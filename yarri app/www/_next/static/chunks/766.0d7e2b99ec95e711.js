"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[766],{8339:function(e,l,t){t.d(l,{Z:function(){return o}});var a=t(2898);let o=(0,a.Z)("Video",[["path",{d:"m22 8-6 4 6 4V8Z",key:"50v9me"}],["rect",{width:"14",height:"12",x:"2",y:"6",rx:"2",ry:"2",key:"1rqjg6"}]])},5766:function(e,l,t){t.r(l),t.d(l,{default:function(){return VideoCallScreen}});var a=t(7437),o=t(2898);let s=(0,o.Z)("RefreshCw",[["path",{d:"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8",key:"v9h5vc"}],["path",{d:"M21 3v5h-5",key:"1q7to0"}],["path",{d:"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16",key:"3uifl3"}],["path",{d:"M8 16H3v5",key:"1cv678"}]]);var r=t(4043),n=t(2741),c=t(8339),i=t(2265),d=t(2263),u=t.n(d),g=t(4671),h=t(5997),m=t(4033),f=t(5376),p=t(5128);function VideoCallScreen(e){let{userName:l,userAvatar:t,rate:o,onEndCall:d}=e,v=(0,m.useRouter)(),{socket:y}=(0,h.useSocket)();(0,f.K)(()=>handleEndCall());let[C,N]=(0,i.useState)(0),[S,x]=(0,i.useState)(!1),[b,w]=(0,i.useState)(!1),[I,j]=(0,i.useState)("user"),[k,E]=(0,i.useState)(null),[D,T]=(0,i.useState)(null),[O,M]=(0,i.useState)([]),[U]=(0,i.useState)(()=>u().createClient({mode:"rtc",codec:"vp8"}));(0,i.useEffect)(()=>{let e=setInterval(()=>{N(e=>e+1)},1e3);return()=>clearInterval(e)},[]),(0,i.useEffect)(()=>{if(!y){console.log("Socket not available in video call");return}console.log("Setting up call-ended listener in video call");let handleRemoteCallEnd=()=>{console.log("\uD83D\uDD34 CALL ENDED BY OTHER USER - CLOSING VIDEO CALL");try{k&&(console.log("Closing local video track"),k.close()),D&&(console.log("Closing local audio track"),D.close()),console.log("Leaving Agora channel"),U.leave(),console.log("Clearing session data"),sessionStorage.removeItem("callData"),sessionStorage.removeItem("channelName"),console.log("Navigating to /users"),window.location.href="/users"}catch(e){console.error("Error during call cleanup:",e),v.push("/users")}};return y.on("call-ended",handleRemoteCallEnd),console.log("call-ended listener registered"),()=>{console.log("Removing call-ended listener"),y.off("call-ended",handleRemoteCallEnd)}},[y,k,D,U,v]),(0,i.useEffect)(()=>{let init=async()=>{try{let e=sessionStorage.getItem("channelName")||"call_".concat(Date.now()),l=await fetch("https://acsgroup.cloud/api/agora/token",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({channelName:e})}),{token:t}=await l.json();console.log("Got Agora token"),await U.join(g.X.appId,e,t,null);let a=await u().createMicrophoneAudioTrack(),o=await u().createCameraVideoTrack();T(a),E(o),await U.publish([a,o]),o.play("local-video");let s=sessionStorage.getItem("callData");if(s){let l=JSON.parse(s),t=localStorage.getItem("user"),a=t?JSON.parse(t):null;if((null==a?void 0:a.id)&&l.otherUserId)try{await fetch("/api/call-log",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({callerId:a.id,receiverId:l.otherUserId,callType:"video",action:"start",channelName:e})}),console.log("Call start logged successfully")}catch(e){console.error("Failed to log call start:",e)}}}catch(e){console.error("Agora init error:",e)}};return U.on("user-published",async(e,l)=>{if(await U.subscribe(e,l),"video"===l&&(M(l=>[...l,e]),setTimeout(()=>{var l;return null===(l=e.videoTrack)||void 0===l?void 0:l.play("remote-video")},100)),"audio"===l){var t;null===(t=e.audioTrack)||void 0===t||t.play()}}),U.on("user-unpublished",e=>{M(l=>l.filter(l=>l.uid!==e.uid))}),init(),(0,p.o$)("Video Call"),()=>{null==k||k.close(),null==D||D.close(),U.leave()}},[]);let toggleMute=async()=>{D&&(await D.setEnabled(S),x(!S))},toggleVideo=async()=>{k&&(await k.setEnabled(b),w(!b))},flipCamera=async()=>{try{if(k){k.close();let e="user"===I?"environment":"user",l=await u().createCameraVideoTrack({facingMode:e});await U.unpublish([k]),await U.publish([l]),E(l),j(e),l.play("local-video"),console.log("Camera flipped to:",e)}}catch(e){console.error("Error flipping camera:",e),alert("Could not flip camera. Make sure you have multiple cameras.")}},handleEndCall=async()=>{console.log("\uD83D\uDD34 USER CLICKED END CALL BUTTON");let e=sessionStorage.getItem("callData");console.log("Call data:",e);let t=Math.ceil(C/60)*o;if((0,p.L9)("Call Ended",{"Call Type":"video",Duration:C,Cost:t,"Ended By":"User",Receiver:l}),e){let l=JSON.parse(e),a=localStorage.getItem("user"),o=a?JSON.parse(a):null;if((null==o?void 0:o.id)&&l.otherUserId)try{await fetch("/api/call-log",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({callerId:o.id,receiverId:l.otherUserId,callType:"video",action:"end",duration:C,cost:t,status:"completed"})}),console.log("Call end logged successfully")}catch(e){console.error("Failed to log call end:",e)}}if(e&&y){let l=JSON.parse(e),t=localStorage.getItem("user"),a=t?JSON.parse(t):null;console.log("Current user:",null==a?void 0:a.id),console.log("Other user:",l.otherUserId),l.otherUserId&&(null==a?void 0:a.id)?(console.log("\uD83D\uDCE4 EMITTING end-call TO:",l.otherUserId),y.emit("end-call",{userId:a.id,otherUserId:l.otherUserId}),console.log("end-call event emitted successfully")):console.log("Missing otherUserId or current userId")}else console.log("No call data or socket not available");console.log("Cleaning up local resources"),k&&k.close(),D&&D.close(),U.leave(),sessionStorage.removeItem("callData"),sessionStorage.removeItem("channelName"),console.log("Navigating back to users page"),window.location.href="/users"};return(0,a.jsxs)("div",{className:"full-screen-page bg-gray-900 flex flex-col",children:[(0,a.jsxs)("div",{className:"flex-1 relative",children:[(0,a.jsx)("div",{id:"remote-video",className:"absolute inset-0 bg-gray-800",children:0===O.length&&(0,a.jsx)("div",{className:"absolute inset-0"})}),(0,a.jsxs)("div",{className:"absolute top-8 left-0 right-0 text-center text-white z-10",children:[(0,a.jsx)("h2",{className:"text-2xl font-bold mb-2",children:l}),(0,a.jsx)("p",{className:"text-lg",children:"".concat(Math.floor(C/60).toString().padStart(2,"0"),":").concat((C%60).toString().padStart(2,"0"))}),(0,a.jsxs)("p",{className:"text-sm text-gray-400 mt-1",children:["â‚¹",Math.ceil(C/60)*o]})]}),(0,a.jsxs)("div",{className:"absolute bottom-32 left-4 z-10",children:[(0,a.jsx)("div",{id:"local-video",className:"w-24 h-32 bg-gray-800 rounded-lg overflow-hidden"}),(0,a.jsx)("button",{onClick:flipCamera,className:"absolute top-2 right-2 w-8 h-8 bg-black/50 rounded-full flex items-center justify-center",children:(0,a.jsx)(s,{className:"text-white",size:16})})]})]}),(0,a.jsxs)("div",{className:"p-8 flex justify-center items-center space-x-4",children:[(0,a.jsx)("button",{onClick:toggleMute,className:"w-14 h-14 rounded-full flex items-center justify-center ".concat(S?"bg-red-500":"bg-gray-700"),children:(0,a.jsx)(r.Z,{className:"text-white",size:24})}),(0,a.jsx)("button",{onClick:handleEndCall,className:"w-16 h-16 bg-red-500 rounded-full flex items-center justify-center shadow-lg",children:(0,a.jsx)(n.Z,{className:"text-white rotate-[135deg]",size:28})}),(0,a.jsx)("button",{onClick:toggleVideo,className:"w-14 h-14 rounded-full flex items-center justify-center ".concat(b?"bg-red-500":"bg-gray-700"),children:(0,a.jsx)(c.Z,{className:"text-white",size:24})})]})]})}}}]);