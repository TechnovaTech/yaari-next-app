"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[766],{8339:function(e,o,t){t.d(o,{Z:function(){return n}});var l=t(2898);let n=(0,l.Z)("Video",[["path",{d:"m22 8-6 4 6 4V8Z",key:"50v9me"}],["rect",{width:"14",height:"12",x:"2",y:"6",rx:"2",ry:"2",key:"1rqjg6"}]])},5766:function(e,o,t){t.r(o),t.d(o,{default:function(){return VideoCallScreen}});var l=t(7437),n=t(2898);let a=(0,n.Z)("RefreshCw",[["path",{d:"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8",key:"v9h5vc"}],["path",{d:"M21 3v5h-5",key:"1q7to0"}],["path",{d:"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16",key:"3uifl3"}],["path",{d:"M8 16H3v5",key:"1cv678"}]]);var c=t(4043),r=t(2741),s=t(8339),i=t(2265),u=t(2263),d=t.n(u),g=t(4671),f=t(5997),h=t(4033),m=t(3101),v=t(5128);function VideoCallScreen(e){let{userName:o,userAvatar:t,rate:n,onEndCall:u}=e,p=(0,h.useRouter)(),{socket:k}=(0,f.useSocket)();(0,m.K)(()=>handleEndCall());let[C,S]=(0,i.useState)(0),[b,y]=(0,i.useState)(!1),[D,x]=(0,i.useState)(!1),[w,N]=(0,i.useState)("user"),[E,I]=(0,i.useState)(null),[j,T]=(0,i.useState)(null),[L,V]=(0,i.useState)([]),[U]=(0,i.useState)(()=>d().createClient({mode:"rtc",codec:"vp8"}));(0,i.useEffect)(()=>{let e=setInterval(()=>{S(e=>e+1)},1e3);return()=>clearInterval(e)},[]),(0,i.useEffect)(()=>{if(!k){console.log("Socket not available in video call");return}console.log("Setting up call-ended listener in video call");let handleRemoteCallEnd=()=>{console.log("\uD83D\uDD34 CALL ENDED BY OTHER USER - CLOSING VIDEO CALL");try{E&&(console.log("Closing local video track"),E.close()),j&&(console.log("Closing local audio track"),j.close()),console.log("Leaving Agora channel"),U.leave(),console.log("Clearing session data"),sessionStorage.removeItem("callData"),sessionStorage.removeItem("channelName"),console.log("Navigating to /users"),window.location.href="/users"}catch(e){console.error("Error during call cleanup:",e),p.push("/users")}};return k.on("call-ended",handleRemoteCallEnd),console.log("call-ended listener registered"),()=>{console.log("Removing call-ended listener"),k.off("call-ended",handleRemoteCallEnd)}},[k,E,j,U,p]),(0,i.useEffect)(()=>{let init=async()=>{try{let e=sessionStorage.getItem("channelName")||"call_".concat(Date.now()),o=await fetch("https://acsgroup.cloud/api/agora/token",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({channelName:e})}),{token:t}=await o.json();console.log("Got Agora token"),await U.join(g.X.appId,e,t,null);let l=await d().createMicrophoneAudioTrack(),n=await d().createCameraVideoTrack();T(l),I(n),await U.publish([l,n]),n.play("local-video")}catch(e){console.error("Agora init error:",e)}};return U.on("user-published",async(e,o)=>{if(await U.subscribe(e,o),"video"===o&&(V(o=>[...o,e]),setTimeout(()=>{var o;return null===(o=e.videoTrack)||void 0===o?void 0:o.play("remote-video")},100)),"audio"===o){var t;null===(t=e.audioTrack)||void 0===t||t.play()}}),U.on("user-unpublished",e=>{V(o=>o.filter(o=>o.uid!==e.uid))}),init(),(0,v.o$)("Video Call"),()=>{null==E||E.close(),null==j||j.close(),U.leave()}},[]);let toggleMute=async()=>{j&&(await j.setEnabled(b),y(!b))},toggleVideo=async()=>{E&&(await E.setEnabled(D),x(!D))},flipCamera=async()=>{try{if(E){E.close();let e="user"===w?"environment":"user",o=await d().createCameraVideoTrack({facingMode:e});await U.unpublish([E]),await U.publish([o]),I(o),N(e),o.play("local-video"),console.log("Camera flipped to:",e)}}catch(e){console.error("Error flipping camera:",e),alert("Could not flip camera. Make sure you have multiple cameras.")}},handleEndCall=()=>{console.log("\uD83D\uDD34 USER CLICKED END CALL BUTTON");let e=sessionStorage.getItem("callData");if(console.log("Call data:",e),(0,v.L9)("Call Ended",{"Call Type":"video",Duration:C,Cost:Math.ceil(C/60)*n,"Ended By":"User",Receiver:o}),e&&k){let o=JSON.parse(e),t=localStorage.getItem("user"),l=t?JSON.parse(t):null;console.log("Current user:",null==l?void 0:l.id),console.log("Other user:",o.otherUserId),o.otherUserId&&(null==l?void 0:l.id)?(console.log("\uD83D\uDCE4 EMITTING end-call TO:",o.otherUserId),k.emit("end-call",{userId:l.id,otherUserId:o.otherUserId}),console.log("end-call event emitted successfully")):console.log("Missing otherUserId or current userId")}else console.log("No call data or socket not available");console.log("Cleaning up local resources"),E&&E.close(),j&&j.close(),U.leave(),sessionStorage.removeItem("callData"),sessionStorage.removeItem("channelName"),console.log("Navigating back to users page"),window.location.href="/users"};return(0,l.jsxs)("div",{className:"full-screen-page bg-gray-900 flex flex-col",children:[(0,l.jsxs)("div",{className:"flex-1 relative",children:[(0,l.jsx)("div",{id:"remote-video",className:"absolute inset-0 bg-gray-800",children:0===L.length&&(0,l.jsx)("div",{className:"absolute inset-0"})}),(0,l.jsxs)("div",{className:"absolute top-8 left-0 right-0 text-center text-white z-10",children:[(0,l.jsx)("h2",{className:"text-2xl font-bold mb-2",children:o}),(0,l.jsx)("p",{className:"text-lg",children:"".concat(Math.floor(C/60).toString().padStart(2,"0"),":").concat((C%60).toString().padStart(2,"0"))}),(0,l.jsxs)("p",{className:"text-sm text-gray-400 mt-1",children:["₹",Math.ceil(C/60)*n]})]}),(0,l.jsxs)("div",{className:"absolute bottom-32 left-4 z-10",children:[(0,l.jsx)("div",{id:"local-video",className:"w-24 h-32 bg-gray-800 rounded-lg overflow-hidden"}),(0,l.jsx)("button",{onClick:flipCamera,className:"absolute top-2 right-2 w-8 h-8 bg-black/50 rounded-full flex items-center justify-center",children:(0,l.jsx)(a,{className:"text-white",size:16})})]})]}),(0,l.jsxs)("div",{className:"p-8 flex justify-center items-center space-x-4",children:[(0,l.jsx)("button",{onClick:toggleMute,className:"w-14 h-14 rounded-full flex items-center justify-center ".concat(b?"bg-red-500":"bg-gray-700"),children:(0,l.jsx)(c.Z,{className:"text-white",size:24})}),(0,l.jsx)("button",{onClick:handleEndCall,className:"w-16 h-16 bg-red-500 rounded-full flex items-center justify-center shadow-lg",children:(0,l.jsx)(r.Z,{className:"text-white rotate-[135deg]",size:28})}),(0,l.jsx)("button",{onClick:toggleVideo,className:"w-14 h-14 rounded-full flex items-center justify-center ".concat(D?"bg-red-500":"bg-gray-700"),children:(0,l.jsx)(s.Z,{className:"text-white",size:24})})]})]})}},4671:function(e,o,t){t.d(o,{X:function(){return l}});let l={appId:"5296c3e4d4b2432f8cf42a9f8e2041e5"}},5997:function(e,o,t){t.r(o),t.d(o,{SocketProvider:function(){return SocketProvider},useSocket:function(){return useSocket}});var l=t(7437),n=t(2265),a=t(4337);let c=(0,n.createContext)({socket:null,isConnected:!1,incomingCall:null,setIncomingCall:()=>{}}),useSocket=()=>(0,n.useContext)(c);function SocketProvider(e){let{children:o}=e,[t,r]=(0,n.useState)(null),[s,i]=(0,n.useState)(!1),[u,d]=(0,n.useState)(null);return(0,n.useEffect)(()=>{let e="https://acsgroup.cloud";console.log("\uD83D\uDD0C Attempting to connect to Socket.io server:",e);let o=(0,a.io)(e,{transports:["websocket","polling"],timeout:2e4,forceNew:!0,reconnection:!0,reconnectionDelay:1e3,reconnectionAttempts:5});return o.on("connect",()=>{console.log("✅ Socket connected successfully"),i(!0);let e=localStorage.getItem("user");if(e)try{let t=JSON.parse(e);console.log("\uD83D\uDC64 Registering user:",t.id),o.emit("register",t.id)}catch(e){console.error("❌ Error parsing user data:",e)}}),o.on("connect_error",e=>{console.error("❌ Socket connection error:",e),i(!1)}),o.on("disconnect",e=>{console.log("\uD83D\uDD0C Socket disconnected:",e),i(!1)}),o.on("reconnect",e=>{console.log("\uD83D\uDD04 Socket reconnected after",e,"attempts"),i(!0)}),o.on("reconnect_error",e=>{console.error("❌ Socket reconnection error:",e)}),o.on("incoming-call",e=>{let{callerId:o,callerName:t,callType:l,channelName:n}=e;console.log("\uD83D\uDCE5 Incoming call (global):",{callerId:o,callerName:t,callType:l,channelName:n}),d({callerId:o,callerName:t,callType:l,channelName:n})}),o.on("call-accepted",e=>{let{channelName:o,callType:t}=e;console.log("✅ Call accepted (global):",{channelName:o,callType:t});try{o&&sessionStorage.setItem("channelName",o);let e=sessionStorage.getItem("callData"),l=t||"audio";if(e)try{let o=JSON.parse(e);((null==o?void 0:o.type)==="video"||(null==o?void 0:o.type)==="audio")&&(l=o.type)}catch(e){}else t&&sessionStorage.setItem("callData",JSON.stringify({userName:"",userAvatar:"",rate:"video"===t?10:5,type:t,channelName:o,otherUserId:""}));let n="video"===l?"/video-call":"/audio-call";window.location.href=n}catch(e){console.error("Error handling global call-accepted:",e)}}),o.on("call-busy",e=>{let{message:o}=e;console.log("\uD83D\uDCF5 Call busy:",o),alert(o)}),o.on("call-ended",()=>{console.log("\uD83D\uDED1 Call ended (global) — clearing incomingCall"),d(null)}),r(o),()=>{console.log("\uD83E\uDDF9 Cleaning up socket connection"),o.off("incoming-call"),o.off("call-accepted"),o.off("call-busy"),o.off("call-ended"),o.off("connect"),o.off("connect_error"),o.off("disconnect"),o.off("reconnect"),o.off("reconnect_error"),o.disconnect()}},[]),(0,l.jsx)(c.Provider,{value:{socket:t,isConnected:s,incomingCall:u,setIncomingCall:d},children:o})}},3101:function(e,o,t){t.d(o,{K:function(){return useBackButton}});var l=t(2265),n=t(4033),a=t(5870);function useBackButton(e){let o=(0,n.useRouter)();(0,l.useEffect)(()=>{let t=Promise.resolve(a.g.addListener("backButton",t=>{let{canGoBack:l}=t;e?e():l&&o.back()}));return()=>{t.then(e=>e.remove()).catch(()=>{})}},[e,o])}},5128:function(e,o,t){t.d(o,{L9:function(){return trackEvent},QU:function(){return trackUserLogin},Tf:function(){return trackSubscription},YY:function(){return trackProfileView},o$:function(){return trackScreenView}});let trackUserLogin=async(e,o)=>{console.log("trackUserLogin (CleverTap disabled):",e,o)},trackEvent=async(e,o)=>{console.log("trackEvent (CleverTap disabled):",e,o)},trackProfileView=async e=>{console.log("trackProfileView (CleverTap disabled):",e)},trackSubscription=async(e,o,t)=>{console.log("trackSubscription (CleverTap disabled):",e,o,t)},trackScreenView=async e=>{console.log("trackScreenView (CleverTap disabled):",e)}}}]);