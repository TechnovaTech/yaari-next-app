"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[828],{1828:function(e,o,t){t.r(o),t.d(o,{default:function(){return AudioCallScreen}});var l=t(7437),n=t(2898);let c=(0,n.Z)("Volume2",[["polygon",{points:"11 5 6 9 2 9 2 15 6 15 11 19 11 5",key:"16drj5"}],["path",{d:"M15.54 8.46a5 5 0 0 1 0 7.07",key:"ltjumu"}],["path",{d:"M19.07 4.93a10 10 0 0 1 0 14.14",key:"1kegas"}]]);var a=t(2741),r=t(4043),s=t(2265),i=t(2263),u=t.n(i),d=t(4671),g=t(5997),f=t(4033),h=t(3101),m=t(5128);function AudioCallScreen(e){let{userName:o,userAvatar:t,rate:n,onEndCall:i}=e,p=(0,f.useRouter)(),{socket:S}=(0,g.useSocket)();(0,h.K)(()=>handleEndCall());let[v,k]=(0,s.useState)(0),[D,C]=(0,s.useState)(!1),[b,y]=(0,s.useState)(!0),[w,x]=(0,s.useState)(null),[N]=(0,s.useState)(()=>u().createClient({mode:"rtc",codec:"vp8"}));(0,s.useEffect)(()=>{let e=setInterval(()=>{k(e=>e+1)},1e3);return()=>clearInterval(e)},[]),(0,s.useEffect)(()=>{if(!S){console.log("Socket not available in audio call");return}console.log("Setting up call-ended listener in audio call");let handleRemoteCallEnd=()=>{console.log("\uD83D\uDD34 CALL ENDED BY OTHER USER - CLOSING AUDIO CALL");try{w&&(console.log("Closing local audio track"),w.close()),console.log("Leaving Agora channel"),N.leave(),console.log("Clearing session data"),sessionStorage.removeItem("callData"),sessionStorage.removeItem("channelName"),console.log("Navigating to /users"),window.location.href="/users"}catch(e){console.error("Error during call cleanup:",e),p.push("/users")}};return S.on("call-ended",handleRemoteCallEnd),console.log("call-ended listener registered"),()=>{console.log("Removing call-ended listener"),S.off("call-ended",handleRemoteCallEnd)}},[S,w,N,p]),(0,s.useEffect)(()=>{let init=async()=>{try{let e=sessionStorage.getItem("channelName")||"audio_".concat(Date.now()),o=await fetch("https://acsgroup.cloud/api/agora/token",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({channelName:e})}),{token:t}=await o.json();console.log("Got Agora token"),await N.join(d.X.appId,e,t,null);let l=await u().createMicrophoneAudioTrack();x(l),await N.publish([l])}catch(e){console.error("Agora audio init error:",e)}};return N.on("user-published",async(e,o)=>{if(await N.subscribe(e,o),"audio"===o){var t;null===(t=e.audioTrack)||void 0===t||t.play()}}),init(),(0,m.o$)("Audio Call"),()=>{null==w||w.close(),N.leave()}},[]);let toggleMute=async()=>{w&&(await w.setEnabled(D),C(!D))},handleEndCall=()=>{console.log("\uD83D\uDD34 USER CLICKED END CALL BUTTON");let e=sessionStorage.getItem("callData");if(console.log("Call data:",e),(0,m.L9)("Call Ended",{"Call Type":"audio",Duration:v,Cost:Math.ceil(v/60)*n,"Ended By":"User",Receiver:o}),e&&S){let o=JSON.parse(e),t=localStorage.getItem("user"),l=t?JSON.parse(t):null;console.log("Current user:",null==l?void 0:l.id),console.log("Other user:",o.otherUserId),o.otherUserId&&(null==l?void 0:l.id)?(console.log("\uD83D\uDCE4 EMITTING end-call TO:",o.otherUserId),S.emit("end-call",{userId:l.id,otherUserId:o.otherUserId}),console.log("end-call event emitted successfully")):console.log("Missing otherUserId or current userId")}else console.log("No call data or socket not available");console.log("Cleaning up local resources"),w&&w.close(),N.leave(),sessionStorage.removeItem("callData"),sessionStorage.removeItem("channelName"),console.log("Navigating back to users page"),window.location.href="/users"};return(0,l.jsxs)("div",{className:"full-screen-page bg-gradient-to-b from-primary to-orange-600 flex flex-col items-center justify-center p-8",children:[(0,l.jsxs)("div",{className:"flex-1 flex flex-col items-center justify-center",children:[(0,l.jsx)("div",{className:"w-40 h-40 rounded-full overflow-hidden bg-white/20 mb-8",children:(0,l.jsx)("img",{src:t,alt:o,className:"w-full h-full object-cover"})}),(0,l.jsx)("h2",{className:"text-3xl font-bold text-white mb-4",children:o}),(0,l.jsx)("p",{className:"text-2xl text-white mb-2",children:"".concat(Math.floor(v/60).toString().padStart(2,"0"),":").concat((v%60).toString().padStart(2,"0"))}),(0,l.jsxs)("p",{className:"text-lg text-white/80",children:["₹",Math.ceil(v/60)*n]})]}),(0,l.jsxs)("div",{className:"flex justify-center items-center space-x-6 mb-8",children:[(0,l.jsx)("button",{onClick:()=>y(!b),className:"w-14 h-14 rounded-full flex items-center justify-center ".concat(b?"bg-white/30":"bg-red-500"),children:(0,l.jsx)(c,{className:"text-white",size:24})}),(0,l.jsx)("button",{onClick:handleEndCall,className:"w-16 h-16 bg-red-500 rounded-full flex items-center justify-center shadow-lg",children:(0,l.jsx)(a.Z,{className:"text-white rotate-[135deg]",size:28})}),(0,l.jsx)("button",{onClick:toggleMute,className:"w-14 h-14 rounded-full flex items-center justify-center ".concat(D?"bg-red-500":"bg-white/30"),children:(0,l.jsx)(r.Z,{className:"text-white",size:24})})]})]})}},4671:function(e,o,t){t.d(o,{X:function(){return l}});let l={appId:"5296c3e4d4b2432f8cf42a9f8e2041e5"}},5997:function(e,o,t){t.r(o),t.d(o,{SocketProvider:function(){return SocketProvider},useSocket:function(){return useSocket}});var l=t(7437),n=t(2265),c=t(4337);let a=(0,n.createContext)({socket:null,isConnected:!1,incomingCall:null,setIncomingCall:()=>{}}),useSocket=()=>(0,n.useContext)(a);function SocketProvider(e){let{children:o}=e,[t,r]=(0,n.useState)(null),[s,i]=(0,n.useState)(!1),[u,d]=(0,n.useState)(null);return(0,n.useEffect)(()=>{let e="https://acsgroup.cloud";console.log("\uD83D\uDD0C Attempting to connect to Socket.io server:",e);let o=(0,c.io)(e,{transports:["websocket","polling"],timeout:2e4,forceNew:!0,reconnection:!0,reconnectionDelay:1e3,reconnectionAttempts:5});return o.on("connect",()=>{console.log("✅ Socket connected successfully"),i(!0);let e=localStorage.getItem("user");if(e)try{let t=JSON.parse(e);console.log("\uD83D\uDC64 Registering user:",t.id),o.emit("register",t.id)}catch(e){console.error("❌ Error parsing user data:",e)}}),o.on("connect_error",e=>{console.error("❌ Socket connection error:",e),i(!1)}),o.on("disconnect",e=>{console.log("\uD83D\uDD0C Socket disconnected:",e),i(!1)}),o.on("reconnect",e=>{console.log("\uD83D\uDD04 Socket reconnected after",e,"attempts"),i(!0)}),o.on("reconnect_error",e=>{console.error("❌ Socket reconnection error:",e)}),o.on("incoming-call",e=>{let{callerId:o,callerName:t,callType:l,channelName:n}=e;console.log("\uD83D\uDCE5 Incoming call (global):",{callerId:o,callerName:t,callType:l,channelName:n}),d({callerId:o,callerName:t,callType:l,channelName:n})}),o.on("call-accepted",e=>{let{channelName:o,callType:t}=e;console.log("✅ Call accepted (global):",{channelName:o,callType:t});try{o&&sessionStorage.setItem("channelName",o);let e=sessionStorage.getItem("callData"),l=t||"audio";if(e)try{let o=JSON.parse(e);((null==o?void 0:o.type)==="video"||(null==o?void 0:o.type)==="audio")&&(l=o.type)}catch(e){}else t&&sessionStorage.setItem("callData",JSON.stringify({userName:"",userAvatar:"",rate:"video"===t?10:5,type:t,channelName:o,otherUserId:""}));let n="video"===l?"/video-call":"/audio-call";window.location.href=n}catch(e){console.error("Error handling global call-accepted:",e)}}),o.on("call-busy",e=>{let{message:o}=e;console.log("\uD83D\uDCF5 Call busy:",o),alert(o)}),o.on("call-ended",()=>{console.log("\uD83D\uDED1 Call ended (global) — clearing incomingCall"),d(null)}),r(o),()=>{console.log("\uD83E\uDDF9 Cleaning up socket connection"),o.off("incoming-call"),o.off("call-accepted"),o.off("call-busy"),o.off("call-ended"),o.off("connect"),o.off("connect_error"),o.off("disconnect"),o.off("reconnect"),o.off("reconnect_error"),o.disconnect()}},[]),(0,l.jsx)(a.Provider,{value:{socket:t,isConnected:s,incomingCall:u,setIncomingCall:d},children:o})}},3101:function(e,o,t){t.d(o,{K:function(){return useBackButton}});var l=t(2265),n=t(4033),c=t(5870);function useBackButton(e){let o=(0,n.useRouter)();(0,l.useEffect)(()=>{let t=Promise.resolve(c.g.addListener("backButton",t=>{let{canGoBack:l}=t;e?e():l&&o.back()}));return()=>{t.then(e=>e.remove()).catch(()=>{})}},[e,o])}},5128:function(e,o,t){t.d(o,{L9:function(){return trackEvent},QU:function(){return trackUserLogin},Tf:function(){return trackSubscription},YY:function(){return trackProfileView},o$:function(){return trackScreenView}});let trackUserLogin=async(e,o)=>{console.log("trackUserLogin (CleverTap disabled):",e,o)},trackEvent=async(e,o)=>{console.log("trackEvent (CleverTap disabled):",e,o)},trackProfileView=async e=>{console.log("trackProfileView (CleverTap disabled):",e)},trackSubscription=async(e,o,t)=>{console.log("trackSubscription (CleverTap disabled):",e,o,t)},trackScreenView=async e=>{console.log("trackScreenView (CleverTap disabled):",e)}}}]);