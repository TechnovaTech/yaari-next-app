"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[773],{4773:function(e,l,t){t.r(l),t.d(l,{default:function(){return AudioCallScreen}});var o=t(7437),a=t(2265),n=t(2263),s=t.n(n),r=t(4671),i=t(5997),c=t(4033),d=t(5376),u=t(5128);let syncUserToCleverTap=async()=>{try{let e=localStorage.getItem("user");if(!e)return;let l=JSON.parse(e),t=(null==l?void 0:l.id)||(null==l?void 0:l._id)||(null==l?void 0:l.phone);if(!t){console.log("⚠️ No user identity found, skipping CleverTap sync");return}console.log("\uD83D\uDD04 Syncing user to CleverTap:",t),await (0,u.Lj)({Identity:t,Name:null==l?void 0:l.name,Email:null==l?void 0:l.email,Phone:null==l?void 0:l.phone,Gender:null==l?void 0:l.gender,Age:null==l?void 0:l.age,City:null==l?void 0:l.city,"Profile Picture":null==l?void 0:l.profilePic,"Coins Balance":(null==l?void 0:l.coins)||0,"User Type":(null==l?void 0:l.isPremium)?"Premium":"Free","Last Updated":new Date().toISOString()}),console.log("✅ User synced to CleverTap successfully")}catch(e){console.error("❌ Error syncing user to CleverTap:",e)}},trackCallEvent=async(e,l,t,o)=>{await (0,u.L9)("Call ".concat(l),{"Call Type":e,"Other User ID":t,Duration:o,Timestamp:new Date().toISOString()})};var g=t(2273),h=t(3103),m=t(6479);function AvatarCircle(e){let{src:l,alt:t,className:a}=e;return(0,o.jsx)("div",{className:"w-40 h-40 rounded-full overflow-hidden bg-white/20 mb-8 ".concat(a||""),children:(0,o.jsx)("img",{src:l,alt:t,className:"w-full h-full object-cover"})})}let formatTime=e=>"".concat(Math.floor(e/60).toString().padStart(2,"0"),":").concat((e%60).toString().padStart(2,"0"));function CallStats(e){let{userName:l,duration:t,cost:a,remainingBalance:n,rate:s}=e;return(0,o.jsxs)("div",{className:"flex-1 flex flex-col items-center justify-center",children:[(0,o.jsx)("h2",{className:"text-3xl font-bold text-white mb-4",children:l}),(0,o.jsx)("p",{className:"text-2xl text-white mb-2",children:formatTime(t)}),(0,o.jsxs)("p",{className:"text-lg text-white/80",children:["₹",a]}),null!==n&&n<=s&&(0,o.jsxs)("div",{className:"mt-4 bg-red-500/90 backdrop-blur-sm px-4 py-2 rounded-full flex items-center gap-2 animate-pulse",children:[(0,o.jsx)("img",{src:"/images/coinicon.png",alt:"coin",className:"w-4 h-4 object-contain"}),(0,o.jsxs)("span",{className:"text-white font-semibold mt-2.5",children:[n," coins left"]})]})]})}var f=t(2898);let p=(0,f.Z)("Volume2",[["polygon",{points:"11 5 6 9 2 9 2 15 6 15 11 19 11 5",key:"16drj5"}],["path",{d:"M15.54 8.46a5 5 0 0 1 0 7.07",key:"ltjumu"}],["path",{d:"M19.07 4.93a10 10 0 0 1 0 14.14",key:"1kegas"}]]);var v=t(2741),C=t(4043);function ControlsBar(e){let{isSpeakerOn:l,isMuted:t,onToggleSpeaker:a,onToggleMute:n,onEndCall:s}=e;return(0,o.jsxs)("div",{className:"flex justify-center items-center space-x-6 mb-8",children:[(0,o.jsx)("button",{onClick:a,className:"w-14 h-14 rounded-full flex items-center justify-center ".concat(l?"bg-white":"bg-white/30"),children:(0,o.jsx)(p,{className:l?"text-primary":"text-white",size:24})}),(0,o.jsx)("button",{onClick:s,className:"w-16 h-16 bg-red-500 rounded-full flex items-center justify-center shadow-lg",children:(0,o.jsx)(v.Z,{className:"text-white rotate-[135deg]",size:28})}),(0,o.jsx)("button",{onClick:n,className:"w-14 h-14 rounded-full flex items-center justify-center ".concat(t?"bg-red-500":"bg-white/30"),children:(0,o.jsx)(C.Z,{className:"text-white",size:24})})]})}function AudioCallScreen(e){let{userName:l,userAvatar:t,rate:n,onEndCall:f}=e,p=(0,c.useRouter)(),{socket:v}=(0,i.useSocket)();(0,d.K)(()=>handleEndCall());let[C,y]=(0,a.useState)(0),[S,I]=(0,a.useState)(!1),[w,N]=(0,a.useState)(!0),[x,D]=(0,a.useState)(null),[j]=(0,a.useState)(()=>s().createClient({mode:"rtc",codec:"vp8"})),[b,k]=(0,a.useState)(!1),[E,T]=(0,a.useState)(null);(0,a.useEffect)(()=>{let e=setInterval(()=>{y(e=>e+1)},1e3);return()=>clearInterval(e)},[]);let handleCoinDeduction=async()=>{try{let e=sessionStorage.getItem("callData");if(console.log("Call data from session:",e),!e)return;let l=JSON.parse(e);console.log("Parsed call data:",l),console.log("isCaller value:",l.isCaller);let t=localStorage.getItem("user");if(!t)return;let o=JSON.parse(t);if(!1===l.isCaller){console.log("Receiver - not deducting coins");return}console.log("Caller - deducting coins"),console.log("Attempting to deduct ".concat(n," coins at ").concat(C,"s"));let a=await (0,g.G)(o.id,n,"audio");console.log("Successfully deducted ".concat(n," coins")),(null==a?void 0:a.newBalance)!==void 0&&T(a.newBalance)}catch(l){var e;console.error("Coin deduction failed:",l),(null===(e=l.message)||void 0===e?void 0:e.includes("Insufficient"))&&(alert("Insufficient coins! Call will end."),handleEndCall())}};(0,a.useEffect)(()=>{10!==C||b?b&&C>10&&(C-10)%60==0&&(console.log("Deduction at ".concat(C," seconds")),handleCoinDeduction()):(console.log("First deduction at 10 seconds"),k(!0),handleCoinDeduction())},[C]),(0,a.useEffect)(()=>{if(!v){console.log("Socket not available in audio call");return}console.log("Setting up call-ended listener in audio call");let handleRemoteCallEnd=()=>{console.log("\uD83D\uDD34 CALL ENDED BY OTHER USER - CLOSING AUDIO CALL");try{x&&(console.log("Closing local audio track"),x.close()),console.log("Leaving Agora channel"),j.leave(),console.log("Clearing session data"),sessionStorage.removeItem("callData"),sessionStorage.removeItem("channelName"),console.log("Navigating to /users"),window.location.href="/users"}catch(e){console.error("Error during call cleanup:",e),p.push("/users")}};return v.on("call-ended",handleRemoteCallEnd),console.log("call-ended listener registered"),()=>{console.log("Removing call-ended listener"),v.off("call-ended",handleRemoteCallEnd)}},[v,x,j,p]),(0,a.useEffect)(()=>{let init=async()=>{h.dV.isNativePlatform()&&(await m.Z.setRoute({route:"earpiece"}),N(!1),console.log("Audio routing set to earpiece"));try{let t=sessionStorage.getItem("channelName")||"audio_".concat(Date.now()),o=await fetch("https://admin.yaari.me/api/agora/token",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({channelName:t})}),{token:a}=await o.json();console.log("Got Agora token"),await j.join(r.X.appId,t,a,null);let n=await s().createMicrophoneAudioTrack();D(n),await j.publish([n]);let i=sessionStorage.getItem("callData");if(i){let o=JSON.parse(i),a=localStorage.getItem("user"),n=a?JSON.parse(a):null;if((null==n?void 0:n.id)&&o.otherUserId)try{var e,l;console.log("\uD83D\uDCE4 Logging audio call start:",{callerId:n.id,receiverId:o.otherUserId});let a=(null===(l=window.Capacitor)||void 0===l?void 0:null===(e=l.isNativePlatform)||void 0===e?void 0:e.call(l))?"".concat("https://admin.yaari.me","/api/call-log"):"/api/call-log",s=await fetch(a,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({callerId:n.id,receiverId:o.otherUserId,callType:"audio",action:"start",channelName:t})});if(!s.ok)throw Error("Failed to log call start: ".concat(s.status));let r=await s.json();r.sessionId&&sessionStorage.setItem("callSessionId",r.sessionId),console.log("✅ Audio call start logged:",r)}catch(e){console.error("❌ Failed to log audio call start:",e),alert("Warning: Call logging failed. Call may not appear in history.")}}}catch(e){console.error("Agora audio init error:",e)}};j.on("user-published",async(e,l)=>{if(await j.subscribe(e,l),"audio"===l){var t;null===(t=e.audioTrack)||void 0===t||t.play()}}),init(),(0,u.o$)("Audio Call");let e=sessionStorage.getItem("callData");if(e){let l=JSON.parse(e);trackCallEvent("audio","accepted",l.otherUserId).catch(e=>console.log("Tracking error:",e))}return()=>{null==x||x.close(),j.leave(),h.dV.isNativePlatform()&&m.Z.setRoute({route:"earpiece"}).catch(()=>{})}},[]);let toggleMute=async()=>{x&&(await x.setEnabled(S),I(!S))},toggleSpeaker=async()=>{let e=!w;if(h.dV.isNativePlatform())try{await m.Z.setRoute({route:e?"speaker":"earpiece"}),console.log("Speaker ".concat(e?"ON":"OFF")),N(e)}catch(e){console.warn("Failed to toggle audio route:",e)}else N(e)},handleEndCall=async()=>{console.log("\uD83D\uDD34 USER CLICKED END CALL BUTTON");let e=sessionStorage.getItem("callData");console.log("Call data:",e);let t=Math.ceil(C/60)*n,o=e?JSON.parse(e):{};if(trackCallEvent("audio","ended",o.otherUserId,C).catch(e=>console.log("Tracking error:",e)),(0,u.L9)("Call Ended",{"Call Type":"audio",Duration:C,Cost:t,"Ended By":"User",Receiver:l,"Receiver ID":o.otherUserId}).catch(e=>console.log("Tracking error:",e)),syncUserToCleverTap().catch(e=>console.log("Sync error:",e)),e){let l=JSON.parse(e),o=localStorage.getItem("user"),n=o?JSON.parse(o):null;if((null==n?void 0:n.id)&&l.otherUserId)try{var a,s;console.log("\uD83D\uDCE4 Logging audio call end:",{callerId:n.id,receiverId:l.otherUserId,duration:C,cost:t});let e=(null===(s=window.Capacitor)||void 0===s?void 0:null===(a=s.isNativePlatform)||void 0===a?void 0:a.call(s))?"".concat("https://admin.yaari.me","/api/call-log"):"/api/call-log",o=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({callerId:n.id,receiverId:l.otherUserId,callType:"audio",action:"end",duration:C,cost:t,status:"completed"})});if(!o.ok)throw Error("Failed to log call end: ".concat(o.status));let r=await o.json();r.verified||console.warn("⚠️ Call saved but verification failed"),console.log("✅ Audio call end logged:",r)}catch(e){console.error("❌ Failed to log audio call end:",e),alert("Warning: Failed to save call to history.")}}if(e&&v){let l=JSON.parse(e),t=localStorage.getItem("user"),o=t?JSON.parse(t):null;console.log("Current user:",null==o?void 0:o.id),console.log("Other user:",l.otherUserId),l.otherUserId&&(null==o?void 0:o.id)?(console.log("\uD83D\uDCE4 EMITTING end-call TO:",l.otherUserId),v.emit("end-call",{userId:o.id,otherUserId:l.otherUserId}),console.log("end-call event emitted successfully")):console.log("Missing otherUserId or current userId")}else console.log("No call data or socket not available");if(console.log("Cleaning up local resources"),x&&x.close(),j.leave(),sessionStorage.removeItem("callData"),sessionStorage.removeItem("channelName"),h.dV.isNativePlatform())try{await m.Z.setRoute({route:"earpiece"})}catch(e){}console.log("Navigating back to users page"),window.location.href="/users"},O=Math.ceil(C/60)*n;return(0,o.jsxs)("div",{className:"full-screen-page bg-gradient-to-b from-primary to-orange-600 flex flex-col items-center justify-center p-8",children:[(0,o.jsxs)("div",{className:"flex-1 flex flex-col items-center justify-center",children:[(0,o.jsx)(AvatarCircle,{src:t,alt:l}),(0,o.jsx)(CallStats,{userName:l,duration:C,cost:O,remainingBalance:E,rate:n})]}),(0,o.jsx)(ControlsBar,{isSpeakerOn:w,isMuted:S,onToggleSpeaker:toggleSpeaker,onToggleMute:toggleMute,onEndCall:handleEndCall})]})}}}]);