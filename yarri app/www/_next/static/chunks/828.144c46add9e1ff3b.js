"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[828],{1828:function(e,l,t){t.r(l),t.d(l,{default:function(){return AudioCallScreen}});var o=t(7437),a=t(2898);let s=(0,a.Z)("Volume2",[["polygon",{points:"11 5 6 9 2 9 2 15 6 15 11 19 11 5",key:"16drj5"}],["path",{d:"M15.54 8.46a5 5 0 0 1 0 7.07",key:"ltjumu"}],["path",{d:"M19.07 4.93a10 10 0 0 1 0 14.14",key:"1kegas"}]]);var n=t(2741),r=t(4043),c=t(2265),i=t(2263),d=t.n(i),u=t(4671),g=t(5997),h=t(4033),f=t(5376),m=t(5128);function AudioCallScreen(e){let{userName:l,userAvatar:t,rate:a,onEndCall:i}=e,p=(0,h.useRouter)(),{socket:S}=(0,g.useSocket)();(0,f.K)(()=>handleEndCall());let[N,y]=(0,c.useState)(0),[x,v]=(0,c.useState)(!1),[I,C]=(0,c.useState)(!0),[w,b]=(0,c.useState)(null),[j]=(0,c.useState)(()=>d().createClient({mode:"rtc",codec:"vp8"}));(0,c.useEffect)(()=>{let e=setInterval(()=>{y(e=>e+1)},1e3);return()=>clearInterval(e)},[]),(0,c.useEffect)(()=>{if(!S){console.log("Socket not available in audio call");return}console.log("Setting up call-ended listener in audio call");let handleRemoteCallEnd=()=>{console.log("\uD83D\uDD34 CALL ENDED BY OTHER USER - CLOSING AUDIO CALL");try{w&&(console.log("Closing local audio track"),w.close()),console.log("Leaving Agora channel"),j.leave(),console.log("Clearing session data"),sessionStorage.removeItem("callData"),sessionStorage.removeItem("channelName"),console.log("Navigating to /users"),window.location.href="/users"}catch(e){console.error("Error during call cleanup:",e),p.push("/users")}};return S.on("call-ended",handleRemoteCallEnd),console.log("call-ended listener registered"),()=>{console.log("Removing call-ended listener"),S.off("call-ended",handleRemoteCallEnd)}},[S,w,j,p]),(0,c.useEffect)(()=>{let init=async()=>{try{let e=sessionStorage.getItem("channelName")||"audio_".concat(Date.now()),l=await fetch("https://acsgroup.cloud/api/agora/token",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({channelName:e})}),{token:t}=await l.json();console.log("Got Agora token"),await j.join(u.X.appId,e,t,null);let o=await d().createMicrophoneAudioTrack();b(o),await j.publish([o]);let a=sessionStorage.getItem("callData");if(a){let l=JSON.parse(a),t=localStorage.getItem("user"),o=t?JSON.parse(t):null;if((null==o?void 0:o.id)&&l.otherUserId)try{await fetch("/api/call-log",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({callerId:o.id,receiverId:l.otherUserId,callType:"audio",action:"start",channelName:e})}),console.log("Audio call start logged successfully")}catch(e){console.error("Failed to log audio call start:",e)}}}catch(e){console.error("Agora audio init error:",e)}};return j.on("user-published",async(e,l)=>{if(await j.subscribe(e,l),"audio"===l){var t;null===(t=e.audioTrack)||void 0===t||t.play()}}),init(),(0,m.o$)("Audio Call"),()=>{null==w||w.close(),j.leave()}},[]);let toggleMute=async()=>{w&&(await w.setEnabled(x),v(!x))},handleEndCall=async()=>{console.log("\uD83D\uDD34 USER CLICKED END CALL BUTTON");let e=sessionStorage.getItem("callData");console.log("Call data:",e);let t=Math.ceil(N/60)*a;if((0,m.L9)("Call Ended",{"Call Type":"audio",Duration:N,Cost:t,"Ended By":"User",Receiver:l}),e){let l=JSON.parse(e),o=localStorage.getItem("user"),a=o?JSON.parse(o):null;if((null==a?void 0:a.id)&&l.otherUserId)try{await fetch("/api/call-log",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({callerId:a.id,receiverId:l.otherUserId,callType:"audio",action:"end",duration:N,cost:t,status:"completed"})}),console.log("Audio call end logged successfully")}catch(e){console.error("Failed to log audio call end:",e)}}if(e&&S){let l=JSON.parse(e),t=localStorage.getItem("user"),o=t?JSON.parse(t):null;console.log("Current user:",null==o?void 0:o.id),console.log("Other user:",l.otherUserId),l.otherUserId&&(null==o?void 0:o.id)?(console.log("\uD83D\uDCE4 EMITTING end-call TO:",l.otherUserId),S.emit("end-call",{userId:o.id,otherUserId:l.otherUserId}),console.log("end-call event emitted successfully")):console.log("Missing otherUserId or current userId")}else console.log("No call data or socket not available");console.log("Cleaning up local resources"),w&&w.close(),j.leave(),sessionStorage.removeItem("callData"),sessionStorage.removeItem("channelName"),console.log("Navigating back to users page"),window.location.href="/users"};return(0,o.jsxs)("div",{className:"full-screen-page bg-gradient-to-b from-primary to-orange-600 flex flex-col items-center justify-center p-8",children:[(0,o.jsxs)("div",{className:"flex-1 flex flex-col items-center justify-center",children:[(0,o.jsx)("div",{className:"w-40 h-40 rounded-full overflow-hidden bg-white/20 mb-8",children:(0,o.jsx)("img",{src:t,alt:l,className:"w-full h-full object-cover"})}),(0,o.jsx)("h2",{className:"text-3xl font-bold text-white mb-4",children:l}),(0,o.jsx)("p",{className:"text-2xl text-white mb-2",children:"".concat(Math.floor(N/60).toString().padStart(2,"0"),":").concat((N%60).toString().padStart(2,"0"))}),(0,o.jsxs)("p",{className:"text-lg text-white/80",children:["â‚¹",Math.ceil(N/60)*a]})]}),(0,o.jsxs)("div",{className:"flex justify-center items-center space-x-6 mb-8",children:[(0,o.jsx)("button",{onClick:()=>C(!I),className:"w-14 h-14 rounded-full flex items-center justify-center ".concat(I?"bg-white/30":"bg-red-500"),children:(0,o.jsx)(s,{className:"text-white",size:24})}),(0,o.jsx)("button",{onClick:handleEndCall,className:"w-16 h-16 bg-red-500 rounded-full flex items-center justify-center shadow-lg",children:(0,o.jsx)(n.Z,{className:"text-white rotate-[135deg]",size:28})}),(0,o.jsx)("button",{onClick:toggleMute,className:"w-14 h-14 rounded-full flex items-center justify-center ".concat(x?"bg-red-500":"bg-white/30"),children:(0,o.jsx)(r.Z,{className:"text-white",size:24})})]})]})}}}]);