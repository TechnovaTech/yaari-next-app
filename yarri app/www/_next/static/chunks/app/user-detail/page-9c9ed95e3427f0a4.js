(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[496],{3067:function(e,a,l){"use strict";l.d(a,{Z:function(){return s}});var t=l(2898);let s=(0,t.Z)("ArrowLeft",[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]])},9469:function(e,a,l){Promise.resolve().then(l.bind(l,1121))},1121:function(e,a,l){"use strict";l.r(a),l.d(a,{default:function(){return UserDetailPage}});var t=l(7437),s=l(4033),r=l(3067),n=l(7972),i=l(8339),c=l(2741),o=l(2265),d=l(3487),m=l(5650),u=l(5997),h=l(2606),f=l(5314),g=l(7115),x=l(7015),p=l(5128);function UserDetailScreen(e){let{onBack:a,userId:l,onStartCall:y,onCoinClick:b}=e,{lang:v}=(0,d.useLanguage)(),j=m.I[v],[N,S]=(0,o.useState)(null),[w,C]=(0,o.useState)(!0),[U,I]=(0,o.useState)("offline"),D=(0,s.useRouter)(),{socket:k}=(0,u.useSocket)(),[O,P]=(0,o.useState)(!1),[A,R]=(0,o.useState)(!1),[Z,E]=(0,o.useState)(!1),[J,_]=(0,o.useState)("video"),[z,B]=(0,o.useState)(null),[L,G]=(0,o.useState)(!1),[K,T]=(0,o.useState)(0),[F,M]=(0,o.useState)(5),[Y,q]=(0,o.useState)(10),[H,$]=(0,o.useState)("full"),[Q,V]=(0,o.useState)(!1),canonicalUrlKey=e=>{try{let a=new URL(e),l=a.pathname.split("/");return(l[l.length-1]||"").toLowerCase()}catch(l){let a=e.split("?")[0];return(a.substring(a.lastIndexOf("/")+1)||"").toLowerCase()}},dedupeByCanonical=e=>{let a=[],l=new Set;for(let t of e||[]){if(!t||!t.trim())continue;let e=t.replace(/https?:\/\/(0\.0\.0\.0|localhost):\d+/g,"https://admin.yaari.me"),s=canonicalUrlKey(e);!s||l.has(s)||(l.add(s),a.push(e))}return a},syncGalleryFromLocalIfSameUser=e=>{try{let a=localStorage.getItem("user");if(!a)return e;let l=JSON.parse(a),t=String((null==l?void 0:l.id)||(null==l?void 0:l._id)||"")===String((null==e?void 0:e.id)||(null==e?void 0:e._id)||"");t&&Array.isArray(null==l?void 0:l.gallery)&&(e.gallery=dedupeByCanonical(l.gallery))}catch(e){}return e};(0,o.useEffect)(()=>{fetchUser(),fetchBalance(),fetchCallRates(),(0,p.o$)("User Detail"),(0,p.YY)(l)},[l]);let fetchBalance=async()=>{try{let e=localStorage.getItem("user");if(e){let a=JSON.parse(e),l=await fetch("https://admin.yaari.me/api/users/".concat(a.id,"/balance")),t=await l.json();l.ok&&T(t.balance||0)}}catch(e){console.error("Error fetching balance:",e)}},fetchCallRates=async()=>{try{let e=await fetch("https://admin.yaari.me/api/settings"),a=await e.json();a.audioCallRate&&M(a.audioCallRate),a.videoCallRate&&q(a.videoCallRate)}catch(e){console.error("Error fetching call rates:",e)}};(0,o.useEffect)(()=>{if(!k)return;let handleUserStatusChange=e=>{let{userId:a,status:t}=e;a===l&&I("online"===t?"online":"offline")},handleOnlineUsers=e=>{let a=e.find(e=>e.userId===l);a&&I("online"===a.status?"online":"offline")};return k.on("online-users",handleOnlineUsers),k.on("user-status-change",handleUserStatusChange),k.emit("get-online-users"),k.on("call-accepted",e=>{let{channelName:a}=e;G(!1),sessionStorage.setItem("channelName",a);let l=sessionStorage.getItem("callData");if(l){let e=JSON.parse(l);e.channelName=a,void 0===e.isCaller&&(e.isCaller=!0),sessionStorage.setItem("callData",JSON.stringify(e)),console.log("Call accepted, updated callData:",e),setTimeout(()=>{D.push("video"===e.type?"/video-call":"/audio-call")},100)}}),k.on("call-declined",()=>{G(!1),sessionStorage.removeItem("callData"),alert("Call declined by user")}),k.on("call-ended",()=>{G(!1),sessionStorage.removeItem("callData"),D.push("/users")}),k.on("call-busy",e=>{let{message:a}=e;G(!1),sessionStorage.removeItem("callData"),alert(a)}),()=>{k.off("call-accepted"),k.off("call-declined"),k.off("call-ended"),k.off("call-busy"),k.off("online-users",handleOnlineUsers),k.off("user-status-change",handleUserStatusChange)}},[k,D]);let fetchUser=async()=>{try{let e=await fetch("https://admin.yaari.me/api/users/".concat(l)),a=await e.json();a.profilePic&&(a.profilePic=a.profilePic.replace(/https?:\/\/localhost:\d+/,"https://admin.yaari.me").replace(/https?:\/\/0\.0\.0\.0:\d+/,"https://admin.yaari.me")),a.gallery&&Array.isArray(a.gallery)&&(a.gallery=dedupeByCanonical(a.gallery.map(e=>e.replace(/https?:\/\/localhost:\d+/,"https://admin.yaari.me").replace(/https?:\/\/0\.0\.0\.0:\d+/,"https://admin.yaari.me")))),a=syncGalleryFromLocalIfSameUser(a),S(a),$(a.callAccess||"full")}catch(e){console.error("Error fetching user:",e)}finally{C(!1)}};if(w)return(0,t.jsx)("div",{className:"min-h-screen flex items-center justify-center",children:(0,t.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary"})});if(!N)return(0,t.jsx)("div",{className:"min-h-screen flex items-center justify-center",children:(0,t.jsx)("p",{className:"text-gray-500",children:"User not found"})});let handleCallClick=async(e,a)=>{if(K<a){V(!0);return}let t=(null==N?void 0:N.name)||"User",s=(null==N?void 0:N.profilePic)||"https://api.dicebear.com/7.x/avataaars/svg?seed=".concat(l),r=localStorage.getItem("mediaPermissionsGranted");B({userName:t,userAvatar:s,rate:a,type:e}),"true"===r?P(!0):(_(e),R(!0))},W=N.name||"User";return N.profilePic,(0,t.jsxs)("div",{className:"min-h-screen bg-white",children:[(0,t.jsx)("div",{className:"p-4 safe-top",children:(0,t.jsx)("button",{onClick:a,children:(0,t.jsx)(r.Z,{size:24,className:"text-gray-800"})})}),(0,t.jsxs)("div",{className:"px-6 pb-32",children:[(0,t.jsxs)("div",{className:"flex flex-col items-center mb-6",children:[(0,t.jsxs)("div",{className:"relative mb-3",children:[(0,t.jsx)("div",{className:"w-32 h-32 bg-gray-300 rounded-full overflow-hidden flex items-center justify-center",children:N.profilePic?(0,t.jsx)("img",{src:N.profilePic,alt:"User",className:"w-full h-full object-cover"}):(0,t.jsx)(n.Z,{size:64,className:"text-gray-500"})}),(0,t.jsxs)("div",{className:"absolute top-2 -right-4 bg-white px-2 py-1 rounded-full flex items-center space-x-1",children:[(0,t.jsx)("div",{className:"w-2 h-2 rounded-full ".concat("online"===U?"bg-green-500":"bg-gray-400")}),(0,t.jsx)("span",{className:"text-xs font-medium ".concat("online"===U?"text-green-500":"text-gray-400"),children:"online"===U?j.online:j.offline})]})]}),(0,t.jsx)("h2",{className:"text-xl font-bold text-gray-900",children:W})]}),N.about&&(0,t.jsxs)("div",{className:"mb-6",children:[(0,t.jsx)("h3",{className:"text-primary font-semibold text-lg mb-2",children:j.aboutMe}),(0,t.jsx)("p",{className:"text-gray-700 text-sm leading-relaxed",children:N.about})]}),N.gallery&&N.gallery.length>0&&(0,t.jsxs)("div",{className:"mb-6",children:[(0,t.jsx)("h3",{className:"text-primary font-semibold text-lg mb-3",children:j.photoGallery}),(0,t.jsx)("div",{className:"grid grid-cols-3 gap-2",children:N.gallery.map(e=>(0,t.jsx)("img",{src:e,alt:"Gallery",className:"aspect-square object-cover rounded-lg",onError:()=>{let a=canonicalUrlKey(e);S(e=>({...e,gallery:dedupeByCanonical(((null==e?void 0:e.gallery)||[]).filter(e=>canonicalUrlKey(e)!==a))}))}},canonicalUrlKey(e)))})]}),N.hobbies&&N.hobbies.length>0&&(0,t.jsxs)("div",{className:"mb-6",children:[(0,t.jsx)("h3",{className:"text-primary font-semibold text-lg mb-3",children:j.hobbies}),(0,t.jsx)("div",{className:"flex flex-wrap gap-2",children:N.hobbies.map((e,a)=>(0,t.jsx)("span",{className:"bg-orange-50 text-gray-800 px-4 py-2 rounded-lg text-sm border border-gray-200",children:e},a))})]})]}),"none"!==H&&(0,t.jsx)("div",{className:"fixed bottom-0 left-0 right-0 bg-white p-4 shadow-lg safe-bottom",children:(0,t.jsxs)("div",{className:"flex space-x-3",children:[("video"===H||"full"===H)&&(0,t.jsxs)("button",{onClick:()=>handleCallClick("video",Y),className:"flex-1 bg-primary text-white py-4 rounded-full font-semibold flex items-center justify-center gap-2",children:[(0,t.jsx)(i.Z,{size:18}),(0,t.jsxs)("span",{className:"flex items-center gap-0.5",style:{marginTop:"10px"},children:[Y,(0,t.jsx)("img",{src:"/images/coinicon.png",alt:"coin",className:"w-3 h-3 object-contain inline rounded-full border border-white mb-2.5"}),"/ min"]})]}),("audio"===H||"full"===H)&&(0,t.jsxs)("button",{onClick:()=>handleCallClick("audio",F),className:"flex-1 bg-primary text-white py-4 rounded-full font-semibold flex items-center justify-center gap-2",children:[(0,t.jsx)(c.Z,{size:18}),(0,t.jsxs)("span",{className:"flex items-center gap-0.5",style:{marginTop:"10px"},children:[F,(0,t.jsx)("img",{src:"/images/coinicon.png",alt:"coin",className:"w-3 h-3 object-contain inline rounded-full border border-white mb-2.5"}),"/ min"]})]})]})}),A&&(0,t.jsx)(f.Z,{type:J,onAllow:()=>{localStorage.setItem("mediaPermissionsGranted","true"),R(!1),P(!0)},onDeny:()=>{R(!1),B(null),E(!0)}}),Z&&(0,t.jsx)(g.Z,{onClose:()=>{E(!1),B(null)},onRetry:()=>{E(!1),R(!0)}}),Q&&(0,t.jsx)(x.Z,{onClose:()=>V(!1),onRecharge:()=>{V(!1),b?b():D.push("/coins")}}),O&&z&&(0,t.jsx)(h.Z,{onClose:()=>P(!1),onConfirm:()=>{if(!z||!k)return;P(!1),G(!0);let e=localStorage.getItem("user"),a=e?JSON.parse(e):null,t="call_".concat(Date.now()),s={userName:z.userName,userAvatar:z.userAvatar,rate:z.rate,type:z.type,channelName:t,otherUserId:l,isCaller:!0};console.log("Saving call data with isCaller=true:",s),sessionStorage.setItem("callData",JSON.stringify(s)),k.emit("call-user",{callerId:null==a?void 0:a.id,callerName:(null==a?void 0:a.name)||"User",receiverId:l,callType:z.type,channelName:t})},userName:z.userName,callType:z.type,rate:z.rate,userAvatar:z.userAvatar}),L&&(0,t.jsx)("div",{className:"fixed inset-0 bg-gradient-to-b from-gray-900 to-black flex flex-col items-center justify-center z-50 p-6",children:(0,t.jsxs)("div",{className:"flex flex-col items-center",children:[(0,t.jsxs)("div",{className:"relative mb-8",children:[(0,t.jsx)("div",{className:"absolute inset-0 bg-primary rounded-full animate-ping opacity-20"}),(0,t.jsx)("div",{className:"relative w-32 h-32 bg-gray-300 rounded-full overflow-hidden border-4 border-primary",children:N.profilePic?(0,t.jsx)("img",{src:N.profilePic,alt:"User",className:"w-full h-full object-cover"}):(0,t.jsx)("img",{src:"https://api.dicebear.com/7.x/avataaars/svg?seed=".concat(l),alt:"User",className:"w-full h-full object-cover"})})]}),(0,t.jsx)("h2",{className:"text-white text-2xl font-bold mb-2",children:W}),(0,t.jsx)("p",{className:"text-gray-400 text-lg mb-8",children:"Calling..."}),(0,t.jsxs)("div",{className:"flex items-center space-x-2 mb-12",children:[(0,t.jsx)("div",{className:"w-2 h-2 bg-white rounded-full animate-bounce",style:{animationDelay:"0ms"}}),(0,t.jsx)("div",{className:"w-2 h-2 bg-white rounded-full animate-bounce",style:{animationDelay:"150ms"}}),(0,t.jsx)("div",{className:"w-2 h-2 bg-white rounded-full animate-bounce",style:{animationDelay:"300ms"}})]}),(0,t.jsx)("button",{onClick:()=>{try{let e=sessionStorage.getItem("callData"),a=localStorage.getItem("user"),l=a?JSON.parse(a):null;if(k&&e&&(null==l?void 0:l.id)){let a=JSON.parse(e);(null==a?void 0:a.otherUserId)&&k.emit("end-call",{userId:l.id,otherUserId:a.otherUserId})}}catch(e){}G(!1),sessionStorage.removeItem("callData"),sessionStorage.removeItem("channelName")},className:"w-20 h-20 bg-red-600 rounded-full flex items-center justify-center shadow-lg hover:bg-red-700 transition",children:(0,t.jsx)(c.Z,{size:32,className:"text-white transform rotate-135",style:{transform:"rotate(135deg)"}})}),(0,t.jsx)("p",{className:"text-white text-sm mt-4",children:"End Call"})]})})]})}function UserDetailPage(){let e=(0,s.useRouter)(),a=(0,s.useSearchParams)(),l=a.get("id")||"";return l?(0,t.jsx)(UserDetailScreen,{userId:l,onBack:()=>e.back(),onStartCall:a=>{sessionStorage.setItem("callData",JSON.stringify(a)),e.push("video"===a.type?"/video-call":"/audio-call")}}):(e.replace("/users"),null)}}},function(e){e.O(0,[601,623,952,617,161,971,472,744],function(){return e(e.s=9469)}),_N_E=e.O()}]);