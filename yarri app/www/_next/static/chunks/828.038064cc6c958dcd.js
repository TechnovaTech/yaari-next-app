"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[828],{1828:function(e,l,o){o.r(l),o.d(l,{default:function(){return AudioCallScreen}});var t=o(7437),a=o(2898);let n=(0,a.Z)("Volume2",[["polygon",{points:"11 5 6 9 2 9 2 15 6 15 11 19 11 5",key:"16drj5"}],["path",{d:"M15.54 8.46a5 5 0 0 1 0 7.07",key:"ltjumu"}],["path",{d:"M19.07 4.93a10 10 0 0 1 0 14.14",key:"1kegas"}]]);var s=o(2741),i=o(4043),c=o(2265),r=o(2263),d=o.n(r),u=o(4671),g=o(5997),h=o(4033),m=o(5376),f=o(5128),p=o(2273);function AudioCallScreen(e){let{userName:l,userAvatar:o,rate:a,onEndCall:r}=e,v=(0,h.useRouter)(),{socket:C}=(0,g.useSocket)();(0,m.K)(()=>handleEndCall());let[w,I]=(0,c.useState)(0),[S,y]=(0,c.useState)(!1),[N,x]=(0,c.useState)(!0),[b,j]=(0,c.useState)(null),[D]=(0,c.useState)(()=>d().createClient({mode:"rtc",codec:"vp8"})),[E,k]=(0,c.useState)(!1),[O,T]=(0,c.useState)(null);(0,c.useEffect)(()=>{let e=setInterval(()=>{I(e=>e+1)},1e3);return()=>clearInterval(e)},[]);let handleCoinDeduction=async()=>{try{let e=sessionStorage.getItem("callData");if(console.log("Call data from session:",e),!e)return;let l=JSON.parse(e);console.log("Parsed call data:",l),console.log("isCaller value:",l.isCaller);let o=localStorage.getItem("user");if(!o)return;let t=JSON.parse(o);if(!1===l.isCaller){console.log("Receiver - not deducting coins");return}console.log("Caller - deducting coins"),console.log("Attempting to deduct ".concat(a," coins at ").concat(w,"s"));let n=await (0,p.G)(t.id,a,"audio");console.log("Successfully deducted ".concat(a," coins")),(null==n?void 0:n.newBalance)!==void 0&&T(n.newBalance)}catch(l){var e;console.error("Coin deduction failed:",l),(null===(e=l.message)||void 0===e?void 0:e.includes("Insufficient"))&&(alert("Insufficient coins! Call will end."),handleEndCall())}};(0,c.useEffect)(()=>{10!==w||E?E&&w>10&&(w-10)%60==0&&(console.log("Deduction at ".concat(w," seconds")),handleCoinDeduction()):(console.log("First deduction at 10 seconds"),k(!0),handleCoinDeduction())},[w]),(0,c.useEffect)(()=>{if(!C){console.log("Socket not available in audio call");return}console.log("Setting up call-ended listener in audio call");let handleRemoteCallEnd=()=>{console.log("\uD83D\uDD34 CALL ENDED BY OTHER USER - CLOSING AUDIO CALL");try{b&&(console.log("Closing local audio track"),b.close()),console.log("Leaving Agora channel"),D.leave(),console.log("Clearing session data"),sessionStorage.removeItem("callData"),sessionStorage.removeItem("channelName"),console.log("Navigating to /users"),window.location.href="/users"}catch(e){console.error("Error during call cleanup:",e),v.push("/users")}};return C.on("call-ended",handleRemoteCallEnd),console.log("call-ended listener registered"),()=>{console.log("Removing call-ended listener"),C.off("call-ended",handleRemoteCallEnd)}},[C,b,D,v]),(0,c.useEffect)(()=>{let init=async()=>{try{let o=sessionStorage.getItem("channelName")||"audio_".concat(Date.now()),t=await fetch("https://admin.yaari.me/api/agora/token",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({channelName:o})}),{token:a}=await t.json();console.log("Got Agora token"),await D.join(u.X.appId,o,a,null);let n=await d().createMicrophoneAudioTrack();j(n),n.setVolume(100),await D.publish([n]);let s=sessionStorage.getItem("callData");if(s){let t=JSON.parse(s),a=localStorage.getItem("user"),n=a?JSON.parse(a):null;if((null==n?void 0:n.id)&&t.otherUserId)try{var e,l;console.log("\uD83D\uDCE4 Logging audio call start:",{callerId:n.id,receiverId:t.otherUserId});let a=(null===(l=window.Capacitor)||void 0===l?void 0:null===(e=l.isNativePlatform)||void 0===e?void 0:e.call(l))?"".concat("https://admin.yaari.me","/api/call-log"):"/api/call-log",s=await fetch(a,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({callerId:n.id,receiverId:t.otherUserId,callType:"audio",action:"start",channelName:o})});if(!s.ok)throw Error("Failed to log call start: ".concat(s.status));let i=await s.json();i.sessionId&&sessionStorage.setItem("callSessionId",i.sessionId),console.log("✅ Audio call start logged:",i)}catch(e){console.error("❌ Failed to log audio call start:",e),alert("Warning: Call logging failed. Call may not appear in history.")}}}catch(e){console.error("Agora audio init error:",e)}};return D.on("user-published",async(e,l)=>{if(await D.subscribe(e,l),"audio"===l){var o,t;null===(o=e.audioTrack)||void 0===o||o.play(),null===(t=e.audioTrack)||void 0===t||t.setVolume(100)}}),init(),(0,f.o$)("Audio Call"),()=>{null==b||b.close(),D.leave()}},[]);let toggleMute=async()=>{b&&(await b.setEnabled(S),y(!S))},handleEndCall=async()=>{console.log("\uD83D\uDD34 USER CLICKED END CALL BUTTON");let e=sessionStorage.getItem("callData");console.log("Call data:",e);let o=Math.ceil(w/60)*a;if((0,f.L9)("Call Ended",{"Call Type":"audio",Duration:w,Cost:o,"Ended By":"User",Receiver:l}),e){let l=JSON.parse(e),a=localStorage.getItem("user"),s=a?JSON.parse(a):null;if((null==s?void 0:s.id)&&l.otherUserId)try{var t,n;console.log("\uD83D\uDCE4 Logging audio call end:",{callerId:s.id,receiverId:l.otherUserId,duration:w,cost:o});let e=(null===(n=window.Capacitor)||void 0===n?void 0:null===(t=n.isNativePlatform)||void 0===t?void 0:t.call(n))?"".concat("https://admin.yaari.me","/api/call-log"):"/api/call-log",a=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({callerId:s.id,receiverId:l.otherUserId,callType:"audio",action:"end",duration:w,cost:o,status:"completed"})});if(!a.ok)throw Error("Failed to log call end: ".concat(a.status));let i=await a.json();i.verified||console.warn("⚠️ Call saved but verification failed"),console.log("✅ Audio call end logged:",i)}catch(e){console.error("❌ Failed to log audio call end:",e),alert("Warning: Failed to save call to history.")}}if(e&&C){let l=JSON.parse(e),o=localStorage.getItem("user"),t=o?JSON.parse(o):null;console.log("Current user:",null==t?void 0:t.id),console.log("Other user:",l.otherUserId),l.otherUserId&&(null==t?void 0:t.id)?(console.log("\uD83D\uDCE4 EMITTING end-call TO:",l.otherUserId),C.emit("end-call",{userId:t.id,otherUserId:l.otherUserId}),console.log("end-call event emitted successfully")):console.log("Missing otherUserId or current userId")}else console.log("No call data or socket not available");console.log("Cleaning up local resources"),b&&b.close(),D.leave(),sessionStorage.removeItem("callData"),sessionStorage.removeItem("channelName"),console.log("Navigating back to users page"),window.location.href="/users"},U=Math.ceil(w/60)*a;return(0,t.jsxs)("div",{className:"full-screen-page bg-gradient-to-b from-primary to-orange-600 flex flex-col items-center justify-center p-8",children:[(0,t.jsxs)("div",{className:"flex-1 flex flex-col items-center justify-center",children:[(0,t.jsx)("div",{className:"w-40 h-40 rounded-full overflow-hidden bg-white/20 mb-8",children:(0,t.jsx)("img",{src:o,alt:l,className:"w-full h-full object-cover"})}),(0,t.jsx)("h2",{className:"text-3xl font-bold text-white mb-4",children:l}),(0,t.jsx)("p",{className:"text-2xl text-white mb-2",children:"".concat(Math.floor(w/60).toString().padStart(2,"0"),":").concat((w%60).toString().padStart(2,"0"))}),(0,t.jsxs)("p",{className:"text-lg text-white/80",children:["₹",U]}),null!==O&&O<=a&&(0,t.jsxs)("div",{className:"mt-4 bg-red-500/90 backdrop-blur-sm px-4 py-2 rounded-full flex items-center gap-2 animate-pulse",children:[(0,t.jsx)("img",{src:"/images/coinicon.png",alt:"coin",className:"w-4 h-4 object-contain"}),(0,t.jsxs)("span",{className:"text-white font-semibold mt-2.5",children:[O," coins left"]})]})]}),(0,t.jsxs)("div",{className:"flex justify-center items-center space-x-6 mb-8",children:[(0,t.jsx)("button",{onClick:()=>x(!N),className:"w-14 h-14 rounded-full flex items-center justify-center ".concat(N?"bg-white":"bg-white/30"),children:(0,t.jsx)(n,{className:N?"text-primary":"text-white",size:24})}),(0,t.jsx)("button",{onClick:handleEndCall,className:"w-16 h-16 bg-red-500 rounded-full flex items-center justify-center shadow-lg",children:(0,t.jsx)(s.Z,{className:"text-white rotate-[135deg]",size:28})}),(0,t.jsx)("button",{onClick:toggleMute,className:"w-14 h-14 rounded-full flex items-center justify-center ".concat(S?"bg-red-500":"bg-white/30"),children:(0,t.jsx)(i.Z,{className:"text-white",size:24})})]})]})}}}]);