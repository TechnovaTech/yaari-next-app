"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[828],{1828:function(e,l,t){t.r(l),t.d(l,{default:function(){return AudioCallScreen}});var o=t(7437),a=t(2898);let n=(0,a.Z)("Volume2",[["polygon",{points:"11 5 6 9 2 9 2 15 6 15 11 19 11 5",key:"16drj5"}],["path",{d:"M15.54 8.46a5 5 0 0 1 0 7.07",key:"ltjumu"}],["path",{d:"M19.07 4.93a10 10 0 0 1 0 14.14",key:"1kegas"}]]);var s=t(2741),i=t(4043),c=t(2265),r=t(2263),d=t.n(r),u=t(4671),g=t(5997),h=t(4033),m=t(5376),f=t(5128),p=t(2273),v=t(3103),w=t(4064);function AudioCallScreen(e){let{userName:l,userAvatar:t,rate:a,onEndCall:r}=e,C=(0,h.useRouter)(),{socket:S}=(0,g.useSocket)();(0,m.K)(()=>handleEndCall());let[y,I]=(0,c.useState)(0),[N,x]=(0,c.useState)(!1),[b,j]=(0,c.useState)(!0),[D,E]=(0,c.useState)(null),[k]=(0,c.useState)(()=>d().createClient({mode:"rtc",codec:"vp8"})),[O,T]=(0,c.useState)(!1),[A,U]=(0,c.useState)(null);(0,c.useEffect)(()=>{let e=setInterval(()=>{I(e=>e+1)},1e3);return()=>clearInterval(e)},[]);let handleCoinDeduction=async()=>{try{let e=sessionStorage.getItem("callData");if(console.log("Call data from session:",e),!e)return;let l=JSON.parse(e);console.log("Parsed call data:",l),console.log("isCaller value:",l.isCaller);let t=localStorage.getItem("user");if(!t)return;let o=JSON.parse(t);if(!1===l.isCaller){console.log("Receiver - not deducting coins");return}console.log("Caller - deducting coins"),console.log("Attempting to deduct ".concat(a," coins at ").concat(y,"s"));let n=await (0,p.G)(o.id,a,"audio");console.log("Successfully deducted ".concat(a," coins")),(null==n?void 0:n.newBalance)!==void 0&&U(n.newBalance)}catch(l){var e;console.error("Coin deduction failed:",l),(null===(e=l.message)||void 0===e?void 0:e.includes("Insufficient"))&&(alert("Insufficient coins! Call will end."),handleEndCall())}};(0,c.useEffect)(()=>{10!==y||O?O&&y>10&&(y-10)%60==0&&(console.log("Deduction at ".concat(y," seconds")),handleCoinDeduction()):(console.log("First deduction at 10 seconds"),T(!0),handleCoinDeduction())},[y]),(0,c.useEffect)(()=>{if(!S){console.log("Socket not available in audio call");return}console.log("Setting up call-ended listener in audio call");let handleRemoteCallEnd=()=>{console.log("\uD83D\uDD34 CALL ENDED BY OTHER USER - CLOSING AUDIO CALL");try{D&&(console.log("Closing local audio track"),D.close()),console.log("Leaving Agora channel"),k.leave(),console.log("Clearing session data"),sessionStorage.removeItem("callData"),sessionStorage.removeItem("channelName"),console.log("Navigating to /users"),window.location.href="/users"}catch(e){console.error("Error during call cleanup:",e),C.push("/users")}};return S.on("call-ended",handleRemoteCallEnd),console.log("call-ended listener registered"),()=>{console.log("Removing call-ended listener"),S.off("call-ended",handleRemoteCallEnd)}},[S,D,k,C]),(0,c.useEffect)(()=>{let init=async()=>{try{let t=sessionStorage.getItem("channelName")||"audio_".concat(Date.now()),o=await fetch("https://admin.yaari.me/api/agora/token",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({channelName:t})}),{token:a}=await o.json();console.log("Got Agora token"),await k.join(u.X.appId,t,a,null);let n=await d().createMicrophoneAudioTrack();if(E(n),n.setVolume(100),await k.publish([n]),v.dV.isNativePlatform())try{await w.Z.enterCommunicationMode(),await w.Z.setSpeakerphoneOn({on:!0})}catch(e){console.warn("AudioRouting init failed:",e)}let s=sessionStorage.getItem("callData");if(s){let o=JSON.parse(s),a=localStorage.getItem("user"),n=a?JSON.parse(a):null;if((null==n?void 0:n.id)&&o.otherUserId)try{var e,l;console.log("\uD83D\uDCE4 Logging audio call start:",{callerId:n.id,receiverId:o.otherUserId});let a=(null===(l=window.Capacitor)||void 0===l?void 0:null===(e=l.isNativePlatform)||void 0===e?void 0:e.call(l))?"".concat("https://admin.yaari.me","/api/call-log"):"/api/call-log",s=await fetch(a,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({callerId:n.id,receiverId:o.otherUserId,callType:"audio",action:"start",channelName:t})});if(!s.ok)throw Error("Failed to log call start: ".concat(s.status));let i=await s.json();i.sessionId&&sessionStorage.setItem("callSessionId",i.sessionId),console.log("✅ Audio call start logged:",i)}catch(e){console.error("❌ Failed to log audio call start:",e),alert("Warning: Call logging failed. Call may not appear in history.")}}}catch(e){console.error("Agora audio init error:",e)}};return k.on("user-published",async(e,l)=>{if(await k.subscribe(e,l),"audio"===l){var t,o;null===(t=e.audioTrack)||void 0===t||t.play(),null===(o=e.audioTrack)||void 0===o||o.setVolume(100)}}),init(),(0,f.o$)("Audio Call"),()=>{if(null==D||D.close(),k.leave(),v.dV.isNativePlatform())try{w.Z.resetAudio()}catch(e){}}},[]);let toggleMute=async()=>{D&&(await D.setEnabled(N),x(!N))},toggleSpeaker=async()=>{let e=!b;if(j(e),v.dV.isNativePlatform())try{await w.Z.setSpeakerphoneOn({on:e})}catch(e){console.warn("Failed to toggle speakerphone:",e)}},handleEndCall=async()=>{console.log("\uD83D\uDD34 USER CLICKED END CALL BUTTON");let e=sessionStorage.getItem("callData");console.log("Call data:",e);let t=Math.ceil(y/60)*a;if((0,f.L9)("Call Ended",{"Call Type":"audio",Duration:y,Cost:t,"Ended By":"User",Receiver:l}),e){let l=JSON.parse(e),a=localStorage.getItem("user"),s=a?JSON.parse(a):null;if((null==s?void 0:s.id)&&l.otherUserId)try{var o,n;console.log("\uD83D\uDCE4 Logging audio call end:",{callerId:s.id,receiverId:l.otherUserId,duration:y,cost:t});let e=(null===(n=window.Capacitor)||void 0===n?void 0:null===(o=n.isNativePlatform)||void 0===o?void 0:o.call(n))?"".concat("https://admin.yaari.me","/api/call-log"):"/api/call-log",a=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({callerId:s.id,receiverId:l.otherUserId,callType:"audio",action:"end",duration:y,cost:t,status:"completed"})});if(!a.ok)throw Error("Failed to log call end: ".concat(a.status));let i=await a.json();i.verified||console.warn("⚠️ Call saved but verification failed"),console.log("✅ Audio call end logged:",i)}catch(e){console.error("❌ Failed to log audio call end:",e),alert("Warning: Failed to save call to history.")}}if(e&&S){let l=JSON.parse(e),t=localStorage.getItem("user"),o=t?JSON.parse(t):null;console.log("Current user:",null==o?void 0:o.id),console.log("Other user:",l.otherUserId),l.otherUserId&&(null==o?void 0:o.id)?(console.log("\uD83D\uDCE4 EMITTING end-call TO:",l.otherUserId),S.emit("end-call",{userId:o.id,otherUserId:l.otherUserId}),console.log("end-call event emitted successfully")):console.log("Missing otherUserId or current userId")}else console.log("No call data or socket not available");if(console.log("Cleaning up local resources"),D&&D.close(),k.leave(),sessionStorage.removeItem("callData"),sessionStorage.removeItem("channelName"),v.dV.isNativePlatform())try{await w.Z.resetAudio()}catch(e){}console.log("Navigating back to users page"),window.location.href="/users"},L=Math.ceil(y/60)*a;return(0,o.jsxs)("div",{className:"full-screen-page bg-gradient-to-b from-primary to-orange-600 flex flex-col items-center justify-center p-8",children:[(0,o.jsxs)("div",{className:"flex-1 flex flex-col items-center justify-center",children:[(0,o.jsx)("div",{className:"w-40 h-40 rounded-full overflow-hidden bg-white/20 mb-8",children:(0,o.jsx)("img",{src:t,alt:l,className:"w-full h-full object-cover"})}),(0,o.jsx)("h2",{className:"text-3xl font-bold text-white mb-4",children:l}),(0,o.jsx)("p",{className:"text-2xl text-white mb-2",children:"".concat(Math.floor(y/60).toString().padStart(2,"0"),":").concat((y%60).toString().padStart(2,"0"))}),(0,o.jsxs)("p",{className:"text-lg text-white/80",children:["₹",L]}),null!==A&&A<=a&&(0,o.jsxs)("div",{className:"mt-4 bg-red-500/90 backdrop-blur-sm px-4 py-2 rounded-full flex items-center gap-2 animate-pulse",children:[(0,o.jsx)("img",{src:"/images/coinicon.png",alt:"coin",className:"w-4 h-4 object-contain"}),(0,o.jsxs)("span",{className:"text-white font-semibold mt-2.5",children:[A," coins left"]})]})]}),(0,o.jsxs)("div",{className:"flex justify-center items-center space-x-6 mb-8",children:[(0,o.jsx)("button",{onClick:toggleSpeaker,className:"w-14 h-14 rounded-full flex items-center justify-center ".concat(b?"bg-white":"bg-white/30"),children:(0,o.jsx)(n,{className:b?"text-primary":"text-white",size:24})}),(0,o.jsx)("button",{onClick:handleEndCall,className:"w-16 h-16 bg-red-500 rounded-full flex items-center justify-center shadow-lg",children:(0,o.jsx)(s.Z,{className:"text-white rotate-[135deg]",size:28})}),(0,o.jsx)("button",{onClick:toggleMute,className:"w-14 h-14 rounded-full flex items-center justify-center ".concat(N?"bg-red-500":"bg-white/30"),children:(0,o.jsx)(i.Z,{className:"text-white",size:24})})]})]})}}}]);