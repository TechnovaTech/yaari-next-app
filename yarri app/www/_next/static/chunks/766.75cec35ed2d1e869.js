"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[766],{4043:function(e,t,l){l.d(t,{Z:function(){return n}});var o=l(2898);let n=(0,o.Z)("Mic",[["path",{d:"M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z",key:"131961"}],["path",{d:"M19 10v2a7 7 0 0 1-14 0v-2",key:"1vc78b"}],["line",{x1:"12",x2:"12",y1:"19",y2:"22",key:"x3vr5v"}]])},8339:function(e,t,l){l.d(t,{Z:function(){return n}});var o=l(2898);let n=(0,o.Z)("Video",[["path",{d:"m22 8-6 4 6 4V8Z",key:"50v9me"}],["rect",{width:"14",height:"12",x:"2",y:"6",rx:"2",ry:"2",key:"1rqjg6"}]])},5766:function(e,t,l){l.r(t),l.d(t,{default:function(){return VideoCallScreen}});var o=l(7437),n=l(2898);let a=(0,n.Z)("RefreshCw",[["path",{d:"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8",key:"v9h5vc"}],["path",{d:"M21 3v5h-5",key:"1q7to0"}],["path",{d:"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16",key:"3uifl3"}],["path",{d:"M8 16H3v5",key:"1cv678"}]]);var r=l(4043),c=l(2741),i=l(8339),s=l(2265),d=l(2263),u=l.n(d),p=l(4671),g=l(5997),f=l(4033),v=l(5376),h=l(5128);function VideoCallScreen(e){let{userName:t,userAvatar:l,rate:n,onEndCall:d}=e,m=(0,f.useRouter)(),{socket:y}=(0,g.useSocket)();(0,v.K)(()=>handleEndCall());let[S,k]=(0,s.useState)(0),[b,C]=(0,s.useState)(!1),[w,x]=(0,s.useState)(!1),[N,D]=(0,s.useState)("user"),[E,I]=(0,s.useState)(null),[T,P]=(0,s.useState)(null),[j,O]=(0,s.useState)([]),[U]=(0,s.useState)(()=>u().createClient({mode:"rtc",codec:"vp8"}));(0,s.useEffect)(()=>{let e=setInterval(()=>{k(e=>e+1)},1e3);return()=>clearInterval(e)},[]),(0,s.useEffect)(()=>{if(!y){console.log("Socket not available in video call");return}console.log("Setting up call-ended listener in video call");let handleRemoteCallEnd=()=>{console.log("\uD83D\uDD34 CALL ENDED BY OTHER USER - CLOSING VIDEO CALL");try{E&&(console.log("Closing local video track"),E.close()),T&&(console.log("Closing local audio track"),T.close()),console.log("Leaving Agora channel"),U.leave(),console.log("Clearing session data"),sessionStorage.removeItem("callData"),sessionStorage.removeItem("channelName"),console.log("Navigating to /users"),window.location.href="/users"}catch(e){console.error("Error during call cleanup:",e),m.push("/users")}};return y.on("call-ended",handleRemoteCallEnd),console.log("call-ended listener registered"),()=>{console.log("Removing call-ended listener"),y.off("call-ended",handleRemoteCallEnd)}},[y,E,T,U,m]),(0,s.useEffect)(()=>{let init=async()=>{try{let e=sessionStorage.getItem("channelName")||"call_".concat(Date.now()),t=await fetch("https://acsgroup.cloud/api/agora/token",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({channelName:e})}),{token:l}=await t.json();console.log("Got Agora token"),await U.join(p.X.appId,e,l,null);let o=await u().createMicrophoneAudioTrack(),n=await u().createCameraVideoTrack();P(o),I(n),await U.publish([o,n]),n.play("local-video");let a=sessionStorage.getItem("callData");if(a){let t=JSON.parse(a),l=localStorage.getItem("user"),o=l?JSON.parse(l):null;if((null==o?void 0:o.id)&&t.otherUserId)try{await fetch("/api/call-log",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({callerId:o.id,receiverId:t.otherUserId,callType:"video",action:"start",channelName:e})}),console.log("Call start logged successfully")}catch(e){console.error("Failed to log call start:",e)}}}catch(e){console.error("Agora init error:",e)}};return U.on("user-published",async(e,t)=>{if(await U.subscribe(e,t),"video"===t&&(O(t=>[...t,e]),setTimeout(()=>{var t;return null===(t=e.videoTrack)||void 0===t?void 0:t.play("remote-video")},100)),"audio"===t){var l;null===(l=e.audioTrack)||void 0===l||l.play()}}),U.on("user-unpublished",e=>{O(t=>t.filter(t=>t.uid!==e.uid))}),init(),(0,h.o$)("Video Call"),()=>{null==E||E.close(),null==T||T.close(),U.leave()}},[]);let toggleMute=async()=>{T&&(await T.setEnabled(b),C(!b))},toggleVideo=async()=>{E&&(await E.setEnabled(w),x(!w))},flipCamera=async()=>{try{if(E){E.close();let e="user"===N?"environment":"user",t=await u().createCameraVideoTrack({facingMode:e});await U.unpublish([E]),await U.publish([t]),I(t),D(e),t.play("local-video"),console.log("Camera flipped to:",e)}}catch(e){console.error("Error flipping camera:",e),alert("Could not flip camera. Make sure you have multiple cameras.")}},handleEndCall=async()=>{console.log("\uD83D\uDD34 USER CLICKED END CALL BUTTON");let e=sessionStorage.getItem("callData");console.log("Call data:",e);let l=Math.ceil(S/60)*n;if((0,h.L9)("Call Ended",{"Call Type":"video",Duration:S,Cost:l,"Ended By":"User",Receiver:t}),e){let t=JSON.parse(e),o=localStorage.getItem("user"),n=o?JSON.parse(o):null;if((null==n?void 0:n.id)&&t.otherUserId)try{await fetch("/api/call-log",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({callerId:n.id,receiverId:t.otherUserId,callType:"video",action:"end",duration:S,cost:l,status:"completed"})}),console.log("Call end logged successfully")}catch(e){console.error("Failed to log call end:",e)}}if(e&&y){let t=JSON.parse(e),l=localStorage.getItem("user"),o=l?JSON.parse(l):null;console.log("Current user:",null==o?void 0:o.id),console.log("Other user:",t.otherUserId),t.otherUserId&&(null==o?void 0:o.id)?(console.log("\uD83D\uDCE4 EMITTING end-call TO:",t.otherUserId),y.emit("end-call",{userId:o.id,otherUserId:t.otherUserId}),console.log("end-call event emitted successfully")):console.log("Missing otherUserId or current userId")}else console.log("No call data or socket not available");console.log("Cleaning up local resources"),E&&E.close(),T&&T.close(),U.leave(),sessionStorage.removeItem("callData"),sessionStorage.removeItem("channelName"),console.log("Navigating back to users page"),window.location.href="/users"};return(0,o.jsxs)("div",{className:"full-screen-page bg-gray-900 flex flex-col",children:[(0,o.jsxs)("div",{className:"flex-1 relative",children:[(0,o.jsx)("div",{id:"remote-video",className:"absolute inset-0 bg-gray-800",children:0===j.length&&(0,o.jsx)("div",{className:"absolute inset-0"})}),(0,o.jsxs)("div",{className:"absolute top-8 left-0 right-0 text-center text-white z-10",children:[(0,o.jsx)("h2",{className:"text-2xl font-bold mb-2",children:t}),(0,o.jsx)("p",{className:"text-lg",children:"".concat(Math.floor(S/60).toString().padStart(2,"0"),":").concat((S%60).toString().padStart(2,"0"))}),(0,o.jsxs)("p",{className:"text-sm text-gray-400 mt-1",children:["₹",Math.ceil(S/60)*n]})]}),(0,o.jsxs)("div",{className:"absolute bottom-32 left-4 z-10",children:[(0,o.jsx)("div",{id:"local-video",className:"w-24 h-32 bg-gray-800 rounded-lg overflow-hidden"}),(0,o.jsx)("button",{onClick:flipCamera,className:"absolute top-2 right-2 w-8 h-8 bg-black/50 rounded-full flex items-center justify-center",children:(0,o.jsx)(a,{className:"text-white",size:16})})]})]}),(0,o.jsxs)("div",{className:"p-8 flex justify-center items-center space-x-4",children:[(0,o.jsx)("button",{onClick:toggleMute,className:"w-14 h-14 rounded-full flex items-center justify-center ".concat(b?"bg-red-500":"bg-gray-700"),children:(0,o.jsx)(r.Z,{className:"text-white",size:24})}),(0,o.jsx)("button",{onClick:handleEndCall,className:"w-16 h-16 bg-red-500 rounded-full flex items-center justify-center shadow-lg",children:(0,o.jsx)(c.Z,{className:"text-white rotate-[135deg]",size:28})}),(0,o.jsx)("button",{onClick:toggleVideo,className:"w-14 h-14 rounded-full flex items-center justify-center ".concat(w?"bg-red-500":"bg-gray-700"),children:(0,o.jsx)(i.Z,{className:"text-white",size:24})})]})]})}},4671:function(e,t,l){l.d(t,{X:function(){return o}});let o={appId:"5296c3e4d4b2432f8cf42a9f8e2041e5"}},5997:function(e,t,l){l.r(t),l.d(t,{SocketProvider:function(){return SocketProvider},useSocket:function(){return useSocket}});var o=l(7437),n=l(2265),a=l(4337);let r=(0,n.createContext)({socket:null,isConnected:!1,incomingCall:null,setIncomingCall:()=>{}}),useSocket=()=>(0,n.useContext)(r);function SocketProvider(e){let{children:t}=e,[l,c]=(0,n.useState)(null),[i,s]=(0,n.useState)(!1),[d,u]=(0,n.useState)(null);return(0,n.useEffect)(()=>{let e="https://acsgroup.cloud";console.log("\uD83D\uDD0C Attempting to connect to Socket.io server:",e);let t=(0,a.io)(e,{transports:["websocket","polling"],timeout:2e4,forceNew:!0,reconnection:!0,reconnectionDelay:1e3,reconnectionAttempts:5});return t.on("connect",()=>{console.log("✅ Socket connected successfully"),s(!0);let e=localStorage.getItem("user");if(e)try{let l=JSON.parse(e);console.log("\uD83D\uDC64 Registering user:",l.id),t.emit("register",l.id)}catch(e){console.error("❌ Error parsing user data:",e)}}),t.on("connect_error",e=>{console.error("❌ Socket connection error:",e),s(!1)}),t.on("disconnect",e=>{console.log("\uD83D\uDD0C Socket disconnected:",e),s(!1)}),t.on("reconnect",e=>{console.log("\uD83D\uDD04 Socket reconnected after",e,"attempts"),s(!0)}),t.on("reconnect_error",e=>{console.error("❌ Socket reconnection error:",e)}),t.on("incoming-call",e=>{let{callerId:t,callerName:l,callType:o,channelName:n}=e;console.log("\uD83D\uDCE5 Incoming call (global):",{callerId:t,callerName:l,callType:o,channelName:n}),u({callerId:t,callerName:l,callType:o,channelName:n})}),t.on("call-accepted",e=>{let{channelName:t,callType:l}=e;console.log("✅ Call accepted (global):",{channelName:t,callType:l});try{t&&sessionStorage.setItem("channelName",t);let e=sessionStorage.getItem("callData"),o=l||"audio";if(e)try{let t=JSON.parse(e);((null==t?void 0:t.type)==="video"||(null==t?void 0:t.type)==="audio")&&(o=t.type)}catch(e){}else l&&sessionStorage.setItem("callData",JSON.stringify({userName:"",userAvatar:"",rate:"video"===l?10:5,type:l,channelName:t,otherUserId:""}));let n="video"===o?"/video-call":"/audio-call";window.location.href=n}catch(e){console.error("Error handling global call-accepted:",e)}}),t.on("call-busy",e=>{let{message:t}=e;console.log("\uD83D\uDCF5 Call busy:",t),alert(t)}),t.on("call-ended",()=>{console.log("\uD83D\uDED1 Call ended (global) — clearing incomingCall"),u(null)}),c(t),()=>{console.log("\uD83E\uDDF9 Cleaning up socket connection"),t.off("incoming-call"),t.off("call-accepted"),t.off("call-busy"),t.off("call-ended"),t.off("connect"),t.off("connect_error"),t.off("disconnect"),t.off("reconnect"),t.off("reconnect_error"),t.disconnect()}},[]),(0,o.jsx)(r.Provider,{value:{socket:l,isConnected:i,incomingCall:d,setIncomingCall:u},children:t})}},5376:function(e,t,l){l.d(t,{K:function(){return useBackButton}});var o=l(2265),n=l(4033),a=l(3103);let r=(0,a.fo)("App",{web:()=>l.e(762).then(l.bind(l,6762)).then(e=>new e.AppWeb)});function useBackButton(e){let t=(0,n.useRouter)();(0,o.useEffect)(()=>{let l=Promise.resolve(r.addListener("backButton",l=>{let{canGoBack:o}=l;e?e():o&&t.back()}));return()=>{l.then(e=>e.remove()).catch(()=>{})}},[e,t])}},5128:function(e,t,l){l.d(t,{H4:function(){return trackAppOpen},L9:function(){return trackEvent},Lj:function(){return updateUserProfile},QU:function(){return trackUserLogin},Tf:function(){return trackSubscription},YY:function(){return trackProfileView},o$:function(){return trackScreenView}});var o=l(1007),n=l(3103),a=l(4725);(()=>{if(n.dV.isNativePlatform())return;let e=window;if(e.clevertap)return;e.clevertap={event:[],profile:[],account:[],onUserLogin:[],region:"eu1"},e.clevertap.account.push({id:"775-RZ7-W67Z"});let t=document.createElement("script");t.src="https://static.clevertap.com/js/clevertap.min.js",t.type="text/javascript",t.async=!0,t.onload=()=>console.log("CleverTap Web SDK loaded"),t.onerror=e=>console.error("CleverTap Web SDK load failed:",e);let l=document.getElementsByTagName("script")[0];((null==l?void 0:l.parentNode)||document.head).insertBefore(t,l||null)})(),(0,a.BP)();let isCleverTapAvailable=()=>n.dV.isNativePlatform(),formatPhoneE164=e=>{if(!e)return;let t=String(e).trim();if(t.startsWith("+"))return t;let l=t.replace(/[^0-9]/g,"");return 10===l.length?"+91".concat(l):12===l.length&&l.startsWith("91")?"+".concat(l):void 0},updateUserProfile=async e=>{let t={...e},l=formatPhoneE164(e.Phone);l?t.Phone=l:delete t.Phone;try{(0,a.Bq)(t)}catch(e){}if(isCleverTapAvailable())try{await o.z.profileSet(t)}catch(e){console.log("CleverTap profileSet error:",e)}else try{var n,r;null===(r=window.clevertap)||void 0===r||null===(n=r.profile)||void 0===n||n.push({Site:t})}catch(e){console.log("Web CleverTap profile push error:",e)}},trackUserLogin=async(e,t)=>{let l={Identity:e,...t||{}},n=formatPhoneE164(l.Phone);n?l.Phone=n:delete l.Phone;try{(0,a.xU)(e),l&&(0,a.Bq)(l)}catch(e){}if(isCleverTapAvailable())try{await o.z.onUserLogin(l)}catch(e){console.log("CleverTap onUserLogin error:",e)}else try{var r,c;null===(c=window.clevertap)||void 0===c||null===(r=c.onUserLogin)||void 0===r||r.push({Site:l})}catch(e){console.log("Web CleverTap onUserLogin error:",e)}},trackEvent=async(e,t)=>{try{(0,a.WO)(e,t)}catch(e){}if(isCleverTapAvailable())try{t&&Object.keys(t).length>0?await o.z.recordEventWithNameAndProps(e,t):await o.z.recordEventWithName(e)}catch(e){console.log("CleverTap recordEvent error:",e)}else try{var l,n,r,c;t&&Object.keys(t).length>0?null===(n=window.clevertap)||void 0===n||null===(l=n.event)||void 0===l||l.push(e,t):null===(c=window.clevertap)||void 0===c||null===(r=c.event)||void 0===r||r.push(e)}catch(e){console.log("Web CleverTap event push error:",e)}},trackProfileView=async e=>{await trackEvent("Profile Viewed",{"Viewed User ID":e})},trackSubscription=async(e,t,l)=>{await trackEvent("Subscription Purchased",{"Plan Name":e,Amount:t,Currency:l})},trackAppOpen=async()=>{try{(0,a.WO)("App Open")}catch(e){}if(isCleverTapAvailable())try{await o.z.notifyDeviceReady(),await o.z.recordEventWithName("App Open")}catch(e){console.log("CleverTap notifyDeviceReady/App Open error:",e)}else try{var e,t;null===(t=window.clevertap)||void 0===t||null===(e=t.event)||void 0===e||e.push("App Open")}catch(e){console.log("Web CleverTap App Open error:",e)}},trackScreenView=async e=>{await trackEvent("Screen View",{"Screen Name":e})}},4725:function(e,t,l){l.d(t,{BP:function(){return initMixpanel},Bq:function(){return mixpanelPeopleSet},WO:function(){return mixpanelTrack},xU:function(){return mixpanelIdentify}});var o=l(718);let n=!1,getToken=()=>{let e="b19e0189e8c34fe2a980f09ba1ceeedc";return e&&e.trim().length>0?e.trim():"b19e0189e8c34fe2a980f09ba1ceeedc"},initMixpanel=e=>{if(n)return;let t=e||getToken();if(!t){console.warn("Mixpanel token missing. Set NEXT_PUBLIC_MIXPANEL_TOKEN in .env.local");return}o.Z.init(t,{debug:!0,track_pageview:!1}),n=!0,console.log("Mixpanel initialized")},mixpanelTrack=(e,t)=>{try{if(initMixpanel(),!n)return;t&&Object.keys(t).length>0?o.Z.track(e,t):o.Z.track(e)}catch(e){console.log("Mixpanel track error:",e)}},mixpanelIdentify=e=>{try{if(initMixpanel(),!n)return;o.Z.identify(e)}catch(e){console.log("Mixpanel identify error:",e)}},normalizePeopleProps=e=>{var t,l,o;let n={...e},a=null!==(t=e.Name)&&void 0!==t?t:e.name,r=null!==(l=e.Email)&&void 0!==l?l:e.email,c=null!==(o=e.Phone)&&void 0!==o?o:e.phone;return a&&(n.$name=String(a),delete n.Name,delete n.name),r&&(n.$email=String(r),delete n.Email,delete n.email),c&&(n.$phone=String(c),delete n.Phone,delete n.phone),n},mixpanelPeopleSet=e=>{try{if(initMixpanel(),!n)return;let t=normalizePeopleProps(e);o.Z.people.set(t)}catch(e){console.log("Mixpanel people.set error:",e)}}}}]);