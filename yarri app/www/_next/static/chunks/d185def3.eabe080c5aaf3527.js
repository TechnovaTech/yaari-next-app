(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[929],{2263:function(L,k,M){var U=M(2601),V=M(263).Buffer;L.exports=function(){"use strict";let L,k,F,B;function e(L,k){return k.forEach(function(k){k&&"string"!=typeof k&&!Array.isArray(k)&&Object.keys(k).forEach(function(M){if("default"!==M&&!(M in L)){var U=Object.getOwnPropertyDescriptor(k,M);Object.defineProperty(L,M,U.get?U:{enumerable:!0,get:function(){return k[M]}})}})}),Object.freeze(L)}var j,G,X,$,ee,et,ei,er,en,ea,eo,es,ec,ed,el,eu,eh,ep,e_,eE,em,ef,eS,eT,eR,eI,ev,eC,ey,eb,eN,eP,eL,ek,eU,eV,eW,eG,eY,eJ,eX,eQ,eZ,e$,e0,e1,e2,e3,e5,e4,e6,e8,e9,e7,te,tt,ti,tr,tn,ta,to,ts,tc,td,tl,tu,th,tp,t_,tE,tm,tf,tS,tT,tR,tI,tC,ty,tb,tO,tN,tP,tL,tk,tU,tV,tF,tB,tj,tW,tG,tH,tY,tq,tJ,tX,tQ,tZ,t$,t0,t1,t2,t3,t5,t4,t6,t8,t9,t7,ie,it,ii,ia,io,is,ic,il,iu,ih,ip,i_,iE,im,iT,iR,iI,iv,iC,iy,iA,ib,iO,iN,iP,iL,ik,iU,iV,iB,iW,iG,iY,iJ,iX,iQ,iZ,i$,i0,i1,i2,i3,i5,i4,i6,i8,i9,i7,ri,rr,ra,ro,rc,rd,rl,ru,rh,rp,r_,rE,rm,rf,rS,rT,rR,rI,rv,rC,ry,rb,rO,rN,rD,rP,rL,rk,rM,rU,rV,rF,rG,rH,rY,rq,rJ,rX,rQ,rZ,r$,r0,r1,r2,r3,r5,r4,r6,r8,r9,r7,nt,nr,nn,na,no,ns,nc,nd,nl,nu,nh,np,n_,nE,nm,nf,ng,nT,nR,nI,nv,nC,ny,nA,nb,nO,nN,nD,nP,nL,nk,nM,nU,nV,nF,nB,nW,nG,nH,nY,nq,nJ,nX,nQ,nZ,n$,n0,n1,n2,n3,n5,n4,n6,n8,n9,n7,ae,at,ai,ar,an="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:void 0!==M.g?M.g:"undefined"!=typeof self?self:{};function i(L){return L&&L.__esModule&&Object.prototype.hasOwnProperty.call(L,"default")?L.default:L}var n=function(L){try{return!!L()}catch(L){return!0}},aa=!n(function(){var L=(function(){}).bind();return"function"!=typeof L||L.hasOwnProperty("prototype")}),ao=Function.prototype,as=ao.call,ac=aa&&ao.bind.bind(as,as),ad=aa?ac:function(L){return function(){return as.apply(L,arguments)}},al=ad({}.isPrototypeOf),u=function(L){return L&&L.Math===Math&&L},au=u("object"==typeof globalThis&&globalThis)||u("object"==typeof window&&window)||u("object"==typeof self&&self)||u("object"==typeof an&&an)||u("object"==typeof an&&an)||function(){return this}()||Function("return this")(),ah=Function.prototype,ap=ah.apply,a_=ah.call,aE="object"==typeof Reflect&&Reflect.apply||(aa?a_.bind(ap):function(){return a_.apply(ap,arguments)}),am=ad({}.toString),af=ad("".slice),R=function(L){return af(am(L),8,-1)},y=function(L){if("Function"===R(L))return ad(L)},aS="object"==typeof document&&document.all,aT=void 0===aS&&void 0!==aS?function(L){return"function"==typeof L||L===aS}:function(L){return"function"==typeof L},aR={},aI=!n(function(){return 7!==Object.defineProperty({},1,{get:function(){return 7}})[1]}),av=Function.prototype.call,aC=aa?av.bind(av):function(){return av.apply(av,arguments)},ay={},aA={}.propertyIsEnumerable,ab=Object.getOwnPropertyDescriptor,aN=ab&&!aA.call({1:2},1);ay.f=aN?function(L){var k=ab(this,L);return!!k&&k.enumerable}:aA;var aD,aL,x=function(L,k){return{enumerable:!(1&L),configurable:!(2&L),writable:!(4&L),value:k}},ak=Object,aM=ad("".split),aU=n(function(){return!ak("z").propertyIsEnumerable(0)})?function(L){return"String"===R(L)?aM(L,""):ak(L)}:ak,H=function(L){return null==L},aV=TypeError,z=function(L){if(H(L))throw new aV("Can't call method on "+L);return L},J=function(L){return aU(z(L))},Q=function(L){return"object"==typeof L?null!==L:aT(L)},aB={},ne=function(L){return aT(L)?L:void 0},re=function(L,k){return arguments.length<2?ne(aB[L])||ne(au[L]):aB[L]&&aB[L][k]||au[L]&&au[L][k]},aj=au.navigator,aG=aj&&aj.userAgent,aH=aG?String(aG):"",aY=au.process,aq=au.Deno,aJ=aY&&aY.versions||aq&&aq.version,aX=aJ&&aJ.v8;aX&&(aL=(aD=aX.split("."))[0]>0&&aD[0]<4?1:+(aD[0]+aD[1])),!aL&&aH&&(!(aD=aH.match(/Edge\/(\d+)/))||aD[1]>=74)&&(aD=aH.match(/Chrome\/(\d+)/))&&(aL=+aD[1]);var aQ=aL,aZ=au.String,a$=!!Object.getOwnPropertySymbols&&!n(function(){var L=Symbol("symbol detection");return!aZ(L)||!(Object(L) instanceof Symbol)||!Symbol.sham&&aQ&&aQ<41}),a0=a$&&!Symbol.sham&&"symbol"==typeof Symbol.iterator,a1=Object,a2=a0?function(L){return"symbol"==typeof L}:function(L){var k=re("Symbol");return aT(k)&&al(k.prototype,a1(L))},a3=String,be=function(L){try{return a3(L)}catch(L){return"Object"}},a5=TypeError,Ne=function(L){if(aT(L))return L;throw new a5(be(L)+" is not a function")},Le=function(L,k){var M=L[k];return H(M)?void 0:Ne(M)},a4=TypeError,a6={exports:{}},a8=Object.defineProperty,a9="__core-js_shared__",a7=a6.exports=au[a9]||function(L,k){try{a8(au,L,{value:k,configurable:!0,writable:!0})}catch(M){au[L]=k}return k}(a9,{});(a7.versions||(a7.versions=[])).push({version:"3.42.0",mode:"pure",copyright:"\xa9 2014-2025 Denis Pushkarev (zloirock.ru)",license:"https://github.com/zloirock/core-js/blob/v3.42.0/LICENSE",source:"https://github.com/zloirock/core-js"});var oe=a6.exports,ze=function(L,k){return oe[L]||(oe[L]=k||{})},ot=Object,Je=function(L){return ot(z(L))},oi=ad({}.hasOwnProperty),or=Object.hasOwn||function(L,k){return oi(Je(L),k)},on=0,oa=Math.random(),oo=ad(1..toString),rt=function(L){return"Symbol("+(void 0===L?"":L)+")_"+oo(++on+oa,36)},os=au.Symbol,oc=ze("wks"),ol=a0?os.for||os:os&&os.withoutSetter||rt,pt=function(L){return or(oc,L)||(oc[L]=a$&&or(os,L)?os[L]:ol("Symbol."+L)),oc[L]},St=function(L,k){var M,U;if("string"===k&&aT(M=L.toString)&&!Q(U=aC(M,L))||aT(M=L.valueOf)&&!Q(U=aC(M,L))||"string"!==k&&aT(M=L.toString)&&!Q(U=aC(M,L)))return U;throw new a4("Can't convert object to primitive value")},ou=TypeError,oh=pt("toPrimitive"),Rt=function(L,k){if(!Q(L)||a2(L))return L;var M,U=Le(L,oh);if(U){if(void 0===k&&(k="default"),!Q(M=aC(U,L,k))||a2(M))return M;throw new ou("Can't convert object to primitive value")}return void 0===k&&(k="number"),St(L,k)},Ct=function(L){var k=Rt(L,"string");return a2(k)?k:k+""},op=au.document,o_=Q(op)&&Q(op.createElement),At=function(L){return o_?op.createElement(L):{}},oE=!aI&&!n(function(){return 7!==Object.defineProperty(At("div"),"a",{get:function(){return 7}}).a}),om=Object.getOwnPropertyDescriptor;aR.f=aI?om:function(L,k){if(L=J(L),k=Ct(k),oE)try{return om(L,k)}catch(L){}if(or(L,k))return x(!aC(ay.f,L,k),L[k])};var of=/#|\.prototype\./,Gt=function(L,k){var M=oR[oT(L)];return M===oC||M!==ov&&(aT(k)?n(k):!!k)},oT=Gt.normalize=function(L){return String(L).replace(of,".").toLowerCase()},oR=Gt.data={},ov=Gt.NATIVE="N",oC=Gt.POLYFILL="P",oy=y(y.bind),Zt=function(L,k){return Ne(L),void 0===k?L:aa?oy(L,k):function(){return L.apply(k,arguments)}},ob={},oN=aI&&n(function(){return 42!==Object.defineProperty(function(){},"prototype",{value:42,writable:!1}).prototype}),oP=String,oL=TypeError,ni=function(L){if(Q(L))return L;throw new oL(oP(L)+" is not an object")},ok=TypeError,oM=Object.defineProperty,oU=Object.getOwnPropertyDescriptor,oV="enumerable",oj="configurable",oG="writable";ob.f=aI?oN?function(L,k,M){if(ni(L),k=Ct(k),ni(M),"function"==typeof L&&"prototype"===k&&"value"in M&&oG in M&&!M[oG]){var U=oU(L,k);U&&U[oG]&&(L[k]=M.value,M={configurable:oj in M?M[oj]:U[oj],enumerable:oV in M?M[oV]:U[oV],writable:!1})}return oM(L,k,M)}:oM:function(L,k,M){if(ni(L),k=Ct(k),ni(M),oE)try{return oM(L,k,M)}catch(L){}if("get"in M||"set"in M)throw new ok("Accessors not supported");return"value"in M&&(L[k]=M.value),L};var oH=aI?function(L,k,M){return ob.f(L,k,x(1,M))}:function(L,k,M){return L[k]=M,L},oY=aR.f,wi=function(L){var t=function(k,M,U){if(this instanceof t){switch(arguments.length){case 0:return new L;case 1:return new L(k);case 2:return new L(k,M)}return new L(k,M,U)}return aE(L,this,arguments)};return t.prototype=L.prototype,t},Oi=function(L,k){var M,U,V,F,B,j,G,X,$,ee=L.target,et=L.global,ei=L.stat,er=L.proto,en=et?au:ei?au[ee]:au[ee]&&au[ee].prototype,ea=et?aB:aB[ee]||oH(aB,ee,{})[ee],eo=ea.prototype;for(F in k)U=!(M=Gt(et?F:ee+(ei?".":"#")+F,L.forced))&&en&&or(en,F),j=ea[F],U&&(G=L.dontCallGetSet?($=oY(en,F))&&$.value:en[F]),B=U&&G?G:k[F],(M||er||typeof j!=typeof B)&&(X=L.bind&&U?Zt(B,au):L.wrap&&U?wi(B):er&&aT(B)?y(B):B,(L.sham||B&&B.sham||j&&j.sham)&&oH(X,"sham",!0),oH(ea,F,X),er&&(or(aB,V=ee+"Prototype")||oH(aB,V,{}),oH(aB[V],F,B),L.real&&eo&&(M||!eo[F])&&oH(eo,F,B)))},oz=Math.ceil,oq=Math.floor,oJ=Math.trunc||function(L){var k=+L;return(k>0?oq:oz)(k)},ki=function(L){var k=+L;return k!=k||0===k?0:oJ(k)},oX=Math.max,oQ=Math.min,xi=function(L,k){var M=ki(L);return M<0?oX(M+k,0):oQ(M,k)},oZ=Math.min,ji=function(L){var k=ki(L);return k>0?oZ(k,9007199254740991):0},Wi=function(L){return ji(L.length)},zi=function(L){return function(k,M,U){var V=J(k),F=Wi(V);if(0===F)return!L&&-1;var B,j=xi(U,F);if(L&&M!=M){for(;F>j;)if((B=V[j++])!=B)return!0}else for(;F>j;j++)if((L||j in V)&&V[j]===M)return L||j||0;return!L&&-1}},o$={includes:zi(!0),indexOf:zi(!1)},o0=o$.includes;Oi({target:"Array",proto:!0,forced:n(function(){return![,].includes()})},{includes:function(L){return o0(this,L,arguments.length>1?arguments[1]:void 0)}});var Qi=function(L,k){var M=aB[L+"Prototype"],U=M&&M[k];if(U)return U;var V=au[L],F=V&&V.prototype;return F&&F[k]},o1=Qi("Array","includes"),o2=pt("match"),rn=function(L){var k;return Q(L)&&(void 0!==(k=L[o2])?!!k:"RegExp"===R(L))},o3=TypeError,o5={};o5[pt("toStringTag")]="z";var o4="[object z]"===String(o5),o6=pt("toStringTag"),o8=Object,o9="Arguments"===R(function(){return arguments}()),o7=o4?R:function(L){var k,M,U;return void 0===L?"Undefined":null===L?"Null":"string"==typeof(M=function(L,k){try{return L[k]}catch(L){}}(k=o8(L),o6))?M:o9?R(k):"Object"===(U=R(k))&&aT(k.callee)?"Arguments":U},se=String,Sn=function(L){if("Symbol"===o7(L))throw TypeError("Cannot convert a Symbol value to a string");return se(L)},st=pt("match"),Rn=function(L){if(rn(L))throw new o3("The method doesn't accept regular expressions");return L},si=ad("".indexOf);Oi({target:"String",proto:!0,forced:!function(L){var k=/./;try{"/./"[L](k)}catch(M){try{return k[st]=!1,"/./"[L](k)}catch(L){}}return!1}("includes")},{includes:function(L){return!!~si(Sn(z(this)),Sn(Rn(L)),arguments.length>1?arguments[1]:void 0)}});var sr=Qi("String","includes"),sn=Array.prototype,sa=String.prototype,so=i(function(L){var k=L.includes;return L===sn||al(sn,L)&&k===sn.includes?o1:"string"==typeof L||L===sa||al(sa,L)&&k===sa.includes?sr:k}),ss=TypeError,sc="Reduce of empty array with no initial value",Bn=function(L){return function(k,M,U,V){var F=Je(k),B=aU(F),j=Wi(F);if(Ne(M),0===j&&U<2)throw new ss(sc);var G=L?j-1:0,X=L?-1:1;if(U<2)for(;;){if(G in B){V=B[G],G+=X;break}if(G+=X,L?G<0:j<=G)throw new ss(sc)}for(;L?G>=0:j>G;G+=X)G in B&&(V=M(V,B[G],G,F));return V}},sd={left:Bn(!1),right:Bn(!0)},Wn=function(L,k){var M=[][L];return!!M&&n(function(){M.call(null,k||function(){return 1},1)})},zn=function(L){return aH.slice(0,L.length)===L},sl=zn("Bun/")?"BUN":zn("Cloudflare-Workers")?"CLOUDFLARE":zn("Deno/")?"DENO":zn("Node.js/")?"NODE":au.Bun&&"string"==typeof Bun.version?"BUN":au.Deno&&"object"==typeof Deno.version?"DENO":"process"===R(au.process)?"NODE":au.window&&au.document?"BROWSER":"REST",su="NODE"===sl,sh=sd.left;Oi({target:"Array",proto:!0,forced:!su&&aQ>79&&aQ<83||!Wn("reduce")},{reduce:function(L){var k=arguments.length;return sh(this,L,k,k>1?arguments[1]:void 0)}});var sp=Qi("Array","reduce"),s_=Array.prototype,ir=function(L){var k=L.reduce;return L===s_||al(s_,L)&&k===s_.reduce?sp:k},sE=i(ir),sm=Array.isArray||function(L){return"Array"===R(L)},sf=ad([].reverse),sS=[1,2];Oi({target:"Array",proto:!0,forced:String(sS)===String(sS.reverse())},{reverse:function(){return sm(this)&&(this.length=this.length),sf(this)}});var sT=Qi("Array","reverse"),sR=Array.prototype,Er=function(L){var k=L.reverse;return L===sR||al(sR,L)&&k===sR.reverse?sT:k},sI=i(Er),sv=ze("keys"),gr=function(L){return sv[L]||(sv[L]=rt(L))},sC=!n(function(){function e(){}return e.prototype.constructor=null,Object.getPrototypeOf(new e)!==e.prototype}),sy=gr("IE_PROTO"),sb=Object,sN=sb.prototype,sD=sC?sb.getPrototypeOf:function(L){var k=Je(L);if(or(k,sy))return k[sy];var M=k.constructor;return aT(M)&&k instanceof M?M.prototype:k instanceof sb?sN:null},sL=String,sk=TypeError,Mr=function(L,k,M){try{return ad(Ne(Object.getOwnPropertyDescriptor(L,k)[M]))}catch(L){}},xr=function(L){if(Q(L)||null===L)return L;throw new sk("Can't set "+sL(L)+" as a prototype")},sM=Object.setPrototypeOf||("__proto__"in{}?function(){var L,k=!1,M={};try{(L=Mr(Object.prototype,"__proto__","set"))(M,[]),k=M instanceof Array}catch(L){}return function(M,U){return z(M),xr(U),Q(M)&&(k?L(M,U):M.__proto__=U),M}}():void 0),sU={},sV={},sB=o$.indexOf,sj=ad([].push),zr=function(L,k){var M,U=J(L),V=0,F=[];for(M in U)!or(sV,M)&&or(U,M)&&sj(F,M);for(;k.length>V;)or(U,M=k[V++])&&(~sB(F,M)||sj(F,M));return F},sW=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"],sG=sW.concat("length","prototype");sU.f=Object.getOwnPropertyNames||function(L){return zr(L,sG)};var sH={};sH.f=Object.getOwnPropertySymbols;var sY=ad([].concat),sq=re("Reflect","ownKeys")||function(L){var k=sU.f(ni(L)),M=sH.f;return M?sY(k,M(L)):k},sJ={},sX=Object.keys||function(L){return zr(L,sW)};sJ.f=aI&&!oN?Object.defineProperties:function(L,k){ni(L);for(var M,U=J(k),V=sX(k),F=V.length,B=0;F>B;)ob.f(L,M=V[B++],U[M]);return L};var sQ,sZ=re("document","documentElement"),s$="prototype",s0="script",s1=gr("IE_PROTO"),No=function(){},Do=function(L){return"<"+s0+">"+L+"</"+s0+">"},Po=function(L){L.write(Do("")),L.close();var k=L.parentWindow.Object;return L=null,k},Lo=function(){try{sQ=new ActiveXObject("htmlfile")}catch(L){}Lo="undefined"!=typeof document?document.domain&&sQ?Po(sQ):((k=At("iframe")).style.display="none",sZ.appendChild(k),k.src=String("java"+s0+":"),(L=k.contentWindow.document).open(),L.write(Do("document.F=Object")),L.close(),L.F):Po(sQ);for(var L,k,M=sW.length;M--;)delete Lo[s$][sW[M]];return Lo()};sV[s1]=!0;var s2=Object.create||function(L,k){var M;return null!==L?(No[s$]=ni(L),M=new No,No[s$]=null,M[s1]=L):M=Lo(),void 0===k?M:sJ.f(M,k)},s3=Error,s5=ad("".replace),s4=String(new s3("zxcasd").stack),s6=/\n\s*at [^:]*:[^\n]*/,s8=s6.test(s4),s9=!n(function(){var L=Error("a");return!("stack"in L)||(Object.defineProperty(L,"stack",x(1,7)),7!==L.stack)}),Ko=function(L,k){if(s8&&"string"==typeof L&&!s3.prepareStackTrace)for(;k--;)L=s5(L,s6,"");return L},s7=Error.captureStackTrace,ce={},ct=pt("iterator"),ci=Array.prototype,Qo=function(L){return void 0!==L&&(ce.Array===L||ci[ct]===L)},cr=pt("iterator"),rs=function(L){if(!H(L))return Le(L,cr)||Le(L,"@@iterator")||ce[o7(L)]},cn=TypeError,us=function(L,k){var M=arguments.length<2?rs(L):k;if(Ne(M))return ni(aC(M,L));throw new cn(be(L)+" is not iterable")},Es=function(L,k,M){var U,V;ni(L);try{if(!(U=Le(L,"return"))){if("throw"===k)throw M;return M}U=aC(U,L)}catch(L){V=!0,U=L}if("throw"===k)throw M;if(V)throw U;return ni(U),M},ca=TypeError,As=function(L,k){this.stopped=L,this.result=k},co=As.prototype,Os=function(L,k,M){var U,V,F,B,j,G,X,$=M&&M.that,ee=!(!M||!M.AS_ENTRIES),et=!(!M||!M.IS_RECORD),ei=!(!M||!M.IS_ITERATOR),er=!(!M||!M.INTERRUPTED),en=Zt(k,$),m=function(L){return U&&Es(U,"normal",L),new As(!0,L)},f=function(L){return ee?(ni(L),er?en(L[0],L[1],m):en(L[0],L[1])):er?en(L,m):en(L)};if(et)U=L.iterator;else if(ei)U=L;else{if(!(V=rs(L)))throw new ca(be(L)+" is not iterable");if(Qo(V)){for(F=0,B=Wi(L);B>F;F++)if((j=f(L[F]))&&al(co,j))return j;return new As(!1)}U=us(L,V)}for(G=et?L.next:U.next;!(X=aC(G,U)).done;){try{j=f(X.value)}catch(L){Es(U,"throw",L)}if("object"==typeof j&&j&&al(co,j))return j}return new As(!1)},Fs=function(L,k){Q(k)&&"cause"in k&&oH(L,"cause",k.cause)},Bs=function(L,k,M,U){s9&&(s7?s7(L,k):oH(L,"stack",Ko(M,U)))},cs=pt("toStringTag"),cc=Error,cl=[].push,Ys=function(L,k){var M,U=al(cu,this);sM?M=sM(new cc,U?sD(this):cu):oH(M=U?this:s2(cu),cs,"Error"),void 0!==k&&oH(M,"message",function(L,k){return void 0===L?arguments.length<2?"":void 0:Sn(L)}(k)),Bs(M,Ys,M.stack,1),arguments.length>2&&Fs(M,arguments[2]);var V=[];return Os(L,cl,{that:V}),oH(M,"errors",V),M};sM?sM(Ys,cc):function(L,k,M){for(var U=sq(k),V=ob.f,F=aR.f,B=0;B<U.length;B++){var j=U[B];or(L,j)||M&&or(M,j)||V(L,j,F(k,j))}}(Ys,cc,{name:!0});var cu=Ys.prototype=s2(cc.prototype,{constructor:x(1,Ys),message:x(1,""),name:x(1,"AggregateError")});Oi({global:!0,constructor:!0,arity:2},{AggregateError:Ys});var ch,cp,c_,cE=au.WeakMap,cm=aT(cE)&&/native code/.test(String(cE)),cf="Object already initialized",cS=au.TypeError,cT=au.WeakMap;if(cm||oe.state){var cv=oe.state||(oe.state=new cT);cv.get=cv.get,cv.has=cv.has,cv.set=cv.set,ch=function(L,k){if(cv.has(L))throw new cS(cf);return k.facade=L,cv.set(L,k),k},cp=function(L){return cv.get(L)||{}},c_=function(L){return cv.has(L)}}else{var cC=gr("state");sV[cC]=!0,ch=function(L,k){if(or(L,cC))throw new cS(cf);return k.facade=L,oH(L,cC,k),k},cp=function(L){return or(L,cC)?L[cC]:{}},c_=function(L){return or(L,cC)}}var cy,cA,cb,cN={set:ch,get:cp,has:c_,enforce:function(L){return c_(L)?cp(L):ch(L,{})},getterFor:function(L){return function(k){var M;if(!Q(k)||(M=cp(k)).type!==L)throw new cS("Incompatible receiver, "+L+" required");return M}}},cL=Function.prototype,ck=aI&&Object.getOwnPropertyDescriptor,cM=or(cL,"name"),cU={EXISTS:cM,PROPER:cM&&"something"===(function(){}).name,CONFIGURABLE:cM&&(!aI||aI&&ck(cL,"name").configurable)},Ca=function(L,k,M,U){return U&&U.enumerable?L[k]=M:oH(L,k,M),L},cV=pt("iterator"),cj=!1;[].keys&&("next"in(cb=[].keys())?(cA=sD(sD(cb)))!==Object.prototype&&(cy=cA):cj=!0),aT((cy=!Q(cy)||n(function(){var L={};return cy[cV].call(L)!==L})?{}:s2(cy))[cV])||Ca(cy,cV,function(){return this});var cW={IteratorPrototype:cy,BUGGY_SAFARI_ITERATORS:cj},cG=o4?({}).toString:function(){return"[object "+o7(this)+"]"},cK=ob.f,cY=pt("toStringTag"),Ga=function(L,k,M,U){var V=M?L:L&&L.prototype;V&&(or(V,cY)||cK(V,cY,{configurable:!0,value:k}),U&&!o4&&oH(V,"toString",cG))},cq=cW.IteratorPrototype,qa=function(){return this},Xa=function(L,k,M,U){var V=k+" Iterator";return L.prototype=s2(cq,{next:x(+!U,M)}),Ga(L,V,!1,!0),ce[V]=qa,L},cJ=cU.PROPER,cX=cW.BUGGY_SAFARI_ITERATORS,cQ=pt("iterator"),cZ="keys",c$="values",c0="entries",uc=function(){return this},hc=function(L,k,M,U,V,F,B){Xa(M,k,U);var j,G,X,l=function(L){if(L===V&&er)return er;if(!cX&&L&&L in et)return et[L];switch(L){case cZ:case c$:case c0:return function(){return new M(this,L)}}return function(){return new M(this)}},$=k+" Iterator",ee=!1,et=L.prototype,ei=et[cQ]||et["@@iterator"]||V&&et[V],er=!cX&&ei||l(V),en="Array"===k&&et.entries||ei;if(en&&(j=sD(en.call(new L)))!==Object.prototype&&j.next&&(Ga(j,$,!0,!0),ce[$]=uc),cJ&&V===c$&&ei&&ei.name!==c$&&(ee=!0,er=function(){return aC(ei,this)}),V){if(G={values:l(c$),keys:F?er:l(cZ),entries:l(c0)},B)for(X in G)!cX&&!ee&&X in et||Ca(et,X,G[X]);else Oi({target:k,proto:!0,forced:cX||ee},G)}return B&&et[cQ]!==er&&Ca(et,cQ,er,{name:V}),ce[k]=er,G},pc=function(L,k){return{value:L,done:k}};ob.f;var c1="Array Iterator",c2=cN.set,c3=cN.getterFor(c1);hc(Array,"Array",function(L,k){c2(this,{type:c1,target:J(L),index:0,kind:k})},function(){var L=c3(this),k=L.target,M=L.index++;if(!k||M>=k.length)return L.target=null,pc(void 0,!0);switch(L.kind){case"keys":return pc(M,!1);case"values":return pc(k[M],!1)}return pc([M,k[M]],!1)},"values"),ce.Arguments=ce.Array;var Cc=function(L,k,M){return ob.f(L,k,M)},c5=pt("species"),c4=TypeError,Nc=function(L,k){if(al(k,L))return L;throw new c4("Incorrect invocation")},c6=ad(Function.toString);aT(oe.inspectSource)||(oe.inspectSource=function(L){return c6(L)});var c8=oe.inspectSource,Bc=function(){},c9=re("Reflect","construct"),c7=/^\s*(?:class|function)\b/,de=ad(c7.exec),dt=!c7.test(Bc),Kc=function(L){if(!aT(L))return!1;try{return c9(Bc,[],L),!0}catch(L){return!1}},Yc=function(L){if(!aT(L))return!1;switch(o7(L)){case"AsyncFunction":case"GeneratorFunction":case"AsyncGeneratorFunction":return!1}try{return dt||!!de(c7,c8(L))}catch(L){return!0}};Yc.sham=!0;var di,dr,dn,da,ds=!c9||n(function(){var L;return Kc(Kc.call)||!Kc(Object)||!Kc(function(){L=!0})||L})?Yc:Kc,dc=TypeError,id=function(L){if(ds(L))return L;throw new dc(be(L)+" is not a constructor")},dd=pt("species"),od=function(L,k){var M,U=ni(L).constructor;return void 0===U||H(M=ni(U)[dd])?k:id(M)},dl=ad([].slice),du=TypeError,cd=function(L,k){if(L<k)throw new du("Not enough arguments");return L},dh=/(?:ipad|iphone|ipod).*applewebkit/i.test(aH),dp=au.setImmediate,d_=au.clearImmediate,dm=au.process,df=au.Dispatch,dS=au.Function,dT=au.MessageChannel,dR=au.String,dI=0,dv={},dC="onreadystatechange";n(function(){di=au.location});var Pd=function(L){if(or(dv,L)){var k=dv[L];delete dv[L],k()}},Ld=function(L){return function(){Pd(L)}},kd=function(L){Pd(L.data)},Md=function(L){au.postMessage(dR(L),di.protocol+"//"+di.host)};dp&&d_||(dp=function(L){cd(arguments.length,1);var k=aT(L)?L:dS(L),M=dl(arguments,1);return dv[++dI]=function(){aE(k,void 0,M)},dr(dI),dI},d_=function(L){delete dv[L]},su?dr=function(L){dm.nextTick(Ld(L))}:df&&df.now?dr=function(L){df.now(Ld(L))}:dT&&!dh?(da=(dn=new dT).port2,dn.port1.onmessage=kd,dr=Zt(da.postMessage,da)):au.addEventListener&&aT(au.postMessage)&&!au.importScripts&&di&&"file:"!==di.protocol&&!n(Md)?(dr=Md,au.addEventListener("message",kd,!1)):dr=dC in At("script")?function(L){sZ.appendChild(At("script"))[dC]=function(){sZ.removeChild(this),Pd(L)}}:function(L){setTimeout(Ld(L),0)});var dy={set:dp,clear:d_},dA=Object.getOwnPropertyDescriptor,Bd=function(L){if(!aI)return au[L];var k=dA(au,L);return k&&k.value},jd=function(){this.head=null,this.tail=null};jd.prototype={add:function(L){var k={item:L,next:null},M=this.tail;M?M.next=k:this.head=k,this.tail=k},get:function(){var L=this.head;if(L)return null===(this.head=L.next)&&(this.tail=null),L.item}};var db,dO,dN,dD,dL,dk=/ipad|iphone|ipod/i.test(aH)&&"undefined"!=typeof Pebble,dU=/web0s(?!.*chrome)/i.test(aH),dV=dy.set,dF=au.MutationObserver||au.WebKitMutationObserver,dW=au.document,dH=au.process,dY=au.Promise,dq=Bd("queueMicrotask");if(!dq){var dJ=new jd,ul=function(){var L,k;for(su&&(L=dH.domain)&&L.exit();k=dJ.get();)try{k()}catch(L){throw dJ.head&&db(),L}L&&L.enter()};dh||su||dU||!dF||!dW?!dk&&dY&&dY.resolve?((dD=dY.resolve(void 0)).constructor=dY,dL=Zt(dD.then,dD),db=function(){dL(ul)}):su?db=function(){dH.nextTick(ul)}:(dV=Zt(dV,au),db=function(){dV(ul)}):(dO=!0,dN=dW.createTextNode(""),new dF(ul).observe(dN,{characterData:!0}),db=function(){dN.data=dO=!dO}),dq=function(L){dJ.head||db(),dJ.add(L)}}var dX=dq,pl=function(L){try{return{error:!1,value:L()}}catch(L){return{error:!0,value:L}}},dQ=au.Promise,dZ=dQ&&dQ.prototype,d$=pt("species"),d0=!1,d1=aT(au.PromiseRejectionEvent),d2={CONSTRUCTOR:Gt("Promise",function(){var L=c8(dQ),k=L!==String(dQ);if(!k&&66===aQ||!dZ.catch||!dZ.finally)return!0;if(!aQ||aQ<51||!/native code/.test(L)){var M=new dQ(function(L){L(1)}),n=function(L){L(function(){},function(){})};if((M.constructor={})[d$]=n,!(d0=M.then(function(){}) instanceof n))return!0}return!(k||"BROWSER"!==sl&&"DENO"!==sl||d1)}),REJECTION_EVENT:d1,SUBCLASSING:d0},d3={},d5=TypeError,Pl=function(L){var k,M;this.promise=new L(function(L,U){if(void 0!==k||void 0!==M)throw new d5("Bad Promise constructor");k=L,M=U}),this.resolve=Ne(k),this.reject=Ne(M)};d3.f=function(L){return new Pl(L)};var d4,d6,d8=dy.set,Xl=function(L,k){try{1==arguments.length?console.error(L):console.error(L,k)}catch(L){}},d9="Promise",d7=d2.CONSTRUCTOR,le=d2.REJECTION_EVENT,lt=cN.getterFor(d9),li=cN.set,lr=dQ&&dQ.prototype,ln=dQ,la=lr,lo=au.TypeError,ls=au.document,lc=au.process,ld=d3.f,ll=ld,lu=!!(ls&&ls.createEvent&&au.dispatchEvent),lh="unhandledrejection",fu=function(L){var k;return!(!Q(L)||!aT(k=L.then))&&k},Su=function(L,k){var M,U,V,F=k.value,B=1===k.state,j=B?L.ok:L.fail,G=L.resolve,X=L.reject,$=L.domain;try{j?(B||(2===k.rejection&&Cu(k),k.rejection=1),!0===j?M=F:($&&$.enter(),M=j(F),$&&($.exit(),V=!0)),M===L.promise?X(new lo("Promise-chain cycle")):(U=fu(M))?aC(U,M,G,X):G(M)):X(F)}catch(L){$&&!V&&$.exit(),X(L)}},gu=function(L,k){L.notified||(L.notified=!0,dX(function(){for(var M,U=L.reactions;M=U.get();)Su(M,L);L.notified=!1,k&&!L.rejection&&Ru(L)}))},Tu=function(L,k,M){var U,V;lu?((U=ls.createEvent("Event")).promise=k,U.reason=M,U.initEvent(L,!1,!0),au.dispatchEvent(U)):U={promise:k,reason:M},!le&&(V=au["on"+L])?V(U):L===lh&&Xl("Unhandled promise rejection",M)},Ru=function(L){aC(d8,au,function(){var k,M=L.facade,U=L.value;if(vu(L)&&(k=pl(function(){su?lc.emit("unhandledRejection",U,M):Tu(lh,M,U)}),L.rejection=su||vu(L)?2:1,k.error))throw k.value})},vu=function(L){return 1!==L.rejection&&!L.parent},Cu=function(L){aC(d8,au,function(){var k=L.facade;su?lc.emit("rejectionHandled",k):Tu("rejectionhandled",k,L.value)})},yu=function(L,k,M){return function(U){L(k,U,M)}},Iu=function(L,k,M){L.done||(L.done=!0,M&&(L=M),L.value=k,L.state=2,gu(L,!0))},bu=function(L,k,M){if(!L.done){L.done=!0,M&&(L=M);try{if(L.facade===k)throw new lo("Promise can't be resolved itself");var U=fu(k);U?dX(function(){var M={done:!1};try{aC(U,k,yu(bu,M,L),yu(Iu,M,L))}catch(k){Iu(M,k,L)}}):(L.value=k,L.state=1,gu(L,!1))}catch(k){Iu({done:!1},k,L)}}};d7&&(la=(ln=function(L){Nc(this,la),Ne(L),aC(d4,this);var k=lt(this);try{L(yu(bu,k),yu(Iu,k))}catch(L){Iu(k,L)}}).prototype,(d4=function(L){li(this,{type:d9,done:!1,notified:!1,parent:!1,reactions:new jd,rejection:!1,state:0,value:null})}).prototype=Ca(la,"then",function(L,k){var M=lt(this),U=ld(od(this,ln));return M.parent=!0,U.ok=!aT(L)||L,U.fail=aT(k)&&k,U.domain=su?lc.domain:void 0,0===M.state?M.reactions.add(U):dX(function(){Su(U,M)}),U.promise}),d6=function(){var L=new d4,k=lt(L);this.promise=L,this.resolve=yu(bu,k),this.reject=yu(Iu,k)},d3.f=ld=function(L){return L===ln||void 0===L?new d6(L):ll(L)}),Oi({global:!0,constructor:!0,wrap:!0,forced:d7},{Promise:ln}),Ga(ln,d9,!1,!0),hr=re(d9),aI&&hr&&!hr[c5]&&Cc(hr,c5,{configurable:!0,get:function(){return this}});var lp=pt("iterator"),l_=!1;try{var lm=0,lf={next:function(){return{done:!!lm++}},return:function(){l_=!0}};lf[lp]=function(){return this},Array.from(lf,function(){throw 2})}catch(L){}var lS=d2.CONSTRUCTOR||!function(L,k){try{if(!l_)return!1}catch(L){return!1}var M=!1;try{var U={};U[lp]=function(){return{next:function(){return{done:M=!0}}}},L(U)}catch(L){}return M}(function(L){dQ.all(L).then(void 0,function(){})});Oi({target:"Promise",stat:!0,forced:lS},{all:function(L){var k=this,M=d3.f(k),U=M.resolve,V=M.reject,F=pl(function(){var M=Ne(k.resolve),F=[],B=0,j=1;Os(L,function(L){var G=B++,X=!1;j++,aC(M,k,L).then(function(L){X||(X=!0,F[G]=L,--j||U(F))},V)}),--j||U(F)});return F.error&&V(F.value),M.promise}});var lT=d2.CONSTRUCTOR;dQ&&dQ.prototype,Oi({target:"Promise",proto:!0,forced:lT,real:!0},{catch:function(L){return this.then(void 0,L)}}),Oi({target:"Promise",stat:!0,forced:lS},{race:function(L){var k=this,M=d3.f(k),U=M.reject,V=pl(function(){var V=Ne(k.resolve);Os(L,function(L){aC(V,k,L).then(M.resolve,U)})});return V.error&&U(V.value),M.promise}}),Oi({target:"Promise",stat:!0,forced:d2.CONSTRUCTOR},{reject:function(L){var k=d3.f(this);return(0,k.reject)(L),k.promise}});var Ju=function(L,k){if(ni(L),Q(k)&&k.constructor===L)return k;var M=d3.f(L);return(0,M.resolve)(k),M.promise},lR=d2.CONSTRUCTOR,lv=re("Promise"),lC=!lR;Oi({target:"Promise",stat:!0,forced:!0},{resolve:function(L){return Ju(lC&&this===lv?dQ:this,L)}}),Oi({target:"Promise",stat:!0,forced:lS},{allSettled:function(L){var k=this,M=d3.f(k),U=M.resolve,V=M.reject,F=pl(function(){var M=Ne(k.resolve),V=[],F=0,B=1;Os(L,function(L){var j=F++,G=!1;B++,aC(M,k,L).then(function(L){G||(G=!0,V[j]={status:"fulfilled",value:L},--B||U(V))},function(L){G||(G=!0,V[j]={status:"rejected",reason:L},--B||U(V))})}),--B||U(V)});return F.error&&V(F.value),M.promise}});var ly="No one promise resolved";Oi({target:"Promise",stat:!0,forced:lS},{any:function(L){var k=this,M=re("AggregateError"),U=d3.f(k),V=U.resolve,F=U.reject,B=pl(function(){var U=Ne(k.resolve),B=[],j=0,G=1,X=!1;Os(L,function(L){var $=j++,ee=!1;G++,aC(U,k,L).then(function(L){ee||X||(X=!0,V(L))},function(L){ee||X||(ee=!0,B[$]=L,--G||F(new M(B,ly)))})}),--G||F(new M(B,ly))});return B.error&&F(B.value),U.promise}});var lA=au.Promise,lb=!1;Oi({target:"Promise",stat:!0,forced:!lA||!lA.try||pl(function(){lA.try(function(L){lb=8===L},8)}).error||!lb},{try:function(L){var k=arguments.length>1?dl(arguments,1):[],M=d3.f(this),U=pl(function(){return aE(Ne(L),void 0,k)});return(U.error?M.reject:M.resolve)(U.value),M.promise}}),Oi({target:"Promise",stat:!0},{withResolvers:function(){var L=d3.f(this);return{promise:L.promise,resolve:L.resolve,reject:L.reject}}});var lN=dQ&&dQ.prototype;Oi({target:"Promise",proto:!0,real:!0,forced:!!dQ&&n(function(){lN.finally.call({then:function(){}},function(){})})},{finally:function(L){var k=od(this,re("Promise")),M=aT(L);return this.then(M?function(M){return Ju(k,L()).then(function(){return M})}:L,M?function(M){return Ju(k,L()).then(function(){throw M})}:L)}});var lD=ad("".charAt),lL=ad("".charCodeAt),lk=ad("".slice),Fh=function(L){return function(k,M){var U,V,F=Sn(z(k)),B=ki(M),j=F.length;return B<0||B>=j?L?"":void 0:(U=lL(F,B))<55296||U>56319||B+1===j||(V=lL(F,B+1))<56320||V>57343?L?lD(F,B):U:L?lk(F,B,B+2):V-56320+(U-55296<<10)+65536}},lM={codeAt:Fh(!1),charAt:Fh(!0)},lU=lM.charAt,lV="String Iterator",lF=cN.set,lW=cN.getterFor(lV);hc(String,"String",function(L){lF(this,{type:lV,string:Sn(L),index:0})},function(){var L,k=lW(this),M=k.string,U=k.index;return U>=M.length?pc(void 0,!0):(L=lU(M,U),k.index+=L.length,pc(L,!1))});var lq=aB.Promise,lJ={CSSRuleList:0,CSSStyleDeclaration:0,CSSValueList:0,ClientRectList:0,DOMRectList:0,DOMStringList:0,DOMTokenList:1,DataTransferItemList:0,FileList:0,HTMLAllCollection:0,HTMLCollection:0,HTMLFormElement:0,HTMLSelectElement:0,MediaList:0,MimeTypeArray:0,NamedNodeMap:0,NodeList:1,PaintRequestList:0,Plugin:0,PluginArray:0,SVGLengthList:0,SVGNumberList:0,SVGPathSegList:0,SVGPointList:0,SVGStringList:0,SVGTransformList:0,SourceBufferList:0,StyleSheetList:0,TextTrackCueList:0,TextTrackList:0,TouchList:0};for(var lX in lJ)Ga(au[lX],lX),ce[lX]=ce.Array;var lQ=i(lq),lZ=Qi("Array","values"),l$=Array.prototype,l0={DOMTokenList:!0,NodeList:!0},l1=i(function(L){var k=L.values;return L===l$||al(l$,L)&&k===l$.values||or(l0,o7(L))?lZ:k}),l2=TypeError,l3=Math.floor,mp=function(L,k){var M=L.length;if(M<8)for(var U,V,F=1;F<M;){for(V=F,U=L[F];V&&k(L[V-1],U)>0;)L[V]=L[--V];V!==F++&&(L[V]=U)}else for(var B=l3(M/2),j=mp(dl(L,0,B),k),G=mp(dl(L,B),k),X=j.length,$=G.length,ee=0,et=0;ee<X||et<$;)L[ee+et]=ee<X&&et<$?0>=k(j[ee],G[et])?j[ee++]:G[et++]:ee<X?j[ee++]:G[et++];return L},l5=aH.match(/firefox\/(\d+)/i),l4=!!l5&&+l5[1],l6=/MSIE|Trident/.test(aH),l8=aH.match(/AppleWebKit\/(\d+)\./),l9=!!l8&&+l8[1],wp=function(L,k){if(!delete L[k])throw new l2("Cannot delete property "+be(k)+" of "+be(L))},l7=[],ue=ad(l7.sort),ut=ad(l7.push),ui=n(function(){l7.sort(void 0)}),ur=n(function(){l7.sort(null)}),un=Wn("sort"),ua=!n(function(){if(aQ)return aQ<70;if(!(l4&&l4>3)){if(l6)return!0;if(l9)return l9<603;var L,k,M,U,V="";for(L=65;L<76;L++){switch(k=String.fromCharCode(L),L){case 66:case 69:case 70:case 72:M=3;break;case 68:case 71:M=4;break;default:M=2}for(U=0;U<47;U++)l7.push({k:k+U,v:M})}for(l7.sort(function(L,k){return k.v-L.v}),U=0;U<l7.length;U++)k=l7[U].k.charAt(0),V.charAt(V.length-1)!==k&&(V+=k);return"DGBEFHACIJK"!==V}});Oi({target:"Array",proto:!0,forced:ui||!ur||!un||!ua},{sort:function(L){void 0!==L&&Ne(L);var k=Je(this);if(ua)return void 0===L?ue(k):ue(k,L);var M,U,V=[],F=Wi(k);for(U=0;U<F;U++)U in k&&ut(V,k[U]);for(mp(V,function(k,M){return void 0===M?-1:void 0===k?1:void 0!==L?+L(k,M)||0:Sn(k)>Sn(M)?1:-1}),M=Wi(V),U=0;U<M;)k[U]=V[U++];for(;U<F;)wp(k,U++);return k}});var uo=Qi("Array","sort"),ud=Array.prototype,uu=i(function(L){var k=L.sort;return L===ud||al(ud,L)&&k===ud.sort?uo:k}),uh=RangeError,up=String.fromCharCode,u_=String.fromCodePoint,um=ad([].join);Oi({target:"String",stat:!0,arity:1,forced:!!u_&&1!==u_.length},{fromCodePoint:function(L){for(var k,M=[],U=arguments.length,V=0;U>V;){if(k=+arguments[V++],xi(k,1114111)!==k)throw new uh(k+" is not a valid code point");M[V]=k<65536?up(k):up(55296+((k-=65536)>>10),k%1024+56320)}return um(M,"")}});var uf=pt("iterator"),uS=!n(function(){var L=new URL("b?a=1&b=2&c=3","https://a"),k=L.searchParams,M=new URLSearchParams("a=1&a=2&b=3"),U="";return L.pathname="c%20d",k.forEach(function(L,M){k.delete("b"),U+=M+L}),M.delete("a",2),M.delete("b",void 0),!L.toJSON||!M.has("a",1)||M.has("a",2)||!M.has("a",void 0)||M.has("b")||!k.size||!k.sort||"https://a/c%20d?a=1&c=3"!==L.href||"3"!==k.get("c")||"a=1"!==String(new URLSearchParams("?a=1"))||!k[uf]||"a"!==new URL("https://a@b").username||"b"!==new URLSearchParams(new URLSearchParams("a=b")).get("a")||"xn--e1aybc"!==new URL("https://тест").host||"#%D0%B1"!==new URL("https://a#б").hash||"a1c3"!==U||"x"!==new URL("https://x",void 0).host}),uT=pt("iterator"),uv="URLSearchParams",uC=uv+"Iterator",uy=cN.set,uN=cN.getterFor(uv),uD=cN.getterFor(uC),uL=Bd("fetch"),uk=Bd("Request"),uM=Bd("Headers"),uU=uk&&uk.prototype,uV=uM&&uM.prototype,uF=au.TypeError,uW=au.encodeURIComponent,uH=String.fromCharCode,uq=re("String","fromCodePoint"),uJ=parseInt,uX=ad("".charAt),uQ=ad([].join),uZ=ad([].push),u$=ad("".replace),u0=ad([].shift),u1=ad([].splice),u2=ad("".split),u3=ad("".slice),u5=ad(/./.exec),u4=/\+/g,u6=/^[0-9a-f]+$/i,dE=function(L,k){var M=u3(L,k,k+2);return u5(u6,M)?uJ(M,16):NaN},lE=function(L){for(var k=0,M=128;M>0&&0!=(L&M);M>>=1)k++;return k},uE=function(L){var k=null;switch(L.length){case 1:k=L[0];break;case 2:k=(31&L[0])<<6|63&L[1];break;case 3:k=(15&L[0])<<12|(63&L[1])<<6|63&L[2];break;case 4:k=(7&L[0])<<18|(63&L[1])<<12|(63&L[2])<<6|63&L[3]}return k>1114111?null:k},hE=function(L){for(var k=(L=u$(L,u4," ")).length,M="",U=0;U<k;){var V=uX(L,U);if("%"===V){if("%"===uX(L,U+1)||U+3>k){M+="%",U++;continue}var F=dE(L,U+1);if(F!=F){M+=V,U++;continue}U+=2;var B=lE(F);if(0===B)V=uH(F);else{if(1===B||B>4){M+="�",U++;continue}for(var j=[F],G=1;G<B&&!(++U+3>k||"%"!==uX(L,U));){var X=dE(L,U+1);if(X!=X){U+=3;break}if(X>191||X<128)break;uZ(j,X),U+=2,G++}if(j.length!==B){M+="�";continue}var $=uE(j);null===$?M+="�":V=uq($)}}M+=V,U++}return M},u8=/[!'()~]|%20/g,u9={"!":"%21","'":"%27","(":"%28",")":"%29","~":"%7E","%20":"+"},EE=function(L){return u9[L]},mE=function(L){return u$(uW(L),u8,EE)},u7=Xa(function(L,k){uy(this,{type:uC,target:uN(L).entries,index:0,kind:k})},uv,function(){var L=uD(this),k=L.target,M=L.index++;if(!k||M>=k.length)return L.target=null,pc(void 0,!0);var U=k[M];switch(L.kind){case"keys":return pc(U.key,!1);case"values":return pc(U.value,!1)}return pc([U.key,U.value],!1)},!0),SE=function(L){this.entries=[],this.url=null,void 0!==L&&(Q(L)?this.parseObject(L):this.parseQuery("string"==typeof L?"?"===uX(L,0)?u3(L,1):L:Sn(L)))};SE.prototype={type:uv,bindURL:function(L){this.url=L,this.update()},parseObject:function(L){var k,M,U,V,F,B,j,G=this.entries,X=rs(L);if(X)for(M=(k=us(L,X)).next;!(U=aC(M,k)).done;){if((B=aC(F=(V=us(ni(U.value))).next,V)).done||(j=aC(F,V)).done||!aC(F,V).done)throw new uF("Expected sequence with length 2");uZ(G,{key:Sn(B.value),value:Sn(j.value)})}else for(var $ in L)or(L,$)&&uZ(G,{key:$,value:Sn(L[$])})},parseQuery:function(L){if(L)for(var k,M,U=this.entries,V=u2(L,"&"),F=0;F<V.length;)(k=V[F++]).length&&uZ(U,{key:hE(u0(M=u2(k,"="))),value:hE(uQ(M,"="))})},serialize:function(){for(var L,k=this.entries,M=[],U=0;U<k.length;)uZ(M,mE((L=k[U++]).key)+"="+mE(L.value));return uQ(M,"&")},update:function(){this.entries.length=0,this.parseQuery(this.url.query)},updateURL:function(){this.url&&this.url.update()}};var gE=function(){Nc(this,he);var L=uy(this,new SE(arguments.length>0?arguments[0]:void 0));aI||(this.size=L.entries.length)},he=gE.prototype;if(function(L,k,M){for(var U in k)M&&M.unsafe&&L[U]?L[U]=k[U]:Ca(L,U,k[U],M)}(he,{append:function(L,k){var M=uN(this);cd(arguments.length,2),uZ(M.entries,{key:Sn(L),value:Sn(k)}),aI||this.length++,M.updateURL()},delete:function(L){for(var k=uN(this),M=cd(arguments.length,1),U=k.entries,V=Sn(L),F=M<2?void 0:arguments[1],B=void 0===F?F:Sn(F),j=0;j<U.length;){var G=U[j];if(G.key!==V||void 0!==B&&G.value!==B)j++;else if(u1(U,j,1),void 0!==B)break}aI||(this.size=U.length),k.updateURL()},get:function(L){var k=uN(this).entries;cd(arguments.length,1);for(var M=Sn(L),U=0;U<k.length;U++)if(k[U].key===M)return k[U].value;return null},getAll:function(L){var k=uN(this).entries;cd(arguments.length,1);for(var M=Sn(L),U=[],V=0;V<k.length;V++)k[V].key===M&&uZ(U,k[V].value);return U},has:function(L){for(var k=uN(this).entries,M=cd(arguments.length,1),U=Sn(L),V=M<2?void 0:arguments[1],F=void 0===V?V:Sn(V),B=0;B<k.length;){var j=k[B++];if(j.key===U&&(void 0===F||j.value===F))return!0}return!1},set:function(L,k){var M=uN(this);cd(arguments.length,1);for(var U,V=M.entries,F=!1,B=Sn(L),j=Sn(k),G=0;G<V.length;G++)(U=V[G]).key===B&&(F?u1(V,G--,1):(F=!0,U.value=j));F||uZ(V,{key:B,value:j}),aI||(this.size=V.length),M.updateURL()},sort:function(){var L=uN(this);mp(L.entries,function(L,k){return L.key>k.key?1:-1}),L.updateURL()},forEach:function(L){for(var k,M=uN(this).entries,U=Zt(L,arguments.length>1?arguments[1]:void 0),V=0;V<M.length;)U((k=M[V++]).value,k.key,this)},keys:function(){return new u7(this,"keys")},values:function(){return new u7(this,"values")},entries:function(){return new u7(this,"entries")}},{enumerable:!0}),Ca(he,uT,he.entries,{name:"entries"}),Ca(he,"toString",function(){return uN(this).serialize()},{enumerable:!0}),aI&&Cc(he,"size",{get:function(){return uN(this).entries.length},configurable:!0,enumerable:!0}),Ga(gE,uv),Oi({global:!0,constructor:!0,forced:!uS},{URLSearchParams:gE}),!uS&&aT(uM)){var ht=ad(uV.has),hi=ad(uV.set),CE=function(L){if(Q(L)){var k,M=L.body;if(o7(M)===uv)return ht(k=L.headers?new uM(L.headers):new uM,"content-type")||hi(k,"content-type","application/x-www-form-urlencoded;charset=UTF-8"),s2(L,{body:x(0,Sn(M)),headers:x(0,k)})}return L};if(aT(uL)&&Oi({global:!0,enumerable:!0,dontCallGetSet:!0,forced:!0},{fetch:function(L){return uL(L,arguments.length>1?CE(arguments[1]):{})}}),aT(uk)){var yE=function(L){return Nc(this,uU),new uk(L,arguments.length>1?CE(arguments[1]):{})};uU.constructor=yE,yE.prototype=uU,Oi({global:!0,constructor:!0,dontCallGetSet:!0,forced:!0},{Request:yE})}}var hr,hn,ha=aB.URLSearchParams,ho=Object.assign,hs=Object.defineProperty,hd=ad([].concat),hl=!ho||n(function(){if(aI&&1!==ho({b:1},ho(hs({},"a",{enumerable:!0,get:function(){hs(this,"b",{value:3,enumerable:!1})}}),{b:2})).b)return!0;var L={},k={},M=Symbol("assign detection"),U="abcdefghijklmnopqrst";return L[M]=7,U.split("").forEach(function(L){k[L]=L}),7!==ho({},L)[M]||sX(ho({},k)).join("")!==U})?function(L,k){for(var M=Je(L),U=arguments.length,V=1,F=sH.f,B=ay.f;U>V;)for(var j,G=aU(arguments[V++]),X=F?hd(sX(G),F(G)):sX(G),$=X.length,ee=0;$>ee;)j=X[ee++],aI&&!aC(B,G,j)||(M[j]=G[j]);return M}:ho,YE=function(L,k,M){aI?ob.f(L,k,x(0,M)):L[k]=M},JE=function(L,k,M,U){try{return U?k(ni(M)[0],M[1]):k(M)}catch(k){Es(L,"throw",k)}},hu=Array,hh=/[^\0-\u007E]/,hp=/[.\u3000\uFF0E\uFF61]/g,h_="Overflow: input needs wider integers to process",hm=RangeError,hf=ad(hp.exec),hS=Math.floor,hT=String.fromCharCode,hI=ad("".charCodeAt),hv=ad([].join),hC=ad([].push),hy=ad("".replace),hA=ad("".split),hb=ad("".toLowerCase),gm=function(L){return L+22+75*(L<26)},Tm=function(L,k,M){var U=0;for(L=M?hS(L/700):L>>1,L+=hS(L/k);L>455;)L=hS(L/35),U+=36;return hS(U+36*L/(L+38))},Rm=function(L){var k,M,U=[],V=(L=function(L){for(var k=[],M=0,U=L.length;M<U;){var V=hI(L,M++);if(V>=55296&&V<=56319&&M<U){var F=hI(L,M++);56320==(64512&F)?hC(k,((1023&V)<<10)+(1023&F)+65536):(hC(k,V),M--)}else hC(k,V)}return k}(L)).length,F=128,B=0,j=72;for(k=0;k<L.length;k++)(M=L[k])<128&&hC(U,hT(M));var G=U.length,X=G;for(G&&hC(U,"-");X<V;){var $=2147483647;for(k=0;k<L.length;k++)(M=L[k])>=F&&M<$&&($=M);var ee=X+1;if($-F>hS((2147483647-B)/ee))throw new hm(h_);for(B+=($-F)*ee,F=$,k=0;k<L.length;k++){if((M=L[k])<F&&++B>2147483647)throw new hm(h_);if(M===F){for(var et=B,ei=36;;){var er=ei<=j?1:ei>=j+26?26:ei-j;if(et<er)break;var en=et-er,ea=36-er;hC(U,hT(gm(er+en%ea))),et=hS(en/ea),ei+=36}hC(U,hT(gm(et))),j=Tm(B,ee,X===G),B=0,X++}}B++,F++}return hv(U,"")},Lm=function(L){var k=Je(L),M=ds(this),U=arguments.length,V=U>1?arguments[1]:void 0,F=void 0!==V;F&&(V=Zt(V,U>2?arguments[2]:void 0));var B,j,G,X,$,ee,et=rs(k),ei=0;if(!et||this===hu&&Qo(et))for(B=Wi(k),j=M?new this(B):hu(B);B>ei;ei++)ee=F?V(k[ei],ei):k[ei],YE(j,ei,ee);else for(j=M?new this:[],$=(X=us(k,et)).next;!(G=aC($,X)).done;ei++)ee=F?JE(X,V,[G.value,ei],!0):G.value,YE(j,ei,ee);return j.length=ei,j},hD=lM.codeAt,Um=function(L){var k,M,U=[],V=hA(hy(hb(L),hp,"."),".");for(k=0;k<V.length;k++)hC(U,hf(hh,M=V[k])?"xn--"+Rm(M):M);return hv(U,".")},hP={URLSearchParams:gE,getState:uN},hL=cN.set,hk=cN.getterFor("URL"),hM=hP.URLSearchParams,hU=hP.getState,hj=au.URL,hH=au.TypeError,hz=au.parseInt,hq=Math.floor,hJ=Math.pow,hX=ad("".charAt),hQ=ad(/./.exec),hZ=ad([].join),h$=ad(1..toString),h0=ad([].pop),h1=ad([].push),h2=ad("".replace),h3=ad([].shift),h5=ad("".split),h4=ad("".slice),h6=ad("".toLowerCase),h8=ad([].unshift),h9="Invalid scheme",h7="Invalid host",pe="Invalid port",pi=/[a-z]/i,pr=/[\d+-.a-z]/i,pn=/\d/,pa=/^0x/i,po=/^[0-7]+$/,ps=/^\d+$/,pd=/^[\da-f]+$/i,pu=/[\0\t\n\r #%/:<>?@[\\\]^|]/,ph=/[\0\t\n\r #/:<>?@[\\\]^|]/,pp=/^[\u0000-\u0020]+/,p_=/(^|[^\u0000-\u0020])[\u0000-\u0020]+$/,pE=/[\t\n\r]/g,If=function(L){var k,M,U,V;if("number"==typeof L){for(k=[],M=0;M<4;M++)h8(k,L%256),L=hq(L/256);return hZ(k,".")}if("object"==typeof L){for(k="",U=function(L){for(var k=null,M=1,U=null,V=0,F=0;F<8;F++)0!==L[F]?(V>M&&(k=U,M=V),U=null,V=0):(null===U&&(U=F),++V);return V>M?U:k}(L),M=0;M<8;M++)V&&0===L[M]||(V&&(V=!1),U===M?(k+=M?":":"::",V=!0):(k+=h$(L[M],16),M<7&&(k+=":")));return"["+k+"]"}return L},pm={},pf=hl({},pm,{" ":1,'"':1,"<":1,">":1,"`":1}),pS=hl({},pf,{"#":1,"?":1,"{":1,"}":1}),pg=hl({},pS,{"/":1,":":1,";":1,"=":1,"@":1,"[":1,"\\":1,"]":1,"^":1,"|":1}),Nf=function(L,k){var M=hD(L,0);return M>32&&M<127&&!or(k,L)?L:encodeURIComponent(L)},pT={ftp:21,file:null,http:80,https:443,ws:80,wss:443},Pf=function(L,k){var M;return 2===L.length&&hQ(pi,hX(L,0))&&(":"===(M=hX(L,1))||!k&&"|"===M)},Lf=function(L){var k;return L.length>1&&Pf(h4(L,0,2))&&(2===L.length||"/"===(k=hX(L,2))||"\\"===k||"?"===k||"#"===k)},pI={},pv={},pC={},pA={},pb={},pN={},pP={},pL={},pk={},pM={},pU={},pH={},pz={},pq={},pJ={},pX={},pQ={},pZ={},p$={},p0={},p1={},iS=function(L,k,M){var U,V,F,B=Sn(L);if(k){if(V=this.parse(B))throw new hH(V);this.searchParams=null}else{if(void 0!==M&&(U=new iS(M,!0)),V=this.parse(B,null,U))throw new hH(V);(F=hU(new hM)).bindURL(this),this.searchParams=F}};iS.prototype={type:"URL",parse:function(L,k,M){var U,V,F,B,j,G=k||pI,X=0,$="",ee=!1,et=!1,ei=!1;for(L=Sn(L),k||(this.scheme="",this.username="",this.password="",this.host=null,this.port=null,this.path=[],this.query=null,this.fragment=null,this.cannotBeABaseURL=!1,L=h2(L,pp,""),L=h2(L,p_,"$1")),U=Lm(L=h2(L,pE,""));X<=U.length;){switch(V=U[X],G){case pI:if(!V||!hQ(pi,V)){if(k)return h9;G=pC;continue}$+=h6(V),G=pv;break;case pv:if(V&&(hQ(pr,V)||"+"===V||"-"===V||"."===V))$+=h6(V);else{if(":"!==V){if(k)return h9;$="",G=pC,X=0;continue}if(k&&(this.isSpecial()!==or(pT,$)||"file"===$&&(this.includesCredentials()||null!==this.port)||"file"===this.scheme&&!this.host))return;if(this.scheme=$,k)return void(this.isSpecial()&&pT[this.scheme]===this.port&&(this.port=null));$="","file"===this.scheme?G=pq:this.isSpecial()&&M&&M.scheme===this.scheme?G=pA:this.isSpecial()?G=pL:"/"===U[X+1]?(G=pb,X++):(this.cannotBeABaseURL=!0,h1(this.path,""),G=p$)}break;case pC:if(!M||M.cannotBeABaseURL&&"#"!==V)return h9;if(M.cannotBeABaseURL&&"#"===V){this.scheme=M.scheme,this.path=dl(M.path),this.query=M.query,this.fragment="",this.cannotBeABaseURL=!0,G=p1;break}G="file"===M.scheme?pq:pN;continue;case pA:if("/"!==V||"/"!==U[X+1]){G=pN;continue}G=pk,X++;break;case pb:if("/"===V){G=pM;break}G=pZ;continue;case pN:if(this.scheme=M.scheme,V===hn)this.username=M.username,this.password=M.password,this.host=M.host,this.port=M.port,this.path=dl(M.path),this.query=M.query;else if("/"===V||"\\"===V&&this.isSpecial())G=pP;else if("?"===V)this.username=M.username,this.password=M.password,this.host=M.host,this.port=M.port,this.path=dl(M.path),this.query="",G=p0;else{if("#"!==V){this.username=M.username,this.password=M.password,this.host=M.host,this.port=M.port,this.path=dl(M.path),this.path.length--,G=pZ;continue}this.username=M.username,this.password=M.password,this.host=M.host,this.port=M.port,this.path=dl(M.path),this.query=M.query,this.fragment="",G=p1}break;case pP:if(this.isSpecial()&&("/"===V||"\\"===V))G=pk;else{if("/"!==V){this.username=M.username,this.password=M.password,this.host=M.host,this.port=M.port,G=pZ;continue}G=pM}break;case pL:if(G=pk,"/"!==V||"/"!==hX($,X+1))continue;X++;break;case pk:if("/"!==V&&"\\"!==V){G=pM;continue}break;case pM:if("@"===V){ee&&($="%40"+$),ee=!0,F=Lm($);for(var er,en=0;en<F.length;en++){var ea=F[en];if(":"!==ea||ei){var eo=Nf(ea,pg);ei?this.password+=eo:this.username+=eo}else ei=!0}$=""}else if(V===hn||"/"===V||"?"===V||"#"===V||"\\"===V&&this.isSpecial()){if(ee&&""===$)return"Invalid authority";X-=Lm($).length+1,$="",G=pU}else $+=V;break;case pU:case pH:if(k&&"file"===this.scheme){G=pX;continue}if(":"!==V||et){if(V===hn||"/"===V||"?"===V||"#"===V||"\\"===V&&this.isSpecial()){if(this.isSpecial()&&""===$)return h7;if(k&&""===$&&(this.includesCredentials()||null!==this.port))return;if(B=this.parseHost($))return B;if($="",G=pQ,k)return;continue}"["===V?et=!0:"]"===V&&(et=!1),$+=V}else{if(""===$)return h7;if(B=this.parseHost($))return B;if($="",G=pz,k===pH)return}break;case pz:if(!hQ(pn,V)){if(V===hn||"/"===V||"?"===V||"#"===V||"\\"===V&&this.isSpecial()||k){if(""!==$){var es=hz($,10);if(es>65535)return pe;this.port=this.isSpecial()&&es===pT[this.scheme]?null:es,$=""}if(k)return;G=pQ;continue}return pe}$+=V;break;case pq:if(this.scheme="file","/"===V||"\\"===V)G=pJ;else{if(!M||"file"!==M.scheme){G=pZ;continue}switch(V){case hn:this.host=M.host,this.path=dl(M.path),this.query=M.query;break;case"?":this.host=M.host,this.path=dl(M.path),this.query="",G=p0;break;case"#":this.host=M.host,this.path=dl(M.path),this.query=M.query,this.fragment="",G=p1;break;default:Lf(hZ(dl(U,X),""))||(this.host=M.host,this.path=dl(M.path),this.shortenPath()),G=pZ;continue}}break;case pJ:if("/"===V||"\\"===V){G=pX;break}M&&"file"===M.scheme&&!Lf(hZ(dl(U,X),""))&&(Pf(M.path[0],!0)?h1(this.path,M.path[0]):this.host=M.host),G=pZ;continue;case pX:if(V===hn||"/"===V||"\\"===V||"?"===V||"#"===V){if(!k&&Pf($))G=pZ;else if(""===$){if(this.host="",k)return;G=pQ}else{if(B=this.parseHost($))return B;if("localhost"===this.host&&(this.host=""),k)return;$="",G=pQ}continue}$+=V;break;case pQ:if(this.isSpecial()){if(G=pZ,"/"!==V&&"\\"!==V)continue}else if(k||"?"!==V){if(k||"#"!==V){if(V!==hn&&(G=pZ,"/"!==V))continue}else this.fragment="",G=p1}else this.query="",G=p0;break;case pZ:if(V===hn||"/"===V||"\\"===V&&this.isSpecial()||!k&&("?"===V||"#"===V)){if(".."===(j=h6(j=$))||"%2e."===j||".%2e"===j||"%2e%2e"===j?(this.shortenPath(),"/"===V||"\\"===V&&this.isSpecial()||h1(this.path,"")):"."===(er=$)||"%2e"===h6(er)?"/"===V||"\\"===V&&this.isSpecial()||h1(this.path,""):("file"===this.scheme&&!this.path.length&&Pf($)&&(this.host&&(this.host=""),$=hX($,0)+":"),h1(this.path,$)),$="","file"===this.scheme&&(V===hn||"?"===V||"#"===V))for(;this.path.length>1&&""===this.path[0];)h3(this.path);"?"===V?(this.query="",G=p0):"#"===V&&(this.fragment="",G=p1)}else $+=Nf(V,pS);break;case p$:"?"===V?(this.query="",G=p0):"#"===V?(this.fragment="",G=p1):V!==hn&&(this.path[0]+=Nf(V,pm));break;case p0:k||"#"!==V?V!==hn&&("'"===V&&this.isSpecial()?this.query+="%27":this.query+="#"===V?"%23":Nf(V,pm)):(this.fragment="",G=p1);break;case p1:V!==hn&&(this.fragment+=Nf(V,pf))}X++}},parseHost:function(L){var k,M,U;if("["===hX(L,0)){if("]"!==hX(L,L.length-1)||!(k=function(L){var k,M,U,V,F,B,j,G=[0,0,0,0,0,0,0,0],X=0,$=null,ee=0,h=function(){return hX(L,ee)};if(":"===h()){if(":"!==hX(L,1))return;ee+=2,$=++X}for(;h();){if(8===X)return;if(":"!==h()){for(k=M=0;M<4&&hQ(pd,h());)k=16*k+hz(h(),16),ee++,M++;if("."===h()){if(0===M||(ee-=M,X>6))return;for(U=0;h();){if(V=null,U>0){if(!("."===h()&&U<4))return;ee++}if(!hQ(pn,h()))return;for(;hQ(pn,h());){if(F=hz(h(),10),null===V)V=F;else{if(0===V)return;V=10*V+F}if(V>255)return;ee++}G[X]=256*G[X]+V,2!=++U&&4!==U||X++}if(4!==U)return;break}if(":"===h()){if(ee++,!h())return}else if(h())return;G[X++]=k}else{if(null!==$)return;ee++,$=++X}}if(null!==$)for(B=X-$,X=7;0!==X&&B>0;)j=G[X],G[X--]=G[$+B-1],G[$+--B]=j;else if(8!==X)return;return G}(h4(L,1,-1))))return h7;this.host=k}else if(this.isSpecial()){if(hQ(pu,L=Um(L))||null===(k=function(L){var k,M,U,V,F,B,j,G=h5(L,".");if(G.length&&""===G[G.length-1]&&G.length--,(k=G.length)>4)return L;for(M=[],U=0;U<k;U++){if(""===(V=G[U]))return L;if(F=10,V.length>1&&"0"===hX(V,0)&&(F=hQ(pa,V)?16:8,V=h4(V,8===F?1:2)),""===V)B=0;else{if(!hQ(10===F?ps:8===F?po:pd,V))return L;B=hz(V,F)}h1(M,B)}for(U=0;U<k;U++)if(B=M[U],U===k-1){if(B>=hJ(256,5-k))return null}else if(B>255)return null;for(j=h0(M),U=0;U<M.length;U++)j+=M[U]*hJ(256,3-U);return j}(L)))return h7;this.host=k}else{if(hQ(ph,L))return h7;for(k="",M=Lm(L),U=0;U<M.length;U++)k+=Nf(M[U],pm);this.host=k}},cannotHaveUsernamePasswordPort:function(){return!this.host||this.cannotBeABaseURL||"file"===this.scheme},includesCredentials:function(){return""!==this.username||""!==this.password},isSpecial:function(){return or(pT,this.scheme)},shortenPath:function(){var L=this.path,k=L.length;!k||"file"===this.scheme&&1===k&&Pf(L[0],!0)||L.length--},serialize:function(){var L=this.scheme,k=this.username,M=this.password,U=this.host,V=this.port,F=this.path,B=this.query,j=this.fragment,G=L+":";return null!==U?(G+="//",this.includesCredentials()&&(G+=k+(M?":"+M:"")+"@"),G+=If(U),null!==V&&(G+=":"+V)):"file"===L&&(G+="//"),G+=this.cannotBeABaseURL?F[0]:F.length?"/"+hZ(F,"/"):"",null!==B&&(G+="?"+B),null!==j&&(G+="#"+j),G},setHref:function(L){var k=this.parse(L);if(k)throw new hH(k);this.searchParams.update()},getOrigin:function(){var L=this.scheme,k=this.port;if("blob"===L)try{return new nS(L.path[0]).origin}catch(L){return"null"}return"file"!==L&&this.isSpecial()?L+"://"+If(this.host)+(null!==k?":"+k:""):"null"},getProtocol:function(){return this.scheme+":"},setProtocol:function(L){this.parse(Sn(L)+":",pI)},getUsername:function(){return this.username},setUsername:function(L){var k=Lm(Sn(L));if(!this.cannotHaveUsernamePasswordPort()){this.username="";for(var M=0;M<k.length;M++)this.username+=Nf(k[M],pg)}},getPassword:function(){return this.password},setPassword:function(L){var k=Lm(Sn(L));if(!this.cannotHaveUsernamePasswordPort()){this.password="";for(var M=0;M<k.length;M++)this.password+=Nf(k[M],pg)}},getHost:function(){var L=this.host,k=this.port;return null===L?"":null===k?If(L):If(L)+":"+k},setHost:function(L){this.cannotBeABaseURL||this.parse(L,pU)},getHostname:function(){var L=this.host;return null===L?"":If(L)},setHostname:function(L){this.cannotBeABaseURL||this.parse(L,pH)},getPort:function(){var L=this.port;return null===L?"":Sn(L)},setPort:function(L){this.cannotHaveUsernamePasswordPort()||(""===(L=Sn(L))?this.port=null:this.parse(L,pz))},getPathname:function(){var L=this.path;return this.cannotBeABaseURL?L[0]:L.length?"/"+hZ(L,"/"):""},setPathname:function(L){this.cannotBeABaseURL||(this.path=[],this.parse(L,pQ))},getSearch:function(){var L=this.query;return L?"?"+L:""},setSearch:function(L){""===(L=Sn(L))?this.query=null:("?"===hX(L,0)&&(L=h4(L,1)),this.query="",this.parse(L,p0)),this.searchParams.update()},getSearchParams:function(){return this.searchParams.facade},getHash:function(){var L=this.fragment;return L?"#"+L:""},setHash:function(L){""!==(L=Sn(L))?("#"===hX(L,0)&&(L=h4(L,1)),this.fragment="",this.parse(L,p1)):this.fragment=null},update:function(){this.query=this.searchParams.serialize()||null}};var nS=function(L){var k=Nc(this,p2),M=cd(arguments.length,1)>1?arguments[1]:void 0,U=hL(k,new iS(L,!1,M));aI||(k.href=U.serialize(),k.origin=U.getOrigin(),k.protocol=U.getProtocol(),k.username=U.getUsername(),k.password=U.getPassword(),k.host=U.getHost(),k.hostname=U.getHostname(),k.port=U.getPort(),k.pathname=U.getPathname(),k.search=U.getSearch(),k.searchParams=U.getSearchParams(),k.hash=U.getHash())},p2=nS.prototype,oS=function(L,k){return{get:function(){return hk(this)[L]()},set:k&&function(L){return hk(this)[k](L)},configurable:!0,enumerable:!0}};if(aI&&(Cc(p2,"href",oS("serialize","setHref")),Cc(p2,"origin",oS("getOrigin")),Cc(p2,"protocol",oS("getProtocol","setProtocol")),Cc(p2,"username",oS("getUsername","setUsername")),Cc(p2,"password",oS("getPassword","setPassword")),Cc(p2,"host",oS("getHost","setHost")),Cc(p2,"hostname",oS("getHostname","setHostname")),Cc(p2,"port",oS("getPort","setPort")),Cc(p2,"pathname",oS("getPathname","setPathname")),Cc(p2,"search",oS("getSearch","setSearch")),Cc(p2,"searchParams",oS("getSearchParams")),Cc(p2,"hash",oS("getHash","setHash"))),Ca(p2,"toJSON",function(){return hk(this).serialize()},{enumerable:!0}),Ca(p2,"toString",function(){return hk(this).serialize()},{enumerable:!0}),hj){var p3=hj.createObjectURL,p5=hj.revokeObjectURL;p3&&Ca(nS,"createObjectURL",Zt(p3,hj)),p5&&Ca(nS,"revokeObjectURL",Zt(p5,hj))}Ga(nS,"URL"),Oi({global:!0,constructor:!0,forced:!uS,sham:!aI},{URL:nS});var p4=re("URL"),p6=uS&&n(function(){p4.canParse()}),p8=n(function(){return 1!==p4.canParse.length});Oi({target:"URL",stat:!0,forced:!p6||p8},{canParse:function(L){var k=cd(arguments.length,1),M=Sn(L),U=k<2||void 0===arguments[1]?void 0:Sn(arguments[1]);try{return new p4(M,U),!0}catch(L){return!1}}});var p9=re("URL");Oi({target:"URL",stat:!0,forced:!uS},{parse:function(L){var k=cd(arguments.length,1),M=Sn(L),U=k<2||void 0===arguments[1]?void 0:Sn(arguments[1]);try{return new p9(M,U)}catch(L){return null}}});var p7=i(aB.URL);function yS(L,k,M){let U=L.match(k);return U&&U.length>=M&&parseInt(U[M],10)}function IS(L,k,M){if(!L.RTCPeerConnection)return;let U=L.RTCPeerConnection.prototype,V=U.addEventListener;U.addEventListener=function(L,U){if(L!==k)return V.apply(this,arguments);let o=L=>{let k=M(L);k&&(U.handleEvent?U.handleEvent(k):U(k))};return this._eventMap=this._eventMap||{},this._eventMap[k]||(this._eventMap[k]=new Map),this._eventMap[k].set(U,o),V.apply(this,[L,o])};let F=U.removeEventListener;U.removeEventListener=function(L,M){if(L!==k||!this._eventMap||!this._eventMap[k]||!this._eventMap[k].has(M))return F.apply(this,arguments);let U=this._eventMap[k].get(M);return this._eventMap[k].delete(M),0===this._eventMap[k].size&&delete this._eventMap[k],0===Object.keys(this._eventMap).length&&delete this._eventMap,F.apply(this,[L,U])},Object.defineProperty(U,"on"+k,{get(){return this["_on"+k]},set(L){this["_on"+k]&&(this.removeEventListener(k,this["_on"+k]),delete this["_on"+k]),L&&this.addEventListener(k,this["_on"+k]=L)},enumerable:!0,configurable:!0})}function wS(){}function OS(L,k){console.warn(L+" is deprecated, please use "+k+" instead.")}function NS(L){return"[object Object]"===Object.prototype.toString.call(L)}function DS(L){var k;return NS(L)?sE(k=Object.keys(L)).call(k,function(k,M){let U=NS(L[M]),V=U?DS(L[M]):L[M],F=U&&!Object.keys(V).length;return void 0===V||F?k:Object.assign(k,{[M]:V})},{}):L}function PS(L,k,M){k&&!M.has(k.id)&&(M.set(k.id,k),Object.keys(k).forEach(U=>{U.endsWith("Id")?PS(L,L.get(k[U]),M):U.endsWith("Ids")&&k[U].forEach(k=>{PS(L,L.get(k),M)})}))}function LS(L,k,M){let U=M?"outbound-rtp":"inbound-rtp",V=new Map;if(null===k)return V;let F=[];return L.forEach(L=>{"track"===L.type&&L.trackIdentifier===k.id&&F.push(L)}),F.forEach(k=>{L.forEach(M=>{M.type===U&&M.trackId===k.id&&PS(L,M,V)})}),V}let _e=wS;function MS(L,k){let M=L&&L.navigator;if(!M.mediaDevices)return;let n=function(L){if("object"!=typeof L||L.mandatory||L.optional)return L;let k={};return Object.keys(L).forEach(M=>{if("require"===M||"advanced"===M||"mediaSource"===M)return;let U="object"==typeof L[M]?L[M]:{ideal:L[M]};void 0!==U.exact&&"number"==typeof U.exact&&(U.min=U.max=U.exact);let r=function(L,k){return L?L+k.charAt(0).toUpperCase()+k.slice(1):"deviceId"===k?"sourceId":k};if(void 0!==U.ideal){k.optional=k.optional||[];let L={};"number"==typeof U.ideal?(L[r("min",M)]=U.ideal,k.optional.push(L),(L={})[r("max",M)]=U.ideal):L[r("",M)]=U.ideal,k.optional.push(L)}void 0!==U.exact&&"number"!=typeof U.exact?(k.mandatory=k.mandatory||{},k.mandatory[r("",M)]=U.exact):["min","max"].forEach(L=>{void 0!==U[L]&&(k.mandatory=k.mandatory||{},k.mandatory[r(L,M)]=U[L])})}),L.advanced&&(k.optional=(k.optional||[]).concat(L.advanced)),k},r=function(L,U){if(k.version>=61)return U(L);if((L=JSON.parse(JSON.stringify(L)))&&"object"==typeof L.audio){let t=function(L,k,M){k in L&&!(M in L)&&(L[M]=L[k],delete L[k])};t((L=JSON.parse(JSON.stringify(L))).audio,"autoGainControl","googAutoGainControl"),t(L.audio,"noiseSuppression","googNoiseSuppression"),L.audio=n(L.audio)}if(L&&"object"==typeof L.video){let V=L.video.facingMode;V=V&&("object"==typeof V?V:{ideal:V});let F=k.version<66;if(V&&("user"===V.exact||"environment"===V.exact||"user"===V.ideal||"environment"===V.ideal)&&(!M.mediaDevices.getSupportedConstraints||!M.mediaDevices.getSupportedConstraints().facingMode||F)){let k;if(delete L.video.facingMode,"environment"===V.exact||"environment"===V.ideal?k=["back","rear"]:"user"!==V.exact&&"user"!==V.ideal||(k=["front"]),k)return M.mediaDevices.enumerateDevices().then(M=>{let F=(M=M.filter(L=>"videoinput"===L.kind)).find(L=>k.some(k=>{var M;return so(M=L.label.toLowerCase()).call(M,k)}));return!F&&M.length&&so(k).call(k,"back")&&(F=M[M.length-1]),F&&(L.video.deviceId=V.exact?{exact:F.deviceId}:{ideal:F.deviceId}),L.video=n(L.video),_e("chrome: "+JSON.stringify(L)),U(L)})}L.video=n(L.video)}return _e("chrome: "+JSON.stringify(L)),U(L)},o=function(L){return k.version>=64?L:{name:({PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"})[L.name]||L.name,message:L.message,constraint:L.constraint||L.constraintName,toString(){return this.name+(this.message&&": ")+this.message}}};if(M.getUserMedia=(function(L,k,U){r(L,L=>{M.webkitGetUserMedia(L,k,L=>{U&&U(o(L))})})}).bind(M),M.mediaDevices.getUserMedia){let L=M.mediaDevices.getUserMedia.bind(M.mediaDevices);M.mediaDevices.getUserMedia=function(k){return r(k,k=>L(k).then(L=>{if(k.audio&&!L.getAudioTracks().length||k.video&&!L.getVideoTracks().length)throw L.getTracks().forEach(L=>{L.stop()}),new DOMException("","NotFoundError");return L},L=>lQ.reject(o(L))))}}}function US(L){L.MediaStream=L.MediaStream||L.webkitMediaStream}function VS(L){if("object"!=typeof L||!L.RTCPeerConnection||"ontrack"in L.RTCPeerConnection.prototype)IS(L,"track",L=>(L.transceiver||Object.defineProperty(L,"transceiver",{value:{receiver:L.receiver}}),L));else{Object.defineProperty(L.RTCPeerConnection.prototype,"ontrack",{get(){return this._ontrack},set(L){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=L)},enumerable:!0,configurable:!0});let k=L.RTCPeerConnection.prototype.setRemoteDescription;L.RTCPeerConnection.prototype.setRemoteDescription=function(){return this._ontrackpoly||(this._ontrackpoly=k=>{k.stream.addEventListener("addtrack",M=>{let U;U=L.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find(L=>L.track&&L.track.id===M.track.id):{track:M.track};let V=new Event("track");V.track=M.track,V.receiver=U,V.transceiver={receiver:U},V.streams=[k.stream],this.dispatchEvent(V)}),k.stream.getTracks().forEach(M=>{let U;U=L.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find(L=>L.track&&L.track.id===M.id):{track:M};let V=new Event("track");V.track=M,V.receiver=U,V.transceiver={receiver:U},V.streams=[k.stream],this.dispatchEvent(V)})},this.addEventListener("addstream",this._ontrackpoly)),k.apply(this,arguments)}}}function xS(L){if("object"==typeof L&&L.RTCPeerConnection&&!("getSenders"in L.RTCPeerConnection.prototype)&&"createDTMFSender"in L.RTCPeerConnection.prototype){let t=function(L,k){return{track:k,get dtmf(){return void 0===this._dtmf&&("audio"===k.kind?this._dtmf=L.createDTMFSender(k):this._dtmf=null),this._dtmf},_pc:L}};if(!L.RTCPeerConnection.prototype.getSenders){L.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};let k=L.RTCPeerConnection.prototype.addTrack;L.RTCPeerConnection.prototype.addTrack=function(L,M){let U=k.apply(this,arguments);return U||(U=t(this,L),this._senders.push(U)),U};let M=L.RTCPeerConnection.prototype.removeTrack;L.RTCPeerConnection.prototype.removeTrack=function(L){M.apply(this,arguments);let k=this._senders.indexOf(L);-1!==k&&this._senders.splice(k,1)}}let k=L.RTCPeerConnection.prototype.addStream;L.RTCPeerConnection.prototype.addStream=function(L){this._senders=this._senders||[],k.apply(this,[L]),L.getTracks().forEach(L=>{this._senders.push(t(this,L))})};let M=L.RTCPeerConnection.prototype.removeStream;L.RTCPeerConnection.prototype.removeStream=function(L){this._senders=this._senders||[],M.apply(this,[L]),L.getTracks().forEach(L=>{let k=this._senders.find(k=>k.track===L);k&&this._senders.splice(this._senders.indexOf(k),1)})}}else if("object"==typeof L&&L.RTCPeerConnection&&"getSenders"in L.RTCPeerConnection.prototype&&"createDTMFSender"in L.RTCPeerConnection.prototype&&L.RTCRtpSender&&!("dtmf"in L.RTCRtpSender.prototype)){let k=L.RTCPeerConnection.prototype.getSenders;L.RTCPeerConnection.prototype.getSenders=function(){let L=k.apply(this,[]);return L.forEach(L=>L._pc=this),L},Object.defineProperty(L.RTCRtpSender.prototype,"dtmf",{get(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}}function FS(L){if(!L.RTCPeerConnection)return;let k=L.RTCPeerConnection.prototype.getStats;L.RTCPeerConnection.prototype.getStats=function(){let[L,M,U]=arguments;if(arguments.length>0&&"function"==typeof L)return k.apply(this,arguments);if(0===k.length&&(0==arguments.length||"function"!=typeof L))return k.apply(this,[]);let r=function(L){let k={};return L.result().forEach(L=>{let M={id:L.id,timestamp:L.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[L.type]||L.type};L.names().forEach(k=>{M[k]=L.stat(k)}),k[M.id]=M}),k},o=function(L){return new Map(Object.keys(L).map(k=>[k,L[k]]))};return arguments.length>=2?k.apply(this,[function(L){M(o(r(L)))},L]):new lQ((L,M)=>{k.apply(this,[function(k){L(o(r(k)))},M])}).then(M,U)}}function BS(L){if(!("object"==typeof L&&L.RTCPeerConnection&&L.RTCRtpSender&&L.RTCRtpReceiver))return;if(!("getStats"in L.RTCRtpSender.prototype)){let k=L.RTCPeerConnection.prototype.getSenders;k&&(L.RTCPeerConnection.prototype.getSenders=function(){let L=k.apply(this,[]);return L.forEach(L=>L._pc=this),L});let M=L.RTCPeerConnection.prototype.addTrack;M&&(L.RTCPeerConnection.prototype.addTrack=function(){let L=M.apply(this,arguments);return L._pc=this,L}),L.RTCRtpSender.prototype.getStats=function(){let L=this;return this._pc.getStats().then(k=>LS(k,L.track,!0))}}if(!("getStats"in L.RTCRtpReceiver.prototype)){let k=L.RTCPeerConnection.prototype.getReceivers;k&&(L.RTCPeerConnection.prototype.getReceivers=function(){let L=k.apply(this,[]);return L.forEach(L=>L._pc=this),L}),IS(L,"track",L=>(L.receiver._pc=L.srcElement,L)),L.RTCRtpReceiver.prototype.getStats=function(){let L=this;return this._pc.getStats().then(k=>LS(k,L.track,!1))}}if(!("getStats"in L.RTCRtpSender.prototype)||!("getStats"in L.RTCRtpReceiver.prototype))return;let k=L.RTCPeerConnection.prototype.getStats;L.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof L.MediaStreamTrack){let L,k,M;let U=arguments[0];return this.getSenders().forEach(k=>{k.track===U&&(L?M=!0:L=k)}),this.getReceivers().forEach(L=>(L.track===U&&(k?M=!0:k=L),L.track===U)),M||L&&k?lQ.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):L?L.getStats():k?k.getStats():lQ.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return k.apply(this,arguments)}}function jS(L){L.RTCPeerConnection.prototype.getLocalStreams=function(){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map(L=>this._shimmedLocalStreams[L][0])};let k=L.RTCPeerConnection.prototype.addTrack;L.RTCPeerConnection.prototype.addTrack=function(L,M){if(!M)return k.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};let U=k.apply(this,arguments);return this._shimmedLocalStreams[M.id]?-1===this._shimmedLocalStreams[M.id].indexOf(U)&&this._shimmedLocalStreams[M.id].push(U):this._shimmedLocalStreams[M.id]=[M,U],U};let M=L.RTCPeerConnection.prototype.addStream;L.RTCPeerConnection.prototype.addStream=function(L){this._shimmedLocalStreams=this._shimmedLocalStreams||{},L.getTracks().forEach(L=>{let k=this.getSenders().find(k=>k.track===L);if(k)throw new DOMException("Track already exists.","InvalidAccessError")});let k=this.getSenders();M.apply(this,arguments);let U=this.getSenders().filter(L=>-1===k.indexOf(L));this._shimmedLocalStreams[L.id]=[L].concat(U)};let U=L.RTCPeerConnection.prototype.removeStream;L.RTCPeerConnection.prototype.removeStream=function(L){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[L.id],U.apply(this,arguments)};let V=L.RTCPeerConnection.prototype.removeTrack;L.RTCPeerConnection.prototype.removeTrack=function(L){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},L&&Object.keys(this._shimmedLocalStreams).forEach(k=>{let M=this._shimmedLocalStreams[k].indexOf(L);-1!==M&&this._shimmedLocalStreams[k].splice(M,1),1===this._shimmedLocalStreams[k].length&&delete this._shimmedLocalStreams[k]}),V.apply(this,arguments)}}function GS(L,k){if(!L.RTCPeerConnection)return;if(L.RTCPeerConnection.prototype.addTrack&&k.version>=65)return jS(L);let M=L.RTCPeerConnection.prototype.getLocalStreams;L.RTCPeerConnection.prototype.getLocalStreams=function(){let L=M.apply(this);return this._reverseStreams=this._reverseStreams||{},L.map(L=>this._reverseStreams[L.id])};let U=L.RTCPeerConnection.prototype.addStream;L.RTCPeerConnection.prototype.addStream=function(k){if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},k.getTracks().forEach(L=>{let k=this.getSenders().find(k=>k.track===L);if(k)throw new DOMException("Track already exists.","InvalidAccessError")}),!this._reverseStreams[k.id]){let M=new L.MediaStream(k.getTracks());this._streams[k.id]=M,this._reverseStreams[M.id]=k,k=M}U.apply(this,[k])};let V=L.RTCPeerConnection.prototype.removeStream;function o(L,k){let M=k.sdp;return Object.keys(L._reverseStreams||[]).forEach(k=>{let U=L._reverseStreams[k],V=L._streams[U.id];M=M.replace(RegExp(V.id,"g"),U.id)}),new RTCSessionDescription({type:k.type,sdp:M})}L.RTCPeerConnection.prototype.removeStream=function(L){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},V.apply(this,[this._streams[L.id]||L]),delete this._reverseStreams[this._streams[L.id]?this._streams[L.id].id:L.id],delete this._streams[L.id]},L.RTCPeerConnection.prototype.addTrack=function(k,M){if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");let U=[].slice.call(arguments,1);if(1!==U.length||!U[0].getTracks().find(L=>L===k))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");let V=this.getSenders().find(L=>L.track===k);if(V)throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};let F=this._streams[M.id];if(F)F.addTrack(k),lQ.resolve().then(()=>{this.dispatchEvent(new Event("negotiationneeded"))});else{let U=new L.MediaStream([k]);this._streams[M.id]=U,this._reverseStreams[U.id]=M,this.addStream(U)}return this.getSenders().find(L=>L.track===k)},["createOffer","createAnswer"].forEach(function(k){let M=L.RTCPeerConnection.prototype[k];L.RTCPeerConnection.prototype[k]=({[k](){let L=arguments;return arguments.length&&"function"==typeof arguments[0]?M.apply(this,[k=>{let M=o(this,k);L[0].apply(null,[M])},k=>{L[1]&&L[1].apply(null,k)},arguments[2]]):M.apply(this,arguments).then(L=>o(this,L))}})[k]});let F=L.RTCPeerConnection.prototype.setLocalDescription;L.RTCPeerConnection.prototype.setLocalDescription=function(){var L,k;let M;return arguments.length&&arguments[0].type&&(arguments[0]=(L=this,k=arguments[0],M=k.sdp,Object.keys(L._reverseStreams||[]).forEach(k=>{let U=L._reverseStreams[k],V=L._streams[U.id];M=M.replace(RegExp(U.id,"g"),V.id)}),new RTCSessionDescription({type:k.type,sdp:M}))),F.apply(this,arguments)};let B=Object.getOwnPropertyDescriptor(L.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(L.RTCPeerConnection.prototype,"localDescription",{get(){let L=B.get.apply(this);return""===L.type?L:o(this,L)}}),L.RTCPeerConnection.prototype.removeTrack=function(L){let k;if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!L._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(L._pc!==this)throw new DOMException("Sender was not created by this connection.","InvalidAccessError");this._streams=this._streams||{},Object.keys(this._streams).forEach(M=>{this._streams[M].getTracks().find(k=>L.track===k)&&(k=this._streams[M])}),k&&(1===k.getTracks().length?this.removeStream(this._reverseStreams[k.id]):k.removeTrack(L.track),this.dispatchEvent(new Event("negotiationneeded")))}}function WS(L,k){!L.RTCPeerConnection&&L.webkitRTCPeerConnection&&(L.RTCPeerConnection=L.webkitRTCPeerConnection),L.RTCPeerConnection&&k.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(k){let M=L.RTCPeerConnection.prototype[k];L.RTCPeerConnection.prototype[k]=({[k](){return arguments[0]=new("addIceCandidate"===k?L.RTCIceCandidate:L.RTCSessionDescription)(arguments[0]),M.apply(this,arguments)}})[k]})}function HS(L,k){IS(L,"negotiationneeded",L=>{let M=L.target;if(!(k.version<72||M.getConfiguration&&"plan-b"===M.getConfiguration().sdpSemantics)||"stable"===M.signalingState)return L})}var _t=Object.freeze({__proto__:null,fixNegotiationNeeded:HS,shimAddTrackRemoveTrack:GS,shimAddTrackRemoveTrackWithNative:jS,shimGetDisplayMedia:function(L,k){L.navigator.mediaDevices&&"getDisplayMedia"in L.navigator.mediaDevices||L.navigator.mediaDevices&&("function"==typeof k?L.navigator.mediaDevices.getDisplayMedia=function(M){return k(M).then(k=>{let U=M.video&&M.video.width,V=M.video&&M.video.height,F=M.video&&M.video.frameRate;return M.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:k,maxFrameRate:F||3}},U&&(M.video.mandatory.maxWidth=U),V&&(M.video.mandatory.maxHeight=V),L.navigator.mediaDevices.getUserMedia(M)})}:console.error("shimGetDisplayMedia: getSourceId argument is not a function"))},shimGetSendersWithDtmf:xS,shimGetStats:FS,shimGetUserMedia:MS,shimMediaStream:US,shimOnTrack:VS,shimPeerConnection:WS,shimSenderReceiverGetStats:BS});function YS(L,k){let M=L&&L.navigator,U=L&&L.MediaStreamTrack;if(M.getUserMedia=function(L,k,U){OS("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),M.mediaDevices.getUserMedia(L).then(k,U)},!(k.version>55&&"autoGainControl"in M.mediaDevices.getSupportedConstraints())){let e=function(L,k,M){k in L&&!(M in L)&&(L[M]=L[k],delete L[k])},L=M.mediaDevices.getUserMedia.bind(M.mediaDevices);if(M.mediaDevices.getUserMedia=function(k){return"object"==typeof k&&"object"==typeof k.audio&&(e((k=JSON.parse(JSON.stringify(k))).audio,"autoGainControl","mozAutoGainControl"),e(k.audio,"noiseSuppression","mozNoiseSuppression")),L(k)},U&&U.prototype.getSettings){let L=U.prototype.getSettings;U.prototype.getSettings=function(){let k=L.apply(this,arguments);return e(k,"mozAutoGainControl","autoGainControl"),e(k,"mozNoiseSuppression","noiseSuppression"),k}}if(U&&U.prototype.applyConstraints){let L=U.prototype.applyConstraints;U.prototype.applyConstraints=function(k){return"audio"===this.kind&&"object"==typeof k&&(e(k=JSON.parse(JSON.stringify(k)),"autoGainControl","mozAutoGainControl"),e(k,"noiseSuppression","mozNoiseSuppression")),L.apply(this,[k])}}}}function zS(L){"object"==typeof L&&L.RTCTrackEvent&&"receiver"in L.RTCTrackEvent.prototype&&!("transceiver"in L.RTCTrackEvent.prototype)&&Object.defineProperty(L.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function qS(L,k){if("object"!=typeof L||!L.RTCPeerConnection&&!L.mozRTCPeerConnection)return;!L.RTCPeerConnection&&L.mozRTCPeerConnection&&(L.RTCPeerConnection=L.mozRTCPeerConnection),k.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(k){let M=L.RTCPeerConnection.prototype[k];L.RTCPeerConnection.prototype[k]=({[k](){return arguments[0]=new("addIceCandidate"===k?L.RTCIceCandidate:L.RTCSessionDescription)(arguments[0]),M.apply(this,arguments)}})[k]});let M={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},U=L.RTCPeerConnection.prototype.getStats;L.RTCPeerConnection.prototype.getStats=function(){let[L,V,F]=arguments;return U.apply(this,[L||null]).then(L=>{if(k.version<53&&!V)try{L.forEach(L=>{L.type=M[L.type]||L.type})}catch(k){if("TypeError"!==k.name)throw k;L.forEach((k,U)=>{L.set(U,Object.assign({},k,{type:M[k.type]||k.type}))})}return L}).then(V,F)}}function XS(L){if("object"!=typeof L||!L.RTCPeerConnection||!L.RTCRtpSender||L.RTCRtpSender&&"getStats"in L.RTCRtpSender.prototype)return;let k=L.RTCPeerConnection.prototype.getSenders;k&&(L.RTCPeerConnection.prototype.getSenders=function(){let L=k.apply(this,[]);return L.forEach(L=>L._pc=this),L});let M=L.RTCPeerConnection.prototype.addTrack;M&&(L.RTCPeerConnection.prototype.addTrack=function(){let L=M.apply(this,arguments);return L._pc=this,L}),L.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):lQ.resolve(new Map)}}function JS(L){if("object"!=typeof L||!L.RTCPeerConnection||!L.RTCRtpSender||L.RTCRtpSender&&"getStats"in L.RTCRtpReceiver.prototype)return;let k=L.RTCPeerConnection.prototype.getReceivers;k&&(L.RTCPeerConnection.prototype.getReceivers=function(){let L=k.apply(this,[]);return L.forEach(L=>L._pc=this),L}),IS(L,"track",L=>(L.receiver._pc=L.srcElement,L)),L.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}function ZS(L){!L.RTCPeerConnection||"removeStream"in L.RTCPeerConnection.prototype||(L.RTCPeerConnection.prototype.removeStream=function(L){OS("removeStream","removeTrack"),this.getSenders().forEach(k=>{var M;k.track&&so(M=L.getTracks()).call(M,k.track)&&this.removeTrack(k)})})}function QS(L){L.DataChannel&&!L.RTCDataChannel&&(L.RTCDataChannel=L.DataChannel)}function $S(L){if("object"!=typeof L||!L.RTCPeerConnection)return;let k=L.RTCPeerConnection.prototype.addTransceiver;k&&(L.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];let L=arguments[1]&&arguments[1].sendEncodings;void 0===L&&(L=[]),L=[...L];let M=L.length>0;M&&L.forEach(L=>{if("rid"in L&&!/^[a-z0-9]{0,16}$/i.test(L.rid))throw TypeError("Invalid RID value provided.");if("scaleResolutionDownBy"in L&&!(parseFloat(L.scaleResolutionDownBy)>=1))throw RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in L&&!(parseFloat(L.maxFramerate)>=0))throw RangeError("max_framerate must be >= 0.0")});let U=k.apply(this,arguments);if(M){let{sender:k}=U,M=k.getParameters();"encodings"in M&&(1!==M.encodings.length||0!==Object.keys(M.encodings[0]).length)||(M.encodings=L,k.sendEncodings=L,this.setParametersPromises.push(k.setParameters(M).then(()=>{delete k.sendEncodings}).catch(()=>{delete k.sendEncodings})))}return U})}function eg(L){if("object"!=typeof L||!L.RTCRtpSender)return;let k=L.RTCRtpSender.prototype.getParameters;k&&(L.RTCRtpSender.prototype.getParameters=function(){let L=k.apply(this,arguments);return"encodings"in L||(L.encodings=[].concat(this.sendEncodings||[{}])),L})}function tg(L){if("object"!=typeof L||!L.RTCPeerConnection)return;let k=L.RTCPeerConnection.prototype.createOffer;L.RTCPeerConnection.prototype.createOffer=function(){return this.setParametersPromises&&this.setParametersPromises.length?lQ.all(this.setParametersPromises).then(()=>k.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):k.apply(this,arguments)}}function ig(L){if("object"!=typeof L||!L.RTCPeerConnection)return;let k=L.RTCPeerConnection.prototype.createAnswer;L.RTCPeerConnection.prototype.createAnswer=function(){return this.setParametersPromises&&this.setParametersPromises.length?lQ.all(this.setParametersPromises).then(()=>k.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):k.apply(this,arguments)}}var _i=Object.freeze({__proto__:null,shimAddTransceiver:$S,shimCreateAnswer:ig,shimCreateOffer:tg,shimGetDisplayMedia:function(L,k){L.navigator.mediaDevices&&"getDisplayMedia"in L.navigator.mediaDevices||L.navigator.mediaDevices&&(L.navigator.mediaDevices.getDisplayMedia=function(M){if(!M||!M.video){let L=new DOMException("getDisplayMedia without video constraints is undefined");return L.name="NotFoundError",L.code=8,lQ.reject(L)}return!0===M.video?M.video={mediaSource:k}:M.video.mediaSource=k,L.navigator.mediaDevices.getUserMedia(M)})},shimGetParameters:eg,shimGetUserMedia:YS,shimOnTrack:zS,shimPeerConnection:qS,shimRTCDataChannel:QS,shimReceiverGetStats:JS,shimRemoveStream:ZS,shimSenderGetStats:XS});function rg(L){if("object"==typeof L&&L.RTCPeerConnection){if("getLocalStreams"in L.RTCPeerConnection.prototype||(L.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in L.RTCPeerConnection.prototype)){let k=L.RTCPeerConnection.prototype.addTrack;L.RTCPeerConnection.prototype.addStream=function(L){var M;this._localStreams||(this._localStreams=[]),so(M=this._localStreams).call(M,L)||this._localStreams.push(L),L.getAudioTracks().forEach(M=>k.call(this,M,L)),L.getVideoTracks().forEach(M=>k.call(this,M,L))},L.RTCPeerConnection.prototype.addTrack=function(L){for(var M=arguments.length,U=Array(M>1?M-1:0),V=1;V<M;V++)U[V-1]=arguments[V];return U&&U.forEach(L=>{var k;this._localStreams?so(k=this._localStreams).call(k,L)||this._localStreams.push(L):this._localStreams=[L]}),k.apply(this,arguments)}}"removeStream"in L.RTCPeerConnection.prototype||(L.RTCPeerConnection.prototype.removeStream=function(L){this._localStreams||(this._localStreams=[]);let k=this._localStreams.indexOf(L);if(-1===k)return;this._localStreams.splice(k,1);let M=L.getTracks();this.getSenders().forEach(L=>{so(M).call(M,L.track)&&this.removeTrack(L)})})}}function og(L){if("object"==typeof L&&L.RTCPeerConnection&&("getRemoteStreams"in L.RTCPeerConnection.prototype||(L.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in L.RTCPeerConnection.prototype))){Object.defineProperty(L.RTCPeerConnection.prototype,"onaddstream",{get(){return this._onaddstream},set(L){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=L),this.addEventListener("track",this._onaddstreampoly=L=>{L.streams.forEach(L=>{var k;if(this._remoteStreams||(this._remoteStreams=[]),so(k=this._remoteStreams).call(k,L))return;this._remoteStreams.push(L);let M=new Event("addstream");M.stream=L,this.dispatchEvent(M)})})}});let k=L.RTCPeerConnection.prototype.setRemoteDescription;L.RTCPeerConnection.prototype.setRemoteDescription=function(){let L=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(k){k.streams.forEach(k=>{if(L._remoteStreams||(L._remoteStreams=[]),L._remoteStreams.indexOf(k)>=0)return;L._remoteStreams.push(k);let M=new Event("addstream");M.stream=k,L.dispatchEvent(M)})}),k.apply(L,arguments)}}}function sg(L){if("object"!=typeof L||!L.RTCPeerConnection)return;let k=L.RTCPeerConnection.prototype,M=k.createOffer,U=k.createAnswer,V=k.setLocalDescription,F=k.setRemoteDescription,B=k.addIceCandidate;k.createOffer=function(L,k){let U=arguments.length>=2?arguments[2]:arguments[0],V=M.apply(this,[U]);return k?(V.then(L,k),lQ.resolve()):V},k.createAnswer=function(L,k){let M=arguments.length>=2?arguments[2]:arguments[0],V=U.apply(this,[M]);return k?(V.then(L,k),lQ.resolve()):V};let a=function(L,k,M){let U=V.apply(this,[L]);return M?(U.then(k,M),lQ.resolve()):U};k.setLocalDescription=a,a=function(L,k,M){let U=F.apply(this,[L]);return M?(U.then(k,M),lQ.resolve()):U},k.setRemoteDescription=a,a=function(L,k,M){let U=B.apply(this,[L]);return M?(U.then(k,M),lQ.resolve()):U},k.addIceCandidate=a}function ag(L){let k=L&&L.navigator;if(k.mediaDevices&&k.mediaDevices.getUserMedia){let L=k.mediaDevices,M=L.getUserMedia.bind(L);k.mediaDevices.getUserMedia=L=>M(cg(L))}!k.getUserMedia&&k.mediaDevices&&k.mediaDevices.getUserMedia&&(k.getUserMedia=(function(L,M,U){k.mediaDevices.getUserMedia(L).then(M,U)}).bind(k))}function cg(L){return L&&void 0!==L.video?Object.assign({},L,{video:DS(L.video)}):L}function dg(L){if(!L.RTCPeerConnection)return;let k=L.RTCPeerConnection;L.RTCPeerConnection=function(L,M){if(L&&L.iceServers){let k=[];for(let M=0;M<L.iceServers.length;M++){let U=L.iceServers[M];!U.hasOwnProperty("urls")&&U.hasOwnProperty("url")?(OS("RTCIceServer.url","RTCIceServer.urls"),(U=JSON.parse(JSON.stringify(U))).urls=U.url,delete U.url,k.push(U)):k.push(L.iceServers[M])}L.iceServers=k}return new k(L,M)},L.RTCPeerConnection.prototype=k.prototype,"generateCertificate"in k&&Object.defineProperty(L.RTCPeerConnection,"generateCertificate",{get:()=>k.generateCertificate})}function lg(L){"object"==typeof L&&L.RTCTrackEvent&&"receiver"in L.RTCTrackEvent.prototype&&!("transceiver"in L.RTCTrackEvent.prototype)&&Object.defineProperty(L.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function ug(L){let k=L.RTCPeerConnection.prototype.createOffer;L.RTCPeerConnection.prototype.createOffer=function(L){if(L){void 0!==L.offerToReceiveAudio&&(L.offerToReceiveAudio=!!L.offerToReceiveAudio);let k=this.getTransceivers().find(L=>"audio"===L.receiver.track.kind);!1===L.offerToReceiveAudio&&k?"sendrecv"===k.direction?k.setDirection?k.setDirection("sendonly"):k.direction="sendonly":"recvonly"===k.direction&&(k.setDirection?k.setDirection("inactive"):k.direction="inactive"):!0!==L.offerToReceiveAudio||k||this.addTransceiver("audio",{direction:"recvonly"}),void 0!==L.offerToReceiveVideo&&(L.offerToReceiveVideo=!!L.offerToReceiveVideo);let M=this.getTransceivers().find(L=>"video"===L.receiver.track.kind);!1===L.offerToReceiveVideo&&M?"sendrecv"===M.direction?M.setDirection?M.setDirection("sendonly"):M.direction="sendonly":"recvonly"===M.direction&&(M.setDirection?M.setDirection("inactive"):M.direction="inactive"):!0!==L.offerToReceiveVideo||M||this.addTransceiver("video",{direction:"recvonly"})}return k.apply(this,arguments)}}function hg(L){"object"!=typeof L||L.AudioContext||(L.AudioContext=L.webkitAudioContext)}var _r=Object.freeze({__proto__:null,shimAudioContext:hg,shimCallbacksAPI:sg,shimConstraints:cg,shimCreateOfferLegacy:ug,shimGetUserMedia:ag,shimLocalStreamsAPI:rg,shimRTCIceServerUrls:dg,shimRemoteStreamsAPI:og,shimTrackEventTransceiver:lg}),_n="	\n\v\f\r \xa0              　\u2028\u2029\uFEFF",_a=ad("".replace),_o=RegExp("^["+_n+"]+"),_s=RegExp("(^|[^"+_n+"])["+_n+"]+$"),Rg=function(L){return function(k){var M=Sn(z(k));return 1&L&&(M=_a(M,_o,"")),2&L&&(M=_a(M,_s,"$1")),M}},_c={start:Rg(1),end:Rg(2),trim:Rg(3)},_d=cU.PROPER,_l=_c.trim;Oi({target:"String",proto:!0,forced:(j="trim",n(function(){return!!_n[j]()||"​\x85᠎"!=="​\x85᠎"[j]()||_d&&_n[j].name!==j}))},{trim:function(){return _l(this)}});var _u=Qi("String","trim"),_h=String.prototype,_p=i(function(L){var k=L.trim;return"string"==typeof L||L===_h||al(_h,L)&&k===_h.trim?_u:k}),__={exports:{}};!function(L){let k={generateIdentifier:function(){return Math.random().toString(36).substring(2,12)}};k.localCName=k.generateIdentifier(),k.splitLines=function(L){return L.trim().split("\n").map(L=>L.trim())},k.splitSections=function(L){return L.split("\nm=").map((L,k)=>(k>0?"m="+L:L).trim()+"\r\n")},k.getDescription=function(L){let M=k.splitSections(L);return M&&M[0]},k.getMediaSections=function(L){let M=k.splitSections(L);return M.shift(),M},k.matchPrefix=function(L,M){return k.splitLines(L).filter(L=>0===L.indexOf(M))},k.parseCandidate=function(L){let k;k=0===L.indexOf("a=candidate:")?L.substring(12).split(" "):L.substring(10).split(" ");let M={foundation:k[0],component:{1:"rtp",2:"rtcp"}[k[1]]||k[1],protocol:k[2].toLowerCase(),priority:parseInt(k[3],10),ip:k[4],address:k[4],port:parseInt(k[5],10),type:k[7]};for(let L=8;L<k.length;L+=2)switch(k[L]){case"raddr":M.relatedAddress=k[L+1];break;case"rport":M.relatedPort=parseInt(k[L+1],10);break;case"tcptype":M.tcpType=k[L+1];break;case"ufrag":M.ufrag=k[L+1],M.usernameFragment=k[L+1];break;default:void 0===M[k[L]]&&(M[k[L]]=k[L+1])}return M},k.writeCandidate=function(L){let k=[];k.push(L.foundation);let M=L.component;"rtp"===M?k.push(1):"rtcp"===M?k.push(2):k.push(M),k.push(L.protocol.toUpperCase()),k.push(L.priority),k.push(L.address||L.ip),k.push(L.port);let U=L.type;return k.push("typ"),k.push(U),"host"!==U&&L.relatedAddress&&L.relatedPort&&(k.push("raddr"),k.push(L.relatedAddress),k.push("rport"),k.push(L.relatedPort)),L.tcpType&&"tcp"===L.protocol.toLowerCase()&&(k.push("tcptype"),k.push(L.tcpType)),(L.usernameFragment||L.ufrag)&&(k.push("ufrag"),k.push(L.usernameFragment||L.ufrag)),"candidate:"+k.join(" ")},k.parseIceOptions=function(L){return L.substring(14).split(" ")},k.parseRtpMap=function(L){let k=L.substring(9).split(" "),M={payloadType:parseInt(k.shift(),10)};return k=k[0].split("/"),M.name=k[0],M.clockRate=parseInt(k[1],10),M.channels=3===k.length?parseInt(k[2],10):1,M.numChannels=M.channels,M},k.writeRtpMap=function(L){let k=L.payloadType;void 0!==L.preferredPayloadType&&(k=L.preferredPayloadType);let M=L.channels||L.numChannels||1;return"a=rtpmap:"+k+" "+L.name+"/"+L.clockRate+(1!==M?"/"+M:"")+"\r\n"},k.parseExtmap=function(L){let k=L.substring(9).split(" ");return{id:parseInt(k[0],10),direction:k[0].indexOf("/")>0?k[0].split("/")[1]:"sendrecv",uri:k[1],attributes:k.slice(2).join(" ")}},k.writeExtmap=function(L){return"a=extmap:"+(L.id||L.preferredId)+(L.direction&&"sendrecv"!==L.direction?"/"+L.direction:"")+" "+L.uri+(L.attributes?" "+L.attributes:"")+"\r\n"},k.parseFmtp=function(L){let k;let M={},U=L.substring(L.indexOf(" ")+1).split(";");for(let L=0;L<U.length;L++)M[(k=U[L].trim().split("="))[0].trim()]=k[1];return M},k.writeFmtp=function(L){let k="",M=L.payloadType;if(void 0!==L.preferredPayloadType&&(M=L.preferredPayloadType),L.parameters&&Object.keys(L.parameters).length){let U=[];Object.keys(L.parameters).forEach(k=>{void 0!==L.parameters[k]?U.push(k+"="+L.parameters[k]):U.push(k)}),k+="a=fmtp:"+M+" "+U.join(";")+"\r\n"}return k},k.parseRtcpFb=function(L){let k=L.substring(L.indexOf(" ")+1).split(" ");return{type:k.shift(),parameter:k.join(" ")}},k.writeRtcpFb=function(L){let k="",M=L.payloadType;return void 0!==L.preferredPayloadType&&(M=L.preferredPayloadType),L.rtcpFeedback&&L.rtcpFeedback.length&&L.rtcpFeedback.forEach(L=>{k+="a=rtcp-fb:"+M+" "+L.type+(L.parameter&&L.parameter.length?" "+L.parameter:"")+"\r\n"}),k},k.parseSsrcMedia=function(L){let k=L.indexOf(" "),M={ssrc:parseInt(L.substring(7,k),10)},U=L.indexOf(":",k);return U>-1?(M.attribute=L.substring(k+1,U),M.value=L.substring(U+1)):M.attribute=L.substring(k+1),M},k.parseSsrcGroup=function(L){let k=L.substring(13).split(" ");return{semantics:k.shift(),ssrcs:k.map(L=>parseInt(L,10))}},k.getMid=function(L){let M=k.matchPrefix(L,"a=mid:")[0];if(M)return M.substring(6)},k.parseFingerprint=function(L){let k=L.substring(14).split(" ");return{algorithm:k[0].toLowerCase(),value:k[1].toUpperCase()}},k.getDtlsParameters=function(L,M){return{role:"auto",fingerprints:k.matchPrefix(L+M,"a=fingerprint:").map(k.parseFingerprint)}},k.writeDtlsParameters=function(L,k){let M="a=setup:"+k+"\r\n";return L.fingerprints.forEach(L=>{M+="a=fingerprint:"+L.algorithm+" "+L.value+"\r\n"}),M},k.parseCryptoLine=function(L){let k=L.substring(9).split(" ");return{tag:parseInt(k[0],10),cryptoSuite:k[1],keyParams:k[2],sessionParams:k.slice(3)}},k.writeCryptoLine=function(L){return"a=crypto:"+L.tag+" "+L.cryptoSuite+" "+("object"==typeof L.keyParams?k.writeCryptoKeyParams(L.keyParams):L.keyParams)+(L.sessionParams?" "+L.sessionParams.join(" "):"")+"\r\n"},k.parseCryptoKeyParams=function(L){if(0!==L.indexOf("inline:"))return null;let k=L.substring(7).split("|");return{keyMethod:"inline",keySalt:k[0],lifeTime:k[1],mkiValue:k[2]?k[2].split(":")[0]:void 0,mkiLength:k[2]?k[2].split(":")[1]:void 0}},k.writeCryptoKeyParams=function(L){return L.keyMethod+":"+L.keySalt+(L.lifeTime?"|"+L.lifeTime:"")+(L.mkiValue&&L.mkiLength?"|"+L.mkiValue+":"+L.mkiLength:"")},k.getCryptoParameters=function(L,M){return k.matchPrefix(L+M,"a=crypto:").map(k.parseCryptoLine)},k.getIceParameters=function(L,M){let U=k.matchPrefix(L+M,"a=ice-ufrag:")[0],V=k.matchPrefix(L+M,"a=ice-pwd:")[0];return U&&V?{usernameFragment:U.substring(12),password:V.substring(10)}:null},k.writeIceParameters=function(L){let k="a=ice-ufrag:"+L.usernameFragment+"\r\na=ice-pwd:"+L.password+"\r\n";return L.iceLite&&(k+="a=ice-lite\r\n"),k},k.parseRtpParameters=function(L){let M={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},U=k.splitLines(L)[0].split(" ");M.profile=U[2];for(let V=3;V<U.length;V++){let F=U[V],B=k.matchPrefix(L,"a=rtpmap:"+F+" ")[0];if(B){let U=k.parseRtpMap(B),V=k.matchPrefix(L,"a=fmtp:"+F+" ");switch(U.parameters=V.length?k.parseFmtp(V[0]):{},U.rtcpFeedback=k.matchPrefix(L,"a=rtcp-fb:"+F+" ").map(k.parseRtcpFb),M.codecs.push(U),U.name.toUpperCase()){case"RED":case"ULPFEC":M.fecMechanisms.push(U.name.toUpperCase())}}}k.matchPrefix(L,"a=extmap:").forEach(L=>{M.headerExtensions.push(k.parseExtmap(L))});let V=k.matchPrefix(L,"a=rtcp-fb:* ").map(k.parseRtcpFb);return M.codecs.forEach(L=>{V.forEach(k=>{L.rtcpFeedback.find(L=>L.type===k.type&&L.parameter===k.parameter)||L.rtcpFeedback.push(k)})}),M},k.writeRtpDescription=function(L,M){let U="";U+="m="+L+" "+(M.codecs.length>0?"9":"0")+" "+(M.profile||"UDP/TLS/RTP/SAVPF")+" "+M.codecs.map(L=>void 0!==L.preferredPayloadType?L.preferredPayloadType:L.payloadType).join(" ")+"\r\nc=IN IP4 localhost\r\na=rtcp:9 IN IP4 localhost\r\n",M.codecs.forEach(L=>{U+=k.writeRtpMap(L)+k.writeFmtp(L)+k.writeRtcpFb(L)});let V=0;return M.codecs.forEach(L=>{L.maxptime>V&&(V=L.maxptime)}),V>0&&(U+="a=maxptime:"+V+"\r\n"),M.headerExtensions&&M.headerExtensions.forEach(L=>{U+=k.writeExtmap(L)}),U},k.parseRtpEncodingParameters=function(L){let M;let U=[],V=k.parseRtpParameters(L),F=-1!==V.fecMechanisms.indexOf("RED"),B=-1!==V.fecMechanisms.indexOf("ULPFEC"),j=k.matchPrefix(L,"a=ssrc:").map(L=>k.parseSsrcMedia(L)).filter(L=>"cname"===L.attribute),G=j.length>0&&j[0].ssrc,X=k.matchPrefix(L,"a=ssrc-group:FID").map(L=>L.substring(17).split(" ").map(L=>parseInt(L,10)));X.length>0&&X[0].length>1&&X[0][0]===G&&(M=X[0][1]),V.codecs.forEach(L=>{if("RTX"===L.name.toUpperCase()&&L.parameters.apt){let k={ssrc:G,codecPayloadType:parseInt(L.parameters.apt,10)};G&&M&&(k.rtx={ssrc:M}),U.push(k),F&&((k=JSON.parse(JSON.stringify(k))).fec={ssrc:G,mechanism:B?"red+ulpfec":"red"},U.push(k))}}),0===U.length&&G&&U.push({ssrc:G});let $=k.matchPrefix(L,"b=");return $.length&&($=0===$[0].indexOf("b=TIAS:")?parseInt($[0].substring(7),10):0===$[0].indexOf("b=AS:")?1e3*parseInt($[0].substring(5),10)*.95-16e3:void 0,U.forEach(L=>{L.maxBitrate=$})),U},k.parseRtcpParameters=function(L){let M={},U=k.matchPrefix(L,"a=ssrc:").map(L=>k.parseSsrcMedia(L)).filter(L=>"cname"===L.attribute)[0];U&&(M.cname=U.value,M.ssrc=U.ssrc);let V=k.matchPrefix(L,"a=rtcp-rsize");M.reducedSize=V.length>0,M.compound=0===V.length;let F=k.matchPrefix(L,"a=rtcp-mux");return M.mux=F.length>0,M},k.writeRtcpParameters=function(L){let k="";return L.reducedSize&&(k+="a=rtcp-rsize\r\n"),L.mux&&(k+="a=rtcp-mux\r\n"),void 0!==L.ssrc&&L.cname&&(k+="a=ssrc:"+L.ssrc+" cname:"+L.cname+"\r\n"),k},k.parseMsid=function(L){let M;let U=k.matchPrefix(L,"a=msid:");if(1===U.length)return{stream:(M=U[0].substring(7).split(" "))[0],track:M[1]};let V=k.matchPrefix(L,"a=ssrc:").map(L=>k.parseSsrcMedia(L)).filter(L=>"msid"===L.attribute);return V.length>0?{stream:(M=V[0].value.split(" "))[0],track:M[1]}:void 0},k.parseSctpDescription=function(L){let M;let U=k.parseMLine(L),V=k.matchPrefix(L,"a=max-message-size:");V.length>0&&(M=parseInt(V[0].substring(19),10)),isNaN(M)&&(M=65536);let F=k.matchPrefix(L,"a=sctp-port:");if(F.length>0)return{port:parseInt(F[0].substring(12),10),protocol:U.fmt,maxMessageSize:M};let B=k.matchPrefix(L,"a=sctpmap:");if(B.length>0){let L=B[0].substring(10).split(" ");return{port:parseInt(L[0],10),protocol:L[1],maxMessageSize:M}}},k.writeSctpDescription=function(L,k){let M=[];return M="DTLS/SCTP"!==L.protocol?["m="+L.kind+" 9 "+L.protocol+" "+k.protocol+"\r\n","c=IN IP4 localhost\r\n","a=sctp-port:"+k.port+"\r\n"]:["m="+L.kind+" 9 "+L.protocol+" "+k.port+"\r\n","c=IN IP4 localhost\r\n","a=sctpmap:"+k.port+" "+k.protocol+" 65535\r\n"],void 0!==k.maxMessageSize&&M.push("a=max-message-size:"+k.maxMessageSize+"\r\n"),M.join("")},k.generateSessionId=function(){return Math.random().toString().substr(2,22)},k.writeSessionBoilerplate=function(L,M,U){return"v=0\r\no="+(U||"thisisadapterortc")+" "+(L||k.generateSessionId())+" "+(void 0!==M?M:2)+" IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n"},k.getDirection=function(L,M){let U=k.splitLines(L);for(let L=0;L<U.length;L++)switch(U[L]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return U[L].substring(2)}return M?k.getDirection(M):"sendrecv"},k.getKind=function(L){return k.splitLines(L)[0].split(" ")[0].substring(2)},k.isRejected=function(L){return"0"===L.split(" ",2)[1]},k.parseMLine=function(L){let M=k.splitLines(L)[0].substring(2).split(" ");return{kind:M[0],port:parseInt(M[1],10),protocol:M[2],fmt:M.slice(3).join(" ")}},k.parseOLine=function(L){let M=k.matchPrefix(L,"o=")[0].substring(2).split(" ");return{username:M[0],sessionId:M[1],sessionVersion:parseInt(M[2],10),netType:M[3],addressType:M[4],address:M[5]}},k.isValidSDP=function(L){if("string"!=typeof L||0===L.length)return!1;let M=k.splitLines(L);for(let L=0;L<M.length;L++)if(M[L].length<2||"="!==M[L].charAt(1))return!1;return!0},L.exports=k}(__);var _E=__.exports,_m=i(_E);function Vg(L){if(!L.RTCIceCandidate||L.RTCIceCandidate&&"foundation"in L.RTCIceCandidate.prototype)return;let k=L.RTCIceCandidate;L.RTCIceCandidate=function(L){if("object"==typeof L&&L.candidate&&0===L.candidate.indexOf("a=")&&((L=JSON.parse(JSON.stringify(L))).candidate=L.candidate.substr(2)),L.candidate&&L.candidate.length){let M=new k(L),U=_m.parseCandidate(L.candidate),V=Object.assign(M,U);return V.toJSON=function(){return{candidate:V.candidate,sdpMid:V.sdpMid,sdpMLineIndex:V.sdpMLineIndex,usernameFragment:V.usernameFragment}},V}return new k(L)},L.RTCIceCandidate.prototype=k.prototype,IS(L,"icecandidate",k=>(k.candidate&&Object.defineProperty(k,"candidate",{value:new L.RTCIceCandidate(k.candidate),writable:"false"}),k))}function xg(L){!L.RTCIceCandidate||L.RTCIceCandidate&&"relayProtocol"in L.RTCIceCandidate.prototype||IS(L,"icecandidate",L=>{if(L.candidate){let k=_m.parseCandidate(L.candidate.candidate);"relay"===k.type&&(L.candidate.relayProtocol=({0:"tls",1:"tcp",2:"udp"})[k.priority>>24])}return L})}function Fg(L,k){if(!L.RTCPeerConnection)return;"sctp"in L.RTCPeerConnection.prototype||Object.defineProperty(L.RTCPeerConnection.prototype,"sctp",{get(){return void 0===this._sctp?null:this._sctp}});let i=function(L){if(!L||!L.sdp)return!1;let k=_m.splitSections(L.sdp);return k.shift(),k.some(L=>{let k=_m.parseMLine(L);return k&&"application"===k.kind&&-1!==k.protocol.indexOf("SCTP")})},n=function(L){let k=L.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(null===k||k.length<2)return -1;let M=parseInt(k[1],10);return M!=M?-1:M},r=function(L){let M=65536;return"firefox"===k.browser&&(M=k.version<57?-1===L?16384:2147483637:k.version<60?57===k.version?65535:65536:2147483637),M},o=function(L,M){let U=65536;"firefox"===k.browser&&57===k.version&&(U=65535);let V=_m.matchPrefix(L.sdp,"a=max-message-size:");return V.length>0?U=parseInt(V[0].substr(19),10):"firefox"===k.browser&&-1!==M&&(U=2147483637),U},M=L.RTCPeerConnection.prototype.setRemoteDescription;L.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,"chrome"===k.browser&&k.version>=76){let{sdpSemantics:L}=this.getConfiguration();"plan-b"===L&&Object.defineProperty(this,"sctp",{get(){return void 0===this._sctp?null:this._sctp},enumerable:!0,configurable:!0})}if(i(arguments[0])){let L;let k=n(arguments[0]),M=r(k),U=o(arguments[0],k);L=0===M&&0===U?Number.POSITIVE_INFINITY:0===M||0===U?Math.max(M,U):Math.min(M,U);let V={};Object.defineProperty(V,"maxMessageSize",{get:()=>L}),this._sctp=V}return M.apply(this,arguments)}}function Bg(L){if(!L.RTCPeerConnection||!("createDataChannel"in L.RTCPeerConnection.prototype))return;function t(L,k){let M=L.send;L.send=function(){let U=arguments[0],V=U.length||U.size||U.byteLength;if("open"===L.readyState&&k.sctp&&V>k.sctp.maxMessageSize)throw TypeError("Message too large (can send a maximum of "+k.sctp.maxMessageSize+" bytes)");return M.apply(L,arguments)}}let k=L.RTCPeerConnection.prototype.createDataChannel;L.RTCPeerConnection.prototype.createDataChannel=function(){let L=k.apply(this,arguments);return t(L,this),L},IS(L,"datachannel",L=>(t(L.channel,L.target),L))}function jg(L){if(!L.RTCPeerConnection||"connectionState"in L.RTCPeerConnection.prototype)return;let k=L.RTCPeerConnection.prototype;Object.defineProperty(k,"connectionState",{get(){return({completed:"connected",checking:"connecting"})[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(k,"onconnectionstatechange",{get(){return this._onconnectionstatechange||null},set(L){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),L&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=L)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach(L=>{let M=k[L];k[L]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=L=>{let k=L.target;if(k._lastConnectionState!==k.connectionState){k._lastConnectionState=k.connectionState;let M=new Event("connectionstatechange",L);k.dispatchEvent(M)}return L},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),M.apply(this,arguments)}})}function Gg(L,k){if(!L.RTCPeerConnection||"chrome"===k.browser&&k.version>=71||"safari"===k.browser&&k.version>=605)return;let M=L.RTCPeerConnection.prototype.setRemoteDescription;L.RTCPeerConnection.prototype.setRemoteDescription=function(k){if(k&&k.sdp&&-1!==k.sdp.indexOf("\na=extmap-allow-mixed")){let M=k.sdp.split("\n").filter(L=>"a=extmap-allow-mixed"!==_p(L).call(L)).join("\n");L.RTCSessionDescription&&k instanceof L.RTCSessionDescription?arguments[0]=new L.RTCSessionDescription({type:k.type,sdp:M}):k.sdp=M}return M.apply(this,arguments)}}function Wg(L,k){if(!L.RTCPeerConnection||!L.RTCPeerConnection.prototype)return;let M=L.RTCPeerConnection.prototype.addIceCandidate;M&&0!==M.length&&(L.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?("chrome"===k.browser&&k.version<78||"firefox"===k.browser&&k.version<68||"safari"===k.browser)&&arguments[0]&&""===arguments[0].candidate?lQ.resolve():M.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),lQ.resolve())})}function Hg(L,k){if(!L.RTCPeerConnection||!L.RTCPeerConnection.prototype)return;let M=L.RTCPeerConnection.prototype.setLocalDescription;M&&0!==M.length&&(L.RTCPeerConnection.prototype.setLocalDescription=function(){let L=arguments[0]||{};if("object"!=typeof L||L.type&&L.sdp)return M.apply(this,arguments);if(!(L={type:L.type,sdp:L.sdp}).type)switch(this.signalingState){case"stable":case"have-local-offer":case"have-remote-pranswer":L.type="offer";break;default:L.type="answer"}return L.sdp||"offer"!==L.type&&"answer"!==L.type?M.apply(this,[L]):("offer"===L.type?this.createOffer:this.createAnswer).apply(this).then(L=>M.apply(this,[L]))})}e({__proto__:null,default:_m},[_E]),Object.freeze({__proto__:null,removeExtmapAllowMixed:Gg,shimAddIceCandidateNullOrEmpty:Wg,shimConnectionState:jg,shimMaxMessageSize:Fg,shimParameterlessSetLocalDescription:Hg,shimRTCIceCandidate:Vg,shimRTCIceCandidateRelayProtocol:xg,shimSendThrowTypeError:Bg}),function(){let{window:L}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},k=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{shimChrome:!0,shimFirefox:!0,shimSafari:!0},M=wS,U=function(L){let k={browser:null,version:null};if(void 0===L||!L.navigator)return k.browser="Not a browser.",k;let{navigator:M}=L;if(M.mozGetUserMedia)k.browser="firefox",k.version=yS(M.userAgent,/Firefox\/(\d+)\./,1);else if(M.webkitGetUserMedia||!1===L.isSecureContext&&L.webkitRTCPeerConnection)k.browser="chrome",k.version=yS(M.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else{if(!L.RTCPeerConnection||!M.userAgent.match(/AppleWebKit\/(\d+)\./))return k.browser="Not a supported browser.",k;k.browser="safari",k.version=yS(M.userAgent,/AppleWebKit\/(\d+)\./,1),k.supportsUnifiedPlan=L.RTCRtpTransceiver&&"currentDirection"in L.RTCRtpTransceiver.prototype}return k}(L),V={};switch(U.browser){case"chrome":if(!_t||!WS||!k.shimChrome)return M("Chrome shim is not included in this adapter release.");if(null===U.version)return M("Chrome shim can not determine version, not shimming.");M("adapter.js shimming chrome."),V.browserShim=_t,Wg(L,U),Hg(L),MS(L,U),US(L),WS(L,U),VS(L),GS(L,U),xS(L),FS(L),BS(L),HS(L,U),Vg(L),xg(L),jg(L),Fg(L,U),Bg(L),Gg(L,U);break;case"firefox":if(!_i||!qS||!k.shimFirefox)return M("Firefox shim is not included in this adapter release.");M("adapter.js shimming firefox."),V.browserShim=_i,Wg(L,U),Hg(L),YS(L,U),qS(L,U),zS(L),ZS(L),XS(L),JS(L),QS(L),$S(L),eg(L),tg(L),ig(L),Vg(L),jg(L),Fg(L,U),Bg(L);break;case"safari":if(!_r||!k.shimSafari)return M("Safari shim is not included in this adapter release.");M("adapter.js shimming safari."),V.browserShim=_r,Wg(L,U),Hg(L),dg(L),ug(L),sg(L),rg(L),og(L),lg(L),ag(L),hg(L),Vg(L),xg(L),Fg(L,U),Bg(L),Gg(L,U);break;default:M("Unsupported browser!")}}({window:"undefined"==typeof window?void 0:window}),Oi({global:!0,forced:au.globalThis!==au},{globalThis:au});var _f=i(au),_S={exports:{}};G=_S.exports,function(L,k){var M="function",U="undefined",V="object",F="string",B="major",j="model",X="name",$="type",ee="vendor",et="version",ei="architecture",er="console",en="mobile",ea="tablet",eo="smarttv",es="wearable",ec="embedded",ed="Amazon",el="Apple",eu="ASUS",eh="BlackBerry",ep="Browser",e_="Chrome",eE="Firefox",em="Google",ef="Huawei",eS="Microsoft",eT="Motorola",eR="Opera",eI="Samsung",ev="Sharp",eC="Sony",ey="Xiaomi",eb="Zebra",eN="Facebook",eP="Chromium OS",eL="Mac OS",ek=" Browser",W=function(L){for(var k={},M=0;M<L.length;M++)k[L[M].toUpperCase()]=L[M];return k},H=function(L,k){return typeof L===F&&-1!==K(k).indexOf(K(L))},K=function(L){return L.toLowerCase()},Y=function(L,k){if(typeof L===F)return L=L.replace(/^\s\s*/,""),typeof k===U?L:L.substring(0,500)},z=function(L,U){for(var F,B,j,G,X,$,ee=0;ee<U.length&&!X;){var et=U[ee],ei=U[ee+1];for(F=B=0;F<et.length&&!X&&et[F];)if(X=et[F++].exec(L))for(j=0;j<ei.length;j++)$=X[++B],typeof(G=ei[j])===V&&G.length>0?2===G.length?typeof G[1]==M?this[G[0]]=G[1].call(this,$):this[G[0]]=G[1]:3===G.length?typeof G[1]!==M||G[1].exec&&G[1].test?this[G[0]]=$?$.replace(G[1],G[2]):k:this[G[0]]=$?G[1].call(this,$,G[2]):k:4===G.length&&(this[G[0]]=$?G[3].call(this,$.replace(G[1],G[2])):k):this[G]=$||k;ee+=2}},q=function(L,M){for(var U in M)if(typeof M[U]===V&&M[U].length>0){for(var F=0;F<M[U].length;F++)if(H(M[U][F],L))return"?"===U?k:U}else if(H(M[U],L))return"?"===U?k:U;return M.hasOwnProperty("*")?M["*"]:L},eU={ME:"4.90","NT 3.11":"NT3.51","NT 4.0":"NT4.0",2e3:"NT 5.0",XP:["NT 5.1","NT 5.2"],Vista:"NT 6.0",7:"NT 6.1",8:"NT 6.2",8.1:"NT 6.3",10:["NT 6.4","NT 10.0"],RT:"ARM"},eV={browser:[[/\b(?:crmo|crios)\/([\w\.]+)/i],[et,[X,"Chrome"]],[/edg(?:e|ios|a)?\/([\w\.]+)/i],[et,[X,"Edge"]],[/(opera mini)\/([-\w\.]+)/i,/(opera [mobiletab]{3,6})\b.+version\/([-\w\.]+)/i,/(opera)(?:.+version\/|[\/ ]+)([\w\.]+)/i],[X,et],[/opios[\/ ]+([\w\.]+)/i],[et,[X,eR+" Mini"]],[/\bop(?:rg)?x\/([\w\.]+)/i],[et,[X,eR+" GX"]],[/\bopr\/([\w\.]+)/i],[et,[X,eR]],[/\bb[ai]*d(?:uhd|[ub]*[aekoprswx]{5,6})[\/ ]?([\w\.]+)/i],[et,[X,"Baidu"]],[/\b(?:mxbrowser|mxios|myie2)\/?([-\w\.]*)\b/i],[et,[X,"Maxthon"]],[/(kindle)\/([\w\.]+)/i,/(lunascape|maxthon|netfront|jasmine|blazer|sleipnir)[\/ ]?([\w\.]*)/i,/(avant|iemobile|slim(?:browser|boat|jet))[\/ ]?([\d\.]*)/i,/(?:ms|\()(ie) ([\w\.]+)/i,/(flock|rockmelt|midori|epiphany|silk|skyfire|ovibrowser|bolt|iron|vivaldi|iridium|phantomjs|bowser|qupzilla|falkon|rekonq|puffin|brave|whale(?!.+naver)|qqbrowserlite|duckduckgo|klar|helio|(?=comodo_)?dragon)\/([-\w\.]+)/i,/(heytap|ovi|115)browser\/([\d\.]+)/i,/(weibo)__([\d\.]+)/i],[X,et],[/quark(?:pc)?\/([-\w\.]+)/i],[et,[X,"Quark"]],[/\bddg\/([\w\.]+)/i],[et,[X,"DuckDuckGo"]],[/(?:\buc? ?browser|(?:juc.+)ucweb)[\/ ]?([\w\.]+)/i],[et,[X,"UC"+ep]],[/microm.+\bqbcore\/([\w\.]+)/i,/\bqbcore\/([\w\.]+).+microm/i,/micromessenger\/([\w\.]+)/i],[et,[X,"WeChat"]],[/konqueror\/([\w\.]+)/i],[et,[X,"Konqueror"]],[/trident.+rv[: ]([\w\.]{1,9})\b.+like gecko/i],[et,[X,"IE"]],[/ya(?:search)?browser\/([\w\.]+)/i],[et,[X,"Yandex"]],[/slbrowser\/([\w\.]+)/i],[et,[X,"Smart Lenovo "+ep]],[/(avast|avg)\/([\w\.]+)/i],[[X,/(.+)/,"$1 Secure "+ep],et],[/\bfocus\/([\w\.]+)/i],[et,[X,eE+" Focus"]],[/\bopt\/([\w\.]+)/i],[et,[X,eR+" Touch"]],[/coc_coc\w+\/([\w\.]+)/i],[et,[X,"Coc Coc"]],[/dolfin\/([\w\.]+)/i],[et,[X,"Dolphin"]],[/coast\/([\w\.]+)/i],[et,[X,eR+" Coast"]],[/miuibrowser\/([\w\.]+)/i],[et,[X,"MIUI"+ek]],[/fxios\/([\w\.-]+)/i],[et,[X,eE]],[/\bqihoobrowser\/?([\w\.]*)/i],[et,[X,"360"]],[/\b(qq)\/([\w\.]+)/i],[[X,/(.+)/,"$1Browser"],et],[/(oculus|sailfish|huawei|vivo|pico)browser\/([\w\.]+)/i],[[X,/(.+)/,"$1"+ek],et],[/samsungbrowser\/([\w\.]+)/i],[et,[X,eI+" Internet"]],[/metasr[\/ ]?([\d\.]+)/i],[et,[X,"Sogou Explorer"]],[/(sogou)mo\w+\/([\d\.]+)/i],[[X,"Sogou Mobile"],et],[/(electron)\/([\w\.]+) safari/i,/(tesla)(?: qtcarbrowser|\/(20\d\d\.[-\w\.]+))/i,/m?(qqbrowser|2345(?=browser|chrome|explorer))\w*[\/ ]?v?([\w\.]+)/i],[X,et],[/(lbbrowser|rekonq)/i,/\[(linkedin)app\]/i],[X],[/ome\/([\w\.]+) \w* ?(iron) saf/i,/ome\/([\w\.]+).+qihu (360)[es]e/i],[et,X],[/((?:fban\/fbios|fb_iab\/fb4a)(?!.+fbav)|;fbav\/([\w\.]+);)/i],[[X,eN],et],[/(Klarna)\/([\w\.]+)/i,/(kakao(?:talk|story))[\/ ]([\w\.]+)/i,/(naver)\(.*?(\d+\.[\w\.]+).*\)/i,/safari (line)\/([\w\.]+)/i,/\b(line)\/([\w\.]+)\/iab/i,/(alipay)client\/([\w\.]+)/i,/(twitter)(?:and| f.+e\/([\w\.]+))/i,/(chromium|instagram|snapchat)[\/ ]([-\w\.]+)/i],[X,et],[/\bgsa\/([\w\.]+) .*safari\//i],[et,[X,"GSA"]],[/musical_ly(?:.+app_?version\/|_)([\w\.]+)/i],[et,[X,"TikTok"]],[/headlesschrome(?:\/([\w\.]+)| )/i],[et,[X,e_+" Headless"]],[/ wv\).+(chrome)\/([\w\.]+)/i],[[X,e_+" WebView"],et],[/droid.+ version\/([\w\.]+)\b.+(?:mobile safari|safari)/i],[et,[X,"Android "+ep]],[/(chrome|omniweb|arora|[tizenoka]{5} ?browser)\/v?([\w\.]+)/i],[X,et],[/version\/([\w\.\,]+) .*mobile\/\w+ (safari)/i],[et,[X,"Mobile Safari"]],[/version\/([\w(\.|\,)]+) .*(mobile ?safari|safari)/i],[et,X],[/webkit.+?(mobile ?safari|safari)(\/[\w\.]+)/i],[X,[et,q,{"1.0":"/8",1.2:"/1",1.3:"/3","2.0":"/412","2.0.2":"/416","2.0.3":"/417","2.0.4":"/419","?":"/"}]],[/(webkit|khtml)\/([\w\.]+)/i],[X,et],[/(navigator|netscape\d?)\/([-\w\.]+)/i],[[X,"Netscape"],et],[/(wolvic|librewolf)\/([\w\.]+)/i],[X,et],[/mobile vr; rv:([\w\.]+)\).+firefox/i],[et,[X,eE+" Reality"]],[/ekiohf.+(flow)\/([\w\.]+)/i,/(swiftfox)/i,/(icedragon|iceweasel|camino|chimera|fennec|maemo browser|minimo|conkeror)[\/ ]?([\w\.\+]+)/i,/(seamonkey|k-meleon|icecat|iceape|firebird|phoenix|palemoon|basilisk|waterfox)\/([-\w\.]+)$/i,/(firefox)\/([\w\.]+)/i,/(mozilla)\/([\w\.]+) .+rv\:.+gecko\/\d+/i,/(polaris|lynx|dillo|icab|doris|amaya|w3m|netsurf|obigo|mosaic|(?:go|ice|up)[\. ]?browser)[-\/ ]?v?([\w\.]+)/i,/(links) \(([\w\.]+)/i],[X,[et,/_/g,"."]],[/(cobalt)\/([\w\.]+)/i],[X,[et,/master.|lts./,""]]],cpu:[[/(?:(amd|x(?:(?:86|64)[-_])?|wow|win)64)[;\)]/i],[[ei,"amd64"]],[/(ia32(?=;))/i],[[ei,K]],[/((?:i[346]|x)86)[;\)]/i],[[ei,"ia32"]],[/\b(aarch64|arm(v?8e?l?|_?64))\b/i],[[ei,"arm64"]],[/\b(arm(?:v[67])?ht?n?[fl]p?)\b/i],[[ei,"armhf"]],[/windows (ce|mobile); ppc;/i],[[ei,"arm"]],[/((?:ppc|powerpc)(?:64)?)(?: mac|;|\))/i],[[ei,/ower/,"",K]],[/(sun4\w)[;\)]/i],[[ei,"sparc"]],[/((?:avr32|ia64(?=;))|68k(?=\))|\barm(?=v(?:[1-7]|[5-7]1)l?|;|eabi)|(?=atmel )avr|(?:irix|mips|sparc)(?:64)?\b|pa-risc)/i],[[ei,K]]],device:[[/\b(sch-i[89]0\d|shw-m380s|sm-[ptx]\w{2,4}|gt-[pn]\d{2,4}|sgh-t8[56]9|nexus 10)/i],[j,[ee,eI],[$,ea]],[/\b((?:s[cgp]h|gt|sm)-(?![lr])\w+|sc[g-]?[\d]+a?|galaxy nexus)/i,/samsung[- ]((?!sm-[lr])[-\w]+)/i,/sec-(sgh\w+)/i],[j,[ee,eI],[$,en]],[/(?:\/|\()(ip(?:hone|od)[\w, ]*)(?:\/|;)/i],[j,[ee,el],[$,en]],[/\((ipad);[-\w\),; ]+apple/i,/applecoremedia\/[\w\.]+ \((ipad)/i,/\b(ipad)\d\d?,\d\d?[;\]].+ios/i],[j,[ee,el],[$,ea]],[/(macintosh);/i],[j,[ee,el]],[/\b(sh-?[altvz]?\d\d[a-ekm]?)/i],[j,[ee,ev],[$,en]],[/(?:honor)([-\w ]+)[;\)]/i],[j,[ee,"Honor"],[$,en]],[/\b((?:ag[rs][23]?|bah2?|sht?|btv)-a?[lw]\d{2})\b(?!.+d\/s)/i],[j,[ee,ef],[$,ea]],[/(?:huawei)([-\w ]+)[;\)]/i,/\b(nexus 6p|\w{2,4}e?-[atu]?[ln][\dx][012359c][adn]?)\b(?!.+d\/s)/i],[j,[ee,ef],[$,en]],[/\b(poco[\w ]+|m2\d{3}j\d\d[a-z]{2})(?: bui|\))/i,/\b; (\w+) build\/hm\1/i,/\b(hm[-_ ]?note?[_ ]?(?:\d\w)?) bui/i,/\b(redmi[\-_ ]?(?:note|k)?[\w_ ]+)(?: bui|\))/i,/oid[^\)]+; (m?[12][0-389][01]\w{3,6}[c-y])( bui|; wv|\))/i,/\b(mi[-_ ]?(?:a\d|one|one[_ ]plus|note lte|max|cc)?[_ ]?(?:\d?\w?)[_ ]?(?:plus|se|lite|pro)?)(?: bui|\))/i],[[j,/_/g," "],[ee,ey],[$,en]],[/oid[^\)]+; (2\d{4}(283|rpbf)[cgl])( bui|\))/i,/\b(mi[-_ ]?(?:pad)(?:[\w_ ]+))(?: bui|\))/i],[[j,/_/g," "],[ee,ey],[$,ea]],[/; (\w+) bui.+ oppo/i,/\b(cph[12]\d{3}|p(?:af|c[al]|d\w|e[ar])[mt]\d0|x9007|a101op)\b/i],[j,[ee,"OPPO"],[$,en]],[/\b(opd2\d{3}a?) bui/i],[j,[ee,"OPPO"],[$,ea]],[/vivo (\w+)(?: bui|\))/i,/\b(v[12]\d{3}\w?[at])(?: bui|;)/i],[j,[ee,"Vivo"],[$,en]],[/\b(rmx[1-3]\d{3})(?: bui|;|\))/i],[j,[ee,"Realme"],[$,en]],[/\b(milestone|droid(?:[2-4x]| (?:bionic|x2|pro|razr))?:?( 4g)?)\b[\w ]+build\//i,/\bmot(?:orola)?[- ](\w*)/i,/((?:moto[\w\(\) ]+|xt\d{3,4}|nexus 6)(?= bui|\)))/i],[j,[ee,eT],[$,en]],[/\b(mz60\d|xoom[2 ]{0,2}) build\//i],[j,[ee,eT],[$,ea]],[/((?=lg)?[vl]k\-?\d{3}) bui| 3\.[-\w; ]{10}lg?-([06cv9]{3,4})/i],[j,[ee,"LG"],[$,ea]],[/(lm(?:-?f100[nv]?|-[\w\.]+)(?= bui|\))|nexus [45])/i,/\blg[-e;\/ ]+((?!browser|netcast|android tv)\w+)/i,/\blg-?([\d\w]+) bui/i],[j,[ee,"LG"],[$,en]],[/(ideatab[-\w ]+)/i,/lenovo ?(s[56]000[-\w]+|tab(?:[\w ]+)|yt[-\d\w]{6}|tb[-\d\w]{6})/i],[j,[ee,"Lenovo"],[$,ea]],[/(?:maemo|nokia).*(n900|lumia \d+)/i,/nokia[-_ ]?([-\w\.]*)/i],[[j,/_/g," "],[ee,"Nokia"],[$,en]],[/(pixel c)\b/i],[j,[ee,em],[$,ea]],[/droid.+; (pixel[\daxl ]{0,6})(?: bui|\))/i],[j,[ee,em],[$,en]],[/droid.+; (a?\d[0-2]{2}so|[c-g]\d{4}|so[-gl]\w+|xq-a\w[4-7][12])(?= bui|\).+chrome\/(?![1-6]{0,1}\d\.))/i],[j,[ee,eC],[$,en]],[/sony tablet [ps]/i,/\b(?:sony)?sgp\w+(?: bui|\))/i],[[j,"Xperia Tablet"],[ee,eC],[$,ea]],[/ (kb2005|in20[12]5|be20[12][59])\b/i,/(?:one)?(?:plus)? (a\d0\d\d)(?: b|\))/i],[j,[ee,"OnePlus"],[$,en]],[/(alexa)webm/i,/(kf[a-z]{2}wi|aeo(?!bc)\w\w)( bui|\))/i,/(kf[a-z]+)( bui|\)).+silk\//i],[j,[ee,ed],[$,ea]],[/((?:sd|kf)[0349hijorstuw]+)( bui|\)).+silk\//i],[[j,/(.+)/g,"Fire Phone $1"],[ee,ed],[$,en]],[/(playbook);[-\w\),; ]+(rim)/i],[j,ee,[$,ea]],[/\b((?:bb[a-f]|st[hv])100-\d)/i,/\(bb10; (\w+)/i],[j,[ee,eh],[$,en]],[/(?:\b|asus_)(transfo[prime ]{4,10} \w+|eeepc|slider \w+|nexus 7|padfone|p00[cj])/i],[j,[ee,eu],[$,ea]],[/ (z[bes]6[027][012][km][ls]|zenfone \d\w?)\b/i],[j,[ee,eu],[$,en]],[/(nexus 9)/i],[j,[ee,"HTC"],[$,ea]],[/(htc)[-;_ ]{1,2}([\w ]+(?=\)| bui)|\w+)/i,/(zte)[- ]([\w ]+?)(?: bui|\/|\))/i,/(alcatel|geeksphone|nexian|panasonic(?!(?:;|\.))|sony(?!-bra))[-_ ]?([-\w]*)/i],[ee,[j,/_/g," "],[$,en]],[/droid [\w\.]+; ((?:8[14]9[16]|9(?:0(?:48|60|8[01])|1(?:3[27]|66)|2(?:6[69]|9[56])|466))[gqswx])\w*(\)| bui)/i],[j,[ee,"TCL"],[$,ea]],[/(itel) ((\w+))/i],[[ee,K],j,[$,q,{tablet:["p10001l","w7001"],"*":"mobile"}]],[/droid.+; ([ab][1-7]-?[0178a]\d\d?)/i],[j,[ee,"Acer"],[$,ea]],[/droid.+; (m[1-5] note) bui/i,/\bmz-([-\w]{2,})/i],[j,[ee,"Meizu"],[$,en]],[/; ((?:power )?armor(?:[\w ]{0,8}))(?: bui|\))/i],[j,[ee,"Ulefone"],[$,en]],[/; (energy ?\w+)(?: bui|\))/i,/; energizer ([\w ]+)(?: bui|\))/i],[j,[ee,"Energizer"],[$,en]],[/; cat (b35);/i,/; (b15q?|s22 flip|s48c|s62 pro)(?: bui|\))/i],[j,[ee,"Cat"],[$,en]],[/((?:new )?andromax[\w- ]+)(?: bui|\))/i],[j,[ee,"Smartfren"],[$,en]],[/droid.+; (a(?:015|06[35]|142p?))/i],[j,[ee,"Nothing"],[$,en]],[/(blackberry|benq|palm(?=\-)|sonyericsson|acer|asus|dell|meizu|motorola|polytron|infinix|tecno|micromax|advan)[-_ ]?([-\w]*)/i,/; (imo) ((?!tab)[\w ]+?)(?: bui|\))/i,/(hp) ([\w ]+\w)/i,/(asus)-?(\w+)/i,/(microsoft); (lumia[\w ]+)/i,/(lenovo)[-_ ]?([-\w]+)/i,/(jolla)/i,/(oppo) ?([\w ]+) bui/i],[ee,j,[$,en]],[/(imo) (tab \w+)/i,/(kobo)\s(ereader|touch)/i,/(archos) (gamepad2?)/i,/(hp).+(touchpad(?!.+tablet)|tablet)/i,/(kindle)\/([\w\.]+)/i,/(nook)[\w ]+build\/(\w+)/i,/(dell) (strea[kpr\d ]*[\dko])/i,/(le[- ]+pan)[- ]+(\w{1,9}) bui/i,/(trinity)[- ]*(t\d{3}) bui/i,/(gigaset)[- ]+(q\w{1,9}) bui/i,/(vodafone) ([\w ]+)(?:\)| bui)/i],[ee,j,[$,ea]],[/(surface duo)/i],[j,[ee,eS],[$,ea]],[/droid [\d\.]+; (fp\du?)(?: b|\))/i],[j,[ee,"Fairphone"],[$,en]],[/(u304aa)/i],[j,[ee,"AT&T"],[$,en]],[/\bsie-(\w*)/i],[j,[ee,"Siemens"],[$,en]],[/\b(rct\w+) b/i],[j,[ee,"RCA"],[$,ea]],[/\b(venue[\d ]{2,7}) b/i],[j,[ee,"Dell"],[$,ea]],[/\b(q(?:mv|ta)\w+) b/i],[j,[ee,"Verizon"],[$,ea]],[/\b(?:barnes[& ]+noble |bn[rt])([\w\+ ]*) b/i],[j,[ee,"Barnes & Noble"],[$,ea]],[/\b(tm\d{3}\w+) b/i],[j,[ee,"NuVision"],[$,ea]],[/\b(k88) b/i],[j,[ee,"ZTE"],[$,ea]],[/\b(nx\d{3}j) b/i],[j,[ee,"ZTE"],[$,en]],[/\b(gen\d{3}) b.+49h/i],[j,[ee,"Swiss"],[$,en]],[/\b(zur\d{3}) b/i],[j,[ee,"Swiss"],[$,ea]],[/\b((zeki)?tb.*\b) b/i],[j,[ee,"Zeki"],[$,ea]],[/\b([yr]\d{2}) b/i,/\b(dragon[- ]+touch |dt)(\w{5}) b/i],[[ee,"Dragon Touch"],j,[$,ea]],[/\b(ns-?\w{0,9}) b/i],[j,[ee,"Insignia"],[$,ea]],[/\b((nxa|next)-?\w{0,9}) b/i],[j,[ee,"NextBook"],[$,ea]],[/\b(xtreme\_)?(v(1[045]|2[015]|[3469]0|7[05])) b/i],[[ee,"Voice"],j,[$,en]],[/\b(lvtel\-)?(v1[12]) b/i],[[ee,"LvTel"],j,[$,en]],[/\b(ph-1) /i],[j,[ee,"Essential"],[$,en]],[/\b(v(100md|700na|7011|917g).*\b) b/i],[j,[ee,"Envizen"],[$,ea]],[/\b(trio[-\w\. ]+) b/i],[j,[ee,"MachSpeed"],[$,ea]],[/\btu_(1491) b/i],[j,[ee,"Rotor"],[$,ea]],[/(shield[\w ]+) b/i],[j,[ee,"Nvidia"],[$,ea]],[/(sprint) (\w+)/i],[ee,j,[$,en]],[/(kin\.[onetw]{3})/i],[[j,/\./g," "],[ee,eS],[$,en]],[/droid.+; (cc6666?|et5[16]|mc[239][23]x?|vc8[03]x?)\)/i],[j,[ee,eb],[$,ea]],[/droid.+; (ec30|ps20|tc[2-8]\d[kx])\)/i],[j,[ee,eb],[$,en]],[/smart-tv.+(samsung)/i],[ee,[$,eo]],[/hbbtv.+maple;(\d+)/i],[[j,/^/,"SmartTV"],[ee,eI],[$,eo]],[/(nux; netcast.+smarttv|lg (netcast\.tv-201\d|android tv))/i],[[ee,"LG"],[$,eo]],[/(apple) ?tv/i],[ee,[j,el+" TV"],[$,eo]],[/crkey/i],[[j,e_+"cast"],[ee,em],[$,eo]],[/droid.+aft(\w+)( bui|\))/i],[j,[ee,ed],[$,eo]],[/\(dtv[\);].+(aquos)/i,/(aquos-tv[\w ]+)\)/i],[j,[ee,ev],[$,eo]],[/(bravia[\w ]+)( bui|\))/i],[j,[ee,eC],[$,eo]],[/(mitv-\w{5}) bui/i],[j,[ee,ey],[$,eo]],[/Hbbtv.*(technisat) (.*);/i],[ee,j,[$,eo]],[/\b(roku)[\dx]*[\)\/]((?:dvp-)?[\d\.]*)/i,/hbbtv\/\d+\.\d+\.\d+ +\([\w\+ ]*; *([\w\d][^;]*);([^;]*)/i],[[ee,Y],[j,Y],[$,eo]],[/\b(android tv|smart[- ]?tv|opera tv|tv; rv:)\b/i],[[$,eo]],[/(ouya)/i,/(nintendo) ([wids3utch]+)/i],[ee,j,[$,er]],[/droid.+; (shield) bui/i],[j,[ee,"Nvidia"],[$,er]],[/(playstation [345portablevi]+)/i],[j,[ee,eC],[$,er]],[/\b(xbox(?: one)?(?!; xbox))[\); ]/i],[j,[ee,eS],[$,er]],[/\b(sm-[lr]\d\d[05][fnuw]?s?)\b/i],[j,[ee,eI],[$,es]],[/((pebble))app/i],[ee,j,[$,es]],[/(watch)(?: ?os[,\/]|\d,\d\/)[\d\.]+/i],[j,[ee,el],[$,es]],[/droid.+; (glass) \d/i],[j,[ee,em],[$,es]],[/droid.+; (wt63?0{2,3})\)/i],[j,[ee,eb],[$,es]],[/droid.+; (glass) \d/i],[j,[ee,em],[$,es]],[/(pico) (4|neo3(?: link|pro)?)/i],[ee,j,[$,es]],[/; (quest( \d| pro)?)/i],[j,[ee,eN],[$,es]],[/(tesla)(?: qtcarbrowser|\/[-\w\.]+)/i],[ee,[$,ec]],[/(aeobc)\b/i],[j,[ee,ed],[$,ec]],[/droid .+?; ([^;]+?)(?: bui|; wv\)|\) applew).+? mobile safari/i],[j,[$,en]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+?(?! mobile) safari/i],[j,[$,ea]],[/\b((tablet|tab)[;\/]|focus\/\d(?!.+mobile))/i],[[$,ea]],[/(phone|mobile(?:[;\/]| [ \w\/\.]*safari)|pda(?=.+windows ce))/i],[[$,en]],[/(android[-\w\. ]{0,9});.+buil/i],[j,[ee,"Generic"]]],engine:[[/windows.+ edge\/([\w\.]+)/i],[et,[X,"EdgeHTML"]],[/(arkweb)\/([\w\.]+)/i],[X,et],[/webkit\/537\.36.+chrome\/(?!27)([\w\.]+)/i],[et,[X,"Blink"]],[/(presto)\/([\w\.]+)/i,/(webkit|trident|netfront|netsurf|amaya|lynx|w3m|goanna|servo)\/([\w\.]+)/i,/ekioh(flow)\/([\w\.]+)/i,/(khtml|tasman|links)[\/ ]\(?([\w\.]+)/i,/(icab)[\/ ]([23]\.[\d\.]+)/i,/\b(libweb)/i],[X,et],[/rv\:([\w\.]{1,9})\b.+(gecko)/i],[et,X]],os:[[/microsoft (windows) (vista|xp)/i],[X,et],[/(windows (?:phone(?: os)?|mobile))[\/ ]?([\d\.\w ]*)/i],[X,[et,q,eU]],[/windows nt 6\.2; (arm)/i,/windows[\/ ]?([ntce\d\. ]+\w)(?!.+xbox)/i,/(?:win(?=3|9|n)|win 9x )([nt\d\.]+)/i],[[et,q,eU],[X,"Windows"]],[/ip[honead]{2,4}\b(?:.*os ([\w]+) like mac|; opera)/i,/(?:ios;fbsv\/|iphone.+ios[\/ ])([\d\.]+)/i,/cfnetwork\/.+darwin/i],[[et,/_/g,"."],[X,"iOS"]],[/(mac os x) ?([\w\. ]*)/i,/(macintosh|mac_powerpc\b)(?!.+haiku)/i],[[X,eL],[et,/_/g,"."]],[/droid ([\w\.]+)\b.+(android[- ]x86|harmonyos)/i],[et,X],[/(android|webos|qnx|bada|rim tablet os|maemo|meego|sailfish|openharmony)[-\/ ]?([\w\.]*)/i,/(blackberry)\w*\/([\w\.]*)/i,/(tizen|kaios)[\/ ]([\w\.]+)/i,/\((series40);/i],[X,et],[/\(bb(10);/i],[et,[X,eh]],[/(?:symbian ?os|symbos|s60(?=;)|series60)[-\/ ]?([\w\.]*)/i],[et,[X,"Symbian"]],[/mozilla\/[\d\.]+ \((?:mobile|tablet|tv|mobile; [\w ]+); rv:.+ gecko\/([\w\.]+)/i],[et,[X,eE+" OS"]],[/web0s;.+rt(tv)/i,/\b(?:hp)?wos(?:browser)?\/([\w\.]+)/i],[et,[X,"webOS"]],[/watch(?: ?os[,\/]|\d,\d\/)([\d\.]+)/i],[et,[X,"watchOS"]],[/crkey\/([\d\.]+)/i],[et,[X,e_+"cast"]],[/(cros) [\w]+(?:\)| ([\w\.]+)\b)/i],[[X,eP],et],[/panasonic;(viera)/i,/(netrange)mmh/i,/(nettv)\/(\d+\.[\w\.]+)/i,/(nintendo|playstation) ([wids345portablevuch]+)/i,/(xbox); +xbox ([^\);]+)/i,/\b(joli|palm)\b ?(?:os)?\/?([\w\.]*)/i,/(mint)[\/\(\) ]?(\w*)/i,/(mageia|vectorlinux)[; ]/i,/([kxln]?ubuntu|debian|suse|opensuse|gentoo|arch(?= linux)|slackware|fedora|mandriva|centos|pclinuxos|red ?hat|zenwalk|linpus|raspbian|plan 9|minix|risc os|contiki|deepin|manjaro|elementary os|sabayon|linspire)(?: gnu\/linux)?(?: enterprise)?(?:[- ]linux)?(?:-gnu)?[-\/ ]?(?!chrom|package)([-\w\.]*)/i,/(hurd|linux) ?([\w\.]*)/i,/(gnu) ?([\w\.]*)/i,/\b([-frentopcghs]{0,5}bsd|dragonfly)[\/ ]?(?!amd|[ix346]{1,2}86)([\w\.]*)/i,/(haiku) (\w+)/i],[X,et],[/(sunos) ?([\w\.\d]*)/i],[[X,"Solaris"],et],[/((?:open)?solaris)[-\/ ]?([\w\.]*)/i,/(aix) ((\d)(?=\.|\)| )[\w\.])*/i,/\b(beos|os\/2|amigaos|morphos|openvms|fuchsia|hp-ux|serenityos)/i,/(unix) ?([\w\.]*)/i],[X,et]]},Z=function(G,er){if(typeof G===V&&(er=G,G=k),!(this instanceof Z))return new Z(G,er).getResult();var eo=typeof L!==U&&L.navigator?L.navigator:k,es=G||(eo&&eo.userAgent?eo.userAgent:""),ec=eo&&eo.userAgentData?eo.userAgentData:k,ed=er?function(L,k){var M={};for(var U in L)k[U]&&k[U].length%2==0?M[U]=k[U].concat(L[U]):M[U]=L[U];return M}(eV,er):eV,el=eo&&eo.userAgent==es;return this.getBrowser=function(){var L,U={};return U[X]=k,U[et]=k,z.call(U,es,ed.browser),U[B]=typeof(L=U[et])===F?L.replace(/[^\d\.]/g,"").split(".")[0]:k,el&&eo&&eo.brave&&typeof eo.brave.isBrave==M&&(U[X]="Brave"),U},this.getCPU=function(){var L={};return L[ei]=k,z.call(L,es,ed.cpu),L},this.getDevice=function(){var L={};return L[ee]=k,L[j]=k,L[$]=k,z.call(L,es,ed.device),el&&!L[$]&&ec&&ec.mobile&&(L[$]=en),el&&"Macintosh"==L[j]&&eo&&typeof eo.standalone!==U&&eo.maxTouchPoints&&eo.maxTouchPoints>2&&(L[j]="iPad",L[$]=ea),L},this.getEngine=function(){var L={};return L[X]=k,L[et]=k,z.call(L,es,ed.engine),L},this.getOS=function(){var L={};return L[X]=k,L[et]=k,z.call(L,es,ed.os),el&&!L[X]&&ec&&ec.platform&&"Unknown"!=ec.platform&&(L[X]=ec.platform.replace(/chrome os/i,eP).replace(/macos/i,eL)),L},this.getResult=function(){return{ua:this.getUA(),browser:this.getBrowser(),engine:this.getEngine(),os:this.getOS(),device:this.getDevice(),cpu:this.getCPU()}},this.getUA=function(){return es},this.setUA=function(L){return es=typeof L===F&&L.length>500?Y(L,500):L,this},this.setUA(es),this};Z.VERSION="0.7.40",Z.BROWSER=W([X,et,B]),Z.CPU=W([ei]),Z.DEVICE=W([j,ee,$,er,en,eo,ea,es,ec]),Z.ENGINE=Z.OS=W([X,et]),_S.exports&&(G=_S.exports=Z),G.UAParser=Z;var eW=typeof L!==U&&(L.jQuery||L.Zepto);if(eW&&!eW.ua){var eG=new Z;eW.ua=eG.getResult(),eW.ua.get=function(){return eG.getUA()},eW.ua.set=function(L){eG.setUA(L);var k=eG.getResult();for(var M in k)eW.ua[M]=k[M]}}}("object"==typeof window?window:an);var _g=i(_S.exports),_T=dy.clear;Oi({global:!0,bind:!0,enumerable:!0,forced:au.clearImmediate!==_T},{clearImmediate:_T});var _R=au.Function,_I=/MSIE .\./.test(aH)||"BUN"===sl&&((X=au.Bun.version.split(".")).length<3||"0"===X[0]&&(X[1]<3||"3"===X[1]&&"0"===X[2])),_C=dy.set,_y=au.setImmediate&&_I?function(L,k){var M=cd(arguments.length,1)>1,U=aT(L)?L:_R(L),V=M?dl(arguments,1):[];return _C(M?function(){aE(U,this,V)}:U)}:_C;Oi({global:!0,bind:!0,enumerable:!0,forced:au.setImmediate!==_y},{setImmediate:_y});var _A=i(aB.setImmediate);Oi({global:!0,enumerable:!0,dontCallGetSet:!0,forced:n(function(){return aI&&1!==Object.getOwnPropertyDescriptor(au,"queueMicrotask").value.length})},{queueMicrotask:function(L){cd(arguments.length,1),dX(Ne(L))}});var _b=i(aB.queueMicrotask);function ST(L,k){return function(){return L.apply(k,arguments)}}let{toString:_N}=Object.prototype,{getPrototypeOf:_D}=Object,{iterator:_P,toStringTag:_L}=Symbol,_k=(it=Object.create(null),L=>{let k=_N.call(L);return it[k]||(it[k]=k.slice(8,-1).toLowerCase())}),IT=L=>(L=L.toLowerCase(),k=>_k(k)===L),bT=L=>k=>typeof k===L,{isArray:_M}=Array,_U=bT("undefined"),_x=IT("ArrayBuffer"),_B=bT("string"),_W=bT("function"),_H=bT("number"),LT=L=>null!==L&&"object"==typeof L,kT=L=>{if("object"!==_k(L))return!1;let k=_D(L);return!(null!==k&&k!==Object.prototype&&null!==Object.getPrototypeOf(k)||_L in L||_P in L)},_K=IT("Date"),_z=IT("File"),_q=IT("Blob"),_J=IT("FileList"),_X=IT("URLSearchParams"),[_Q,_Z,_$,_0]=["ReadableStream","Request","Response","Headers"].map(IT);function HT(L,k){let M,U,{allOwnKeys:V=!1}=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(null!=L){if("object"!=typeof L&&(L=[L]),_M(L))for(M=0,U=L.length;M<U;M++)k.call(null,L[M],M,L);else{let U;let F=V?Object.getOwnPropertyNames(L):Object.keys(L),B=F.length;for(M=0;M<B;M++)U=F[M],k.call(null,L[U],U,L)}}}function KT(L,k){k=k.toLowerCase();let M=Object.keys(L),U,V=M.length;for(;V-- >0;)if(k===(U=M[V]).toLowerCase())return U;return null}let _1=void 0!==_f?_f:"undefined"!=typeof self?self:"undefined"!=typeof window?window:M.g,zT=L=>!_U(L)&&L!==_1,_2=(ii="undefined"!=typeof Uint8Array&&_D(Uint8Array),L=>ii&&L instanceof ii),_3=IT("HTMLFormElement"),_5=(L=>{let{hasOwnProperty:k}=L;return(L,M)=>k.call(L,M)})(Object.prototype),_4=IT("RegExp"),$T=(L,k)=>{let M=Object.getOwnPropertyDescriptors(L),U={};HT(M,(M,V)=>{let F;!1!==(F=k(M,V,L))&&(U[V]=F||M)}),Object.defineProperties(L,U)},_6=IT("AsyncFunction"),_8=(ia=_W(_1.postMessage),"function"==typeof _A?_A:ia?(io="axios@".concat(Math.random()),is=[],_1.addEventListener("message",L=>{let{source:k,data:M}=L;k===_1&&M===io&&is.length&&is.shift()()},!1),L=>{is.push(L),_1.postMessage(io,"*")}):L=>setTimeout(L)),_9=void 0!==_b?_b.bind(_1):void 0!==U&&U.nextTick||_8;var _7={isArray:_M,isArrayBuffer:_x,isBuffer:function(L){return null!==L&&!_U(L)&&null!==L.constructor&&!_U(L.constructor)&&_W(L.constructor.isBuffer)&&L.constructor.isBuffer(L)},isFormData:L=>{let k;return L&&("function"==typeof FormData&&L instanceof FormData||_W(L.append)&&("formdata"===(k=_k(L))||"object"===k&&_W(L.toString)&&"[object FormData]"===L.toString()))},isArrayBufferView:function(L){return"undefined"!=typeof ArrayBuffer&&ArrayBuffer.isView?ArrayBuffer.isView(L):L&&L.buffer&&_x(L.buffer)},isString:_B,isNumber:_H,isBoolean:L=>!0===L||!1===L,isObject:LT,isPlainObject:kT,isReadableStream:_Q,isRequest:_Z,isResponse:_$,isHeaders:_0,isUndefined:_U,isDate:_K,isFile:_z,isBlob:_q,isRegExp:_4,isFunction:_W,isStream:L=>LT(L)&&_W(L.pipe),isURLSearchParams:_X,isTypedArray:_2,isFileList:_J,forEach:HT,merge:function e(){let{caseless:L}=zT(this)&&this||{},k={},n=(M,U)=>{let V=L&&KT(k,U)||U;kT(k[V])&&kT(M)?k[V]=e(k[V],M):kT(M)?k[V]=e({},M):_M(M)?k[V]=M.slice():k[V]=M};for(let L=0,k=arguments.length;L<k;L++)arguments[L]&&HT(arguments[L],n);return k},extend:function(L,k,M){let{allOwnKeys:U}=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};return HT(k,(k,U)=>{M&&_W(k)?L[U]=ST(k,M):L[U]=k},{allOwnKeys:U}),L},trim:L=>_p(L)?_p(L).call(L):L.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,""),stripBOM:L=>(65279===L.charCodeAt(0)&&(L=L.slice(1)),L),inherits:(L,k,M,U)=>{L.prototype=Object.create(k.prototype,U),L.prototype.constructor=L,Object.defineProperty(L,"super",{value:k.prototype}),M&&Object.assign(L.prototype,M)},toFlatObject:(L,k,M,U)=>{let V,F,B;let j={};if(k=k||{},null==L)return k;do{for(F=(V=Object.getOwnPropertyNames(L)).length;F-- >0;)B=V[F],U&&!U(B,L,k)||j[B]||(k[B]=L[B],j[B]=!0);L=!1!==M&&_D(L)}while(L&&(!M||M(L,k))&&L!==Object.prototype);return k},kindOf:_k,kindOfTest:IT,endsWith:(L,k,M)=>{L=String(L),(void 0===M||M>L.length)&&(M=L.length),M-=k.length;let U=L.indexOf(k,M);return -1!==U&&U===M},toArray:L=>{if(!L)return null;if(_M(L))return L;let k=L.length;if(!_H(k))return null;let M=Array(k);for(;k-- >0;)M[k]=L[k];return M},forEachEntry:(L,k)=>{let M;let U=(L&&L[_P]).call(L);for(;(M=U.next())&&!M.done;){let U=M.value;k.call(L,U[0],U[1])}},matchAll:(L,k)=>{let M;let U=[];for(;null!==(M=L.exec(k));)U.push(M);return U},isHTMLForm:_3,hasOwnProperty:_5,hasOwnProp:_5,reduceDescriptors:$T,freezeMethods:L=>{$T(L,(k,M)=>{if(_W(L)&&-1!==["arguments","caller","callee"].indexOf(M))return!1;let U=L[M];_W(U)&&(k.enumerable=!1,"writable"in k?k.writable=!1:k.set||(k.set=()=>{throw Error("Can not rewrite read-only method '"+M+"'")}))})},toObjectSet:(L,k)=>{let M={};return(L=>{L.forEach(L=>{M[L]=!0})})(_M(L)?L:String(L).split(k)),M},toCamelCase:L=>L.toLowerCase().replace(/[-_\s]([a-z\d])(\w*)/g,function(L,k,M){return k.toUpperCase()+M}),noop:()=>{},toFiniteNumber:(L,k)=>null!=L&&Number.isFinite(L=+L)?L:k,findKey:KT,global:_1,isContextDefined:zT,isSpecCompliantForm:function(L){return!!(L&&_W(L.append)&&"FormData"===L[_L]&&L[_P])},toJSONObject:L=>{let k=Array(10),i=(L,M)=>{if(LT(L)){if(k.indexOf(L)>=0)return;if(!("toJSON"in L)){k[M]=L;let U=_M(L)?[]:{};return HT(L,(L,k)=>{let V=i(L,M+1);_U(V)||(U[k]=V)}),k[M]=void 0,U}}return L};return i(L,0)},isAsyncFn:_6,isThenable:L=>L&&(LT(L)||_W(L))&&_W(L.then)&&_W(L.catch),setImmediate:_8,asap:_9,isIterable:L=>null!=L&&_W(L[_P])};function cR(L,k,M,U,V){Error.call(this),Error.captureStackTrace?Error.captureStackTrace(this,this.constructor):this.stack=Error().stack,this.message=L,this.name="AxiosError",k&&(this.code=k),M&&(this.config=M),U&&(this.request=U),V&&(this.response=V,this.status=V.status?V.status:null)}_7.inherits(cR,Error,{toJSON:function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:_7.toJSONObject(this.config),code:this.code,status:this.status}}});let Ee=cR.prototype,Et={};function uR(L){return _7.isPlainObject(L)||_7.isArray(L)}function hR(L){return _7.endsWith(L,"[]")?L.slice(0,-2):L}function pR(L,k,M){return L?L.concat(k).map(function(L,k){return L=hR(L),!M&&k?"["+L+"]":L}).join(M?".":""):k}["ERR_BAD_OPTION_VALUE","ERR_BAD_OPTION","ECONNABORTED","ETIMEDOUT","ERR_NETWORK","ERR_FR_TOO_MANY_REDIRECTS","ERR_DEPRECATED","ERR_BAD_RESPONSE","ERR_BAD_REQUEST","ERR_CANCELED","ERR_NOT_SUPPORT","ERR_INVALID_URL"].forEach(L=>{Et[L]={value:L}}),Object.defineProperties(cR,Et),Object.defineProperty(Ee,"isAxiosError",{value:!0}),cR.from=(L,k,M,U,V,F)=>{let B=Object.create(Ee);return _7.toFlatObject(L,B,function(L){return L!==Error.prototype},L=>"isAxiosError"!==L),cR.call(B,L.message,k,M,U,V),B.cause=L,B.name=L.name,F&&Object.assign(B,F),B};let Ei=_7.toFlatObject(_7,{},null,function(L){return/^is[A-Z]/.test(L)});function ER(L,k,M){if(!_7.isObject(L))throw TypeError("target must be an object");k=k||new FormData;let U=(M=_7.toFlatObject(M,{metaTokens:!0,dots:!1,indexes:!1},!1,function(L,k){return!_7.isUndefined(k[L])})).metaTokens,F=M.visitor||d,B=M.dots,j=M.indexes,G=(M.Blob||"undefined"!=typeof Blob&&Blob)&&_7.isSpecCompliantForm(k);if(!_7.isFunction(F))throw TypeError("visitor must be a function");function c(L){if(null===L)return"";if(_7.isDate(L))return L.toISOString();if(!G&&_7.isBlob(L))throw new cR("Blob is not supported. Use a Buffer instead.");return _7.isArrayBuffer(L)||_7.isTypedArray(L)?G&&"function"==typeof Blob?new Blob([L]):V.from(L):L}function d(L,M,V){let F=L;if(L&&!V&&"object"==typeof L){if(_7.endsWith(M,"{}"))M=U?M:M.slice(0,-2),L=JSON.stringify(L);else{var G;if(_7.isArray(L)&&(G=L,_7.isArray(G)&&!G.some(uR))||(_7.isFileList(L)||_7.endsWith(M,"[]"))&&(F=_7.toArray(L)))return M=hR(M),F.forEach(function(L,U){_7.isUndefined(L)||null===L||k.append(!0===j?pR([M],U,B):null===j?M:M+"[]",c(L))}),!1}}return!!uR(L)||(k.append(pR(V,M,B),c(L)),!1)}let X=[],$=Object.assign(Ei,{defaultVisitor:d,convertValue:c,isVisitable:uR});if(!_7.isObject(L))throw TypeError("data must be an object");return function e(L,M){if(!_7.isUndefined(L)){if(-1!==X.indexOf(L))throw Error("Circular reference detected in "+M.join("."));X.push(L),_7.forEach(L,function(L,U){!0===(!(_7.isUndefined(L)||null===L)&&F.call(k,L,_7.isString(U)?_p(U).call(U):U,M,$))&&e(L,M?M.concat(U):[U])}),X.pop()}}(L),k}function mR(L){let k={"!":"%21","'":"%27","(":"%28",")":"%29","~":"%7E","%20":"+","%00":"\x00"};return encodeURIComponent(L).replace(/[!'()~]|%20|%00/g,function(L){return k[L]})}function fR(L,k){this._pairs=[],L&&ER(L,this,k)}let En=fR.prototype;function gR(L){return encodeURIComponent(L).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+").replace(/%5B/gi,"[").replace(/%5D/gi,"]")}function TR(L,k,M){let U;if(!k)return L;let V=M&&M.encode||gR;_7.isFunction(M)&&(M={serialize:M});let F=M&&M.serialize;if(U=F?F(k,M):_7.isURLSearchParams(k)?k.toString():new fR(k,M).toString(V)){let k=L.indexOf("#");-1!==k&&(L=L.slice(0,k)),L+=(-1===L.indexOf("?")?"?":"&")+U}return L}En.append=function(L,k){this._pairs.push([L,k])},En.toString=function(L){let k=L?function(k){return L.call(this,k,mR)}:mR;return this._pairs.map(function(L){return k(L[0])+"="+k(L[1])},"").join("&")};var Ea=class{constructor(){this.handlers=[]}use(L,k,M){return this.handlers.push({fulfilled:L,rejected:k,synchronous:!!M&&M.synchronous,runWhen:M?M.runWhen:null}),this.handlers.length-1}eject(L){this.handlers[L]&&(this.handlers[L]=null)}clear(){this.handlers&&(this.handlers=[])}forEach(L){_7.forEach(this.handlers,function(k){null!==k&&L(k)})}},Eo={silentJSONParsing:!0,forcedJSONParsing:!0,clarifyTimeoutError:!1},Ec={exports:{}},Ed=ob.f;Oi({target:"Object",stat:!0,forced:Object.defineProperty!==Ed,sham:!aI},{defineProperty:Ed});var El=aB.Object,Eu=Ec.exports=function(L,k,M){return El.defineProperty(L,k,M)};El.defineProperty.sham&&(Eu.sham=!0);var Eh=i(Ec.exports),Ep=TypeError,E_=pt("species"),Em=Array,UR=function(L){var k;return sm(L)&&(ds(k=L.constructor)&&(k===Em||sm(k.prototype))||Q(k)&&null===(k=k[E_]))&&(k=void 0),void 0===k?Em:k},VR=function(L,k){return new(UR(L))(0===k?0:k)},Ef=pt("species"),jR=function(L){return aQ>=51||!n(function(){var k=[];return(k.constructor={})[Ef]=function(){return{foo:1}},1!==k[L](Boolean).foo})},qR=function(L){if(L>9007199254740991)throw Ep("Maximum allowed index exceeded");return L},ES=pt("isConcatSpreadable"),Eg=aQ>=51||!n(function(){var L=[];return L[ES]=!1,L.concat()[0]!==L}),tv=function(L){if(!Q(L))return!1;var k=L[ES];return void 0!==k?!!k:sm(L)};Oi({target:"Array",proto:!0,arity:1,forced:!Eg||!jR("concat")},{concat:function(L){var k,M,U,V,F,B=Je(this),j=VR(B,0),G=0;for(k=-1,U=arguments.length;k<U;k++)if(tv(F=-1===k?B:arguments[k]))for(qR(G+(V=Wi(F))),M=0;M<V;M++,G++)M in F&&YE(j,G,F[M]);else qR(G+1),YE(j,G++,F);return j.length=G,j}});var ET={},EI=sU.f,Ev="object"==typeof window&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[];ET.f=function(L){return Ev&&"Window"===R(L)?function(L){try{return EI(L)}catch(L){return dl(Ev)}}(L):EI(J(L))};var EC={};EC.f=pt;var Ey=ob.f,_v=function(L){var k=aB.Symbol||(aB.Symbol={});or(k,L)||Ey(k,L,{value:EC.f(L)})},gv=function(){var L=re("Symbol"),k=L&&L.prototype,M=k&&k.valueOf,U=pt("toPrimitive");k&&!k[U]&&Ca(k,U,function(L){return aC(M,this)},{arity:1})},EA=ad([].push),bv=function(L){var k=1===L,M=2===L,U=3===L,V=4===L,F=6===L,B=7===L,j=5===L||F;return function(G,X,$,ee){for(var et,ei,er=Je(G),en=aU(er),ea=Wi(en),eo=Zt(X,$),es=0,ec=ee||VR,ed=k?ec(G,ea):M||B?ec(G,0):void 0;ea>es;es++)if((j||es in en)&&(ei=eo(et=en[es],es,er),L)){if(k)ed[es]=ei;else if(ei)switch(L){case 3:return!0;case 5:return et;case 6:return es;case 2:EA(ed,et)}else switch(L){case 4:return!1;case 7:EA(ed,et)}}return F?-1:U||V?V:ed}},Eb={forEach:bv(0),map:bv(1),filter:bv(2),some:bv(3),every:bv(4),find:bv(5),findIndex:bv(6),filterReject:bv(7)},EO=Eb.forEach,EL=gr("hidden"),Ek="Symbol",EU="prototype",EV=cN.set,Ej=cN.getterFor(Ek),EG=Object[EU],EH=au.Symbol,EK=EH&&EH[EU],Eq=au.RangeError,EJ=au.TypeError,EX=au.QObject,EQ=aR.f,EZ=ob.f,E$=ET.f,E0=ay.f,E1=ad([].push),E2=ze("symbols"),E3=ze("op-symbols"),E5=ze("wks"),E4=!EX||!EX[EU]||!EX[EU].findChild,OC=function(L,k,M){var U=EQ(EG,k);U&&delete EG[k],EZ(L,k,M),U&&L!==EG&&EZ(EG,k,U)},E6=aI&&n(function(){return 7!==s2(EZ({},"a",{get:function(){return EZ(this,"a",{value:7}).a}})).a})?OC:EZ,DC=function(L,k){var M=E2[L]=s2(EK);return EV(M,{type:Ek,tag:L,description:k}),aI||(M.description=k),M},PC=function(L,k,M){L===EG&&PC(E3,k,M),ni(L);var U=Ct(k);return ni(M),or(E2,U)?(M.enumerable?(or(L,EL)&&L[EL][U]&&(L[EL][U]=!1),M=s2(M,{enumerable:x(0,!1)})):(or(L,EL)||EZ(L,EL,x(1,s2(null))),L[EL][U]=!0),E6(L,U,M)):EZ(L,U,M)},LC=function(L,k){ni(L);var M=J(k);return EO(sX(M).concat(VC(M)),function(k){aI&&!aC(kC,M,k)||PC(L,k,M[k])}),L},kC=function(L){var k=Ct(L),M=aC(E0,this,k);return!(this===EG&&or(E2,k)&&!or(E3,k))&&(!(M||!or(this,k)||!or(E2,k)||or(this,EL)&&this[EL][k])||M)},MC=function(L,k){var M=J(L),U=Ct(k);if(M!==EG||!or(E2,U)||or(E3,U)){var V=EQ(M,U);return!V||!or(E2,U)||or(M,EL)&&M[EL][U]||(V.enumerable=!0),V}},UC=function(L){var k=E$(J(L)),M=[];return EO(k,function(L){or(E2,L)||or(sV,L)||E1(M,L)}),M},VC=function(L){var k=L===EG,M=E$(k?E3:J(L)),U=[];return EO(M,function(L){or(E2,L)&&(!k||or(EG,L))&&E1(U,E2[L])}),U};a$||(Ca(EK=(EH=function(){if(al(EK,this))throw new EJ("Symbol is not a constructor");var L=arguments.length&&void 0!==arguments[0]?Sn(arguments[0]):void 0,k=rt(L),i=function(L){var M=void 0===this?au:this;M===EG&&aC(i,E3,L),or(M,EL)&&or(M[EL],k)&&(M[EL][k]=!1);var U=x(1,L);try{E6(M,k,U)}catch(L){if(!(L instanceof Eq))throw L;OC(M,k,U)}};return aI&&E4&&E6(EG,k,{configurable:!0,set:i}),DC(k,L)})[EU],"toString",function(){return Ej(this).tag}),Ca(EH,"withoutSetter",function(L){return DC(rt(L),L)}),ay.f=kC,ob.f=PC,sJ.f=LC,aR.f=MC,sU.f=ET.f=UC,sH.f=VC,EC.f=function(L){return DC(pt(L),L)},aI&&Cc(EK,"description",{configurable:!0,get:function(){return Ej(this).description}})),Oi({global:!0,constructor:!0,wrap:!0,forced:!a$,sham:!a$},{Symbol:EH}),EO(sX(E5),function(L){_v(L)}),Oi({target:Ek,stat:!0,forced:!a$},{useSetter:function(){E4=!0},useSimple:function(){E4=!1}}),Oi({target:"Object",stat:!0,forced:!a$,sham:!aI},{create:function(L,k){return void 0===k?s2(L):LC(s2(L),k)},defineProperty:PC,defineProperties:LC,getOwnPropertyDescriptor:MC}),Oi({target:"Object",stat:!0,forced:!a$},{getOwnPropertyNames:UC}),gv(),Ga(EH,Ek),sV[EL]=!0;var E8=a$&&!!Symbol.for&&!!Symbol.keyFor,E9=ze("string-to-symbol-registry"),E7=ze("symbol-to-string-registry");Oi({target:"Symbol",stat:!0,forced:!E8},{for:function(L){var k=Sn(L);if(or(E9,k))return E9[k];var M=re("Symbol")(k);return E9[k]=M,E7[M]=k,M}});var me=ze("symbol-to-string-registry");Oi({target:"Symbol",stat:!0,forced:!E8},{keyFor:function(L){if(!a2(L))throw TypeError(be(L)+" is not a symbol");if(or(me,L))return me[L]}});var mt=ad([].push),py=function(L){if(aT(L))return L;if(sm(L)){for(var k=L.length,M=[],U=0;U<k;U++){var V=L[U];"string"==typeof V?mt(M,V):"number"!=typeof V&&"Number"!==R(V)&&"String"!==R(V)||mt(M,Sn(V))}var F=M.length,B=!0;return function(L,k){if(B)return B=!1,k;if(sm(this))return k;for(var U=0;U<F;U++)if(M[U]===L)return k}}},mi=String,mr=re("JSON","stringify"),mn=ad(/./.exec),ma=ad("".charAt),mo=ad("".charCodeAt),ms=ad("".replace),mc=ad(1..toString),md=/[\uD800-\uDFFF]/g,ml=/^[\uD800-\uDBFF]$/,mu=/^[\uDC00-\uDFFF]$/,mh=!a$||n(function(){var L=re("Symbol")("stringify detection");return"[null]"!==mr([L])||"{}"!==mr({a:L})||"{}"!==mr(Object(L))}),m_=n(function(){return'"\udf06\ud834"'!==mr("\udf06\ud834")||'"\udead"'!==mr("\udead")}),Ay=function(L,k){var M=dl(arguments),U=py(k);if(aT(U)||void 0!==L&&!a2(L))return M[1]=function(L,k){if(aT(U)&&(k=aC(U,this,mi(L),k)),!a2(k))return k},aE(mr,null,M)},wy=function(L,k,M){var U=ma(M,k-1),V=ma(M,k+1);return mn(ml,L)&&!mn(mu,V)||mn(mu,L)&&!mn(ml,U)?"\\u"+mc(mo(L,0),16):L};mr&&Oi({target:"JSON",stat:!0,arity:3,forced:mh||m_},{stringify:function(L,k,M){var U=dl(arguments),V=aE(mh?Ay:mr,null,U);return m_&&"string"==typeof V?ms(V,md,wy):V}}),Oi({target:"Object",stat:!0,forced:!a$||n(function(){sH.f(1)})},{getOwnPropertySymbols:function(L){var k=sH.f;return k?k(Je(L)):[]}}),_v("asyncIterator"),_v("hasInstance"),_v("isConcatSpreadable"),_v("iterator"),_v("match"),_v("matchAll"),_v("replace"),_v("search"),_v("species"),_v("split"),_v("toPrimitive"),gv(),_v("toStringTag"),Ga(re("Symbol"),"Symbol"),_v("unscopables"),Ga(au.JSON,"JSON",!0);var mm=aB.Symbol,mf=ob.f,mS=pt("metadata"),mg=Function.prototype;void 0===mg[mS]&&mf(mg,mS,{value:null}),_v("asyncDispose"),_v("dispose"),_v("metadata");var mT=re("Symbol"),mI=mT.keyFor,mv=ad(mT.prototype.valueOf),mC=mT.isRegisteredSymbol||function(L){try{return void 0!==mI(mv(L))}catch(L){return!1}};Oi({target:"Symbol",stat:!0},{isRegisteredSymbol:mC});for(var my=re("Symbol"),mb=my.isWellKnownSymbol,mN=re("Object","getOwnPropertyNames"),mD=ad(my.prototype.valueOf),mL=ze("wks"),mk=0,mU=mN(my),mV=mU.length;mk<mV;mk++)try{var mj=mU[mk];a2(my[mj])&&pt(mj)}catch(L){}var oI=function(L){if(mb&&mb(L))return!0;try{for(var k=mD(L),M=0,U=mN(mL),V=U.length;M<V;M++)if(mL[U[M]]==k)return!0}catch(L){}return!1};Oi({target:"Symbol",stat:!0,forced:!0},{isWellKnownSymbol:oI}),_v("customMatcher"),_v("observable"),Oi({target:"Symbol",stat:!0,name:"isRegisteredSymbol"},{isRegistered:mC}),Oi({target:"Symbol",stat:!0,name:"isWellKnownSymbol",forced:!0},{isWellKnown:oI}),_v("matcher"),_v("metadataKey"),_v("patternMatch"),_v("replaceAll");var mW=i(mm),mG=i(EC.f("iterator"));function cI(L){return(cI="function"==typeof mW&&"symbol"==typeof mG?function(L){return typeof L}:function(L){return L&&"function"==typeof mW&&L.constructor===mW&&L!==mW.prototype?"symbol":typeof L})(L)}var mH=i(EC.f("toPrimitive"));function lI(L){var k=function(L,k){if("object"!=cI(L)||!L)return L;var M=L[mH];if(void 0!==M){var U=M.call(L,k||"default");if("object"!=cI(U))return U;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===k?String:Number)(L)}(L,"string");return"symbol"==cI(k)?k:k+""}function uI(L,k,M){return(k=lI(k))in L?Eh(L,k,{value:M,enumerable:!0,configurable:!0,writable:!0}):L[k]=M,L}var mK=i(ha),mz={isBrowser:!0,classes:{URLSearchParams:void 0!==mK?mK:fR,FormData:"undefined"!=typeof FormData?FormData:null,Blob:"undefined"!=typeof Blob?Blob:null},protocols:["http","https","file","blob","url","data"]};let mJ="undefined"!=typeof window&&"undefined"!=typeof document,mX="object"==typeof navigator&&navigator||void 0,mQ=mJ&&(!mX||0>["ReactNative","NativeScript","NS"].indexOf(mX.product)),mZ="undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope&&"function"==typeof self.importScripts,m$=mJ&&window.location.href||"http://localhost";function gI(L,k){var M=Object.keys(L);if(Object.getOwnPropertySymbols){var U=Object.getOwnPropertySymbols(L);k&&(U=U.filter(function(k){return Object.getOwnPropertyDescriptor(L,k).enumerable})),M.push.apply(M,U)}return M}function TI(L){for(var k=1;k<arguments.length;k++){var M=null!=arguments[k]?arguments[k]:{};k%2?gI(Object(M),!0).forEach(function(k){uI(L,k,M[k])}):Object.getOwnPropertyDescriptors?Object.defineProperties(L,Object.getOwnPropertyDescriptors(M)):gI(Object(M)).forEach(function(k){Object.defineProperty(L,k,Object.getOwnPropertyDescriptor(M,k))})}return L}var m0=TI(TI({},Object.freeze({__proto__:null,hasBrowserEnv:mJ,hasStandardBrowserEnv:mQ,hasStandardBrowserWebWorkerEnv:mZ,navigator:mX,origin:m$})),mz),bI=function(){var L=ni(this),k="";return L.hasIndices&&(k+="d"),L.global&&(k+="g"),L.ignoreCase&&(k+="i"),L.multiline&&(k+="m"),L.dotAll&&(k+="s"),L.unicode&&(k+="u"),L.unicodeSets&&(k+="v"),L.sticky&&(k+="y"),k},m1=RegExp.prototype,wI=function(L){var k=L.flags;return void 0!==k||"flags"in m1||or(L,"flags")||!al(m1,L)?k:aC(bI,L)},m2=lM.charAt,m3=/./.exec,m5=TypeError,$I=function(L,k){var M=L.exec;if(aT(M)){var U=aC(M,L,k);return null!==U&&ni(U),U}if("RegExp"===R(L))return aC(m3,L,k);throw new m5("RegExp#exec called on incompatible receiver")},m4=pt("matchAll"),m6="RegExp String",m8=m6+" Iterator",m9=cN.set,m7=cN.getterFor(m8),fe=TypeError,ft=y("".indexOf),fi=y("".matchAll),fr=!!fi&&!n(function(){fi("a",/./)}),fn=Xa(function(L,k,M,U){m9(this,{type:m8,regexp:L,string:k,global:M,unicode:U,done:!1})},m6,function(){var L,k=m7(this);if(k.done)return pc(void 0,!0);var M=k.regexp,U=k.string,V=$I(M,U);return null===V?(k.done=!0,pc(void 0,!0)):(k.global?""===Sn(V[0])&&(M.lastIndex=(L=ji(M.lastIndex))+(k.unicode?m2(U,L).length:1)):k.done=!0,pc(V,!1))}),ub=function(L){var k,M,U,V=ni(this),F=Sn(L),B=od(V,RegExp),j=Sn(wI(V));return k=new B(B===RegExp?V.source:V,j),M=!!~ft(j,"g"),U=!!~ft(j,"u"),k.lastIndex=ji(V.lastIndex),new fn(k,F,M,U)};Oi({target:"String",proto:!0,forced:fr},{matchAll:function(L){var k,M,U=z(this);if(Q(L)){if(rn(L)&&!~ft(Sn(z(wI(L))),"g"))throw new fe("`.matchAll` does not allow non-global regexes");if(fr)return fi(U,L);if(void 0===(M=Le(L,m4))&&"RegExp"===R(L)&&(M=ub),M)return aC(M,L,U)}else if(fr)return fi(U,L);return k=Sn(U),aC(ub,RegExp(L,"g"),k)}});var fa=Qi("String","matchAll"),fo=String.prototype,fs=i(function(L){var k=L.matchAll;return"string"==typeof L||L===fo||al(fo,L)&&k===fo.matchAll?fa:k});function Sb(L){function t(L,k,M,U){let V=L[U++];if("__proto__"===V)return!0;let F=Number.isFinite(+V),B=U>=L.length;return(V=!V&&_7.isArray(M)?M.length:V,B)?_7.hasOwnProp(M,V)?M[V]=[M[V],k]:M[V]=k:(M[V]&&_7.isObject(M[V])||(M[V]=[]),t(L,k,M[V],U)&&_7.isArray(M[V])&&(M[V]=function(L){let k,M;let U={},V=Object.keys(L),F=V.length;for(k=0;k<F;k++)U[M=V[k]]=L[M];return U}(M[V]))),!F}if(_7.isFormData(L)&&_7.isFunction(L.entries)){let k={};return _7.forEachEntry(L,(L,M)=>{t(fs(_7).call(_7,/\w+|\[(\w*)]/g,L).map(L=>"[]"===L[0]?"":L[1]||L[0]),M,k,0)}),k}return null}let fc={transitional:Eo,adapter:["xhr","http","fetch"],transformRequest:[function(L,k){let M;let U=k.getContentType()||"",V=U.indexOf("application/json")>-1,F=_7.isObject(L);if(F&&_7.isHTMLForm(L)&&(L=new FormData(L)),_7.isFormData(L))return V?JSON.stringify(Sb(L)):L;if(_7.isArrayBuffer(L)||_7.isBuffer(L)||_7.isStream(L)||_7.isFile(L)||_7.isBlob(L)||_7.isReadableStream(L))return L;if(_7.isArrayBufferView(L))return L.buffer;if(_7.isURLSearchParams(L))return k.setContentType("application/x-www-form-urlencoded;charset=utf-8",!1),L.toString();if(F){if(U.indexOf("application/x-www-form-urlencoded")>-1){var B,j;return(B=L,j=this.formSerializer,ER(B,new m0.classes.URLSearchParams,Object.assign({visitor:function(L,k,M,U){return m0.isNode&&_7.isBuffer(L)?(this.append(k,L.toString("base64")),!1):U.defaultVisitor.apply(this,arguments)}},j))).toString()}if((M=_7.isFileList(L))||U.indexOf("multipart/form-data")>-1){let k=this.env&&this.env.FormData;return ER(M?{"files[]":L}:L,k&&new k,this.formSerializer)}}return F||V?(k.setContentType("application/json",!1),function(L,k,M){if(_7.isString(L))try{return(0,JSON.parse)(L),_p(_7).call(_7,L)}catch(L){if("SyntaxError"!==L.name)throw L}return(0,JSON.stringify)(L)}(L)):L}],transformResponse:[function(L){let k=this.transitional||fc.transitional,M=k&&k.forcedJSONParsing,U="json"===this.responseType;if(_7.isResponse(L)||_7.isReadableStream(L))return L;if(L&&_7.isString(L)&&(M&&!this.responseType||U)){let M=!(k&&k.silentJSONParsing)&&U;try{return JSON.parse(L)}catch(L){if(M){if("SyntaxError"===L.name)throw cR.from(L,cR.ERR_BAD_RESPONSE,this,null,this.response);throw L}}}return L}],timeout:0,xsrfCookieName:"XSRF-TOKEN",xsrfHeaderName:"X-XSRF-TOKEN",maxContentLength:-1,maxBodyLength:-1,env:{FormData:m0.classes.FormData,Blob:m0.classes.Blob},validateStatus:function(L){return L>=200&&L<300},headers:{common:{Accept:"application/json, text/plain, */*","Content-Type":void 0}}};_7.forEach(["delete","get","head","post","put","patch"],L=>{fc.headers[L]={}});let fd=_7.toObjectSet(["age","authorization","content-length","content-type","etag","expires","from","host","if-modified-since","if-unmodified-since","last-modified","location","max-forwards","proxy-authorization","referer","retry-after","user-agent"]),fl=Symbol("internals");function Cb(L){var k;return L&&_p(k=String(L)).call(k).toLowerCase()}function yb(L){return!1===L||null==L?L:_7.isArray(L)?L.map(yb):String(L)}function Ib(L,k,M,U,V){return _7.isFunction(U)?U.call(this,k,M):(V&&(k=M),_7.isString(k)?_7.isString(U)?-1!==k.indexOf(U):_7.isRegExp(U)?U.test(k):void 0:void 0)}let bb=class bb{constructor(L){L&&this.set(L)}set(L,k,M){var U;let V=this;function r(L,k,M){let U=Cb(k);if(!U)throw Error("header name must be a non-empty string");let F=_7.findKey(V,U);F&&void 0!==V[F]&&!0!==M&&(void 0!==M||!1===V[F])||(V[F||k]=yb(L))}let o=(L,k)=>_7.forEach(L,(L,M)=>r(L,M,k));if(_7.isPlainObject(L)||L instanceof this.constructor)o(L,k);else if(_7.isString(L)&&(L=_p(L).call(L))&&!/^[-_a-zA-Z0-9^`|~,!#$%&'*+.]+$/.test(_p(U=L).call(U)))o((L=>{let k,M,U;let V={};return L&&L.split("\n").forEach(function(L){var F,B;U=L.indexOf(":"),k=_p(F=L.substring(0,U)).call(F).toLowerCase(),M=_p(B=L.substring(U+1)).call(B),!k||V[k]&&fd[k]||("set-cookie"===k?V[k]?V[k].push(M):V[k]=[M]:V[k]=V[k]?V[k]+", "+M:M)}),V})(L),k);else if(_7.isObject(L)&&_7.isIterable(L)){let M,U,V={};for(let k of L){if(!_7.isArray(k))throw TypeError("Object iterator must return a key-value pair");V[U=k[0]]=(M=V[U])?_7.isArray(M)?[...M,k[1]]:[M,k[1]]:k[1]}o(V,k)}else null!=L&&r(k,L,M);return this}get(L,k){if(L=Cb(L)){let M=_7.findKey(this,L);if(M){let L=this[M];if(!k)return L;if(!0===k)return function(L){let k;let M=Object.create(null),U=/([^\s,;=]+)\s*(?:=\s*([^,;]+))?/g;for(;k=U.exec(L);)M[k[1]]=k[2];return M}(L);if(_7.isFunction(k))return k.call(this,L,M);if(_7.isRegExp(k))return k.exec(L);throw TypeError("parser must be boolean|regexp|function")}}}has(L,k){if(L=Cb(L)){let M=_7.findKey(this,L);return!(!M||void 0===this[M]||k&&!Ib(0,this[M],M,k))}return!1}delete(L,k){let M=this,U=!1;function r(L){if(L=Cb(L)){let V=_7.findKey(M,L);V&&(!k||Ib(0,M[V],V,k))&&(delete M[V],U=!0)}}return _7.isArray(L)?L.forEach(r):r(L),U}clear(L){let k=Object.keys(this),M=k.length,U=!1;for(;M--;){let V=k[M];L&&!Ib(0,this[V],V,L,!0)||(delete this[V],U=!0)}return U}normalize(L){let k=this,M={};return _7.forEach(this,(U,V)=>{var F;let B=_7.findKey(M,V);if(B)return k[B]=yb(U),void delete k[V];let j=L?_p(V).call(V).toLowerCase().replace(/([a-z\d])(\w*)/g,(L,k,M)=>k.toUpperCase()+M):_p(F=String(V)).call(F);j!==V&&delete k[V],k[j]=yb(U),M[j]=!0}),this}concat(){for(var L=arguments.length,k=Array(L),M=0;M<L;M++)k[M]=arguments[M];return this.constructor.concat(this,...k)}toJSON(L){let k=Object.create(null);return _7.forEach(this,(M,U)=>{null!=M&&!1!==M&&(k[U]=L&&_7.isArray(M)?M.join(", "):M)}),k}[Symbol.iterator](){return Object.entries(this.toJSON())[Symbol.iterator]()}toString(){return Object.entries(this.toJSON()).map(L=>{let[k,M]=L;return k+": "+M}).join("\n")}getSetCookie(){return this.get("set-cookie")||[]}get[Symbol.toStringTag](){return"AxiosHeaders"}static from(L){return L instanceof this?L:new this(L)}static concat(L){let k=new this(L);for(var M=arguments.length,U=Array(M>1?M-1:0),V=1;V<M;V++)U[V-1]=arguments[V];return U.forEach(L=>k.set(L)),k}static accessor(L){let k=(this[fl]=this[fl]={accessors:{}}).accessors,M=this.prototype;function n(L){let U=Cb(L);k[U]||(function(L,k){let M=_7.toCamelCase(" "+k);["get","set","has"].forEach(U=>{Object.defineProperty(L,U+M,{value:function(L,M,V){return this[U].call(this,k,L,M,V)},configurable:!0})})}(M,L),k[U]=!0)}return _7.isArray(L)?L.forEach(n):n(L),this}};function wb(L,k){let M=this||fc,U=k||M,V=bb.from(U.headers),F=U.data;return _7.forEach(L,function(L){F=L.call(M,F,V.normalize(),k?k.status:void 0)}),V.normalize(),F}function Ob(L){return!(!L||!L.__CANCEL__)}function Nb(L,k,M){cR.call(this,null==L?"canceled":L,cR.ERR_CANCELED,k,M),this.name="CanceledError"}function Db(L,k,M){let U=M.config.validateStatus;M.status&&U&&!U(M.status)?k(new cR("Request failed with status code "+M.status,[cR.ERR_BAD_REQUEST,cR.ERR_BAD_RESPONSE][Math.floor(M.status/100)-4],M.config,M.request,M)):L(M)}bb.accessor(["Content-Type","Content-Length","Accept","Accept-Encoding","User-Agent","Authorization"]),_7.reduceDescriptors(bb.prototype,(L,k)=>{let{value:M}=L,U=k[0].toUpperCase()+k.slice(1);return{get:()=>M,set(L){this[U]=L}}}),_7.freezeMethods(bb),_7.inherits(Nb,cR,{__CANCEL__:!0});let Pb=function(L,k){let M=arguments.length>2&&void 0!==arguments[2]?arguments[2]:3,U=0,V=function(L,k){L=L||10;let M=Array(L),U=Array(L),V,F=0,B=0;return k=void 0!==k?k:1e3,function(j){let G=Date.now(),X=U[B];V||(V=G),M[F]=j,U[F]=G;let $=B,ee=0;for(;$!==F;)ee+=M[$++],$%=L;if((F=(F+1)%L)===B&&(B=(B+1)%L),G-V<k)return;let et=X&&G-X;return et?Math.round(1e3*ee/et):void 0}}(50,250);return function(L,k){let M,U,V=0,F=1e3/k,s=function(k){let F=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Date.now();V=F,M=null,U&&(clearTimeout(U),U=null),L.apply(null,k)};return[function(){let L=Date.now(),k=L-V;for(var B=arguments.length,j=Array(B),G=0;G<B;G++)j[G]=arguments[G];k>=F?s(j,L):(M=j,U||(U=setTimeout(()=>{U=null,s(M)},F-k)))},()=>M&&s(M)]}(M=>{let F=M.loaded,B=M.lengthComputable?M.total:void 0,j=F-U,G=V(j);U=F,L({loaded:F,total:B,progress:B?F/B:void 0,bytes:j,rate:G||void 0,estimated:G&&B&&F<=B?(B-F)/G:void 0,event:M,lengthComputable:null!=B,[k?"download":"upload"]:!0})},M)},Lb=(L,k)=>{let M=null!=L;return[U=>k[0]({lengthComputable:M,total:L,loaded:U}),k[1]]},kb=L=>function(){for(var k=arguments.length,M=Array(k),U=0;U<k;U++)M[U]=arguments[U];return _7.asap(()=>L(...M))};var fh=m0.hasStandardBrowserEnv?($=new p7(m0.origin),ee=m0.navigator&&/(msie|trident)/i.test(m0.navigator.userAgent),L=>(L=new p7(L,m0.origin),$.protocol===L.protocol&&$.host===L.host&&(ee||$.port===L.port))):()=>!0,fp=m0.hasStandardBrowserEnv?{write(L,k,M,U,V,F){let B=[L+"="+encodeURIComponent(k)];_7.isNumber(M)&&B.push("expires="+new Date(M).toGMTString()),_7.isString(U)&&B.push("path="+U),_7.isString(V)&&B.push("domain="+V),!0===F&&B.push("secure"),document.cookie=B.join("; ")},read(L){let k=document.cookie.match(RegExp("(^|;\\s*)("+L+")=([^;]*)"));return k?decodeURIComponent(k[3]):null},remove(L){this.write(L,"",Date.now()-864e5)}}:{write(){},read:()=>null,remove(){}};function Vb(L,k,M){let U=!/^([a-z][a-z\d+\-.]*:)?\/\//i.test(k);return L&&(U||0==M)?k?L.replace(/\/?\/$/,"")+"/"+k.replace(/^\/+/,""):L:k}function xb(L,k){var M=Object.keys(L);if(Object.getOwnPropertySymbols){var U=Object.getOwnPropertySymbols(L);k&&(U=U.filter(function(k){return Object.getOwnPropertyDescriptor(L,k).enumerable})),M.push.apply(M,U)}return M}let Fb=L=>L instanceof bb?function(L){for(var k=1;k<arguments.length;k++){var M=null!=arguments[k]?arguments[k]:{};k%2?xb(Object(M),!0).forEach(function(k){uI(L,k,M[k])}):Object.getOwnPropertyDescriptors?Object.defineProperties(L,Object.getOwnPropertyDescriptors(M)):xb(Object(M)).forEach(function(k){Object.defineProperty(L,k,Object.getOwnPropertyDescriptor(M,k))})}return L}({},L):L;function Bb(L,k){k=k||{};let M={};function n(L,k,M,U){return _7.isPlainObject(L)&&_7.isPlainObject(k)?_7.merge.call({caseless:U},L,k):_7.isPlainObject(k)?_7.merge({},k):_7.isArray(k)?k.slice():k}function r(L,k,M,U){return _7.isUndefined(k)?_7.isUndefined(L)?void 0:n(void 0,L,0,U):n(L,k,0,U)}function o(L,k){if(!_7.isUndefined(k))return n(void 0,k)}function s(L,k){return _7.isUndefined(k)?_7.isUndefined(L)?void 0:n(void 0,L):n(void 0,k)}function a(M,U,V){return V in k?n(M,U):V in L?n(void 0,M):void 0}let U={url:o,method:o,data:o,baseURL:s,transformRequest:s,transformResponse:s,paramsSerializer:s,timeout:s,timeoutMessage:s,withCredentials:s,withXSRFToken:s,adapter:s,responseType:s,xsrfCookieName:s,xsrfHeaderName:s,onUploadProgress:s,onDownloadProgress:s,decompress:s,maxContentLength:s,maxBodyLength:s,beforeRedirect:s,transport:s,httpAgent:s,httpsAgent:s,cancelToken:s,socketPath:s,responseEncoding:s,validateStatus:a,headers:(L,k,M)=>r(Fb(L),Fb(k),0,!0)};return _7.forEach(Object.keys(Object.assign({},L,k)),function(V){let F=U[V]||r,B=F(L[V],k[V],V);_7.isUndefined(B)&&F!==a||(M[V]=B)}),M}var jb=L=>{let k=Bb({},L),M,{data:U,withXSRFToken:V,xsrfHeaderName:F,xsrfCookieName:B,headers:j,auth:G}=k;if(k.headers=j=bb.from(j),k.url=TR(Vb(k.baseURL,k.url,k.allowAbsoluteUrls),L.params,L.paramsSerializer),G&&j.set("Authorization","Basic "+btoa((G.username||"")+":"+(G.password?unescape(encodeURIComponent(G.password)):""))),_7.isFormData(U)){if(m0.hasStandardBrowserEnv||m0.hasStandardBrowserWebWorkerEnv)j.setContentType(void 0);else if(!1!==(M=j.getContentType())){let[L,...k]=M?M.split(";").map(L=>_p(L).call(L)).filter(Boolean):[];j.setContentType([L||"multipart/form-data",...k].join("; "))}}if(m0.hasStandardBrowserEnv&&(V&&_7.isFunction(V)&&(V=V(k)),V||!1!==V&&fh(k.url))){let L=F&&B&&fp.read(B);L&&j.set(F,L)}return k},f_="undefined"!=typeof XMLHttpRequest&&function(L){return new lQ(function(k,M){let U=jb(L),V=U.data,F=bb.from(U.headers).normalize(),B,j,G,X,$,{responseType:ee,onUploadProgress:et,onDownloadProgress:ei}=U;function _(){X&&X(),$&&$(),U.cancelToken&&U.cancelToken.unsubscribe(B),U.signal&&U.signal.removeEventListener("abort",B)}let er=new XMLHttpRequest;function m(){if(!er)return;let U=bb.from("getAllResponseHeaders"in er&&er.getAllResponseHeaders());Db(function(L){k(L),_()},function(L){M(L),_()},{data:ee&&"text"!==ee&&"json"!==ee?er.response:er.responseText,status:er.status,statusText:er.statusText,headers:U,config:L,request:er}),er=null}er.open(U.method.toUpperCase(),U.url,!0),er.timeout=U.timeout,"onloadend"in er?er.onloadend=m:er.onreadystatechange=function(){er&&4===er.readyState&&(0!==er.status||er.responseURL&&0===er.responseURL.indexOf("file:"))&&setTimeout(m)},er.onabort=function(){er&&(M(new cR("Request aborted",cR.ECONNABORTED,L,er)),er=null)},er.onerror=function(){M(new cR("Network Error",cR.ERR_NETWORK,L,er)),er=null},er.ontimeout=function(){let k=U.timeout?"timeout of "+U.timeout+"ms exceeded":"timeout exceeded",V=U.transitional||Eo;U.timeoutErrorMessage&&(k=U.timeoutErrorMessage),M(new cR(k,V.clarifyTimeoutError?cR.ETIMEDOUT:cR.ECONNABORTED,L,er)),er=null},void 0===V&&F.setContentType(null),"setRequestHeader"in er&&_7.forEach(F.toJSON(),function(L,k){er.setRequestHeader(k,L)}),_7.isUndefined(U.withCredentials)||(er.withCredentials=!!U.withCredentials),ee&&"json"!==ee&&(er.responseType=U.responseType),ei&&([G,$]=Pb(ei,!0),er.addEventListener("progress",G)),et&&er.upload&&([j,X]=Pb(et),er.upload.addEventListener("progress",j),er.upload.addEventListener("loadend",X)),(U.cancelToken||U.signal)&&(B=k=>{er&&(M(!k||k.type?new Nb(null,L,er):k),er.abort(),er=null)},U.cancelToken&&U.cancelToken.subscribe(B),U.signal&&(U.signal.aborted?B():U.signal.addEventListener("abort",B)));let en=function(L){let k=/^([-+\w]{1,25})(:?\/\/|:)/.exec(L);return k&&k[1]||""}(U.url);en&&-1===m0.protocols.indexOf(en)?M(new cR("Unsupported protocol "+en+":",cR.ERR_BAD_REQUEST,L)):er.send(V||null)})},Wb=(L,k)=>{let{length:M}=L=L?L.filter(Boolean):[];if(k||M){let M,U=new AbortController,r=function(L){if(!M){M=!0,s();let k=L instanceof Error?L:this.reason;U.abort(k instanceof cR?k:new Nb(k instanceof Error?k.message:k))}},V=k&&setTimeout(()=>{V=null,r(new cR("timeout ".concat(k," of ms exceeded"),cR.ETIMEDOUT))},k),s=()=>{L&&(V&&clearTimeout(V),V=null,L.forEach(L=>{L.unsubscribe?L.unsubscribe(r):L.removeEventListener("abort",r)}),L=null)};L.forEach(L=>L.addEventListener("abort",r));let{signal:F}=U;return F.unsubscribe=()=>_7.asap(s),F}},fE=i(lq),fm=EC.f("asyncIterator"),ff=i(fm);function zb(L,k){this.v=L,this.k=k}function qb(L){return function(){return new Xb(L.apply(this,arguments))}}function Xb(L){var k,M;function n(k,M){try{var U=L[k](M),V=U.value,F=V instanceof zb;fE.resolve(F?V.v:V).then(function(M){if(F){var B="return"===k?"return":"next";if(!V.k||M.done)return n(B,M);M=L[B](M).value}r(U.done?"return":"normal",M)},function(L){n("throw",L)})}catch(L){r("throw",L)}}function r(L,U){switch(L){case"return":k.resolve({value:U,done:!0});break;case"throw":k.reject(U);break;default:k.resolve({value:U,done:!1})}(k=k.next)?n(k.key,k.arg):M=null}this._invoke=function(L,U){return new fE(function(V,F){var B={key:L,arg:U,resolve:V,reject:F,next:null};M?M=M.next=B:(k=M=B,n(L,U))})},"function"!=typeof L.return&&(this.return=void 0)}function Jb(L){return new zb(L,0)}function Zb(L){var k={},M=!1;function n(k,U){return M=!0,{done:!1,value:new zb(U=new fE(function(M){M(L[k](U))}),1)}}return k[void 0!==mW&&mG||"@@iterator"]=function(){return this},k.next=function(L){return M?(M=!1,L):n("next",L)},"function"==typeof L.throw&&(k.throw=function(L){if(M)throw M=!1,L;return n("throw",L)}),"function"==typeof L.return&&(k.return=function(L){return M?(M=!1,L):n("return",L)}),k}Xb.prototype["function"==typeof mW&&ff||"@@asyncIterator"]=function(){return this},Xb.prototype.next=function(L){return this._invoke("next",L)},Xb.prototype.throw=function(L){return this._invoke("throw",L)},Xb.prototype.return=function(L){return this._invoke("return",L)};var fS=i(fm);function $b(L){var k,M,U,V=2;for("undefined"!=typeof Symbol&&(M=fS,U=Symbol.iterator);V--;){if(M&&null!=(k=L[M]))return k.call(L);if(U&&null!=(k=L[U]))return new eA(k.call(L));M="@@asyncIterator",U="@@iterator"}throw TypeError("Object is not async iterable")}function eA(L){function t(L){if(Object(L)!==L)return lQ.reject(TypeError(L+" is not an object."));var k=L.done;return lQ.resolve(L.value).then(function(L){return{value:L,done:k}})}return(eA=function(L){this.s=L,this.n=L.next}).prototype={s:null,n:null,next:function(){return t(this.n.apply(this.s,arguments))},return:function(L){var k=this.s.return;return void 0===k?lQ.resolve({value:L,done:!0}):t(k.apply(this.s,arguments))},throw:function(L){var k=this.s.return;return void 0===k?lQ.reject(L):t(k.apply(this.s,arguments))}},new eA(L)}let tA=function*(L,k){let M=L.byteLength;if(!k||M<k)return void(yield L);let U,V=0;for(;V<M;)U=V+k,yield L.slice(V,U),V=U},fg=(et=qb(function*(L,k){var M,U=!1,V=!1;try{for(var F,B=$b(fT(L));U=!(F=yield Jb(B.next())).done;U=!1){let L=F.value;yield*Zb($b(tA(L,k)))}}catch(L){V=!0,M=L}finally{try{U&&null!=B.return&&(yield Jb(B.return()))}finally{if(V)throw M}}}),function(L,k){return et.apply(this,arguments)}),fT=(ei=qb(function*(L){if(L[fS])return void(yield*Zb($b(L)));let k=L.getReader();try{for(;;){let{done:L,value:M}=yield Jb(k.read());if(L)break;yield M}}finally{yield Jb(k.cancel())}}),function(L){return ei.apply(this,arguments)}),rA=(L,k,M,U)=>{let V=fg(L,k),F,B=0,a=L=>{F||(F=!0,U&&U(L))};return new ReadableStream({async pull(L){try{let{done:k,value:U}=await V.next();if(k)return a(),void L.close();let F=U.byteLength;if(M){let L=B+=F;M(L)}L.enqueue(new Uint8Array(U))}catch(L){throw a(L),L}},cancel:L=>(a(L),V.return())},{highWaterMark:2})};function oA(L,k){var M=Object.keys(L);if(Object.getOwnPropertySymbols){var U=Object.getOwnPropertySymbols(L);k&&(U=U.filter(function(k){return Object.getOwnPropertyDescriptor(L,k).enumerable})),M.push.apply(M,U)}return M}function sA(L){for(var k=1;k<arguments.length;k++){var M=null!=arguments[k]?arguments[k]:{};k%2?oA(Object(M),!0).forEach(function(k){uI(L,k,M[k])}):Object.getOwnPropertyDescriptors?Object.defineProperties(L,Object.getOwnPropertyDescriptors(M)):oA(Object(M)).forEach(function(k){Object.defineProperty(L,k,Object.getOwnPropertyDescriptor(M,k))})}return L}let fI="function"==typeof fetch&&"function"==typeof Request&&"function"==typeof Response,fv=fI&&"function"==typeof ReadableStream,fC=fI&&("function"==typeof TextEncoder?(ic=new TextEncoder,L=>ic.encode(L)):async L=>new Uint8Array(await new Response(L).arrayBuffer())),uA=function(L){try{for(var k=arguments.length,M=Array(k>1?k-1:0),U=1;U<k;U++)M[U-1]=arguments[U];return!!L(...M)}catch(L){return!1}},fy=fv&&uA(()=>{let L=!1,k=new Request(m0.origin,{body:new ReadableStream,method:"POST",get duplex(){return L=!0,"half"}}).headers.has("Content-Type");return L&&!k}),fA=fv&&uA(()=>_7.isReadableStream(new Response("").body)),fb={stream:fA&&(L=>L.body)};fI&&(il=new Response,["text","arrayBuffer","blob","formData","stream"].forEach(L=>{fb[L]||(fb[L]=_7.isFunction(il[L])?k=>k[L]():(k,M)=>{throw new cR("Response type '".concat(L,"' is not supported"),cR.ERR_NOT_SUPPORT,M)})}));let mA=async(L,k)=>{let M=_7.toFiniteNumber(L.getContentLength());return null==M?(async L=>{if(null==L)return 0;if(_7.isBlob(L))return L.size;if(_7.isSpecCompliantForm(L)){let k=new Request(m0.origin,{method:"POST",body:L});return(await k.arrayBuffer()).byteLength}return _7.isArrayBufferView(L)||_7.isArrayBuffer(L)?L.byteLength:(_7.isURLSearchParams(L)&&(L+=""),_7.isString(L)?(await fC(L)).byteLength:void 0)})(k):M};var fD=fI&&(async L=>{let k,{url:M,method:U,data:V,signal:F,cancelToken:B,timeout:j,onDownloadProgress:G,onUploadProgress:X,responseType:$,headers:ee,withCredentials:et="same-origin",fetchOptions:ei}=jb(L);$=$?($+"").toLowerCase():"text";let er,en=Wb([F,B&&B.toAbortSignal()],j),ea=en&&en.unsubscribe&&(()=>{en.unsubscribe()});try{if(X&&fy&&"get"!==U&&"head"!==U&&0!==(k=await mA(ee,V))){let L,U=new Request(M,{method:"POST",body:V,duplex:"half"});if(_7.isFormData(V)&&(L=U.headers.get("content-type"))&&ee.setContentType(L),U.body){let[L,M]=Lb(k,Pb(kb(X)));V=rA(U.body,65536,L,M)}}_7.isString(et)||(et=et?"include":"omit");let F="credentials"in Request.prototype;er=new Request(M,sA(sA({},ei),{},{signal:en,method:U.toUpperCase(),headers:ee.normalize().toJSON(),body:V,duplex:"half",credentials:F?et:void 0}));let B=await fetch(er),j=fA&&("stream"===$||"response"===$);if(fA&&(G||j&&ea)){let L={};["status","statusText","headers"].forEach(k=>{L[k]=B[k]});let k=_7.toFiniteNumber(B.headers.get("content-length")),[M,U]=G&&Lb(k,Pb(kb(G),!0))||[];B=new Response(rA(B.body,65536,M,()=>{U&&U(),ea&&ea()}),L)}$=$||"text";let eo=await fb[_7.findKey(fb,$)||"text"](B,L);return!j&&ea&&ea(),await new lQ((k,M)=>{Db(k,M,{data:eo,headers:bb.from(B.headers),status:B.status,statusText:B.statusText,config:L,request:er})})}catch(k){if(ea&&ea(),k&&"TypeError"===k.name&&/Load failed|fetch/i.test(k.message))throw Object.assign(new cR("Network Error",cR.ERR_NETWORK,L,er),{cause:k.cause||k});throw cR.from(k,k&&k.code,L,er)}});let fP={http:null,xhr:f_,fetch:fD};_7.forEach(fP,(L,k)=>{if(L){try{Object.defineProperty(L,"name",{value:k})}catch(L){}Object.defineProperty(L,"adapterName",{value:k})}});let gA=L=>"- ".concat(L),TA=L=>_7.isFunction(L)||null===L||!1===L;var fL={getAdapter:L=>{let k,M;L=_7.isArray(L)?L:[L];let{length:U}=L,V={};for(let F=0;F<U;F++){let U;if(M=k=L[F],!TA(k)&&void 0===(M=fP[(U=String(k)).toLowerCase()]))throw new cR("Unknown adapter '".concat(U,"'"));if(M)break;V[U||"#"+F]=M}if(!M){let L=Object.entries(V).map(L=>{let[k,M]=L;return"adapter ".concat(k," ")+(!1===M?"is not supported by the environment":"is not available in the build")});throw new cR("There is no suitable adapter to dispatch the request "+(U?L.length>1?"since :\n"+L.map(gA).join("\n"):" "+gA(L[0]):"as no adapter specified"),"ERR_NOT_SUPPORT")}return M},adapters:fP};function vA(L){if(L.cancelToken&&L.cancelToken.throwIfRequested(),L.signal&&L.signal.aborted)throw new Nb(null,L)}function CA(L){return vA(L),L.headers=bb.from(L.headers),L.data=wb.call(L,L.transformRequest),-1!==["post","put","patch"].indexOf(L.method)&&L.headers.setContentType("application/x-www-form-urlencoded",!1),fL.getAdapter(L.adapter||fc.adapter)(L).then(function(k){return vA(L),k.data=wb.call(L,L.transformResponse,k),k.headers=bb.from(k.headers),k},function(k){return Ob(k)||(vA(L),k&&k.response&&(k.response.data=wb.call(L,L.transformResponse,k.response),k.response.headers=bb.from(k.response.headers))),lQ.reject(k)})}let fk="1.9.0",fM={};["object","boolean","number","function","string","symbol"].forEach((L,k)=>{fM[L]=function(M){return typeof M===L||"a"+(k<1?"n ":" ")+L}});let fU={};fM.transitional=function(L,k,M){function n(L,k){return"[Axios v"+fk+"] Transitional option '"+L+"'"+k+(M?". "+M:"")}return(M,U,V)=>{if(!1===L)throw new cR(n(U," has been removed"+(k?" in "+k:"")),cR.ERR_DEPRECATED);return k&&!fU[U]&&(fU[U]=!0,console.warn(n(U," has been deprecated since v"+k+" and will be removed in the near future"))),!L||L(M,U,V)}},fM.spelling=function(L){return(k,M)=>(console.warn("".concat(M," is likely a misspelling of ").concat(L)),!0)};var fV={assertOptions:function(L,k,M){if("object"!=typeof L)throw new cR("options must be an object",cR.ERR_BAD_OPTION_VALUE);let U=Object.keys(L),V=U.length;for(;V-- >0;){let F=U[V],B=k[F];if(B){let k=L[F],M=void 0===k||B(k,F,L);if(!0!==M)throw new cR("option "+F+" must be "+M,cR.ERR_BAD_OPTION_VALUE)}else if(!0!==M)throw new cR("Unknown option "+F,cR.ERR_BAD_OPTION)}},validators:fM};let fF=fV.validators,fj=class{constructor(L){this.defaults=L||{},this.interceptors={request:new Ea,response:new Ea}}async request(L,k){try{return await this._request(L,k)}catch(L){if(L instanceof Error){let k={};Error.captureStackTrace?Error.captureStackTrace(k):k=Error();let M=k.stack?k.stack.replace(/^.+\n/,""):"";try{L.stack?M&&!String(L.stack).endsWith(M.replace(/^.+\n.+\n/,""))&&(L.stack+="\n"+M):L.stack=M}catch(L){}}throw L}}_request(L,k){let M;"string"==typeof L?(k=k||{}).url=L:k=L||{},k=Bb(this.defaults,k);let{transitional:U,paramsSerializer:V,headers:F}=k;void 0!==U&&fV.assertOptions(U,{silentJSONParsing:fF.transitional(fF.boolean),forcedJSONParsing:fF.transitional(fF.boolean),clarifyTimeoutError:fF.transitional(fF.boolean)},!1),null!=V&&(_7.isFunction(V)?k.paramsSerializer={serialize:V}:fV.assertOptions(V,{encode:fF.function,serialize:fF.function},!0)),void 0!==k.allowAbsoluteUrls||(void 0!==this.defaults.allowAbsoluteUrls?k.allowAbsoluteUrls=this.defaults.allowAbsoluteUrls:k.allowAbsoluteUrls=!0),fV.assertOptions(k,{baseUrl:fF.spelling("baseURL"),withXsrfToken:fF.spelling("withXSRFToken")},!0),k.method=(k.method||this.defaults.method||"get").toLowerCase();let B=F&&_7.merge(F.common,F[k.method]);F&&_7.forEach(["delete","get","head","post","put","patch","common"],L=>{delete F[L]}),k.headers=bb.concat(B,F);let j=[],G=!0;this.interceptors.request.forEach(function(L){"function"==typeof L.runWhen&&!1===L.runWhen(k)||(G=G&&L.synchronous,j.unshift(L.fulfilled,L.rejected))});let X=[];this.interceptors.response.forEach(function(L){X.push(L.fulfilled,L.rejected)});let $,ee=0;if(!G){let L=[CA.bind(this),void 0];for(L.unshift.apply(L,j),L.push.apply(L,X),$=L.length,M=lQ.resolve(k);ee<$;)M=M.then(L[ee++],L[ee++]);return M}$=j.length;let et=k;for(ee=0;ee<$;){let L=j[ee++],k=j[ee++];try{et=L(et)}catch(L){k.call(this,L);break}}try{M=CA.call(this,et)}catch(L){return lQ.reject(L)}for(ee=0,$=X.length;ee<$;)M=M.then(X[ee++],X[ee++]);return M}getUri(L){return TR(Vb((L=Bb(this.defaults,L)).baseURL,L.url,L.allowAbsoluteUrls),L.params,L.paramsSerializer)}};_7.forEach(["delete","get","head","options"],function(L){fj.prototype[L]=function(k,M){return this.request(Bb(M||{},{method:L,url:k,data:(M||{}).data}))}}),_7.forEach(["post","put","patch"],function(L){function t(k){return function(M,U,V){return this.request(Bb(V||{},{method:L,headers:k?{"Content-Type":"multipart/form-data"}:{},url:M,data:U}))}}fj.prototype[L]=t(),fj.prototype[L+"Form"]=t(!0)});let DA=class DA{constructor(L){let k;if("function"!=typeof L)throw TypeError("executor must be a function.");this.promise=new lQ(function(L){k=L});let M=this;this.promise.then(L=>{if(!M._listeners)return;let k=M._listeners.length;for(;k-- >0;)M._listeners[k](L);M._listeners=null}),this.promise.then=L=>{let k;let U=new lQ(L=>{M.subscribe(L),k=L}).then(L);return U.cancel=function(){M.unsubscribe(k)},U},L(function(L,U,V){M.reason||(M.reason=new Nb(L,U,V),k(M.reason))})}throwIfRequested(){if(this.reason)throw this.reason}subscribe(L){this.reason?L(this.reason):this._listeners?this._listeners.push(L):this._listeners=[L]}unsubscribe(L){if(!this._listeners)return;let k=this._listeners.indexOf(L);-1!==k&&this._listeners.splice(k,1)}toAbortSignal(){let L=new AbortController,t=k=>{L.abort(k)};return this.subscribe(t),L.signal.unsubscribe=()=>this.unsubscribe(t),L.signal}static source(){let L;let k=new DA(function(k){L=k});return{token:k,cancel:L}}};let fW={Continue:100,SwitchingProtocols:101,Processing:102,EarlyHints:103,Ok:200,Created:201,Accepted:202,NonAuthoritativeInformation:203,NoContent:204,ResetContent:205,PartialContent:206,MultiStatus:207,AlreadyReported:208,ImUsed:226,MultipleChoices:300,MovedPermanently:301,Found:302,SeeOther:303,NotModified:304,UseProxy:305,Unused:306,TemporaryRedirect:307,PermanentRedirect:308,BadRequest:400,Unauthorized:401,PaymentRequired:402,Forbidden:403,NotFound:404,MethodNotAllowed:405,NotAcceptable:406,ProxyAuthenticationRequired:407,RequestTimeout:408,Conflict:409,Gone:410,LengthRequired:411,PreconditionFailed:412,PayloadTooLarge:413,UriTooLong:414,UnsupportedMediaType:415,RangeNotSatisfiable:416,ExpectationFailed:417,ImATeapot:418,MisdirectedRequest:421,UnprocessableEntity:422,Locked:423,FailedDependency:424,TooEarly:425,UpgradeRequired:426,PreconditionRequired:428,TooManyRequests:429,RequestHeaderFieldsTooLarge:431,UnavailableForLegalReasons:451,InternalServerError:500,NotImplemented:501,BadGateway:502,ServiceUnavailable:503,GatewayTimeout:504,HttpVersionNotSupported:505,VariantAlsoNegotiates:506,InsufficientStorage:507,LoopDetected:508,NotExtended:510,NetworkAuthenticationRequired:511};Object.entries(fW).forEach(L=>{let[k,M]=L;fW[M]=k});let fG=function e(L){let k=new fj(L),M=ST(fj.prototype.request,k);return _7.extend(M,fj.prototype,k,{allOwnKeys:!0}),_7.extend(M,k,null,{allOwnKeys:!0}),M.create=function(k){return e(Bb(L,k))},M}(fc);fG.Axios=fj,fG.CanceledError=Nb,fG.CancelToken=DA,fG.isCancel=Ob,fG.VERSION=fk,fG.toFormData=ER,fG.AxiosError=cR,fG.Cancel=fG.CanceledError,fG.all=function(L){return lQ.all(L)},fG.spread=function(L){return function(k){return L.apply(null,k)}},fG.isAxiosError=function(L){return _7.isObject(L)&&!0===L.isAxiosError},fG.mergeConfig=Bb,fG.AxiosHeaders=bb,fG.formToJSON=L=>Sb(_7.isHTMLForm(L)?new FormData(L):L),fG.getAdapter=fL.getAdapter,fG.HttpStatusCode=fW,fG.default=fG;let VA=()=>{};function xA(){let L={promise:void 0,isResolved:!1,isRejected:!1,isFinished:!1,resolve:void 0,reject:void 0,cancel:VA};return L.promise=new lQ((k,M)=>{L.resolve=M=>{L.isFinished||(L.isResolved=!0,L.isFinished=!0,k(M),L.value=M)},L.reject=k=>{L.isFinished||(L.isRejected=!0,L.isFinished=!0,M(k))}}),L}let fH=new Map,fY=new Map,fJ=new Map,fX=((er={}).WIN_10="Windows 10",er.WIN_81="Windows 8.1",er.WIN_8="Windows 8",er.WIN_7="Windows 7",er.WIN_VISTA="Windows Vista",er.WIN_SERVER_2003="Windows Server 2003",er.WIN_XP="Windows XP",er.WIN_2000="Windows 2000",er.ANDROID="Android",er.HARMONY_OS="HarmonyOS",er.OPEN_BSD="Open BSD",er.SUN_OS="Sun OS",er.LINUX="Linux",er.IOS="iOS",er.MAC_OS="Mac OS",er.CHROMIUM_OS="Chromium OS",er.QNX="QNX",er.UNIX="UNIX",er.BEOS="BeOS",er.OS_2="OS/2",er.SEARCH_BOT="Search Bot",er),fQ=((en={}).CHROME="Chrome",en.SAFARI="Safari",en.EDGE="Edge",en.FIREFOX="Firefox",en.OPERA="OPR",en.QQ="QQBrowser",en.WECHAT="MicroMessenger",en),fZ=new _g,f$=fZ.getResult(),f0=null;function zA(L){if(!f0){var k;L&&fZ.setUA(L),f$=fZ.getResult();let M=function(L){if("Blink"===L.engine.name&&"WeChat"!==L.browser.name)return fQ.CHROME;switch(L.browser.name){case"Chrome Headless":case"Chrome":case"Chromium":return fQ.CHROME;case"Safari":case"Mobile Safari":return fQ.SAFARI;case"Edge":return fQ.EDGE;case"Firefox":return fQ.FIREFOX;case"QQ":case"QQBrowser":return fQ.QQ;case"Opera":return fQ.OPERA;case"WeChat":return fQ.WECHAT;default:return L.browser.name||""}}(f$),U=qA(f$),V="Windows"===(k=f$).os.name?k.os.version?k.os.name+" "+k.os.version:k.os.name:k.os.name||"",F=f$.os.version,B=qA(f$,!1),j=f$.device.type;if(!(M&&U&&V&&F))return{name:M,version:U,os:V,osVersion:F,browserVersion:B,deviceType:j};f0={name:M,version:U,os:V,osVersion:F,browserVersion:B,deviceType:j}}return f0}function qA(L){let k,M=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return k="Blink"===L.engine.name?L.engine.version||"":L.browser.version||"",M?k.split(".")[0]:k}function XA(){return zA().os}function JA(){let L=zA();return"".concat(L.os," ").concat(L.osVersion)}function ZA(){let L=zA();return!!("WebKit"===f$.engine.name&&L.os===fX.MAC_OS&&navigator.maxTouchPoints&&navigator.maxTouchPoints>0&&L.name!==fQ.SAFARI||nw()&&L.name!==fQ.SAFARI)}function QA(){return zA().name===fQ.CHROME}function $A(){return zA().name===fQ.SAFARI}function ew(){let L=zA();if(L.name!==fQ.SAFARI||!L.browserVersion)return!1;let k=L.browserVersion.split(".");return Number(k[0])>15||15===Number(k[0])&&Number(k[1])>=4}function tw(){return zA().name===fQ.EDGE}function iw(){return zA().name===fQ.FIREFOX}function nw(){return zA().os===fX.IOS}function rw(L){let k=zA();return!(k.name!==fQ.CHROME||!k.osVersion)&&Number(k.version)>=L}function ow(L){let k=zA();return!(k.name!==fQ.CHROME||!k.osVersion)&&Number(k.version)<L}function sw(L,k,M){let U=zA();return!(U.name!==L||!U.osVersion)&&(M?Number(U.version)>=k&&Number(U.version)<=M:Number(U.version)===k)}function aw(L){let k=zA();return!(k.name!==fQ.EDGE||!k.osVersion)&&Number(k.version)>=L}function cw(L){let k=zA();return!(k.name!==fQ.FIREFOX||!k.osVersion)&&Number(k.version)>=L}function dw(L){let k=zA();return!(k.name!==fQ.SAFARI||!k.osVersion)&&Number(k.version)>=L}function lw(L,k,M){let U=zA();if(U.os!==fX.IOS||!U.osVersion)return!1;let V=U.osVersion.split(".");return M?k&&Number(V[0])===L&&Number(V[1])>k||Number(V[0])>L:k?Number(V[0])===L&&Number(V[1])>=k||Number(V[0])>L:Number(V[0])>=L}function uw(L,k,M){let U=zA();if(U.os!==fX.IOS||!U.osVersion)return!1;let V=U.osVersion.split(".");return M?k&&Number(V[0])===L&&Number(V[1])<k||Number(V[0])<L:k?Number(V[0])===L&&Number(V[1])<=k||Number(V[0])<L:Number(V[0])<=L}function hw(L,k,M){let U=zA();if(U.name!==fQ.SAFARI||!U.osVersion||!U.browserVersion)return!1;let V=U.browserVersion.split(".");return M?k&&Number(V[0])===L&&Number(V[1])<k||Number(V[0])<L:k?Number(V[0])===L&&Number(V[1])<=k||Number(V[0])<L:Number(V[0])<=L}function pw(L){let k=zA();return!(k.name!==fQ.OPERA||!k.osVersion)&&Number(k.version)>=L}function _w(){let L=zA();if(L.os!==fX.IOS||!L.osVersion)return!1;let k=L.osVersion.split(".");return 14>Number(k[0])||14===Number(k[0])&&6>=Number(k[1])}function Ew(){let L=zA();if(L.os!==fX.IOS||!L.osVersion)return!1;let k=L.osVersion.split(".");return 15===Number(k[0])}function mw(){let L=zA();if(L.os!==fX.IOS||!L.osVersion)return!1;let k=L.osVersion.split(".");return 16===Number(k[0])}function fw(){let L=zA();if(L.os!==fX.IOS||!L.osVersion)return!1;let k=L.osVersion.split(".");return 15===Number(k[0])&&Number(k[1])>=1}function Sw(){return $A()&&navigator.maxTouchPoints>0}function gw(){return zA().name===fQ.WECHAT}function Tw(){return window.navigator.appVersion&&null!==window.navigator.appVersion.match(/Chrome\/([\w\W]*?)\./)&&window.navigator.appVersion.match(/Chrome\/([\w\W]*?)\./)[1]<=35}function Rw(){let L=XA();return function(){let{deviceType:L}=zA();return"mobile"===L||"tablet"===L}()||L===fX.ANDROID||L===fX.IOS||L===fX.HARMONY_OS}function vw(){let L=zA();return L.name!==fQ.EDGE&&L.name!==fQ.SAFARI&&!!navigator.userAgent.toLocaleLowerCase().match(/chrome\/[\d]./i)}function Cw(){return XA()===fX.ANDROID}function yw(){let L=zA();return Cw()&&(L.name===fQ.CHROME||L.name===fQ.WECHAT||/chrome|chromium/i.test(navigator.userAgent))}function Iw(L,k,M){var U;return(k="symbol"==typeof(U=function(L,k){if("object"!=typeof L||!L)return L;var M=L[Symbol.toPrimitive];if(void 0!==M){var U=M.call(L,"string");if("object"!=typeof U)return U;throw TypeError("@@toPrimitive must return a primitive value.")}return String(L)}(k))?U:U+"")in L?Object.defineProperty(L,k,{value:M,enumerable:!0,configurable:!0,writable:!0}):L[k]=M,L}function bw(L,k){var M=Object.keys(L);if(Object.getOwnPropertySymbols){var U=Object.getOwnPropertySymbols(L);k&&(U=U.filter(function(k){return Object.getOwnPropertyDescriptor(L,k).enumerable})),M.push.apply(M,U)}return M}function Aw(L){for(var k=1;k<arguments.length;k++){var M=null!=arguments[k]?arguments[k]:{};k%2?bw(Object(M),!0).forEach(function(k){Iw(L,k,M[k])}):Object.getOwnPropertyDescriptors?Object.defineProperties(L,Object.getOwnPropertyDescriptors(M)):bw(Object(M)).forEach(function(k){Object.defineProperty(L,k,Object.getOwnPropertyDescriptor(M,k))})}return L}let f1=((ea={}).UNEXPECTED_ERROR="UNEXPECTED_ERROR",ea.UNEXPECTED_RESPONSE="UNEXPECTED_RESPONSE",ea.TIMEOUT="TIMEOUT",ea.INVALID_PARAMS="INVALID_PARAMS",ea.NOT_READABLE="NOT_READABLE",ea.NOT_SUPPORTED="NOT_SUPPORTED",ea.INVALID_OPERATION="INVALID_OPERATION",ea.OPERATION_ABORTED="OPERATION_ABORTED",ea.WEB_SECURITY_RESTRICT="WEB_SECURITY_RESTRICT",ea.EXCHANGE_SDP_FAILED="EXCHANGE_SDP_FAILED",ea.ADD_CANDIDATE_FAILED="ADD_CANDIDATE_FAILED",ea.DATACHANNEL_FAILED="DATACHANNEL_FAILED",ea.NETWORK_ERROR="NETWORK_ERROR",ea.NETWORK_TIMEOUT="NETWORK_TIMEOUT",ea.NETWORK_RESPONSE_ERROR="NETWORK_RESPONSE_ERROR",ea.API_INVOKE_TIMEOUT="API_INVOKE_TIMEOUT",ea.ENUMERATE_DEVICES_FAILED="ENUMERATE_DEVICES_FAILED",ea.DEVICE_NOT_FOUND="DEVICE_NOT_FOUND",ea.ELECTRON_IS_NULL="ELECTRON_IS_NULL",ea.ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR="ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR",ea.CHROME_PLUGIN_NO_RESPONSE="CHROME_PLUGIN_NO_RESPONSE",ea.CHROME_PLUGIN_NOT_INSTALL="CHROME_PLUGIN_NOT_INSTALL",ea.MEDIA_OPTION_INVALID="MEDIA_OPTION_INVALID",ea.PERMISSION_DENIED="PERMISSION_DENIED",ea.CONSTRAINT_NOT_SATISFIED="CONSTRAINT_NOT_SATISFIED",ea.TRACK_IS_DISABLED="TRACK_IS_DISABLED",ea.GET_VIDEO_ELEMENT_VISIBLE_ERROR="GET_VIDEO_ELEMENT_VISIBLE_ERROR",ea.SHARE_AUDIO_NOT_ALLOWED="SHARE_AUDIO_NOT_ALLOWED",ea.LOW_STREAM_ENCODING_ERROR="LOW_STREAM_ENCODING_ERROR",ea.SET_ENCODING_PARAMETER_ERROR="SET_ENCODING_PARAMETER_ERROR",ea.TRACK_STATE_UNREACHABLE="TRACK_STATE_UNREACHABLE",ea.INVALID_UINT_UID_FROM_STRING_UID="INVALID_UINT_UID_FROM_STRING_UID",ea.CAN_NOT_GET_PROXY_SERVER="CAN_NOT_GET_PROXY_SERVER",ea.CAN_NOT_GET_GATEWAY_SERVER="CAN_NOT_GET_GATEWAY_SERVER",ea.VOID_GATEWAY_ADDRESS="VOID_GATEWAY_ADDRESS",ea.UID_CONFLICT="UID_CONFLICT",ea.MULTI_UNILBS_RESPONSE_ERROR="MULTI_UNILBS_RESPONSE_ERROR",ea.UPDATE_TICKET_FAILED="UPDATE_TICKET_FAILED",ea.TOKEN_EXPIRE="TOKEN_EXPIRE",ea.INVALID_LOCAL_TRACK="INVALID_LOCAL_TRACK",ea.INVALID_TRACK="INVALID_TRACK",ea.SENDER_NOT_FOUND="SENDER_NOT_FOUND",ea.CREATE_OFFER_FAILED="CREATE_OFFER_FAILED",ea.SET_ANSWER_FAILED="SET_ANSWER_FAILED",ea.ICE_FAILED="ICE_FAILED",ea.PC_CLOSED="PC_CLOSED",ea.SENDER_REPLACE_FAILED="SENDER_REPLACE_FAILED",ea.GET_LOCAL_CAPABILITIES_FAILED="GET_LOCAL_CAPABILITIES_FAILED",ea.GET_LOCAL_CONNECTION_PARAMS_FAILED="GET_LOCAL_CONNECTION_PARAMS_FAILED",ea.SUBSCRIBE_FAILED="SUBSCRIBE_FAILED",ea.UNSUBSCRIBE_FAILED="UNSUBSCRIBE_FAILED",ea.GATEWAY_P2P_LOST="GATEWAY_P2P_LOST",ea.NO_ICE_CANDIDATE="NO_ICE_CANDIDATE",ea.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS="CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS",ea.EXIST_DISABLED_VIDEO_TRACK="EXIST_DISABLED_VIDEO_TRACK",ea.INVALID_REMOTE_USER="INVALID_REMOTE_USER",ea.REMOTE_USER_IS_NOT_PUBLISHED="REMOTE_USER_IS_NOT_PUBLISHED",ea.CUSTOM_REPORT_SEND_FAILED="CUSTOM_REPORT_SEND_FAILED",ea.CUSTOM_REPORT_FREQUENCY_TOO_HIGH="CUSTOM_REPORT_FREQUENCY_TOO_HIGH",ea.FETCH_AUDIO_FILE_FAILED="FETCH_AUDIO_FILE_FAILED",ea.READ_LOCAL_AUDIO_FILE_ERROR="READ_LOCAL_AUDIO_FILE_ERROR",ea.DECODE_AUDIO_FILE_FAILED="DECODE_AUDIO_FILE_FAILED",ea.WS_ABORT="WS_ABORT",ea.WS_DISCONNECT="WS_DISCONNECT",ea.WS_ERR="WS_ERR",ea.EXTERNAL_SIGNAL_ABORT="EXTERNAL_SIGNAL_ABORT",ea.LIVE_STREAMING_TASK_CONFLICT="LIVE_STREAMING_TASK_CONFLICT",ea.LIVE_STREAMING_INVALID_ARGUMENT="LIVE_STREAMING_INVALID_ARGUMENT",ea.LIVE_STREAMING_INTERNAL_SERVER_ERROR="LIVE_STREAMING_INTERNAL_SERVER_ERROR",ea.LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED="LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED",ea.LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED="LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED",ea.LIVE_STREAMING_CDN_ERROR="LIVE_STREAMING_CDN_ERROR",ea.LIVE_STREAMING_INVALID_RAW_STREAM="LIVE_STREAMING_INVALID_RAW_STREAM",ea.LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT="LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT",ea.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE="LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE",ea.LIVE_STREAMING_WARN_FREQUENT_REQUEST="LIVE_STREAMING_WARN_FREQUENT_REQUEST",ea.WEBGL_INTERNAL_ERROR="WEBGL_INTERNAL_ERROR",ea.BEAUTY_PROCESSOR_INTERNAL_ERROR="BEAUTY_PROCESSOR_INTERNAL_ERROR",ea.CROSS_CHANNEL_WAIT_STATUS_ERROR="CROSS_CHANNEL_WAIT_STATUS_ERROR",ea.CROSS_CHANNEL_FAILED_JOIN_SRC="CROSS_CHANNEL_FAILED_JOIN_SEC",ea.CROSS_CHANNEL_FAILED_JOIN_DEST="CROSS_CHANNEL_FAILED_JOIN_DEST",ea.CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST="CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST",ea.CROSS_CHANNEL_SERVER_ERROR_RESPONSE="CROSS_CHANNEL_SERVER_ERROR_RESPONSE",ea.METADATA_OUT_OF_RANGE="METADATA_OUT_OF_RANGE",ea.LOCAL_AEC_ERROR="LOCAL_AEC_ERROR",ea.INVALID_PLUGIN="INVALID_PLUGIN",ea.DISCONNECT_P2P="DISCONNECT_P2P",ea.CONVERTING_IMAGEDATA_TO_BLOB_FAILED="CONVERTING_IMAGEDATA_TO_BLOB_FAILED",ea.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED="CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED",ea.INIT_DATACHANNEL_TIMEOUT="INIT_DATACHANNEL_TIMEOUT",ea.CREATE_DATACHANNEL_ERROR="CREATE_DATACHANNEL_ERROR",ea.DATACHANNEL_CONNECTION_TIMEOUT="DATACHANNEL_CONNECTION_TIMEOUT",ea.PROHIBITED_OPERATION="PROHIBITED_OPERATION",ea.IMAGE_MODERATION_UPLOAD_FAILED="IMAGE_MODERATION_UPLOAD_FAILED",ea.P2P_MESSAGE_FAILED="P2P_MESSAGE_FAILED",ea),f2=class extends Error{constructor(L){let k=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",M=arguments.length>2?arguments[2]:void 0;super(k),Iw(this,"code",void 0),Iw(this,"message",void 0),Iw(this,"data",void 0),Iw(this,"name","AgoraRTCException"),this.code=L,this.message="AgoraRTCError ".concat(this.code,": ").concat(k),this.data=M}toString(){return this.data?"".concat(this.message,"\ndata: ").concat(JSON.stringify(this.data)):this.message}print(){let L=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"error",k=arguments.length>1?arguments[1]:void 0;return"error"===L&&(k||console).error(this.toString()),"warning"===L&&(k||console).warn(this.toString()),this}throw(L){throw this.print("error",L),this}};function Nw(L,k){if("boolean"!=typeof L)throw new f2(f1.INVALID_PARAMS,"Invalid ".concat(k,": The value is of the boolean type."))}function Dw(L,k,M){if(!so(M).call(M,L))throw new f2(f1.INVALID_PARAMS,"".concat(k," can only be set as ").concat(JSON.stringify(M)))}function Pw(L,k){let M=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,U=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1e4;if(L<M||L>U||(!(arguments.length>4&&void 0!==arguments[4])||arguments[4])&&!("number"==typeof L&&L%1==0))throw new f2(f1.INVALID_PARAMS,"invalid ".concat(k,": the value range is [").concat(M,", ").concat(U,"]. integer only"))}function Lw(L,k){if("number"!=typeof L){if(!(L.min||L.max||L.ideal||L.exact))throw new f2(f1.INVALID_PARAMS,"".concat(k," is not a valid ConstrainLong"));void 0!==L.min&&Pw(L.min,"".concat(k,".min"),0,1/0),void 0!==L.max&&Pw(L.max,"".concat(k,".max"),1,1/0),void 0!==L.exact&&Pw(L.exact,"".concat(k,".exact"),1,1/0),void 0!==L.ideal&&Pw(L.ideal,"".concat(k,".ideal"),1,1/0)}else Pw(L,k,1,1/0)}function kw(L,k){let M=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,U=arguments.length>3&&void 0!==arguments[3]?arguments[3]:255,V=!(arguments.length>4&&void 0!==arguments[4])||arguments[4];if(null==L)throw new f2(f1.INVALID_PARAMS,"".concat(k||"param"," cannot be empty"));if(!Vw(L,M,U,V))throw new f2(f1.INVALID_PARAMS,"Invalid ".concat(k||"string param",": Length of the string: [").concat(M,",").concat(U,"].").concat(V?" ASCII characters only.":""))}function Mw(L,k){if(!Array.isArray(L))throw new f2(f1.INVALID_PARAMS,"".concat(k," should be an array"))}function Uw(L){return null==L}function Vw(L){let k=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,M=arguments.length>2&&void 0!==arguments[2]?arguments[2]:255,U=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];return"string"==typeof L&&L.length<=M&&L.length>=k&&(!U||function(L){if("string"!=typeof L)return!1;for(let k=0;k<L.length;k+=1){let M=L.charCodeAt(k);if(M<0||M>255)return!1}return!0}(L))}var f3=((eo=f3||{}).COVERED="COVERED",eo.POSITION="POSITION",eo.SIZE="SIZE",eo.STYLE="STYLE",eo),f5=((es=f5||{}).UNMOUNTED="UNMOUNTED",es.INVALID_HTML_ELEMENT="INVALID_HTML_ELEMENT",es);let f4=new class{constructor(){Iw(this,"_clientSize",null),Iw(this,"getClientWidth",()=>document.documentElement?document.documentElement.clientWidth:document.body.clientWidth),Iw(this,"getClientHeight",()=>document.documentElement?document.documentElement.clientHeight:document.body.clientHeight),Iw(this,"getStyle",L=>window.getComputedStyle(L,null)),Iw(this,"checkCssVisibleProperty",L=>{var k;let M=!0,U=this.getStyle(L),{display:V,visibility:F,opacity:B,filter:j}=U;return("none"===V||so(k=["hidden","collapse"]).call(k,F)||.1>Number(B))&&(M=!1),!!M&&(j&&j.split(" ").filter(L=>{var k;let M=L.split("(")[0];return so(k=["brightness","blur","opacity"]).call(k,M)}).map(L=>{let[k,M]=L.split(/\(|\)/);return[k,Number(M.match(/^[0-9\.]+/))]}).forEach(L=>{let[k,U]=L;switch(k){case"brightness":(U<.1||U>3)&&(M=!1);break;case"blur":U>3&&(M=!1);break;case"opacity":U<.1&&(M=!1)}}),M)}),Iw(this,"checkPropertyUpToAllParentNodes",(L,k)=>{let M=!0,U=!0,r=L=>k(L),V=L;for(;V&&U;)r(V)||(M=!1,U=!1),(V=V.parentElement)||(U=!1);return M}),Iw(this,"checkActualCssVisibleIncludeInherit",L=>this.checkPropertyUpToAllParentNodes(L,this.checkCssVisibleProperty)),Iw(this,"getSizeAboutClient",L=>{let{width:k,height:M,left:U,right:V,top:F,bottom:B}=L.getBoundingClientRect(),j=this.getClientWidth(),G=this.getClientHeight();return{width:k,height:M,left:U,right:V,top:F,bottom:B,clientWidth:j,clientHeight:G,clientMin:Math.min(j,G)}}),Iw(this,"checkActualSize",()=>{let{width:L,height:k,clientMin:M}=this._clientSize;return this.checkSizeIsVisible(L,k,M)}),Iw(this,"elementFromPoint",(L,k)=>document.elementFromPoint?document.elementFromPoint(L,k):null),Iw(this,"checkCoverForAPoint",(L,k,M)=>{let U=this.elementFromPoint(L,k);return null!==U&&U!==M}),Iw(this,"getPointPositionList",()=>{let{width:L,height:k,left:M,top:U}=this._clientSize,V=L/6,F=k/6,B=[];for(let L=0;L<5;L++)for(let k=0;k<5;k++){let j=(1e6*M+(0===L?.1:4===L?(V*L*1e6-1e5)/1e6:V*L)*1e6)/1e6,G=(1e6*U+(0===k?.1:4===k?(F*k*1e6-1e5)/1e6:F*k)*1e6)/1e6;B.push({x:j,y:G})}return[...B]}),Iw(this,"checkElementCover",L=>this.getPointPositionList().map(k=>this.checkCoverForAPoint(k.x,k.y,L)).filter(L=>!!L).length>6),Iw(this,"checkSizeIsVisible",(L,k,M)=>(L>50||M/L<=10)&&(k>50||M/k<=10)),Iw(this,"checkSizeOfPartInClient",()=>{let L,k;let{left:M,right:U,top:V,bottom:F,clientHeight:B,clientWidth:j,clientMin:G}=this._clientSize;if(M<0)L=0;else{if(!(M<j))return!1;L=M}if(U<0)return!1;if(V<0)k=0;else{if(!(V<B))return!1;k=V}if(F<0)return!1;let X=(U<j?U:j)-L,$=(F<B?F:B)-k;return this.checkSizeIsVisible(X,$,G)}),Iw(this,"returnHiddenResult",L=>(this._clientSize=null,{visible:!1,reason:L})),Iw(this,"checkOneElementVisible",L=>{if(L instanceof HTMLElement){if(this.checkElementIsMountedOnDom(L)){if(this.checkActualCssVisibleIncludeInherit(L)){if(this._clientSize=this.getSizeAboutClient(L),this.checkElementCover(L))return this.returnHiddenResult(f3.COVERED);{let L=this.checkActualSize(),k=this.checkSizeOfPartInClient();return L&&!k?this.returnHiddenResult(f3.POSITION):L?(this._clientSize=null,{visible:!0}):this.returnHiddenResult(f3.SIZE)}}return this.returnHiddenResult(f3.STYLE)}return this.returnHiddenResult(f5.UNMOUNTED)}return this.returnHiddenResult(f5.INVALID_HTML_ELEMENT)}),Iw(this,"checkElementIsMountedOnDom",L=>this.checkPropertyUpToAllParentNodes(L,L=>"HTML"!==L.nodeName.toUpperCase()?null!==L.parentElement:!!document.documentElement))}};function jw(L){return(new TextEncoder).encode(L)}let Gw=function(L,k){let M=new Uint8Array(L.byteLength+k.byteLength);return M.set(new Uint8Array(L),0),M.set(new Uint8Array(k),L.byteLength),M},Ww=async L=>{var k;let M;return k=await crypto.subtle.digest("SHA-256",jw(L)),M="",new Uint8Array(k).forEach(L=>{M+=L.toString(16).padStart(2,"0")}),M};let Hw=class Hw{constructor(){Iw(this,"_events",{}),Iw(this,"addListener",this.on)}getListeners(L){return this._events[L]?this._events[L].map(L=>L.listener):[]}on(L,k){this._events[L]||(this._events[L]=[]);let M=this._events[L];-1===this._indexOfListener(M,k)&&M.push({listener:k,once:!1})}once(L,k){this._events[L]||(this._events[L]=[]);let M=this._events[L];-1===this._indexOfListener(M,k)&&M.push({listener:k,once:!0})}off(L,k){if(!this._events[L])return;let M=this._events[L],U=this._indexOfListener(M,k);-1!==U&&M.splice(U,1),0===this._events[L].length&&delete this._events[L]}removeAllListeners(L){L?delete this._events[L]:this._events={}}emit(L){this._events[L]||(this._events[L]=[]);let k=this._events[L].map(L=>L);for(var M=arguments.length,U=Array(M>1?M-1:0),V=1;V<M;V++)U[V-1]=arguments[V];for(let M=0;M<k.length;M+=1){let V=k[M];V.once&&this.off(L,V.listener),V.listener.apply(this,U||[])}}safeEmit(L){for(var k=arguments.length,M=Array(k>1?k-1:0),U=1;U<k;U++)M[U-1]=arguments[U];[...this._events[L]||[]].forEach(k=>{k.once&&this.off(L,k.listener);try{k.listener.apply(this,M)}catch(k){console.error("safeEmit event:".concat(L," error ").concat(null==k?void 0:k.toString()))}})}_indexOfListener(L,k){let M=L.length;for(;M--;)if(L[M].listener===k)return M;return -1}};let f6=null;function Yw(){if(f6)return f6;if(window.electron)return f6=window.electron;if(!window.require)return null;try{return f6=window.require("electron")}catch(L){return null}}let f8=((ec={}).CREATE_CLIENT="createClient",ec.CHECK_SYSTEM_REQUIREMENTS="checkSystemRequirements",ec.SET_AREA="setArea",ec.PRELOAD="PRELOAD",ec.CHECK_VIDEO_TRACK_IS_ACTIVE="checkVideoTrackIsActive",ec.CHECK_AUDIO_TRACK_IS_ACTIVE="checkAudioTrackIsActive",ec.CREATE_MIC_AUDIO_TRACK="createMicrophoneAudioTrack",ec.CREATE_CUSTOM_AUDIO_TRACK="createCustomAudioTrack",ec.CREATE_BUFFER_AUDIO_TRACK="createBufferSourceAudioTrack",ec.CREATE_CAM_VIDEO_TRACK="createCameraVideoTrack",ec.CREATE_CUSTOM_VIDEO_TRACK="createCustomVideoTrack",ec.CREATE_MIC_AND_CAM_TRACKS="createMicrophoneAndCameraTracks",ec.CREATE_SCREEN_VIDEO_TRACK="createScreenVideoTrack",ec.SET_ENCRYPTION_CONFIG="Client.setEncryptionConfig",ec.START_PROXY_SERVER="Client.startProxyServer",ec.STOP_PROXY_SERVER="Client.stopProxyServer",ec.SET_PROXY_SERVER="Client.setProxyServer",ec.SET_TURN_SERVER="Client.setTurnServer",ec.SET_CLIENT_ROLE="Client.setClientRole",ec.SET_LOW_STREAM_PARAMETER="Client.setLowStreamParameter",ec.ENABLE_DUAL_STREAM="Client.enableDualStream",ec.DISABLE_DUAL_STREAM="Client.disableDualStream",ec.JOIN="Client.join",ec.LEAVE="Client.leave",ec.PUBLISH="Client.publish",ec.UNPUBLISH="Client.unpublish",ec.SUBSCRIBE="Client.subscribe",ec.MASS_SUBSCRIBE="Client.massSubscribe",ec.MASS_UNSUBSCRIBE="Client.massUnsubscribe",ec.UNSUBSCRIBE="Client.unsubscribe",ec.RENEW_TOKEN="Client.renewToken",ec.SET_REMOTE_VIDEO_STREAM_TYPE="Client.setRemoteVideoStreamType",ec.SET_STREAM_FALLBACK_OPTION="Client.setStreamFallbackOption",ec.ENABLE_AUDIO_VOLUME_INDICATOR="Client.enableAudioVolumeIndicator",ec.SEND_CUSTOM_REPORT_MESSAGE="Client.sendCustomReportMessage",ec.INSPECT_VIDEO_CONTENT="Client.inspectVideoContent",ec.STOP_INSPECT_VIDEO_CONTENT="Client.stopInspectVideoContent",ec.JOIN_FALLBACK_TO_PROXY="Client._joinFallbackToProxy",ec.ON_LIVE_STREAM_WARNING="Client.onLiveStreamWarning",ec.ON_LIVE_STREAM_ERROR="Client.onLiveStreamingError",ec.START_LIVE_STREAMING="Client.startLiveStreaming",ec.SET_LIVE_TRANSCODING="Client.setLiveTranscoding",ec.STOP_LIVE_STREAMING="Client.stopLiveStreaming",ec.START_CHANNEL_MEDIA_RELAY="Client.startChannelMediaRelay",ec.UPDATE_CHANNEL_MEDIA_RELAY="Client.updateChannelMediaRelay",ec.STOP_CHANNEL_MEDIA_RELAY="Client.stopChannelMediaRelay",ec.REQUEST_CONFIG_DISTRIBUTE="_config-distribute-request",ec.SET_CONFIG_DISTRIBUTE="_configDistribute",ec.LOCAL_TRACK_SET_MUTED="LocalTrack.setMute",ec.LOCAL_AUDIO_TRACK_PLAY="LocalAudioTrack.play",ec.LOCAL_AUDIO_TRACK_PLAY_IN_ELEMENT="LocalAudioTrack.playInElement",ec.LOCAL_AUDIO_TRACK_STOP="LocalAudioTrack.stop",ec.LOCAL_AUDIO_TRACK_SET_VOLUME="LocalAudioTrack.setVolume",ec.MIC_AUDIO_TRACK_SET_DEVICE="MicrophoneAudioTrack.setDevice",ec.BUFFER_AUDIO_TRACK_START="BufferSourceAudioTrack.startProcessAudioBuffer",ec.BUFFER_AUDIO_TRACK_STOP="BufferSourceAudioTrack.stopProcessAudioBuffer",ec.BUFFER_AUDIO_TRACK_PAUSE="BufferSourceAudioTrack.pauseProcessAudioBuffer",ec.BUFFER_AUDIO_TRACK_RESUME="BufferSourceAudioTrack.resumeProcessAudioBuffer",ec.BUFFER_AUDIO_TRACK_SEEK="BufferSourceAudioTrack.seekAudioBuffer",ec.LOCAL_VIDEO_TRACK_PLAY="LocalVideoTrack.play",ec.LOCAL_VIDEO_TRACK_STOP="LocalVideoTrack.stop",ec.LOCAL_VIDEO_TRACK_GET_VIDEO_VISIBLE="LocalVideoTrack.getVideoElementVisibleStatus",ec.LOCAL_VIDEO_TRACK_BEAUTY="LocalVideoTrack.setBeautyEffect",ec.LOCAL_VIDEO_SEND_SEI_DATA="LocalVideoTrack.sendSeiData",ec.CAM_VIDEO_TRACK_SET_DEVICE="CameraVideoTrack.setDevice",ec.CAM_VIDEO_TRACK_SET_ENCODER_CONFIG="CameraVideoTrack.setEncoderConfiguration",ec.REMOTE_VIDEO_TRACK_PLAY="RemoteVideoTrack.play",ec.REMOTE_VIDEO_TRACK_STOP="RemoteVideoTrack.stop",ec.REMOTE_VIDEO_TRACK_GET_VIDEO_VISIBLE="RemoteVideoTrack.getVideoElementVisibleStatus",ec.REMOTE_AUDIO_TRACK_PLAY="RemoteAudioTrack.play",ec.REMOTE_AUDIO_TRACK_STOP="RemoteAudioTrack.stop",ec.REMOTE_AUDIO_SET_VOLUME="RemoteAudioTrack.setVolume",ec.REMOTE_AUDIO_SET_OUTPUT_DEVICE="RemoteAudioTrack.setOutputDevice",ec.GET_MEDIA_STREAM_TRACK="Track.getMediaStreamTrack",ec.STREAM_TYPE_CHANGE="streamTypeChange",ec.CONNECTION_STATE_CHANGE="connectionStateChange",ec.LOAD_CONFIG_FROM_LOCALSTORAGE="loadConfigFromLocalStorage",ec.IMAGE_MODERATION_UPLOAD="imageModerationUpload",ec.REPUB_AFTER_PC_CONNECTED="repubAfterPCConnected",ec.PRELOAD_MEDIA_FAILED="preloadMediaFailed",ec.MISMATCH_DTLS_PARAMETERS="mismatchDtlsParameters",ec),f9=((ed={}).TRACER="tracer",ed);function Xw(L){return Pw(L.timeout,"config.timeout",0,1e5),Pw(L.timeoutFactor,"config.timeoutFactor",0,100,!1),Pw(L.maxRetryCount,"config.maxRetryConfig",0,1/0),Pw(L.maxRetryTimeout,"config.maxRetryTimeout",0,1/0),!0}let f7=((el={})[el.AUDIENCE_LEVEL_LOW_LATENCY=1]="AUDIENCE_LEVEL_LOW_LATENCY",el[el.AUDIENCE_LEVEL_ULTRA_LOW_LATENCY=2]="AUDIENCE_LEVEL_ULTRA_LOW_LATENCY",el[el.AUDIENCE_LEVEL_SYNC_LATENCY=3]="AUDIENCE_LEVEL_SYNC_LATENCY",el),Se=((eu={}).LEAVE="LEAVE",eu.NETWORK_ERROR="NETWORK_ERROR",eu.SERVER_ERROR="SERVER_ERROR",eu.UID_BANNED="UID_BANNED",eu.FALLBACK="FALLBACK",eu.IP_BANNED="IP_BANNED",eu.CHANNEL_BANNED="CHANNEL_BANNED",eu.LICENSE_MISSING="LICENSE_MISSING",eu.LICENSE_EXPIRED="LICENSE_EXPIRED",eu.LICENSE_MINUTES_EXCEEDED="LICENSE_MINUTES_EXCEEDED",eu.LICENSE_PERIOD_INVALID="LICENSE_PERIOD_INVALID",eu.LICENSE_MULTIPLE_SDK_SERVICE="LICENSE_MULTIPLE_SDK_SERVICE",eu.LICENSE_ILLEGAL="LICENSE_ILLEGAL",eu.TOKEN_EXPIRE="TOKEN_EXPIRE",eu);function Qw(L){if(!Array.isArray(L)||L.length<1)return!1;try{L.forEach(L=>{if(!L.urls)throw Error()})}catch(L){return!1}return!0}function $w(L){return kw(L.turnServerURL,"turnServerURL"),kw(L.username,"username"),kw(L.password,"password"),L.udpport&&Pw(L.udpport,"udpport",1,99999,!0),L.forceturn&&Nw(L.forceturn,"forceturn"),L.security&&Nw(L.security,"security"),L.tcpport&&Pw(L.tcpport,"tcpport",1,99999,!0),!0}function eO(L){return void 0!==L.level&&Dw(L.level,"level",[1,2,3]),void 0!==L.delay&&Pw(L.delay,"delay",0,3e3,!0),!0}let Si=((eh={}).PEERCONNECTION_STATE_CHANGE="peerconnection-state-change",eh.AUDIO_METADATA="audio-metadata",eh.AUDIO_PTS="audio-pts",eh.CONNECTION_STATE_CHANGE="connection-state-change",eh.MEDIA_RECONNECT_START="media-reconnect-start",eh.MEDIA_RECONNECT_END="media-reconnect-end",eh.IS_USING_CLOUD_PROXY="is-using-cloud-proxy",eh.USER_JOINED="user-joined",eh.USER_LEAVED="user-left",eh.USER_PUBLISHED="user-published",eh.USER_UNPUBLISHED="user-unpublished",eh.USER_INFO_UPDATED="user-info-updated",eh.CLIENT_BANNED="client-banned",eh.CHANNEL_MEDIA_RELAY_STATE="channel-media-relay-state",eh.CHANNEL_MEDIA_RELAY_EVENT="channel-media-relay-event",eh.VOLUME_INDICATOR="volume-indicator",eh.CRYPT_ERROR="crypt-error",eh.ON_TOKEN_PRIVILEGE_WILL_EXPIRE="token-privilege-will-expire",eh.ON_TOKEN_PRIVILEGE_DID_EXPIRE="token-privilege-did-expire",eh.NETWORK_QUALITY="network-quality",eh.STREAM_TYPE_CHANGED="stream-type-changed",eh.STREAM_FALLBACK="stream-fallback",eh.RECEIVE_METADATA="receive-metadata",eh.STREAM_MESSAGE="stream-message",eh.LIVE_STREAMING_ERROR="live-streaming-error",eh.LIVE_STREAMING_WARNING="live-streaming-warning",eh.EXCEPTION="exception",eh.ERROR="error",eh.P2P_LOST="p2p_lost",eh.JOIN_FALLBACK_TO_PROXY="join-fallback-to-proxy",eh.CHANNEL_FALLBACK_TO_WEBSOCKET="channel-fallback-to-websocket",eh.MEDIA_CONNECTION_TYPE_CHANGE="media-connection-type-change",eh.PUBLISHED_USER_LIST="published-user-list",eh.CONTENT_INSPECT_CONNECTION_STATE_CHANGE="content-inspect-connection-state-change",eh.CONTENT_INSPECT_ERROR="content-inspect-error",eh.CONTENT_INSPECT_RESULT="content-inspect-result",eh.IMAGE_MODERATION_CONNECTION_STATE_CHANGE="image-moderation-connection-state-change",eh),Sr=((ep={}).NETWORK_ERROR="NETWORK_ERROR",ep.SERVER_ERROR="SERVER_ERROR",ep.MULTI_IP="MULTI_IP",ep.TIMEOUT="TIMEOUT",ep.OFFLINE="OFFLINE",ep.LEAVE="LEAVE",ep.P2P_FAILED="P2P_FAILED",ep.FALLBACK="FALLBACK",ep.REGIONAL_DISTRIBUTION="REGIONAL_DISTRIBUTION",ep),Sa=((e_={}).ONLINE="ONLINE",e_.OFFLINE="OFFLINE",e_),So=((eE={}).NETWORK_STATE_CHANGE="NETWORK_STATE_CHANGE",eE.ONLINE="ONLINE",eE.OFFLINE="OFFLINE",eE);function oO(L,k){for(var M=arguments.length,U=Array(M>2?M-2:0),V=2;V<M;V++)U[V-2]=arguments[V];return 0===L.getListeners(k).length?lQ.reject(new f2(f1.UNEXPECTED_ERROR,"can not emit promise")):new lQ((M,V)=>{L.emit(k,...U,M,V)})}function sO(L,k){if(0===L.getListeners(k).length)return lQ.resolve();for(var M=arguments.length,U=Array(M>2?M-2:0),V=2;V<M;V++)U[V-2]=arguments[V];return oO(L,k,...U)}function aO(L,k){if(0===L.getListeners(k).length)return null;for(var M=arguments.length,U=Array(M>2?M-2:0),V=2;V<M;V++)U[V-2]=arguments[V];return cO(L,k,...U)}function cO(L,k){let M=null,U=null;for(var V=arguments.length,F=Array(V>2?V-2:0),B=2;B<V;B++)F[B-2]=arguments[B];if(L.emit(k,...F,L=>{M=L},L=>{U=L}),null!==U)throw U;if(null===M)throw new f2(f1.UNEXPECTED_ERROR,"handler is not sync");return M}let Ss=new class extends Hw{set networkState(L){this.emit(So.NETWORK_STATE_CHANGE,L,this._networkState),L===Sa.ONLINE?this.emit(So.ONLINE):L===Sa.OFFLINE&&(this.onlineWaiter=new lQ(L=>{this.once(So.ONLINE,()=>{this.onlineWaiter=void 0,L(Sa.ONLINE)})}),this.emit(So.OFFLINE)),this._networkState=L}get networkState(){return this._networkState}get isOnline(){return this._networkState===Sa.ONLINE}constructor(){super(),Iw(this,"_moduleName","network-indicator"),Iw(this,"_networkState",Sa.ONLINE),Iw(this,"onlineWaiter",void 0),window.addEventListener("online",()=>{this.networkState=Sa.ONLINE}),window.addEventListener("offline",()=>{this.networkState=Sa.OFFLINE})}};function lO(L,k){let M=L.indexOf(k);-1!==M&&L.splice(M,1)}function uO(L){let k=[];return L.forEach(L=>{-1===k.indexOf(L)&&k.push(L)}),k}function hO(L){void 0!==lQ?lQ.resolve().then(L):setTimeout(L,0)}function pO(L){return JSON.parse(JSON.stringify(L))}function _O(L){try{return pO(L)}catch(k){return L}}let Sc={};function mO(L,k){Sc[k]||(Sc[k]=!0,L())}function fO(L){let k=window.atob(L),M=new Uint8Array(new ArrayBuffer(k.length));for(let L=0;L<k.length;L+=1)M[L]=k.charCodeAt(L);return M}function SO(L){let k="";for(let M=0;M<L.length;M+=1)k+=String.fromCharCode(L[M]);return window.btoa(k)}function gO(L){let k=arguments.length>1&&void 0!==arguments[1]?arguments[1]:16,M=(new TextEncoder).encode(L);if(M.length>k)M=M.slice(0,k);else if(M.length<k){let L=new Uint8Array(k);L.set(M),M=L}return M}function TO(){for(var L=arguments.length,k=Array(L),M=0;M<L;M++)k[M]=arguments[M];let U=sE(k).call(k,(L,k)=>L+k.length,0),V=new Uint8Array(new ArrayBuffer(U)),F=0;return k.forEach(L=>{V.set(L,F),F+=L.length}),V}function RO(L){return window.TextEncoder?(new TextEncoder).encode(L).length:L.length}function vO(L){let k=0;return(/DingTalk/i.test(navigator.userAgent)||/AliApp/i.test(navigator.userAgent))&&L.realFormData&&(L=L.realFormData),L.forEach(L=>{k+="string"==typeof L?RO(L):L.size}),k+138}function CO(L){let k=new f2(f1.TIMEOUT,"timeout");return new lQ((M,U)=>{window.setTimeout(()=>U(k),L)})}function yO(L){return new lQ(k=>{window.setTimeout(k,L)})}function IO(){let L=arguments.length>0&&void 0!==arguments[0]?arguments[0]:7,k=arguments.length>1?arguments[1]:void 0,M=Math.random().toString(16).substr(2,L).toLowerCase();return M.length===L?"".concat(k).concat(M):"".concat(k).concat(M)+IO(L-M.length,"")}function bO(){return IO(32,"").toUpperCase()}let AO=()=>{},Sd=new class{constructor(){Iw(this,"fnMap",new Map)}throttleByKey(L,k,M,U){for(var V=arguments.length,F=Array(V>4?V-4:0),B=4;B<V;B++)F[B-4]=arguments[B];if(this.fnMap.has(k)){let V=this.fnMap.get(k);if(V.threshold!==M){V.fn(...V.args),clearTimeout(V.timer);let B=window.setTimeout(()=>{let L=this.fnMap.get(k);L&&L.fn(...L.args),this.fnMap.delete(k)},M);this.fnMap.set(k,{fn:L,threshold:M,timer:B,args:F,skipFn:U})}else V.skipFn&&V.skipFn(...V.args),this.fnMap.set(k,Aw(Aw({},V),{},{fn:L,args:F,skipFn:U}))}else{let V=window.setTimeout(()=>{let L=this.fnMap.get(k);L&&L.fn(...L.args),this.fnMap.delete(k)},M);this.fnMap.set(k,{fn:L,threshold:M,timer:V,args:F,skipFn:U})}}},Sl=Sd.throttleByKey.bind(Sd);function NO(L){return"object"==typeof L&&null!==L&&!(L instanceof RegExp)}function DO(L,k){if(!NO(L)||!NO(k)||Array.isArray(L)&&!Array.isArray(k)||!Array.isArray(L)&&Array.isArray(k))return k;if(Array.isArray(k)&&Array.isArray(L)){let M=[...L];for(let U=0;U<k.length;U++)M[U]=DO(L[U],k[U]);return M}{let M=Aw({},L);for(let U in k)Object.prototype.hasOwnProperty.call(k,U)&&(Object.prototype.hasOwnProperty.call(L,U)?M[U]=DO(L[U],k[U]):M[U]=k[U]);return M}}function PO(L,k){let M=[0];if(k&&(M=Array(k).fill(0)),0===L)return M;let U=0;for(;L>0&&(M[U]=255&L,L>>=8,U++,!k||U!==k););return M}function LO(L){return"number"==typeof L?L:L.exact||L.ideal||L.max||L.min||0}function kO(L){return sE(L).call(L,(L,k)=>L+k,0)}function MO(L){let k="0123456789abcdef";function i(L){let M,U="";for(M=0;M<=3;M++)U+=k.charAt(L>>8*M+4&15)+k.charAt(L>>8*M&15);return U}function n(L,k){let M=(65535&L)+(65535&k);return(L>>16)+(k>>16)+(M>>16)<<16|65535&M}function r(L,k,M,U,V,F){var B;return n((B=n(n(k,L),n(U,F)))<<V|B>>>32-V,M)}function o(L,k,M,U,V,F,B){return r(k&M|~k&U,L,k,V,F,B)}function s(L,k,M,U,V,F,B){return r(k&U|M&~U,L,k,V,F,B)}function a(L,k,M,U,V,F,B){return r(k^M^U,L,k,V,F,B)}function c(L,k,M,U,V,F,B){return r(M^(k|~U),L,k,V,F,B)}let M=function(L){let k;let M=1+(L.length+8>>6),U=Array(16*M);for(k=0;k<16*M;k++)U[k]=0;for(k=0;k<L.length;k++)U[k>>2]|=L.charCodeAt(k)<<k%4*8;return U[k>>2]|=128<<k%4*8,U[16*M-2]=8*L.length,U}(L),U,V,F,B,j,G=1732584193,X=-271733879,$=-1732584194,ee=271733878;for(U=0;U<M.length;U+=16)V=G,F=X,B=$,j=ee,G=o(G,X,$,ee,M[U+0],7,-680876936),ee=o(ee,G,X,$,M[U+1],12,-389564586),$=o($,ee,G,X,M[U+2],17,606105819),X=o(X,$,ee,G,M[U+3],22,-1044525330),G=o(G,X,$,ee,M[U+4],7,-176418897),ee=o(ee,G,X,$,M[U+5],12,1200080426),$=o($,ee,G,X,M[U+6],17,-1473231341),X=o(X,$,ee,G,M[U+7],22,-45705983),G=o(G,X,$,ee,M[U+8],7,1770035416),ee=o(ee,G,X,$,M[U+9],12,-1958414417),$=o($,ee,G,X,M[U+10],17,-42063),X=o(X,$,ee,G,M[U+11],22,-1990404162),G=o(G,X,$,ee,M[U+12],7,1804603682),ee=o(ee,G,X,$,M[U+13],12,-40341101),$=o($,ee,G,X,M[U+14],17,-1502002290),X=o(X,$,ee,G,M[U+15],22,1236535329),G=s(G,X,$,ee,M[U+1],5,-165796510),ee=s(ee,G,X,$,M[U+6],9,-1069501632),$=s($,ee,G,X,M[U+11],14,643717713),X=s(X,$,ee,G,M[U+0],20,-373897302),G=s(G,X,$,ee,M[U+5],5,-701558691),ee=s(ee,G,X,$,M[U+10],9,38016083),$=s($,ee,G,X,M[U+15],14,-660478335),X=s(X,$,ee,G,M[U+4],20,-405537848),G=s(G,X,$,ee,M[U+9],5,568446438),ee=s(ee,G,X,$,M[U+14],9,-1019803690),$=s($,ee,G,X,M[U+3],14,-187363961),X=s(X,$,ee,G,M[U+8],20,1163531501),G=s(G,X,$,ee,M[U+13],5,-1444681467),ee=s(ee,G,X,$,M[U+2],9,-51403784),$=s($,ee,G,X,M[U+7],14,1735328473),X=s(X,$,ee,G,M[U+12],20,-1926607734),G=a(G,X,$,ee,M[U+5],4,-378558),ee=a(ee,G,X,$,M[U+8],11,-2022574463),$=a($,ee,G,X,M[U+11],16,1839030562),X=a(X,$,ee,G,M[U+14],23,-35309556),G=a(G,X,$,ee,M[U+1],4,-1530992060),ee=a(ee,G,X,$,M[U+4],11,1272893353),$=a($,ee,G,X,M[U+7],16,-155497632),X=a(X,$,ee,G,M[U+10],23,-1094730640),G=a(G,X,$,ee,M[U+13],4,681279174),ee=a(ee,G,X,$,M[U+0],11,-358537222),$=a($,ee,G,X,M[U+3],16,-722521979),X=a(X,$,ee,G,M[U+6],23,76029189),G=a(G,X,$,ee,M[U+9],4,-640364487),ee=a(ee,G,X,$,M[U+12],11,-421815835),$=a($,ee,G,X,M[U+15],16,530742520),X=a(X,$,ee,G,M[U+2],23,-995338651),G=c(G,X,$,ee,M[U+0],6,-198630844),ee=c(ee,G,X,$,M[U+7],10,1126891415),$=c($,ee,G,X,M[U+14],15,-1416354905),X=c(X,$,ee,G,M[U+5],21,-57434055),G=c(G,X,$,ee,M[U+12],6,1700485571),ee=c(ee,G,X,$,M[U+3],10,-1894986606),$=c($,ee,G,X,M[U+10],15,-1051523),X=c(X,$,ee,G,M[U+1],21,-2054922799),G=c(G,X,$,ee,M[U+8],6,1873313359),ee=c(ee,G,X,$,M[U+15],10,-30611744),$=c($,ee,G,X,M[U+6],15,-1560198380),X=c(X,$,ee,G,M[U+13],21,1309151649),G=c(G,X,$,ee,M[U+4],6,-145523070),ee=c(ee,G,X,$,M[U+11],10,-1120210379),$=c($,ee,G,X,M[U+2],15,718787259),X=c(X,$,ee,G,M[U+9],21,-343485551),G=n(G,V),X=n(X,F),$=n($,B),ee=n(ee,j);return i(G)+i(X)+i($)+i(ee)}let Sh=1,Sp=console,S_=class{static setLogger(L){Sp=L}constructor(L,k){Iw(this,"id",void 0),Iw(this,"lockingPromise",lQ.resolve()),Iw(this,"locks",0),Iw(this,"name",""),Iw(this,"lockId",void 0),this.lockId=Sh++,L&&(this.name=L),k&&(this.id=k),this.logger("created")}logger(L,k){let M=(this.id?"[".concat(this.id,"]"):"")+"[lock-".concat(this.name,"-").concat(this.lockId,"]"),U="created"===L?"is ".concat(L,"."):"is ".concat(L,", current queue ").concat(this.locks,". ").concat(null!=k?k:"");Sp.debug("".concat(M," ").concat(U))}setId(L){this.id=L}get isLocked(){return this.locks>0}lock(L){let k;this.locks+=1,this.logger("locked",L);let M=new lQ(M=>{k=()=>{this.locks-=1,this.logger("unlocked",L),M()}}),U=this.lockingPromise.then(()=>k);return this.lockingPromise=this.lockingPromise.then(()=>M),U}};function FO(L,k){return function(M,U,V){let F=V.value;if("function"!=typeof F)throw Error("Cannot use mutex on object property.");return V.value=async function(){let M=this[k];if(!M)throw Error("mutex property key ".concat(k," doesn't exist on ").concat(L));let V=await M.lock("From ".concat(L,".").concat(U));try{for(var B=arguments.length,j=Array(B),G=0;G<B;G++)j[G]=arguments[G];return await F.apply(this,j)}finally{V()}},V}}let Sm={timeout:500,timeoutFactor:1.5,maxRetryCount:1/0,maxRetryTimeout:1e4};function jO(L,k){let M=Math.floor(k.timeout*Math.pow(k.timeoutFactor,L));return Math.min(k.maxRetryTimeout,M)}function GO(L,k,M,U){let V=Object.assign({},Sm,U),F=V.timeout,s=async()=>{var L;await (L=F,new lQ(k=>{window.setTimeout(k,L)})),F*=V.timeoutFactor,F=Math.min(V.maxRetryTimeout,F)},B=!1,j=new lQ(async(U,F)=>{k=k||(()=>!1),M=M||(()=>!0);for(let j=0;j<V.maxRetryCount;j+=1){if(B)return F(new f2(f1.OPERATION_ABORTED));try{let M=await L();if(!k(M,j)||j+1===V.maxRetryCount)return U(M);await s()}catch(L){if(!M(L,j)||j+1===V.maxRetryCount)return F(L);await s()}}});return j.cancel=()=>B=!0,j}let Sf,SS=class{constructor(L){Iw(this,"input",[]),Iw(this,"size",void 0),this.size=L}add(L){this.input.push(L),this.input.length>this.size&&this.input.splice(0,1)}mean(){var L;return 0===this.input.length?0:sE(L=this.input).call(L,(L,k)=>L+k)/this.input.length}},Sg=0,SR=0;function zO(L,k,M,U){return new lQ((V,F)=>{k.responseType=k.responseType||"json",k.data&&!M?(k.data=JSON.stringify(k.data),Sg+=RO(k.data)):M&&(k.data.size?Sg+=k.data.size:k.data instanceof FormData?Sg+=vO(k.data):Sg+=RO(JSON.stringify(k.data))),k.headers=k.headers||{},k.headers["Content-Type"]=k.headers["Content-Type"]||"application/json",k.method="POST",k.url=L,fG.request(k).then(L=>{"string"==typeof L.data?SR+=RO(L.data):L.data instanceof ArrayBuffer||L.data instanceof Uint8Array?SR+=L.data.byteLength:SR+=RO(JSON.stringify(L.data)),U&&V({data:L.data,headers:L.headers}),V(L.data)}).catch(L=>{fG.isCancel(L)?F(new f2(f1.OPERATION_ABORTED,"cancel token canceled")):"ECONNABORTED"===L.code?F(new f2(f1.NETWORK_TIMEOUT,L.message)):L.response?F(new f2(f1.NETWORK_RESPONSE_ERROR,L.response.status)):F(new f2(f1.NETWORK_ERROR,L.message))})})}async function qO(L,k){let M=new Blob([k.data],{type:"buffer"});return await zO(L,Aw(Aw({},k),{},{data:M,headers:{"Content-Type":"application/octet-stream"}}),!0)}let XO=()=>void 0!==window.isSecureContext;function JO(L){if(Array.isArray(L))return L.map(L=>L);if(!ZO(L))return L;let k={};for(let M in L){let U=L[M];ZO(U)||Array.isArray(U)?k[M]=JO(U):k[M]=U}return k}function ZO(L){return!("object"!=typeof L||Array.isArray(L)||!L)}let SI=class{constructor(L){Iw(this,"input",[]),Iw(this,"size",void 0),this.size=L}add(L){this.input.push(L),this.input.length>this.size&&this.input.splice(0,1)}diffMean(){return 0===this.input.length?0:(this.input[this.input.length-1]-this.input[0])/this.input.length}},Sv={address:"unknown",candidateType:"unknown",id:"unknown",port:0,priority:0,protocol:"unknown",type:"unknown"},SC={timestamp:0,bitrate:{actualEncoded:0,transmit:0},sendPacketLossRate:0,recvPacketLossRate:0,videoRecv:[],videoSend:[],audioRecv:[],audioSend:[],selectedCandidatePair:{id:"unknown",localCandidate:Sv,remoteCandidate:Sv},updateInterval:0},Sy={firsCount:0,nacksCount:0,plisCount:0,framesDecodeCount:0,framesDecodeInterval:0,framesDecodeFreezeTime:0,decodeFrameRate:0,bytes:0,packetsLost:0,packetLostRate:0,packets:0,ssrc:0,qpSumPerFrame:0,framesDroppedCount:0,outputFrameRate:0,packetsDiscarded:0,framesAssembledFromMultiplePackets:0,totalProcessingDelay:0,avgDecodeMs:0,avgFramesAssembledFromMultiplePacketsMs:0,avgProcessingDelayMs:0,avgInterFrameDelayMs:0,totalAssemblyTime:0},SA={firsCount:0,nacksCount:0,plisCount:0,frameCount:0,bytes:0,packets:0,packetsLost:0,packetLostRate:0,ssrc:0,rttMs:0,jitterMs:0,qpSumPerFrame:0},SN={bytes:0,packets:0,packetsLost:0,packetLostRate:0,ssrc:0,rttMs:0,jitterMs:0},SL={jitterBufferMs:0,jitterMs:0,bytes:0,packetsLost:0,packetLostRate:0,packetsDiscarded:0,packets:0,ssrc:0,receivedFrames:0,droppedFrames:0,concealedSamples:0,totalSamplesReceived:0,silentConcealedSamples:0,concealmentEvents:0,freezeMs80:0,freezeMs200:0,freezeSamples80:0,freezeSamples200:0},Sk=class{constructor(L,k){Iw(this,"onFirstVideoReceived",void 0),Iw(this,"onFirstVideoDecoded",void 0),Iw(this,"onFirstAudioReceived",void 0),Iw(this,"onFirstVideoDecodedTimeout",void 0),Iw(this,"onFirstAudioDecoded",void 0),Iw(this,"onSelectedLocalCandidateChanged",void 0),Iw(this,"onSelectedRemoteCandidateChanged",void 0),Iw(this,"videoIsReady",!1),Iw(this,"videoIsReady2",{}),Iw(this,"pc",void 0),Iw(this,"options",void 0),Iw(this,"intervalTimer",void 0),Iw(this,"stats",JO(SC)),Iw(this,"isFirstVideoReceived",{}),Iw(this,"isFirstVideoDecoded",{}),Iw(this,"isFirstAudioReceived",{}),Iw(this,"isFirstAudioDecoded",{}),Iw(this,"isFirstVideoDecodedTimeout",{}),Iw(this,"lossRateWindowStats",[]),this.pc=L,this.options=k,this.intervalTimer=window.setInterval(async()=>{this.updateStats()},this.options.updateInterval)}getStats(){return this.stats}getSelectedCandidatePair(){return new lQ(L=>{L({local:Aw({},Sv),remote:Aw({},Sv)})})}setVideoIsReady(L){this.videoIsReady=L}setVideoIsReady2(L,k){this.videoIsReady2[L]=k}getVideoIsReady(L){return this.videoIsReady2[L]||!1}setIsFirstAudioDecoded(L){}destroy(){window.clearInterval(this.intervalTimer),this.pc=void 0}calcLossRate(L){this.lossRateWindowStats.push(L),this.lossRateWindowStats.length>this.options.lossRateInterval&&this.lossRateWindowStats.splice(0,1);let k=this.lossRateWindowStats.length,M=0,U=0,V=0,F=0;for(let B of["videoSend","audioSend","videoRecv","audioRecv"])L[B].forEach((L,j)=>{if(!this.lossRateWindowStats[k-1][B][j]||!this.lossRateWindowStats[0][B][j])return;let G=this.lossRateWindowStats[k-1][B][j].packets-this.lossRateWindowStats[0][B][j].packets,X=this.lossRateWindowStats[k-1][B][j].packetsLost-this.lossRateWindowStats[0][B][j].packetsLost;"videoSend"===B||"audioSend"===B?(M+=G,V+=X):(U+=G,F+=X),Number.isNaN(G)||Number.isNaN(G)?L.packetLostRate=0:L.packetLostRate=G<=0||X<=0?0:X/(G+X)});L.sendPacketLossRate=M<=0||V<=0?0:V/(M+V),L.recvPacketLossRate=U<=0||F<=0?0:F/(U+F)}},SU=class extends Sk{constructor(){super(...arguments),Iw(this,"_stats",SC),Iw(this,"lastDecodeVideoReceiverStats",new Map)}async updateStats(){let L=await this._getStats(),k=this.statsResponsesToObjects(L);this._stats=JO(SC);let M=k.filter(L=>"ssrc"===L.type);this.processSSRCStats(M);let U=k.find(L=>"VideoBwe"===L.type);U&&this.processBandwidthStats(U),this._stats.timestamp=Date.now(),this.calcLossRate(this._stats),this.stats=this._stats}processBandwidthStats(L){this._stats.bitrate={actualEncoded:Number(L.googActualEncBitrate),targetEncoded:Number(L.googTargetEncBitrate),retransmit:Number(L.googRetransmitBitrate),transmit:Number(L.googTransmitBitrate)},this._stats.sendBandwidth=Number(L.googAvailableSendBandwidth)}processSSRCStats(L){L.forEach(L=>{var k;let M=so(k=L.id).call(k,"send");switch("".concat(L.mediaType,"_").concat(M?"send":"recv")){case"video_send":{let k=JO(SA);k.codec=L.googCodecName,k.adaptionChangeReason="none",L.googCpuLimitedResolution&&(k.adaptionChangeReason="cpu"),L.googBandwidthLimitedResolution&&(k.adaptionChangeReason="bandwidth"),k.avgEncodeMs=Number(L.googAvgEncodeMs),k.inputFrame={width:Number(L.googFrameWidthInput)||Number(L.googFrameWidthSent),height:Number(L.googFrameHeightInput)||Number(L.googFrameHeightSent),frameRate:Number(L.googFrameRateInput)},k.sentFrame={width:Number(L.googFrameWidthSent),height:Number(L.googFrameHeightSent),frameRate:Number(L.googFrameRateInput)},k.firsCount=Number(L.googFirReceived),k.nacksCount=Number(L.googNacksReceived),k.plisCount=Number(L.googPlisReceived),k.frameCount=Number(L.framesEncoded),k.bytes=Number(L.bytesSent),k.packets=Number(L.packetsSent),k.packetsLost=Number(L.packetsLost),k.ssrc=Number(L.ssrc),k.rttMs=Number(L.googRtt||0),this._stats.videoSend.push(k),this._stats.rtt=k.rttMs;break}case"video_recv":{let k=JO(Sy),M=this.lastDecodeVideoReceiverStats.get(Number(L.ssrc));if(k.codec=L.googCodecName,k.targetDelayMs=Number(L.googTargetDelayMs),k.renderDelayMs=Number(L.googRenderDelayMs),k.currentDelayMs=Number(L.googCurrentDelayMs),k.minPlayoutDelayMs=Number(L.googMinPlayoutDelayMs),k.decodeMs=Number(L.googDecodeMs),k.maxDecodeMs=Number(L.googMaxDecodeMs),k.receivedFrame={width:Number(L.googFrameWidthReceived),height:Number(L.googFrameHeightReceived),frameRate:Number(L.googFrameRateReceived)},k.decodedFrame={width:Number(L.googFrameWidthReceived),height:Number(L.googFrameHeightReceived),frameRate:Number(L.googFrameRateDecoded)},k.decodeFrameRate=Number(L.googFrameRateDecoded),k.outputFrame={width:Number(L.googFrameWidthReceived),height:Number(L.googFrameHeightReceived),frameRate:Number(L.googFrameRateOutput)},k.jitterBufferMs=Number(L.googJitterBufferMs),k.firsCount=Number(L.googFirsSent),k.nacksCount=Number(L.googNacksSent),k.plisCount=Number(L.googPlisSent),k.framesDecodeCount=Number(L.framesDecoded),k.bytes=Number(L.bytesReceived),k.packets=Number(L.packetsReceived),k.packetsLost=Number(L.packetsLost),k.ssrc=Number(L.ssrc),k.packets>0&&!this.isFirstVideoReceived[k.ssrc]&&(this.onFirstVideoReceived&&this.onFirstVideoReceived(k.ssrc),this.isFirstVideoReceived[k.ssrc]=!0),k.framesDecodeCount>0&&!this.isFirstVideoDecoded[k.ssrc]&&(this.onFirstVideoDecoded&&this.onFirstVideoDecoded(k.ssrc,k.decodedFrame.width,k.decodedFrame.height),this.isFirstVideoDecoded[k.ssrc]=!0),M){let U=M.stats,V=Date.now()-M.lts;k.framesDecodeFreezeTime=U.framesDecodeFreezeTime,k.framesDecodeInterval=U.framesDecodeInterval,k.framesDecodeCount>U.framesDecodeCount&&this.isFirstVideoDecoded[k.ssrc]?(M.lts=Date.now(),k.framesDecodeInterval=V,k.framesDecodeInterval>=this.options.freezeRateLimit&&(this.getVideoIsReady(parseInt(L.ssrc,10))?k.framesDecodeFreezeTime+=k.framesDecodeInterval:this.setVideoIsReady2(parseInt(L.ssrc,10),!0))):k.framesDecodeCount<M.stats.framesDecodeCount&&(k.framesDecodeInterval=0)}this.lastDecodeVideoReceiverStats.set(k.ssrc,{stats:Aw({},k),lts:Date.now()}),this._stats.videoRecv.push(k);break}case"audio_recv":{let k=JO(SL);k.codec=L.googCodecName,k.outputLevel=Math.abs(Number(L.audioOutputLevel))/32767,k.decodingCNG=Number(L.googDecodingCNG),k.decodingCTN=Number(L.googDecodingCTN),k.decodingCTSG=Number(L.googDecodingCTSG),k.decodingNormal=Number(L.googDecodingNormal),k.decodingPLC=Number(L.googDecodingPLC),k.decodingPLCCNG=Number(L.googDecodingPLCCNG),k.expandRate=Number(L.googExpandRate),k.accelerateRate=Number(L.googAccelerateRate),k.preemptiveExpandRate=Number(L.googPreemptiveExpandRate),k.secondaryDecodedRate=Number(L.googSecondaryDecodedRate),k.speechExpandRate=Number(L.googSpeechExpandRate),k.preferredJitterBufferMs=Number(L.googPreferredJitterBufferMs),k.jitterBufferMs=Number(L.googJitterBufferMs),k.jitterMs=Number(L.googJitterReceived),k.bytes=Number(L.bytesReceived),k.packets=Number(L.packetsReceived),k.packetsLost=Number(L.packetsLost),k.ssrc=Number(L.ssrc),k.receivedFrames=Number(L.googDecodingCTN)||Number(L.packetsReceived),k.droppedFrames=Number(L.googDecodingPLC)+Number(L.googDecodingPLCCNG)||Number(L.packetsLost),k.receivedFrames>0&&!this.isFirstAudioReceived[k.ssrc]&&(this.onFirstAudioReceived&&this.onFirstAudioReceived(k.ssrc),this.isFirstAudioReceived[k.ssrc]=!0),k.decodingNormal>0&&!this.isFirstAudioDecoded[k.ssrc]&&(this.onFirstAudioDecoded&&this.onFirstAudioDecoded(k.ssrc),this.isFirstAudioDecoded[k.ssrc]=!0),this._stats.audioRecv.push(k);break}case"audio_send":{let k=JO(SN);k.codec=L.googCodecName,k.inputLevel=Math.abs(Number(L.audioInputLevel))/32767,k.aecReturnLoss=Number(L.googEchoCancellationReturnLoss||0),k.aecReturnLossEnhancement=Number(L.googEchoCancellationReturnLossEnhancement||0),k.residualEchoLikelihood=Number(L.googResidualEchoLikelihood||0),k.residualEchoLikelihoodRecentMax=Number(L.googResidualEchoLikelihoodRecentMax||0),k.bytes=Number(L.bytesSent),k.packets=Number(L.packetsSent),k.packetsLost=Number(L.packetsLost),k.ssrc=Number(L.ssrc),k.rttMs=Number(L.googRtt||0),this._stats.rtt=k.rttMs,this._stats.audioSend.push(k)}}})}_getStats(){return new lQ((L,k)=>{this.pc.getStats(L,k)})}statsResponsesToObjects(L){let k=[];return L.result().forEach(L=>{let M={id:L.id,timestamp:L.timestamp.valueOf().toString(),type:L.type};L.names().forEach(k=>{M[k]=L.stat(k)}),k.push(M)}),k}},SV=((em={}).BANDWIDTH="bandwidth",em.CPU="cpu",em.NONE="none",em.OTHER="other",em),Sj=((ef={}).L1T1="L1T1",ef.L1T2="L1T2",ef.L1T3="L1T3",ef.L1T3_KEY="L1T3_KEY",ef.L2T1_KEY="L2T1_KEY",ef.L2T2_KEY="L2T2_KEY",ef.L2T3_KEY="L2T3_KEY",ef.L3T1_KEY="L3T1_KEY",ef.L3T2_KEY="L3T2_KEY",ef.L3T3_KEY="L3T3_KEY",ef),SW=((eS={})[eS.new=0]="new",eS[eS.connecting=1]="connecting",eS[eS.connected=2]="connected",eS[eS.disconnected=3]="disconnected",eS[eS.failed=4]="failed",eS[eS.closed=5]="closed",eS),SG=((eT={}).CERTIFICATE="certificate",eT.CODEC="codec",eT.CANDIDATE_PAIR="candidate-pair",eT.LOCAL_CANDIDATE="local-candidate",eT.REMOTE_CANDIDATE="remote-candidate",eT.INBOUND="inbound-rtp",eT.TRACK="track",eT.OUTBOUND="outbound-rtp",eT.PC="peer-connection",eT.REMOTE_INBOUND="remote-inbound-rtp",eT.REMOTE_OUTBOUND="remote-outbound-rtp",eT.TRANSPORT="transport",eT.CSRC="csrc",eT.DATA_CHANNEL="data-channel",eT.STREAM="stream",eT.SENDER="sender",eT.RECEIVER="receiver",eT);var SH=((eR=SH||{})[eR.kNone=1]="kNone",eR[eR.kMillisecondsFromSeconds=1e3]="kMillisecondsFromSeconds",eR[eR.kBytesToBits=8]="kBytesToBits",eR);function hN(L,k,M,U){let V=arguments.length>4&&void 0!==arguments[4]?arguments[4]:SH.kNone;if(!k)return;let F=Number(k[M]);if("number"!=typeof F)return;let B=Number(k[U]);if("number"!=typeof B)return;if(!L)return B?F/B*V:void 0;let j=Number(L[M]);if("number"!=typeof j)return;let G=Number(L[U]);if("number"!=typeof G)return;let X=B-G;return X?(F-j)/X*V:void 0}let SK=class extends Sk{constructor(){super(...arguments),Iw(this,"_stats",SC),Iw(this,"report",void 0),Iw(this,"lastDecodeVideoReceiverStats",new Map),Iw(this,"lastVideoFramesRecv",new Map),Iw(this,"lastVideoFramesSent",new Map),Iw(this,"lastVideoFramesDecode",new Map),Iw(this,"lastVideoFramesOutput",new Map),Iw(this,"lastVideoJBDelay",new Map),Iw(this,"lastAudioJBDelay",new Map),Iw(this,"mediaBytesSent",new Map),Iw(this,"mediaBytesRetransmit",new Map),Iw(this,"mediaBytesTargetEncode",new Map),Iw(this,"lastDecodeAudioReceiverStats",new Map),Iw(this,"lastAudioConcealment",new Map),Iw(this,"lastEncoderMs",new Map)}async updateStats(){this.report=await this.pc.getStats(),this._stats=JO(SC),this.report.forEach(L=>{switch(L.type){case SG.OUTBOUND:case SG.INBOUND:{let k=L.mediaType||L.kind,M=!k&&"frameWidth"in L,U=!k&&!("frameWidth"in L);L.type===SG.OUTBOUND?"audio"===k||U?this.processAudioOutboundStats(L):("video"===k||M)&&this.processVideoOutboundStats(L):L.type===SG.INBOUND&&("audio"===k||U?this.processAudioInboundStats(L):("video"===k||M)&&this.processVideoInboundStats(L));break}case SG.TRANSPORT:{let k=this.report.get(L.selectedCandidatePairId);k&&this.processCandidatePairStats(k);break}case SG.CANDIDATE_PAIR:L.selected&&this.processCandidatePairStats(L)}}),this.updateSendBitrate(),this._stats.updateInterval=Date.now()-this.stats.timestamp,this._stats.timestamp=Date.now(),this.calcLossRate(this._stats),this.stats=this._stats}async getSelectedCandidatePair(){let L=await this.pc.getStats(),k={local:Aw({},Sv),remote:Aw({},Sv)};return L.forEach(M=>{let U;if(M.type===SG.TRANSPORT&&(U=L.get(M.selectedCandidatePairId)),M.type===SG.CANDIDATE_PAIR&&M.selected&&(U=M),U){let i=(L,k)=>{L.type=k.type,L.id=k.id,k.address&&(L.address=k.address),k.candidateType&&(L.candidateType=k.candidateType),k.port&&(L.port=k.port),k.priority&&(L.priority=k.priority),k.protocol&&(L.protocol=k.protocol),k.relayProtocol&&(L.relayProtocol=k.relayProtocol)};if(U.localCandidateId){let M=L.get(U.localCandidateId);M&&i(k.local,M)}if(U.remoteCandidateId){let M=L.get(U.remoteCandidateId);M&&i(k.remote,M)}}}),k}processCandidatePairStats(L){if(this._stats.sendBandwidth=L.availableOutgoingBitrate||0,L.currentRoundTripTime&&(this._stats.rtt=1e3*L.currentRoundTripTime),this._stats.videoSend.forEach(k=>{L.currentRoundTripTime&&(k.rttMs=1e3*L.currentRoundTripTime)}),this._stats.audioSend.forEach(k=>{L.currentRoundTripTime&&(k.rttMs=1e3*L.currentRoundTripTime)}),this._stats.selectedCandidatePair.id=L.id,L.localCandidateId){let k=this.report.get(L.localCandidateId);k&&this.processCandidateStats(k)}if(L.remoteCandidateId){let k=this.report.get(L.remoteCandidateId);k&&this.processCandidateStats(k)}}processCandidateStats(L){let k;L.type===SG.LOCAL_CANDIDATE&&(k=this._stats.selectedCandidatePair.localCandidate),L.type===SG.REMOTE_CANDIDATE&&(k=this._stats.selectedCandidatePair.remoteCandidate),k&&(k.type=L.type,k.id=L.id,L.address&&(k.address=L.address),L.candidateType&&(k.candidateType=L.candidateType),L.port&&(k.port=L.port),L.priority&&(k.priority=L.priority),L.protocol&&(k.protocol=L.protocol),L.relayProtocol&&(k.relayProtocol=L.relayProtocol),L.type===SG.LOCAL_CANDIDATE&&this.stats.selectedCandidatePair.localCandidate.id!==k.id&&this.onSelectedLocalCandidateChanged&&this.onSelectedLocalCandidateChanged(Aw({},k),Aw({},this.stats.selectedCandidatePair.localCandidate)),L.type===SG.REMOTE_CANDIDATE&&this.stats.selectedCandidatePair.remoteCandidate.id!==k.id&&this.onSelectedRemoteCandidateChanged&&this.onSelectedRemoteCandidateChanged(Aw({},k),Aw({},this.stats.selectedCandidatePair.remoteCandidate)))}processAudioInboundStats(L){let k=this._stats.audioRecv.find(k=>k.ssrc===L.ssrc);k||(k=JO(SL),this._stats.audioRecv.push(k)),k.ssrc=L.ssrc,k.packets=L.packetsReceived,k.packetsLost=L.packetsLost,k.packetsDiscarded=L.packetsDiscarded,k.bytes=L.bytesReceived,k.jitterMs=1e3*L.jitter,k.retransmittedBytesReceived=L.retransmittedBytesReceived,k.retransmittedPacketsReceived=L.retransmittedPacketsReceived,k.totalProcessingDelay=L.totalProcessingDelay,k.jitterBufferEmittedCount=L.jitterBufferEmittedCount;let M=this.lastDecodeAudioReceiverStats.get(k.ssrc);k.avgProcessingDelayMs=hN(M,k,"totalProcessingDelay","jitterBufferEmittedCount",SH.kMillisecondsFromSeconds),this.processAudioTrackReceiverStats(L,L.trackId,k),this.calculateAudioFreeze(k,M,L),L.codecId&&(k.codec=this.getCodecFromCodecStats(L.codecId)),k.receivedFrames||(k.receivedFrames=L.packetsReceived),k.droppedFrames||(k.droppedFrames=L.packetsLost),k.receivedFrames>0&&!this.isFirstAudioReceived[k.ssrc]&&(this.onFirstAudioReceived&&this.onFirstAudioReceived(k.ssrc),this.isFirstAudioReceived[k.ssrc]=!0),k.outputLevel&&k.outputLevel>0&&!this.isFirstAudioDecoded[k.ssrc]&&(this.onFirstAudioDecoded&&this.onFirstAudioDecoded(k.ssrc),this.isFirstAudioDecoded[k.ssrc]=!0),"number"==typeof L.concealedSamples&&(k.concealedSamples=L.concealedSamples),this.lastDecodeAudioReceiverStats.set(k.ssrc,Aw({},k))}calculateAudioFreeze(L,k,M){let U=this.lastAudioConcealment.get(L.ssrc);if(null!=k&&null!=U){let V=U.lts,F=M.timestamp,B=F-V;if(B<=0)return;let j=L.concealedSamples-k.concealedSamples-0,G=U.nonSilent+j,X=L.totalSamplesReceived-k.totalSamplesReceived;if(X<=0)return;let $=B/X,ee=0;L.freezeSamples80=k.freezeSamples80,L.freezeMs80=k.freezeMs80,G>80*X/B&&(U.plc80>0?(L.freezeSamples80+=j,L.freezeMs80+=Math.round(j*$)):(L.freezeSamples80+=G,L.freezeMs80+=Math.round(G*$)),ee=U.plc80+1);let et=0;L.freezeSamples200=k.freezeSamples200,L.freezeMs200=k.freezeMs200,G>200*X/B&&(U.plc200>0?(L.freezeSamples200+=j,L.freezeMs200+=Math.round(j*$)):(L.freezeSamples200+=G,L.freezeMs200+=Math.round(G*$)),et=U.plc200+1),this.lastAudioConcealment.set(L.ssrc,{nonSilent:j,lts:F,plc80:ee,plc200:et})}else L.freezeSamples80=0,L.freezeSamples200=0,L.freezeMs80=0,L.freezeMs200=0,this.lastAudioConcealment.set(L.ssrc,{nonSilent:0,lts:M.timestamp,plc80:0,plc200:0})}processVideoInboundStats(L){let k=this._stats.videoRecv.find(k=>k.ssrc===L.ssrc);k||(k=JO(Sy),this._stats.videoRecv.push(k)),k.ssrc=L.ssrc,k.packets=L.packetsReceived,k.packetsLost=L.packetsLost,k.bytes=L.bytesReceived,k.firsCount=L.firCount,k.nacksCount=L.nackCount,k.plisCount=L.pliCount,k.framesDecodeCount=L.framesDecoded,k.framesDroppedCount=L.framesDropped,k.totalInterFrameDelay=L.totalInterFrameDelay,k.totalSquaredInterFrameDelay=L.totalSquaredInterFrameDelay,k.totalFreezesDuration=L.totalFreezesDuration,k.totalProcessingDelay=L.totalProcessingDelay,k.packetsDiscarded=L.packetsDiscarded,k.framesAssembledFromMultiplePackets=L.framesAssembledFromMultiplePackets,k.totalAssemblyTime=L.totalAssemblyTime,k.keyFramesDecoded=L.keyFramesDecoded,k.retransmittedBytesReceived=L.retransmittedBytesReceived,k.retransmittedPacketsReceived=L.retransmittedPacketsReceived;let M=this.lastDecodeVideoReceiverStats.get(k.ssrc),U=this.lastVideoFramesDecode.get(k.ssrc),V=this.lastVideoFramesOutput.get(k.ssrc),F=Date.now();if(k.framesDecodeCount>0&&!this.isFirstVideoDecoded[k.ssrc]){let L=k.decodedFrame?k.decodedFrame.width:0,M=k.decodedFrame?k.decodedFrame.height:0;this.onFirstVideoDecoded&&this.onFirstVideoDecoded(k.ssrc,L,M),this.isFirstVideoDecoded[k.ssrc]=!0}if(M){let U=M.stats,V=F-M.lts;k.framesDecodeFreezeTime=U.framesDecodeFreezeTime,k.framesDecodeInterval=U.framesDecodeInterval,this.isFirstVideoDecoded[k.ssrc]||!(V>this.options.firstVideoDecodedTimeout)||this.isFirstVideoDecodedTimeout[k.ssrc]||(this.onFirstVideoDecodedTimeout&&this.onFirstVideoDecodedTimeout(k.ssrc),this.isFirstVideoDecodedTimeout[k.ssrc]=!0),k.framesDecodeCount>U.framesDecodeCount&&this.isFirstVideoDecoded[k.ssrc]?(M.lts=Date.now(),k.framesDecodeInterval=V,k.framesDecodeInterval>=this.options.freezeRateLimit&&(this.getVideoIsReady(parseInt(L.ssrc))?k.framesDecodeFreezeTime+=k.framesDecodeInterval:this.setVideoIsReady2(parseInt(L.ssrc,10),!0))):k.framesDecodeCount<U.framesDecodeCount&&(k.framesDecodeInterval=0),L.framesDecoded&&L.qpSum&&(M.stats.framesDecodeCount>L.framesDecoded?k.qpSumPerFrame=L.qpSum/L.framesDecoded:k.qpSumPerFrame=(L.qpSum-M.qpSum)/(L.framesDecoded-M.stats.framesDecodeCount))}L.totalDecodeTime&&(k.decodeMs=1e3*L.totalDecodeTime,k.avgDecodeMs=hN(null==M?void 0:M.stats,k,"decodeMs","framesDecodeCount")),k.avgProcessingDelayMs=hN(null==M?void 0:M.stats,k,"totalProcessingDelay","framesDecodeCount",SH.kMillisecondsFromSeconds),k.avgFramesAssembledFromMultiplePacketsMs=hN(null==M?void 0:M.stats,k,"totalAssemblyTime","framesAssembledFromMultiplePackets",SH.kMillisecondsFromSeconds),k.avgInterFrameDelayMs=hN(null==M?void 0:M.stats,k,"totalInterFrameDelay","framesDecodeCount",SH.kMillisecondsFromSeconds),U&&F-U.lts>=800?(k.decodeFrameRate=Math.round((k.framesDecodeCount-U.count)/((F-U.lts)/1e3)),this.lastVideoFramesDecode.set(k.ssrc,{count:k.framesDecodeCount,lts:F,rate:k.decodeFrameRate})):U?k.decodeFrameRate=U.rate:this.lastVideoFramesDecode.set(k.ssrc,{count:k.framesDecodeCount,lts:F,rate:0}),k.framesDroppedCount&&L.framesReceived&&(V&&F-V.lts>=800?(k.outputFrameRate=Math.round((L.framesReceived-k.framesDroppedCount-V.count)/((F-V.lts)/1e3)),this.lastVideoFramesOutput.set(k.ssrc,{count:L.framesReceived-k.framesDroppedCount,lts:F,rate:Math.max(k.outputFrameRate,0)})):V?k.outputFrameRate=V.rate:this.lastVideoFramesOutput.set(k.ssrc,{count:L.framesReceived-k.framesDroppedCount,lts:F,rate:0})),this.processVideoTrackReceiverStats(L,L.trackId,k),L.codecId&&(k.codec=this.getCodecFromCodecStats(L.codecId)),L.framerateMean&&(k.framesRateFirefox=L.framerateMean),k.packets>0&&!this.isFirstVideoReceived[k.ssrc]&&(this.onFirstVideoReceived&&this.onFirstVideoReceived(k.ssrc),this.isFirstVideoReceived[k.ssrc]=!0),this.lastDecodeVideoReceiverStats.set(k.ssrc,{stats:Aw({},k),lts:M?M.lts:Date.now(),qpSum:L.qpSum})}processVideoOutboundStats(L){let k=this._stats.videoSend.find(k=>k.ssrc===L.ssrc);k||(k=JO(SA),this._stats.videoSend.push(k));let M=this.mediaBytesSent.get(L.ssrc);if(M)M.add(L.bytesSent);else{let k=new SI(10);k.add(L.bytesSent),this.mediaBytesSent.set(L.ssrc,k)}if(void 0!==L.retransmittedBytesSent){let k=this.mediaBytesRetransmit.get(L.ssrc);if(k)k.add(L.retransmittedBytesSent);else{let k=new SI(10);k.add(L.retransmittedBytesSent),this.mediaBytesRetransmit.set(L.ssrc,k)}}if(L.totalEncodedBytesTarget){let k=this.mediaBytesTargetEncode.get(L.ssrc);if(k)k.add(L.totalEncodedBytesTarget);else{let k=new SI(10);k.add(L.totalEncodedBytesTarget),this.mediaBytesTargetEncode.set(L.ssrc,k)}}if(k.ssrc=L.ssrc,k.bytes=L.bytesSent,k.packets=L.packetsSent,k.firsCount=L.firCount,k.nacksCount=L.nackCount,k.plisCount=L.pliCount,k.frameCount=L.framesEncoded,k.adaptionChangeReason=L.qualityLimitationReason,k.scalabilityMode=L.scalabilityMode,k.retransmittedBytesSent=L.retransmittedBytesSent,k.retransmittedPacketsSent=L.retransmittedPacketsSent,k.hugeFramesSent=L.hugeFramesSent,k.keyFramesEncoded=L.keyFramesEncoded,k.targetBitrate=L.targetBitrate,L.totalEncodeTime&&L.framesEncoded){let M=this.lastEncoderMs.get(L.ssrc);if(!M||M.lastFrameCount>L.framesEncoded)k.avgEncodeMs=1e3*L.totalEncodeTime/L.framesEncoded;else{let U=L.framesEncoded-M.lastFrameCount,V=L.totalEncodeTime-M.lastEncoderTime;k.avgEncodeMs=1e3*V/U}}if(L.framesEncoded&&L.qpSum){let M=this.lastEncoderMs.get(L.ssrc);!M||M.lastFrameCount>L.framesEncoded?k.qpSumPerFrame=L.qpSum/L.framesEncoded:k.qpSumPerFrame=(L.qpSum-M.lastQpSum)/(L.framesEncoded-M.lastFrameCount)}if(this.lastEncoderMs.set(L.ssrc,{lastFrameCount:L.framesEncoded,lastEncoderTime:L.totalEncodeTime,lastQpSum:L.qpSum,lts:Date.now()}),L.codecId&&(k.codec=this.getCodecFromCodecStats(L.codecId)),L.mediaSourceId&&this.processVideoMediaSource(L.mediaSourceId,k),this.processVideoTrackSenderStats(L,L.trackId,k),L.remoteId)this.processRemoteInboundStats(L.remoteId,k);else{let M=this.findRemoteStatsId(L.ssrc,SG.REMOTE_INBOUND);M&&this.processRemoteInboundStats(M,k)}}processAudioOutboundStats(L){let k=this._stats.audioSend.find(k=>k.ssrc===L.ssrc);if(k||(k=JO(SN),this._stats.audioSend.push(k)),k.ssrc=L.ssrc,k.packets=L.packetsSent,k.bytes=L.bytesSent,k.retransmittedBytesSent=L.retransmittedBytesSent,k.retransmittedPacketsSent=L.retransmittedPacketsSent,L.mediaSourceId&&this.processAudioMediaSource(L.mediaSourceId,k),L.codecId&&(k.codec=this.getCodecFromCodecStats(L.codecId)),this.processAudioTrackSenderStats(L,L.trackId,k),L.remoteId)this.processRemoteInboundStats(L.remoteId,k);else{let M=this.findRemoteStatsId(L.ssrc,SG.REMOTE_INBOUND);M&&this.processRemoteInboundStats(M,k)}}findRemoteStatsId(L,k){var M;let U=Array.from(l1(M=this.report).call(M)).find(M=>M.type===k&&M.ssrc===L);return U?U.id:null}processVideoMediaSource(L,k){let M=this.report.get(L);M&&M.width&&M.height&&M.framesPerSecond&&(k.inputFrame={width:M.width,height:M.height,frameRate:M.framesPerSecond})}processAudioMediaSource(L,k){let M=this.report.get(L);M&&(k.inputLevel=M.audioLevel)}processVideoTrackSenderStats(L,k,M){var U,V,F,B;let j=k?this.report.get(k):void 0,G=null!==(U=null==j?void 0:j.framesSent)&&void 0!==U?U:L.framesSent;if("number"!=typeof G)return;let X=null!==(V=null==j?void 0:j.frameWidth)&&void 0!==V?V:L.frameWidth,$=null!==(F=null==j?void 0:j.frameHeight)&&void 0!==F?F:L.frameHeight,ee=null!==(B=null==j?void 0:j.framesPerSecond)&&void 0!==B?B:L.framesPerSecond;if("number"==typeof X&&"number"==typeof $||(X=0,$=0),null==ee){let L=Date.now(),k=this.lastVideoFramesSent.get(M.ssrc);k&&L-k.lts>=800?(ee=Math.round((G-k.count)/((L-k.lts)/1e3)),this.lastVideoFramesSent.set(M.ssrc,{count:G,lts:L,rate:ee})):k?ee=k.rate:this.lastVideoFramesSent.set(M.ssrc,{count:G,lts:L,rate:0})}M.sentFrame={width:X,height:$,frameRate:Math.max(0,ee)}}processVideoTrackReceiverStats(L,k,M){var U,V,F,B,j;let G=k?this.report.get(k):void 0,X=null!==(U=null==G?void 0:G.framesReceived)&&void 0!==U?U:L.framesReceived,$=null!==(V=null==G?void 0:G.frameWidth)&&void 0!==V?V:L.frameWidth,ee=null!==(F=null==G?void 0:G.frameHeight)&&void 0!==F?F:L.frameHeight,et=null!==(B=null==G?void 0:G.jitterBufferDelay)&&void 0!==B?B:L.jitterBufferDelay,ei=null!==(j=null==G?void 0:G.jitterBufferEmittedCount)&&void 0!==j?j:L.jitterBufferEmittedCount;if("number"==typeof X){let L=this.lastVideoFramesRecv.get(M.ssrc),k=Date.now();M.framesReceivedCount=X;let U=0;L&&k-L.lts>=800?(U=Math.round((X-L.count)/((k-L.lts)/1e3)),this.lastVideoFramesRecv.set(M.ssrc,{count:X,lts:k,rate:U})):L?U=L.rate:this.lastVideoFramesRecv.set(M.ssrc,{count:X,lts:k,rate:0}),M.receivedFrame={width:$||0,height:ee||0,frameRate:U||0},M.decodedFrame={width:$||0,height:ee||0,frameRate:M.decodeFrameRate||0},M.outputFrame={width:$||0,height:ee||0,frameRate:M.outputFrameRate||M.decodeFrameRate||0}}if(et&&ei){let L=this.lastVideoJBDelay.get(M.ssrc)||{jitterBufferDelay:0,jitterBufferEmittedCount:0,jitterBufferMs:0},k=L.jitterBufferMs,U=ei-L.jitterBufferEmittedCount;U>0&&(k=1e3*(et-L.jitterBufferDelay)/U),M.jitterBufferMs=k,M.currentDelayMs=Math.round(k),this.lastVideoJBDelay.set(M.ssrc,{jitterBufferDelay:et,jitterBufferEmittedCount:ei,jitterBufferMs:M.currentDelayMs})}}processAudioTrackSenderStats(L,k,M){var U,V,F,B;let j=k?this.report.get(k):void 0,G=null!==(U=null!==(V=null==j?void 0:j.echoReturnLoss)&&void 0!==V?V:L.echoReturnLoss)&&void 0!==U?U:0,X=null!==(F=null!==(B=null==j?void 0:j.echoReturnLossEnhancement)&&void 0!==B?B:L.echoReturnLossEnhancement)&&void 0!==F?F:0;M.aecReturnLoss=G,M.aecReturnLossEnhancement=X}processAudioTrackReceiverStats(L,k,M){var U,V,F,B,j,G,X,$,ee;let et=k?this.report.get(k):void 0,ei=null!==(U=null==et?void 0:et.removedSamplesForAcceleration)&&void 0!==U?U:L.removedSamplesForAcceleration,er=null!==(V=null==et?void 0:et.totalSamplesReceived)&&void 0!==V?V:L.totalSamplesReceived,en=null!==(F=null==et?void 0:et.jitterBufferDelay)&&void 0!==F?F:L.jitterBufferDelay,ea=null!==(B=null==et?void 0:et.jitterBufferEmittedCount)&&void 0!==B?B:L.jitterBufferEmittedCount,eo=null!==(j=null==et?void 0:et.audioLevel)&&void 0!==j?j:null==L?void 0:L.audioLevel,es=null!==(G=null==et?void 0:et.totalSamplesDuration)&&void 0!==G?G:null==L?void 0:L.totalSamplesDuration,ec=null!==(X=null==et?void 0:et.concealedSamples)&&void 0!==X?X:L.concealedSamples,ed=null!==($=null==et?void 0:et.silentConcealedSamples)&&void 0!==$?$:L.silentConcealedSamples,el=null!==(ee=null==et?void 0:et.concealmentEvents)&&void 0!==ee?ee:L.concealmentEvents;if("number"==typeof er&&(M.totalSamplesReceived=er),"number"==typeof ed&&(M.silentConcealedSamples=ed),"number"==typeof el&&(M.concealmentEvents=el),"number"==typeof ec&&(M.concealedSamples=ec),ei&&er&&(M.accelerateRate=ei/er),en&&ea){let L=this.lastAudioJBDelay.get(M.ssrc)||{jitterBufferDelay:0,jitterBufferEmittedCount:0,jitterBufferMs:0},k=L.jitterBufferMs,U=ea-L.jitterBufferEmittedCount;U>0&&(k=1e3*(en-L.jitterBufferDelay)/U),M.jitterBufferMs=Math.round(k),this.lastAudioJBDelay.set(M.ssrc,{jitterBufferDelay:en,jitterBufferEmittedCount:ea,jitterBufferMs:M.jitterBufferMs})}M.outputLevel=eo;let eu=1920;es&&er&&(eu=er/es/50,M.receivedFrames=Math.round(er/eu)),ec&&(M.droppedFrames=Math.round(ec/eu))}processRemoteInboundStats(L,k){let M=this.report.get(L);M&&(k.packetsLost=M.packetsLost,M.roundTripTime&&(k.rttMs=1e3*M.roundTripTime),M.jitter&&(k.jitterMs=1e3*M.jitter),M.timestamp&&(k.timestamp=M.timestamp))}getCodecFromCodecStats(L){let k=this.report.get(L);if(!k)return"";let M=k.mimeType.match(/\/(.*)$/);return M&&M[1]?M[1]:""}updateSendBitrate(){let L=0,k=null,M=null;this.mediaBytesSent.forEach(k=>{L+=k.diffMean()}),this.mediaBytesRetransmit.forEach(L=>{k=null===k?L.diffMean():k+L.diffMean()}),this.mediaBytesTargetEncode.forEach(L=>{M=null===M?L.diffMean():M+L.diffMean()});let U=null!==k?L-k:L;this._stats.bitrate={actualEncoded:8*U/(this.options.updateInterval/1e3),transmit:8*L/(this.options.updateInterval/1e3)},null!==k&&(this._stats.bitrate.retransmit=8*k/(this.options.updateInterval/1e3)),null!==M&&(this._stats.bitrate.targetEncoded=8*M/(this.options.updateInterval/1e3))}},SY=class extends Sk{updateStats(){return lQ.resolve()}};function EN(L){let k=arguments.length>1&&void 0!==arguments[1]?arguments[1]:250,M=arguments.length>2&&void 0!==arguments[2]?arguments[2]:8,U=arguments.length>3&&void 0!==arguments[3]?arguments[3]:500,V=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1e4,F=function(){let L=navigator.userAgent.toLocaleLowerCase().match(/chrome\/[\d]*/i);return L&&L[0]?Number(L[0].split("/")[1]):null}();return F?F<76?new SU(L,{updateInterval:k,lossRateInterval:M,freezeRateLimit:U,firstVideoDecodedTimeout:V}):new SK(L,{updateInterval:k,lossRateInterval:M,freezeRateLimit:U,firstVideoDecodedTimeout:V}):!function(L){if(!window.RTCStatsReport)return!1;let k=L.getStats();return!!(k instanceof lQ||k&&("object"==typeof k||"function"==typeof k)&&"function"==typeof k.then)}(L)?new SY(L,{updateInterval:k,lossRateInterval:M,freezeRateLimit:U,firstVideoDecodedTimeout:V}):new SK(L,{updateInterval:k,lossRateInterval:M,freezeRateLimit:U,firstVideoDecodedTimeout:V})}let Sq="websdk_ng_install_id";function fN(){try{if(wN("INSTALL_ID"))return wN("INSTALL_ID");let L=window.localStorage.getItem(Sq);return L||(L=bO(),window.localStorage.setItem(Sq,L)),AN("INSTALL_ID",L),L}catch(L){return}}let SJ=function(L){if(L.match(/[0-9]+\.[0-9]+\.[0-9]+$/))return L;let k=L.match(/([0-9]+\.[0-9]+\.[0-9]+)\-([0-9]+)/);if(k&&k[1]&&k[2]){let L=k[1],M=k[2];return"".concat(L,".").concat(M)}return"4.0.0.999"}("4.24.0"),SX=function(){try{return!0===JSON.parse("true")}catch(L){return!0}}(),SQ=((eI={}).Default="default",eI.Auto="auto",eI.Relay="relay",eI.SdRtn="sd-rtn",eI),SZ=function(){let L=["t","s","t"];L.splice(1,0,"e");let k=L.join(""),M=[];for(let L=0;L<6;L++)M.push("1");let U=M.join(""),V={};return V["us".concat("erna","me")]=k,V["pa".concat("sswo","rd")]=U,Object.assign(V,{turnServerURL:"",tcpport:3433,udpport:3478,forceturn:!1})}();window.DEFAULT_TURN_CONFIG=SZ;let S$={ENABLE_PUBLISHED_USER_LIST:!0,MAX_SUBSCRIPTION:50,SUBSCRIBE_AUDIO_FILTER_TOPN:void 0,ENABLE_PUBLISH_AUDIO_FILTER:void 0,ENABLE_USER_LICENSE_CHECK:!0,DISABLE_FEC:void 0,ENABLE_NTP_REPORT:!1,ENABLE_INSTANT_VIDEO:!1,ENABLE_USER_AUTO_REBALANCE_CHECK:!0,ENABLE_LOSSBASED_BWE:!0,ENABLE_AUT_CC:!0,FORCE_ENABLE_AUT_CC:!1,ENABLE_CC_FALLBACK:void 0,SUBSCRIBE_TWCC:!0,PUBLISH_TWCC:!1,ENABLE_SVC_DEFAULT_CODECS:["H264","VP8","VP9","AV1"],SVC:[],ENABLE_FULL_LINK_AV_SYNC:!1,SVC_MODE:null,PRE_SUB_NUM:1,ENABLE_AUT_FEEDBACK:!0,SVC_EXTENDED:["VP9"]},S0={MIN_FRAME_RATE:1,MAX_FRAME_RATE:30,MAX_THRESHOLD_FRAMERATE:30,BITRATE_MIN_THRESHOLD:100,BITRATE_MAX_THRESHOLD:100,MAX_SCALE:5,BWE_SCALE_UP_THRESHOLD:.6,BWE_SCALE_DOWN_THRESHOLD:.6,PERF_SCALE_UP_THRESHOLD:.7,PERF_SCALE_DOWN_THRESHOLD:.6,MOTION_RESOLUTION_FACTOR:.8,MOTION_BITRATE_FACTOR:.6,DETAIL_FRAMERATE_FACTOR:.8,DETAIL_BITRATE_FACTOR:.6,BALANCE_RESOLUTION_FACTOR:.9,BALANCE_FRAMERATE_FACTOR:.9,BALANCE_BITRATE_FACTOR:.6,OVERUSE_TIMES_THRESHOLD:10,UNDERUSE_TIMES_THRESHOLD:40},S1="v4.24.0-0-gf2267710-dirty(7/31/2025, 7:00:42 PM)",S2={ENABLE_EVENT_REPORT:!0,UPLOAD_LOG:!1,ENABLE_AG_ADAPTATION:!0,FORCE_AG_HIGH_FRAMERATE:!1,FORCE_SUPPORT_AG_ADAPTATION:!1,ENCODER_CONFIG_LIMIT:{},CAMERA_CAPTURE_CONFIG:void 0,ENABLE_PRELOAD:!0,NEW_ICE_RESTART:!0,ICE_RESTART_INTERVAL:1e4,RESTART_SEQUENCE:["udp_tcp_relay","relay"],FIRST_TCP_CANDIDATE:!1,FIRST_TCP_CANDIDATE_INTERVAL:1e3,TURN_DOMAIN:"edge.agora.io",USE_TURN_IP:!0,NEW_TURN_MODE:4,NEW_FORCE_TURN:!1,USE_NEW_RENDER_FREEZE_TIME:!1,ENCODE_EXCEPTION_TIMES:5,ENABLE_ENCODE_EXCEPTION:!0,ENCODE_EXCEPTION_VALIDATE_CODEC:["h264"],VIDEO_ENCODER_CONFIG_LIST:[{width:240,height:180},{width:320,height:240},{width:400,height:300},{width:480,height:360},{width:560,height:420},{width:640,height:480}],DELETE_NEQ_AFTER_USER_LEAVE:!0},S3=Aw(Aw(Aw(Aw({},S2),{},{PROCESS_ID:"",ENCRYPT_AES:!0,AREAS:["CHINA","GLOBAL"],WEBCS_DOMAIN:["webrtc2-ap-web-1.agora.io","webrtc2-2.ap.sd-rtn.com"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-ap-web-3.agora.io","webrtc2-4.ap.sd-rtn.com"],PROXY_CS:["ap-proxy-1.agora.io","ap-proxy-2.agora.io"],CDS_AP:["cds-ap-web-1.agora.io","cds-web-2.ap.sd-rtn.com","cds-ap-web-3.agora.io","cds-web-4.ap.sd-rtn.com"],ACCOUNT_REGISTER:["sua-ap-web-1.agora.io","sua-web-2.ap.sd-rtn.com","sua-ap-web-3.agora.io","sua-web-4.ap.sd-rtn.com"],UAP_AP:["uap-ap-web-1.agora.io","uap-web-2.ap.sd-rtn.com","uap-ap-web-3.agora.io","uap-web-4.ap.sd-rtn.com"],LOG_UPLOAD_SERVER:"logservice.agora.io",EVENT_REPORT_DOMAIN:"statscollector-1.agora.io",EVENT_REPORT_BACKUP_DOMAIN:"web-2.statscollector.sd-rtn.com",GATEWAY_ADDRESS:[],GATEWAY_WSS_ADDRESS:"",LIVE_STREAMING_ADDRESS:"",HTTP_CONNECT_TIMEOUT:5e3,SIGNAL_REQUEST_TIMEOUT:1e4,REPORT_STATS:!0,NOT_REPORT_EVENT:[],PING_PONG_TIME_OUT:10,WEBSOCKET_TIMEOUT_MIN:1e4,EVENT_REPORT_SEND_INTERVAL:3e3,CONFIG_DISTRIBUTE_INTERVAL:3e5,ENABLE_CONFIG_DISTRIBUTE:!0,CANDIDATE_TIMEOUT:5e3,SHOW_REPORT_INVOKER_LOG:!1,SHOW_REPORT_USER_INVOKER_LOG:!0,JOIN_EXTEND:"",PUB_EXTEND:"",SUB_EXTEND:"",FORCE_TURN:!1,TURN_ENABLE_TCP:!0,TURN_ENABLE_UDP:!0,MAX_UPLOAD_CACHE:50,UPLOAD_CACHE_INTERVAL:2e3,AJAX_REQUEST_CONCURRENT:3,REPORT_APP_SCENARIO:void 0,GATEWAY_DOMAINS:["edge.agora.io","edge.sd-rtn.com"],CONNECT_GATEWAY_WITHOUT_DOMAIN:!1,WORKER_DOMAIN:"edge.agora.io",EVENT_REPORT_RETRY:!0,CHROME_FORCE_PLAN_B:!1,AUDIO_SOURCE_VOLUME_UPDATE_INTERVAL:400,AUDIO_SOURCE_AVG_VOLUME_DURATION:3e3,AUDIO_VOLUME_INDICATION_INTERVAL:2e3,VOLUME_VOICE_WEIGHT:10,GET_VOLUME_OF_MUTED_AUDIO_TRACK:!1,STATS_UPDATE_INTERVAL:250,NORMAL_EVENT_QUEUE_CAPACITY:100,CUSTOM_REPORT:!0,CUSTOM_REPORT_LIMIT:20,PROXY_SERVER_TYPE2:"webnginx-proxy.agora.io",PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.sd-rtn.com","webrtc-cloud-proxy.agora.io"],CUSTOM_PUB_ANSWER_MODIFIER:null,CUSTOM_SUB_ANSWER_MODIFIER:null,CUSTOM_PUB_OFFER_MODIFIER:null,CUSTOM_SUB_OFFER_MODIFIER:null,DSCP_TYPE:"high",REMOVE_NEW_CODECS:!0,FRAGEMENT_LENGTH:3,WEBSOCKET_COMPRESS:!1,SIMULCAST:!1,CHECK_VIDEO_VISIBLE_INTERVAL:3e4,CHECK_LOCAL_STATS_INTERVAL:250,PROFILE_SWITCH_INTERVAL:2e3,UNSUPPORTED_VIDEO_CODEC:[],ENUMERATE_DEVICES_INTERVAL:!1,ENUMERATE_DEVICES_INTERVAL_TIME:1e4,USE_NEW_TOKEN:!1,CLOSE_AFB_FOR_LOCAL_AP:!0,JOIN_MAX_CONCURRENCY:6,JOIN_WITH_FALLBACK_SIGNAL_PROXY:!0,JOIN_WITH_FALLBACK_MEDIA_PROXY:!0,JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE:!1,JOIN_GATEWAY_TRY_443PORT_DURATION:2e3,JOIN_GATEWAY_USE_443PORT_ONLY:!1,JOIN_GATEWAY_USE_DUAL_DOMAIN:!0,JOIN_GATEWAY_FALLBACK_PORT:443,USE_TURN_SERVER_OF_GATEWAY:!1,H264_PROFILE_LEVEL_ID:"",USE_NEW_LOG:!1,LOG_VERSION:3,MEDIA_DEVICE_CONSTRAINTS:null,ENCRYPT_PROXY_USERNAME_AND_PSW:!0,SDP_LOGGING:!1,CSP_DETECTED_HOSTNAME_LIST:["agora.io","sd-rtn.com"],REMOTE_AUDIO_TRACK_USES_WEB_AUDIO:!1,LOCAL_AUDIO_TRACK_USES_WEB_AUDIO:!1,BITRATE_ADAPTER_TYPE:"STANDARD_BITRATE",AI_DENOISER_PARAMETERS:{excludedLinks:[]},ADJUST_3A_FROM_PLUGINS:!0,RAISE_H264_BASELINE_PRIORITY:!0,FILTER_SEND_H264_BASELINE:!1,FIRST_H264_PROFILE_LEVEL_ID:"42001f",FIRST_PACKETIZATION_MODE:"",X_GOOGLE_START_BITRATE:void 0,NEW_REPORT_SERVER:!1,NEW_REPORT_SERVER_DOMAINS:["data-reporting.agora.io","data-reporting.agora.io"],VIDEO_INSPECT_WORKER_MESSAGE_LENGTH_LIMIT:3e5,VIDEO_INSPECT_INTERVAL_MINIMUM:1e3,VIDEO_INSPECT_QUALITY_RATIO:.9,VIDEO_INSPECT_WORKER_MANAGER_HOST:"edge.agora.io",VIDEO_INSPECT_WORKER_MANAGER_PORT:"",VIDEO_INSPECT_WORKER_PORT:"",SHOW_VIDEO_INSPECT_WORKER_MESSAGE:!1,STATS_COLLECTOR_PORT:443,FORCE_TURN_TCP:!1,WEBAUDIO_INIT_OPTIONS:void 0,FILTER_VIDEO_FEC:!0,FILTER_AUDIO_FEC:!1,CHROME_DUAL_STREAM_USE_ENCODING:!0,DISABLE_DUAL_STREAM_USE_ENCODING:!1,EXTENSION_USAGE_UPLOAD_INTERVAL:1e4,ICE_RESTART:!0,FINGERPRINT:null,ENABLE_VIDEO_FRAME_CALLBACK:!0,VIDEO_FREEZE_DURATION:500,SPATIALIZER_PARAMETERS:{},UPLOAD_LOG_INTERVAL:3e3,UPLOAD_LOG_REQUEST_RETRY_INTERVAL:2e3,UPLOAD_LOG_REQUEST_MAX_RETRY_INTERVAL:2e4,UPLOAD_LOG_TRY_INTERVAL_WHILE_OFF:5e3,UPLOAD_LOG_RETRY_INTERVAL_V1:1e4,UPLOAD_LOG_TWICE_RETRY_INTERVAL_V1:200,UPLOAD_LOG_LENGTH_EACH_TIME:10,APP_TYPE:0,DISABLE_WEBAUDIO:!1,CHANNEL_MEDIA_RELAY_SERVERS:void 0,KEEP_LAST_FRAME:!0,FORWARD_P2P_CREATION:!0,SYNC_GROUP:!0,BLOCK_LOCAL_CLIENT:!1,ENABLE_AUDIO_TOPN:!1,ENABLE_AUDIO_METADATA:!1,ENABLE_AUDIO_PTS:!1,TOPN_SMOOTH_LEVEL:void 0,TOPN_NEW_SPEAKER_DELAY:void 0,TOPN_SWITCH_HOLD_MS:void 0,TOPN_AUDIO_GAIN:void 0,TOPN_SILENCE_THRESHOLD:250,AP_AREA:!0,ENABLE_ENCODED_TRANSFORM:!1,ENABLE_VIDEO_SEI:!1,IMAGE_MODERATION_WORKER_HOST:"edge.agora.io",IMAGE_MODERATION_WORKER_MESSAGE_LENGTH_LIMIT:3e5,IMAGE_MODERATION_INTERVAL_MINIMUM:1e3,SHOW_IMAGE_MODERATION_WORKER_MESSAGE:!1,IMAGE_MODERATION_QUALITY_RATIO:.9,IMAGE_MODERATION_UPLOAD_REPORT_INTERVAL:5e3,SHOW_GLOBAL_CLIENT_LIST:!1,DATASTREAM_MAX_RETRANSMITS:10,TCP_CANDIDATE_ONLY:!1,EXTERNAL_SIGNAL_REQUEST_TIMEOUT:3e3,SHOW_P2P_LOG:!1,MAX_P2P_TIMEOUT:3e4,P2P_TOKEN_INTERVAL:1e3,SHOW_DATASTREAM2_LOG:!1,RESTRICTION_SET_PLAYBACK_DEVICE:!0,USE_PURE_ENCRYPTION_MASTER_KEY:!1,ENABLE_AUDIO_RED:!1,OPUS_PTIME:void 0,AUDIO_DUPLICATE_NUM:void 0,ENABLE_ABSSENDTIME_AS_SENTTS:!0,ACCOUNT_REGISTER_RETRY_TIMEOUT:1,ACCOUNT_REGISTER_RETRY_RATIO:2,ACCOUNT_REGISTER_RETRY_TIMEOUT_MAX:6e4,ACCOUNT_REGISTER_RETRY_COUNT_MAX:1e5,AUDIO_CONTEXT:null,WEBCS_BACKUP_CONNECT_TIMEOUT:6e3,PLAYER_STATE_DEFER:2e3,SIGNAL_REQUEST_WATCH_INTERVAL:1e3,FILEPATH_LENMAX:255,DUALSTREAM_OPERATION_CHECK:!0,MEDIA_ELEMENT_EXISTS_DEPTH:3,SHIM_CANDIDATE:!1,LEAVE_MSG_TIMEOUT:2e3,STATS_FILTER:{transportId:!0,googTrackId:!0},FILTER_VIDEO_CODEC:[],UNSUPPORTED_VIDEO_UPLINK_CODEC:[],UNSUPPORTED_VIDEO_DOWNLINK_CODEC:[],USE_NEW_NETWORK_CONFIG:!1,AUTO_RESET_AUDIO_ROUTE:!1,PLUGIN_INFO:[],OVERUSE_DETECTOR_PARAMS:S0,CUSTOM_ADAPTATION_DEFAULT_MODE:"",HIDE_NO_POSTER:!1,AP_CACHE_NUM:10,AP_UPDATE_INTERVAL:12e4,AP_CACHE_LIFETIME:12e4,MAX_PRELOAD_ASYNC_LENGTH:3,DISABLE_SCREEN_SHARE_REMB:!1},S$),{},{USE_CANDIDATE_FROM_AP_DETAIL:!1,AP_REQUEST_DETAIL:void 0,ENABLE_ROLE_SELECT_EDGE:!1,CLIENT_ROLE_OPTIONS:void 0,COMPATIBLE_SDP_EXTENSION:["gdpr_forbidden"],LIMIT_BITRATE:void 0,EXPERIMENTS:{},USE_PUB_RTX:!0,USE_SUB_RTX:!0,ENABLE_DATASTREAM_2:!1,USE_XR:!0,ENABLE_PREALLOC_PC:!1,ENABLE_PRE_SUB:!1,ENABLE_SVC:!1,ENABLE_PRE_RENDER:!1,FORCE_DISABLE_AUTO_SUB:!1,ENABLE_PRE_SUB_WITH_PRE_PC:!1,PRE_USE_LOCAL_CODECS:!0},{INSTALL_ID:""}),{},{K_MIN_RENDER_DELAY:66,USE_STANDARD_BITRATE_DEFAULT:!1,VIDEO_NEW_BITRATE_RATIO:void 0,VIDEO_STANDARD_BITRATE_VERSION:2,BASELINE_MORE_H264_BITRATE_RATIO:1.1});function AN(L,k,M){var U,V,F;so(U=Object.keys(S3)).call(U,L)&&(!M&&so(V=Object.keys(S4)).call(V,L)||(S3[L]=k,"ENABLE_VIDEO_SEI"!==L&&"ENABLE_AUDIO_TOPN"!==L&&"ENABLE_AUDIO_METADATA"!==L&&"ENABLE_AUDIO_PTS"!==L||!0!==k||(S3.ENABLE_ENCODED_TRANSFORM=!0),"USE_NEW_NETWORK_CONFIG"===L&&k&&(F=!!k,S3.USE_NEW_NETWORK_CONFIG=F,F&&(S3.WEBCS_DOMAIN=["webrtc2-2.ap.sd-rtn.com"],S3.WEBCS_DOMAIN_BACKUP_LIST=["webrtc2-4.ap.sd-rtn.com"],S3.CDS_AP=["cds-web-2.ap.sd-rtn.com","cds-web-4.ap.sd-rtn.com"],S3.ACCOUNT_REGISTER=["sua-web-2.ap.sd-rtn.com","sua-web-4.ap.sd-rtn.com"],S3.EVENT_REPORT_DOMAIN="web-2.statscollector.sd-rtn.com",S3.EVENT_REPORT_BACKUP_DOMAIN="statscollector-1.agora.io",S3.GATEWAY_DOMAINS=["edge.sd-rtn.com"])),"ENABLE_PRE_SUB"===L&&k&&(S3.ENABLE_INSTANT_VIDEO=!0,S3.ENABLE_PREALLOC_PC=!0),"ENABLE_SVC"===L&&k&&(S3.ENABLE_AUT_CC=!0),"NEW_FORCE_TURN"===L&&k&&(S3.NEW_TURN_MODE||(S3.NEW_TURN_MODE=4))))}function wN(L){return S3[L]}SX||(S3.WEBCS_DOMAIN=["ap-web-1-oversea.agora.io","ap-web-1-north-america.agora.io"],S3.WEBCS_DOMAIN_BACKUP_LIST=["ap-web-2-oversea.agora.io","ap-web-2-north-america.agora.io"],S3.PROXY_CS=["proxy-ap-web-oversea.agora.io","proxy-ap-web-america.agora.io"],S3.CDS_AP=["cds-ap-web-oversea.agora.io","cds-ap-web-america.agora.io","cds-ap-web-america2.agora.io"],S3.ACCOUNT_REGISTER=["sua-ap-web-oversea.agora.io","sua-ap-web-america.agora.io","sua-ap-web-america2.agora.io"],S3.UAP_AP=["uap-ap-web-oversea.agora.io","uap-ap-web-america.agora.io","uap-ap-web-america2.agora.io"],S3.LOG_UPLOAD_SERVER="logservice-oversea.agora.io",S3.EVENT_REPORT_DOMAIN="statscollector-1-oversea.agora.io",S3.EVENT_REPORT_BACKUP_DOMAIN="statscollector-2-oversea.agora.io",S3.PROXY_SERVER_TYPE3="webrtc-cloud-proxy.agora.io",S3.AREAS=["NORTH_AMERICA","OVERSEA"]);let S5=((ev={})[ev.REALTIME=1]="REALTIME",ev),S4={};var S6=((eC=S6||{}).SET_SESSION_ID="SET_SESSION_ID",eC.SET_P2P_ID="SET_P2P_id",eC.SET_DC_ID="SET_DC_id",eC.SET_UID="SET_UID",eC.SET_INT_UID="SET_INT_UID",eC.SET_PUB_ID="SET_PUB_ID",eC.SET_CLOUD_PROXY_SERVER_MODE="SET_CLOUD_PROXY_SERVER_MODE",eC.KEY_METRIC_CLIENT_CREATED="KEY_METRIC_CLIENT_CREATED",eC.KEY_METRIC_JOIN_START="KEY_METRIC_JOIN_START",eC.KEY_METRIC_PRELOAD_START="KEY_METRIC_PRELOAD_START",eC.KEY_METRIC_PRELOAD_END="KEY_METRIC_PRELOAD_END",eC.KEY_METRIC_JOIN_END="KEY_METRIC_JOIN_END",eC.KEY_METRIC_REQUEST_AP_START="KEY_METRIC_REQUEST_AP_START",eC.KEY_METRIC_REQUEST_AP_END="KEY_METRIC_REQUEST_AP_END",eC.KEY_METRIC_REQUEST_SUA_END="KEY_METRIC_REQUEST_SUA_END",eC.KEY_METRIC_BEFORE_CONNECT="KEY_METRIC_BEFORE_CONNECT",eC.KEY_METRIC_PEER_RECEIVER="KEY_METRIC_PEER_RECEIVER",eC.KEY_METRIC_SIGNAL_CONNECTED="KEY_METRIC_SIGNAL_CONNECTED",eC.KEY_METRIC_JOIN_REQ="KEY_METRIC_JOIN_REQ",eC.KEY_METRIC_JOIN_REP="KEY_METRIC_JOIN_REP",eC.KEY_METRIC_JOIN_GATEWAY_START="KEY_METRIC_JOIN_GATEWAY_START",eC.KEY_METRIC_JOIN_GATEWAY_END="KEY_METRIC_JOIN_GATEWAY_END",eC.KEY_METRIC_PEER_CONNECTION_START="KEY_METRIC_PEER_CONNECTION_START",eC.KEY_METRIC_PEER_CONNECTION_END="KEY_METRIC_PEER_CONNECTION_END",eC.KEY_METRIC_FIRST_VIDEO_FRAME_DECODED="KEY_METRIC_FIRST_VIDEO_FRAME_DECODED",eC.KEY_METRIC_DESCRIPTION_START="KEY_METRIC_DESCRIPTION_START",eC.KEY_METRIC_ICE_CONNECTION_END="KEY_METRIC_ICE_CONNECTION_END",eC.KEY_METRIC_SIGNAL_CHANNEL_OPEN="KEY_METRIC_SIGNAL_CHANNEL_OPEN",eC.KEY_METRIC_PUBLISH="KEY_METRIC_PUBLISH",eC.KEY_METRIC_SUBSCRIBE="KEY_METRIC_SUBSCRIBE",eC.RECORD_JOIN_CHANNEL_SERVICE="RECORD_JOIN_CHANNEL_SERVICE",eC.RESET_JOIN_CHANNEL_SERVICE_RECORDS="RESET_JOIN_CHANNEL_SERVICE_RECORDS",eC.RESET_KEY_METRICS="RESET_KEY_METRICS",eC.RESET_FIRST_VIDEO_FRAME_DECODED="RESET_FIRST_VIDEO_FRAME_DECODED",eC.SET_USE_P2P="SET_USE_P2P",eC.SET_TRANSPORT_TYPE="SET_TRANSPORT_TYPE",eC);let S8=((ey={}).h264="h264",ey.h265="h265",ey.vp8="vp8",ey.vp9="vp9",ey.av1="av1",ey);(eb={}).opus="opus",eb.pcma="pcma",eb.pcmu="pcmu",eb.g722="g722";let S9=0;var S7=(()=>{var L={8:(L,k,M)=>{var U;let V;M.r(k),M.d(k,{Parser:()=>v,Printer:()=>A,parse:()=>D,print:()=>P});let F="".concat("\r").concat("\n");function a(L){return L>="0"&&L<="9"}function c(L){return L>="!"&&L<="~"}function d(L){return c(L)||L>="\x80"&&L<="\xff"}function l(L){return"!"===L||L>="#"&&L<="'"||L>="*"&&L<="+"||L>="-"&&L<="."||L>="0"&&L<="9"||L>="A"&&L<="Z"||L>="^"&&L<="~"}function u(L){return L>="1"&&L<="9"}function h(L){return L>="A"&&L<="Z"||L>="a"&&L<="z"}function p(L){return"d"===L||"h"===L||"m"===L||"s"===L}function _(L){return L>"\x01"&&L<"	"||L>"\v"&&L<"\f"||L>"\x0e"&&L<"\xff"}function E(L){return h(L)||a(L)||"+"===L||"/"===L}function m(L){return a(L)||h(L)||"+"===L||"/"===L||"-"===L||"_"===L}function f(L){return h(L)||a(L)||"+"===L||"/"===L}function S(L,k){var M=Object.keys(L);if(Object.getOwnPropertySymbols){var U=Object.getOwnPropertySymbols(L);k&&(U=U.filter(function(k){return Object.getOwnPropertyDescriptor(L,k).enumerable})),M.push.apply(M,U)}return M}function g(L){for(var k=1;k<arguments.length;k++){var M=null!=arguments[k]?arguments[k]:{};k%2?S(Object(M),!0).forEach(function(k){T(L,k,M[k])}):Object.getOwnPropertyDescriptors?Object.defineProperties(L,Object.getOwnPropertyDescriptors(M)):S(Object(M)).forEach(function(k){Object.defineProperty(L,k,Object.getOwnPropertyDescriptor(M,k))})}return L}function T(L,k,M){return k in L?Object.defineProperty(L,k,{value:M,enumerable:!0,configurable:!0,writable:!0}):L[k]=M,L}(U=V||(V={})).VERSION="v",U.ORIGIN="o",U.SESSION_NAME="s",U.INFORMATION="i",U.URI="u",U.EMAIL="e",U.PHONE="p",U.CONNECTION="c",U.BANDWIDTH="b",U.TIME="t",U.REPEAT="r",U.ZONE_ADJUSTMENTS="z",U.KEY="k",U.ATTRIBUTE="a",U.MEDIA="m";let R=class R{consumeText(L,k){let M=k;for(;M<L.length;){let k=L[M];if("\x00"===k||"\r"===k||"\n"===k)break;M+=1}if(M-k==0)throw Error("Invalid text, at ".concat(L));return M}consumeUnicastAddress(L,k,M){return this.consumeTill(L,k," ")}consumeOneOrMore(L,k,M){let U=k;for(;M(L[U]);)U++;if(U-k==0)throw Error("Invalid rule at ".concat(k,"."));return U}consumeSpace(L,k){if(" "===L[k])return k+1;throw Error("Invalid space at ".concat(k,"."))}consumeIP4Address(L,k){let M=k;for(let k=0;k<4;k++)if(M=this.consumeDecimalUChar(L,M),3!==k){if("."!==L[M])throw Error("Invalid IP4 address.");M++}return M}consumeDecimalUChar(L,k){let M=k;for(let k=0;k<3&&a(L[M]);k++,M++);if(M-k==0)throw Error("Invalid decimal uchar.");let U=parseInt(L.slice(k,M));if(U>=0&&U<=255)return M;throw Error("Invalid decimal uchar")}consumeIP6Address(L,k){let M=this.consumeHexpart(L,k);return":"===L[M]?(M+=1,M=this.consumeIP4Address(L,M)):M}consumeHexpart(L,k){let M=k;if(":"===L[M]&&":"===L[M+1]){M+=2;try{M=this.consumeHexseq(L,M)}catch(L){}return M}if(M=this.consumeHexseq(L,M),":"===L[M]&&":"===L[M+1]){M+=2;try{M=this.consumeHexseq(L,M)}catch(L){}}return M}consumeHexseq(L,k){let M=k;for(;M=this.consumeHex4(L,M),":"===L[M]&&":"!==L[M+1];)M+=1;return M}consumeHex4(L,k){var M;let U=0;for(;U<4;U++)if(!((M=L[k+U])>="0"&&M<="9"||M>="a"&&M<="f"||M>="A"&&M<="F")){if(0===U)throw Error("Invalid hex 4");break}return k+U}consumeFQDN(L,k){let M=k;for(;a(L[M])||h(L[M])||"-"===L[M]||"."===L[M];)M+=1;if(M-k<4)throw Error("Invalid FQDN");return M}consumeExtnAddr(L,k){return this.consumeOneOrMore(L,k,d)}consumeMulticastAddress(L,k,M){switch(M){case"IP4":case"ip4":return this.consumeIP4MulticastAddress(L,k);case"IP6":case"ip6":return this.consumeIP6MulticastAddress(L,k);default:try{return this.consumeFQDN(L,k)}catch(M){return this.consumeExtnAddr(L,k)}}}consumeIP6MulticastAddress(L,k){let M=this.consumeHexpart(L,k);return"/"===L[M]?this.consumeInteger(L,M+1):M}consumeIP4MulticastAddress(L,k){let M=k+3,U=L.slice(k,M),V=parseInt(U);if(V<224||V>239)throw Error("Invalid IP4 multicast address, IPv4 multicast addresses may be in the range 224.0.0.0 to 239.255.255.255.");for(let k=0;k<3;k++){if("."!==L[M])throw Error("Invalid IP4 multicast address.");M+=1,M=this.consumeDecimalUChar(L,M)}return"/"===L[M]&&(M+=1),M=this.consumeTTL(L,M),"/"===L[M]&&(M=this.consumeInteger(L,M)),M}consumeInteger(L,k){if(!u(L[k]))throw Error("Invalid integer.");for(k+=1;a(L[k]);)k+=1;return k}consumeTTL(L,k){if("0"===L[k])return k+1;if(!u(L[k]))throw Error("Invalid TTL.");k+=1;for(let M=0;M<2&&a(L[k]);M++)k+=1;return k}consumeToken(L,k){return this.consumeOneOrMore(L,k,l)}consumeTime(L,k){let M=k;if("0"===L[M])return M+1;for(u(L[M])&&(M+=1);a(L[M]);)M++;if(M-k<10)throw Error("Invalid time");return M}consumeAddress(L,k){return this.consumeTill(L,k," ")}consumeTypedTime(L,k){let M=k;return M=this.consumeOneOrMore(L,M,a),p(L[M])?M+1:M}consumeRepeatInterval(L,k){if(!u(L[k]))throw Error("Invalid repeat interval");for(k+=1;a(L[k]);)k+=1;return p(L[k])&&(k+=1),k}consumePort(L,k){return this.consumeOneOrMore(L,k,a)}consume(L,k,M){for(let U=0;U<M.length;U++){if(k+U>=L.length)throw Error("consume exceeding value length");if(L[k+U]!==M[U])throw Error("consume ".concat(M," failed at ").concat(U))}return k+M.length}consumeTill(L,k,M){let U=k;for(;U<L.length&&("string"!=typeof M||L[U]!==M)&&("function"!=typeof M||!M(L[U]));)U++;return U}};let v=class v extends R{constructor(){super(),T(this,"records",[]),T(this,"currentLine",0)}parse(L){let k=this.probeEOL(L);this.records=L.split(k).filter(L=>!!_p(L).call(L)).map(this.parseLine),this.currentLine=0;let M=this.parseVersion(),U=this.parseOrigin(),V=this.parseSessionName(),F=this.parseInformation(),B=this.parseUri(),j=this.parseEmail(),G=this.parsePhone(),X=this.parseConnection(),$=this.parseBandWidth(),ee=this.parseTimeFields(),et=this.parseKey(),ei=this.parseSessionAttribute(),er=this.parseMediaDescription();if(this.currentLine!==this.records.length)throw Error("parsing failed, non exhaustive sdp lines.");return{version:M,origin:U,sessionName:V,information:F,uri:B,emails:j,phones:G,connection:X,bandwidths:$,timeFields:ee,key:et,attributes:ei,mediaDescriptions:er}}getCurrentRecord(){let L=this.records[this.currentLine];if(!L)throw Error("Record doesn't exit.");return L}probeEOL(L){for(let k=0;k<L.length;k++)if("\n"===L[k])return"\r"===L[k-1]?F:"\n";throw Error("Invalid newline character.")}parseLine(L,k){if(L.length<2)throw Error("Invalid sdp line, sdp line should be of form <type>=<value>.");let M=L[0];if("="!==L[1])throw Error('Invalid sdp line, <type> should be a single character followed by an "=" sign.');return{type:M,value:L.slice(2),line:k,cur:0}}parseSessionAttribute(){let L=new y;for(;this.currentLine<this.records.length;){let k=this.getCurrentRecord();if(k.type!==V.ATTRIBUTE)break;let M={attField:this.extractOneOrMore(k,L=>l(L)&&":"!==L),_cur:0};":"===k.value[k.cur]&&(k.cur+=1,M.attValue=this.extractOneOrMore(k,_)),L.parse(M),this.currentLine++}return L.digest()}parseMediaAttributes(L){let k=new I(L);for(;this.currentLine<this.records.length;){let L=this.getCurrentRecord();if(L.type!==V.ATTRIBUTE)break;let M={attField:this.extractOneOrMore(L,L=>l(L)&&":"!==L),_cur:0};":"===L.value[L.cur]&&(L.cur+=1,M.attValue=this.extractOneOrMore(L,_)),k.parse(M),this.currentLine++}return k.digest()}parseKey(){let L=this.getCurrentRecord();if(L.type===V.KEY){if("prompt"===L.value||"clear:"===L.value||"base64:"===L.value||"uri:"===L.value)return L.value;throw this.currentLine++,Error("Invalid key.")}}parseZone(){let L=this.getCurrentRecord();if(L.type===V.ZONE_ADJUSTMENTS){let k=[];for(;;)try{let M=this.extract(L,this.consumeTime);this.consumeSpaceForRecord(L);let U=!1;"-"===L.value[L.cur]&&(U=!0,L.cur+=1);let V=this.extract(L,this.consumeTypedTime);k.push({time:M,typedTime:V,back:U})}catch(L){break}if(0===k.length)throw Error("Invalid zone adjustments");return this.currentLine++,k}return[]}parseRepeat(){let L=[];for(;;){let k=this.getCurrentRecord();if(k.type!==V.REPEAT)break;{let M=this.extract(k,this.consumeRepeatInterval),U=this.parseTypedTime(k);L.push({repeatInterval:M,typedTimes:U}),this.currentLine++}}return L}parseTypedTime(L){let k=[];for(;;)try{this.consumeSpaceForRecord(L),k.push(this.extract(L,this.consumeTypedTime))}catch(L){break}if(0===k.length)throw Error("Invalid typed time.");return k}parseTime(){let L=this.getCurrentRecord(),k=this.extract(L,this.consumeTime);this.consumeSpaceForRecord(L);let M=this.extract(L,this.consumeTime);return this.currentLine++,{startTime:k,stopTime:M}}parseBandWidth(){let L=[];for(;this.currentLine<this.records.length;){let k=this.getCurrentRecord();if(k.type!==V.BANDWIDTH)break;{let M=this.extractOneOrMore(k,l);if(":"!==k.value[k.cur])throw Error("Invalid bandwidth field.");k.cur++;let U=this.extractOneOrMore(k,a);L.push({bwtype:M,bandwidth:U}),this.currentLine++}}return L}parseVersion(){let L=this.getCurrentRecord();if(L.type!==V.VERSION)throw Error("first sdp record must be version");let k=L.value.slice(0,this.consumeOneOrMore(L.value,0,a));if(k.length!==L.value.length)throw Error('invalid proto version, "v='.concat(L.value,'"'));return this.currentLine++,k}parseOrigin(){let L=this.getCurrentRecord();if(L.type!==V.ORIGIN)throw Error("second line of sdp must be origin");let k=this.extractOneOrMore(L,d);this.consumeSpaceForRecord(L);let M=this.extractOneOrMore(L,a);this.consumeSpaceForRecord(L);let U=this.extractOneOrMore(L,a);this.consumeSpaceForRecord(L);let F=this.extractOneOrMore(L,l);this.consumeSpaceForRecord(L);let B=this.extractOneOrMore(L,l);this.consumeSpaceForRecord(L);let j=this.extract(L,this.consumeUnicastAddress);return this.currentLine++,{username:k,sessId:M,sessVersion:U,nettype:F,addrtype:B,unicastAddress:j}}parseSessionName(){let L=this.getCurrentRecord();if(L.type===V.SESSION_NAME){let k=this.extract(L,this.consumeText);return this.currentLine++,k}}parseInformation(){let L=this.getCurrentRecord();if(L.type!==V.INFORMATION)return;let k=this.extract(L,this.consumeText);return this.currentLine++,k}parseUri(){let L=this.getCurrentRecord();if(L.type===V.URI)return this.currentLine++,L.value}parseEmail(){let L=[];for(;;){let k=this.getCurrentRecord();if(k.type!==V.EMAIL)break;L.push(k.value),this.currentLine++}return L}parsePhone(){let L=[];for(;;){let k=this.getCurrentRecord();if(k.type!==V.PHONE)break;L.push(k.value),this.currentLine++}return L}parseConnection(){let L=this.getCurrentRecord();if(L.type===V.CONNECTION){let k=this.extractOneOrMore(L,l);this.consumeSpaceForRecord(L);let M=this.extractOneOrMore(L,l);this.consumeSpaceForRecord(L);let U=this.extract(L,this.consumeAddress);return this.currentLine++,{nettype:k,addrtype:M,address:U}}}parseMedia(){let L=this.getCurrentRecord(),k=this.extract(L,this.consumeToken);this.consumeSpaceForRecord(L);let M=this.extract(L,this.consumePort);"/"===L.value[L.cur]&&(L.cur+=1,M+=this.extract(L,this.consumeInteger)),this.consumeSpaceForRecord(L);let U=[];for(U.push(this.extract(L,this.consumeToken));"/"===L.value[L.cur];)L.cur+=1,U.push(this.extract(L,this.consumeToken));if(0===U.length)throw Error("Invalid proto");let V=this.parseFmt(L);return this.currentLine++,{mediaType:k,port:M,protos:U,fmts:V}}parseTimeFields(){let L=[];for(;this.getCurrentRecord().type===V.TIME;){let k=this.parseTime(),M=this.parseRepeat(),U=this.parseZone();L.push({time:k,repeats:M,zones:U})}return L}parseMediaDescription(){let L=[];for(;this.currentLine<this.records.length&&this.getCurrentRecord().type===V.MEDIA;){let k=this.parseMedia(),M=this.parseInformation(),U=this.parseConnections(),V=this.parseBandWidth(),F=this.parseKey(),B=this.parseMediaAttributes(k);L.push({media:k,information:M,connections:U,bandwidths:V,key:F,attributes:B})}return L}parseConnections(){let L=[];for(;this.currentLine<this.records.length&&this.getCurrentRecord().type===V.CONNECTION;)L.push(this.parseConnection());return L}parseFmt(L){let k=[];for(;;)try{this.consumeSpaceForRecord(L),k.push(this.extract(L,this.consumeToken))}catch(L){break}if(0===k.length)throw Error("Invalid fmts");return k}extract(L,k){for(var M=arguments.length,U=Array(M>2?M-2:0),V=2;V<M;V++)U[V-2]=arguments[V];let F=k.call(this,L.value,L.cur,...U),B=L.value.slice(L.cur,F);return L.cur=F,B}extractOneOrMore(L,k){let M=this.consumeOneOrMore(L.value,L.cur,k),U=L.value.slice(L.cur,M);return L.cur=M,U}consumeSpaceForRecord(L){if(" "!==L.value[L.cur])throw Error("Invalid space at ".concat(L.cur,"."));L.cur+=1}};let C=class C extends R{constructor(){super(...arguments),T(this,"attributes",void 0),T(this,"digested",!1)}extractOneOrMore(L,k,M){let U=this.consumeOneOrMore(L.attValue,L._cur,k),V=L.attValue.slice(L._cur,U),[F,B]=M||[];if("number"==typeof F&&V.length<F)throw Error("error in length, should be more or equal than ".concat(F," characters."));if("number"==typeof B&&V.length>B)throw Error("error in length, should be less or equal than ".concat(B," characters."));return L._cur=U,V}consumeAttributeSpace(L){if(" "!==L.attValue[L._cur])throw Error("Invalid space at ".concat(L._cur,"."));L._cur+=1}extract(L,k){if(!L.attValue)throw Error("Nothing to extract from attValue.");for(var M=arguments.length,U=Array(M>2?M-2:0),V=2;V<M;V++)U[V-2]=arguments[V];let F=k.call(this,L.attValue,L._cur,...U),B=L.attValue.slice(L._cur,F);return L._cur=F,B}atEnd(L){if(!L.attValue)throw Error();return L._cur>=L.attValue.length}peekChar(L){if(!L.attValue)throw Error();return L.attValue[L._cur]}peek(L,k){if(!L.attValue)throw Error();for(let M=0;M<k.length;M++)if(k[M]!==L.attValue[L._cur+M])return!1;return!0}parseIceUfrag(L){if(this.attributes.iceUfrag)throw Error("Invalid ice-ufrag, should be only a single line if 'a=ice-ufrag'");this.attributes.iceUfrag=this.extractOneOrMore(L,E,[4,256])}parseIcePwd(L){if(this.attributes.icePwd)throw Error("Invalid ice-pwd, should be only a single line if 'a=ice-pwd'");this.attributes.icePwd=this.extractOneOrMore(L,E,[22,256])}parseIceOptions(L){if(this.attributes.iceOptions)throw Error("Invalid ice-options, should be only one 'ice-options' line");let k=[];for(;!this.atEnd(L);){k.push(this.extractOneOrMore(L,E));try{this.consumeAttributeSpace(L)}catch(k){if(this.atEnd(L))break;throw k}}this.attributes.iceOptions=k}parseFingerprint(L){let k=this.extract(L,this.consumeToken);this.consumeAttributeSpace(L);let M=this.extract(L,this.consumeTill);this.attributes.fingerprints.push({hashFunction:k,fingerprint:M})}parseExtmap(L){let k;let M=this.extractOneOrMore(L,a);"/"===this.peekChar(L)&&(this.extract(L,this.consume,"/"),k=this.extract(L,this.consumeToken)),this.consumeAttributeSpace(L);let U=this.extract(L,this.consumeTill," "),V=g(g({entry:parseInt(M,10)},k&&{direction:k}),{},{extensionName:U});" "===this.peekChar(L)&&(this.consumeAttributeSpace(L),V.extensionAttributes=this.extract(L,this.consumeTill)),this.attributes.extmaps.push(V)}parseSetup(L){if(this.attributes.setup)throw Error("must only be one single 'a=setup' line.");let k=this.extract(L,this.consumeTill);if("active"!==k&&"passive"!==k&&"actpass"!==k&&"holdconn"!==k)throw Error("role must be one of 'active', 'passive', 'actpass', 'holdconn'.");this.attributes.setup=k}};let y=class y extends C{constructor(){super(...arguments),T(this,"attributes",{unrecognized:[],groups:[],extmaps:[],fingerprints:[],identities:[]})}parse(L){if(this.digested)throw Error("already digested");try{switch(L.attField){case"group":this.parseGroup(L);break;case"ice-lite":this.parseIceLite();break;case"ice-ufrag":this.parseIceUfrag(L);break;case"ice-pwd":this.parseIcePwd(L);break;case"ice-options":this.parseIceOptions(L);break;case"fingerprint":this.parseFingerprint(L);break;case"setup":this.parseSetup(L);break;case"tls-id":this.parseTlsId(L);break;case"identity":this.parseIdentity(L);break;case"extmap":this.parseExtmap(L);break;case"msid-semantic":this.parseMsidSemantic(L);break;default:L.ignored=!0,this.attributes.unrecognized.push(L)}}catch(k){throw console.error("parsing session attribute ".concat(L.attField,' error, "a=').concat(L.attField,":").concat(L.attValue,'"')),k}if(!L.ignored&&L.attValue&&!this.atEnd(L))throw Error("attribute parsing error")}digest(){return this.digested=!0,this.attributes}parseGroup(L){let k=this.extract(L,this.consumeToken),M=[];for(;!this.atEnd(L)&&" "===this.peekChar(L);)this.consumeAttributeSpace(L),M.push(this.extract(L,this.consumeToken));this.attributes.groups.push({semantic:k,identificationTag:M})}parseIceLite(){if(this.attributes.iceLite)throw Error("Invalid ice-lite, should be only a single line of 'a=ice-lite'");this.attributes.iceLite=!0}parseTlsId(L){if(this.attributes.tlsId)throw Error("must be only one tld-id line");this.attributes.tlsId=this.extractOneOrMore(L,m)}parseIdentity(L){let k=this.extractOneOrMore(L,f),M=[];for(;!this.atEnd(L)&&" "===this.peekChar(L);){this.consumeAttributeSpace(L);let k=this.extract(L,this.consumeToken);this.extract(L,this.consume,"=");let U=this.extractOneOrMore(L,L=>" "!==L&&_(L));M.push({name:k,value:U})}this.attributes.identities.push({assertionValue:k,extensions:M})}parseMsidSemantic(L){" "===this.peekChar(L)&&this.consumeAttributeSpace(L);let k={semantic:this.extract(L,this.consumeToken),identifierList:[]};for(;;){try{this.consumeAttributeSpace(L)}catch(L){break}if("*"===this.peekChar(L)){this.extract(L,this.consume,"*"),k.applyForAll=!0;break}{let M=this.extract(L,this.consumeTill," ");k.identifierList.push(M)}}this.attributes.msidSemantic=k}};let I=class I extends C{constructor(L){super(),T(this,"attributes",void 0),-1!==L.protos.indexOf("RTP")||L.protos.indexOf("rtp"),this.attributes={unrecognized:[],candidates:[],extmaps:[],fingerprints:[],imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:[],ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:[]}}parse(L){if(this.digested)throw Error("already digested");try{switch(L.attField){case"extmap":this.parseExtmap(L);break;case"setup":this.parseSetup(L);break;case"ice-ufrag":this.parseIceUfrag(L);break;case"ice-pwd":this.parseIcePwd(L);break;case"ice-options":this.parseIceOptions(L);break;case"candidate":this.parseCandidate(L);break;case"remote-candidate":this.parseRemoteCandidate(L);break;case"end-of-candidates":this.parseEndOfCandidates();break;case"fingerprint":this.parseFingerprint(L);break;case"rtpmap":this.parseRtpmap(L);break;case"ptime":this.parsePtime(L);break;case"maxptime":this.parseMaxPtime(L);break;case"sendrecv":case"recvonly":case"sendonly":case"inactive":this.parseDirection(L);break;case"ssrc":this.parseSSRC(L);break;case"fmtp":this.parseFmtp(L);break;case"rtcp-fb":this.parseRtcpFb(L);break;case"rtcp-mux":this.parseRTCPMux();break;case"rtcp-mux-only":this.parseRTCPMuxOnly();break;case"rtcp-rsize":this.parseRTCPRsize();break;case"rtcp":this.parseRTCP(L);break;case"mid":this.parseMid(L);break;case"msid":this.parseMsid(L);break;case"imageattr":this.parseImageAttr(L);break;case"rid":this.parseRid(L);break;case"simulcast":this.parseSimulcast(L);break;case"sctp-port":this.parseSctpPort(L);break;case"max-message-size":this.parseMaxMessageSize(L);break;case"ssrc-group":this.parseSSRCGroup(L);break;default:L.ignored=!0,this.attributes.unrecognized.push(L)}}catch(k){throw console.error("parsing media attribute ".concat(L.attField,' error, "a=').concat(L.attField,":").concat(L.attValue,'"')),k}if(!L.ignored&&L.attValue&&!this.atEnd(L))throw Error("attribute parsing error")}parseCandidate(L){let k=this.extractOneOrMore(L,E,[1,32]);this.consumeAttributeSpace(L);let M=this.extractOneOrMore(L,a,[1,5]);this.consumeAttributeSpace(L);let U=this.extract(L,this.consumeToken);this.consumeAttributeSpace(L);let V=this.extractOneOrMore(L,a,[1,10]);this.consumeAttributeSpace(L);let F=this.extract(L,this.consumeAddress);this.consumeAttributeSpace(L);let B=this.extract(L,this.consumePort);this.consumeAttributeSpace(L),this.extract(L,this.consume,"typ"),this.consumeAttributeSpace(L);let j={foundation:k,componentId:M,transport:U,priority:V,connectionAddress:F,port:B,type:this.extract(L,this.consumeToken),extension:{}};for(this.peek(L," raddr")&&(this.extract(L,this.consume," raddr"),this.consumeAttributeSpace(L),j.relAddr=this.extract(L,this.consumeAddress)),this.peek(L," rport")&&(this.extract(L,this.consume," rport"),this.consumeAttributeSpace(L),j.relPort=this.extract(L,this.consumePort));" "===this.peekChar(L);){this.consumeAttributeSpace(L);let k=this.extract(L,this.consumeToken);this.consumeAttributeSpace(L),j.extension[k]=this.extractOneOrMore(L,c)}this.attributes.candidates.push(j)}parseRemoteCandidate(L){let k=[];for(;;){let M=this.extractOneOrMore(L,a,[1,5]);this.consumeAttributeSpace(L);let U=this.extract(L,this.consumeAddress);this.consumeAttributeSpace(L);let V=this.extract(L,this.consumePort);k.push({componentId:M,connectionAddress:U,port:V});try{this.consumeAttributeSpace(L)}catch(L){break}}this.attributes.remoteCandidatesList.push(k)}parseEndOfCandidates(){if(this.attributes.endOfCandidates)throw Error("must be only one line of end-of-candidates");this.attributes.endOfCandidates=!0}parseRtpmap(L){let k=this.extract(L,this.consumeToken);this.consumeAttributeSpace(L);let M=this.extract(L,this.consumeTill,"/");this.extract(L,this.consume,"/");let U={encodingName:M,clockRate:this.extractOneOrMore(L,a)};this.atEnd(L)||"/"!==this.peekChar(L)||(this.extract(L,this.consume,"/"),U.encodingParameters=parseInt(this.extract(L,this.consumeTill),10));let V=this.attributes.payloads.find(L=>L.payloadType===parseInt(k,10));V?V.rtpMap=U:this.attributes.payloads.push({payloadType:parseInt(k,10),rtpMap:U,rtcpFeedbacks:[]})}parsePtime(L){if(this.attributes.ptime)throw Error("must be only one line of ptime");this.attributes.ptime=this.extract(L,this.consumeTill)}parseMaxPtime(L){if(this.attributes.maxPtime)throw Error("must be only one line of ptime");this.attributes.maxPtime=this.extract(L,this.consumeTill)}parseDirection(L){if(this.attributes.direction)throw Error("must be only one line of direction info");this.attributes.direction=L.attField}parseSSRC(L){let k;let M=this.extractOneOrMore(L,a);this.consumeAttributeSpace(L);let U=this.extract(L,this.consumeTill,":");":"===this.peekChar(L)&&(this.extract(L,this.consume,":"),k=this.extract(L,this.consumeTill));let V=this.attributes.ssrcs.find(L=>L.ssrcId===parseInt(M,10));V?V.attributes[U]=k:this.attributes.ssrcs.push({ssrcId:parseInt(M,10),attributes:{[U]:k}})}parseFmtp(L){let k=this.extract(L,this.consumeTill," ");this.consumeAttributeSpace(L);let M=this.extract(L,this.consumeTill),U={};M.split(";").forEach(L=>{let[k,M]=L.split("=");k=_p(k).call(k);let V="string"==typeof M?_p(M).call(M):null;"string"==typeof k&&k.length>0&&(U[k]=V)});let V=this.attributes.payloads.find(L=>L.payloadType===parseInt(k,10));V?V.fmtp={parameters:U}:this.attributes.payloads.push({payloadType:parseInt(k,10),rtcpFeedbacks:[],fmtp:{parameters:U}})}parseFmtParameters(L){let k={},M=this.extract(L,this.consumeTill,"=");L._cur++;let U=this.extract(L,this.consumeTill,";");for(k[M]=U;";"===L.attValue[L._cur];){let M=this.extract(L,this.consumeTill,"=");L._cur++;let U=this.extract(L,this.consumeTill,";");k[M]=U}return k}parseRtcpFb(L){let k,M="";M="*"===this.peekChar(L)?this.extract(L,this.consume,"*"):this.extract(L,this.consumeTill," "),this.consumeAttributeSpace(L);let U=this.extract(L,this.consumeTill," ");if("trr-int"===U)k={type:U,interval:this.extract(L,this.consumeTill)};else{let M={type:U};" "===this.peekChar(L)&&(this.consumeAttributeSpace(L),M.parameter=this.extract(L,this.consumeToken)," "===this.peekChar(L)&&(M.additional=this.extract(L,this.consumeTill))),k=M}if("*"===M)this.attributes.rtcpFeedbackWildcards.push(k);else{let L=this.attributes.payloads.find(L=>L.payloadType===parseInt(M,10));L?L.rtcpFeedbacks.push(k):this.attributes.payloads.push({payloadType:parseInt(M,10),rtcpFeedbacks:[k]})}}parseRTCPMux(){if(this.attributes.rtcpMux)throw Error("must be single line of rtcp-mux");this.attributes.rtcpMux=!0}parseRTCPMuxOnly(){if(this.attributes.rtcpMuxOnly)throw Error("must be single line of rtcp-only");this.attributes.rtcpMuxOnly=!0}parseRTCPRsize(){if(this.attributes.rtcpRsize)throw Error("must be single line of rtcp-rsize");this.attributes.rtcpRsize=!0}parseRTCP(L){if(this.attributes.rtcp)throw Error("must be single line of rtcp");let k={port:this.extract(L,this.consumePort)};" "===this.peekChar(L)&&(this.consumeAttributeSpace(L),k.netType=this.extractOneOrMore(L,l),this.consumeAttributeSpace(L),k.addressType=this.extractOneOrMore(L,l),this.consumeAttributeSpace(L),k.address=this.extract(L,this.consumeAddress)),this.attributes.rtcp=k}parseMsid(L){let k={id:this.extractOneOrMore(L,l,[1,64])};" "===this.peekChar(L)&&(this.consumeAttributeSpace(L),k.appdata=this.extractOneOrMore(L,l,[1,64])),this.attributes.msids.push(k)}parseImageAttr(L){this.attributes.imageattr.push(L.attValue)}parseRid(L){let k=this.extractOneOrMore(L,L=>h(L)||a(L)||"_"===L||"-"===L);this.consumeAttributeSpace(L);let M={id:k,direction:this.extract(L,this.consumeToken),params:[]};if(" "===this.peekChar(L)){if(this.consumeAttributeSpace(L),this.peek(L,"pt=")){this.extract(L,this.consume,"pt=");let k=[];for(;;){let M=this.extract(L,this.consumeToken);k.push(M);try{this.extract(L,this.consume,",")}catch(L){break}}M.payloads=k," "===this.peekChar(L)&&this.extract(L,this.consume," ")}for(;;){let k=this.extract(L,this.consumeToken);if("depend"===k){let U={type:k,rids:this.extract(L,this.consume,"=").split(",")};M.params.push(U)}else{let U={type:k};"="===this.peekChar(L)&&(this.extract(L,this.consume,"="),U.val=this.extract(L,this.consumeTill,";")),M.params.push(U)}try{this.extract(L,this.consume,";")}catch(L){break}}}this.attributes.rids.push(M)}parseSimulcast(L){if(this.attributes.simulcast)throw Error("must be single line of simulcast");this.attributes.simulcast=L.attValue,this.extract(L,this.consumeTill)}parseSctpPort(L){this.attributes.sctpPort=this.extractOneOrMore(L,a,[1,5])}parseMaxMessageSize(L){this.attributes.maxMessageSize=this.extractOneOrMore(L,a,[1,void 0])}digest(){return this.digested=!0,this.attributes}parseMid(L){this.attributes.mid=this.extract(L,this.consumeToken)}parseSSRCGroup(L){let k=this.extract(L,this.consumeToken),M=[];for(;;)try{this.consumeAttributeSpace(L);let k=this.extract(L,this.consumeInteger);M.push(parseInt(k,10))}catch(L){break}this.attributes.ssrcGroups.push({semantic:k,ssrcIds:M})}};function b(L,k,M){return k in L?Object.defineProperty(L,k,{value:M,enumerable:!0,configurable:!0,writable:!0}):L[k]=M,L}let A=class A{constructor(){b(this,"eol",F)}print(L,k){let M="";return k&&(this.eol=k),M+=this.printVersion(L.version)+this.printOrigin(L.origin)+this.printSessionName(L.sessionName)+this.printInformation(L.information)+this.printUri(L.uri)+this.printEmail(L.emails)+this.printPhone(L.phones)+this.printConnection(L.connection)+this.printBandwidth(L.bandwidths)+this.printTimeFields(L.timeFields)+this.printKey(L.key)+this.printSessionAttributes(L.attributes)+this.printMediaDescription(L.mediaDescriptions)}printVersion(L){return"v=".concat(L).concat(this.eol)}printOrigin(L){return"o=".concat(L.username," ").concat(L.sessId," ").concat(L.sessVersion," ").concat(L.nettype," ").concat(L.addrtype," ").concat(L.unicastAddress).concat(this.eol)}printSessionName(L){return L?"s=".concat(L).concat(this.eol):""}printInformation(L){return L?"i=".concat(L).concat(this.eol):""}printUri(L){return L?"u=".concat(L).concat(this.eol):""}printEmail(L){let k="";for(let M of L)k+="e=".concat(M).concat(this.eol);return k}printPhone(L){let k="";for(let M of L)k+="e=".concat(M).concat(this.eol);return k}printConnection(L){return L?"c=".concat(L.nettype," ").concat(L.addrtype," ").concat(L.address).concat(this.eol):""}printBandwidth(L){let k="";for(let M of L)k+="b=".concat(M.bwtype,":").concat(M.bandwidth).concat(this.eol);return k}printTimeFields(L){let k="";for(let M of L){for(let L of(k+="t=".concat(M.time.startTime," ").concat(M.time.startTime).concat(this.eol),M.repeats))k+="r=".concat(L.repeatInterval," ").concat(L.typedTimes.join(" ")).concat(this.eol);M.zoneAdjustments&&(k+="z="+"z=".concat(M.zoneAdjustments.map(L=>"".concat(L.time," ").concat(L.back?"-":""," ").concat(L.typedTime)).join(" ")).concat(this.eol)+this.eol)}return k}printKey(L){return L?"k=".concat(L).concat(this.eol):""}printAttributes(L){let k="";for(let M of L)k+="a=".concat(M.attField).concat(M.attValue?":".concat(M.attValue):"").concat(this.eol);return k}printMediaDescription(L){let k="";for(let M of L)k+=this.printMedia(M.media)+this.printInformation(M.information)+this.printConnections(M.connections)+this.printBandwidth(M.bandwidths)+this.printKey(M.key)+this.printMediaAttributes(M);return k}printConnections(L){let k="";for(let M of L)k+=this.printConnection(M);return k}printMedia(L){return"m=".concat(L.mediaType," ").concat(L.port," ").concat(L.protos.join("/")," ").concat(L.fmts.join(" ")).concat(this.eol)}printSessionAttributes(L){return new O(this.eol).print(L)}printMediaAttributes(L){return new N(this.eol).print(L)}};let w=class w{constructor(L){b(this,"eol",void 0),this.eol=L}printIceUfrag(L){return void 0===L?"":"a=ice-ufrag:".concat(L).concat(this.eol)}printIcePwd(L){return void 0===L?"":"a=ice-pwd:".concat(L).concat(this.eol)}printIceOptions(L){return void 0===L?"":"a=ice-options:".concat(L.join(" ")).concat(this.eol)}printFingerprints(L){return L.length>0?L.map(L=>"a=fingerprint:".concat(L.hashFunction).concat(" ").concat(L.fingerprint)).join(this.eol)+this.eol:""}printExtmap(L){return L.map(L=>"a=extmap:".concat(L.entry).concat(L.direction?"/".concat(L.direction):"").concat(" ").concat(L.extensionName).concat(L.extensionAttributes?"".concat(" ").concat(L.extensionAttributes):"").concat(this.eol)).join("")}printSetup(L){return void 0===L?"":"a=setup:".concat(L).concat(this.eol)}printUnrecognized(L){return L.map(L=>"a=".concat(L.attField).concat(L.attValue?":".concat(L.attValue):"").concat(this.eol)).join("")}};let O=class O extends w{print(L){return""+(this.printGroups(L.groups)+this.printMsidSemantic(L.msidSemantic)+this.printIceLite(L.iceLite)+this.printIceUfrag(L.iceUfrag)+this.printIcePwd(L.icePwd)+this.printIceOptions(L.iceOptions)+this.printFingerprints(L.fingerprints)+this.printSetup(L.setup)+this.printTlsId(L.tlsId)+this.printIdentity(L.identities)+this.printExtmap(L.extmaps)+this.printUnrecognized(L.unrecognized))}printGroups(L){let k="";return L.length>0&&(k+=L.map(L=>"a=group:".concat(L.semantic).concat(L.identificationTag.map(L=>"".concat(" ").concat(L)).join("")).concat(this.eol)).join("")),k}printIceLite(L){return void 0===L?"":"a=ice-lite"+this.eol}printTlsId(L){return L?"a=tls-id:".concat(L).concat(this.eol):""}printIdentity(L){return 0===L.length?"":L.map(L=>"a=identity:".concat(L.assertionValue).concat(L.extensions.map(L=>"".concat(" ").concat(L.name).concat(L.value?"=".concat(L.value):"")))).join(this.eol)+this.eol}printMsidSemantic(L){if(!L)return"";let k="a=msid-semantic:".concat(L.semantic);return L.applyForAll?k+="".concat(" ","*"):L.identifierList.length>0&&(k+=L.identifierList.map(L=>"".concat(" ").concat(L))),k+this.eol}};let N=class N extends w{print(L){let k=L.attributes;return""+(this.printRTCP(k.rtcp)+this.printIceUfrag(k.iceUfrag)+this.printIcePwd(k.icePwd)+this.printIceOptions(k.iceOptions)+this.printCandidates(k.candidates)+this.printRemoteCandidatesList(k.remoteCandidatesList)+this.printEndOfCandidates(k.endOfCandidates)+this.printFingerprints(k.fingerprints)+this.printSetup(k.setup)+this.printMid(k.mid)+this.printExtmap(k.extmaps)+this.printRTPRelated(k)+this.printPtime(k.ptime)+this.printMaxPtime(k.maxPtime)+this.printDirection(k.direction)+this.printSSRCGroups(k.ssrcGroups)+this.printSSRC(k.ssrcs)+this.printRTCPMux(k.rtcpMux)+this.printRTCPMuxOnly(k.rtcpMuxOnly)+this.printRTCPRsize(k.rtcpRsize)+this.printMSId(k.msids)+this.printImageattr(k.imageattr)+this.printRid(k.rids)+this.printSimulcast(k.simulcast)+this.printSCTPPort(k.sctpPort)+this.printMaxMessageSize(k.maxMessageSize)+this.printUnrecognized(k.unrecognized))}printCandidates(L){return L.map(L=>"a=candidate:".concat(L.foundation).concat(" ").concat(L.componentId).concat(" ").concat(L.transport).concat(" ").concat(L.priority).concat(" ").concat(L.connectionAddress).concat(" ").concat(L.port).concat(" ","typ").concat(" ").concat(L.type).concat(L.relAddr?"".concat(" ","raddr").concat(" ").concat(L.relAddr):"").concat(L.relPort?"".concat(" ","rport").concat(" ").concat(L.relPort):"").concat(Object.keys(L.extension).map(k=>"".concat(" ").concat(k).concat(" ").concat(L.extension[k])).join("")).concat(this.eol)).join("")}printRemoteCandidatesList(L){return L.map(L=>"a=remote-candidates:".concat(L.join(" ")).concat(this.eol)).join("")}printEndOfCandidates(L){return void 0===L?"":"a=end-of-candidates"+this.eol}printRTPRelated(L){if(!L.payloads)return"";let k=L.payloads,M="";for(let U of(M+=L.rtcpFeedbackWildcards.map(L=>this.printRTCPFeedback("*",L)).join(""),k))M+=this.printRtpMap(U.payloadType,U.rtpMap)+this.printFmtp(U.payloadType,U.fmtp)+U.rtcpFeedbacks.map(L=>this.printRTCPFeedback(U.payloadType,L)).join("");return M}printFmtp(L,k){if(!k)return"";let M=Object.keys(k.parameters);return 1===M.length&&null===k.parameters[M[0]]?"a=fmtp:".concat(L).concat(" ").concat(M[0]).concat(this.eol):"a=fmtp:".concat(L).concat(" ").concat(Object.keys(k.parameters).map(L=>"".concat(L,"=").concat(k.parameters[L])).join(";")).concat(this.eol)}printRtpMap(L,k){return k?"a=rtpmap:".concat(L).concat(" ").concat(k.encodingName,"/").concat(k.clockRate).concat(k.encodingParameters?"/".concat(k.encodingParameters):"").concat(this.eol):""}printRTCPFeedback(L,k){let M="a=rtcp-fb:".concat(L).concat(" ");return"trr-int"===k.type?M+="ttr-int".concat(" ").concat(k.interval):(M+="".concat(k.type),k.parameter&&(M+="".concat(" ").concat(k.parameter),k.additional&&(M+="".concat(" ").concat(k.additional)))),M+this.eol}printPtime(L){return void 0===L?"":"a=ptime:".concat(L).concat(this.eol)}printMaxPtime(L){return void 0===L?"":"a=maxptime:".concat(L).concat(this.eol)}printDirection(L){return void 0===L?"":"a=".concat(L).concat(this.eol)}printSSRC(L){return L.map(L=>Object.keys(L.attributes).map(k=>"a=ssrc:".concat(L.ssrcId.toString(10)).concat(" ").concat(k).concat(L.attributes[k]?":".concat(L.attributes[k]):"").concat(this.eol)).join("")).join("")}printRTCPMux(L){return void 0===L?"":"a=rtcp-mux".concat(this.eol)}printRTCPMuxOnly(L){return void 0===L?"":"a=rtcp-mux-only".concat(this.eol)}printRTCPRsize(L){return void 0===L?"":"a=rtcp-rsize".concat(this.eol)}printRTCP(L){if(void 0===L)return"";let k="a=rtcp:".concat(L.port);return L.netType&&(k+="".concat(" ").concat(L.netType)),L.addressType&&(k+="".concat(" ").concat(L.addressType)),L.address&&(k+="".concat(" ").concat(L.address)),k+this.eol}printMSId(L){return L.map(L=>"a=msid:".concat(L.id).concat(L.appdata?"".concat(" ").concat(L.appdata):"").concat(this.eol)).join("")}printImageattr(L){return L.map(L=>"a=imageattr:".concat(L).concat(this.eol)).join("")}printRid(L){return L.map(L=>{let k="a=rid:".concat(L.id).concat(" ").concat(L.direction);return L.payloads&&(k+="".concat(" ","pt=").concat(L.payloads.join(","))),L.params.length>0&&(k+="".concat(" ").concat(L.params.map(L=>"depend"===L.type?"depend=".concat(L.rids.join(",")):"".concat(L.type,"=").concat(L.val)).join(";"))),k+this.eol}).join("")}printSimulcast(L){return void 0===L?"":"a=simulcast:".concat(L).concat(this.eol)}printSCTPPort(L){return void 0===L?"":"a=sctp-port:".concat(L).concat(this.eol)}printMaxMessageSize(L){return void 0===L?"":"a=max-message-size:".concat(L).concat(this.eol)}printMid(L){return void 0===L?"":"a=mid:".concat(L).concat(this.eol)}printSSRCGroups(L){return L.map(L=>"a=ssrc-group:".concat(L.semantic).concat(L.ssrcIds.map(L=>"".concat(" ").concat(L.toString(10))).join("")).concat(this.eol)).join("")}};function D(L){return(new v).parse(L)}function P(L,k){return(new A).print(L,k)}}},k={};function i(M){if(k[M])return k[M].exports;var U=k[M]={exports:{}};return L[M](U,U.exports,i),U.exports}return i.d=(L,k)=>{for(var M in k)i.o(k,M)&&!i.o(L,M)&&Object.defineProperty(L,M,{enumerable:!0,get:k[M]})},i.o=(L,k)=>Object.prototype.hasOwnProperty.call(L,k),i.r=L=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(L,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(L,"__esModule",{value:!0})},i(8)})();function FN(L){return S7.parse(L)}function BN(L,k){return S7.print(L,k)}var ge=Qi("Array","keys"),gt=Array.prototype,gi={DOMTokenList:!0,NodeList:!0},gn=i(function(L){var k=L.keys;return L===gt||al(gt,L)&&k===gt.keys||or(gi,o7(L))?ge:k});function JN(L,k,M){var U;return(k="symbol"==typeof(U=function(L,k){if("object"!=typeof L||!L)return L;var M=L[Symbol.toPrimitive];if(void 0!==M){var U=M.call(L,"string");if("object"!=typeof U)return U;throw TypeError("@@toPrimitive must return a primitive value.")}return String(L)}(k))?U:U+"")in L?Object.defineProperty(L,k,{value:M,enumerable:!0,configurable:!0,writable:!0}):L[k]=M,L}function ZN(L,k){var M=Object.keys(L);if(Object.getOwnPropertySymbols){var U=Object.getOwnPropertySymbols(L);k&&(U=U.filter(function(k){return Object.getOwnPropertyDescriptor(L,k).enumerable})),M.push.apply(M,U)}return M}function QN(L){for(var k=1;k<arguments.length;k++){var M=null!=arguments[k]?arguments[k]:{};k%2?ZN(Object(M),!0).forEach(function(k){JN(L,k,M[k])}):Object.getOwnPropertyDescriptors?Object.defineProperties(L,Object.getOwnPropertyDescriptors(M)):ZN(Object(M)).forEach(function(k){Object.defineProperty(L,k,Object.getOwnPropertyDescriptor(M,k))})}return L}let ga=new class extends Hw{constructor(){super(...arguments),JN(this,"currentUploadLogID",0)}reportLogUploadError(L){let{errorRange:k}=L;k[k.length-1]&&k[k.length-1]>this.currentUploadLogID&&(this.currentUploadLogID=k[k.length-1],this.emit("REPORT_LOG_UPLOAD",L))}};let eD=class eD{constructor(L){JN(this,"logger",void 0),JN(this,"prefixLists",[]),this.logger=L}debug(){for(var L=arguments.length,k=Array(L),M=0;M<L;M++)k[M]=arguments[M];this.logger.debug(...this.prefixLists,...k)}info(){for(var L=arguments.length,k=Array(L),M=0;M<L;M++)k[M]=arguments[M];this.logger.info(...this.prefixLists,...k)}warning(){for(var L=arguments.length,k=Array(L),M=0;M<L;M++)k[M]=arguments[M];this.logger.warning(...this.prefixLists,...k)}error(){for(var L=arguments.length,k=Array(L),M=0;M<L;M++)k[M]=arguments[M];this.logger.error(...this.prefixLists,...k)}prefix(L){return this.prefixLists.push(L),this}popPrefix(){return this.prefixLists.pop(),this}};function tD(){let L=new Date;return L.toTimeString().split(" ")[0]+":"+L.getMilliseconds()}function iD(){let L=new Date,k=/((\d+:){2}\d+)/.exec((new Date).toUTCString());return k?(null==k?void 0:k[0])+":"+L.getUTCMilliseconds():L.toTimeString().split(" ")[0]+":"+L.getMilliseconds()}let go={DEBUG:0,INFO:1,WARNING:2,ERROR:3,NONE:4},gs=Date.now(),oD=L=>{for(let k in go)if(Object.prototype.hasOwnProperty.call(go,k)&&go[k]===L)return k;return"DEFAULT"},gc=new class{constructor(){JN(this,"proxyServerURL",void 0),JN(this,"logLevel",go.DEBUG),JN(this,"uploadState","collecting"),JN(this,"uploadLogWaitingList",[]),JN(this,"uploadLogUploadingList",[]),JN(this,"uploadErrorCount",0),JN(this,"currentLogID",0),JN(this,"url",void 0),JN(this,"extLog",(L,k)=>{this.appendLogToWaitingList(L,...k)})}debug(){for(var L=arguments.length,k=Array(L),M=0;M<L;M++)k[M]=arguments[M];let U=[go.DEBUG].concat(k);this.log.apply(this,U)}info(){for(var L=arguments.length,k=Array(L),M=0;M<L;M++)k[M]=arguments[M];let U=[go.INFO].concat(k);this.log.apply(this,U)}warning(){for(var L=arguments.length,k=Array(L),M=0;M<L;M++)k[M]=arguments[M];let U=[go.WARNING].concat(k);this.log.apply(this,U)}warn(){this.warning(...arguments)}error(){for(var L=arguments.length,k=Array(L),M=0;M<L;M++)k[M]=arguments[M];let U=[go.ERROR].concat(k);this.log.apply(this,U)}upload(){for(var L=arguments.length,k=Array(L),M=0;M<L;M++)k[M]=arguments[M];let U=[go.DEBUG].concat(k);this.uploadLog.apply(this,U)}setLogLevel(L){L=Math.min(Math.max(0,L),4),this.logLevel=L}enableLogUpload(){AN("UPLOAD_LOG",!0)}disableLogUpload(){AN("UPLOAD_LOG",!1),this.uploadLogUploadingList=[],this.uploadLogWaitingList=[]}setProxyServer(L){this.proxyServerURL=L}prefix(L){return new eD(this).prefix(L)}log(){for(var L=arguments.length,k=Array(L),M=0;M<L;M++)k[M]=arguments[M];if(Date.now()-gs<100)return void setTimeout(()=>{this.log(...k)},Date.now()-gs);let U=Math.max(0,Math.min(4,k[0]));if(k[0]=tD()+" Agora-SDK [".concat(oD(U),"]:"),this.appendLogToWaitingList(U,...k),U<this.logLevel)return;let V=tD()+" %cAgora-SDK [".concat(oD(U),"]:"),F=[];if(!wN("USE_NEW_LOG"))switch(U){case go.DEBUG:F=[V,"color: #64B5F6;"].concat(k.slice(1)),console.log.apply(console,F);break;case go.INFO:F=[V,"color: #1E88E5; font-weight: bold;"].concat(k.slice(1)),console.log.apply(console,F);break;case go.WARNING:F=[V,"color: #FB8C00; font-weight: bold;"].concat(k.slice(1)),console.warn.apply(console,F);break;case go.ERROR:F=[V,"color: #B00020; font-weight: bold;"].concat(k.slice(1)),console.error.apply(console,F)}}uploadLog(){for(var L=arguments.length,k=Array(L),M=0;M<L;M++)k[M]=arguments[M];if(Date.now()-gs<100)return void setTimeout(()=>{this.uploadLog(...k)},Date.now()-gs);let U=Math.max(0,Math.min(4,k[0]));k[0]=tD()+" Agora-SDK [".concat(oD(U),"]:"),this.appendLogToWaitingList(U,...k)}appendLogToWaitingList(L){if(!wN("UPLOAD_LOG"))return;for(var k=arguments.length,M=Array(k>1?k-1:0),U=1;U<k;U++)M[U-1]=arguments[U];Array.isArray(M[0])?M[0][0]=iD()+" Agora-SDK [".concat(oD(L),"]:"):M[0]=iD()+" Agora-SDK [".concat(oD(L),"]:");let V="";M.forEach(L=>{"object"==typeof L&&(L=JSON.stringify(L)),V+="".concat(L," ")}),this.uploadLogWaitingList.push({payload_str:V,log_level:L,log_item_id:this.currentLogID++}),"uploading"===this.uploadState&&0===this.uploadLogUploadingList.length&&this.uploadLogInterval()}startUpload(){this.uploadState="uploading",0===this.uploadLogUploadingList.length&&this.uploadLogInterval()}async uploadLogs(){let L=this.uploadLogUploadingList,k={sdk_version:SJ,process_id:wN("PROCESS_ID"),payload:JSON.stringify(L)};return GO(async()=>{let L=await fG.post(this.url||(this.proxyServerURL?"https://".concat(this.proxyServerURL,"/ls/?h=").concat(wN("LOG_UPLOAD_SERVER"),"&p=443&d=upload/v1"):"https://".concat(wN("LOG_UPLOAD_SERVER"),"/upload/v1")),k,{responseType:"text"});if("OK"!==L.data){let k=Error("unexpected upload log response");throw k.response=L,k}},()=>(this.uploadLogUploadingList=[],!1),k=>{let M={status:-1,message:k.message,errorRange:L.map(L=>L.log_item_id)};return k.response?(M.status=k.response.status,M.data=k.response.data,M.headers=k.response.headers):k.request&&(M.status=k.request.status),ga.reportLogUploadError(M),!0},{timeout:wN("UPLOAD_LOG_REQUEST_RETRY_INTERVAL"),maxRetryTimeout:wN("UPLOAD_LOG_REQUEST_MAX_RETRY_INTERVAL")})}uploadLogInterval(){0===this.uploadLogUploadingList.length&&0===this.uploadLogWaitingList.length||(0===this.uploadLogUploadingList.length&&(this.uploadLogUploadingList=this.uploadLogWaitingList.splice(0,wN("UPLOAD_LOG_LENGTH_EACH_TIME"))),this.uploadLogs().then(()=>{this.uploadErrorCount=0,this.uploadLogWaitingList.length>0&&window.setTimeout(()=>this.uploadLogInterval(),wN("UPLOAD_LOG_INTERVAL"))}).catch(L=>{this.uploadErrorCount+=1,this.uploadErrorCount<2?window.setTimeout(()=>this.uploadLogInterval(),wN("UPLOAD_LOG_TWICE_RETRY_INTERVAL_V1")):window.setTimeout(()=>this.uploadLogInterval(),wN("UPLOAD_LOG_RETRY_INTERVAL_V1"))}))}};function cD(L){return kw(L.reportId,"params.reportId",0,100,!1),kw(L.category,"params.category",0,100,!1),kw(L.event,"params.event",0,100,!1),kw(L.label,"params.label",0,100,!1),Pw(L.value,"params.value",Number.MIN_SAFE_INTEGER,Number.MAX_SAFE_INTEGER,!1),!0}(iu={}).FREE="free",iu.UPLOADING="uploading",(eN={})[eN.MISC=0]="MISC",eN[eN.INTERNAL_EVENT=1]="INTERNAL_EVENT",eN[eN.PUBLIC_EVENT=2]="PUBLIC_EVENT",eN[eN.WEB_EVENT=3]="WEB_EVENT",eN[eN.INTERNAL_API=4]="INTERNAL_API",eN[eN.WEB_API=5]="WEB_API",eN[eN.PUBLIC_API=6]="PUBLIC_API";let gd={sid:"",lts:0,success:null,cname:null,uid:null,peer:null,cid:null,elapse:null,extend:null,vid:0},gl=((eP={}).PUBLISH="publish",eP.SUBSCRIBE="subscribe",eP.WS_COMPRESSOR_INIT="ws_compressor_init",eP.SESSION_INIT="session_init",eP.JOIN_CHOOSE_SERVER="join_choose_server",eP.REQ_USER_ACCOUNT="req_user_account",eP.JOIN_GATEWAY="join_gateway",eP.REJOIN_GATEWAY="rejoin_gateway",eP.STREAM_SWITCH="stream_switch",eP.REQUEST_PROXY_WORKER_MANAGER="request_proxy_worker_manager",eP.REQUEST_PROXY_APPCENTER="request_proxy_appcenter",eP.FIRST_VIDEO_RECEIVED="first_video_received",eP.FIRST_AUDIO_RECEIVED="first_audio_received",eP.FIRST_VIDEO_DECODE="first_video_decode",eP.FIRST_AUDIO_DECODE="first_audio_decode",eP.XLA_PEER_FIRST_VIDEO_FRAME="xla_peer_first_video_frame",eP.ON_ADD_AUDIO_STREAM="on_add_audio_stream",eP.ON_ADD_VIDEO_STREAM="on_add_video_stream",eP.ON_UPDATE_STREAM="on_update_stream",eP.ON_REMOVE_STREAM="on_remove_stream",eP.USER_ANALYTICS="req_user_analytics",eP.PC_STATS="pc_stats",eP.UPDATE_REMOTE_RTPCAPABILITIES="update_remote_rtpCapabilities",eP.AB_TEST="ab_test",eP),gh=((eL={}).SESSION="io.agora.pb.Wrtc.Session",eL.JOIN_CHOOSE_SERVER="io.agora.pb.Wrtc.JoinChooseServer",eL.REQ_USER_ACCOUNT="io.agora.pb.Wrtc.ReqUserAccount",eL.JOIN_GATEWAY="io.agora.pb.Wrtc.JoinGateway",eL.RE_JOIN_GATEWAY="io.agora.pb.Wrtc.ReJoinGateway",eL.PUBLISH="io.agora.pb.Wrtc.Publish",eL.SUBSCRIBE="io.agora.pb.Wrtc.Subscribe",eL.WS_COMPRESSOR_INIT="io.agora.pb.Wrtc.WsCompressorInit",eL.STREAM_SWITCH="io.agora.pb.Wrtc.StreamSwitch",eL.AUDIO_SENDING_STOPPED="io.agora.pb.Wrtc.AudioSendingStopped",eL.VIDEO_SENDING_STOPPED="io.agora.pb.Wrtc.VideoSendingStopped",eL.REQUEST_PROXY_APPCENTER="io.agora.pb.Wrtc.RequestProxyAppCenter",eL.REQUEST_PROXY_WORKER_MANAGER="io.agora.pb.Wrtc.RequestProxyWorkerManager",eL.API_INVOKE="io.agora.pb.Wrtc.ApiInvoke",eL.FIRST_VIDEO_RECEIVED="io.agora.pb.Wrtc.FirstVideoReceived",eL.FIRST_AUDIO_RECEIVED="io.agora.pb.Wrtc.FirstAudioReceived",eL.FIRST_VIDEO_DECODE="io.agora.pb.Wrtc.FirstVideoDecode",eL.FIRST_AUDIO_DECODE="io.agora.pb.Wrtc.FirstAudioDecode",eL.XLA_PEER_FIRST_VIDEO_FRAME="io.agora.pb.Wrtc.XLAPeerFirstVideoFrame",eL.ON_ADD_AUDIO_STREAM="io.agora.pb.Wrtc.OnAddAudioStream",eL.ON_ADD_VIDEO_STREAM="io.agora.pb.Wrtc.OnAddVideoStream",eL.ON_UPDATE_STREAM="io.agora.pb.Wrtc.OnUpdateStream",eL.ON_REMOVE_STREAM="io.agora.pb.Wrtc.OnRemoveStream",eL.JOIN_CHANNEL_TIMEOUT="io.agora.pb.Wrtc.JoinChannelTimeout",eL.PEER_PUBLISH_STATUS="io.agora.pb.Wrtc.PeerPublishStatus",eL.WORKER_EVENT="io.agora.pb.Wrtc.WorkerEvent",eL.AP_WORKER_EVENT="io.agora.pb.Wrtc.APWorkerEvent",eL.JOIN_WEB_PROXY_AP="io.agora.pb.Wrtc.JoinWebProxyAP",eL.WEBSOCKET_QUIT="io.agora.pb.Wrtc.WebSocketQuit",eL.USER_ANALYTICS="io.agora.pb.Wrtc.UserAnalytics",eL.AUTOPLAY_FAILED="io.agora.pb.Wrtc.AutoplayFailed",eL.PC_STATS="io.agora.pb.Wrtc.PCStats",eL.UPDATE_REMOTE_RTPCAPABILITIES="io.agora.pb.Wrtc.UpdateRemoteRTPCapabilities",eL.AB_TEST="io.agora.pb.Wrtc.ABTest",eL);(ek={})[ek.WORKER_EVENT=156]="WORKER_EVENT",ek[ek.AP_WORKER_EVENT=160]="AP_WORKER_EVENT";let gp=((eU={})[eU.SESSION=26]="SESSION",eU[eU.JOIN_CHOOSE_SERVER=27]="JOIN_CHOOSE_SERVER",eU[eU.REQ_USER_ACCOUNT=196]="REQ_USER_ACCOUNT",eU[eU.JOIN_GATEWAY=28]="JOIN_GATEWAY",eU[eU.PUBLISH=30]="PUBLISH",eU[eU.SUBSCRIBE=29]="SUBSCRIBE",eU[eU.WS_COMPRESSOR_INIT=9430]="WS_COMPRESSOR_INIT",eU[eU.STREAM_SWITCH=32]="STREAM_SWITCH",eU[eU.AUDIO_SENDING_STOPPED=33]="AUDIO_SENDING_STOPPED",eU[eU.VIDEO_SENDING_STOPPED=34]="VIDEO_SENDING_STOPPED",eU[eU.REQUEST_PROXY_APPCENTER=35]="REQUEST_PROXY_APPCENTER",eU[eU.REQUEST_PROXY_WORKER_MANAGER=36]="REQUEST_PROXY_WORKER_MANAGER",eU[eU.API_INVOKE=41]="API_INVOKE",eU[eU.FIRST_VIDEO_RECEIVED=348]="FIRST_VIDEO_RECEIVED",eU[eU.FIRST_AUDIO_RECEIVED=349]="FIRST_AUDIO_RECEIVED",eU[eU.FIRST_VIDEO_DECODE=350]="FIRST_VIDEO_DECODE",eU[eU.FIRST_AUDIO_DECODE=351]="FIRST_AUDIO_DECODE",eU[eU.ON_ADD_AUDIO_STREAM=352]="ON_ADD_AUDIO_STREAM",eU[eU.ON_ADD_VIDEO_STREAM=353]="ON_ADD_VIDEO_STREAM",eU[eU.ON_UPDATE_STREAM=356]="ON_UPDATE_STREAM",eU[eU.ON_REMOVE_STREAM=355]="ON_REMOVE_STREAM",eU[eU.JOIN_CHANNEL_TIMEOUT=407]="JOIN_CHANNEL_TIMEOUT",eU[eU.PEER_PUBLISH_STATUS=408]="PEER_PUBLISH_STATUS",eU[eU.WORKER_EVENT=156]="WORKER_EVENT",eU[eU.AP_WORKER_EVENT=160]="AP_WORKER_EVENT",eU[eU.JOIN_WEB_PROXY_AP=700]="JOIN_WEB_PROXY_AP",eU[eU.WEBSOCKET_QUIT=671]="WEBSOCKET_QUIT",eU[eU.USER_ANALYTICS=1e4]="USER_ANALYTICS",eU[eU.AUTOPLAY_FAILED=9178]="AUTOPLAY_FAILED",eU);function pD(){let L=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return function(k,M,U){let V=U.value;if("function"==typeof V){let F=L.className||k.__className__||("AgoraRTCClient"===k.constructor.name?"Client":k.constructor.name);U.value=function(){for(var k,U=arguments.length,B=Array(U),j=0;j<U;j++)B[j]=arguments[j];let G=B;if(L.argsMap)try{G=L.argsMap(this,...B)}catch(L){gc.warning(L),G=[]}try{JSON.stringify(G)}catch(L){gc.warning("arguments for method ".concat(F,".").concat(String(M)," not serializable for apiInvoke.")),G=[]}let X=(L.report||g_).reportApiInvoke(this._sessionId||null,{id:this._clientId||(null===(k=this.store)||void 0===k?void 0:k.clientId)||this._ID,name:"".concat(F,".").concat(String(M)),options:G,tag:f9.TRACER,reportResult:L.reportResult},L.throttleTime);try{let k=V.apply(this,B);return k instanceof lQ?k.then(k=>(X.onSuccess(L.reportResult&&k),k)).catch(L=>{throw X.onError(L),L}):(X.onSuccess(L.reportResult&&k),k)}catch(L){throw X.onError(L),L}}}return U}}let g_=new class{constructor(){JN(this,"baseInfoMap",new Map),JN(this,"proxyServer",void 0),JN(this,"eventUploadTimer",void 0),JN(this,"setSessionIdTimer",void 0),JN(this,"url",void 0),JN(this,"sids",new Set),JN(this,"backupUrl",void 0),JN(this,"_appId",void 0),JN(this,"_aid",0),JN(this,"keyEventUploadPendingItems",[]),JN(this,"normalEventUploadPendingItems",[]),JN(this,"apiInvokeUploadPendingItems",[]),JN(this,"apiInvokeCount",0),JN(this,"apiInvokeLoggedCount",0),JN(this,"ltsList",[]),JN(this,"lastSendNormalEventTime",Date.now()),JN(this,"customReportCounterTimer",void 0),JN(this,"customReportCount",0),JN(this,"extApiInvoke",async L=>{for(let k of L){let L=QN(QN({},k),{},{sid:null,invokeId:++this.apiInvokeCount,tag:f9.TRACER});this.sendApiInvoke(L)}}),this.eventUploadTimer=window.setInterval(this.doSend.bind(this),wN("EVENT_REPORT_SEND_INTERVAL")),this.setSessionIdTimer=window.setInterval(this.appendSessionId.bind(this),wN("EVENT_REPORT_SEND_INTERVAL"))}getBaseInfoBySessionId(L){return this.baseInfoMap.get(L)}setAppId(L){this._appId=L,this._aid=parseInt(L.replace(/[a-fA-F0-9]{8}/g,L=>{let[k,M]=L;return k+M}),16)||0}reportApiInvoke(L,k,M){k.timeout=k.timeout||6e4,k.reportResult=void 0===k.reportResult||k.reportResult;let U=Date.now();this.apiInvokeCount+=1;let V=this.apiInvokeCount,F=!!wN("SHOW_REPORT_INVOKER_LOG"),B=!!wN("SHOW_REPORT_USER_INVOKER_LOG"),j=F||B&&k.id;j&&(this.apiInvokeLoggedCount+=1);let G=this.apiInvokeLoggedCount;function d(L,M){if(j){let U="[apiInvoke-".concat(G,"]");if(k.id&&(U+="[".concat(k.id,"]")),k.name&&(U+="[".concat(k.name,"]"),k.name===f8.JOIN))return gc.info("".concat(U," ").concat(L));gc.info("".concat(U," ").concat(L),"start"===L?k.options:M||"")}}let l=()=>({tag:k.tag,invokeId:V,sid:L,name:k.name,apiInvokeTime:U,options:k.options,states:k.states||null});d("start");let X=!1;yO(k.timeout).then(()=>{X||(this.sendApiInvoke(QN(QN({},l()),{},{error:f1.API_INVOKE_TIMEOUT,success:!1})),d("timeout"))});let $=new f2(f1.UNEXPECTED_ERROR,"".concat(k.name,": this api invoke is end"));return{onSuccess:L=>{let n=()=>{if(X)throw $;return X=!0,this.sendApiInvoke(QN(QN({},l()),{},{success:!0},k.reportResult&&{result:L})),d("onSuccess"),L};return M?Sl(n,k.name+"Success",M,()=>X=!0):n()},onError:L=>{let n=()=>{if(X)throw L;X=!0,this.sendApiInvoke(QN(QN({},l()),{},{success:!1,error:L})),d("onFailure",L.toString())};return M?Sl(n,k.name+"Error",M,()=>X=!0):n()}}}sessionInit(L,k){var M;if(this.baseInfoMap.has(L))return;let U=Date.now(),V=this.createBaseInfo(L,U);V.cname=k.cname;let F=Object.assign({},{willUploadConsoleLog:wN("UPLOAD_LOG"),maxTouchPoints:navigator.maxTouchPoints,areaVersion:SX?"global":"oversea",areas:wN("AREAS")&&wN("AREAS").join(",")},k.extend),{stringUid:B,channelProfile:j,channelMode:G,isABTestSuccess:X,lsid:$,clientRole:ee}=k,et=Date.now(),ei=QN(QN({},V),{},{eventType:gl.SESSION_INIT,appid:k.appid,browser:navigator.userAgent,buildFormat:k.buildFormat,build:S1,lts:et,elapse:et-U,extend:JSON.stringify(F),mode:k.mode,process:wN("PROCESS_ID"),appType:wN("APP_TYPE"),success:!0,version:SJ,stringUid:B,channelProfile:j,channelMode:G,isABTestSuccess:X,lsid:$,clientType:so(M=window.navigator.userAgent).call(M,"AgoraWebView")?42:20,clientRole:ee,serviceId:wN("PROCESS_ID"),extensionID:wN("PLUGIN_INFO").join(",")||""});this.send({type:gh.SESSION,data:ei},!0)}joinChooseServer(L,k){let M=this.baseInfoMap.get(L);if(!M)return;let U=M.info,V=Date.now(),F=QN(QN({},U),{},{role:k.role,eventType:gl.JOIN_CHOOSE_SERVER,lts:V,eventElapse:k.elapse||V-k.lts,chooseServerAddr:k.csAddr,errorCode:k.ec,elapse:V-M.startTime,success:k.succ,chooseServerAddrList:JSON.stringify(k.serverList),uid:k.uid?parseInt(k.uid):null,cid:k.cid?parseInt(k.cid):null,chooseServerIp:k.csIp||"",opid:k.opid,unilbsServerIds:k.unilbsServerIds,extend:k.extend||void 0,isHttp3:k.isHttp3,corssRegionTagReq:k.corssRegionTagReq||void 0,corssRegionTagRes:k.corssRegionTagRes||void 0,resourceTimingInfo:k.resourceTimingInfo||void 0});this.send({type:gh.JOIN_CHOOSE_SERVER,data:F},!0)}reqUserAccount(L,k){let M=this.baseInfoMap.get(L);if(!M)return;let U=M.info,V=Date.now(),F=QN(QN({},U),{},{eventType:gl.REQ_USER_ACCOUNT,lts:V,success:k.success,serverAddress:k.serverAddr,stringUid:k.stringUid,uid:k.uid,errorCode:k.errorCode,elapse:k.elapse||V-M.startTime,eventElapse:V-k.lts,extend:JSON.stringify(k.extend)});this.send({type:gh.REQ_USER_ACCOUNT,data:F},!0)}joinGateway(L,k){let M=this.baseInfoMap.get(L);if(!M)return;let U=M.info;k.vid&&(U.vid=k.vid),U.uid=k.uid,U.cid=k.cid;let V=Date.now(),{firstSuccess:F,addr:B,isProxy:j}=k,G=V-M.startTime,X=QN(QN({},U),{},{eventType:gl.JOIN_GATEWAY,lts:V,gatewayAddr:k.addr,success:k.succ,errorCode:k.ec,errorMsg:k.errorMsg||"",elapse:G,eventElapse:V-k.lts,firstSuccess:F,signalChannel:k.signalChannel,preload:k.preload?1:0,installId:fN(),isABTestSuccess:k.isABTestSuccess?1:0}),$=X.success?1:0;if(k.succ&&(M.lastJoinSuccessTime=V),F)this.send({type:gh.JOIN_GATEWAY,data:X},!0);else{let L;if(B){if(j){let k=B.match(/h=(\d{1,3}-){3}\d{1,3}/g),M=B.match(/p=[0-9]{1,6}/g);L={isSuccess:$,gatewayIp:k&&k.length?k[0].split("=")[1].replace(/-/g,"."):"",port:M&&M.length?M[0].split("=")[1]:"",isProxy:j?1:0}}else{let k=B.match(/wss:\/\/(\d{1,3}-){3}\d{1,3}/g),M=B.match(/(:|p=)[0-9]{1,6}/g);L={isSuccess:$,gatewayIp:k&&k.length?k[0].split("//")[1].replace(/-/g,"."):"",port:M&&M.length?M[0].split(/:|p=/g)[1]:"",isProxy:j?1:0}}}else L={isSuccess:$,gatewayIp:"",port:"",isProxy:j?1:0};delete X.success,delete X.eventType,delete X.firstSuccess,X.vid=Number(X.vid);let k=Object.assign({},X,L,{eventType:gl.REJOIN_GATEWAY});this.send({type:gh.RE_JOIN_GATEWAY,data:k},!0)}}joinChannelTimeout(L,k){let M=this.baseInfoMap.get(L);if(!M)return;let U=Date.now(),V=QN(QN({},M.info),{},{lts:U,timeout:k,elapse:U-M.startTime});this.send({type:gh.JOIN_CHANNEL_TIMEOUT,data:V},!0)}publish(L,k){let M=this.baseInfoMap.get(L);if(!M)return;let U=M.info,V=Date.now(),F=QN(QN({},U),{},{eventType:gl.PUBLISH,lts:V,eventElapse:k.eventElapse,elapse:V-M.startTime,success:k.succ,errorCode:k.ec,videoName:k.videoName,audioName:k.audioName,screenName:k.screenName,screenshare:k.screenshare,audio:k.audio,video:k.video,p2pid:k.p2pid,publishRequestid:k.publishRequestid});this.send({type:gh.PUBLISH,data:F},!0)}subscribe(L,k,M){let U=this.baseInfoMap.get(L);if(!U)return;let V=U.info,F=Date.now(),B=QN(QN({},V),{},{eventType:gl.SUBSCRIBE,lts:F,eventElapse:k.eventElapse,elapse:F-U.startTime,success:k.succ,errorCode:k.ec,video:k.video,audio:k.audio,subscribeRequestid:k.subscribeRequestid,p2pid:k.p2pid,preSsrc:k.preSsrc?1:0},M&&{extend:JSON.stringify({isMassSubscribe:!0})});"string"==typeof k.peerid?B.peerSuid=k.peerid:B.peer=k.peerid,this.send({type:gh.SUBSCRIBE,data:B},!0)}wsCompressorInit(L){var k;let M=[...gn(k=this.baseInfoMap).call(k)],U=M.length?M[0]:"UnableToGetSid",V=this.baseInfoMap.get(U);if(!V)return;let F=V.info,B=Date.now(),j=QN(QN({},F),{},{eventType:gl.WS_COMPRESSOR_INIT,lts:B,eventElapse:L.eventElapse,elapse:B-V.startTime,status:L.status?1:2});this.send({type:gh.WS_COMPRESSOR_INIT,data:j},!0)}firstXLAPeerFirstVideoFrame(L,k){let M=this.baseInfoMap.get(L);if(!M)return;let U=M.info,V=Date.now(),F=k.peerPubStatusMs-(M.lastJoinSuccessTime||V),B=QN(QN({},U),{},{elapse:V-M.startTime,eventType:gl.XLA_PEER_FIRST_VIDEO_FRAME,lts:V,peer:k.peer,width:k.width,height:k.height,ssrc:k.ssrc,p2pid:k.p2pid,peerPublishDuration:k.peerPublishDuration,joinChannelSuccessElapse:F,peerPubStatusMs:k.peerPubStatusMs-k.joinChannelStart,availablePublish:k.peerPublishDuration>F?1:0,preloadStart:Math.max(k.preloadStart-k.joinChannelStart,0),preloadEnd:Math.max(k.preloadEnd-k.joinChannelStart,0),encrypt:Math.max(k.apStart-k.joinChannelStart,0),ap:Math.max(k.apEnd-k.joinChannelStart,0),sua:Math.max(k.suaEnd-k.joinChannelStart,0),beforeConnect:Math.max(k.beforeConnect-k.joinChannelStart,0),peerRecevier:Math.max(k.peerReceiver-k.joinChannelStart,0),ice:Math.max(k.ice-k.joinChannelStart,0),pc:Math.max(k.pc-k.joinChannelStart,0),signalConnected:Math.max(k.signalConnected-k.joinChannelStart,0),joinReq:Math.max(k.joinReq-k.joinChannelStart,0),joinRes:Math.max(k.joinRes-k.joinChannelStart,0),userJoinNotify:Math.max(k.userJoinNotify-k.joinChannelStart,0),videoSsrcNotify:Math.max(k.videoAddNotify-k.joinChannelStart,0),subscribeDelayMs:Math.max(k.subscribeStart-k.videoAddNotify,0),subscribeStart:Math.max(k.subscribeStart-k.joinChannelStart,0),subscribeEnd:Math.max(k.subscribeEnd-k.joinChannelStart,0),firstReceived:Math.max(k.firstReceived-k.joinChannelStart,0),firstDecoded:Math.max(k.firstDecoded-k.joinChannelStart,0),firstPreRender:Math.max(k.firstPreRender-k.joinChannelStart,0),firstRender:Math.max(k.firstRender-k.joinChannelStart,0),playDelayMs:Math.max(k.playStart-k.subscribeEnd,0),playStart:Math.max(k.playStart-k.joinChannelStart,0),playEnd:Math.max(k.playEnd-k.joinChannelStart,0),isPreSub:k.isPreSub?1:0,isPrePc:k.isPrePc?1:0,isPreInstantVideo:k.isPreInstantVideo?1:0});this.send({type:gh.XLA_PEER_FIRST_VIDEO_FRAME,data:B},!0)}firstRemoteVideoDecode(L,k,M,U){let V=this.baseInfoMap.get(L);if(!V)return;let F=V.info,B=Date.now(),j=QN(QN(QN({},F),U),{},{elapse:B-V.startTime,eventType:k,lts:B,firstDecodeFrame:Math.max((U.firstFrame||B)-V.startTime,0),apEnd:Math.max(U.apEnd-V.startTime,0),apStart:Math.max(U.apStart-V.startTime,0),joinGwEnd:Math.max(U.joinGwEnd-V.startTime,0),joinGwStart:Math.max(U.joinGwStart-V.startTime,0),pcEnd:Math.max(U.pcEnd-V.startTime,0),pcStart:Math.max(U.pcStart-V.startTime,0),subscriberEnd:Math.max(U.subscriberEnd-V.startTime,0),subscriberStart:Math.max(U.subscriberStart-V.startTime,0),videoAddNotify:Math.max(U.videoAddNotify-V.startTime,0)});this.send({type:M,data:j},!0)}firstRemoteFrame(L,k,M,U){let V=this.baseInfoMap.get(L);if(!V)return;let F=V.info,B=Date.now(),j=QN(QN(QN({},F),U),{},{elapse:B-V.startTime,eventType:k,lts:B});this.send({type:M,data:j},!0)}abTest(L,k){let M=this.baseInfoMap.get(L);if(!M)return;let U=M.info,V=Date.now(),F=QN(QN(QN({},U),k),{},{vid:void 0===U.vid?0:Number(U.vid),elapse:V-M.startTime,eventType:gl.AB_TEST,lts:V});this.send({type:gh.AB_TEST,data:F},!0)}pcStats(L,k){let M=this.baseInfoMap.get(L);if(!M)return;let U=M.info,V=Date.now(),F=QN(QN(QN({},U),k),{},{vid:void 0===U.vid?0:Number(U.vid),elapse:V-M.startTime,eventType:gl.PC_STATS,lts:V,preallocation:k.preallocation?1:0});this.send({type:gh.PC_STATS,data:F},!0)}updateRemoteRTPCapabilities(L,k){if(L){let M=this.baseInfoMap.get(L);if(!M)return;let U=M.info,V=Date.now(),F=QN(QN(QN({},U),k),{},{vid:void 0===U.vid?0:Number(U.vid),eventType:gl.UPDATE_REMOTE_RTPCAPABILITIES,lts:V});this.send({type:gh.UPDATE_REMOTE_RTPCAPABILITIES,data:F},!0)}}onGatewayStream(L,k,M,U){let V=this.baseInfoMap.get(L);if(!V)return;let F=V.info,B=Date.now(),j=QN(QN(QN({},F),U),{},{eventType:k,lts:B});this.send({type:M,data:j},!0)}streamSwitch(L,k){let M=this.baseInfoMap.get(L);if(!M)return;let U=M.info,V=Date.now(),F=QN(QN({},U),{},{eventType:gl.STREAM_SWITCH,lts:V,isDual:k.isdual,elapse:V-M.startTime,success:k.succ});this.send({type:gh.STREAM_SWITCH,data:F},!0)}requestProxyAppCenter(L,k){let M=this.baseInfoMap.get(L);if(!M)return;let U=M.info,V=Date.now(),F=QN(QN({},U),{},{eventType:gl.REQUEST_PROXY_APPCENTER,lts:V,eventElapse:V-k.lts,elapse:V-M.startTime,APAddr:k.APAddr,workerManagerList:k.workerManagerList,response:k.response,errorCode:k.ec,success:k.succ});this.send({type:gh.REQUEST_PROXY_APPCENTER,data:F},!0)}requestProxyWorkerManager(L,k){let M=this.baseInfoMap.get(L);if(!M)return;let U=M.info,V=Date.now(),F=QN(QN({},U),{},{eventType:gl.REQUEST_PROXY_WORKER_MANAGER,lts:V,eventElapse:V-k.lts,elapse:V-M.startTime,workerManagerAddr:k.workerManagerAddr,response:k.response,errorCode:k.ec,success:k.succ});this.send({type:gh.REQUEST_PROXY_WORKER_MANAGER,data:F},!0)}setProxyServer(L){this.proxyServer=L,L?gc.debug("reportProxyServerurl: ".concat(L)):gc.debug("disable reportProxyServerurl: ".concat(L))}peerPublishStatus(L,k){let M=this.baseInfoMap.get(L);if(!M)return;let U=M.info,V=Date.now(),F=QN(QN({},U),{},{subscribeElapse:k.subscribeElapse,peer:k.peer,peerPublishDuration:Math.max(k.audioPublishDuration,k.videoPublishDuration),audiotag:k.audioPublishDuration>0?1:-1,videotag:k.videoPublishDuration>0?1:-1,lts:V,elapse:V-M.startTime,joinChannelSuccessElapse:V-(M.lastJoinSuccessTime||V),peerPublishDurationVideo:k.videoPublishDuration,peerPublishDurationAudio:k.audioPublishDuration});this.send({type:gh.PEER_PUBLISH_STATUS,data:F},!0)}workerEvent(L,k){let M=this.baseInfoMap.get(L);if(!M)return;let U=M.info,V=Date.now();(function(L,k,M){let U=L[k];if(!U||"string"!=typeof U)return[L];L[k]="";let V=RO(JSON.stringify(L)),F=0,B=[],j=0;for(let M=0;M<U.length;M++)(j+=127>=U.charCodeAt(M)?1:3)<=1300-V||(B[B.length]=Aw(Aw({},L),{},{[k]:U.substring(F,M)}),F=M,j=127>=U.charCodeAt(M)?1:3);return F!==U.length-1&&(B[B.length]=Aw(Aw({},L),{},{[k]:U.substring(F)})),B})(QN(QN(QN({},U),k),{},{elapse:V-M.startTime,lts:V,productType:"WebRTC"}),"payload",0).forEach(L=>this.send({type:gh.WORKER_EVENT,data:L},!0))}apworkerEvent(L,k){let M=this.baseInfoMap.get(L);if(!M)return;let U=M.info,V=Date.now(),F=QN(QN(QN({},U),k),{},{elapse:V-M.startTime,lts:V});this.send({type:gh.AP_WORKER_EVENT,data:F},!0)}joinWebProxyAP(L,k){let M=this.baseInfoMap.get(L);if(!M)return;let U=M.info,V=Date.now(),F=QN(QN(QN({},U),k),{},{elapse:V-M.startTime,lts:V,extend:k.extend||void 0});this.send({type:gh.JOIN_WEB_PROXY_AP,data:F},!0)}WebSocketQuit(L,k){let M=this.baseInfoMap.get(L);if(!M)return;let U=M.info,V=Date.now(),F=QN(QN(QN({},U),k),{},{elapse:V-M.startTime,lts:V});this.send({type:gh.WEBSOCKET_QUIT,data:F},!0)}async sendCustomReportMessage(L,k){if(this.customReportCount+=k.length,this.customReportCount>wN("CUSTOM_REPORT_LIMIT"))throw new f2(f1.CUSTOM_REPORT_FREQUENCY_TOO_HIGH);this.customReportCounterTimer||(this.customReportCounterTimer=window.setInterval(()=>{this.customReportCount=0},5e3));let M=Date.now(),U=k.map(k=>({type:gh.USER_ANALYTICS,data:QN(QN({sid:L},k),{},{lts:M})}));try{wN("NEW_REPORT_SERVER")?await this.postDataToStatsCollector2(U):await this.postDataToStatsCollector(U)}catch(L){throw gc.error("send custom report message failed",L.toString()),new f2(f1.CUSTOM_REPORT_SEND_FAILED,L.message)}}sendApiInvoke(L){let k;let M=wN("NOT_REPORT_EVENT");if(L.tag&&so(M)&&so(M).call(M,L.tag))return!1;if(null===L.sid)return this.apiInvokeUploadPendingItems.push(L),!1;let U=this.baseInfoMap.get(L.sid);if(!U)return this.apiInvokeUploadPendingItems.push(L),!1;let{cname:V,uid:F,cid:B}=U.info;if(L.lts=L.lts||Date.now(),L.error){if(L.error instanceof f2){let{code:M,message:U}=L.error;k=M||U||L.error.toString()}else k=L.error.toString()}let j={invokeId:L.invokeId,sid:L.sid,cname:V,cid:B,uid:F,lts:L.lts,success:L.success,elapse:L.lts-U.startTime,execElapse:L.lts-L.apiInvokeTime,apiName:L.name,options:L.options?JSON.stringify(L.options):void 0,execStates:L.states?JSON.stringify(L.states):void 0,execResult:L.result?JSON.stringify(L.result):void 0,errorCode:L.error?k:void 0,errorMsg:L.error?JSON.stringify(L.error):void 0};return this.send({type:gh.API_INVOKE,data:j},!1),!0}addSid(L){this.sids.add(L)}removeSid(L){this.sids.delete(L)}appendSessionId(){let L=this.apiInvokeUploadPendingItems;if(0===L.length)return;let k=Array.from(this.sids).find(L=>null!==L);k&&L.forEach(L=>{L&&(L.sid=k,this.sendApiInvoke(Object.assign({},L)))}),L.length=0}send(L,k){if(k)return this.keyEventUploadPendingItems.push(L),void this.sendItems(this.keyEventUploadPendingItems,!0);this.normalEventUploadPendingItems.push(L),this.normalEventUploadPendingItems.length>wN("NORMAL_EVENT_QUEUE_CAPACITY")&&this.normalEventUploadPendingItems.splice(0,1),this.normalEventUploadPendingItems.length>=10&&this.sendItems(this.normalEventUploadPendingItems,!1)}doSend(){this.keyEventUploadPendingItems.length>0&&this.sendItems(this.keyEventUploadPendingItems,!0),this.normalEventUploadPendingItems.length>0&&Date.now()-this.lastSendNormalEventTime>=5e3&&this.sendItems(this.normalEventUploadPendingItems,!1)}sendItems(L,k){var M;let U=[],V=[];for(;L.length;){let k=L.shift();U.length<20?U.push(k):V.push(k)}for(let k of(L.push(...V),[...U]))-1!==this.ltsList.indexOf(k.data.lts)?(k.data.lts=this.ltsList[this.ltsList.length-1]+1,this.ltsList.push(k.data.lts)):(this.ltsList.push(k.data.lts),uu(M=this.ltsList).call(M,(L,k)=>L-k));return k||(this.lastSendNormalEventTime=Date.now()),wN("ENABLE_EVENT_REPORT")&&U.length&&(wN("NEW_REPORT_SERVER")?this.postDataToStatsCollector2(U):this.postDataToStatsCollector(U)).catch(L=>{wN("EVENT_REPORT_RETRY")&&(k?this.keyEventUploadPendingItems=this.keyEventUploadPendingItems.concat(U):(this.normalEventUploadPendingItems=this.normalEventUploadPendingItems.concat(U),this.normalEventUploadPendingItems.length>wN("NORMAL_EVENT_QUEUE_CAPACITY")&&(this.normalEventUploadPendingItems.splice(0,this.normalEventUploadPendingItems.length-wN("NORMAL_EVENT_QUEUE_CAPACITY")),gc.warning("report: drop normal events"))))}),L}async postDataToStatsCollector2(L){Ss.networkState===Sa.OFFLINE&&await lQ.race([Ss.onlineWaiter,yO(2*Sm.maxRetryTimeout)]);let t=L=>{let k=new Uint8Array;return L.forEach(L=>{let M;let U=jw(JSON.stringify(L.data)),V=new ArrayBuffer(5),F=(M=0,Object.entries(gh).forEach(k=>{let[U,V]=k;V===L.type&&(M=gp[U])}),M),B=new DataView(V);B.setUint16(0,U.byteLength,!0),B.setUint8(2,255&F),B.setUint8(3,F>>>8&255),B.setUint8(4,F>>>16&255),k=Gw(k,new Uint8Array(V)),k=Gw(k,U)}),k},k="event",M=this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(wN("NEW_REPORT_SERVER_DOMAINS")[0],"&p=443&d=").concat(k):"https://".concat(wN("NEW_REPORT_SERVER_DOMAINS")[0],"/").concat(k);for(let U=0;U<2;U+=1){1===U&&(M=this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(wN("NEW_REPORT_SERVER_DOMAINS")[1],"&p=443&d=").concat(k):"https://".concat(wN("NEW_REPORT_SERVER_DOMAINS")[1],"/").concat(k));try{await zO(M,{timeout:1e4,data:t(L),headers:QN(QN({biz:"webrtc",sendts:Math.round(Date.now()/1e3),debug:"false"},this._appId&&{appid:this._appId}),{},{"Content-Type":"application/octet-stream"})},!0)}catch(L){if(1===U)throw L;continue}return}}async postDataToStatsCollector(L){let k=arguments.length>1&&void 0!==arguments[1]&&arguments[1],M=(L=>{let k=L&&L.data.sid&&this.baseInfoMap.get(L.data.sid);return k&&k.info.vid&&+k.info.vid||0})(L[0]),U=M?void 0:this._aid,V={msgType:"EventMessages",sentTs:Math.round(Date.now()/1e3),payloads:L.map(L=>JSON.stringify(L)),vid:M,aid:U};Ss.networkState===Sa.OFFLINE&&await lQ.race([Ss.onlineWaiter,yO(2*Sm.maxRetryTimeout)]);let F=k?"/events/proto-raws":"/events/messages",B=this.url||(this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(wN("EVENT_REPORT_DOMAIN"),"&p=").concat(wN("STATS_COLLECTOR_PORT"),"&d=").concat(F):"https://".concat(wN("EVENT_REPORT_DOMAIN"),":").concat(wN("STATS_COLLECTOR_PORT")).concat(F));for(let L=0;L<2;L+=1){1===L&&(B=this.backupUrl||(this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(wN("EVENT_REPORT_BACKUP_DOMAIN"),"&p=").concat(wN("STATS_COLLECTOR_PORT"),"&d=").concat(F):"https://".concat(wN("EVENT_REPORT_BACKUP_DOMAIN"),":").concat(wN("STATS_COLLECTOR_PORT")).concat(F)));try{k?await qO(B,{timeout:1e4,data:V}):await zO(B,{timeout:1e4,data:V})}catch(k){if(1===L)throw k;continue}return}}createBaseInfo(L,k){let M=Object.assign({},gd);return M.sid=L,this.baseInfoMap.set(L,{info:M,startTime:k}),M}reportResourceTiming(L,k){let M=performance.getEntriesByName(L),U=M[M.length-1];U&&this.reportApiInvoke(k,{name:"Client.resourceTiming",options:U,tag:f9.TRACER}).onSuccess()}};ga.on("REPORT_LOG_UPLOAD",L=>{L.networkState=Ss.networkState,g_.reportApiInvoke(null,{name:"logUploadError",options:L,tag:f9.TRACER}).onSuccess("logUploadError")});let ED=class ED extends f2{constructor(L){super(L,arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",arguments.length>2?arguments[2]:void 0),JN(this,"name","AgoraRTCException")}print(){let L=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"error";return super.print(L,gc)}throw(){super.throw(gc)}};let gf={getDisplayMedia:!1,getStreamFromExtension:!1,supportUnifiedPlan:!1,supportMinBitrate:!1,supportSetRtpSenderParameters:!1,supportDualStream:!0,webAudioMediaStreamDest:!1,supportReplaceTrack:!1,supportWebGL:!1,webAudioWithAEC:!1,supportRequestFrame:!1,supportShareAudio:!1,supportDualStreamEncoding:!1,supportDataChannel:!1,supportPCSetConfiguration:!1,supportWebRTCEncodedTransform:!1,supportWebRTCInsertableStream:!1,supportRequestVideoFrameCallback:!1,supportWebCrypto:!1};function SD(){return"setSinkId"in HTMLAudioElement.prototype&&(!wN("RESTRICTION_SET_PLAYBACK_DEVICE")||(QA()||tw())&&!Rw())}function gD(){return!gf.supportUnifiedPlan||wN("CHROME_FORCE_PLAN_B")&&vw()}function TD(L){return!(iw()||ow(87)||gD()||!wN("ENABLE_PRE_SUB")&&(null==L||!L.autoSubscribe||wN("FORCE_DISABLE_AUTO_SUB")))}function RD(L){return!!wN("ENABLE_INSTANT_VIDEO")||!(null==L||!L.autoSubscribe||wN("FORCE_DISABLE_AUTO_SUB"))}let gS=((eV={}).IOS_15_16_INTERRUPTION_START="ios15_16-interruption-start",eV.IOS_15_16_INTERRUPTION_END="ios15_16-interruption-end",eV.IOS_INTERRUPTION_START="ios-interruption-start",eV.IOS_INTERRUPTION_END="ios-interruption-end",eV.STATE_CHANGE="state-change",eV);function CD(L,k,M){return{sampleRate:L,stereo:k,bitrate:M}}function yD(L,k,M,U,V){return{width:L,height:k,frameRate:M,bitrateMin:U,bitrateMax:V}}function ID(L,k,M,U,V){return{width:{max:L},height:{max:k},frameRate:M,bitrateMin:U,bitrateMax:V}}function bD(L,k){return{numSpatialLayers:L,numTemporalLayers:k}}let gg={"90p":yD(160,90),"90p_1":yD(160,90),"120p":yD(160,120,15,30,65),"120p_1":yD(160,120,15,30,65),"120p_3":yD(120,120,15,30,50),"120p_4":yD(212,120),"180p":yD(320,180,15,30,140),"180p_1":yD(320,180,15,30,140),"180p_3":yD(180,180,15,30,100),"180p_4":yD(240,180,15,30,120),"240p":yD(320,240,15,40,200),"240p_1":yD(320,240,15,40,200),"240p_3":yD(240,240,15,40,140),"240p_4":yD(424,240,15,40,220),"360p":yD(640,360,15,80,400),"360p_1":yD(640,360,15,80,400),"360p_3":yD(360,360,15,80,260),"360p_4":yD(640,360,30,80,600),"360p_6":yD(360,360,30,80,400),"360p_7":yD(480,360,15,80,320),"360p_8":yD(480,360,30,80,490),"360p_9":yD(640,360,15,80,800),"360p_10":yD(640,360,24,80,800),"360p_11":yD(640,360,24,80,1e3),"480p":yD(640,480,15,100,500),"480p_1":yD(640,480,15,100,500),"480p_2":yD(640,480,30,100,1e3),"480p_3":yD(480,480,15,100,400),"480p_4":yD(640,480,30,100,750),"480p_6":yD(480,480,30,100,600),"480p_8":yD(848,480,15,100,610),"480p_9":yD(848,480,30,100,930),"480p_10":yD(640,480,10,100,400),"720p":yD(1280,720,15,120,1130),"720p_auto":yD(1280,720,30,900,3e3),"720p_1":yD(1280,720,15,120,1130),"720p_2":yD(1280,720,30,120,2e3),"720p_3":yD(1280,720,30,120,1710),"720p_5":yD(960,720,15,120,910),"720p_6":yD(960,720,30,120,1380),"1080p":yD(1920,1080,15,120,2080),"1080p_1":yD(1920,1080,15,120,2080),"1080p_2":yD(1920,1080,30,120,3e3),"1080p_3":yD(1920,1080,30,120,3150),"1080p_5":yD(1920,1080,60,120,4780),"1440p":yD(2560,1440,30,120,4850),"1440p_1":yD(2560,1440,30,120,4850),"1440p_2":yD(2560,1440,60,120,7350),"4k":yD(3840,2160,30,120,8910),"4k_1":yD(3840,2160,30,120,8910),"4k_3":yD(3840,2160,60,120,13500)},gT={"480p":ID(640,480,5),"480p_1":ID(640,480,5),"480p_2":ID(640,480,30),"480p_3":ID(640,480,15),"720p":ID(1280,720,5),"720p_auto":yD(1280,720,30,900,3e3),"720p_1":ID(1280,720,5),"720p_2":ID(1280,720,30),"720p_3":ID(1280,720,15),"1080p":ID(1920,1080,5),"1080p_1":ID(1920,1080,5),"1080p_2":ID(1920,1080,30),"1080p_3":ID(1920,1080,15)},gC={"1SL1TL":bD(1,1),"3SL3TL":bD(3,3),"2SL3TL":bD(2,3)};function ND(L){return L||(L="480p_1"),"string"==typeof L?Object.assign({},gg[L]):L}function DD(L){return"string"==typeof L?Object.assign({},gT[L]):L}function PD(L){return"string"==typeof L?Object.assign({},gC[L]):L}let gy={speech_low_quality:CD(16e3,!1),speech_standard:CD(32e3,!1,18),music_standard:CD(48e3,!1),standard_stereo:CD(48e3,!0,56),high_quality:CD(48e3,!1,128),high_quality_stereo:CD(48e3,!0,192)};function kD(L){return"string"==typeof L?Object.assign({},gy[L]):L}let gb=[];function UD(L){return Dw(L,"mediaSource",["screen","window","application"]),!0}let gN=((eW={}).NEED_RENEGOTIATE="@need_renegotiate",eW.NEED_REPLACE_TRACK="@need_replace_track",eW.NEED_REPLACE_MIXING_TRACK="@need_replace_mixing_track",eW.NEED_CLOSE="@need_close",eW.NEED_ENABLE_TRACK="@need_enable_track",eW.NEED_DISABLE_TRACK="@need_disable_track",eW.NEED_SESSION_ID="@need_sid",eW.SET_OPTIMIZATION_MODE="@set_optimization_mode",eW.GET_STATS="@get_stats",eW.GET_RTC_STATS="@get_rtc_stats",eW.GET_LOW_VIDEO_TRACK="@get_low_video_track",eW.NEED_RESET_REMOTE_SDP="@need_reset_remote_sdp",eW.NEED_UPDATE_VIDEO_ENCODER="@need_update_video_encoder",eW.NEED_UPDATE_VIDEO_SEND_PARAMETERS="@need_update_video_send_parameters",eW.NEED_MUTE_TRACK="@need_mute_track",eW.NEED_UNMUTE_TRACK="@need_unmute_track",eW),gL=((eG={}).SCREEN_TRACK="screen_track",eG.CUSTOM_TRACK="custome_track",eG.LOW_STREAM="low_stream",eG.SCREEN_LOW_TRACK="screen_low_track",eG),gk=((eY={})[eY.HIGH_STREAM=0]="HIGH_STREAM",eY[eY.LOW_STREAM=1]="LOW_STREAM",eY),gU=((eJ={})[eJ.HIGH_STREAM=0]="HIGH_STREAM",eJ[eJ.LOW_STREAM=1]="LOW_STREAM",eJ[eJ.HIGH_STREAM_LAYER1=4]="HIGH_STREAM_LAYER1",eJ[eJ.HIGH_STREAM_LAYER2=5]="HIGH_STREAM_LAYER2",eJ[eJ.HIGH_STREAM_LAYER3=6]="HIGH_STREAM_LAYER3",eJ[eJ.HIGH_STREAM_LAYER4=7]="HIGH_STREAM_LAYER4",eJ[eJ.HIGH_STREAM_LAYER5=8]="HIGH_STREAM_LAYER5",eJ[eJ.HIGH_STREAM_LAYER6=9]="HIGH_STREAM_LAYER6",eJ),gV=((eX={})[eX.DISABLE=0]="DISABLE",eX[eX.LOW_STREAM=1]="LOW_STREAM",eX[eX.AUDIO_ONLY=2]="AUDIO_ONLY",eX[eX.HIGH_STREAM_LAYER1=3]="HIGH_STREAM_LAYER1",eX[eX.HIGH_STREAM_LAYER2=4]="HIGH_STREAM_LAYER2",eX[eX.HIGH_STREAM_LAYER3=5]="HIGH_STREAM_LAYER3",eX[eX.HIGH_STREAM_LAYER4=6]="HIGH_STREAM_LAYER4",eX[eX.HIGH_STREAM_LAYER5=7]="HIGH_STREAM_LAYER5",eX[eX.HIGH_STREAM_LAYER6=8]="HIGH_STREAM_LAYER6",eX),gF=((eQ={}).TRANSCEIVER_UPDATED="transceiver-updated",eQ.SEI_TO_SEND="sei-to-send",eQ.SEI_RECEIVED="sei-received",eQ.TRACK_UPDATED="track-updated",eQ),gB=((eZ={}).SOURCE_STATE_CHANGE="source-state-change",eZ.TRACK_ENDED="track-ended",eZ.BEAUTY_EFFECT_OVERLOAD="beauty-effect-overload",eZ.VIDEO_ELEMENT_VISIBLE_STATUS="video-element-visible-status",eZ.CLOSED="closed",eZ),gj=((e$={}).FIRST_FRAME_DECODED="first-frame-decoded",e$.VIDEO_ELEMENT_VISIBLE_STATUS="video-element-visible-status",e$.VIDEO_STATE_CHANGED="video-state-changed",e$.PLAY_START="play-start",e$.PLAY_END="play-end",e$.FIRST_FRAME_RENDER="first-frame-render",e$),gW=((e0={}).AUDIO="audio",e0.VIDEO="video",e0.DATA="data",e0),gG=((e1={}).AUDIO_SOURCE_STATE_CHANGE="audio_source_state_change",e1.RECEIVE_TRACK_BUFFER="receive_track_buffer",e1.ON_AUDIO_BUFFER="on_audio_buffer",e1.UPDATE_SOURCE="update_source",e1),gH={sendVolumeLevel:0,sendBitrate:0,sendBytes:0,sendPackets:0,sendPacketsLost:0,sendJitterMs:0,sendRttMs:0,currentPacketLossRate:0},gK={sendBytes:0,sendBitrate:0,sendPackets:0,sendPacketsLost:0,sendJitterMs:0,sendRttMs:0,sendResolutionHeight:0,sendResolutionWidth:0,captureResolutionHeight:0,captureResolutionWidth:0,targetSendBitrate:0,totalDuration:0,totalFreezeTime:0,currentPacketLossRate:0},gY={transportDelay:0,end2EndDelay:0,receiveBitrate:0,receiveLevel:0,receiveBytes:0,receiveDelay:0,receivePackets:0,receivePacketsLost:0,receivePacketsDiscarded:0,totalDuration:0,totalFreezeTime:0,freezeRate:0,packetLossRate:0,currentPacketLossRate:0,publishDuration:-1},gJ={uplinkNetworkQuality:0,downlinkNetworkQuality:0},gX={transportDelay:0,end2EndDelay:0,receiveBitrate:0,receiveBytes:0,receiveDelay:0,receivePackets:0,receivePacketsLost:0,receiveResolutionHeight:0,receiveResolutionWidth:0,totalDuration:0,totalFreezeTime:0,freezeRate:0,packetLossRate:0,currentPacketLossRate:0,publishDuration:-1},gQ=((e2={}).ON_TRACK="on_track",e2.ON_NODE="on_node",e2),gZ=((e3={}).REQUEST_UPDATE_CONSTRAINTS="request_update_constraints",e3.REQUEST_CONSTRAINTS="request_constraints",e3),g$=((e5={}).IDLE="IDLE",e5.INITING="INITING",e5.INITEND="INITEND",e5),g0=((e4={}).STATE_CHANGE="state_change",e4.RECORDING_DEVICE_CHANGED="recordingDeviceChanged",e4.PLAYOUT_DEVICE_CHANGED="playoutDeviceChanged",e4.CAMERA_DEVICE_CHANGED="cameraDeviceChanged",e4),g1=((e6={}).NONE="none",e6.INIT="init",e6.CANPLAY="canplay",e6.PLAYING="playing",e6.PAUSED="paused",e6.SUSPEND="suspend",e6.STALLED="stalled",e6.WAITING="waiting",e6.ERROR="error",e6.DESTROYED="destroyed",e6.ABORT="abort",e6.ENDED="ended",e6.EMPTIED="emptied",e6.LOADEDDATA="loadeddata",e6),g2=((e8={})[e8.VideoStateStopped=0]="VideoStateStopped",e8[e8.VideoStateStarting=1]="VideoStateStarting",e8[e8.VideoStateDecoding=2]="VideoStateDecoding",e8[e8.VideoStateFrozen=3]="VideoStateFrozen",e8),g3={uninit:100,none:110,init:120,loadeddata:130,canplay:200,playing:210,paused:220,suspend:300,stalled:310,waiting:320,error:330,destroyed:340,abort:350,ended:360,emptied:370},g5=((e9={}).OPEN="open",e9.MESSAGE="message",e9.CLOSE="close",e9.CLOSING="closing",e9.ERROR="error",e9);function sP(L,k,M,U,V){var F,B,j={};return Object.keys(U).forEach(function(L){j[L]=U[L]}),j.enumerable=!!j.enumerable,j.configurable=!!j.configurable,("value"in j||j.initializer)&&(j.writable=!0),j=sE(F=sI(B=M.slice()).call(B)).call(F,function(M,U){return U(L,k,M)||M},j),V&&void 0!==j.initializer&&(j.value=j.initializer?j.initializer.call(V):void 0,j.initializer=void 0),void 0===j.initializer?(Object.defineProperty(L,k,j),null):j}function aP(L,k,M){var U;return(k="symbol"==typeof(U=function(L,k){if("object"!=typeof L||!L)return L;var M=L[Symbol.toPrimitive];if(void 0!==M){var U=M.call(L,"string");if("object"!=typeof U)return U;throw TypeError("@@toPrimitive must return a primitive value.")}return String(L)}(k))?U:U+"")in L?Object.defineProperty(L,k,{value:M,enumerable:!0,configurable:!0,writable:!0}):L[k]=M,L}function cP(L,k){var M=Object.keys(L);if(Object.getOwnPropertySymbols){var U=Object.getOwnPropertySymbols(L);k&&(U=U.filter(function(k){return Object.getOwnPropertyDescriptor(L,k).enumerable})),M.push.apply(M,U)}return M}function dP(L){for(var k=1;k<arguments.length;k++){var M=null!=arguments[k]?arguments[k]:{};k%2?cP(Object(M),!0).forEach(function(k){aP(L,k,M[k])}):Object.getOwnPropertyDescriptors?Object.defineProperties(L,Object.getOwnPropertyDescriptors(M)):cP(Object(M)).forEach(function(k){Object.defineProperty(L,k,Object.getOwnPropertyDescriptor(M,k))})}return L}let lP=class lP extends Hw{set _mediaStreamTrack(L){L!==this.mediaStreamTrack&&(this.safeEmit(gF.TRACK_UPDATED,L),this.mediaStreamTrack=L)}get _mediaStreamTrack(){return this.mediaStreamTrack}constructor(L,k){super(),aP(this,"trackMediaType",void 0),aP(this,"_ID",void 0),aP(this,"_rtpTransceiver",void 0),aP(this,"_lowRtpTransceiver",void 0),aP(this,"_hints",[]),aP(this,"_isClosed",!1),aP(this,"_originMediaStreamTrack",void 0),aP(this,"mediaStreamTrack",void 0),aP(this,"_external",{}),this._ID=k||IO(8,"track-"),this._originMediaStreamTrack=L,this.mediaStreamTrack=L,so(gb).call(gb,this)||gb.push(this)}toString(){return this._ID}getTrackId(){return this._ID}getMediaStreamTrack(L){return L||mO(()=>{var L;g_.reportApiInvoke(null,{name:f8.GET_MEDIA_STREAM_TRACK,options:[],tag:f9.TRACER}).onSuccess((null===(L=this._mediaStreamTrack)||void 0===L?void 0:L.label)||"")},this.mediaStreamTrack.id||this.getTrackId()),this._mediaStreamTrack}getRTCRtpTransceiver(L){return L===gk.LOW_STREAM?this._lowRtpTransceiver:this._rtpTransceiver}getMediaStreamTrackSettings(){return this.getMediaStreamTrack(!0).getSettings()}close(){this._isClosed=!0,this._lowRtpTransceiver=void 0,this._rtpTransceiver=void 0,function(L){let k=gb.indexOf(L);-1!==k&&gb.splice(k,1)}(this),this.emit(gB.CLOSED),this.removeAllListeners(gF.SEI_RECEIVED)}_updateRtpTransceiver(L,k){if(k===gk.LOW_STREAM){if(this._lowRtpTransceiver===L)return;this._lowRtpTransceiver=L}else{if(this._rtpTransceiver===L)return;this._rtpTransceiver=L}this.emit(gF.TRANSCEIVER_UPDATED,L,k)}};let uP=class uP extends lP{get isExternalTrack(){return this._isExternalTrack}get muted(){return this._muted}get enabled(){return this._enabled}get processorContext(){return this._processorContext}constructor(L,k){super(L,k),aP(this,"_enabled",!0),aP(this,"_muted",!1),aP(this,"_isExternalTrack",!1),aP(this,"_isClosed",!1),aP(this,"_enabledMutex",void 0),aP(this,"processor",void 0),aP(this,"_processorContext",void 0),aP(this,"_handleTrackEnded",()=>{this.onTrackEnded()}),this._enabledMutex=new S_("".concat(this.getTrackId())),L.addEventListener("ended",this._handleTrackEnded)}getTrackLabel(){var L,k;return null!==(L=null===(k=this._originMediaStreamTrack)||void 0===k?void 0:k.label)&&void 0!==L?L:""}close(){this._isClosed||(this.stop(),this._originMediaStreamTrack.stop(),this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack.stop(),this._mediaStreamTrack=null),this._originMediaStreamTrack=null,this._enabledMutex=null,gc.debug("[".concat(this.getTrackId(),"] close")),this.emit(gN.NEED_CLOSE),super.close())}async _updateOriginMediaStreamTrack(L,k){let M=arguments.length>2&&void 0!==arguments[2]&&arguments[2];this._isExternalTrack=M,L!==this._originMediaStreamTrack&&(this._originMediaStreamTrack&&(this._originMediaStreamTrack.removeEventListener("ended",this._handleTrackEnded),k&&this._originMediaStreamTrack.stop()),L.addEventListener("ended",this._handleTrackEnded),this._originMediaStreamTrack=L,this._muted&&(this._originMediaStreamTrack.enabled=!1),this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await sO(this,gN.NEED_REPLACE_TRACK,this),this.processor&&this._processorContext&&this.processor.updateInput({track:this._originMediaStreamTrack,context:this._processorContext}))}_getDefaultPlayerConfig(){return{}}onTrackEnded(){gc.debug("[".concat(this.getTrackId(),"] track ended")),this.safeEmit(gB.TRACK_ENDED)}stateCheck(L,k){if(gc.debug("check track state, [muted: ".concat(this._muted,", enabled: ").concat(this._enabled,"] to [").concat(L,": ").concat(k,"]")),Nw(k,L),this._enabled&&this._muted&&"enabled"===L&&!1===k)throw new f2(f1.TRACK_STATE_UNREACHABLE,"cannot set enabled while the track is muted").print("error",gc);if(!this._enabled&&!this._muted&&"muted"===L&&!0===k)throw new f2(f1.TRACK_STATE_UNREACHABLE,"cannot set muted while the track is disabled").print("error",gc)}getProcessorStats(){return this._processorContext&&this._processorContext.gatherStats()||[]}getProcessorUsage(){return this._processorContext?this._processorContext.gatherUsage():lQ.resolve([])}};let g4=window.AudioContext||window.webkitAudioContext,g6=null,g8=new class extends Hw{constructor(){super(...arguments),aP(this,"prevState",void 0),aP(this,"curState",void 0),aP(this,"currentTime",void 0),aP(this,"currentTimeStuckAt",void 0),aP(this,"interruptDetectorTrack",void 0),aP(this,"onLocalAudioTrackMute",()=>{gc.info("ios15-interruption-start"),this.emit(gS.IOS_15_16_INTERRUPTION_START)}),aP(this,"onLocalAudioTrackUnmute",async()=>{gc.info("ios15-interruption-end"),"running"!==this.curState||this.duringInterruption?gc.info("ios15-interruption-end-canceled"):(g6&&await g6.suspend(),this.emit(gS.IOS_15_16_INTERRUPTION_END))})}get duringInterruption(){return"running"===this.prevState&&"interrupted"===this.curState}bindInterruptDetectorTrack(L){gc.debug("webaudio bindInterruptDetectorTrack ".concat(L.getTrackId())),this.interruptDetectorTrack||(this.interruptDetectorTrack=L,this.interruptDetectorTrack._mediaStreamTrack.onmute=this.onLocalAudioTrackMute,this.interruptDetectorTrack._mediaStreamTrack.onunmute=this.onLocalAudioTrackUnmute)}unbindInterruptDetectorTrack(L){gc.debug("webaudio unbindInterruptDetectorTrack ".concat(L.getTrackId())),this.interruptDetectorTrack&&this.interruptDetectorTrack===L&&(this.interruptDetectorTrack._mediaStreamTrack&&(this.interruptDetectorTrack._mediaStreamTrack.onmute=null,this.interruptDetectorTrack._mediaStreamTrack.onunmute=null),this.interruptDetectorTrack=void 0)}};function EP(){if(!g6&&(function(){if(!g4)return void gc.error("your browser is not support web audio");gc.info("create audio context");let L=dP({},wN("WEBAUDIO_INIT_OPTIONS"));gc.debug("audio context init option:",JSON.stringify(L)),g6=new g4(L),g8.curState=g6.state,g6.onstatechange=()=>{g8.prevState=g8.curState,g8.curState=g6?g6.state:void 0;let{prevState:L,curState:k}=g8,M="running"===k,U="interrupted"===k,V="running"===L,F="suspended"===L,B="interrupted"===L,j=zA().osVersion;(nw()||Sw())&&V&&U&&(gc.info("ios".concat(j,"-interruption-start")),g8.emit(gS.IOS_INTERRUPTION_START)),(nw()||Sw())&&(F||B)&&M&&(gc.info("ios".concat(j,"-interruption-end")),g8.emit(gS.IOS_INTERRUPTION_END)),L!==k&&g8.emit(gS.STATE_CHANGE,k,L)},setInterval(()=>{var L;let k=null===(L=g6)||void 0===L?void 0:L.currentTime;g8.currentTime!==k?(g8.currentTimeStuckAt&&(gc.debug("AudioContext current time resume at ".concat(k)),g8.currentTimeStuckAt=void 0),g8.currentTime=k):(k!==g8.currentTimeStuckAt&&(g_.reportApiInvoke(null,{name:"WEB_AUDIO_CURRENT_TIME_STUCK",options:{currentTime:k},tag:f9.TRACER}).onSuccess(),gc.warning("AudioContext current time stuck at ".concat(k))),g8.currentTimeStuckAt=k)},5e3),async function(L){let k=["click","contextmenu","auxclick","dblclick","mousedown","mouseup","touchend","keydown","keyup"],M,U=!1,V=!1,F=!1;function s(k){"running"===L.state?a(!1):nw()||Sw()?"suspended"===L.state&&(a(!0),k&&L.resume().then(c,c)):"closed"!==L.state&&(a(!0),k&&L.resume().then(c,c))}function a(L){if(U!==L){U=L;for(let M=0;M<k.length;M+=1){let U=k[M];L?window.addEventListener(U,d,{capture:!0,passive:!0}):window.removeEventListener(U,d,{capture:!0,passive:!0})}}}function c(){s(!1)}function d(){s(!0)}function l(L){if(!F){if(M.paused){if(L){let L;u(!1),F=!0;try{(L=M.play())?L.then(h,h):(M.addEventListener("playing",h),M.addEventListener("abort",h),M.addEventListener("error",h))}catch(L){h()}}else u(!0)}else u(!1)}}function u(L){if(V!==L){V=L;for(let M=0;M<k.length;M++){let U=k[M];L?window.addEventListener(U,p,{capture:!0,passive:!0}):window.removeEventListener(U,p,{capture:!0,passive:!0})}}}function h(){M.removeEventListener("playing",h),M.removeEventListener("abort",h),M.removeEventListener("error",h),F=!1,l(!1)}function p(){l(!0)}if(nw()){let k=L.createMediaStreamDestination(),U=document.createElement("div");U.innerHTML="<audio x-webkit-airplay='deny'></audio>",(M=U.children.item(0)).controls=!1,M.disableRemotePlayback=!0,M.preload="auto",M.srcObject=k.stream,l(!0)}g8.on(gS.STATE_CHANGE,function(){s(!0)}),s(!1)}(g6)}(),!g6))throw new f2(f1.NOT_SUPPORTED,"can not create audio context");return g6}function mP(L){if(function(){if(null!==g9)return g9;let L=EP(),k=L.createBufferSource(),M=L.createGain(),U=L.createGain();k.connect(M),k.connect(U),k.disconnect(M);let V=!1;try{k.disconnect(M)}catch(L){V=!0}return k.disconnect(),g9=V,V}())return;let k=L.connect,M=L.disconnect;L.connect=(M,U,V)=>{var F;return L._inputNodes||(L._inputNodes=[]),so(F=L._inputNodes).call(F,M)||(M instanceof AudioNode?(L._inputNodes.push(M),k.call(L,M,U,V)):k.call(L,M,U)),L},L.disconnect=(U,V,F)=>{for(let V of(M.call(L),U?lO(L._inputNodes,U):L._inputNodes=[],L._inputNodes))k.call(L,V)}}let g9=null;function SP(L,k){let M=!1,U=1/k;if(wN("DISABLE_WEBAUDIO")){let k=window.setInterval(()=>{M?window.clearInterval(k):L(performance.now()/1e3)},1e3*U)}else{let k=EP(),V=k.createGain();V.gain.value=0,V.connect(k.destination);let o=()=>{if(M)return void(V=null);let F=k.createOscillator();F.onended=o,F.connect(V),F.start(0),F.stop(k.currentTime+U),L(k.currentTime)};o()}return()=>{M=!0}}let gP=class gP{constructor(){aP(this,"context",void 0),aP(this,"analyserNode",void 0),aP(this,"sourceNode",void 0),this.context=EP(),this.analyserNode=this.context.createAnalyser(),this.analyserNode.fftSize=2048,this.analyserNode.smoothingTimeConstant=.4}updateSource(L){if(L!==this.sourceNode){if(this.sourceNode)try{this.sourceNode.disconnect(this.analyserNode)}catch(L){}this.sourceNode=L,null==L||L.connect(this.analyserNode)}}getVolumeLevel(){if(!this.sourceNode||(!this.context||nw()||Sw()||"running"!==this.context.state&&this.context.resume(),!this.analyserNode))return 0;let L=new Float32Array(this.analyserNode.fftSize);if(this.analyserNode.getFloatTimeDomainData)this.analyserNode.getFloatTimeDomainData(L);else{let k=new Uint8Array(this.analyserNode.fftSize);this.analyserNode.getByteTimeDomainData(k);for(let M=0;M<L.length;++M)L[M]=k[M]/128-1}let k=sE(L).call(L,(L,k)=>L+k*k,0)/L.length;return Math.max(10*Math.log10(k)+100,0)/100}getAnalyserNode(){return this.analyserNode}rebuildAnalyser(){try{var L,k;null===(L=this.sourceNode)||void 0===L||L.disconnect(this.analyserNode),this.analyserNode=this.context.createAnalyser(),this.analyserNode.fftSize=2048,this.analyserNode.smoothingTimeConstant=.4,null===(k=this.sourceNode)||void 0===k||k.connect(this.analyserNode)}catch(L){gc.warning("rebuild analyser node failed.")}}destroy(){this.updateSource(void 0)}};let TP=class TP extends Hw{get processSourceNode(){return this.sourceNode}set processedNode(L){var k,M;if(!this.isDestroyed&&this._processedNode!==L){try{null===(M=this.sourceNode)||void 0===M||M.disconnect(this.outputNode)}catch(L){}null===(k=this._processedNode)||void 0===k||k.disconnect(),this._processedNode=L,this.connect()}}get processedNode(){return this._processedNode}constructor(){super(),aP(this,"outputNode",void 0),aP(this,"outputTrack",void 0),aP(this,"isPlayed",!1),aP(this,"sourceNode",void 0),aP(this,"context",void 0),aP(this,"audioBufferNode",void 0),aP(this,"destNode",void 0),aP(this,"audioOutputLevel",0),aP(this,"volumeLevelAnalyser",void 0),aP(this,"_processedNode",void 0),aP(this,"playNode",void 0),aP(this,"isDestroyed",!1),aP(this,"onNoAudioInput",void 0),aP(this,"isNoAudioInput",!1),aP(this,"_noAudioInputCount",0),this.context=EP(),this.playNode=this.context.destination,this.outputNode=this.context.createGain(),mP(this.outputNode),this.volumeLevelAnalyser=new gP}startGetAudioBuffer(L){this.audioBufferNode||(this.audioBufferNode=this.context.createScriptProcessor(L),this.outputNode.connect(this.audioBufferNode),this.audioBufferNode.connect(this.context.destination),this.audioBufferNode.onaudioprocess=L=>{this.emit(gG.ON_AUDIO_BUFFER,function(L){for(let k=0;k<L.outputBuffer.numberOfChannels;k+=1){let M=L.outputBuffer.getChannelData(k);for(let L=0;L<M.length;L+=1)M[L]=0}return L.inputBuffer}(L))})}stopGetAudioBuffer(){this.audioBufferNode&&(this.audioBufferNode.onaudioprocess=null,this.outputNode.disconnect(this.audioBufferNode),this.audioBufferNode=void 0)}createOutputTrack(){if(!gf.webAudioMediaStreamDest)throw new f2(f1.NOT_SUPPORTED,"your browser is not support audio processor");return this.destNode&&this.outputTrack||(this.destNode=this.context.createMediaStreamDestination(),this.outputNode.connect(this.destNode),this.outputTrack=this.destNode.stream.getAudioTracks()[0]),this.outputTrack}play(L){"running"!==this.context.state&&hO(()=>{g8.emit("autoplay-failed")}),this.isPlayed=!0,this.playNode=L||this.context.destination,this.outputNode.connect(this.playNode)}stop(){if(this.isPlayed)try{this.outputNode.disconnect(this.playNode)}catch(L){}this.isPlayed=!1}getAccurateVolumeLevel(){return this.volumeLevelAnalyser.getVolumeLevel()}async checkHasAudioInput(){let L,k=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;if(k>5)return this.isNoAudioInput=!0,this.onNoAudioInput&&this.onNoAudioInput(),!1;nw()||Sw()?"suspended"===this.context.state&&this.context.resume():"running"!==this.context.state&&this.context.resume();let M=this.volumeLevelAnalyser.getAnalyserNode();M.getFloatTimeDomainData?(L=new Float32Array(M.fftSize),M.getFloatTimeDomainData(L)):(L=new Uint8Array(M.fftSize),M.getByteTimeDomainData(L));let U=!1;for(let k=0;k<L.length;k++)0!==L[k]&&(U=!0);return U?(this.isNoAudioInput=!1,!0):(await yO(200),await this.checkHasAudioInput(k?k+1:1)&&U)}getAudioVolume(){return this.outputNode.gain.value}setVolume(L){this.outputNode.gain.setValueAtTime(L,this.context.currentTime)}destroy(){this.disconnect(),this.stop(),this.isDestroyed=!0,this.onNoAudioInput=void 0}disconnect(){var L,k;null===(L=this.processedNode)||void 0===L||L.disconnect(),null===(k=this.sourceNode)||void 0===k||k.disconnect(),this.outputNode&&this.outputNode.disconnect()}connect(){var L;this.processedNode?null===(L=this.processedNode)||void 0===L||L.connect(this.outputNode):this.sourceNode&&this.sourceNode.connect(this.outputNode),this.volumeLevelAnalyser.updateSource(this.outputNode)}};let RP=class RP extends TP{get isFreeze(){return!1}constructor(L,k,M){var U;if(super(),aP(this,"sourceNode",void 0),aP(this,"track",void 0),aP(this,"clonedTrack",void 0),aP(this,"audioElement",void 0),aP(this,"isCurrentTrackCloned",!1),aP(this,"isRemoteTrack",!1),aP(this,"originVolumeLevelAnalyser",void 0),aP(this,"rebuildWebAudio",async()=>{if(gc.debug("ready to rebuild web audio, state:",this.context.state),this.isNoAudioInput&&await this.checkHasAudioInput(),!this.isNoAudioInput||this.isDestroyed)return document.body.removeEventListener("click",this.rebuildWebAudio,!0),void gc.debug("rebuild web audio success, current volume status",this.getAccurateVolumeLevel());this.context.resume().then(()=>gc.info("resume success")),gc.debug("rebuild web audio because of ios 12 bugs"),this.disconnect();let L=this.track;this.track=this.track.clone(),this.isCurrentTrackCloned?L.stop():this.isCurrentTrackCloned=!0;let k=new MediaStream([this.track]);this.sourceNode=this.context.createMediaStreamSource(k),mP(this.sourceNode),this.volumeLevelAnalyser.rebuildAnalyser();let M=this.outputNode.gain.value;this.outputNode=this.context.createGain(),this.outputNode.gain.setValueAtTime(M,this.context.currentTime),mP(this.outputNode),this.emit(gG.UPDATE_SOURCE),this.connect(),this.audioElement.srcObject=k,this.isPlayed&&this.play(this.playNode),this.checkHasAudioInput()}),"audio"!==L.kind)throw new f2(f1.UNEXPECTED_ERROR);this.track=L;let V=new MediaStream([this.track]);if(this.isRemoteTrack=!!k,this.sourceNode=this.context.createMediaStreamSource(V),mP(this.sourceNode),M){let L=M.clone();L.enabled=!0,this.clonedTrack=L,gc.debug("create an unmuted track ".concat(L.id," from the original track ").concat(M.id," to get the volume"));let k=this.context.createMediaStreamSource(new MediaStream([L]));mP(k),this.originVolumeLevelAnalyser=new gP,this.originVolumeLevelAnalyser.updateSource(k)}this.connect(),this.audioElement=document.createElement("audio"),this.audioElement.srcObject=V;let F=zA();k&&F.os===fX.IOS&&15>Number(null===(U=F.osVersion)||void 0===U?void 0:U.split(".")[0])&&(g8.on(gS.STATE_CHANGE,()=>{"suspended"===this.context.state?document.body.addEventListener("click",this.rebuildWebAudio,!0):"running"===this.context.state&&this.rebuildWebAudio()}),this.checkHasAudioInput().then(L=>{L||document.body.addEventListener("click",this.rebuildWebAudio,!0)}))}updateTrack(L){this.sourceNode.disconnect(),this.track=L,this.isCurrentTrackCloned=!1;let k=new MediaStream([L]);this.sourceNode=this.context.createMediaStreamSource(k),mP(this.sourceNode),this.processedNode||this.sourceNode.connect(this.outputNode),this.emit(gG.UPDATE_SOURCE),this.audioElement.srcObject=k}destroy(){var L;this.audioElement.srcObject=null,this.audioElement.remove(),g8.off("state-change",this.rebuildWebAudio),null===(L=this.originVolumeLevelAnalyser)||void 0===L||L.destroy(),this.clonedTrack=void 0,super.destroy()}createMediaStreamSourceNode(L){return this.context.createMediaStreamSource(new MediaStream([L]))}updateOriginTrack(L){let k=L.clone();k.enabled=!0,this.clonedTrack&&(this.clonedTrack.stop(),this.clonedTrack=k),gc.debug("create an unmuted track ".concat(k.id," from the original track ").concat(L.id," to get the volume"));let M=this.context.createMediaStreamSource(new MediaStream([k]));mP(M),this.originVolumeLevelAnalyser&&this.originVolumeLevelAnalyser.updateSource(M)}getOriginVolumeLevel(){return this.originVolumeLevelAnalyser?this.originVolumeLevelAnalyser.getVolumeLevel():this.getAccurateVolumeLevel()}};async function vP(L,k,M){let n=(L,k)=>L?"number"!=typeof L?L.max||L.exact||L.ideal||L.min||k:L:k,U={audio:!!M&&{mandatory:{chromeMediaSource:"desktop"}},video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:L,maxHeight:n(k.height,1080),maxWidth:n(k.width,1920)}}};return k.frameRate&&"number"!=typeof k.frameRate?(U.video.mandatory.maxFrameRate=k.frameRate.max,U.video.mandatory.minFrameRate=k.frameRate.min):"number"==typeof k.frameRate&&(U.video.mandatory.maxFrameRate=k.frameRate),await navigator.mediaDevices.getUserMedia(U)}async function CP(L,k){let M=await yP(L.mediaSource),{sourceId:U,audio:V}=await function(L){let k=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return new lQ((M,U)=>{let V=document.createElement("div");V.innerText="share screen",V.setAttribute("style","text-align: center; height: 25px; line-height: 25px; border-radius: 4px 4px 0 0; background: #D4D2D4; border-bottom:  solid 1px #B9B8B9;");let F=document.createElement("div");F.setAttribute("style","width: 100%; height: 500px; padding: 15px 25px ; box-sizing: border-box;");let B=document.createElement("div");B.innerText="Agora Web Screensharing wants to share the contents of your screen with webdemo.agorabeckon.com. Choose what you'd like to share.",B.setAttribute("style","height: 12%;");let j=document.createElement("div");j.setAttribute("style","width: 100%; height: 80%; background: #FFF; border:  solid 1px #CBCBCB; display: flex; flex-wrap: wrap; justify-content: space-around; overflow-y: scroll; padding: 0 15px; box-sizing: border-box;");let G=document.createElement("div");G.setAttribute("style","display: flex; justify-content: space-between; padding: 16px 0;");let X=document.createElement("button");X.innerHTML="cancel",X.setAttribute("style","width: 85px;"),X.onclick=()=>{document.body.removeChild(et);let L=Error("NotAllowedError");L.name="NotAllowedError",U(L)};let $=k,ee=document.createElement("div");if(k){let L=document.createElement("input");L.setAttribute("type","checkbox");let k=document.createElement("span");L.setAttribute("style","margin-right: 6px;"),k.innerText="Share audio",L.checked=$,L.onchange=()=>{$=L.checked},ee.appendChild(L),ee.appendChild(k)}G.appendChild(ee),G.appendChild(X),F.appendChild(B),F.appendChild(j),F.appendChild(G);let et=document.createElement("div");et.setAttribute("style","position: fixed; z-index: 99999999; top: 50%; left: 50%; width: 620px; height: 525px; background: #ECECEC; border-radius: 4px; -webkit-transform: translate(-50%,-50%); transform: translate(-50%,-50%);"),et.appendChild(V),et.appendChild(F),document.body.appendChild(et),L.map(L=>{if(L.id){let k=document.createElement("div");k.setAttribute("style","width: 30%; height: 160px; padding: 20px 0; text-align: center;box-sizing: content-box;");let U=L.thumbnail;try{let{width:L}=U.getSize();L>1920&&(U=U.resize({width:1920}))}catch(L){throw L&&L.message.startsWith("Illegal invocation")&&console.error("Operate thumbnail error, please try to set contextIsolation: false. (https://github.com/electron/electron/issues/34953)"),L}k.innerHTML='<div style="height: 120px; display: table-cell; vertical-align: middle;"><img style="width: 100%; background: #333333; box-shadow: 1px 1px 1px 1px rgba(0, 0, 0, 0.2);" src='+U.toDataURL()+' /></div><span style="	height: 40px; line-height: 40px; display: inline-block; width: 70%; word-break: keep-all; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">'+L.name.replace(/[\u00A0-\u9999<>\&]/g,function(L){return"&#"+L.charCodeAt(0)+";"})+"</span>",k.onclick=()=>{document.body.removeChild(et),M({sourceId:L.id,audio:$})},j.appendChild(k)}})})}(M,k);return await vP(U,L,V)}async function yP(L){let k=["window","screen"];"application"!==L&&"window"!==L||(k=["window"]),"screen"===L&&(k=["screen"]);let M=Yw();if(!M)throw console.error("failed to fetch electron, please mount it to window"),new f2(f1.ELECTRON_IS_NULL);let U=null;try{var V;U=(null===(V=M.desktopCapturer)||void 0===V?void 0:V.getSources({types:k}))||M.ipcRenderer.invoke("DESKTOP_CAPTURER_GET_SOURCES",{types:k})}catch(L){U=null}U&&U.then||(U=new lQ((L,U)=>{M.desktopCapturer.getSources({types:k},(k,M)=>{k?U(k):L(M)})}));try{return await U}catch(L){throw new f2(f1.ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR,L.toString())}}let g7=new S_("safari"),Te=!1,Tt=!1;async function wP(L,k){let M=0,U=null;for(;M<2;)try{U=await OP(L,k,M>0);break}catch(U){if(U instanceof f2)throw gc.error("[".concat(k,"] ").concat(U.toString())),U;let L=NP(U.name||U.code||U,U.message);if(L.code===f1.MEDIA_OPTION_INVALID){gc.debug("[".concat(k,"] detect media option invalid, retry")),M+=1,await yO(500);continue}throw gc.error("[".concat(k,"] ").concat(L.toString())),L}if(!U)throw new f2(f1.UNEXPECTED_ERROR,"can not find stream after getUserMedia");return U}async function OP(L,k,M){var U,V;if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)throw new f2(f1.NOT_SUPPORTED,"can not find getUserMedia");M&&(L.video&&(delete L.video.width,delete L.video.height),L.screen&&(delete L.screen.width,delete L.screen.height));let F=new MediaStream;if(L.audioSource&&F.addTrack(L.audioSource),L.videoSource&&F.addTrack(L.videoSource),!L.audio&&!L.video&&!L.screen)return gc.debug("Using Video Source/ Audio Source"),F;if(L.screen){if(Yw())L.screen.sourceId?DP(F,await vP(L.screen.sourceId,L.screen,!!L.screenAudio)):DP(F,await CP(L.screen,!!L.screenAudio));else if(QA()&&L.screen.extensionId&&L.screen.mandatory){if(!gf.getStreamFromExtension)throw new f2(f1.NOT_SUPPORTED,"This browser does not support screen sharing");gc.debug("[".concat(k,'] Screen access on chrome stable, looking for extension"'));let M=await (V=L.screen.extensionId,new lQ((L,M)=>{try{chrome.runtime.sendMessage(V,{getStream:!0},U=>{if(!U||!U.streamId)return gc.error("[".concat(k,"] No response from Chrome Plugin. Plugin not installed properly"),U),void M(new f2(f1.CHROME_PLUGIN_NO_RESPONSE,"No response from Chrome Plugin. Plugin not installed properly"));L(U.streamId)})}catch(L){gc.error("[".concat(k,"] AgoraRTC screensharing plugin is not accessible(").concat(V,")"),L.toString()),M(new f2(f1.CHROME_PLUGIN_NOT_INSTALL))}}));L.screen.mandatory.chromeMediaSourceId=M,DP(F,await navigator.mediaDevices.getUserMedia({video:{mandatory:L.screen.mandatory}}))}else if(gf.getDisplayMedia){L.screen.mediaSource&&UD(L.screen.mediaSource);let M={width:L.screen.width,height:L.screen.height,frameRate:L.screen.frameRate,displaySurface:null!==(U=L.screen.displaySurface)&&void 0!==U?U:"screen"===L.screen.mediaSource?"monitor":L.screen.mediaSource},{selfBrowserSurface:V,surfaceSwitching:B,systemAudio:j,preferCurrentTab:G}=L.screen,X={selfBrowserSurface:V,surfaceSwitching:B,systemAudio:j,preferCurrentTab:G};V||delete X.selfBrowserSurface,B||delete X.surfaceSwitching,j||delete X.systemAudio,G||delete X.preferCurrentTab,gc.debug("[".concat(k,"] getDisplayMedia:"),JSON.stringify({video:M,audio:L.screenAudio,controls:X})),DP(F,await navigator.mediaDevices.getDisplayMedia(dP({video:M,audio:L.screenAudio},X)))}else{if(!iw())throw gc.error("[".concat(k,"] This browser does not support screenSharing")),new f2(f1.NOT_SUPPORTED,"This browser does not support screen sharing");{L.screen.mediaSource&&UD(L.screen.mediaSource);let M={video:{mediaSource:L.screen.mediaSource,width:L.screen.width,height:L.screen.height,frameRate:L.screen.frameRate}};gc.debug("[".concat(k,"] getUserMedia: ").concat(JSON.stringify(M))),DP(F,await navigator.mediaDevices.getUserMedia(M))}}}if(!L.video&&!L.audio)return F;let B={video:L.video,audio:L.audio},j=wN("MEDIA_DEVICE_CONSTRAINTS");if(j)try{"string"==typeof j&&(j=JSON.parse(j)),B=DO(B,j)}catch(L){}gc.debug("[".concat(k,"] GetUserMedia"),JSON.stringify(B)),zA();let G,X=null;($A()||nw()||ZA())&&(X=await g7.lock());try{G=await navigator.mediaDevices.getUserMedia(B)}catch(L){throw X&&X(),L}return B.audio&&(Te=!0),B.video&&(Tt=!0),DP(F,G),X&&X(),F}function NP(L,k){switch(L){case"Starting video failed":case"OverconstrainedError":case"TrackStartError":return new f2(f1.MEDIA_OPTION_INVALID,"".concat(L,": ").concat(k));case"NotFoundError":case"DevicesNotFoundError":return new f2(f1.DEVICE_NOT_FOUND,"".concat(L,": ").concat(k));case"NotSupportedError":return new f2(f1.NOT_SUPPORTED,"".concat(L,": ").concat(k));case"NotReadableError":return new f2(f1.NOT_READABLE,"".concat(L,": ").concat(k));case"InvalidStateError":case"NotAllowedError":case"PERMISSION_DENIED":case"PermissionDeniedError":return new f2(f1.PERMISSION_DENIED,"".concat(L,": ").concat(k));case"ConstraintNotSatisfiedError":return new f2(f1.CONSTRAINT_NOT_SATISFIED,"".concat(L,": ").concat(k));default:return gc.error("getUserMedia unexpected error",L),new f2(f1.UNEXPECTED_ERROR,"".concat(L,": ").concat(k))}}function DP(L,k){let M=L.getVideoTracks()[0],U=L.getAudioTracks()[0],V=k.getVideoTracks()[0],F=k.getAudioTracks()[0];F&&(U&&L.removeTrack(U),L.addTrack(F)),V&&(M&&L.removeTrack(M),L.addTrack(V))}let Ti=new class extends Hw{get state(){return this._state}set state(L){L!==this._state&&(this.emit(g0.STATE_CHANGE,L),this._state=L)}constructor(){super(),aP(this,"_state",g$.IDLE),aP(this,"isAccessMicrophonePermission",!1),aP(this,"isAccessCameraPermission",!1),aP(this,"lastAccessMicrophonePermission",!1),aP(this,"lastAccessCameraPermission",!1),aP(this,"checkdeviceMatched",!1),aP(this,"deviceInfoMap",new Map),this.init().then(()=>{navigator.mediaDevices.addEventListener&&navigator.mediaDevices.addEventListener("devicechange",this.updateDevicesInfo.bind(this)),window.setInterval(()=>{(wN("ENUMERATE_DEVICES_INTERVAL")||(Cw()||XA()===fX.HARMONY_OS)&&vw())&&this.updateDevicesInfo()},wN("ENUMERATE_DEVICES_INTERVAL_TIME"))}).catch(L=>gc.error(L.toString()))}async enumerateDevices(L,k){let M=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!navigator.mediaDevices||!navigator.mediaDevices.enumerateDevices)return new f2(f1.NOT_SUPPORTED,"enumerateDevices() not supported.").throw();let U=await navigator.mediaDevices.enumerateDevices(),V=this.checkMediaDeviceInfoIsOk(U),F=!this.isAccessMicrophonePermission&&L,B=!this.isAccessCameraPermission&&k;V.audio&&(F=!1),V.video&&(B=!1);let j=null,G=null,X=null;if(!M&&(F||B)){if(g7.isLocked&&(gc.debug("[device manager] wait GUM lock"),(await g7.lock())(),gc.debug("[device manager] GUM unlock")),Te&&(F=!1,this.isAccessMicrophonePermission=!0),Tt&&(B=!1,this.isAccessCameraPermission=!0),gc.debug("[device manager] check media device permissions",L,k,F,B),F&&B){try{X=await navigator.mediaDevices.getUserMedia({audio:!0,video:!0})}catch(k){let L=NP(k.name||k.code||k,k.message);if(L.code===f1.PERMISSION_DENIED)throw L;gc.warning("getUserMedia failed in getDevices",L)}this.isAccessCameraPermission=!0,this.isAccessMicrophonePermission=!0}else if(F){try{j=await navigator.mediaDevices.getUserMedia({audio:L})}catch(k){let L=NP(k.name||k.code||k,k.message);if(L.code===f1.PERMISSION_DENIED)throw L;gc.warning("getUserMedia failed in getDevices",L)}this.isAccessMicrophonePermission=!0}else if(B){try{G=await navigator.mediaDevices.getUserMedia({video:k})}catch(k){let L=NP(k.name||k.code||k,k.message);if(L.code===f1.PERMISSION_DENIED)throw L;gc.warning("getUserMedia failed in getDevices",L)}this.isAccessCameraPermission=!0}gc.debug("[device manager] mic permission",L,"cam permission",k)}try{let L=await navigator.mediaDevices.enumerateDevices();return j&&j.getTracks().forEach(L=>L.stop()),G&&G.getTracks().forEach(L=>L.stop()),X&&X.getTracks().forEach(L=>L.stop()),j=null,G=null,X=null,L}catch(L){return j&&j.getTracks().forEach(L=>L.stop()),G&&G.getTracks().forEach(L=>L.stop()),X&&X.getTracks().forEach(L=>L.stop()),j=null,G=null,X=null,new f2(f1.ENUMERATE_DEVICES_FAILED,L.toString()).throw()}}async getRecordingDevices(){let L=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return(await this.enumerateDevices(!0,!1,L)).filter(L=>"audioinput"===L.kind)}async getCamerasDevices(){let L=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return(await this.enumerateDevices(!1,!0,L)).filter(L=>"videoinput"===L.kind)}async getSpeakers(){let L=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return(await this.enumerateDevices(!0,!1,L)).filter(L=>"audiooutput"===L.kind)}searchDeviceIdByName(L){let k=null;return this.deviceInfoMap.forEach(M=>{M.device.label===L&&(k=M.device.deviceId)}),k}async getDeviceById(L){let k=(await this.enumerateDevices(!0,!0,!0)).find(k=>k.deviceId===L);if(!k)throw new f2(f1.DEVICE_NOT_FOUND,"deviceId: ".concat(L));return k}async init(){this.state=g$.INITING;try{await this.updateDevicesInfo(),this.state=g$.INITEND}catch(L){throw gc.warning("Device Detection functionality cannot start properly.",L.toString()),this.state=g$.IDLE,("boolean"==typeof isSecureContext?isSecureContext:"https:"===location.protocol||"file:"===location.protocol||"localhost"===location.hostname||"127.0.0.1"===location.hostname||"::1"===location.hostname)||new f2(f1.WEB_SECURITY_RESTRICT,"Your context is limited by web security, please try using https protocol or localhost.").throw(),L}}async updateDevicesInfo(){let L=await this.enumerateDevices(!0,!0,!0),k=Date.now(),M=[];if(L[0]&&L[0].label&&!1===this.checkdeviceMatched){this.checkdeviceMatched=!0;let k=L.find(L=>"audioinput"===L.kind&&"default"===L.deviceId),M=L.find(L=>"audiooutput"===L.kind&&"default"===L.deviceId);k&&M?M.groupId===k.groupId?gc.debug("[device-check] default input ".concat(k.label," and output ").concat(M.label," is the same group")):gc.debug("[device-check] default input ".concat(k.label," and output ").concat(M.label," is not the same group")):gc.debug("[device-check] default input or output not found")}let U=this.checkMediaDeviceInfoIsOk(L);if(L.forEach(L=>{if(!L.deviceId)return;let U=this.deviceInfoMap.get("".concat(L.kind,"_").concat(L.deviceId));if("ACTIVE"!==(U?U.state:"INACTIVE")){let U={initAt:k,updateAt:k,device:L,state:"ACTIVE"};this.deviceInfoMap.set("".concat(L.kind,"_").concat(L.deviceId),U),M.push(U)}U&&(U.updateAt=k)}),this.deviceInfoMap.forEach((L,U)=>{"ACTIVE"===L.state&&L.updateAt!==k&&(L.state="INACTIVE",M.push(L))}),this.state!==g$.INITEND)return U.audio&&(this.lastAccessMicrophonePermission=!0,this.isAccessMicrophonePermission=!0),void(U.video&&(this.lastAccessCameraPermission=!0,this.isAccessCameraPermission=!0));M.forEach(L=>{switch(L.device.kind){case"audioinput":this.lastAccessMicrophonePermission&&this.isAccessMicrophonePermission&&this.emit(g0.RECORDING_DEVICE_CHANGED,L);break;case"videoinput":this.lastAccessCameraPermission&&this.isAccessCameraPermission&&this.emit(g0.CAMERA_DEVICE_CHANGED,L);break;case"audiooutput":this.lastAccessMicrophonePermission&&this.isAccessMicrophonePermission&&this.emit(g0.PLAYOUT_DEVICE_CHANGED,L)}}),U.audio&&(this.lastAccessMicrophonePermission=!0,this.isAccessMicrophonePermission=!0),U.video&&(this.lastAccessCameraPermission=!0,this.isAccessCameraPermission=!0)}checkMediaDeviceInfoIsOk(L){let k=L.filter(L=>"audioinput"===L.kind),M=L.filter(L=>"videoinput"===L.kind),U={audio:!1,video:!1};for(let L of k)if(L.label&&L.deviceId){U.audio=!0;break}for(let L of M)if(L.label&&L.deviceId){U.video=!0;break}return U}},Tr=!1,Tn=new class extends Hw{constructor(){super(...arguments),aP(this,"onAutoplayFailed",void 0),aP(this,"onAudioAutoplayFailed",void 0)}};function MP(){if(zA(),!Tr){let e=L=>{L.preventDefault(),Tr=!1,yw()?document.body.removeEventListener("click",e,!0):(document.body.removeEventListener("touchstart",e,!0),document.body.removeEventListener("mousedown",e,!0))};Tr=!0,yw()?document.body.addEventListener("click",e,!0):(document.body.addEventListener("touchstart",e,!0),document.body.addEventListener("mousedown",e,!0)),gc.info("detect media autoplay failed, document: https://docs.agora.io/cn/Voice/autoplay_policy_web_ng?platform=Web"),Tn.onAutoplayFailed?Tn.onAutoplayFailed():Tn.onAudioAutoplayFailed?gc.warning("AgoraRTC.onAudioAutoplayFailed has been deprecated in favor of AgoraRTC.onAutoplayFailed.\n\n  Please refer to the Agora document to migrate the newer API, https://docs.agora.io/en/Voice/autoplay_policy_web_ng?platform=Web ."):gc.warning("We have detected a media autoplay failed event, and found out that you haven't implemented AgoraRTC.onAutoplayFailed callback yet.\n\n  It will cause audio/video element not playing automatically on some browsers without user interaction, possibly hurting user experiences.\n\n  Please refer to the Agora document to properly handle autoplay failed event, https://docs.agora.io/en/Voice/autoplay_policy_web_ng?platform=Web ."),Tn.emit("autoplay-failed")}}function UP(L,k,M,U){if(!L)return;let V=g_.getBaseInfoBySessionId(L);if(!V)return;let F=V.info,B=Date.now(),j=dP(dP({},F),{},{vid:void 0===F.vid?0:Number(F.vid),lts:B,elapse:B-V.startTime,cbRegistered:Tn.onAutoplayFailed||Tn.onAudioAutoplayFailed?1:-1,errorMsg:M,mediaType:k,trackId:U,extend:void 0});g_.send({type:gh.AUTOPLAY_FAILED,data:j},!0)}let Ta=["play","playing","loadeddata","canplay","pause","stalled","suspend","waiting","abort","emptied","ended","error"],To=new class{constructor(){aP(this,"onAutoplayFailed",void 0),aP(this,"elementMap",new Map),aP(this,"elementStateMap",new Map),aP(this,"elementsNeedToResume",[]),aP(this,"sinkIdMap",new Map),aP(this,"autoResumeAfterInterruption",L=>{Array.from(this.elementMap.entries()).forEach(k=>{let[M,U]=k,V=this.elementStateMap.get(M),F=U.srcObject.getAudioTracks()[0],B=F&&F.readyState;if(gc.debug("resume after interrupted, ele: ".concat(V," audio: ").concat(B," ").concat(L)),"live"===B){if(L)return U.pause(),void U.play();if("running"===g8.curState)return Ew()?(U.pause(),void U.play()):void(V&&"paused"===V&&U.play())}})}),aP(this,"autoResumeAfterInterruptionOnIOS15_16",()=>{Array.from(this.elementMap.entries()).forEach(L=>{let[k,M]=L,U=M.srcObject.getAudioTracks()[0];U&&"live"===U.readyState&&(gc.debug("auto resume after interruption inside autoResumeAfterInterruptionOnIOS15"),M.pause(),M.play())})}),this.autoResumeAudioElement(),g8.on(gS.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),g8.on(gS.IOS_15_16_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15_16),g8.on(gS.STATE_CHANGE,()=>{nw()&&"suspended"===g8.prevState&&"running"===g8.curState&&this.autoResumeAfterInterruption()})}async setSinkID(L,k){let M=this.elementMap.get(L);if(this.sinkIdMap.set(L,k),M)try{await M.setSinkId(k)}catch(L){throw new f2(f1.PERMISSION_DENIED,"can not set sink id: "+L.toString())}}play(L,k,M,U){if(this.elementMap.has(k))return;let V=document.createElement("audio");V.autoplay=!0,V.srcObject=new MediaStream([L]),this.bindAudioElementEvents(k,V),this.elementMap.set(k,V),this.elementStateMap.set(k,g1.INIT),this.setVolume(k,M);let F=this.sinkIdMap.get(k);if(F)try{V.setSinkId(F).catch(L=>{gc.warning("[".concat(k,"] set sink id failed"),L.toString())})}catch(L){gc.warning("[".concat(k,"] set sink id failed"),L.toString())}let B=V.play();B&&B.then&&B.catch(L=>{U&&UP(U,"audio",L.message,k),gc.warning("audio element play warning",L.toString()),this.elementMap.has(k)&&"NotAllowedError"===L.name&&(gc.warning("detected audio element autoplay failed"),this.elementsNeedToResume.push(V),hO(()=>{this.onAutoplayFailed&&this.onAutoplayFailed(),MP()}))})}updateTrack(L,k){let M=this.elementMap.get(L);M&&(M.srcObject=new MediaStream([k]))}isPlaying(L){return this.elementMap.has(L)&&"playing"===this.elementStateMap.get(L)}setVolume(L,k){let M=this.elementMap.get(L);M&&(k=Math.max(0,Math.min(100,k)),M.volume=k/100)}stop(L){let k=this.elementMap.get(L);if(this.sinkIdMap.delete(L),!k)return;let M=this.elementsNeedToResume.indexOf(k);this.elementsNeedToResume.splice(M,1),k.srcObject=null,k.remove(),this.elementMap.delete(L),this.elementStateMap.delete(L)}bindAudioElementEvents(L,k){Ta.forEach(M=>{k.addEventListener(M,M=>{let U=this.elementStateMap.get(L),V="pause"===M.type?"paused":M.type;if(gc.debug("[".concat(L,"] audio-element-status change ").concat(U," => ").concat(V)),"error"===M.type){let M=null==k?void 0:k.error;M&&gc.error("[".concat(L,"] media error, code: ").concat(M.code,", message: ").concat(M.message))}this.elementStateMap.set(L,V)})})}getPlayerState(L){return this.elementStateMap.get(L)||"uninit"}autoResumeAudioElement(){let e=()=>{this.elementsNeedToResume.forEach(L=>{L.play().then(L=>{gc.debug("Auto resume audio element success")}).catch(L=>{gc.warning("Auto resume audio element failed!",L)})}),this.elementsNeedToResume=[]};new lQ(L=>{document.body?L():window.addEventListener("load",()=>L())}).then(()=>{yw()?document.body.addEventListener("click",e,!0):(document.body.addEventListener("touchstart",e,!0),document.body.addEventListener("mousedown",e,!0))})}};function FP(){return function(L,k,M){let U=M.value;return"function"==typeof U&&(M.value=function(){this._isClosed&&new f2(f1.INVALID_OPERATION,"[".concat(this.getTrackId(),"] cannot operate a closed track")).print("warning",gc);for(var L=arguments.length,k=Array(L),M=0;M<L;M++)k[M]=arguments[M];let V=U.apply(this,k);return V instanceof lQ?new lQ((L,k)=>{V.then(L).catch(k)}):V}),M}}let BP=class BP extends Hw{constructor(L){super(),aP(this,"name","VideoProcessorDestination"),aP(this,"ID","0"),aP(this,"_source",void 0),aP(this,"videoContext",void 0),aP(this,"inputTrack",void 0),this.videoContext=L}get kind(){return"video"}get enabled(){return!0}pipe(){throw new f2(f1.NOT_SUPPORTED,"VideoProcessor cannot pipe to any other Processor")}unpipe(){throw new f2(f1.NOT_SUPPORTED,"VideoProcessor cannot unpipe to any other Processor")}enable(){}disable(){}updateInput(L){if(L.context!==this.videoContext)throw Error("ProcessorContext passed to VideoTrack.processorDestination doesn't match it's belonging VideoTrack's context.\nProbably you are making pipeline like this:\nvideoTrack1.pipe(processor).pipe(videoTrack2.processorDestination).");L.track&&L.track!==this.inputTrack&&(this.videoContext.chained=!0,this.inputTrack=L.track,this.emit(gQ.ON_TRACK,L.track))}reset(){this.inputTrack=void 0,this.videoContext.chained=!1,this.emit(gQ.ON_TRACK,void 0)}};let jP=class jP extends Hw{set chained(L){this._chained=L}get chained(){return this._chained}constructor(L,k){super(),aP(this,"constraintsMap",new Map),aP(this,"statsRegistry",[]),aP(this,"usageRegistry",[]),aP(this,"trackId",void 0),aP(this,"direction",void 0),aP(this,"_chained",!1),this.trackId=L,this.direction=k}async getConstraints(){return await oO(this,gZ.REQUEST_CONSTRAINTS)}async requestApplyConstraints(L,k){var M;return gc.info("processor ".concat(k.name," requestApplyConstraints for ").concat(this.trackId)),L&&this.constraintsMap.set(k,L),sO(this,gZ.REQUEST_UPDATE_CONSTRAINTS,Array.from(l1(M=this.constraintsMap).call(M)))}async requestRevertConstraints(L){var k;if(this.constraintsMap.has(L))return gc.info("processor ".concat(L.name," requestRevertConstraints for ").concat(this.trackId)),this.constraintsMap.delete(L),sO(this,gZ.REQUEST_UPDATE_CONSTRAINTS,Array.from(l1(k=this.constraintsMap).call(k)))}registerStats(L,k,M){this.statsRegistry.find(M=>M.processorID===L.ID&&M.processorName===L.name&&M.type===k)||this.statsRegistry.push({processorName:L.name,processorID:L.ID,type:k,cb:M})}unregisterStats(L,k){let M=this.statsRegistry.findIndex(M=>M.processorID===L.ID&&M.processorName===L.name&&M.type===k);-1!==M&&this.statsRegistry.splice(M,1)}gatherStats(){let L=[];for(let{processorID:k,processorName:M,type:U,cb:V}of this.statsRegistry)try{let F=V();L.push({processorID:k,processorName:M,type:U,stats:F})}catch(L){gc.error(new f2(f1.UNEXPECTED_ERROR,L.message))}return L}registerUsage(L,k){this.usageRegistry.find(k=>k.processorID===L.ID&&k.processorName===L.name)||this.usageRegistry.push({processorID:L.ID,processorName:L.name,cb:k})}unregisterUsage(L){let k=this.usageRegistry.findIndex(k=>k.processorID===L.ID&&k.processorName===L.name);-1!==k&&this.usageRegistry.splice(k,1)}async gatherUsage(){let L=[];if(!this.chained)return[];for(let{cb:k}of this.usageRegistry)try{let M=k();M instanceof lQ&&(M=await M),L.push(dP(dP({},M),{},{direction:this.direction}))}catch(L){gc.error("gather extension usage error",L)}return L}getDirection(){return this.direction}};let GP=class GP extends Hw{constructor(L){super(),aP(this,"name","AudioProcessorDestination"),aP(this,"ID","0"),aP(this,"inputTrack",void 0),aP(this,"inputNode",void 0),aP(this,"audioProcessorContext",void 0),aP(this,"_source",void 0),this.audioProcessorContext=L}get kind(){return"audio"}get enabled(){return!0}pipe(){throw new f2(f1.NOT_SUPPORTED,"AudioProcessorDestination cannot pipe to any other Processor")}unpipe(){throw new f2(f1.NOT_SUPPORTED,"AudioProcessor cannot unpipe to any other Processor")}enable(){}disable(){}reset(){this.inputTrack=void 0,this.inputNode=void 0,this.audioProcessorContext.chained=!1,this.emit(gQ.ON_TRACK,void 0),this.emit(gQ.ON_NODE,void 0)}updateInput(L){if(L.context!==this.audioProcessorContext)throw Error("ProcessorContext passed to AudioTrack.processorDestination doesn't match it's belonging AudioTrack's context.\n        Probably you are making pipeline like this: audioTrack1.pipe(processor).pipe(audioTrack2.processorDestination).");L.track&&this.inputTrack!==L.track&&(this.audioProcessorContext.chained=!0,this.inputTrack=L.track,this.emit(gQ.ON_TRACK,this.inputTrack)),L.node&&this.inputNode!==L.node&&(this.audioProcessorContext.chained=!0,this.inputNode=L.node,this.emit(gQ.ON_NODE,this.inputNode))}};let WP=class WP extends Hw{set chained(L){this._chained=L}get chained(){return this._chained}constructor(L,k,M){super(),aP(this,"constraintsMap",new Map),aP(this,"statsRegistry",[]),aP(this,"audioContext",void 0),aP(this,"trackId",void 0),aP(this,"direction",void 0),aP(this,"usageRegistry",[]),aP(this,"_chained",!1),this.audioContext=L,this.trackId=k,this.direction=M}async getConstraints(){return oO(this,gZ.REQUEST_CONSTRAINTS)}getAudioContext(){return this.audioContext}async requestApplyConstraints(L,k){var M;return gc.info("processor ".concat(k.name," requestApplyConstraints for ").concat(this.trackId)),L&&this.constraintsMap.set(k,L),sO(this,gZ.REQUEST_UPDATE_CONSTRAINTS,Array.from(l1(M=this.constraintsMap).call(M)))}async requestRevertConstraints(L){var k;if(this.constraintsMap.has(L))return this.constraintsMap.delete(L),sO(this,gZ.REQUEST_UPDATE_CONSTRAINTS,Array.from(l1(k=this.constraintsMap).call(k)))}registerStats(L,k,M){this.statsRegistry.find(M=>M.processorID===L.ID&&M.processorName===L.name&&M.type===k)||this.statsRegistry.push({processorName:L.name,processorID:L.ID,type:k,cb:M})}unregisterStats(L,k){let M=this.statsRegistry.findIndex(M=>M.processorID===L.ID&&M.processorName===L.name&&M.type===k);-1!==M&&this.statsRegistry.splice(M,1)}gatherStats(){let L=[];for(let{processorID:k,processorName:M,type:U,cb:V}of this.statsRegistry)try{let F=V();L.push({processorID:k,processorName:M,type:U,stats:F})}catch(L){gc.error(new f2(f1.UNEXPECTED_ERROR,L.message))}return L}registerUsage(L,k){this.usageRegistry.find(k=>k.processorID===L.ID&&k.processorName===L.name)||this.usageRegistry.push({processorID:L.ID,processorName:L.name,cb:k})}unregisterUsage(L){let k=this.usageRegistry.findIndex(k=>k.processorID===L.ID&&k.processorName===L.name);-1!==k&&this.usageRegistry.splice(k,1)}async gatherUsage(){let L=[];if(!this.chained)return[];for(let{cb:k}of this.usageRegistry)try{let M=k();M instanceof lQ&&(M=await M),L.push(dP(dP({},M),{},{direction:this.direction}))}catch(L){gc.error("gather extension usage error",L)}return L}getDirection(){return this.direction}};let HP=class HP extends Hw{get isPlayed(){return!0}get isFreeze(){return!1}constructor(){super(),aP(this,"context",void 0),aP(this,"processSourceNode",void 0),aP(this,"outputTrack",void 0),aP(this,"processedNode",void 0),aP(this,"clonedTrack",void 0),aP(this,"outputNode",void 0),this.outputNode=new KP}setVolume(){}createOutputTrack(){throw new f2(f1.NOT_SUPPORTED,"can not create output MediaStreamTrack when WebAudio disabled")}getOriginVolumeLevel(){return 0}getAccurateVolumeLevel(){return 0}stopGetAudioBuffer(){}startGetAudioBuffer(){}play(){}stop(){}destroy(){}updateTrack(){}updateOriginTrack(){}createMediaStreamSourceNode(){}};let KP=class KP{disconnect(){}connect(){}};function YP(L){return new lQ((k,M)=>{let U=!1,V=document.createElement("video");V.setAttribute("autoplay",""),V.setAttribute("muted",""),V.muted=!0,V.autoplay=!0,V.setAttribute("playsinline",""),V.setAttribute("style","position: fixed; top: 0; left: 0; width: 1px; height: 1px"),document.body.appendChild(V);let F=nw()?"canplay":"playing";V.addEventListener(F,()=>{let L=V.videoWidth,M=V.videoHeight;!L&&iw()||(U=!0,V.srcObject=null,V.remove(),k([L,M]))}),V.srcObject=new MediaStream([L]),V.play().catch(AO),setTimeout(()=>{U||(V.srcObject=null,V.remove(),k([V.videoWidth,V.videoHeight]))},4e3)})}function zP(L){let k={};L.facingMode&&(k.facingMode=L.facingMode),L.cameraId&&(k.deviceId={exact:L.cameraId});let M=ND(L.encoderConfig);return null!=M.width&&(k.width=M.width),null!=M.height&&(k.height=M.height),!Tw()&&M.frameRate&&(k.frameRate=M.frameRate),tw()&&"object"==typeof k.frameRate&&(k.frameRate.max=60),iw()&&(k.frameRate={ideal:30,max:30}),k}function qP(L){let k={};return Tw()||(void 0!==L.AGC&&(k.autoGainControl=L.AGC),void 0!==L.AEC&&(k.echoCancellation=L.AEC),void 0!==L.ANS&&(k.noiseSuppression=L.ANS,QA()&&L.ANS&&(k.googHighpassFilter=L.ANS))),k}function XP(L){let k=qP(L);if(L.encoderConfig){let M=kD(L.encoderConfig);k.channelCount=M.stereo?2:1,k.sampleRate=M.sampleRate,k.sampleSize=M.sampleSize}return L.microphoneId&&(k.deviceId={exact:L.microphoneId}),Cw()&&(k.sampleRate=void 0),k}let JP=L=>{let k=L._encoderConfig;if(!k)return;let{frameRate:M,width:U,height:V}=L.getMediaStreamTrackSettings(),{frameRate:F=M,width:B=U,height:j=V}=k;if(!F||!B||!j)return;B=LO(B),j=LO(j),F=LO(F);let{max:G,min:X}=function(L,k,M){let U=200*Math.pow(M/15,.6)*Math.pow(L*k/640/360,.75);return{min:Math.floor(U),max:Math.floor(4*U)}}(B,j,F),{bitrateMax:$,bitrateMin:ee}=k||{};$||gc.debug("calculate bitrate: [w: ".concat(B,", h: ").concat(j,", fps: ").concat(F,"] => [brMax: ").concat($,", brMin: ").concat(ee,"]"));let{maxFramerate:et}=wN("ENCODER_CONFIG_LIMIT");return et&&"number"==typeof et&&(F=Math.min(F,et)),{frameRate:F,bitrateMax:$||G,bitrateMin:ee||X,scaleResolutionDownBy:1,scale:0}},ZP=async(L,k,M)=>await (async(L,k,M)=>{let U=(function(L){let k=[];for(let M=0;M<L.length;M+=2)k.push(parseInt(L.slice(M,M+2),16));return Uint8Array.from(k)})(MO(""+k+M)).slice(0,16),V=U.slice(0,12),F=await window.crypto.subtle.importKey("raw",U,"AES-GCM",!0,["encrypt"]);return new Uint8Array(await window.crypto.subtle.encrypt({name:"AES-GCM",iv:V},F,L))})(L.buffer,k,M),QP=L=>{let k=document.createElement("canvas");return k.width=2,k.height=2,new lQ((M,U)=>{k.toBlob(async L=>{if(k.remove(),L){let U=await $P(L);M({buffer:U,width:k.width,height:k.height})}else U(new f2(f1.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED))},L,1)})},$P=async L=>{let k=await L.arrayBuffer();return new Uint8Array(k)},Ts=(ih=pD({argsMap:(L,k)=>[L.getTrackId(),k],throttleTime:300}),ip=pD({argsMap:(L,k)=>[L.getTrackId(),k]}),i_=FP(),iE=FO("LocalAudioTrack","_enabledMutex"),im=pD({argsMap:(L,k)=>[L.getTrackId(),k]}),iT=FP(),iR=FO("LocalAudioTrack","_enabledMutex"),iI=pD({argsMap:(L,k)=>[L.getTrackId(),k]}),iv=FP(),iC=FP(),iy=FP(),iA=pD({argsMap:L=>[L.getTrackId()]}),ib=FP(),iO=pD({argsMap:L=>[L.getTrackId()]}),iN=FP(),iP=pD({argsMap:L=>[L.getTrackId()]}),iL=pD({argsMap:(L,k)=>[L.getTrackId(),k.name]}),ik=pD({argsMap:L=>[L.getTrackId()]}),sP((iU=class extends uP{get _source(){return this.initWebAudio()}set _source(L){this._trackSource=L}get processorContext(){return this._processorContext||(this._processorContext=this.initProcessor().processorContext),this._processorContext}get processorDestination(){return this._processorDestination||(this._processorDestination=this.initProcessor().processorDestination),this._processorDestination}get isPlaying(){return this._useAudioElement?To.isPlaying(this.getTrackId()):this._source.isPlayed}get __className__(){return"LocalAudioTrack"}constructor(L,k,M,U){super(L,M),aP(this,"trackMediaType",gW.AUDIO),aP(this,"_encoderConfig",void 0),aP(this,"_trackSource",void 0),aP(this,"metadata",[]),aP(this,"_enabled",!0),aP(this,"_volume",100),aP(this,"_useAudioElement",!0),aP(this,"_bypassWebAudio",!1),aP(this,"processor",void 0),aP(this,"_processorContext",void 0),aP(this,"_processorDestination",void 0),aP(this,"_getOriginVolumeLevel",void 0),this._encoderConfig=k,this._getOriginVolumeLevel=!!U,this._trackSource=new HP,wN("DISABLE_WEBAUDIO")&&(this._bypassWebAudio=!0),wN("LOCAL_AUDIO_TRACK_USES_WEB_AUDIO")&&(this._useAudioElement=!1),$A()&&!g6?setTimeout(()=>this.initWebAudio()):this.initWebAudio()}setVolume(L){Pw(L,"volume",0,1e3),this._volume=L,this._source.setVolume(L/100),this._useAudioElement&&To.setVolume(this.getTrackId(),L);try{if(this._bypassWebAudio)return void gc.debug("[".concat(this.getTrackId(),"] setVolume returned because no pass through WebAudio."));let L=this._source.createOutputTrack();this._mediaStreamTrack!==L&&(this._mediaStreamTrack=L,sO(this,gN.NEED_REPLACE_TRACK,this).then(()=>{gc.debug("[".concat(this.getTrackId(),"] replace web audio track success"))}).catch(L=>{gc.warning("[".concat(this.getTrackId(),"] replace web audio track failed"),L)}))}catch(L){}}getVolumeLevel(){return this._muted&&this.enabled&&this._getOriginVolumeLevel?this._source.getOriginVolumeLevel():this._source.getAccurateVolumeLevel()}async setPlaybackDevice(L){if(!this._useAudioElement||!SD())throw new f2(f1.NOT_SUPPORTED,"your browser does not support setting the audio output device");await To.setSinkID(this.getTrackId(),L)}async setEnabled(L,k,M){return this._setEnabled(L,k,M)}async _setEnabled(L,k,M){if(!M){if(L===this._enabled)return;this.stateCheck("enabled",L)}if(gc.info("[".concat(this.getTrackId(),"] start setEnabled"),L),L){this._originMediaStreamTrack.enabled=!0;try{M||(this._enabled=!0),await sO(this,gN.NEED_ENABLE_TRACK,this),gc.info("[".concat(this.getTrackId(),"] setEnabled to ").concat(L," success"))}catch(L){throw M||(this._enabled=!1),gc.error("[".concat(this.getTrackId(),"] setEnabled to true error"),L.toString()),L}}else{this._originMediaStreamTrack.enabled=!1,M||(this._enabled=!1);try{await sO(this,gN.NEED_DISABLE_TRACK,this)}catch(L){throw M||(this._enabled=!0),gc.error("[".concat(this.getTrackId(),"] setEnabled to false error"),L.toString()),L}}}async setMuted(L){L!==this._muted&&(this.stateCheck("muted",L),this._muted=L,this._originMediaStreamTrack.enabled=!L,gc.debug("[".concat(this.getTrackId(),"] start set muted: ").concat(L)),L?await sO(this,gN.NEED_MUTE_TRACK,this):await sO(this,gN.NEED_UNMUTE_TRACK,this))}getStats(){return mO(()=>{gc.warning("[deprecated] LocalAudioTrack.getStats will be removed in the future, use AgoraRTCClient.getLocalAudioStats instead")},"localAudioTrackGetStatsWarning"),aO(this,gN.GET_STATS)||dP({},gH)}setAudioFrameCallback(L){let k=arguments.length>1&&void 0!==arguments[1]?arguments[1]:4096;if(!L)return this._source.removeAllListeners(gG.ON_AUDIO_BUFFER),void this._source.stopGetAudioBuffer();this._source.startGetAudioBuffer(k),this._source.removeAllListeners(gG.ON_AUDIO_BUFFER),this._source.on(gG.ON_AUDIO_BUFFER,k=>L(k))}play(){gc.debug("[".concat(this.getTrackId(),"] start audio playback")),this._useAudioElement?(gc.debug("[".concat(this.getTrackId(),"] start audio playback in element")),To.play(this._mediaStreamTrack,this.getTrackId(),this._volume)):this._source.play()}stop(){gc.debug("[".concat(this.getTrackId(),"] stop audio playback")),this._useAudioElement?To.stop(this.getTrackId()):this._source.stop()}close(){super.close(),this._processorDestination&&this.unbindProcessorDestinationEvents(this._processorDestination),this._processorContext&&this.unbindProcessorContextEvents(this._processorContext),this.unpipe(),this._processorDestination&&this._processorDestination._source&&this._processorDestination._source.unpipe(),this._source.destroy()}_updatePlayerSource(){let L=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];gc.debug("[".concat(this.getTrackId(),"] update player source track")),L&&this._source.updateTrack(this._mediaStreamTrack),this._useAudioElement&&To.updateTrack(this.getTrackId(),this._mediaStreamTrack)}async _updateOriginMediaStreamTrack(L,k){this._originMediaStreamTrack!==L&&(this._originMediaStreamTrack&&(this._originMediaStreamTrack.removeEventListener("ended",this._handleTrackEnded),k&&this._originMediaStreamTrack.stop()),L.addEventListener("ended",this._handleTrackEnded),this._originMediaStreamTrack=L,this._muted&&(this._originMediaStreamTrack.enabled=!1),this.processor&&this._processorContext&&this.processor.updateInput({track:L,context:this._processorContext}),this._mediaStreamTrack!==this._source.outputTrack?(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await sO(this,gN.NEED_REPLACE_TRACK,this)):this._source.updateTrack(this._originMediaStreamTrack),this._getOriginVolumeLevel&&this._source.updateOriginTrack(L))}renewMediaStreamTrack(L){return lQ.resolve(void 0)}pipe(L){if(this._bypassWebAudio)throw new f2(f1.INVALID_OPERATION,"Can not process AudioTrack when bypassWebAudio set to true.");if(this.processor===L)return L;if(L._source)throw new f2(f1.INVALID_OPERATION,"Processor ".concat(L.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=L,this.processor._source=this,L.updateInput({track:this._originMediaStreamTrack,node:this._source.processSourceNode,context:this.processorContext}),L}unpipe(){var L;if(!this.processor)return;let k=this.processor;null===(L=this._source.processSourceNode)||void 0===L||L.disconnect(),this.processor._source=!1,this.processor=void 0,k.reset()}bindProcessorDestinationEvents(L){L.on(gQ.ON_TRACK,async L=>{L?L!==this._mediaStreamTrack&&(this._mediaStreamTrack=L,this._updatePlayerSource(!1),this._source.processedNode=this._source.createMediaStreamSourceNode(L),await sO(this,gN.NEED_REPLACE_TRACK,this)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await sO(this,gN.NEED_REPLACE_TRACK,this))}),L.on(gQ.ON_NODE,L=>{this._source.processedNode=L})}unbindProcessorDestinationEvents(L){L.removeAllListeners(gQ.ON_TRACK),L.removeAllListeners(gQ.ON_NODE)}bindProcessorContextEvents(L){L.on(gZ.REQUEST_CONSTRAINTS,async L=>{L(this._originMediaStreamTrack.getSettings())})}unbindProcessorContextEvents(L){L.removeAllListeners(gZ.REQUEST_CONSTRAINTS)}initWebAudio(){return this._trackSource instanceof HP&&(this._trackSource=new RP(this._mediaStreamTrack,!1,this._getOriginVolumeLevel?this._mediaStreamTrack:void 0)),this._trackSource}initProcessor(){let L=new WP(this._source.context,this.getTrackId(),"local"),k=new GP(L);return this._processorContext=L,this._processorDestination=k,this.bindProcessorContextEvents(L),this.bindProcessorDestinationEvents(k),this._source.on(gG.UPDATE_SOURCE,()=>{this.processor&&this.processor.updateInput({node:this._source.processSourceNode,context:L})}),this._useAudioElement&&(this._useAudioElement=!1,this.isPlaying&&(To.stop(this.getTrackId()),this._source.play()),sO(this,gN.NEED_REPLACE_MIXING_TRACK,this).then(()=>{gc.debug("[".concat(this.getTrackId(),"] replace from origin track to web audio track success"))}).catch(L=>{gc.warning("[".concat(this.getTrackId(),"] replace from origin track to web audio track failed"),L)})),{processorContext:L,processorDestination:k}}}).prototype,"setVolume",[ih],Object.getOwnPropertyDescriptor(iU.prototype,"setVolume"),iU.prototype),sP(iU.prototype,"setPlaybackDevice",[ip,i_],Object.getOwnPropertyDescriptor(iU.prototype,"setPlaybackDevice"),iU.prototype),sP(iU.prototype,"setEnabled",[iE,im,iT],Object.getOwnPropertyDescriptor(iU.prototype,"setEnabled"),iU.prototype),sP(iU.prototype,"setMuted",[iR,iI,iv],Object.getOwnPropertyDescriptor(iU.prototype,"setMuted"),iU.prototype),sP(iU.prototype,"getStats",[iC],Object.getOwnPropertyDescriptor(iU.prototype,"getStats"),iU.prototype),sP(iU.prototype,"setAudioFrameCallback",[iy],Object.getOwnPropertyDescriptor(iU.prototype,"setAudioFrameCallback"),iU.prototype),sP(iU.prototype,"play",[iA,ib],Object.getOwnPropertyDescriptor(iU.prototype,"play"),iU.prototype),sP(iU.prototype,"stop",[iO,iN],Object.getOwnPropertyDescriptor(iU.prototype,"stop"),iU.prototype),sP(iU.prototype,"close",[iP],Object.getOwnPropertyDescriptor(iU.prototype,"close"),iU.prototype),sP(iU.prototype,"pipe",[iL],Object.getOwnPropertyDescriptor(iU.prototype,"pipe"),iU.prototype),sP(iU.prototype,"unpipe",[ik],Object.getOwnPropertyDescriptor(iU.prototype,"unpipe"),iU.prototype),iU),Tc=(iV=pD({argsMap:(L,k)=>[L.getTrackId(),k]}),iB=FP(),iW=FO("MicrophoneAudioTrack","_enabledMutex"),iG=pD({argsMap:(L,k,M)=>[L.getTrackId(),k,M]}),iY=FP(),iJ=pD({argsMap:L=>[L.getTrackId()]}),sP((iX=class extends Ts{get __className__(){return"MicrophoneAudioTrack"}constructor(L,k,M,U){super(L,k.encoderConfig?kD(k.encoderConfig):{},U,wN("GET_VOLUME_OF_MUTED_AUDIO_TRACK")),aP(this,"_config",void 0),aP(this,"_deviceName","default"),aP(this,"_constraints",void 0),aP(this,"_originalConstraints",void 0),aP(this,"_enabled",!0),this._config=k,this._constraints=M,this._originalConstraints=M,this._deviceName=L.label,"boolean"==typeof k.bypassWebAudio&&(this._bypassWebAudio=k.bypassWebAudio),(Ew()||mw())&&g8.bindInterruptDetectorTrack(this)}async setDevice(L){if(gc.info("[".concat(this.getTrackId(),"] start set device to ").concat(L)),this._enabled)try{let k=await Ti.getDeviceById(L),M={};M.audio=dP({},this._constraints),M.audio.deviceId={exact:L},this._originMediaStreamTrack.stop();let U=null;try{U=await wP(M,this.getTrackId())}catch(L){throw gc.error("[".concat(this.getTrackId(),"] setDevice failed"),L.toString()),U=await wP({audio:this._constraints},this.getTrackId()),await this._updateOriginMediaStreamTrack(U.getAudioTracks()[0],!1),L}await this._updateOriginMediaStreamTrack(U.getAudioTracks()[0],!1),this._deviceName=k.label,this._config.microphoneId=L,this._constraints.deviceId={exact:L}}catch(L){throw gc.error("[".concat(this.getTrackId(),"] setDevice error"),L.toString()),L}else try{let k=await Ti.getDeviceById(L);this._deviceName=k.label,this._config.microphoneId=L,this._constraints.deviceId={exact:L}}catch(L){throw gc.error("[".concat(this.getTrackId(),"] setDevice error"),L.toString()),L}gc.info("[".concat(this.getTrackId(),"] set device to ").concat(L," success"))}async setEnabled(L,k,M){if(k)return gc.debug("[".concat(this.getTrackId(),"] setEnabled false (do not close microphone)")),await super._setEnabled(L);if(!M){if(L===this._enabled)return;this.stateCheck("enabled",L)}if(gc.info("[".concat(this.getTrackId(),"] start setEnabled"),L),wN("AUTO_RESET_AUDIO_ROUTE")&&(nw()||Sw())){let k=navigator.audioSession;k&&(L||(k.type="playback"),k.type="auto")}if(!L){var U;this._originMediaStreamTrack.onended=null,this._originMediaStreamTrack.stop(),null===(U=this._source.clonedTrack)||void 0===U||U.stop(),M||(this._enabled=!1);try{await sO(this,gN.NEED_DISABLE_TRACK,this)}catch(L){throw gc.error("[".concat(this.getTrackId(),"] setEnabled false failed"),L.toString()),L}return}let V=dP({},this._constraints),F=Ti.searchDeviceIdByName(this._deviceName);F&&!V.deviceId&&(V.deviceId=F);try{M||(this._enabled=!0);let L=await wP({audio:this._constraints},this.getTrackId());await this._updateOriginMediaStreamTrack(L.getAudioTracks()[0],!1),await sO(this,gN.NEED_ENABLE_TRACK,this)}catch(L){throw M||(this._enabled=!1),gc.error("[".concat(this.getTrackId(),"] setEnabled true failed"),L.toString()),L}gc.info("[".concat(this.getTrackId(),"] setEnabled success"))}close(){super.close(),(Ew()||mw())&&g8.unbindInterruptDetectorTrack(this)}onTrackEnded(){if((nw()||Sw())&&this._enabled&&!this._isClosed&&g8.duringInterruption){let e=async()=>{g8.off(gS.IOS_INTERRUPTION_END,e),this._enabled&&!this._isClosed&&(gc.debug("[".concat(this.getTrackId(),"] try capture microphone media device for interrupted iOS device.")),await this.setEnabled(!1),await this.setEnabled(!0))};g8.on(gS.IOS_INTERRUPTION_END,e)}else gc.debug("[".concat(this.getTrackId(),"] track ended")),this.safeEmit(gB.TRACK_ENDED)}async renewMediaStreamTrack(L){let k=L||this._constraints,M=Ti.searchDeviceIdByName(this._deviceName);if(M&&!k.deviceId&&(k.deviceId=M),this._constraints=k,this._enabled){this._originMediaStreamTrack.stop();let L=await wP({audio:this._constraints},this.getTrackId());await this._updateOriginMediaStreamTrack(L.getAudioTracks()[0],!0)}}bindProcessorContextEvents(L){super.bindProcessorContextEvents(L),L.on(gZ.REQUEST_UPDATE_CONSTRAINTS,async(L,k,M)=>{try{let M=Object.assign({},this._originalConstraints,...L);await this.renewMediaStreamTrack(M),k()}catch(L){M(L)}})}unbindProcessorContextEvents(L){super.unbindProcessorContextEvents(L),L.removeAllListeners(gZ.REQUEST_UPDATE_CONSTRAINTS)}}).prototype,"setDevice",[iV,iB],Object.getOwnPropertyDescriptor(iX.prototype,"setDevice"),iX.prototype),sP(iX.prototype,"setEnabled",[iW,iG,iY],Object.getOwnPropertyDescriptor(iX.prototype,"setEnabled"),iX.prototype),sP(iX.prototype,"close",[iJ],Object.getOwnPropertyDescriptor(iX.prototype,"close"),iX.prototype),iX),Td=(iQ=pD({argsMap:(L,k)=>[L.getTrackId(),k,L.duration]}),iZ=FP(),i$=pD({argsMap:L=>[L.getTrackId()]}),i0=FP(),i1=pD({argsMap:L=>[L.getTrackId()]}),i2=FP(),i3=pD({argsMap:L=>[L.getTrackId()]}),i5=FP(),i4=pD({argsMap:L=>[L.getTrackId()]}),i6=FP(),i8=pD({argsMap:L=>[L.getTrackId()]}),i9=pD({argsMap:L=>[L.getTrackId()]}),i7=FP(),sP((ri=class extends Ts{get __className__(){return"BufferSourceAudioTrack"}constructor(L,k,M,U){super(k.createOutputTrack(),M,U),aP(this,"source",void 0),aP(this,"_bufferSource",void 0),this._useAudioElement=!1,this.source=L,this._bufferSource=k,this._bufferSource.on(gG.AUDIO_SOURCE_STATE_CHANGE,L=>{this.safeEmit(gB.SOURCE_STATE_CHANGE,L)});try{this._mediaStreamTrack=this._source.createOutputTrack()}catch(L){}}get currentState(){return this._bufferSource.currentState}get duration(){return this._bufferSource.duration}get playbackSpeed(){return this._bufferSource.playbackSpeed}getCurrentTime(){return this._bufferSource.currentTime}startProcessAudioBuffer(L){L&&this._bufferSource.updateOptions(L),this._bufferSource.startProcessAudioBuffer()}pauseProcessAudioBuffer(){this._bufferSource.pauseProcessAudioBuffer()}seekAudioBuffer(L){this._bufferSource.seekAudioBuffer(L)}resumeProcessAudioBuffer(){this._bufferSource.resumeProcessAudioBuffer()}stopProcessAudioBuffer(){this._bufferSource.stopProcessAudioBuffer()}close(){this.source=null,this._bufferSource.destroy(),super.close()}setAudioBufferPlaybackSpeed(L){Pw(L,"speed",0),this._bufferSource.setAudioBufferPlaybackSpeed(L)}}).prototype,"startProcessAudioBuffer",[iQ,iZ],Object.getOwnPropertyDescriptor(ri.prototype,"startProcessAudioBuffer"),ri.prototype),sP(ri.prototype,"pauseProcessAudioBuffer",[i$,i0],Object.getOwnPropertyDescriptor(ri.prototype,"pauseProcessAudioBuffer"),ri.prototype),sP(ri.prototype,"seekAudioBuffer",[i1,i2],Object.getOwnPropertyDescriptor(ri.prototype,"seekAudioBuffer"),ri.prototype),sP(ri.prototype,"resumeProcessAudioBuffer",[i3,i5],Object.getOwnPropertyDescriptor(ri.prototype,"resumeProcessAudioBuffer"),ri.prototype),sP(ri.prototype,"stopProcessAudioBuffer",[i4,i6],Object.getOwnPropertyDescriptor(ri.prototype,"stopProcessAudioBuffer"),ri.prototype),sP(ri.prototype,"close",[i8],Object.getOwnPropertyDescriptor(ri.prototype,"close"),ri.prototype),sP(ri.prototype,"setAudioBufferPlaybackSpeed",[i9,i7],Object.getOwnPropertyDescriptor(ri.prototype,"setAudioBufferPlaybackSpeed"),ri.prototype),ri);let WL=class WL extends Ts{get __className__(){return"MixingAudioTrack"}get isActive(){for(let L of this.trackList)if(L._enabled&&!L._isClosed&&!L.muted)return!0;return!1}constructor(){let L=EP().createMediaStreamDestination();super(L.stream.getAudioTracks()[0],void 0,IO(8,"track-mix-")),aP(this,"trackList",void 0),aP(this,"destNode",void 0),this._useAudioElement=!1;try{this._mediaStreamTrack=this._source.createOutputTrack()}catch(L){}this.destNode=L,this.trackList=[]}hasAudioTrack(L){return -1!==this.trackList.indexOf(L)}addAudioTrack(L){-1===this.trackList.indexOf(L)?(gc.debug("add ".concat(L.getTrackId()," to mixing track")),L._source.outputNode.connect(this.destNode),this.trackList.push(L),this.updateEncoderConfig()):gc.debug("track ".concat(L.getTrackId()," is already added"))}removeAudioTrack(L){if(-1!==this.trackList.indexOf(L)){gc.debug("remove ".concat(L.getTrackId()," from mixing track"));try{L._source.outputNode.disconnect(this.destNode)}catch(L){}lO(this.trackList,L),this.updateEncoderConfig()}}updateEncoderConfig(){let L={};this.trackList.forEach(k=>{k._encoderConfig&&((k._encoderConfig.bitrate||0)>(L.bitrate||0)&&(L.bitrate=k._encoderConfig.bitrate),(k._encoderConfig.sampleRate||0)>(L.sampleRate||0)&&(L.sampleRate=k._encoderConfig.sampleRate),(k._encoderConfig.sampleSize||0)>(L.sampleSize||0)&&(L.sampleSize=k._encoderConfig.sampleSize),k._encoderConfig.stereo&&(L.stereo=!0))}),this._encoderConfig=L}_updateRtpTransceiver(L){this._rtpTransceiver!==L&&(this._rtpTransceiver=L,this.trackList.forEach(k=>{k instanceof WL?k.emit(gF.TRANSCEIVER_UPDATED,L):k._updateRtpTransceiver(L)}))}};let HL=class HL extends TP{set currentState(L){L!==this._currentState&&(this._currentState=L,this.safeEmit(gG.AUDIO_SOURCE_STATE_CHANGE,this._currentState))}get currentState(){return this._currentState}constructor(L){let k=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};super(),aP(this,"audioBuffer",void 0),aP(this,"sourceNode",void 0),aP(this,"startPlayTime",0),aP(this,"startPlayOffset",0),aP(this,"pausePlayTime",0),aP(this,"options",void 0),aP(this,"currentLoopCount",0),aP(this,"currentPlaybackSpeed",100),aP(this,"_currentState","stopped"),this.audioBuffer=L,this.options=k,this.startPlayOffset=this.options.startPlayTime||0}createWebAudioDiagram(){return this.context.createGain()}get duration(){return this.audioBuffer?this.audioBuffer.duration:0}get playbackSpeed(){return this.currentPlaybackSpeed}get currentTime(){return this.audioBuffer?"stopped"===this.currentState?0:"paused"===this.currentState?this.pausePlayTime:((this.context.currentTime-this.startPlayTime)*(this.playbackSpeed/100)+this.startPlayOffset)%this.audioBuffer.duration:0}updateOptions(L){"stopped"===this.currentState?(this.options=L,this.startPlayOffset=this.options.startPlayTime||0):gc.warning("can not set audio source options")}startProcessAudioBuffer(){this.sourceNode&&this.stopProcessAudioBuffer(),this.sourceNode=this.createSourceNode(),this.startSourceNode(),this.currentState="playing"}pauseProcessAudioBuffer(){this.sourceNode&&"playing"===this.currentState&&(this.pausePlayTime=this.currentTime,this.sourceNode.onended=null,this.sourceNode.stop(),this.sourceNode.buffer=null,this.sourceNode=this.createSourceNode(),this.currentState="paused")}seekAudioBuffer(L){this.sourceNode&&(this.sourceNode.onended=null,"playing"===this.currentState&&this.sourceNode.stop(),this.sourceNode=this.createSourceNode(),"playing"===this.currentState?(this.startPlayOffset=L,this.startSourceNode()):"paused"===this.currentState&&(this.pausePlayTime=L))}resumeProcessAudioBuffer(){"paused"===this.currentState&&this.sourceNode&&(this.startPlayOffset=this.pausePlayTime,this.pausePlayTime=0,this.startSourceNode(),this.currentState="playing")}stopProcessAudioBuffer(){if(this.sourceNode){this.sourceNode.onended=null;try{this.sourceNode.stop()}catch(L){}this.reset()}}destroy(){this.audioBuffer=null,super.destroy()}setAudioBufferPlaybackSpeed(L){this.sourceNode&&("playing"===this.currentState&&(this.startPlayOffset=this.currentTime,this.startPlayTime=this.context.currentTime),this.sourceNode.playbackRate.value=L/100),this.currentPlaybackSpeed=L}startSourceNode(){this.sourceNode&&this.sourceNode.buffer&&(this.sourceNode.start(0,this.startPlayOffset),this.startPlayTime=this.context.currentTime,this.sourceNode.onended=this.handleSourceNodeEnded.bind(this))}createSourceNode(){let L=this.context.createBufferSource();return L.buffer=this.audioBuffer,L.loop=!!this.options.loop,L.connect(this.outputNode),L.playbackRate.value=this.currentPlaybackSpeed/100,L}handleSourceNodeEnded(){if(this.currentLoopCount+=1,this.options.cycle&&this.options.cycle>this.currentLoopCount)return this.startPlayOffset=0,this.sourceNode=void 0,void this.startProcessAudioBuffer();this.reset()}reset(){this.startPlayOffset=this.options.startPlayTime||0,this.currentState="stopped",this.sourceNode&&(this.sourceNode.disconnect(),this.sourceNode=void 0),this.currentLoopCount=0}};let Tl=new Map;function YL(L,k){if(0===L.length||0===k.length)return 1/0;let M=kO(L),U=kO(k);return Math.floor(U/M)}let zL=class zL{get rendFrameRate(){let L=Math.max(1,YL(this._render_interframe_delays_sizes,this._render_interframe_delays));return Math.floor(1e3/L)}get videoElementStatus(){return this._isInPage?this._videoElementStatus:g1.DESTROYED}set videoElementStatus(L){L!==this._videoElementStatus&&(gc.debug("[".concat(this.trackId,"] video-element-status change ").concat(this._videoElementStatus," => ").concat(L)),this._videoElementStatus=L)}get videoState(){return this._videoState}set videoState(L){var k;L!==this._videoState&&(this._videoState=L,null===(k=this.onVideoStateChanged)||void 0===k||k.call(this,this.videoState))}constructor(L){aP(this,"trackId",void 0),aP(this,"config",void 0),aP(this,"onFirstVideoFrameDecoded",void 0),aP(this,"onFirstVideoFrameRender",void 0),aP(this,"onVideoStateChanged",void 0),aP(this,"freezeTimeCounterList",[]),aP(this,"renderFreezeAccTime",0),aP(this,"renderFreezeAccTime2",0),aP(this,"isKeepLastFrame",!1),aP(this,"isDestroyed",!1),aP(this,"timeUpdatedCount",0),aP(this,"freezeTime",0),aP(this,"playbackTime",0),aP(this,"lastTimeUpdatedTime",0),aP(this,"autoplayFailed",!1),aP(this,"videoTrack",void 0),aP(this,"videoElement",void 0),aP(this,"cacheVideoElement",void 0),aP(this,"internal",!1),aP(this,"_render_interframe_delays",[]),aP(this,"_render_interframe_delays_sizes",[]),aP(this,"_videoState",g2.VideoStateStopped),aP(this,"videoElementCheckInterval",void 0),aP(this,"videoElementFreezeTimeout",void 0),aP(this,"_videoElementStatus",g1.NONE),aP(this,"_isInPage",!0),aP(this,"isGettingVideoDimensions",!1),aP(this,"startGetVideoDimensions",()=>{let e=()=>{if(this.isGettingVideoDimensions=!0,this.videoElement.videoWidth*this.videoElement.videoHeight>4)return gc.debug("[".concat(this.trackId,"] current video dimensions:"),this.videoElement.videoWidth,this.videoElement.videoHeight),void(this.isGettingVideoDimensions=!1);setTimeout(e,500)};this.isGettingVideoDimensions||e()}),aP(this,"autoResumeAfterInterruption",()=>{this.videoTrack&&"live"===this.videoTrack.readyState&&"running"===g8.curState&&(gc.debug("[track-".concat(this.trackId,"] video element paused, auto resume for ").concat(JA())),fw()?(this.videoElement.srcObject=null,this.videoElement.srcObject=new MediaStream([this.videoTrack])):this.videoElement.pause(),this.videoElement.play())}),aP(this,"handleVideoEvents",L=>{switch(L.type){case"play":case"playing":"play"===L.type&&gc.debug("[".concat(this.trackId,"] video element status: play")),this.startGetVideoDimensions(),this.videoElementStatus=g1.PLAYING;break;case"loadeddata":if(this.videoState=g2.VideoStateStarting,this.onFirstVideoFrameRender&&this.onFirstVideoFrameRender(),this.onFirstVideoFrameDecoded&&this.onFirstVideoFrameDecoded(),this.cacheVideoElement){try{this.cacheVideoElement.srcObject=null,this.cacheVideoElement.remove()}catch(L){}this.cacheVideoElement=void 0}break;case"canplay":this.videoElementStatus=g1.CANPLAY;break;case"stalled":this.videoElementStatus=g1.STALLED;break;case"suspend":this.videoElementStatus=g1.SUSPEND;break;case"pause":this.videoElementStatus=g1.PAUSED,nw()||Sw()||$A()&&this.autoplayFailed||!this.videoTrack||"live"!==this.videoTrack.readyState||(gc.debug("[track-".concat(this.trackId,"] video element paused, auto resume")),this.videoElement.play());break;case"waiting":this.videoElementStatus=g1.WAITING;break;case"abort":this.videoElementStatus=g1.ABORT;break;case"ended":this.videoElementStatus=g1.ENDED;break;case"emptied":this.videoElementStatus=g1.EMPTIED;break;case"error":{let L=this.videoElement.error;L&&(this.videoElementStatus=g1.ERROR,gc.error("[".concat(this.trackId,"] media error: ").concat(L.message," (").concat(L.code,")")));break}case"timeupdate":{let L=performance.now();if(this.timeUpdatedCount+=1,this.timeUpdatedCount<10)return void(this.lastTimeUpdatedTime=L);let k=L-this.lastTimeUpdatedTime,M=this.lastTimeUpdatedTime;if(this.lastTimeUpdatedTime=L,TS.lastVisibleTime<TS.lastHiddenTime||M<TS.lastHiddenTime||M<TS.lastVisibleTime||this.isSkipCalcRenderFreezeTime())return;for(k>wN("VIDEO_FREEZE_DURATION")&&(this.freezeTime+=k),this.playbackTime+=k;this.playbackTime>=6e3;){this.playbackTime-=6e3;let L=Math.min(6e3,this.freezeTime);this.freezeTimeCounterList.push(L),this.freezeTime=Math.max(0,this.freezeTime-6e3)}}}}),aP(this,"autoResumeAfterInterruptionOnIOS15_16",()=>{this.videoTrack&&"live"===this.videoTrack.readyState&&(gc.debug("[track-".concat(this.trackId,"] video element paused, auto resume for ").concat(JA())),fw()?(this.videoElement.srcObject=null,this.videoElement.srcObject=new MediaStream([this.videoTrack])):this.videoElement.pause(),this.videoElement.play())}),this.trackId=L.trackId,this.config=L,L.element instanceof HTMLVideoElement?this.videoElement=L.element:this.videoElement=document.createElement("video"),g8.on(gS.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),g8.on(gS.IOS_15_16_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15_16)}getVideoElement(){return this.videoElement}getContainerElement(){var L;return null!==(L=this.videoElement.parentElement)&&void 0!==L?L:void 0}updateConfig(L){this.config=L,this.trackId=L.trackId,L.element!==this.videoElement&&(this.destroy(),this.videoElement=L.element),this.videoTrack&&this.initVideoElement()}updateVideoTrack(L){this.videoTrack!==L&&(this.videoTrack=L,this.initVideoElement())}play(L){let k=this.videoElement.play();k&&k.catch&&k.catch(k=>{L&&UP(L,"video",k.message,this.trackId),"NotAllowedError"===k.name?(gc.warning("detected video element autoplay failed",k),this.autoplayFailed=!0,this.handleAutoPlayFailed()):gc.warning("[".concat(this.trackId,"] play warning: "),k)});let M=zA();if(("Safari"===M.name&&15===Number(M.version)||Ew())&&k&&k.then){let e=()=>{this.config.mirror&&(this.videoElement.style.transform="rotateY(180deg)")};k.then(e).catch(e)}}getCurrentFrame(){let L=document.createElement("canvas");L.width=this.videoElement.videoWidth,L.height=this.videoElement.videoHeight;let k=L.getContext("2d");if(!k)return gc.error("create canvas context failed!"),new ImageData(2,2);k.drawImage(this.videoElement,0,0,L.width,L.height);let M=k.getImageData(0,0,L.width,L.height);return L.remove(),M}async getCurrentFrameToUint8Array(L){let k=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,M=document.createElement("canvas");M.width=this.videoElement.videoWidth,M.height=this.videoElement.videoHeight;let U=M.getContext("2d");return U?(U.drawImage(this.videoElement,0,0,M.width,M.height),new lQ((U,V)=>{M.toBlob(async L=>{if(M.remove(),L){let k=await $P(L);U({buffer:k,width:M.width,height:M.height})}else V(new f2(f1.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED))},L,k<0?.1:k>1?1:k)})):await QP(L)}destroy(){this.isDestroyed=!0,g8.off(gS.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),g8.off(gS.IOS_15_16_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15_16),this.videoElement.srcObject=null,this.resetVideoElement(),this.freezeTimeCounterList=[],this.videoState=g2.VideoStateStopped}initVideoElement(){if(this.videoElementStatus=g1.INIT,!this.videoElementCheckInterval&&(Th.forEach(L=>{this.videoElement.addEventListener(L,this.handleVideoEvents)}),this.videoElementCheckInterval=window.setInterval(()=>{var L;this._isInPage=(L=this.videoElement)!==document.body&&document.body.contains(L)},1e3),wN("ENABLE_VIDEO_FRAME_CALLBACK"))){var L,k;let M;let n=()=>{"visible"===document.visibilityState&&(document.removeEventListener("visibilitychange",n),this.videoElementFreezeTimeout=window.setTimeout(r,wN("VIDEO_FREEZE_DURATION")))},r=()=>{this.videoElementFreezeTimeout=void 0,this.videoState===g2.VideoStateDecoding&&("visible"===document.visibilityState?this.videoState=g2.VideoStateFrozen:document.addEventListener("visibilitychange",n))},o=(L,k)=>{var U,V;if(this.videoElementStatus===g1.PLAYING){if(M){let L=k.presentationTime-M.presentationTime,U=k.presentedFrames-M.presentedFrames;this._render_interframe_delays_sizes.push(U),this._render_interframe_delays.push(L);let V=kO(this._render_interframe_delays_sizes),F=V-this._render_interframe_delays_sizes[0];if(V>30&&F>5&&(this._render_interframe_delays_sizes.shift(),this._render_interframe_delays.shift()),this.videoState===g2.VideoStateStarting&&(this.videoState=g2.VideoStateDecoding),this.videoState===g2.VideoStateDecoding&&this.onVideoStateChanged&&(this.videoElementFreezeTimeout&&window.clearTimeout(this.videoElementFreezeTimeout),this.videoElementFreezeTimeout=window.setTimeout(r,wN("VIDEO_FREEZE_DURATION"))),L<wN("VIDEO_FREEZE_DURATION")&&this.videoState===g2.VideoStateFrozen&&(this.videoState=g2.VideoStateDecoding),L>wN("VIDEO_FREEZE_DURATION")&&TS.lastVisibleTime>=TS.lastHiddenTime&&M.timestamp>TS.lastVisibleTime&&M.timestamp>TS.lastHiddenTime){let k=Math.min(66,YL(this._render_interframe_delays_sizes,this._render_interframe_delays)),M=Math.max(0,L-(U-1)*k);this.renderFreezeAccTime2+=M>k?M:0,this.renderFreezeAccTime+=L}}M=dP(dP({},k),{},{timestamp:L})}else this.isSkipCalcRenderFreezeTime()&&(M=dP(dP({},k),{},{timestamp:L}));wN("ENABLE_VIDEO_FRAME_CALLBACK")&&(null===(U=(V=this.videoElement).requestVideoFrameCallback)||void 0===U||U.call(V,o))};null===(L=(k=this.videoElement).requestVideoFrameCallback)||void 0===L||L.call(k,o)}this.videoElement.controls=!1,this.videoElement.setAttribute("playsinline",""),Cw()&&!wN("HIDE_NO_POSTER")&&(this.videoElement.poster="noposter");let M=zA();"Safari"===M.name&&15===Number(M.version)||Ew()||!this.config.mirror||(this.videoElement.style.transform="rotateY(180deg)"),this.config.fit?this.videoElement.style.objectFit=this.config.fit:this.videoElement.style.objectFit="cover",this.videoElement.setAttribute("muted",""),this.videoElement.muted=!0,this.videoElement.srcObject&&this.videoElement.srcObject instanceof MediaStream?this.videoElement.srcObject.getVideoTracks()[0]!==this.videoTrack&&(this.videoElement.srcObject=this.videoTrack?new MediaStream([this.videoTrack]):null,iw()&&this.videoElement.load()):(this.videoElement.srcObject=this.videoTrack?new MediaStream([this.videoTrack]):null,iw()&&this.videoElement.load());let U=this.videoElement.play();void 0!==U&&U.catch(L=>{gc.debug("[".concat(this.trackId,"] playback interrupted"),L.toString())})}resetVideoElement(){Th.forEach(L=>{this.videoElement&&this.videoElement.removeEventListener(L,this.handleVideoEvents)}),this.videoElementCheckInterval&&(window.clearInterval(this.videoElementCheckInterval),this.videoElementCheckInterval=void 0),this.videoElementStatus=g1.NONE}isSkipCalcRenderFreezeTime(){return this.videoElementStatus===g1.DESTROYED||this.internal}handleAutoPlayFailed(){let e=L=>{L.preventDefault(),this.videoElement.play().then(()=>{gc.debug("[".concat(this.trackId,"] Video element for trackId:").concat(this.trackId," autoplay resumed."))}).catch(L=>{gc.error(L)}),this.autoplayFailed=!1,yw()?document.body.removeEventListener("click",e,!0):(document.body.removeEventListener("touchstart",e,!0),document.body.removeEventListener("mousedown",e,!0))};yw()?document.body.addEventListener("click",e,!0):(document.body.addEventListener("touchstart",e,!0),document.body.addEventListener("mousedown",e,!0)),MP()}};let Th=["play","playing","loadeddata","canplay","pause","stalled","suspend","waiting","abort","emptied","ended","timeupdate","error"];let XL=class XL extends zL{constructor(L){let k=arguments.length>1&&void 0!==arguments[1]&&arguments[1];super(L),aP(this,"container",void 0),aP(this,"slot",void 0),this.slot=L.element,this.internal=k,this.updateConfig(L)}updateConfig(L){var k;this.config=L,this.trackId=L.trackId;let M=L.element;!this.internal||this.slot?(M!==this.slot&&(this.destroy(),this.slot=M),this.createElements()):(this.slot=M,M&&this.container?(this.internal=!1,this.container.id="agora-video-player-".concat(this.trackId),this.videoElement.id="video_".concat(this.trackId),this.config.fit?this.videoElement.style.objectFit=this.config.fit:this.videoElement.style.objectFit="cover",null===(k=this.slot)||void 0===k||k.appendChild(this.container)):this.createElements())}updateVideoTrack(L){this.videoTrack!==L&&(this.videoTrack=L,this.createElements())}play(L){var k;null!==(k=this.container)&&void 0!==k&&k.contains(this.videoElement)&&super.play(L)}getCurrentFrame(){var L;return null!==(L=this.container)&&void 0!==L&&L.contains(this.videoElement)?super.getCurrentFrame():new ImageData(2,2)}async getCurrentFrameToUint8Array(L){var k;let M=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;return null!==(k=this.container)&&void 0!==k&&k.contains(this.videoElement)?await super.getCurrentFrameToUint8Array(L,M):await QP(L)}destroy(){if(super.destroy(),this.videoElement.remove(),this.videoElement=document.createElement("video"),this.container){try{var L;this.container.remove(),null===(L=this.slot)||void 0===L||L.removeChild(this.container)}catch(L){}this.container=void 0}}createElements(){var L;this.container||(this.container=document.createElement("div")),this.container.id="agora-video-player-".concat(this.trackId),this.container.style.width="100%",this.container.style.height="100%",this.container.style.position="relative",this.container.style.overflow="hidden",this.videoTrack?(this.container.style.backgroundColor="black",wN("KEEP_LAST_FRAME")&&this.isKeepLastFrame&&this.videoElement.paused&&this.resetVideoElement(),this.mountedVideoElement()):this.unmountedVideoElement(),null===(L=this.slot)||void 0===L||L.appendChild(this.container)}mountedVideoElement(){var L;!this.container||null!==(L=this.container)&&void 0!==L&&L.contains(this.videoElement)||this.container.appendChild(this.videoElement),super.initVideoElement(),this.videoElement.id="video_".concat(this.trackId),this.videoElement.className="agora_video_player",this.videoElement.style.width="100%",this.videoElement.style.height="100%",this.videoElement.style.position="absolute",this.videoElement.style.left="0",this.videoElement.style.top="0"}unmountedVideoElement(){var L;if(null!==(L=this.container)&&void 0!==L&&L.contains(this.videoElement)){super.resetVideoElement();try{this.container&&this.container.removeChild(this.videoElement)}catch(L){}this.videoElement=document.createElement("video")}}resetVideoElement(){var L;null!==(L=this.container)&&void 0!==L&&L.contains(this.videoElement)&&(super.resetVideoElement(),this.cacheVideoElement=this.videoElement,this.videoElement=document.createElement("video"))}getContainerElement(){return this.container}};let Tp=(rr=pD({argsMap:(L,k,M)=>[L.getTrackId(),"string"==typeof k?k:k instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement",M]}),ra=FP(),ro=pD({argsMap:L=>[L.getTrackId()]}),rc=FO("LocalVideoTrack","_enabledMutex"),rd=pD({argsMap:(L,k)=>[L.getTrackId(),k]}),rl=FP(),ru=FO("LocalVideoTrack","_enabledMutex"),rh=pD({argsMap:(L,k)=>[L.getTrackId(),k]}),rp=FP(),r_=pD({argsMap:(L,k)=>[L.getTrackId(),k,L._saveEncodeBitrateRatio]}),rE=FP(),rm=pD({argsMap:(L,k)=>[L.getTrackId(),k]}),rf=FP(),rS=FP(),rT=pD({argsMap:(L,k,M)=>[L.getTrackId(),k,M]}),rR=FP(),rI=FP(),rv=FP(),rC=pD({argsMap:L=>[L.getTrackId()]}),ry=FP(),rb=FP(),rO=FP(),rN=FP(),rD=FP(),rP=pD({argsMap:(L,k)=>[L.getTrackId(),k.name]}),rL=pD({argsMap:L=>[L.getTrackId()]}),rk=pD({argsMap:L=>[L.getTrackId()]}),rM=pD({argsMap:(L,k,M)=>[L.getTrackId(),k.label,M]}),sP((rU=class e extends uP{get videoHeight(){if($A()){let{height:L}=this._mediaStreamTrack.getSettings();return this._videoHeight=L,this._videoHeight}return this._videoHeight}get videoWidth(){if($A()){let{width:L}=this._mediaStreamTrack.getSettings();return this._videoWidth=L,this._videoWidth}return this._videoWidth}get isPlaying(){return!(!this._player||this._player.videoElementStatus!==g1.PLAYING)}get processorDestination(){return this._processorDestination}get processorContext(){return this._processorContext}set processorContext(L){this._processorContext=L}get __className__(){return"LocalVideoTrack"}constructor(L,k,M,U,V,F){if(super(L,V),aP(this,"trackMediaType",gW.VIDEO),aP(this,"_player",void 0),aP(this,"isUseScaleResolutionDownBy",!1),aP(this,"_videoVisibleTimer",null),aP(this,"_previousVideoVisibleStatus",void 0),aP(this,"_clearPreviousVideoVisibleStatus",()=>this._previousVideoVisibleStatus=void 0),aP(this,"_encoderConfig",void 0),aP(this,"_scalabilityMode",{numSpatialLayers:1,numTemporalLayers:1}),aP(this,"_optimizationMode",void 0),aP(this,"_saveEncodeBitrateRatio",1),aP(this,"_videoHeight",void 0),aP(this,"_videoWidth",void 0),aP(this,"_forceBitrateLimit",void 0),aP(this,"_enabled",!0),aP(this,"_processorDestination",void 0),aP(this,"_processorContext",void 0),$A()){let{width:k,height:M}=L.getSettings();this._videoWidth=k,this._videoHeight=M}else this.updateMediaStreamTrackResolution();if(this._scalabilityMode=M,this._optimizationMode=U,this._hints=F||[],k&&-1!==this._hints.indexOf(gL.CUSTOM_TRACK)?this._encoderConfig=pO(k):this._encoderConfig=k,-1===this._hints.indexOf(gL.SCREEN_TRACK))this.updateBitrateFromProfile();else if(sw(fQ.CHROME,115)&&-1!==XA().indexOf("Windows")){let k=function(L,k){if("VideoFrame"in window&&"TransformStream"in window&&gf.supportWebRTCInsertableStream){let M=new MediaStreamTrackProcessor(L),U=new MediaStreamTrackGenerator({kind:"video"}),V,F,B=Date.now(),a=()=>{j&&(clearInterval(j),j=void 0),V&&(V.close(),V=void 0),L.stop(),F=void 0,U.removeEventListener("ended",a)},j=window.setInterval(()=>{if(F&&V&&Date.now()-B>(null!=k?k:1e3))try{"live"===U.readyState?F.enqueue(V.clone()):a()}catch(L){a()}},null!=k?k:1e3),G=new TransformStream({transform:(L,k)=>{"live"===U.readyState?(F=k,B=Date.now(),void 0===V?(V=L,k.enqueue(L.clone())):(k.enqueue(V),V=L)):L.close()}});return U.addEventListener("ended",a),M.readable.pipeThrough(G).pipeTo(U.writable),U}}(L);k&&(gc.info("local screen video track begin to inject frame"),this._mediaStreamTrack=k)}k&&-1!==this._hints.indexOf(gL.CUSTOM_TRACK)&&this.setEncoderConfiguration(k),this._processorContext=new jP(this.getTrackId(),"local"),this._processorDestination=new BP(this.processorContext),this.bindProcessorDestinationEvents()}play(L){let k=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if("string"==typeof L){let k=document.getElementById(L);k?L=k:(gc.warning("[".concat(this.getTrackId(),'] can not find "#').concat(L,'" element, use document.body')),L=document.body)}gc.debug("[".concat(this.getTrackId(),"] start video playback in ").concat(L instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement"),JSON.stringify(k));let M=dP(dP(dP({},this._getDefaultPlayerConfig()),k),{},{trackId:this.getTrackId(),element:L});this._player?this._player.updateConfig(M):(L instanceof HTMLVideoElement?this._player=new zL(M):this._player=new XL(M),this._player.updateVideoTrack(this._mediaStreamTrack)),this._player.play(),this._videoVisibleTimer&&window.clearInterval(this._videoVisibleTimer),this._clearPreviousVideoVisibleStatus(),this._videoVisibleTimer=window.setInterval(()=>{try{let L=this.getVideoElementVisibleStatus();this.safeEmit(gB.VIDEO_ELEMENT_VISIBLE_STATUS,L)}catch(L){}},wN("CHECK_VIDEO_VISIBLE_INTERVAL"))}stop(){this._player&&(this._videoVisibleTimer&&(window.clearInterval(this._videoVisibleTimer),this._videoVisibleTimer=null),this._clearPreviousVideoVisibleStatus(),this._player.destroy(),this._player=void 0,gc.debug("[".concat(this.getTrackId(),"] stop video playback")))}async setEnabled(L,k){if(!k){if(L===this._enabled)return;this.stateCheck("enabled",L)}if(gc.info("[".concat(this.getTrackId(),"] start setEnabled"),L),!L){this._originMediaStreamTrack.enabled=!1;try{await sO(this,gN.NEED_DISABLE_TRACK,this)}catch(L){throw gc.error("[".concat(this.getTrackId(),"] setEnabled to false error"),L.toString()),L}return k||(this._enabled=!1),void gc.info("[".concat(this.getTrackId(),"] setEnabled to false success"))}this._originMediaStreamTrack.enabled=!0;try{await sO(this,gN.NEED_ENABLE_TRACK,this)}catch(L){throw gc.error("[".concat(this.getTrackId(),"] setEnabled to true error"),L.toString()),L}gc.info("[".concat(this.getTrackId(),"] setEnabled to true success")),k||(this._enabled=!0)}async setMuted(L){L!==this._muted&&(this.stateCheck("muted",L),this._muted=L,this._originMediaStreamTrack.enabled=!L,gc.debug("[".concat(this.getTrackId(),"] start set muted: ").concat(L)),L?await sO(this,gN.NEED_MUTE_TRACK,this):await sO(this,gN.NEED_UNMUTE_TRACK,this))}async setSaveEncodeBitrateRatio(){let L=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this._saveEncodeBitrateRatio;if(1!==this._saveEncodeBitrateRatio&&this._encoderConfig&&this._encoderConfig.bitrateMax&&this._encoderConfig.bitrateMin){this._encoderConfig.bitrateMin=Math.floor(this._encoderConfig.bitrateMin*L),this._encoderConfig.bitrateMax=Math.floor(this._encoderConfig.bitrateMax*L),gc.debug("[".concat(this.getTrackId(),"] set save encode bitrate ratio, ").concat(L)),this._saveEncodeBitrateRatio=1;try{await sO(this,gN.NEED_UPDATE_VIDEO_ENCODER,this)}catch(L){return L.throw(gc)}}}async setEncoderConfiguration(L,k){if(!this._enabled)throw new f2(f1.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");if(L=ND(L),wN("USE_STANDARD_BITRATE_DEFAULT")&&(delete L.bitrateMax,delete L.bitrateMin),this._forceBitrateLimit&&(L.bitrateMax=this._forceBitrateLimit.max_bitrate?this._forceBitrateLimit.max_bitrate:L.bitrateMax,L.bitrateMin=this._forceBitrateLimit.min_bitrate?this._forceBitrateLimit.min_bitrate:L.bitrateMin),L.width||L.height||L.frameRate){let k=zP({encoderConfig:L});($A()||nw()||Sw())&&(k.deviceId=void 0),gc.debug("[".concat(this.getTrackId(),"] setEncoderConfiguration applyConstraints"),JSON.stringify(L),JSON.stringify(k));try{await this._originMediaStreamTrack.applyConstraints(k),this.updateMediaStreamTrackResolution()}catch(k){let L=new f2(f1.UNEXPECTED_ERROR,k.toString());throw gc.error("[".concat(this.getTrackId(),"] applyConstraints error"),L.toString()),L}}this._encoderConfig=L,-1===this._hints.indexOf(gL.SCREEN_TRACK)&&this.updateBitrateFromProfile();try{await sO(this,gN.NEED_UPDATE_VIDEO_ENCODER,this)}catch(L){return L.throw(gc)}}getStats(){return mO(()=>{gc.warning("[deprecated] LocalVideoTrack.getStats will be removed in the future, use AgoraRTCClient.getLocalVideoStats instead")},"localVideoTrackGetStatsWarning"),aO(this,gN.GET_STATS)||dP({},gK)}async setBeautyEffect(L){gc.error("LocalVideoTrack.setBeautyEffect was deprecated, please migrate to agora-extension-beauty-effect")}getCurrentFrameData(){return this._player?this._player.getCurrentFrame():new ImageData(2,2)}async getCurrentFrameImage(L){let k=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;return this._player?this._player.getCurrentFrameToUint8Array(L,k):await QP(L)}async findClosestProfile(){let{width:L,height:k,frameRate:M}=this.getMediaStreamTrackSettings(),{width:U,height:V,frameRate:F}=this._encoderConfig||{},B=LO(this._videoWidth||L||U||0),j=LO(this._videoHeight||k||V||0),G=function(L,k,M){if(!Array.isArray(wN("VIDEO_ENCODER_CONFIG_LIST"))||0===wN("VIDEO_ENCODER_CONFIG_LIST").length)return!1;let U=Math.min(L,k);return!(U>=480)&&dP(dP({},wN("VIDEO_ENCODER_CONFIG_LIST").find(L=>L.height>U)),{},{frameRate:M})}(B,j,LO(M||F||15));if(G)return gc.debug("[".concat(this.getTrackId(),"] find closest profile, ").concat(B,"x").concat(j," => ").concat(JSON.stringify(G))),this.setEncoderConfiguration(G)}async setBitrateLimit(L){gc.debug("[".concat(this.getTrackId(),"] set bitrate limit, ").concat(JSON.stringify(L))),L&&(this._forceBitrateLimit=L,this._encoderConfig&&(this._encoderConfig.bitrateMax?this._encoderConfig.bitrateMax=this._encoderConfig.bitrateMax<L.max_bitrate?this._encoderConfig.bitrateMax:L.max_bitrate:this._encoderConfig.bitrateMax=L.max_bitrate,this._encoderConfig.bitrateMin,this._encoderConfig.bitrateMin=L.min_bitrate))}async setOptimizationMode(L){if("motion"!==L&&"detail"!==L&&"balanced"!==L)return void gc.error(f1.INVALID_PARAMS,"optimization mode must be motion, detail or balanced");let k=this._optimizationMode;try{this._optimizationMode=L,await sO(this,gN.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this)}catch(L){throw this._optimizationMode=k,gc.error("[".concat(this.getTrackId(),"] set optimization mode failed"),L.toString()),L}gc.info("[".concat(this.getTrackId(),"] set optimization mode success (").concat(L,")"))}setScalabiltyMode(L){if(1===L.numSpatialLayers&&1!==L.numTemporalLayers)return gc.error(f1.INVALID_PARAMS,"scalability mode currently not supported, no SVC."),void(this._scalabilityMode={numSpatialLayers:1,numTemporalLayers:1});this._scalabilityMode=L,gc.info("[".concat(this.getTrackId(),"] set scalability mode success (").concat(L,")"))}updateMediaStreamTrackResolution(){YP(this._originMediaStreamTrack).then(L=>{let[k,M]=L;this._videoHeight=M,this._videoWidth=k}).catch(AO)}_updatePlayerSource(){this._player&&this._player.updateVideoTrack(this._mediaStreamTrack)}_getDefaultPlayerConfig(){return{fit:"contain"}}async setSenderConfiguration(L){if(!this._enabled)throw new f2(f1.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");gc.debug("[".concat(this.getTrackId(),"] setSenderConfiguration applyConstraints"),JSON.stringify(L)),L=ND(L),this._forceBitrateLimit&&(L.bitrateMax=this._forceBitrateLimit.max_bitrate?this._forceBitrateLimit.max_bitrate:L.bitrateMax,L.bitrateMin=this._forceBitrateLimit.min_bitrate?this._forceBitrateLimit.min_bitrate:L.bitrateMin),this._encoderConfig=L,-1===this._hints.indexOf(gL.SCREEN_TRACK)&&this.updateBitrateFromProfile();try{await sO(this,gN.NEED_UPDATE_VIDEO_ENCODER,this)}catch(L){return L.throw(gc)}}updateBitrateFromProfile(){if(!this._encoderConfig)return;let{width:L,height:k,frameRate:M}=this.getMediaStreamTrackSettings();if(!L||!k||!M)return;let{bitrateMax:U,bitrateMin:V}=this._encoderConfig;if(null==V||null==U){let{max:F,min:B}=function(L,k,M,U,V){let F=wN("BITRATE_ADAPTER_TYPE");if("DEFAULT_BITRATE"===F)return{min:U,max:V};if(void 0===V){let B=Math.floor(200*Math.pow(M/15,.6)*Math.pow(L*k/640/360,.75));V="STANDARD_BITRATE"===F?4*B:2*B,U=null!=U?U:B}else U=null!=U?U:Math.floor(V/10);return{min:U,max:V}}(L,k,M,V,U);if(this._encoderConfig.bitrateMin=B,this._encoderConfig.bitrateMax=F,wN("VIDEO_STANDARD_BITRATE_VERSION")&&null==V&&null==U){let[U,V]=function(L,k,M){var U,V;let F=4*Math.floor(2e5*Math.pow(M/15,.6)*Math.pow(L*k/230400,.75)),B=L*k,j=new Map([[19200,.9],[230400,.85],[518400,.75],[921600,.7],[2073600,.6],[3686400,.5]]),G=new Map([[230400,.95],[518400,.9],[921600,.85],[2073600,.8]]),X=l1(j).call(j).next().value,$=1;if(j.has(B))X=j.get(B);else{let L=uu(U=Array.from(j.entries())).call(U,(L,k)=>{let[M]=L,[U]=k;return M-U}),k=L.find(L=>{let[k]=L;return k>B});if(k){let M=L.indexOf(k);if(M>0){let U=L[M-1],V=(B-U[0])/(k[0]-U[0]);X=U[1]+V*(k[1]-U[1])}else X=k[1]}else X=L[L.length-1][1]}if(G.has(B))$=G.get(B);else{let L=uu(V=Array.from(G.entries())).call(V,(L,k)=>{let[M]=L,[U]=k;return M-U}),k=L.find(L=>{let[k]=L;return k>B});if(k){let M=L.indexOf(k);if(M>0){let U=L[M-1],V=(B-U[0])/(k[0]-U[0]);$=U[1]+V*(k[1]-U[1])}else $=k[1]}else $=L[L.length-1][1]}let ee=wN("VIDEO_NEW_BITRATE_RATIO");ee&&ee>0&&(X=ee/100);let et=Math.floor(F*X),ei=et,er=wN("VIDEO_STANDARD_BITRATE_VERSION");return er&&er>0&&(1===er?ei=F:2===er?ei=et:3===er&&(ei=Math.floor(65e4*Math.pow(L*k/230400,.5)*Math.pow(M/15,.69)))),[Math.floor(ei/1e3),$]}(L,k,M);this._encoderConfig.bitrateMax=U,this._encoderConfig.bitrateMin=B?Math.min(B,U):U,this._saveEncodeBitrateRatio=V,gc.debug("[".concat(this.getTrackId(),"] update new bitrate from profile, [w: ").concat(L,", h: ").concat(k,", fps: ").concat(M,"] => [brMax: ").concat(this._encoderConfig.bitrateMax,", brMin: ").concat(this._encoderConfig.bitrateMin,", save_bitrate_ratio: ").concat(this._saveEncodeBitrateRatio,"]"))}else gc.debug("[".concat(this.getTrackId(),"] update bitrate from profile, [w: ").concat(L,", h: ").concat(k,", fps: ").concat(M,"] => [brMax: ").concat(F,", brMin: ").concat(B,"]")),this._saveEncodeBitrateRatio=1}}getVideoElementVisibleStatus(){try{var L,k;let M=null==this||null===(L=this._player)||void 0===L?void 0:L.getContainerElement(),U={track:this,element:null==this||null===(k=this._player)||void 0===k?void 0:k.getVideoElement(),slot:null==M?void 0:M.parentElement},{element:V,slot:F}=U;if(this.isPlaying&&V instanceof HTMLVideoElement&&F instanceof HTMLElement){let L=f4.checkOneElementVisible(V),k=Object.assign({},L);if(k.visible!==this._previousVideoVisibleStatus){this._previousVideoVisibleStatus=k.visible;let L=g_.reportApiInvoke(null,{tag:f9.TRACER,name:f8.LOCAL_VIDEO_TRACK_GET_VIDEO_VISIBLE,options:[this.getTrackId()]});k.visible?L.onSuccess("Video is visible"):L.onSuccess("Invisible because of ".concat(k.reason))}return k}return}catch(L){throw new f2(f1.GET_VIDEO_ELEMENT_VISIBLE_ERROR,L.message)}}async renewMediaStreamTrack(L){}pipe(L){if(this.processor===L)return L;if(L._source)throw new f2(f1.INVALID_OPERATION,"Processor ".concat(L.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=L,this.processor._source=this,L.updateInput({track:this._originMediaStreamTrack,context:this.processorContext}),L}unpipe(){if(!this.processor)return;let L=this.processor;this.processor._source=void 0,this.processor=void 0,L.reset()}close(){super.close(),this.unbindProcessorDestinationEvents(),this.unbindProcessorContextEvents(),this.unpipe(),this.processorDestination._source&&this.processorDestination._source.unpipe()}clone(L){let k=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],M=this._encoderConfig;L&&(M=dP(dP({},M),ND(L))),M=_O(M);let U=IO(8,"track-video-cloned-"),V=new e(k?this._mediaStreamTrack.clone():this._mediaStreamTrack,M,_O(this._scalabilityMode),this._optimizationMode,U,_O(this._hints));return L&&M&&V.setEncoderConfiguration(M),gc.debug("clone video track from ".concat(this.getTrackId()," to ").concat(U,", clone ").concat(k)),V}async replaceTrack(L,k){if(!(L instanceof MediaStreamTrack))throw new f2(f1.INVALID_PARAMS,"track should be an instance of MediaStreamTrack");if("video"!==L.kind)throw new f2(f1.INVALID_PARAMS,"track should be a video MediaStreamTrack");await this._updateOriginMediaStreamTrack(L,k,!0),this.updateMediaStreamTrackResolution()}sendSeiData(L){if(mO(()=>{g_.reportApiInvoke(null,{name:f8.LOCAL_VIDEO_SEND_SEI_DATA,options:[],tag:f9.TRACER}).onSuccess("")},this._mediaStreamTrack.id||this.getTrackId()),!wN("ENABLE_VIDEO_SEI")||!wN("ENABLE_ENCODED_TRANSFORM"))return void gc.warning('To send/receive SEI, please call AgoraRTC.setParameter("ENABLE_VIDEO_SEI", true) before instantiate IAgoraRtcClient');if(L instanceof Uint8Array==0)return new f2(f1.INVALID_PARAMS,"Invalid argument type, ILocalVideoTrack.sendSeiData() only accept Uint8Array argument.").throw();let k=this.getRTCRtpTransceiver();if(!k)return void gc.warning("Video track is not published, SEI can not be send");let M=k.sender.getParameters();if(0===M.codecs.length)return;let U=M.codecs[0].mimeType.toLocaleLowerCase();"video/h264"===U||"video/h265"===U?this.safeEmit("sei-to-send",L):gc.warning("SEI is not supported by ".concat(U))}bindProcessorDestinationEvents(){this.processorDestination.on(gQ.ON_TRACK,async L=>{L?L!==this._mediaStreamTrack&&(this._mediaStreamTrack=L,this._updatePlayerSource(),await sO(this,gN.NEED_REPLACE_TRACK,this)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await sO(this,gN.NEED_REPLACE_TRACK,this))})}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(gQ.ON_TRACK)}unbindProcessorContextEvents(){this.processorContext.removeAllListeners(gZ.REQUEST_UPDATE_CONSTRAINTS),this.processorContext.removeAllListeners(gZ.REQUEST_CONSTRAINTS)}}).prototype,"play",[rr,ra],Object.getOwnPropertyDescriptor(rU.prototype,"play"),rU.prototype),sP(rU.prototype,"stop",[ro],Object.getOwnPropertyDescriptor(rU.prototype,"stop"),rU.prototype),sP(rU.prototype,"setEnabled",[rc,rd,rl],Object.getOwnPropertyDescriptor(rU.prototype,"setEnabled"),rU.prototype),sP(rU.prototype,"setMuted",[ru,rh,rp],Object.getOwnPropertyDescriptor(rU.prototype,"setMuted"),rU.prototype),sP(rU.prototype,"setSaveEncodeBitrateRatio",[r_,rE],Object.getOwnPropertyDescriptor(rU.prototype,"setSaveEncodeBitrateRatio"),rU.prototype),sP(rU.prototype,"setEncoderConfiguration",[rm,rf],Object.getOwnPropertyDescriptor(rU.prototype,"setEncoderConfiguration"),rU.prototype),sP(rU.prototype,"getStats",[rS],Object.getOwnPropertyDescriptor(rU.prototype,"getStats"),rU.prototype),sP(rU.prototype,"setBeautyEffect",[rT,rR],Object.getOwnPropertyDescriptor(rU.prototype,"setBeautyEffect"),rU.prototype),sP(rU.prototype,"getCurrentFrameData",[rI],Object.getOwnPropertyDescriptor(rU.prototype,"getCurrentFrameData"),rU.prototype),sP(rU.prototype,"getCurrentFrameImage",[rv],Object.getOwnPropertyDescriptor(rU.prototype,"getCurrentFrameImage"),rU.prototype),sP(rU.prototype,"findClosestProfile",[rC,ry],Object.getOwnPropertyDescriptor(rU.prototype,"findClosestProfile"),rU.prototype),sP(rU.prototype,"setBitrateLimit",[rb],Object.getOwnPropertyDescriptor(rU.prototype,"setBitrateLimit"),rU.prototype),sP(rU.prototype,"setOptimizationMode",[rO],Object.getOwnPropertyDescriptor(rU.prototype,"setOptimizationMode"),rU.prototype),sP(rU.prototype,"setScalabiltyMode",[rN],Object.getOwnPropertyDescriptor(rU.prototype,"setScalabiltyMode"),rU.prototype),sP(rU.prototype,"updateMediaStreamTrackResolution",[rD],Object.getOwnPropertyDescriptor(rU.prototype,"updateMediaStreamTrackResolution"),rU.prototype),sP(rU.prototype,"pipe",[rP],Object.getOwnPropertyDescriptor(rU.prototype,"pipe"),rU.prototype),sP(rU.prototype,"unpipe",[rL],Object.getOwnPropertyDescriptor(rU.prototype,"unpipe"),rU.prototype),sP(rU.prototype,"close",[rk],Object.getOwnPropertyDescriptor(rU.prototype,"close"),rU.prototype),sP(rU.prototype,"replaceTrack",[rM],Object.getOwnPropertyDescriptor(rU.prototype,"replaceTrack"),rU.prototype),rU),T_=(rV=pD({argsMap:(L,k)=>[L.getTrackId(),k]}),rF=FP(),rG=FO("CameraVideoTrack","_enabledMutex"),rH=pD({argsMap:(L,k)=>[L.getTrackId(),k]}),rY=FP(),rq=pD({argsMap:(L,k)=>[L.getTrackId(),k]}),rJ=FP(),rX=pD({argsMap:L=>[L.getTrackId()]}),sP((rQ=class e extends Tp{get __className__(){return"CameraVideoTrack"}constructor(L,k,M,U,V,F){super(L,ND(k.encoderConfig),U,V,F),aP(this,"_config",void 0),aP(this,"_originalConstraints",void 0),aP(this,"_constraints",void 0),aP(this,"_enabled",!0),aP(this,"_deviceName","default"),aP(this,"tryResumeVideoForIOS15_16WeChat",async()=>{(Ew()||mw())&&!function(){let L=zA();if(L.os!==fX.IOS||!L.osVersion)return!1;let k=L.osVersion.split(".");return 15===Number(k[0])&&Number(k[1])>=2}()&&gw()&&this._enabled&&!this._isClosed&&(gc.debug("[".concat(this.getTrackId(),"] try capture camera media device for interrupted iOS 15 device on WeChat.")),await this.renewMediaStreamTrack())}),this._config=k,this._originalConstraints=M,this._constraints=M,this._deviceName=L.label,this._encoderConfig=ND(this._config.encoderConfig),g8.on(gS.IOS_15_16_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat),g8.on(gS.IOS_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat),this.bindProcessorContextEvents()}async setDevice(L){return"string"==typeof L?this._setDeviceById(L):L.deviceId?this._setDeviceById(L.deviceId):L.facingMode?this._setDeviceByFacingModel(L.facingMode):void 0}async _setDeviceById(L){if(gc.info("[".concat(this.getTrackId(),"] set device to ").concat(L)),this._enabled)try{let k=await Ti.getDeviceById(L),M={};M.video=dP({},this._constraints),M.video.deviceId={exact:L},M.video.facingMode=void 0,this._originMediaStreamTrack.stop();let U=null;try{U=await wP(M,this.getTrackId())}catch(L){throw gc.error("[".concat(this.getTrackId(),"] setDevice failed"),L.toString()),U=await wP({video:this._constraints},this.getTrackId()),await this._updateOriginMediaStreamTrack(U.getVideoTracks()[0],!1),L}await this._updateOriginMediaStreamTrack(U.getVideoTracks()[0],!1),this.updateMediaStreamTrackResolution(),this._deviceName=k.label,this._config.cameraId=L,this._constraints.deviceId={exact:L}}catch(L){throw gc.error("[".concat(this.getTrackId(),"] setDevice error"),L.toString()),L}else try{let k=await Ti.getDeviceById(L);this._deviceName=k.label,this._config.cameraId=L,this._constraints.deviceId={exact:L}}catch(L){throw gc.error("[".concat(this.getTrackId(),"] setDevice error"),L.toString()),L}gc.info("[".concat(this.getTrackId(),"] setDevice success"))}async _setDeviceByFacingModel(L){gc.info("[".concat(this.getTrackId(),"] set facingMode ").concat(L));let k={video:dP(dP({},this._constraints),{},{deviceId:void 0,facingMode:{exact:L}})};if(this._enabled){this._originMediaStreamTrack.stop();let L=null;try{L=await wP(k,this.getTrackId())}catch(k){throw gc.error("[".concat(this.getTrackId(),"] setDeviceByFacingModel failed"),k.toString()),L=await wP({video:this._constraints},this.getTrackId()),await this._updateOriginMediaStreamTrack(L.getVideoTracks()[0],!1),k}await this._updateOriginMediaStreamTrack(L.getVideoTracks()[0],!1),this.updateMediaStreamTrackResolution()}this._deviceName="",this._config.facingMode=L,this._config.cameraId=void 0,this._constraints=dP({},k.video),gc.info("[".concat(this.getTrackId(),"] setDeviceByFacingModel success"))}async setEnabled(L,k){if(!k){if(L===this._enabled)return;this.stateCheck("enabled",L)}if(gc.info("[".concat(this.getTrackId(),"] start setEnabled"),L),L){try{if(this.isExternalTrack)this._originMediaStreamTrack.enabled=!0;else{let L=await wP({video:this._constraints},this.getTrackId());await this._updateOriginMediaStreamTrack(L.getVideoTracks()[0],!1)}await sO(this,gN.NEED_ENABLE_TRACK,this)}catch(L){throw gc.error("[".concat(this.getTrackId(),"] setEnabled true error"),L.toString()),L}this.updateMediaStreamTrackResolution(),gc.info("[".concat(this.getTrackId(),"] setEnabled to true success")),k||(this._enabled=!0)}else{this.isExternalTrack?this._originMediaStreamTrack.enabled=!1:(this._originMediaStreamTrack.onended=null,this._originMediaStreamTrack.stop()),k||(this._enabled=!1);try{await sO(this,gN.NEED_DISABLE_TRACK,this)}catch(L){throw gc.error("[".concat(this.getTrackId(),"] setEnabled to false error"),L.toString()),L}gc.info("[".concat(this.getTrackId(),"] setEnabled to false success"))}}async setEncoderConfiguration(L,k){if(!this._enabled)throw new f2(f1.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");L=ND(L),wN("USE_STANDARD_BITRATE_DEFAULT")&&(delete L.bitrateMax,delete L.bitrateMin),this._forceBitrateLimit&&(L.bitrateMax=this._forceBitrateLimit.max_bitrate||L.bitrateMax,L.bitrateMin=this._forceBitrateLimit.min_bitrate||L.bitrateMin);let M=pO(this._config);M.encoderConfig=L;let U=zP(M);($A()||nw()||Sw())&&(U.deviceId=void 0),gc.debug("[".concat(this.getTrackId(),"] setEncoderConfiguration applyConstraints"),JSON.stringify(L),JSON.stringify(U));try{await this._originMediaStreamTrack.applyConstraints(U),this.updateMediaStreamTrackResolution()}catch(k){let L=new f2(f1.UNEXPECTED_ERROR,k.toString());throw gc.error("[".concat(this.getTrackId(),"] applyConstraints error"),L.toString()),L}this._config=M,this._constraints=U,this._originalConstraints=U,this._encoderConfig=L,-1===this._hints.indexOf(gL.SCREEN_TRACK)&&this.updateBitrateFromProfile();try{await sO(this,gN.NEED_UPDATE_VIDEO_ENCODER,this)}catch(L){return L.throw(gc)}}_getDefaultPlayerConfig(){return{mirror:!0,fit:"cover"}}onTrackEnded(){if((nw()||Sw())&&this._enabled&&!this._isClosed&&g8.duringInterruption){let e=async()=>{g8.off(gS.IOS_INTERRUPTION_END,e),this._enabled&&!this._isClosed&&(gc.debug("[".concat(this.getTrackId(),"] try capture camera media device for interrupted iOS device.")),await this.setEnabled(!1),await this.setEnabled(!0))};g8.on(gS.IOS_INTERRUPTION_END,e)}else gc.debug("[".concat(this.getTrackId(),"] track ended")),this.safeEmit(gB.TRACK_ENDED)}async renewMediaStreamTrack(L){let k=L||this._constraints,M=Ti.searchDeviceIdByName(this._deviceName);if(M&&!k.deviceId&&(k.deviceId={exact:M}),this._enabled){let L=await wP({video:k},this.getTrackId());this._constraints=k,await this._updateOriginMediaStreamTrack(L.getVideoTracks()[0],!0),this.updateMediaStreamTrackResolution()}}close(){super.close(),g8.off(gS.IOS_15_16_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat),g8.off(gS.IOS_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat)}clone(L){let k=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],M=this._encoderConfig;L&&(M=dP(dP({},M),ND(L))),M=_O(M);let U=IO(8,"track-cam-cloned-"),V=new e(k?this._mediaStreamTrack.clone():this._mediaStreamTrack,_O(dP(dP({},this._config),{},{encoderConfig:M})),_O(this._constraints),_O(this._scalabilityMode),this._optimizationMode,U);return L&&M&&V.setEncoderConfiguration(M),gc.debug("clone track from ".concat(this.getTrackId()," to ").concat(U,", clone ").concat(k)),V}bindProcessorContextEvents(){this.processorContext.on(gZ.REQUEST_UPDATE_CONSTRAINTS,async(L,k,M)=>{try{let M=Object.assign({},this._originalConstraints,...L);await this.renewMediaStreamTrack(M),k()}catch(L){M(L)}}),this.processorContext.on(gZ.REQUEST_CONSTRAINTS,async L=>{L(this._originMediaStreamTrack.getSettings())})}}).prototype,"setDevice",[rV,rF],Object.getOwnPropertyDescriptor(rQ.prototype,"setDevice"),rQ.prototype),sP(rQ.prototype,"setEnabled",[rG,rH,rY],Object.getOwnPropertyDescriptor(rQ.prototype,"setEnabled"),rQ.prototype),sP(rQ.prototype,"setEncoderConfiguration",[rq,rJ],Object.getOwnPropertyDescriptor(rQ.prototype,"setEncoderConfiguration"),rQ.prototype),sP(rQ.prototype,"close",[rX],Object.getOwnPropertyDescriptor(rQ.prototype,"close"),rQ.prototype),rQ);function Uk(L,k,M,U){M.optimizationMode&&(U&&U.width&&U.height?(M.encoderConfig=dP(dP({},U),{},{bitrateMin:U.bitrateMin,bitrateMax:U.bitrateMax}),"motion"!==M.optimizationMode&&"detail"!==M.optimizationMode||(k.contentHint=M.optimizationMode,k.contentHint===M.optimizationMode?gc.debug("[".concat(L,"] set content hint to"),M.optimizationMode):gc.debug("[".concat(L,"] set content hint failed")))):gc.warning("[".concat(L,"] can not apply optimization mode bitrate config, no encoderConfig")))}let Xk=class Xk extends lP{getUserId(){return this._userId}constructor(L,k,M,U){super(L,"track-".concat(L.kind,"-").concat(k,"-").concat(U.clientId,"_").concat(IO(5,""))),aP(this,"_userId",void 0),aP(this,"_uintId",void 0),aP(this,"_isDestroyed",!1),aP(this,"store",void 0),aP(this,"processor",void 0),aP(this,"processorContext",void 0),this._userId=k,this._uintId=M,this.store=U}_updateOriginMediaStreamTrack(L){this._originMediaStreamTrack=L,this._mediaStreamTrack=L,this._updatePlayerSource(),this.processor&&this.processor.updateInput({track:this._originMediaStreamTrack,context:this.processorContext})}_destroy(){this._isDestroyed=!0,gc.info("[".concat(this.getTrackId(),"] is destroyed")),this.stop(),super.close()}getProcessorStats(){return this.processorContext.gatherStats()}getProcessorUsage(){return this.processorContext.gatherUsage()}};let TE=(rZ=pD({argsMap:(L,k,M)=>[L.getTrackId(),"string"==typeof k?k:k instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement",M]}),r$=pD({argsMap:L=>[L.getTrackId()]}),r0=pD({argsMap:(L,k)=>[L.getTrackId(),k.name]}),r1=pD({argsMap:L=>[L.getTrackId()]}),sP((r2=class extends Xk{get isPlaying(){return!(!this._player||this._player.videoElementStatus!==g1.PLAYING)}get __className__(){return"RemoteVideoTrack"}constructor(L,k,M,U,V){super(L,k,M,U),aP(this,"_videoVisibleTimer",null),aP(this,"_previousVideoVisibleStatus",void 0),aP(this,"_clearPreviousVideoVisibleStatus",()=>this._previousVideoVisibleStatus=void 0),aP(this,"trackMediaType",gW.VIDEO),aP(this,"_videoWidth",void 0),aP(this,"_videoHeight",void 0),aP(this,"_player",void 0),aP(this,"_prePlayer",void 0),aP(this,"processorDestination",void 0),aP(this,"processorContext",void 0),this._prePlayer=V,this.updateMediaStreamTrackResolution(),this.processorContext=new jP(this.getTrackId(),"remote"),this.processorDestination=new BP(this.processorContext),this.bindProcessorDestinationEvents()}getStats(){return mO(()=>{gc.warning("[deprecated] RemoteVideoTrack.getStats will be removed in the future, use AgoraRTCClient.getRemoteVideoStats instead")},"remoteVideoTrackGetStatsWarning"),aO(this,gN.GET_STATS)||dP({},gX)}play(L){let k=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(this.safeEmit(gj.PLAY_START),"string"==typeof L){let k=document.getElementById(L);k?L=k:(gc.warning("[".concat(this.getTrackId(),'] can not find "#').concat(L,'" element, use document.body')),L=document.body)}gc.debug("[".concat(this.getTrackId(),"] start video playback in ").concat(L instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement"),JSON.stringify(k));let M=dP(dP({fit:"cover"},k),{},{trackId:this.getTrackId(),element:L});if(this._player)this._player.updateConfig(M);else{let k=!1,U=!1;L instanceof HTMLVideoElement?(this._player=new zL(M),this._prePlayer&&(this._prePlayer.destroy(),this._prePlayer=void 0,U=!0)):this._prePlayer&&!this._prePlayer.isDestroyed?(this._player=this._prePlayer,this._prePlayer=void 0,k=this._player.videoState>0,this._player.updateConfig(M)):this._player=new XL(M),this._player.updateVideoTrack(this._mediaStreamTrack),this._player.onFirstVideoFrameDecoded=()=>{this.store.subscribe(this.getUserId(),"video",void 0,void 0,Date.now()),this.safeEmit(gj.FIRST_FRAME_DECODED),U&&this.safeEmit(gj.FIRST_FRAME_RENDER)},this._player.onVideoStateChanged=L=>{this.safeEmit(gj.VIDEO_STATE_CHANGED,L)},k&&(this._player.onFirstVideoFrameDecoded(),this._player.onVideoStateChanged(this._player.videoState))}this._player.play(this.store.sessionId||void 0),this._videoVisibleTimer&&window.clearInterval(this._videoVisibleTimer),this._clearPreviousVideoVisibleStatus(),this._videoVisibleTimer=window.setInterval(()=>{try{let L=this.getVideoElementVisibleStatus();this.safeEmit(gj.VIDEO_ELEMENT_VISIBLE_STATUS,L)}catch(L){}},wN("CHECK_VIDEO_VISIBLE_INTERVAL")),this.safeEmit(gj.PLAY_END)}stop(){this._player&&(this._videoVisibleTimer&&(window.clearInterval(this._videoVisibleTimer),this._videoVisibleTimer=null),this._clearPreviousVideoVisibleStatus(),this._player.destroy(),this._player=void 0,gc.debug("[".concat(this.getTrackId(),"] stop video playback")))}getCurrentFrameData(){return this._player?this._player.getCurrentFrame():new ImageData(2,2)}updateMediaStreamTrackResolution(){YP(this._originMediaStreamTrack).then(L=>{let[k,M]=L;this._videoHeight=M,this._videoWidth=k}).catch(AO)}_updatePlayerSource(){gc.debug("[".concat(this.getTrackId(),"] update player source track")),this._player&&this._player.updateVideoTrack(this._mediaStreamTrack)}getVideoElementVisibleStatus(){try{var L,k;let M=null==this||null===(L=this._player)||void 0===L?void 0:L.getContainerElement(),U={track:this,element:null==this||null===(k=this._player)||void 0===k?void 0:k.getVideoElement(),slot:null==M?void 0:M.parentElement},{element:V,slot:F}=U;if(this.isPlaying&&V instanceof HTMLVideoElement&&F instanceof HTMLElement){let L=f4.checkOneElementVisible(V),k=Object.assign({},L);if(k.visible!==this._previousVideoVisibleStatus){this._previousVideoVisibleStatus=k.visible;let L=g_.reportApiInvoke(null,{tag:f9.TRACER,name:f8.REMOTE_VIDEO_TRACK_GET_VIDEO_VISIBLE,options:[this.getTrackId()]});k.visible?L.onSuccess("Video is visible"):L.onSuccess("Invisible because of ".concat(k.reason))}return k}return}catch(L){throw new f2(f1.GET_VIDEO_ELEMENT_VISIBLE_ERROR,L.message)}}pipe(L){if(this.processor===L)return L;if(L._source)throw new f2(f1.INVALID_OPERATION,"Processor ".concat(L.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=L,this.processor._source=this,L.updateInput({track:this._originMediaStreamTrack,context:this.processorContext}),L}unpipe(){if(!this.processor)return;let L=this.processor;this.processor._source=void 0,this.processor=void 0,L.reset()}bindProcessorDestinationEvents(){this.processorDestination.on(gQ.ON_TRACK,async L=>{L?L!==this._mediaStreamTrack&&(this._mediaStreamTrack=L,this._updatePlayerSource()):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource())})}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(gQ.ON_TRACK)}_destroy(){this._prePlayer&&(this._prePlayer.destroy(),this._prePlayer=void 0),super._destroy(),this.unbindProcessorDestinationEvents()}_onSei(L){this.emit(gF.SEI_RECEIVED,L)}}).prototype,"play",[rZ],Object.getOwnPropertyDescriptor(r2.prototype,"play"),r2.prototype),sP(r2.prototype,"stop",[r$],Object.getOwnPropertyDescriptor(r2.prototype,"stop"),r2.prototype),sP(r2.prototype,"pipe",[r0],Object.getOwnPropertyDescriptor(r2.prototype,"pipe"),r2.prototype),sP(r2.prototype,"unpipe",[r1],Object.getOwnPropertyDescriptor(r2.prototype,"unpipe"),r2.prototype),r2),Tf=(r3=pD({argsMap:(L,k)=>[L.getTrackId(),k],throttleTime:300}),r5=pD({argsMap:(L,k)=>[L.getTrackId(),k]}),r4=pD({argsMap:L=>[L.getTrackId()]}),r6=pD({argsMap:L=>[L.getTrackId()]}),r8=pD({argsMap:(L,k)=>[L.getTrackId(),k.name]}),r9=pD({argsMap:L=>[L.getTrackId()]}),sP((r7=class extends Xk{get isPlaying(){return this._useAudioElement?To.isPlaying(this.getTrackId()):this._source.isPlayed}get __className__(){return"RemoteAudioTrack"}constructor(L,k,M,U){super(L,k,M,U),aP(this,"trackMediaType",gW.AUDIO),aP(this,"_source",void 0),aP(this,"_useAudioElement",!0),aP(this,"_volume",100),aP(this,"processorContext",void 0),aP(this,"processorDestination",void 0),aP(this,"_played",!1),aP(this,"_bypassWebAudio",!1),wN("DISABLE_WEBAUDIO")?(this._source=new HP,this._bypassWebAudio=!0,this._useAudioElement=!0):(this._source=new RP(L,!0),wN("REMOTE_AUDIO_TRACK_USES_WEB_AUDIO")&&(this._useAudioElement=!1)),this._source.once(gG.RECEIVE_TRACK_BUFFER,()=>{this.safeEmit(gj.FIRST_FRAME_DECODED)}),this.processorContext=new WP(this._source.context,this.getTrackId(),"remote"),this.processorDestination=new GP(this.processorContext),this.bindProcessorDestinationEvents(),this._source.on(gG.UPDATE_SOURCE,()=>{this.processor&&this.processor.updateInput({node:this._source.processSourceNode,context:this.processorContext})})}setAudioFrameCallback(L){let k=arguments.length>1&&void 0!==arguments[1]?arguments[1]:4096;if(!L)return this._source.removeAllListeners(gG.ON_AUDIO_BUFFER),void this._source.stopGetAudioBuffer();this._source.startGetAudioBuffer(k),this._source.removeAllListeners(gG.ON_AUDIO_BUFFER),this._source.on(gG.ON_AUDIO_BUFFER,k=>L(k))}setVolume(L){this._volume=L,this._useAudioElement?To.setVolume(this.getTrackId(),L):this._source.setVolume(L/100)}async setPlaybackDevice(L){if(!this._useAudioElement||!SD())throw new f2(f1.NOT_SUPPORTED,"your browser does not support setting the audio output device");await To.setSinkID(this.getTrackId(),L)}getVolumeLevel(){return this._source.getAccurateVolumeLevel()}getStats(){return mO(()=>{gc.warning("[deprecated] RemoteAudioTrack.getStats will be removed in the future, use AgoraRTCClient.getRemoteAudioStats instead")},"remoteAudioTrackGetStatsWarning"),aO(this,gN.GET_STATS)||dP({},gY)}play(){gc.debug("[".concat(this.getTrackId(),"] start audio playback")),this._played=!0,this._useAudioElement?(gc.debug("[".concat(this.getTrackId(),"] use audio element to play")),To.play(this._mediaStreamTrack,this.getTrackId(),this._volume,this.store.sessionId||void 0)):this._source.play()}stop(){gc.debug("[".concat(this.getTrackId(),"] stop audio playback")),this._played=!1,this._useAudioElement?To.stop(this.getTrackId()):this._source.stop()}_destroy(){super._destroy(),this._played=!1,this.unbindProcessorDestinationEvents(),this._source.destroy()}_isFreeze(){return this._source.isFreeze}_updatePlayerSource(){let L=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];gc.debug("[".concat(this.getTrackId(),"] update player source track")),L&&this._source.updateTrack(this._mediaStreamTrack),this._useAudioElement&&To.updateTrack(this.getTrackId(),this._mediaStreamTrack)}pipe(L){if(this._bypassWebAudio)throw new f2(f1.NOT_SUPPORTED,"can not pipe extension when WebAudio disabled");if(this.processor===L)return L;if(L._source)throw new f2(f1.INVALID_OPERATION,"Processor ".concat(L.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=L,this.processor._source=this,L.updateInput({track:this._originMediaStreamTrack,node:this._source.processSourceNode,context:this.processorContext}),L}unpipe(){var L;if(this._bypassWebAudio)throw new f2(f1.NOT_SUPPORTED,"can not unpipe extension when WebAudio disabled");if(!this.processor)return;let k=this.processor;null===(L=this._source.processSourceNode)||void 0===L||L.disconnect(),this.processor._source=!1,this.processor=void 0,k.reset()}bindProcessorDestinationEvents(){this.processorDestination.on(gQ.ON_TRACK,async L=>{L?L!==this._mediaStreamTrack&&(this._mediaStreamTrack=L,this._updatePlayerSource(!1),this._source.processedNode=this._source.createMediaStreamSourceNode(L)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource())}),this.processorDestination.on(gQ.ON_NODE,L=>{this._source.processedNode=L;let k=!L;this._useAudioElement!==k&&(this._played?(this.stop(),this._useAudioElement=k,this.play()):this._useAudioElement=k)})}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(gQ.ON_TRACK),this.processorDestination.removeAllListeners(gQ.ON_NODE)}}).prototype,"setVolume",[r3],Object.getOwnPropertyDescriptor(r7.prototype,"setVolume"),r7.prototype),sP(r7.prototype,"setPlaybackDevice",[r5],Object.getOwnPropertyDescriptor(r7.prototype,"setPlaybackDevice"),r7.prototype),sP(r7.prototype,"play",[r4],Object.getOwnPropertyDescriptor(r7.prototype,"play"),r7.prototype),sP(r7.prototype,"stop",[r6],Object.getOwnPropertyDescriptor(r7.prototype,"stop"),r7.prototype),sP(r7.prototype,"pipe",[r8],Object.getOwnPropertyDescriptor(r7.prototype,"pipe"),r7.prototype),sP(r7.prototype,"unpipe",[r9],Object.getOwnPropertyDescriptor(r7.prototype,"unpipe"),r7.prototype),r7),TS=new class extends Hw{get visibility(){return document.visibilityState}get lastHiddenTime(){return this._lastHiddenTime}get lastVisibleTime(){return this._lastVisibleTime}constructor(){super(),aP(this,"_lastHiddenTime",0),aP(this,"_lastVisibleTime",0),document.addEventListener("visibilitychange",()=>{"hidden"===document.visibilityState?this._lastHiddenTime=performance.now():this._lastVisibleTime=performance.now(),gc.debug("current web page is ".concat(document.visibilityState)),this.emit("VISIBILITY_CHANGE",document.visibilityState)})}};let $k=class $k extends Hw{constructor(L,k){super(),aP(this,"trackMediaType",gW.DATA),aP(this,"_version",1),aP(this,"_type",3),aP(this,"_config",void 0),aP(this,"_originDataChannel",void 0),aP(this,"_dataStreamPacketHeader",new ArrayBuffer(4)),aP(this,"_dataStreamPacketHandler",{serialize:L=>L,deserialize:L=>L}),aP(this,"_datachannelEventMap",new Map),this._config=L,k&&(this._originDataChannel=k,this._bandDataChannelEvents(k)),this._initPacketHeader()}useDataStream(L){this._dataStreamPacketHandler=L}get id(){return this._config.id}get ordered(){return this._config.ordered}get maxRetransmits(){return wN("DATASTREAM_MAX_RETRANSMITS")}get metadata(){return this._config.metadata}get readyState(){var L,k;return null!==(L=null===(k=this._originDataChannel)||void 0===k?void 0:k.readyState)&&void 0!==L?L:"connecting"}get _originDataChannelId(){var L,k;return null!==(L=null===(k=this._originDataChannel)||void 0===k?void 0:k.id)&&void 0!==L?L:null}getChannelId(){return this.id}getConfig(){return this._config}_close(){this._originDataChannel&&(this._unbindDataChannelEvents(this._originDataChannel),this._originDataChannel=void 0)}async _waitTillOpen(){return new lQ((L,k)=>{if(this._originDataChannel){"open"===this._originDataChannel.readyState&&L();let M=setTimeout(()=>{var L;k(new f2(f1.DATACHANNEL_CONNECTION_TIMEOUT,"Cannot create datachannel, id: ".concat(null===(L=this._originDataChannel)||void 0===L?void 0:L.id)))},1e4);this._originDataChannel.onopen=()=>{clearTimeout(M),this._originDataChannel&&this._bandDataChannelEvents(this._originDataChannel),L()},this._originDataChannel.onerror=()=>{throw clearTimeout(M),new f2(f1.DATACHANNEL_CONNECTION_TIMEOUT)}}else k(new f2(f1.DATACHANNEL_CONNECTION_TIMEOUT,"cannot find dataChannel"))})}_updateOriginDataChannel(L){this._originDataChannel=L,this._bandDataChannelEvents(L)}_initPacketHeader(){let L=new DataView(this._dataStreamPacketHeader);L.setUint16(0,this._version),L.setUint8(2,this._type),L.setUint8(3,this._config.id)}_bandDataChannelEvents(L){this._unbindDataChannelEvents(L),[g5.OPEN,g5.CLOSE,g5.ERROR].forEach(k=>{let i=()=>{this.emit(k)};this._datachannelEventMap.set(k,i),L.addEventListener(k,i)})}_unbindDataChannelEvents(L){Array.from(this._datachannelEventMap.entries()).forEach(k=>{let[M,U]=k;L.removeEventListener(M,U)}),this._datachannelEventMap.clear()}};let eM=class eM extends $k{constructor(L){super(L),aP(this,"_messageListener",void 0),this._messageListener=L=>{if(L.data.byteLength<this._dataStreamPacketHeader.byteLength)throw Error("invalid byteLength: the byte length must exceed "+this._dataStreamPacketHeader.byteLength);let k=L.data.slice(0,this._dataStreamPacketHeader.byteLength),M=new DataView(k).getUint8(3);if(M!==this.id)return void(wN("SHOW_DATASTREAM2_LOG")&&gc.debug("invalid datachannel id: ".concat(M," !== ").concat(this.id)));let U=L.data.slice(this._dataStreamPacketHeader.byteLength);U=this._dataStreamPacketHandler.deserialize(U),this.emit(g5.MESSAGE,U)}}_updateOriginDataChannel(L){super._updateOriginDataChannel(L),this._bandRemoteDataChannelEvents()}_close(){this._originDataChannel&&(this._originDataChannel.removeEventListener("message",this._messageListener),super._close())}_bandRemoteDataChannelEvents(){this._originDataChannel&&this._originDataChannel.addEventListener("message",this._messageListener)}};let tM=class tM extends $k{send(L){if(this._originDataChannel){let k=L;k=this._dataStreamPacketHandler.serialize(L);let M=new Uint8Array(this._dataStreamPacketHeader.byteLength+k.byteLength);M.set(new Uint8Array(this._dataStreamPacketHeader),0),M.set(new Uint8Array(k),this._dataStreamPacketHeader.byteLength),this._originDataChannel.send(M.buffer)}}};function iM(){let L=new Blob([atob("Y29uc3QgdD0idmlkZW8vaDI2NCIsZT0idmlkZW8vaDI2NSI7ZnVuY3Rpb24gbih0LGUsbil7bGV0IGE9bmV3IFVpbnQ4QXJyYXkodCxlLG4pLHI9W10sbz0wO2Zvcig7ci5sZW5ndGg8bjspbyszPG4mJjA9PT1hW29dJiYwPT09YVtvKzFdJiYzPT09YVtvKzJdJiYoMD09PWFbbyszXXx8MT09PWFbbyszXXx8Mj09PWFbbyszXXx8Mz09PWFbbyszXSk/KHIucHVzaChhW29dLGFbbysxXSxhW28rM10pLG8rPTQpOihyLnB1c2goYVtvXSksbysrKTtyZXR1cm4gbmV3IFVpbnQ4QXJyYXkocil9ZnVuY3Rpb24gYShhLHIpe3N3aXRjaChyKXtjYXNlIHQ6cmV0dXJuIGZ1bmN0aW9uKHQpe2NvbnN0IGU9bmV3IERhdGFWaWV3KHQuZGF0YSk7bGV0IGE9MDtmb3IoO2ErNDx0LmRhdGEuYnl0ZUxlbmd0aDspe2lmKDA9PT1lLmdldFVpbnQ4KGErMCkmJjA9PT1lLmdldFVpbnQ4KGErMSkmJjA9PT1lLmdldFVpbnQ4KGErMikmJjE9PT1lLmdldFVpbnQ4KGErMykmJjY9PT1lLmdldFVpbnQ4KGErNCkpe2xldCByPWErNixvPTAsaT0wO2Zvcig7MjU1PT09KGk9ZS5nZXRVaW50OChyKyspKTspbys9MjU1O28rPWk7Y29uc3Qgcz1uKHQuZGF0YSxyLG8pO3JldHVybiBuZXcgVWludDhBcnJheShzKX1hKyt9cmV0dXJuIG51bGx9KGEpO2Nhc2UgZTpyZXR1cm4gZnVuY3Rpb24odCl7Y29uc3QgZT1uZXcgRGF0YVZpZXcodC5kYXRhKTtsZXQgYT0wO2Zvcig7YSs1PHQuZGF0YS5ieXRlTGVuZ3RoOyl7aWYoMD09PWUuZ2V0VWludDgoYSswKSYmMD09PWUuZ2V0VWludDgoYSsxKSYmMD09PWUuZ2V0VWludDgoYSsyKSYmMT09PWUuZ2V0VWludDgoYSszKSYmNzg9PT1lLmdldFVpbnQ4KGErNCkmJjE9PT1lLmdldFVpbnQ4KGErNSkmJjEwMT09PWUuZ2V0VWludDgoYSs2KSl7bGV0IHI9YSs3LG89MCxpPTA7Zm9yKDsyNTU9PT0oaT1lLmdldFVpbnQ4KHIrKykpOylvKz0yNTU7bys9aTtjb25zdCBzPW4odC5kYXRhLHIsbyk7cmV0dXJuIG5ldyBVaW50OEFycmF5KHMpfWErK31yZXR1cm4gbnVsbH0oYSk7ZGVmYXVsdDpyZXR1cm4gbnVsbH19ZnVuY3Rpb24gcih0KXtjb25zdCBlPXQubGVuZ3RoO2xldCBuPVtdLGE9MDtmb3IoO2E8ZTspYSsyPGUmJjA9PT10W2FdJiYwPT09dFthKzFdJiYoMD09PXRbYSsyXXx8MT09PXRbYSsyXXx8Mj09PXRbYSsyXXx8Mz09PXRbYSsyXSk/KG4ucHVzaCh0W2FdLHRbYSsxXSwzLHRbYSsyXSksYSs9Myk6KG4ucHVzaCh0W2FdKSxhKyspO3JldHVybiBuZXcgVWludDhBcnJheShuKX1mdW5jdGlvbiBvKG4sYSxvKXtzd2l0Y2gobyl7Y2FzZSB0OnJldHVybiBmdW5jdGlvbih0LGUpe2NvbnN0IG49cihlKSxhPW4ubGVuZ3RoLG89TWF0aC5mbG9vcihhLzI1NSksaT1hJTI1NSxzPW5ldyBVaW50OEFycmF5KDYrbysxK2ErdC5ieXRlTGVuZ3RoKTtzWzBdPTAsc1sxXT0wLHNbMl09MCxzWzNdPTEsc1s0XT02LHNbNV09MTAxO2xldCBmPTA7Zm9yKDtmPG87KXNbNitmXT0yNTUsZisrO3JldHVybiBzWzYrZl09aSxmKysscy5zZXQobiw2K2YpLHMuc2V0KG5ldyBVaW50OEFycmF5KHQpLDYrZithKSxzLmJ1ZmZlcn0obixhKTtjYXNlIGU6cmV0dXJuIGZ1bmN0aW9uKHQsZSl7Y29uc3Qgbj1yKGUpLGE9bi5sZW5ndGgsbz1NYXRoLmZsb29yKGEvMjU1KSxpPWElMjU1LHM9bmV3IFVpbnQ4QXJyYXkoNytvKzErYSsxK3QuYnl0ZUxlbmd0aCk7c1swXT0wLHNbMV09MCxzWzJdPTAsc1szXT0xLHNbNF09Nzgsc1s1XT0xLHNbNl09MTAxO2xldCBmPTA7Zm9yKDtmPG87KXNbNytmXT0yNTUsZisrO3JldHVybiBzWzcrZl09aSxmKysscy5zZXQobiw3K2YpLGYrPWEsc1s3K2ZdPTEyOCxmKysscy5zZXQobmV3IFVpbnQ4QXJyYXkodCksNytmKSxzLmJ1ZmZlcn0obixhKTtkZWZhdWx0OnJldHVybiBudWxsfX1mdW5jdGlvbiBpKG4pe2lmKG4ubGVuZ3RoPDUpcmV0dXJuIiI7bGV0IGE9LTE7Zm9yKGxldCB0PTA7dDxuLmxlbmd0aC0zO3QrKyl7aWYoMD09PW5bdF0mJjA9PT1uW3QrMV0mJjE9PT1uW3QrMl0pe2E9dDticmVha31pZih0PG4ubGVuZ3RoLTQmJjA9PT1uW3RdJiYwPT09blt0KzFdJiYwPT09blt0KzJdJiYxPT09blt0KzNdKXthPXQ7YnJlYWt9fWlmKC0xPT09YSlyZXR1cm4iIjtjb25zdCByPWErKDA9PT1uW2ErMl0/NDozKTtpZihyPj1uLmxlbmd0aClyZXR1cm4iIjtjb25zdCBvPW5bcl07aWYoMTI4Jm8pcmV0dXJuIiI7aWYoKG8+PjEmNjMpPj0zMilyZXR1cm4gZTtpZihyKzE8bi5sZW5ndGgpe2lmKDA9PSgyNDgmbltyKzFdKSlyZXR1cm4gZX1yZXR1cm4oMzEmbyk8PTMxP3Q6IiJ9Y29uc3Qgcz03MSxmPTEsbD0yLHU9MSxnPTI7dmFyIGM7ZnVuY3Rpb24gZCh0LGU9ITEpe2NvbnN0IG49dC5nZXRVaW50OCgwKTtpZihuIT09cylyZXR1cm47Y29uc3QgYT10LmdldFVpbnQxNigxKSxyPWYrbCthLG89bmV3IFVpbnQ4QXJyYXkodC5ieXRlTGVuZ3RoLXIpO28uc2V0KG5ldyBVaW50OEFycmF5KHQuYnVmZmVyLHIsdC5ieXRlTGVuZ3RoLXIpKTtjb25zdCBpPXttOm4sdGx2TGVuOmEsdGx2OltdLGZyYW1lOm99O2xldCBkPWYrbDtmb3IoO2Q8cjspe2NvbnN0IG49dC5nZXRVaW50OChkKSxhPXQuZ2V0VWludDE2KGQrdSkscj11K2c7aWYobj09PWMuQVVESU9fTEVWRUwpe2xldCBvPXQuZ2V0VWludDgoZCtyKTtmb3IobGV0IGU9MTtlPGE7ZSsrKW89bzw8OHx0LmdldFVpbnQ4KGQrcitlKTtpLnRsdi5wdXNoKHt0YWc6bixsZW5ndGg6YSx2YWx1ZTplPzEyN15vPj4xOjEyNyZvfSl9ZWxzZSBpZihuPT09Yy5NRVRBREFUQXx8bj09PWMuQVVESU9fNjRfQklUX1BUUyl7Y29uc3QgZT1uZXcgVWludDhBcnJheShhKTtmb3IobGV0IG49MDtuPGE7bisrKWVbbl09dC5nZXRVaW50OChkK3Irbik7aS50bHYucHVzaCh7dGFnOm4sbGVuZ3RoOmEsdmFsdWU6ZX0pfWQrPXIrYX1yZXR1cm4gaX0hZnVuY3Rpb24odCl7dFt0LkFVRElPX0xFVkVMPTFdPSJBVURJT19MRVZFTCIsdFt0Lk1FVEFEQVRBPTJdPSJNRVRBREFUQSIsdFt0LkFVRElPXzY0X0JJVF9QVFM9M109IkFVRElPXzY0X0JJVF9QVFMifShjfHwoYz17fSkpLHNlbGYub25ydGN0cmFuc2Zvcm09dD0+e2NvbnN0IGU9dC50cmFuc2Zvcm1lcjtsZXQgbj1bXSxyPVtdO2Uub3B0aW9ucy5wb3J0Lm9ubWVzc2FnZT10PT57dC5kYXRhLnNlaSYmbi5wdXNoKHQuZGF0YS5zZWkpLHQuZGF0YS5tZXRhZGF0YSYmci5wdXNoKHQuZGF0YS5tZXRhZGF0YSl9LHNlbGYucG9zdE1lc3NhZ2UoInN0YXJ0ZWQiKTtjb25zdCBoPWUucmVhZGFibGUuZ2V0UmVhZGVyKCksVT1lLndyaXRhYmxlLmdldFdyaXRlcigpOyJzZWktcngiPT09ZS5vcHRpb25zLm5hbWU/ZnVuY3Rpb24gdChlKXtoLnJlYWQoKS50aGVuKChuPT57aWYoIW4uZG9uZSl7aWYobi52YWx1ZSBpbnN0YW5jZW9mIFJUQ0VuY29kZWRWaWRlb0ZyYW1lKXtjb25zdCB0PWkobmV3IFVpbnQ4QXJyYXkobi52YWx1ZS5kYXRhKSkscj1hKG4udmFsdWUsdCk7ciYmZS5vcHRpb25zLnBvcnQucG9zdE1lc3NhZ2Uoe3NlaTpyfSl9VS53cml0ZShuLnZhbHVlKSxlLm9wdGlvbnMucG9ydC5wb3N0TWVzc2FnZSh7dHJhbnNmb3JtZWQ6ITB9KSx0KGUpfX0pKX0oZSk6InNlaS10eCI9PT1lLm9wdGlvbnMubmFtZT9mdW5jdGlvbiB0KGUpe2gucmVhZCgpLnRoZW4oKGE9PntpZighYS5kb25lKXtpZihhLnZhbHVlIGluc3RhbmNlb2YgUlRDRW5jb2RlZFZpZGVvRnJhbWUpe2NvbnN0IHQ9aShuZXcgVWludDhBcnJheShhLnZhbHVlLmRhdGEpKSxlPW4uc2hpZnQoKTtpZihlKXtjb25zdCBuPW8oYS52YWx1ZS5kYXRhLGUsdCk7biYmKGEudmFsdWUuZGF0YT1uKX19VS53cml0ZShhLnZhbHVlKSxlLm9wdGlvbnMucG9ydC5wb3N0TWVzc2FnZSh7dHJhbnNmb3JtZWQ6ITB9KSx0KGUpfX0pKX0oZSk6ImF1ZGlvLW1ldGFkYXRhLXJ4Ij09PWUub3B0aW9ucy5uYW1lP2Z1bmN0aW9uIHQoZSl7aC5yZWFkKCkudGhlbigobj0+e2lmKCFuLmRvbmUpe2lmKG4udmFsdWUgaW5zdGFuY2VvZiBSVENFbmNvZGVkQXVkaW9GcmFtZSl7Y29uc3QgdD1uZXcgRGF0YVZpZXcobi52YWx1ZS5kYXRhKSxhPXQuZ2V0VWludDgoMCk7bGV0IHI7aWYoMCE9KDEyOCZhKSYmNzEhPT1hKXtsZXQgZT1mdW5jdGlvbih0KXtpZih0LmJ5dGVMZW5ndGg8PTApcmV0dXJuW107Y29uc3QgZT1bXTtsZXQgbj0wO2Zvcig7bjx0LmJ5dGVMZW5ndGg7KXtjb25zdCBhPSgxMjgmdC5nZXRVaW50OChuKSk+Pjcscj0xMjcmdC5nZXRVaW50OChuKTtpZighKGEmJm4rNDw9dC5ieXRlTGVuZ3RoKSl7bisrO2JyZWFrfXtjb25zdCBhPXQuZ2V0VWludDMyKG4sITEpLG89KDE2Nzc2MTkyJmEpPj4xMCxpPTEwMjMmYTtlLnB1c2goe3B0OnIsdHNfb2Zmc2V0Om8sbGVuZ3RoOmksZGF0YTpuZXcgVWludDhBcnJheX0pLG4rPTR9fWxldCBhPXQuYnl0ZUxlbmd0aC1uO2Zvcihjb25zdCByIG9mIGUpe2lmKHIubGVuZ3RoPmEpcmV0dXJuIGNvbnNvbGUud2FybigiQnJva2VuIHJlZCBwYXlsb2FkIiksW107ci5sZW5ndGg+MCYmKHIuZGF0YT1uZXcgVWludDhBcnJheSh0LmJ1ZmZlcix0LmJ5dGVPZmZzZXQrbixyLmxlbmd0aCksbis9ci5sZW5ndGgsYS09ci5sZW5ndGgpfWlmKGE+MCl7Y29uc3Qgcj17cHQ6ZS5sZW5ndGg+MD9lW2UubGVuZ3RoLTFdLnB0OjAsdHNfb2Zmc2V0OjAsbGVuZ3RoOmEsZGF0YTpuZXcgVWludDhBcnJheSh0LmJ1ZmZlcix0LmJ5dGVPZmZzZXQrbixhKX07ZS5wdXNoKHIpfXJldHVybiBlfSh0KTtpZihlLmxlbmd0aD4wKXtjb25zdCB0PWZ1bmN0aW9uKHQpe2xldCBlPTA7Zm9yKGxldCBuPTA7bjx0Lmxlbmd0aDtuKyspZSs9bjx0Lmxlbmd0aC0xPzQ6MSxlKz10W25dLmxlbmd0aDtjb25zdCBuPW5ldyBVaW50OEFycmF5KGUpO2xldCBhPTA7Zm9yKGxldCBlPTA7ZTx0Lmxlbmd0aDtlKyspaWYoZTx0Lmxlbmd0aC0xKXtjb25zdCByPSgyMTQ3NDgzNjQ4fCgxMjcmdFtlXS5wdCk8PDI0fCgyNjIxNDMmdFtlXS50c19vZmZzZXQpPDwxMHwxMDIzJnRbZV0ubGVuZ3RoKT4+PjA7blthKytdPXI+PjI0JjI1NSxuW2ErK109cj4+MTYmMjU1LG5bYSsrXT1yPj44JjI1NSxuW2ErK109MjU1JnJ9ZWxzZSBuW2ErK109MTI3JnRbZV0ucHQ7Zm9yKGNvbnN0IGUgb2YgdCluLnNldChlLmRhdGEsYSksYSs9ZS5sZW5ndGg7cmV0dXJuIG59KGUubWFwKCh0PT57bGV0IGU9bmV3IFVpbnQ4QXJyYXkodC5sZW5ndGgpO2Uuc2V0KHQuZGF0YSk7Y29uc3Qgbj1kKG5ldyBEYXRhVmlldyhlLmJ1ZmZlcikpO3JldHVybiBuPy5mcmFtZSYmKHQuZGF0YT1uPy5mcmFtZSkscj1uLHR9KSkpO24udmFsdWUuZGF0YT10LmJ1ZmZlcn19ZWxzZSByPWQodCksciYmKG4udmFsdWUuZGF0YT1yLmZyYW1lLmJ1ZmZlcik7aWYocil7bGV0IHQ9ci50bHYuZmluZCgodD0+dC50YWc9PT1jLk1FVEFEQVRBKSk7aWYodCYmdC52YWx1ZSBpbnN0YW5jZW9mIFVpbnQ4QXJyYXkmJmUub3B0aW9ucy5wb3J0LnBvc3RNZXNzYWdlKHttZXRhZGF0YTp0LnZhbHVlfSksdD1yLnRsdi5maW5kKCh0PT50LnRhZz09PWMuQVVESU9fNjRfQklUX1BUUykpLHQmJnQudmFsdWUgaW5zdGFuY2VvZiBVaW50OEFycmF5JiY4PT10LnZhbHVlLmxlbmd0aCl7Y29uc3Qgbj1uZXcgRGF0YVZpZXcodC52YWx1ZS5idWZmZXIpLmdldEJpZ1VpbnQ2NCgwLCEwKTt0JiZ0LnZhbHVlIGluc3RhbmNlb2YgVWludDhBcnJheSYmZS5vcHRpb25zLnBvcnQucG9zdE1lc3NhZ2Uoe3B0czpufSl9fX1VLndyaXRlKG4udmFsdWUpLGUub3B0aW9ucy5wb3J0LnBvc3RNZXNzYWdlKHt0cmFuc2Zvcm1lZDohMH0pLHQoZSl9fSkpfShlKToiYXVkaW8tbWV0YWRhdGEtdHgiPT09ZS5vcHRpb25zLm5hbWUmJmZ1bmN0aW9uIHQoZSl7aC5yZWFkKCkudGhlbigobj0+e2lmKCFuLmRvbmUpe2lmKGUub3B0aW9ucy5wb3J0LnBvc3RNZXNzYWdlKHtnZXRNZXRhZGF0YTohMH0pLG4udmFsdWUgaW5zdGFuY2VvZiBSVENFbmNvZGVkQXVkaW9GcmFtZSl7Y29uc3QgdD1yLnNoaWZ0KCk7dCYmKG4udmFsdWUuZGF0YT1mdW5jdGlvbih0LGUsbil7Y29uc3QgYT1uLmJ5dGVMZW5ndGgscj1hK3UrZyxvPWYrbCtyLGk9bmV3IEFycmF5QnVmZmVyKHQuYnl0ZUxlbmd0aCtvKSxjPW5ldyBEYXRhVmlldyhpKTtjLnNldFVpbnQ4KDAscyksYy5zZXRVaW50MTYoMSxyKSxjLnNldFVpbnQ4KDMsZSksYy5zZXRVaW50MTYoNCxhKTtmb3IobGV0IHQ9MDt0PGE7dCsrKWMuc2V0VWludDgoNit0LG5bdF0pO2NvbnN0IGQ9bmV3IFVpbnQ4QXJyYXkoYy5idWZmZXIpO3JldHVybiBkLnNldChuZXcgVWludDhBcnJheSh0KSxvKSxkLmJ1ZmZlcn0obi52YWx1ZS5kYXRhLGMuQVVESU9fNjRfQklUX1BUUyx0KSl9VS53cml0ZShuLnZhbHVlKSxlLm9wdGlvbnMucG9ydC5wb3N0TWVzc2FnZSh7dHJhbnNmb3JtZWQ6ITB9KSx0KGUpfX0pKX0oZSl9LHNlbGYucG9zdE1lc3NhZ2UoInJlZ2lzdGVyZWQiKTsK")],{type:"text/javascript"});return setTimeout(()=>p7.revokeObjectURL(L),0),new Worker(p7.createObjectURL(L))}var Tg=((e7=Tg||{})[e7.AUDIO_LEVEL=1]="AUDIO_LEVEL",e7[e7.METADATA=2]="METADATA",e7[e7.AUDIO_64_BIT_PTS=3]="AUDIO_64_BIT_PTS",e7);function dM(L){let k=arguments.length>1&&void 0!==arguments[1]&&arguments[1],M=L.getUint8(0);if(71!==M)return;let U=L.getUint16(1),V=3+U,F=new Uint8Array(L.byteLength-V);F.set(new Uint8Array(L.buffer,V,L.byteLength-V));let B={m:M,tlvLen:U,tlv:[],frame:F},j=3;for(;j<V;){let M=L.getUint8(j),U=L.getUint16(j+1);if(M===Tg.AUDIO_LEVEL){let V=L.getUint8(j+3);for(let k=1;k<U;k++)V=V<<8|L.getUint8(j+3+k);B.tlv.push({tag:M,length:U,value:k?127^V>>1:127&V})}else if(M===Tg.METADATA||M===Tg.AUDIO_64_BIT_PTS){let k=new Uint8Array(U);for(let M=0;M<U;M++)k[M]=L.getUint8(j+3+M);B.tlv.push({tag:M,length:U,value:k})}j+=3+U}return B}let TT=new Map,Tv=139/13,TC=new Map;function EM(L,k,M){let U="".concat(L,"-").concat(k,"-").concat(M),V=0;return TC.has(U)?V=TC.get(U):(V=Math.log(function(L,k){let M=L-k;k<M&&(k=M);let U=1;for(let M=L,V=1;M>k;M--,V++)U=U*M/V;return U}(k,L))+L*Math.log(.5)+(k-L)*Math.log(.5)-Math.log(M)+M*L,TC.set(U,V)),V<1e-10&&(V=1e-10),V}function mM(L,k,M){let U=k.length,V=L.length/U,F=!1;for(let B=0,j=0;B<U;B++){let U=0;for(let k=j+V;j<k;j++)L[j]>M&&U++;k[B]!==U&&(k[B]=U,F=!0)}return F}window.cache=TC;let Ty=0;let SM=class SM{constructor(L){aP(this,"id",void 0),aP(this,"immediates",[]),aP(this,"lastNonSilence",-1),aP(this,"immediateSpeechActivityScore",1e-10),aP(this,"lastLevelChangedTime",Date.now()),aP(this,"levels",[]),aP(this,"longs",[]),aP(this,"longSpeechActivityScore",1e-10),aP(this,"mediums",[]),aP(this,"mediumSpeechActivityScore",1e-10),aP(this,"minLevel",0),aP(this,"nextMinLevel",0),aP(this,"nextMinLevelWindowLength",0),aP(this,"energyScore",0),this.id=L||"".concat(Ty++),this.immediates.length=50,this.mediums.length=10,this.longs.length=1,this.levels.length=this.immediates.length}computeImmediates(){let L=this.immediates,k=this.levels,M=this.minLevel+Tv,U=!1;for(let V=0;V<L.length;++V){let F=k[V];F<M&&(F=0);let B=Math.floor(F/Tv);L[V]!==B&&(L[V]=B,U=!0)}return U}computeLongs(){return mM(this.mediums,this.longs,4)}computeMediums(){return mM(this.immediates,this.mediums,7)}evaluateImmediateSpeechActivityScore(){this.immediateSpeechActivityScore=EM(this.immediates[0],13,.78)}evaluateLongSpeechActivityScore(L){this.longSpeechActivityScore=EM(this.longs[0],10,47),this.longSpeechActivityScore>1e-10&&(this.lastNonSilence=L)}evaluateMediumSpeechActivityScore(){this.mediumSpeechActivityScore=EM(this.mediums[0],5,24)}evaluateSpeechActivityScores(L){this.computeImmediates()&&(this.evaluateImmediateSpeechActivityScore(),this.computeMediums()&&(this.evaluateMediumSpeechActivityScore(),this.computeLongs()&&this.evaluateLongSpeechActivityScore(L)))}getLastLevelChangedTime(){return this.lastLevelChangedTime}getLevels(){var L;return"[".concat(sI(L=[...this.levels]).call(L).join(),"]")}getSpeechActivityScore(L){switch(L){case 0:return this.immediateSpeechActivityScore;case 1:return this.mediumSpeechActivityScore;case 2:return this.longSpeechActivityScore;default:throw Error("interval "+L)}}levelChanged(L,k){if(this.lastLevelChangedTime<=k){this.lastLevelChangedTime=k;let M=L;return L<0&&(M=0),L>127&&(M=127),this.levels.unshift(M),this.levels.length>this.immediates.length&&this.levels.pop(),this.updateMinLevel(M),M>=this.minLevel+Tv?M:M/2}return -1}levelTimedOut(){this.levelChanged(0,this.lastLevelChangedTime)}updateMinLevel(L){if(0!==L){if(0===this.minLevel||this.minLevel>L)return this.minLevel=L,this.nextMinLevel=0,void(this.nextMinLevelWindowLength=0);if(0===this.nextMinLevel)return this.nextMinLevel=L,void(this.nextMinLevelWindowLength=1);if(this.nextMinLevel>L&&(this.nextMinLevel=L),this.nextMinLevelWindowLength++,this.nextMinLevelWindowLength>=750){let L=Math.sqrt(this.minLevel*this.nextMinLevel);L<0?L=0:L>127&&(L=127),this.minLevel=L,this.nextMinLevel=0,this.nextMinLevelWindowLength=0}}}};let gM=class gM{constructor(L){aP(this,"algorithm",void 0),this.algorithm=L}execute(){let L=!this.algorithm;if(!L)try{let k=this.algorithm.runInDecisionMaker(this);k<=0?L=!0:setTimeout(this.execute.bind(this),k)}catch(k){L=!0}L&&this.algorithm&&this.algorithm.decisionMakerExited(this)}};let TM=class TM{constructor(L,k,M){aP(this,"isDominant",void 0),aP(this,"energyRanking",void 0),aP(this,"energyScore",void 0),this.isDominant=L,this.energyRanking=k,this.energyScore=M}};let RM=class RM extends Hw{constructor(L){super(),aP(this,"dominantId",null),aP(this,"lastDecisionTime",0),aP(this,"lastLevelChangedTime",0),aP(this,"lastLevelIdleTime",0),aP(this,"relativeSpeechActivities",[]),aP(this,"speakers",new Map),aP(this,"enableSilence",!1),aP(this,"timeoutToSilenceInterval",0),aP(this,"decisionMaker",null),aP(this,"loudest",[]),aP(this,"numLoudestToTrack",3),aP(this,"energyExpireTimeMs",250),aP(this,"energyAlphaPct",50),this.timeoutToSilenceInterval=L,this.enableSilence=L>0,this.relativeSpeechActivities.length=3}setLoudestConfig(){let L=arguments.length>0&&void 0!==arguments[0]?arguments[0]:3,k=arguments.length>1?arguments[1]:void 0,M=arguments.length>2?arguments[2]:void 0;this.numLoudestToTrack=L,null!=k&&(this.energyExpireTimeMs=k),null!=M&&(this.energyAlphaPct=M),this.loudest.length>L&&this.loudest.splice(L)}getDominantSpeaker(){return this.dominantId}isAmongLoudest(L){return this.loudest.some(k=>k.id===L)}levelChanged(L,k){let M=Date.now(),U=this.getOrCreateSpeaker(L);this.lastLevelChangedTime<M&&(this.lastLevelChangedTime=M,this.maybeStartDecisionMaker());let V=U.levelChanged(k,M);return this.updateLoudestList(U,V,M)}runInDecisionMaker(L){return this.decisionMaker!==L||this.lastDecisionTime>0&&this.lastDecisionTime-this.lastLevelChangedTime>=15e3?-1:this._runInDecisionMaker()}decisionMakerExited(L){this.decisionMaker===L&&(this.decisionMaker=null)}destroy(){this.decisionMaker=null,this.loudest.length=0,this.speakers.clear(),this.removeAllListeners()}addSpeakers(L){L.forEach(L=>{this.speakers.has(L.id)||this.speakers.set(L.id,L)})}removeSpeakers(L){L.forEach(L=>{this.speakers.delete(L.id)})}getOrCreateSpeaker(L){let k=this.speakers.get(L);return k||(k=new SM(L),this.speakers.set(L,k),this.maybeStartDecisionMaker()),k}updateLoudestList(L,k,M){let U=L.id===this.dominantId;if(k<0){let k=0;for(;k<this.loudest.length&&this.loudest[k]!==L;)++k;return new TM(U,k,L.energyScore)}if(L.energyScore=Math.floor((this.energyAlphaPct*k+(100-this.energyAlphaPct)*L.energyScore+50)/100),0===this.numLoudestToTrack)return new TM(U,0,L.energyScore);let V=M-this.energyExpireTimeMs,F=0;for(;F<this.loudest.length;){let k=this.loudest[F];if(k.getLastLevelChangedTime()<V&&this.loudest.length>=this.numLoudestToTrack)this.loudest.splice(F,1);else if(k.id!==L.id)++F;else if(this.loudest.splice(F,1),this.loudest.length<this.numLoudestToTrack)break}let B=0;for(;B<this.loudest.length&&!(this.loudest[B].energyScore<L.energyScore);)++B;return B<this.numLoudestToTrack&&(this.loudest.splice(B,0,L),this.loudest.length>this.numLoudestToTrack&&this.loudest.splice(this.numLoudestToTrack,1)),new TM(U,B,L.energyScore)}maybeStartDecisionMaker(){!this.decisionMaker&&this.speakers.size>0&&(this.decisionMaker=new gM(this),this.decisionMaker.execute())}makeDecision(L){let k=null,M=null,U=this.speakers.size,V=null;if(0===U)V=null;else if(1===U){var F;let k=l1(F=this.speakers).call(F).next().value;this.enableSilence&&k&&(V=k.id,k.evaluateSpeechActivityScores(L),L-k.lastNonSilence>this.timeoutToSilenceInterval&&(V=null))}else{let k=null==this.dominantId?null:this.speakers.get(this.dominantId);if(null==k){let L=this.speakers.entries().next();L.value&&(V=L.value[0],k=L.value[1])}else V=k.id;null!=k&&k.evaluateSpeechActivityScores(L);let M=this.relativeSpeechActivities,U=2;for(let F of this.speakers.entries()){let[B,j]=F;if(j===k)continue;j.evaluateSpeechActivityScores(L);for(let L=0;L<M.length;++L){let U=null==k?1e-10:k.getSpeechActivityScore(L);M[L]=Math.log(j.getSpeechActivityScore(L)/U)}let G=M[0],X=M[1],$=M[2];G>3&&X>2&&$>0&&X>U&&(U=X,V=B)}this.enableSilence&&null!=k&&V===k.id&&L-k.lastNonSilence>this.timeoutToSilenceInterval&&(V=null)}(null!=V||this.enableSilence)&&V!==this.dominantId&&(k=this.dominantId,this.dominantId=V,M=this.dominantId),(null!=M||this.enableSilence)&&M!==k&&this.emit("ActiveSpeakerChanged",M)}_runInDecisionMaker(){let L=Date.now(),k=300-(L-this.lastLevelIdleTime),M=0;k<=0?(0!==this.lastLevelIdleTime&&this.timeoutIdleLevels(L),this.lastLevelIdleTime=L):M=k;let U=300-(L-this.lastDecisionTime);return U<=0&&(this.lastDecisionTime=L,this.makeDecision(L),U=300-(Date.now()-L)),U>0&&M>U&&(M=U),M}timeoutIdleLevels(L){let k=[];for(let U of l1(M=this.speakers).call(M)){var M;let V=L-U.getLastLevelChangedTime();36e5<V&&(null==this.dominantId||U.id!==this.dominantId)?k.push(U.id):300<V&&U.levelTimedOut()}k.forEach(L=>this.speakers.delete(L))}};let Tb=new Map,TN=null,TL=null,Tk=[],TU=new Map,TV=new Map;let OM=class OM{get samples(){return this.actives+this.inactives}get activeRate(){return this.actives/this.samples}constructor(L,k){aP(this,"id",void 0),aP(this,"track",void 0),aP(this,"score",0),aP(this,"active",!0),aP(this,"muted",!1),aP(this,"timer",0),aP(this,"actives",0),aP(this,"inactives",0),this.id=L,this.track=k,this.setActive(TU.size<3)}autoCheckActive(){this.autoSetActive(),this.autoAdjustActive(),this.resetTimer(),this.actives=0,this.inactives=0}autoSetActive(){let L=this.active;this.active=this.activeRate>=.8;let{actives:k,inactives:M}=function(){let L=[],k=[];return Array.from(l1(TU).call(TU)).forEach(M=>{M.active?L.push(M):k.push(M)}),{actives:L,inactives:k}}();if(k.length>3){let L;k.forEach(k=>{(!L||L.score>k.score)&&(L=k)}),L&&L.setActive(!1)}if(k.length<3&&M.length>0){let k;M.forEach(L=>{(!k||k.score<L.score)&&L.id!==this.id&&(k=L)}),k&&L&&!this.active&&(k.samples>40&&k.activeRate-this.activeRate>.4?k.setActive(!0):this.active=!0)}this.setMuted(!this.active)}setActive(L){this.active=L,this.resetTimer(),this.setMuted(!L)}autoAdjustActive(){this.active?this.autoSwitchToInactive():this.autoSwitchToActive()}autoSwitchToActive(){var L;let k;let M=(L=this.id,Array.from(l1(TU).call(TU)).forEach(M=>{!M.active||M.id===L||M.samples<40||(!k||M.score<k.score)&&(k=M)}),k);M&&this.activeRate-M.activeRate>.4&&(M.setActive(!1),this.setActive(!0))}autoSwitchToInactive(){var L;let k;let M=(L=this.id,Array.from(l1(TU).call(TU)).forEach(M=>{M.active||M.id===L||M.samples<40||(!k||M.score>k.score)&&(k=M)}),k);M&&M.activeRate-this.activeRate>.4&&(M.setActive(!0),this.setActive(!1))}addSample(L){L?this.actives+=1:this.inactives+=1,this.samples>66.66666666666667&&this.autoCheckActive()}setMuted(L){this.track&&(this.track.enabled=!L,this.muted=L)}resetTimer(){this.clearTimer(),this.timer=window.setTimeout(()=>{if(0!==this.samples)return this.samples<50?this.resetTimer():void this.autoCheckActive()},1e3)}clearTimer(){this.timer&&(clearTimeout(this.timer),this.timer=0)}};function DM(L){let k=TU.get(L);k&&(TU.delete(L),k.clearTimer())}let Tj=new Map,TW=new Map,TG="video/h264",TH="video/h265";function UM(L,k,M){let U=new Uint8Array(L,k,M),V=[],F=0;for(;V.length<M;)F+3<M&&0===U[F]&&0===U[F+1]&&3===U[F+2]&&(0===U[F+3]||1===U[F+3]||2===U[F+3]||3===U[F+3])?(V.push(U[F],U[F+1],U[F+3]),F+=4):(V.push(U[F]),F++);return new Uint8Array(V)}function VM(L){let k=L.length,M=[],U=0;for(;U<k;)U+2<k&&0===L[U]&&0===L[U+1]&&(0===L[U+2]||1===L[U+2]||2===L[U+2]||3===L[U+2])?(M.push(L[U],L[U+1],3,L[U+2]),U+=3):(M.push(L[U]),U++);return new Uint8Array(M)}function xM(L){if(L.length<5)return"";let k=-1;for(let M=0;M<L.length-3;M++)if(0===L[M]&&0===L[M+1]&&1===L[M+2]||M<L.length-4&&0===L[M]&&0===L[M+1]&&0===L[M+2]&&1===L[M+3]){k=M;break}if(-1===k)return"";let M=k+(0===L[k+2]?4:3);if(M>=L.length)return"";let U=L[M];return 128&U?"":(U>>1&63)>=32||M+1<L.length&&0==(248&L[M+1])?TH:(31&U)<=31?TG:""}let TK=new Map,TJ=new Map;!function(){let L=zA();gf.getDisplayMedia=!(!navigator.mediaDevices||!navigator.mediaDevices.getDisplayMedia),gf.getStreamFromExtension=L.name===fQ.CHROME&&Number(L.version)>34,gf.supportUnifiedPlan=function(){if(!window.RTCRtpTransceiver||!("currentDirection"in RTCRtpTransceiver.prototype))return!1;let L=new RTCPeerConnection,k=!1;try{L.addTransceiver("audio"),k=!0}catch(L){}return L.close(),k}(),gf.supportMinBitrate=L.name===fQ.CHROME||L.name===fQ.EDGE,gf.supportSetRtpSenderParameters=function(){let L=zA();return!!(window.RTCRtpSender&&window.RTCRtpSender.prototype.setParameters&&window.RTCRtpSender.prototype.getParameters)&&(!!vw()||!(!$A()&&!ZA())||L.name===fQ.FIREFOX&&Number(L.version)>=64)}(),L.name===fQ.SAFARI&&(Number(L.version)>=14?gf.supportDualStream=!0:gf.supportDualStream=!1),gf.webAudioMediaStreamDest=function(){let L=zA();return!(L.name===fQ.SAFARI&&12>Number(L.version))}(),gf.supportReplaceTrack=!!window.RTCRtpSender&&"function"==typeof RTCRtpSender.prototype.replaceTrack,gf.supportWebGL="undefined"!=typeof WebGLRenderingContext,gf.supportRequestFrame=!!window.CanvasCaptureMediaStreamTrack,vw()||(gf.webAudioWithAEC=!0),gf.supportShareAudio=function(){let L=zA();return(L.os===fX.WIN_10||L.os===fX.WIN_81||L.os===fX.WIN_7||L.os===fX.LINUX||L.os===fX.MAC_OS||L.os===fX.CHROMIUM_OS)&&L.name===fQ.CHROME&&Number(L.version)>=74}(),gf.supportDataChannel=!!(rw(76)||cw(68)||dw(14)),gf.supportPCSetConfiguration=function(){let L=window.RTCPeerConnection;return!iw()&&!!L&&L.prototype.setConfiguration instanceof Function}(),gf.supportWebRTCEncodedTransform=rw(87)||ew()||cw(117),gf.supportWebRTCInsertableStream=function(){let L=zA();return(L.name===fQ.CHROME||L.name===fQ.EDGE)&&Number(L.version)>=94&&"MediaStreamTrackGenerator"in window&&"MediaStreamTrackProcessor"in window}(),gf.supportRequestVideoFrameCallback="requestVideoFrameCallback"in HTMLVideoElement.prototype,gf.supportWebCrypto="undefined"!=typeof window&&void 0!==window.crypto&&void 0!==window.crypto.subtle,hO(()=>{gf.supportDualStreamEncoding=function(){let L=zA();return!!wN("DISABLE_WEBAUDIO")||"Safari"===L.name&&Number(L.version)>=14||!!("Chrome"===L.name&&/Windows/i.test(L.os||"")&&Number(L.version)>=100&&wN("CHROME_DUAL_STREAM_USE_ENCODING"))}(),gc.debug("browser ua: ",navigator.userAgent),gc.info("browser info: ",L),gc.info("browser compatibility: ",gf)})}();let TX=["CHINA","GLOBAL"],TQ=[[0,1,2,3,4,5,5],[0,2,2,3,4,5,5],[0,3,3,3,4,5,5],[0,4,4,4,4,5,5],[0,5,5,5,5,5,5]],TZ=[],T$=[];function KM(L,k){return!!k&&TZ.some(M=>M.uid===L&&M.channelName===k)}function YM(){return T$.length>0}var T0=Eb.forEach,T1=Wn("forEach")?[].forEach:function(L){return T0(this,L,arguments.length>1?arguments[1]:void 0)};Oi({target:"Array",proto:!0,forced:[].forEach!==T1},{forEach:T1});var T2=Qi("Array","forEach"),T3=Array.prototype,T5={DOMTokenList:!0,NodeList:!0},T4=i(function(L){var k=L.forEach;return L===T3||al(T3,L)&&k===T3.forEach||or(T5,o7(L))?T2:k});Oi({target:"Object",stat:!0,forced:n(function(){sX(1)})},{keys:function(L){return sX(Je(L))}});var T6=i(aB.Object.keys),T8=i(ir),T9=i(Er),T7=jR("slice"),Re=pt("species"),Ri=Array,Rr=Math.max;Oi({target:"Array",proto:!0,forced:!T7},{slice:function(L,k){var M,U,V,F=J(this),B=Wi(F),j=xi(L,B),G=xi(void 0===k?B:k,B);if(sm(F)&&((ds(M=F.constructor)&&(M===Ri||sm(M.prototype))||Q(M)&&null===(M=M[Re]))&&(M=void 0),M===Ri||void 0===M))return dl(F,j,G);for(U=new(void 0===M?Ri:M)(Rr(G-j,0)),V=0;j<G;j++,V++)j in F&&YE(U,V,F[j]);return U.length=V,U}});var Ra=Qi("Array","slice"),Ro=Array.prototype,Rs=i(function(L){var k=L.slice;return L===Ro||al(Ro,L)&&k===Ro.slice?Ra:k});function OU(L,k,M,U,V){var F,B,j,G={};return T4(F=T6(U)).call(F,function(L){G[L]=U[L]}),G.enumerable=!!G.enumerable,G.configurable=!!G.configurable,("value"in G||G.initializer)&&(G.writable=!0),G=T8(B=T9(j=Rs(M).call(M)).call(j)).call(B,function(M,U){return U(L,k,M)||M},G),V&&void 0!==G.initializer&&(G.value=G.initializer?G.initializer.call(V):void 0,G.initializer=void 0),void 0===G.initializer?(Eh(L,k,G),null):G}let Rc=((te={})[te.ACCESS_POINT=101]="ACCESS_POINT",te[te.UNILBS=201]="UNILBS",te[te.STRING_UID_ALLOCATOR=901]="STRING_UID_ALLOCATOR",te),Rd=((tt={})[tt.IIIEGAL_APPID=1]="IIIEGAL_APPID",tt[tt.IIIEGAL_UID=2]="IIIEGAL_UID",tt[tt.INTERNAL_ERROR=3]="INTERNAL_ERROR",tt),Rl=((ti={})[ti.INVALID_VENDOR_KEY=5]="INVALID_VENDOR_KEY",ti[ti.INVALID_CHANNEL_NAME=7]="INVALID_CHANNEL_NAME",ti[ti.INTERNAL_ERROR=8]="INTERNAL_ERROR",ti[ti.NO_AUTHORIZED=9]="NO_AUTHORIZED",ti[ti.DYNAMIC_KEY_TIMEOUT=10]="DYNAMIC_KEY_TIMEOUT",ti[ti.NO_ACTIVE_STATUS=11]="NO_ACTIVE_STATUS",ti[ti.DYNAMIC_KEY_EXPIRED=13]="DYNAMIC_KEY_EXPIRED",ti[ti.STATIC_USE_DYNAMIC_KEY=14]="STATIC_USE_DYNAMIC_KEY",ti[ti.DYNAMIC_USE_STATIC_KEY=15]="DYNAMIC_USE_STATIC_KEY",ti[ti.USER_OVERLOAD=16]="USER_OVERLOAD",ti[ti.FORBIDDEN_REGION=18]="FORBIDDEN_REGION",ti[ti.CANNOT_MEET_AREA_DEMAND=19]="CANNOT_MEET_AREA_DEMAND",ti),Rh=((tr={})[tr.NO_FLAG_SET=100]="NO_FLAG_SET",tr[tr.FLAG_SET_BUT_EMPTY=101]="FLAG_SET_BUT_EMPTY",tr[tr.INVALID_FALG_SET=102]="INVALID_FALG_SET",tr[tr.FLAG_SET_BUT_NO_RE=103]="FLAG_SET_BUT_NO_RE",tr[tr.INVALID_SERVICE_ID=104]="INVALID_SERVICE_ID",tr[tr.NO_SERVICE_AVAILABLE=200]="NO_SERVICE_AVAILABLE",tr[tr.NO_SERVICE_AVAILABLE_P2P=201]="NO_SERVICE_AVAILABLE_P2P",tr[tr.NO_SERVICE_AVAILABLE_VOICE=202]="NO_SERVICE_AVAILABLE_VOICE",tr[tr.NO_SERVICE_AVAILABLE_WEBRTC=203]="NO_SERVICE_AVAILABLE_WEBRTC",tr[tr.NO_SERVICE_AVAILABLE_CDS=204]="NO_SERVICE_AVAILABLE_CDS",tr[tr.NO_SERVICE_AVAILABLE_CDN=205]="NO_SERVICE_AVAILABLE_CDN",tr[tr.NO_SERVICE_AVAILABLE_TDS=206]="NO_SERVICE_AVAILABLE_TDS",tr[tr.NO_SERVICE_AVAILABLE_REPORT=207]="NO_SERVICE_AVAILABLE_REPORT",tr[tr.NO_SERVICE_AVAILABLE_APP_CENTER=208]="NO_SERVICE_AVAILABLE_APP_CENTER",tr[tr.NO_SERVICE_AVAILABLE_ENV0=209]="NO_SERVICE_AVAILABLE_ENV0",tr[tr.NO_SERVICE_AVAILABLE_VOET=210]="NO_SERVICE_AVAILABLE_VOET",tr[tr.NO_SERVICE_AVAILABLE_STRING_UID=211]="NO_SERVICE_AVAILABLE_STRING_UID",tr[tr.NO_SERVICE_AVAILABLE_WEBRTC_UNILBS=212]="NO_SERVICE_AVAILABLE_WEBRTC_UNILBS",tr[tr.NO_SERVICE_AVAILABLE_UNILBS_FLV=213]="NO_SERVICE_AVAILABLE_UNILBS_FLV",tr),Rp=((tn={})[tn.K_TIMESTAMP_EXPIRED=2]="K_TIMESTAMP_EXPIRED",tn[tn.K_CHANNEL_PERMISSION_INVALID=3]="K_CHANNEL_PERMISSION_INVALID",tn[tn.K_CERTIFICATE_INVALID=4]="K_CERTIFICATE_INVALID",tn[tn.K_CHANNEL_NAME_EMPTY=5]="K_CHANNEL_NAME_EMPTY",tn[tn.K_CHANNEL_NOT_FOUND=6]="K_CHANNEL_NOT_FOUND",tn[tn.K_TICKET_INVALID=7]="K_TICKET_INVALID",tn[tn.K_CHANNEL_CONFLICTED=8]="K_CHANNEL_CONFLICTED",tn[tn.K_SERVICE_NOT_READY=9]="K_SERVICE_NOT_READY",tn[tn.K_SERVICE_TOO_HEAVY=10]="K_SERVICE_TOO_HEAVY",tn[tn.K_UID_BANNED=14]="K_UID_BANNED",tn[tn.K_IP_BANNED=15]="K_IP_BANNED",tn[tn.K_CHANNEL_BANNED=16]="K_CHANNEL_BANNED",tn[tn.DATASTREAM2_NOT_AVAILABLE=27]="DATASTREAM2_NOT_AVAILABLE",tn[tn.K_AUTO_REBALANCE=28]="K_AUTO_REBALANCE",tn[tn.WARN_NO_AVAILABLE_CHANNEL=103]="WARN_NO_AVAILABLE_CHANNEL",tn[tn.WARN_LOOKUP_CHANNEL_TIMEOUT=104]="WARN_LOOKUP_CHANNEL_TIMEOUT",tn[tn.WARN_LOOKUP_CHANNEL_REJECTED=105]="WARN_LOOKUP_CHANNEL_REJECTED",tn[tn.WARN_OPEN_CHANNEL_TIMEOUT=106]="WARN_OPEN_CHANNEL_TIMEOUT",tn[tn.WARN_OPEN_CHANNEL_REJECTED=107]="WARN_OPEN_CHANNEL_REJECTED",tn[tn.WARN_REQUEST_DEFERRED=108]="WARN_REQUEST_DEFERRED",tn[tn.ERR_DYNAMIC_KEY_TIMEOUT=109]="ERR_DYNAMIC_KEY_TIMEOUT",tn[tn.ERR_NO_AUTHORIZED=110]="ERR_NO_AUTHORIZED",tn[tn.ERR_VOM_SERVICE_UNAVAILABLE=111]="ERR_VOM_SERVICE_UNAVAILABLE",tn[tn.ERR_NO_CHANNEL_AVAILABLE_CODE=112]="ERR_NO_CHANNEL_AVAILABLE_CODE",tn[tn.ERR_MASTER_VOCS_UNAVAILABLE=114]="ERR_MASTER_VOCS_UNAVAILABLE",tn[tn.ERR_INTERNAL_ERROR=115]="ERR_INTERNAL_ERROR",tn[tn.ERR_NO_ACTIVE_STATUS=116]="ERR_NO_ACTIVE_STATUS",tn[tn.ERR_INVALID_UID=117]="ERR_INVALID_UID",tn[tn.ERR_DYNAMIC_KEY_EXPIRED=118]="ERR_DYNAMIC_KEY_EXPIRED",tn[tn.ERR_STATIC_USE_DYANMIC_KE=119]="ERR_STATIC_USE_DYANMIC_KE",tn[tn.ERR_DYNAMIC_USE_STATIC_KE=120]="ERR_DYNAMIC_USE_STATIC_KE",tn[tn.ERR_NO_VOCS_AVAILABLE=2e3]="ERR_NO_VOCS_AVAILABLE",tn[tn.ERR_NO_VOS_AVAILABLE=2001]="ERR_NO_VOS_AVAILABLE",tn[tn.ERR_JOIN_CHANNEL_TIMEOUT=2002]="ERR_JOIN_CHANNEL_TIMEOUT",tn[tn.ERR_REPEAT_JOIN_CHANNEL=2003]="ERR_REPEAT_JOIN_CHANNEL",tn[tn.ERR_JOIN_BY_MULTI_IP=2004]="ERR_JOIN_BY_MULTI_IP",tn[tn.ERR_NOT_JOINED=2011]="ERR_NOT_JOINED",tn[tn.ERR_REPEAT_JOIN_REQUEST=2012]="ERR_REPEAT_JOIN_REQUEST",tn[tn.ERR_INVALID_VENDOR_KEY=2013]="ERR_INVALID_VENDOR_KEY",tn[tn.ERR_INVALID_CHANNEL_NAME=2014]="ERR_INVALID_CHANNEL_NAME",tn[tn.ERR_INVALID_STRINGUID=2015]="ERR_INVALID_STRINGUID",tn[tn.ERR_TOO_MANY_USERS=2016]="ERR_TOO_MANY_USERS",tn[tn.ERR_SET_CLIENT_ROLE_TIMEOUT=2017]="ERR_SET_CLIENT_ROLE_TIMEOUT",tn[tn.ERR_SET_CLIENT_ROLE_NO_PERMISSION=2018]="ERR_SET_CLIENT_ROLE_NO_PERMISSION",tn[tn.ERR_SET_CLIENT_ROLE_ALREADY_IN_USE=2019]="ERR_SET_CLIENT_ROLE_ALREADY_IN_USE",tn[tn.ERR_PUBLISH_REQUEST_INVALID=2020]="ERR_PUBLISH_REQUEST_INVALID",tn[tn.ERR_SUBSCRIBE_REQUEST_INVALID=2021]="ERR_SUBSCRIBE_REQUEST_INVALID",tn[tn.ERR_NOT_SUPPORTED_MESSAGE=2022]="ERR_NOT_SUPPORTED_MESSAGE",tn[tn.ERR_ILLEAGAL_PLUGIN=2023]="ERR_ILLEAGAL_PLUGIN",tn[tn.ERR_REJOIN_TOKEN_INVALID=2024]="ERR_REJOIN_TOKEN_INVALID",tn[tn.ERR_REJOIN_USER_NOT_JOINED=2025]="ERR_REJOIN_USER_NOT_JOINED",tn[tn.ERR_INVALID_OPTIONAL_INFO=2027]="ERR_INVALID_OPTIONAL_INFO",tn[tn.ILLEGAL_AES_PASSWORD=2028]="ILLEGAL_AES_PASSWORD",tn[tn.ILLEGAL_CLIENT_ROLE_LEVEL=2029]="ILLEGAL_CLIENT_ROLE_LEVEL",tn[tn.ERR_TOO_MANY_BROADCASTERS=2031]="ERR_TOO_MANY_BROADCASTERS",tn[tn.ERR_TOO_MANY_SUBSCRIBERS=2032]="ERR_TOO_MANY_SUBSCRIBERS",tn[tn.ERR_LICENSE_MISSING=32769]="ERR_LICENSE_MISSING",tn[tn.ERR_LICENSE_EXPIRED=32771]="ERR_LICENSE_EXPIRED",tn[tn.ERR_LICENSE_MINUTES_EXCEEDED=32773]="ERR_LICENSE_MINUTES_EXCEEDED",tn[tn.ERR_LICENSE_PERIOD_INVALID=32774]="ERR_LICENSE_PERIOD_INVALID",tn[tn.ERR_LICENSE_MULTIPLE_SDK_SERVICE=32778]="ERR_LICENSE_MULTIPLE_SDK_SERVICE",tn[tn.ERR_LICENSE_ILLEGAL=32783]="ERR_LICENSE_ILLEGAL",tn[tn.ERR_TEST_RECOVER=9e3]="ERR_TEST_RECOVER",tn[tn.ERR_TEST_TRYNEXT=9001]="ERR_TEST_TRYNEXT",tn[tn.ERR_TEST_RETRY=9002]="ERR_TEST_RETRY",tn),R_=((ta={}).CONNECTING="connecting",ta.CONNECTED="connected",ta.RECONNECTING="reconnecting",ta.CLOSED="closed",ta),RE=((to={}).WS_CONNECTED="ws_connected",to.WS_RECONNECTING="ws_reconnecting",to.WS_CLOSED="ws_closed",to.WS_RECONNECT_CREATE_CONNECTION="ws_reconnect_create_connection",to.ON_BINARY_DATA="on_binary_data",to.REQUEST_RECOVER="request_recover",to.REQUEST_JOIN_INFO="request_join_info",to.REQUEST_REJOIN_INFO="req_rejoin_info",to.IS_P2P_DISCONNECTED="is_p2p_dis",to.DISCONNECT_P2P="dis_p2p",to.ABORT_P2P_EXECUTION="abort_p2p_execution",to.NEED_RENEW_SESSION="need-sid",to.REPORT_JOIN_GATEWAY="report_join_gateway",to.REQUEST_TIMEOUT="request_timeout",to.REQUEST_SUCCESS="request_success",to.JOIN_RESPONSE="join_response",to.PRE_CONNECT_PC="pre_connect_pc",to.P2P_CONNECTION="p2p_connection",to.P2P_REMOTE_CANDIDATE_UPDATE="p2p_remote_candidate_update",to.P2P_SUBSCRIBE="p2p_subscribe",to.P2P_UNSUBSCRIBE="p2p_unsubscribe",to.P2P_EXCHANGE_SDP="p2p_exchange_sdp",to.P2P_ON_ADD_VIDEO_STREAM="p2p_on_add_video_stream",to.P2P_ON_ADD_AUDIO_STREAM="p2p_on_add_audio_stream",to.RECOVER_NOTIFICATION="recover_notification",to),Rf=((ts={}).PING="ping",ts.PING_BACK="ping_back",ts.JOIN="join_v3",ts.REJOIN="rejoin_v3",ts.LEAVE="leave",ts.SET_CLIENT_ROLE="set_client_role",ts.PUBLISH="publish",ts.PUBLISH_DATASTREAM="publish_datastream",ts.UNPUBLISH="unpublish",ts.UNPUBLISH_DATASTREAM="unpublish_datastream",ts.SUBSCRIBE="subscribe",ts.PRE_SUBSCRIBE="pre_subscribe",ts.SUBSCRIBE_DATASTREAM="subscribe_datastream",ts.SUBSCRIBE_STREAMS="subscribe_streams",ts.UNSUBSCRIBE="unsubscribe",ts.UNSUBSCRIBE_DATASTREAM="unsubscribe_datastream",ts.UNSUBSCRIBE_STREAMS="unsubscribe_streams",ts.SUBSCRIBE_CHANGE="subscribe_change",ts.TRAFFIC_STATS="traffic_stats",ts.RENEW_TOKEN="renew_token",ts.SWITCH_VIDEO_STREAM="switch_video_stream",ts.DEFAULT_VIDEO_STREAM="default_video_stream",ts.SET_FALLBACK_OPTION="set_fallback_option",ts.GATEWAY_INFO="gateway_info",ts.CONTROL="control",ts.SEND_METADATA="send_metadata",ts.DATA_STREAM="data_stream",ts.PICK_SVC_LAYER="pick_svc_layer",ts.RESTART_ICE="restart_ice",ts.CONNECT_PC="connect_pc",ts.SET_VIDEO_PROFILE="set_video_profile",ts.SET_PARAMETER="set_parameter",ts.SET_RTM2_FLAG="set_rtm2_flag",ts.DOWNGRADE_CODEC="downgrade_codec",ts),RS=((tc={}).WRTC_STATS="wrtc_stats",tc.WS_INFLATE_DATA_LENGTH="ws_inflate_data_length",tc.DENOISER_STATS="denoiser_stats",tc.EXTENSION_USAGE_STATS="extension_usage_stats",tc),RT=((td={}).ON_USER_ONLINE="on_user_online",td.ON_USER_OFFLINE="on_user_offline",td.ON_STREAM_FALLBACK_UPDATE="on_stream_fallback_update",td.ON_PUBLISH_STREAM="on_publish_stream",td.ON_UPLINK_STATS="on_uplink_stats",td.ON_P2P_LOST="on_p2p_lost",td.ON_REMOVE_STREAM="on_remove_stream",td.ON_ADD_AUDIO_STREAM="on_add_audio_stream",td.ON_ADD_VIDEO_STREAM="on_add_video_stream",td.ON_TOKEN_PRIVILEGE_WILL_EXPIRE="on_token_privilege_will_expire",td.ON_TOKEN_PRIVILEGE_DID_EXPIRE="on_token_privilege_did_expire",td.ON_USER_BANNED="on_user_banned",td.ON_USER_LICENSE_BANNED="on_user_license_banned",td.ON_NOTIFICATION="on_notification",td.ON_CRYPT_ERROR="on_crypt_error",td.MUTE_AUDIO="mute_audio",td.MUTE_VIDEO="mute_video",td.UNMUTE_AUDIO="unmute_audio",td.UNMUTE_VIDEO="unmute_video",td.ON_P2P_OK="on_p2p_ok",td.RECEIVE_METADATA="receive_metadata",td.ON_DATA_STREAM="on_data_stream",td.ON_RTP_CAPABILITY_CHANGE="on_rtp_capability_change",td.ON_REMOTE_DATASTREAM_UPDATE="on_remote_datastream_update",td.ON_REMOTE_FULL_DATASTREAM_INFO="on_remote_full_datastream_info",td.ENABLE_LOCAL_VIDEO="enable_local_video",td.DISABLE_LOCAL_VIDEO="disable_local_video",td.ENABLE_LOCAL_AUDIO="enable_local_audio",td.DISABLE_LOCAL_AUDIO="disable_local_audio",td.ON_PUBLISHED_USER_LIST="on_published_user_list",td),RR=((tl={}).SEND_ONLY="SEND_ONLY",tl.RECEIVE_ONLY="RECEIVE_ONLY",tl),RI=((tu={}).CONNECTED="websocket:connected",tu.RECONNECTING="websocket:reconnecting",tu.WILL_RECONNECT="websocket:will_reconnect",tu.CLOSED="websocket:closed",tu.FAILED="websocket:failed",tu.ON_MESSAGE="websocket:on_message",tu.REQUEST_NEW_URLS="websocket:request_new_urls",tu.RECONNECT_CREATE_CONNECTION="websocket:reconnect_create_connection",tu.ON_TOKEN_PRIVILEGE_DID_EXPIRE="websocket:on_token_privilege_did_expire",tu);function GU(L){if("string"!=typeof L||!/^[a-zA-Z0-9 \!\#\$\%\&\(\)\+\-\:\;\<\=\.\>\?\@\[\]\^\_\{\}\|\~\,]{1,64}$/.test(L))throw gc.error("Invalid Channel Name ".concat(L)),new ED(f1.INVALID_PARAMS,"The length must be within 64 bytes. The supported characters: a-z,A-Z,0-9,space,!, #, $, %, &, (, ), +, -, :, ;, <, =, ., >, ?, @, [, ], ^, _,  {, }, |, ~, ,")}function WU(L){if(!("number"==typeof L&&Math.floor(L)===L&&0<=L&&L<=4294967295||Vw(L,1,255)))throw new ED(f1.INVALID_PARAMS,"[String uid] Length of the string: [1,255]. ASCII characters only. [Number uid] The value range is [0,10000]");"string"==typeof L&&gc.warn("You input a string as the user ID, to ensure better end-user experience, Agora highly suggests not using a string as the user ID.")}let Rv=((th={}).TRANSCODE="mix_streaming",th.RAW="raw_streaming",th),RC={alpha:1,height:640,width:360,x:0,y:0,zOrder:0,audioChannel:0},Ry={x:0,y:0,width:160,height:160,zOrder:255,alpha:1};function zU(L,k){kw(L.url,"".concat(k,".url"),1,1e3,!1),Uw(L.x)||Pw(L.x,"".concat(k,".x"),0,1e4),Uw(L.y)||Pw(L.y,"".concat(k,".y"),0,1e4),Uw(L.width)||Pw(L.width,"".concat(k,".width"),0,1e4),Uw(L.height)||Pw(L.height,"".concat(k,".height"),0,1e4),Uw(L.zOrder)||Pw(L.zOrder,"".concat(k,".zOrder"),0,255),Uw(L.alpha)||Pw(L.alpha,"".concat(k,".alpha"),0,1,!1)}let RA={audioBitrate:48,audioChannels:1,audioSampleRate:48e3,backgroundColor:0,height:360,lowLatency:!1,videoBitrate:400,videoCodecProfile:100,videoCodecType:1,videoFrameRate:15,videoGop:30,width:640,images:[],userConfigs:[],userConfigExtraInfo:""},Rb=((tp={}).WARNING="@live_uap-warning",tp.ERROR="@line_uap-error",tp.PUBLISH_STREAM_STATUS="@live_uap-publish-status",tp.WORKER_STATUS="@live_uap-worker-status",tp.REQUEST_NEW_ADDRESS="@live_uap-request-address",tp),RN=((t_={}).REQUEST_WORKER_MANAGER_LIST="@live_req_worker_manager",t_),RL=((tE={})[tE.LIVE_STREAM_RESPONSE_SUCCEED=200]="LIVE_STREAM_RESPONSE_SUCCEED",tE[tE.LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM=454]="LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM",tE[tE.LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR=450]="LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR",tE[tE.LIVE_STREAM_RESPONSE_BAD_STREAM=451]="LIVE_STREAM_RESPONSE_BAD_STREAM",tE[tE.LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR=400]="LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR",tE[tE.LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST=404]="LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST",tE[tE.LIVE_STREAM_RESPONSE_NOT_AUTHORIZED=456]="LIVE_STREAM_RESPONSE_NOT_AUTHORIZED",tE[tE.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE=457]="LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE",tE[tE.LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN=429]="LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN",tE[tE.LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH=452]="LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH",tE[tE.LIVE_STREAM_RESPONSE_NOT_SUPPORTED=453]="LIVE_STREAM_RESPONSE_NOT_SUPPORTED",tE[tE.LIVE_STREAM_RESPONSE_MAX_STREAM_NUM=455]="LIVE_STREAM_RESPONSE_MAX_STREAM_NUM",tE[tE.LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR=500]="LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR",tE[tE.LIVE_STREAM_RESPONSE_WORKER_LOST=501]="LIVE_STREAM_RESPONSE_WORKER_LOST",tE[tE.LIVE_STREAM_RESPONSE_RESOURCE_LIMIT=502]="LIVE_STREAM_RESPONSE_RESOURCE_LIMIT",tE[tE.LIVE_STREAM_RESPONSE_WORKER_QUIT=503]="LIVE_STREAM_RESPONSE_WORKER_QUIT",tE[tE.ERROR_FAIL_SEND_MESSAGE=504]="ERROR_FAIL_SEND_MESSAGE",tE[tE.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE=30]="PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE",tE[tE.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT=31]="PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT",tE[tE.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH=32]="PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH",tE[tE.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN=33]="PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN",tE);function QU(L){if(!L.channelName)throw new ED(f1.INVALID_PARAMS,"invalid channelName in info");if("number"!=typeof L.uid)throw new ED(f1.INVALID_PARAMS,"invalid uid in info, uid must be a number");return L.token&&kw(L.token,"info.token",1,2047),WU(L.uid),GU(L.channelName),!0}let Rk=((tm={})[tm.SetSdkProfile=0]="SetSdkProfile",tm[tm.SetSourceChannel=1]="SetSourceChannel",tm[tm.SetSourceUserId=2]="SetSourceUserId",tm[tm.SetDestChannel=3]="SetDestChannel",tm[tm.StartPacketTransfer=4]="StartPacketTransfer",tm[tm.StopPacketTransfer=5]="StopPacketTransfer",tm[tm.UpdateDestChannel=6]="UpdateDestChannel",tm[tm.Reconnect=7]="Reconnect",tm[tm.SetVideoProfile=8]="SetVideoProfile",tm),RU=((tf={}).NETWORK_DISCONNECTED="NETWORK_DISCONNECTED",tf.NETWORK_CONNECTED="NETWORK_CONNECTED",tf.PACKET_JOINED_SRC_CHANNEL="PACKET_JOINED_SRC_CHANNEL",tf.PACKET_JOINED_DEST_CHANNEL="PACKET_JOINED_DEST_CHANNEL",tf.PACKET_SENT_TO_DEST_CHANNEL="PACKET_SENT_TO_DEST_CHANNEL",tf.PACKET_RECEIVED_VIDEO_FROM_SRC="PACKET_RECEIVED_VIDEO_FROM_SRC",tf.PACKET_RECEIVED_AUDIO_FROM_SRC="PACKET_RECEIVED_AUDIO_FROM_SRC",tf.PACKET_UPDATE_DEST_CHANNEL="PACKET_UPDATE_DEST_CHANNEL",tf.PACKET_UPDATE_DEST_CHANNEL_REFUSED="PACKET_UPDATE_DEST_CHANNEL_REFUSED",tf.PACKET_UPDATE_DEST_CHANNEL_NOT_CHANGE="PACKET_UPDATE_DEST_CHANNEL_NOT_CHANGE",tf),RV=((tS={}).RELAY_STATE_IDLE="RELAY_STATE_IDLE",tS.RELAY_STATE_CONNECTING="RELAY_STATE_CONNECTING",tS.RELAY_STATE_RUNNING="RELAY_STATE_RUNNING",tS.RELAY_STATE_FAILURE="RELAY_STATE_FAILURE",tS),Rj=((tT={}).RELAY_OK="RELAY_OK",tT.SERVER_CONNECTION_LOST="SERVER_CONNECTION_LOST",tT.SRC_TOKEN_EXPIRED="SRC_TOKEN_EXPIRED",tT.DEST_TOKEN_EXPIRED="DEST_TOKEN_EXPIRED",tT),RG=((tR={}).High="high",tR.Low="low",tR.Audio="audio",tR.Screen="screen",tR.ScreenLow="screen_low",tR),RH=((tI={}).DISCONNECT="disconnect",tI.CONNECTION_STATE_CHANGE="connection-state-change",tI.NETWORK_QUALITY="network-quality",tI.STREAM_TYPE_CHANGE="stream-type-change",tI.IS_P2P_DISCONNECTED="is-p2p-dis",tI.DISCONNECT_P2P="dis-p2p",tI.REQUEST_NEW_GATEWAY_LIST="req-gate-url",tI.NEED_RENEW_SESSION="need-sid",tI.REQUEST_P2P_CONNECTION_PARAMS="request-p2p-connection-params",tI.JOIN_RESPONSE="join-response",tI.RESET_CONNECTION_EVENTS="reset-connection-events",tI.PRE_CONNECT_PC="pre-connect_pc",tI.UPDATE_GATEWAY_CONFIG="update-gateway-config",tI),RK=((tC={}).P2P_DISCONNECTED="P2P_DISCONNECTED",tC.A_ROUND_WS_FAILED="A_ROUND_WS_FAILED",tC.TIMEOUT="TIMEOUT",tC.UNKNOWN_REASON="UNKNOWN_REASON",tC),RJ=((ty={})[ty.Nothing=0]="Nothing",ty[ty.Audio=1]="Audio",ty[ty.LwoVideo=2]="LwoVideo",ty[ty.Video=4]="Video",ty[ty.Data=8]="Data",ty[ty.DataStream0=256]="DataStream0",ty[ty.DataStream1=512]="DataStream1",ty[ty.DataStream2=1024]="DataStream2",ty[ty.DataStream3=2048]="DataStream3",ty[ty.DataStream4=4096]="DataStream4",ty[ty.DataStream5=8192]="DataStream5",ty[ty.DataStream6=16384]="DataStream6",ty[ty.DataStream7=32768]="DataStream7",ty),RX=((tb={}).CHINA="CHINA",tb.ASIA="ASIA",tb.NORTH_AMERICA="NORTH_AMERICA",tb.EUROPE="EUROPE",tb.JAPAN="JAPAN",tb.INDIA="INDIA",tb.KOREA="KOREA",tb.HKMC="HKMC",tb.US="US",tb.OCEANIA="OCEANIA",tb.SOUTH_AMERICA="SOUTH_AMERICA",tb.AFRICA="AFRICA",tb.OVERSEA="OVERSEA",tb.GLOBAL="GLOBAL",tb.EXTENSIONS="EXTENSIONS",tb),RQ=[RX.AFRICA,RX.ASIA,RX.CHINA,RX.EUROPE,RX.GLOBAL,RX.INDIA,RX.JAPAN,RX.NORTH_AMERICA,RX.OCEANIA,RX.OVERSEA,RX.SOUTH_AMERICA],RZ=((tO={}).CHINA="CN",tO.ASIA="AS",tO.NORTH_AMERICA="NA",tO.EUROPE="EU",tO.JAPAN="JP",tO.INDIA="IN",tO.KOREA="KR",tO.HKMC="HK",tO.US="US",tO.OCEANIA="OC",tO.SOUTH_AMERICA="SA",tO.AFRICA="AF",tO.OVERSEA="OVERSEA",tO.GLOBAL="GLOBAL",tO.EXTENSIONS="GLOBAL",tO),R$={CHINA:{},ASIA:{CODE:RZ.ASIA,WEBCS_DOMAIN:["ap-web-1-asia.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-asia.agora.io"],PROXY_CS:["proxy-ap-web-asia.agora.io"],CDS_AP:["cds-ap-web-asia.agora.io","cds-ap-web-asia2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-asia.agora.io","sua-ap-web-asia2.agora.io"],UAP_AP:["uap-ap-web-asia.agora.io","uap-ap-web-asia2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-asia.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-asia.agora.io"],LOG_UPLOAD_SERVER:["logservice-asia.agora.io"],PROXY_SERVER_TYPE3:["southeast-asia.webrtc-cloud-proxy.sd-rtn.com"]},NORTH_AMERICA:{CODE:RZ.NORTH_AMERICA,WEBCS_DOMAIN:["ap-web-1-north-america.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-north-america.agora.io"],PROXY_CS:["proxy-ap-web-america.agora.io"],CDS_AP:["cds-ap-web-america.agora.io","cds-ap-web-america2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-america.agora.io","sua-ap-web-america2.agora.io"],UAP_AP:["uap-ap-web-america.agora.io","uap-ap-web-america2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-north-america.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-north-america.agora.io"],LOG_UPLOAD_SERVER:["logservice-north-america.agora.io"],PROXY_SERVER_TYPE3:["east-usa.webrtc-cloud-proxy.sd-rtn.com"]},EUROPE:{CODE:RZ.EUROPE,WEBCS_DOMAIN:["ap-web-1-europe.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-europe.agora.io"],PROXY_CS:["proxy-ap-web-europe.agora.io"],CDS_AP:["cds-ap-web-europe.agora.io","cds-ap-web-europe2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-europe.agora.io","sua-ap-web-europe.agora.io"],UAP_AP:["uap-ap-web-europe.agora.io","uap-ap-web-europe2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-europe.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-europe.agora.io"],LOG_UPLOAD_SERVER:["logservice-europe.agora.io"],PROXY_SERVER_TYPE3:["europe.webrtc-cloud-proxy.sd-rtn.com"]},JAPAN:{CODE:RZ.JAPAN,WEBCS_DOMAIN:["ap-web-1-japan.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-japan.agora.io"],PROXY_CS:["proxy-ap-web-japan.agora.io"],CDS_AP:["cds-ap-web-japan.agora.io","cds-ap-web-japan2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-japan.agora.io","sua-ap-web-japan2.agora.io"],UAP_AP:["uap-ap-web-japan.agora.io","uap-ap-web-japan2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-japan.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-japan.agora.io"],LOG_UPLOAD_SERVER:["logservice-japan.agora.io"],PROXY_SERVER_TYPE3:["japan.webrtc-cloud-proxy.sd-rtn.com"]},INDIA:{CODE:RZ.INDIA,WEBCS_DOMAIN:["ap-web-1-india.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-india.agora.io"],PROXY_CS:["proxy-ap-web-india.agora.io"],CDS_AP:["cds-ap-web-india.agora.io","cds-ap-web-india2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-india.agora.io","sua-ap-web-india2.agora.io"],UAP_AP:["uap-ap-web-india.agora.io","uap-ap-web-india2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-india.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-india.agora.io"],LOG_UPLOAD_SERVER:["logservice-india.agora.io"],PROXY_SERVER_TYPE3:["india.webrtc-cloud-proxy.sd-rtn.com"]},KOREA:{CODE:RZ.KOREA,WEBCS_DOMAIN:["ap-web-1-korea.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-korea.agora.io"],PROXY_CS:["proxy-ap-web-korea.agora.io"],CDS_AP:["cds-ap-web-korea.agora.io","cds-ap-web-korea2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-korea.agora.io","sua-ap-web-korea2.agora.io"],UAP_AP:["uap-ap-web-korea.agora.io","uap-ap-web-korea2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-korea.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-korea.agora.io"],LOG_UPLOAD_SERVER:["logservice-korea.agora.io"],PROXY_SERVER_TYPE3:["korea.webrtc-cloud-proxy.sd-rtn.com"]},HKMC:{CODE:RZ.HKMC,WEBCS_DOMAIN:["ap-web-1-hkmc.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-hkmc.agora.io"],PROXY_CS:["proxy-ap-web-hkmc.agora.io"],CDS_AP:["cds-ap-web-hkmc.agora.io","cds-ap-web-hkmc2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-hkmc.agora.io","sua-ap-web-hkmc2.agora.io"],UAP_AP:["uap-ap-web-hkmc.agora.io","uap-ap-web-hkmc2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-hkmc.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-hkmc.agora.io"],LOG_UPLOAD_SERVER:["logservice-hkmc.agora.io"],PROXY_SERVER_TYPE3:["hkmc.webrtc-cloud-proxy.sd-rtn.com"]},US:{CODE:RZ.US,WEBCS_DOMAIN:["ap-web-1-us.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-us.agora.io"],PROXY_CS:["proxy-ap-web-us.agora.io"],CDS_AP:["cds-ap-web-us.agora.io","cds-ap-web-us2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-us.agora.io","sua-ap-web-us2.agora.io"],UAP_AP:["uap-ap-web-us.agora.io","uap-ap-web-us2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-us.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-us.agora.io"],LOG_UPLOAD_SERVER:["logservice-us.agora.io"],PROXY_SERVER_TYPE3:["us.webrtc-cloud-proxy.sd-rtn.com"]},OVERSEA:{CODE:RZ.OVERSEA,WEBCS_DOMAIN:["ap-web-1-oversea.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-oversea.agora.io"],PROXY_CS:["proxy-ap-web-oversea.agora.io"],CDS_AP:["cds-ap-web-oversea.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-oversea.agora.io"],UAP_AP:["uap-ap-web-oversea.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-oversea.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-oversea.agora.io"],LOG_UPLOAD_SERVER:["logservice-oversea.agora.io"],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.agora.io"]},GLOBAL:{CODE:RZ.GLOBAL,WEBCS_DOMAIN:["webrtc2-ap-web-1.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-ap-web-3.agora.io"],PROXY_CS:["ap-proxy-1.agora.io","ap-proxy-2.agora.io"],CDS_AP:["cds-ap-web-1.agora.io","cds-ap-web-3.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-1.agora.io","sua-ap-web-3.agora.io"],UAP_AP:["uap-ap-web-1.agora.io","uap-ap-web-3.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2.agora.io"],LOG_UPLOAD_SERVER:["logservice.agora.io"],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.sd-rtn.com"]},OCEANIA:{CODE:RZ.OCEANIA,WEBCS_DOMAIN:["ap-web-1-oceania.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-oceania.agora.io"],PROXY_CS:["proxy-ap-web-oceania.agora.io"],CDS_AP:["cds-ap-web-oceania.agora.io","cds-ap-web-oceania2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-oceania.agora.io","sua-ap-web-oceania2.agora.io"],UAP_AP:["uap-ap-web-oceania.agora.io","uap-ap-web-oceania2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-oceania.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-oceania.agora.io"],LOG_UPLOAD_SERVER:["logservice-oceania.agora.io"],PROXY_SERVER_TYPE3:["oceania.webrtc-cloud-proxy.sd-rtn.com"]},SOUTH_AMERICA:{CODE:RZ.SOUTH_AMERICA,WEBCS_DOMAIN:["ap-web-1-south-america.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-south-america.agora.io"],PROXY_CS:["proxy-ap-web-south-america.agora.io"],CDS_AP:["cds-ap-web-south-america.agora.io","cds-ap-web-south-america2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-south-america.agora.io","sua-ap-web-south-america2.agora.io"],UAP_AP:["uap-ap-web-south-america.agora.io","uap-ap-web-south-america2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-south-america.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-south-america.agora.io"],LOG_UPLOAD_SERVER:["logservice-south-america.agora.io"],PROXY_SERVER_TYPE3:["south-america.webrtc-cloud-proxy.sd-rtn.com"]},AFRICA:{CODE:RZ.AFRICA,WEBCS_DOMAIN:["ap-web-1-africa.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-africa.agora.io"],PROXY_CS:["proxy-ap-web-africa.agora.io"],CDS_AP:["cds-ap-web-africa.agora.io","cds-ap-web-africa2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-africa.agora.io","sua-ap-web-africa2.agora.io"],UAP_AP:["uap-ap-web-africa.agora.io","uap-ap-web-africa2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-africa.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-africa.agora.io"],LOG_UPLOAD_SERVER:["logservice-south-africa.agora.io"],PROXY_SERVER_TYPE3:["africa.webrtc-cloud-proxy.sd-rtn.com"]},EXTENSIONS:{}};SX&&(R$.CHINA={CODE:RZ.CHINA,WEBCS_DOMAIN:["webrtc2-2.ap.sd-rtn.com"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-4.ap.sd-rtn.com"],PROXY_CS:["proxy-web.ap.sd-rtn.com"],CDS_AP:["cds-web-2.ap.sd-rtn.com","cds-web-4.ap.sd-rtn.com"],ACCOUNT_REGISTER:["sua-web-2.ap.sd-rtn.com","sua-web-4.ap.sd-rtn.com"],UAP_AP:["uap-web-2.ap.sd-rtn.com","uap-web-4.ap.sd-rtn.com"],EVENT_REPORT_DOMAIN:["web-3.statscollector.sd-rtn.com"],EVENT_REPORT_BACKUP_DOMAIN:["web-4.statscollector.sd-rtn.com"],LOG_UPLOAD_SERVER:["logservice-china.agora.io"],PROXY_SERVER_TYPE3:["east-cn.webrtc-cloud-proxy.sd-rtn.com"]});let R0=((tN={}).UPDATE_BITRATE_LIMIT="update_bitrate_limit",tN.UPDATE_CLIENT_ROLE_OPTIONS="update_client_role_options",tN);function hV(L){return!!L&&!(!L.uplink||!L.id)&&void 0!==L.uplink.max_bitrate&&void 0!==L.uplink.min_bitrate}let pV=class pV extends Hw{constructor(L,k){super(),uI(this,"onICEConnectionStateChange",void 0),uI(this,"onConnectionStateChange",void 0),uI(this,"onDTLSTransportStateChange",void 0),uI(this,"onDTLSTransportError",void 0),uI(this,"onICETransportStateChange",void 0),uI(this,"onFirstAudioReceived",void 0),uI(this,"onFirstVideoReceived",void 0),uI(this,"onFirstAudioDecoded",void 0),uI(this,"onFirstVideoDecoded",void 0),uI(this,"onFirstVideoRender",void 0),uI(this,"onFirstVideoDecodedTimeout",void 0),uI(this,"onSelectedLocalCandidateChanged",void 0),uI(this,"onSelectedRemoteCandidateChanged",void 0),uI(this,"onICECandidateError",void 0),uI(this,"getLocalVideoStats",void 0)}};let _V=class _V extends pV{constructor(L,k){super(L,k),uI(this,"establishPromise",void 0)}};let R1=((tP={}).VIDEO="video",tP.AUDIO="audio",tP),R2=((tL={}).UDP_RELAY="udp_relay",tL.UDP_TCP_RELAY="udp_tcp_relay",tL.TCP_RELAY="tcp_relay",tL.RELAY="relay",tL),R3=((tk={})[tk.FIRST_CONNECTION=0]="FIRST_CONNECTION",tk[tk.UDP_TCP_RESTART=1]="UDP_TCP_RESTART",tk[tk.RELAY_RESTART=2]="RELAY_RESTART",tk[tk.TCP_RESTART=3]="TCP_RESTART",tk[tk.OLD_FIRST_CONNECTION=10]="OLD_FIRST_CONNECTION",tk[tk.OLD_RESTART=11]="OLD_RESTART",tk[tk.DISCONNECTED_OR_FAILED=20]="DISCONNECTED_OR_FAILED",tk),R5=["disconnected","failed"],R4=((tU={}).LocalVideoTrack="videoTrack",tU.LocalAudioTrack="audioTrack",tU.LocalVideoLowTrack="videoLowTrack",tU),R6=((tV={}).New="new",tV.Connected="connected",tV.Reconnecting="reconnecting",tV.Disconnected="disconnected",tV),R8=((tF={}).AudioMetadata="audioMetadata",tF.AudioPts="audioPts",tF.StateChange="stateChange",tF.IceConnectionStateChange="iceConnectionStateChange",tF.RequestMuteLocal="requestMuteLocal",tF.RequestUnmuteLocal="requestUnmuteLocal",tF.RequestRePublish="requestRePublish",tF.RequestRePublishDataChannel="requestRePublishDataChannel",tF.RequestReSubscribe="requestReSubscribe",tF.RequestUploadStats="requestUploadStats",tF.RequestUpload="requestUpload",tF.MediaReconnectStart="MediaReconnectStart",tF.MediaReconnectEnd="MediaReconnectEnd",tF.NeedSignalRTT="NeedSignalRTT",tF.RequestRestartICE="RequestRestartIce",tF.PeerConnectionStateChange="PeerConnectionStateChange",tF.RequestReconnect="RequestReconnect",tF.RequestReconnectPC="RequestReconnectPC",tF.RequestUnpublishForReconnectPC="RequestUnpublishForReconnectPC",tF.P2PLost="P2PLost",tF.UpdateVideoEncoder="UpdateVideoEncoder",tF.ConnectionTypeChange="ConnectionTypeChange",tF.RequestLowStreamParameter="RequestLowStreamParameter",tF.QueryClientConnectionState="QueryClientConnectionState",tF.LocalCandidate="LocalCandidate",tF.RequestP2PMuteLocal="requestP2PMuteLocal",tF.RequestP2PUnPublish="RequestP2PUnPublish",tF.RequestP2PUnmuteRemote="RequestP2PUnmuteRemote",tF.RequestP2PMuteRemote="RequestP2PMuteRemote",tF.RequestP2PRestartICE="RequestP2PRestartICE",tF),R9=((tB={}).CONNECTING="CONNECTING",tB.RECONNECTING="RECONNECTING",tB.CONNECTED="CONNECTED",tB.CLOSED="CLOSED",tB),R7=((tj={})[tj.CONNECT_AP=0]="CONNECT_AP",tj[tj.AP_CONNECTED=1]="AP_CONNECTED",tj[tj.CONNECT_WORKER_MANAGER=2]="CONNECT_WORKER_MANAGER",tj[tj.WORKER_MANAGER_CONNECTED=3]="WORKER_MANAGER_CONNECTED",tj[tj.GET_WORKER_MANAGER_RESPONSE=4]="GET_WORKER_MANAGER_RESPONSE",tj[tj.CONNECT_WORKER=5]="CONNECT_WORKER",tj[tj.WORKER_CONNECTED=6]="WORKER_CONNECTED",tj[tj.CLOSED=7]="CLOSED",tj),Ie=((tW={}).CONNECTION_STATE_CHANGE="connection-state-change",tW.STATE_CHANGE="state-change",tW.INSPECT_RESULT="inspect-result",tW.CLIENT_LOCAL_VIDEO_TRACK="client-local-video-track",tW.REQUEST_NEW_WORKER_URL="request-new-worker-url",tW),It=((tG={}).CONNECTED="transmitter:connected",tG.RECONNECTING="transmitter:reconnecting",tG.WILL_RECONNECT="transmitter:will_reconnect",tG.CLOSED="transmitter:closed",tG.FAILED="transmitter:failed",tG.ON_MESSAGE="transmitter:on_message",tG.REQUEST_NEW_URLS="transmitter:request_new_urls",tG.RECONNECT_CREATE_CONNECTION="transmitter:reconnect_create_connection",tG.ON_TOKEN_PRIVILEGE_DID_EXPIRE="transmitter:on_token_privilege_did_expire",tG.TO_CONNECT_DATACHANNEL="transmitter:to_connect_datachannel",tG.FAILBACK="transmitter:failback",tG.PRE_CONNECT_PC="transmitter:pre_connect_pc",tG),Ii=((tH={}).CAMERA_CHANGED="camera-changed",tH.MICROPHONE_CHANGED="microphone-changed",tH.PLAYBACK_DEVICE_CHANGED="playback-device-changed",tH.AUDIO_AUTOPLAY_FAILED="audio-autoplay-failed",tH.AUTOPLAY_FAILED="autoplay-failed",tH.AUDIO_CONTEXT_STATE_CHANGED="audio-context-state-changed",tH.SECURITY_POLICY_VIOLATION="security-policy-violation",tH),Ir=((tY={}).CONNECTING="CONNECTING",tY.RECONNECTING="RECONNECTING",tY.CONNECTED="CONNECTED",tY.CLOSED="CLOSED",tY),In=((tq={}).CONNECTION_STATE_CHANGE="connection-state-change",tq.STATE_CHANGE="state-change",tq.INSPECT_RESULT="inspect-result",tq.CLIENT_LOCAL_VIDEO_TRACK="client-local-video-track",tq.REQUEST_NEW_WORKER_URL="request-new-worker-url",tq),Ia=((tJ={})[tJ.CONNECT_AP=0]="CONNECT_AP",tJ[tJ.AP_CONNECTED=1]="AP_CONNECTED",tJ[tJ.CONNECT_WORKER_MANAGER=2]="CONNECT_WORKER_MANAGER",tJ[tJ.WORKER_MANAGER_CONNECTED=3]="WORKER_MANAGER_CONNECTED",tJ[tJ.GET_WORKER_MANAGER_RESPONSE=4]="GET_WORKER_MANAGER_RESPONSE",tJ[tJ.CONNECT_WORKER=5]="CONNECT_WORKER",tJ[tJ.WORKER_CONNECTED=6]="WORKER_CONNECTED",tJ[tJ.CLOSED=7]="CLOSED",tJ),Io=((tX={}).CALL="call",tX.CANDIDATE="candidate",tX.PUBLISH="publish",tX.UNPUBLISH="unpublish",tX.CONTROL="control",tX.RESTART_ICE="restart_ice",tX.ACK="ack",tX.RESPONSE="response",tX.JOIN="join",tX.CHECK="check",tX),Is=((tQ={}).ABORT="abort",tQ),Ic=((tZ={}).MUTE_LOCAL_AUDIO="mute_local_audio",tZ.MUTE_LOCAL_VIDEO="mute_local_video",tZ.UNMUTE_LOCAL_AUDIO="unmute_local_audio",tZ.UNMUTE_LOCAL_VIDEO="unmute_local_video",tZ),Id=((t$={}).P2P_TOKEN_TIMEOUT="p2p_token_timeout",t$.P2P_TOKEN_CHANGED="p2p_token_changed",t$),Il={[Rc.ACCESS_POINT]:{[Rh.NO_FLAG_SET]:{desc:"flag is zero",retry:!1},[Rh.FLAG_SET_BUT_EMPTY]:{desc:"flag is empty",retry:!1},[Rh.INVALID_FALG_SET]:{desc:"invalid flag",retry:!1},[Rh.FLAG_SET_BUT_NO_RE]:{desc:"flag set unilbs but no request",retry:!1},[Rh.INVALID_SERVICE_ID]:{desc:"invalid service id",retry:!1},[Rh.NO_SERVICE_AVAILABLE]:{desc:"no service available",retry:!0},[Rh.NO_SERVICE_AVAILABLE_P2P]:{desc:"no unilbs p2p service available",retry:!0},[Rh.NO_SERVICE_AVAILABLE_VOICE]:{desc:"no unilbs voice service available",retry:!0},[Rh.NO_SERVICE_AVAILABLE_WEBRTC]:{desc:"no unilbs webrtc service available",retry:!0},[Rh.NO_SERVICE_AVAILABLE_CDS]:{desc:"no cds service available",retry:!0},[Rh.NO_SERVICE_AVAILABLE_CDN]:{desc:"no cdn dispatcher service available",retry:!0},[Rh.NO_SERVICE_AVAILABLE_TDS]:{desc:"no tds service available",retry:!0},[Rh.NO_SERVICE_AVAILABLE_REPORT]:{desc:"no unilbs report service available",retry:!0},[Rh.NO_SERVICE_AVAILABLE_APP_CENTER]:{desc:"no app center service available",retry:!0},[Rh.NO_SERVICE_AVAILABLE_ENV0]:{desc:"no unilbs sig env0 service available",retry:!0},[Rh.NO_SERVICE_AVAILABLE_VOET]:{desc:"no unilbs voet service available",retry:!0},[Rh.NO_SERVICE_AVAILABLE_STRING_UID]:{desc:"no string uid service available",retry:!0},[Rh.NO_SERVICE_AVAILABLE_WEBRTC_UNILBS]:{desc:"no webrtc unilbs service available",retry:!0}},[Rc.UNILBS]:{[Rl.INVALID_VENDOR_KEY]:{desc:"invalid vendor key, can not find appid",retry:!1},[Rl.INVALID_CHANNEL_NAME]:{desc:"invalid channel name",retry:!1},[Rl.INTERNAL_ERROR]:{desc:"unilbs internal error",retry:!1},[Rl.NO_AUTHORIZED]:{desc:"invalid token, authorized failed",retry:!1},[Rl.DYNAMIC_KEY_TIMEOUT]:{desc:"dynamic key or token timeout",retry:!1},[Rl.NO_ACTIVE_STATUS]:{desc:"no active status",retry:!1},[Rl.DYNAMIC_KEY_EXPIRED]:{desc:"dynamic key expired",retry:!1},[Rl.STATIC_USE_DYNAMIC_KEY]:{desc:"static use dynamic key",retry:!1},[Rl.DYNAMIC_USE_STATIC_KEY]:{desc:"dynamic use static key",retry:!1},[Rl.USER_OVERLOAD]:{desc:"amount of users over load",retry:!1},[Rl.FORBIDDEN_REGION]:{desc:"the request is forbidden in this area",retry:!1},[Rl.CANNOT_MEET_AREA_DEMAND]:{desc:"unable to allocate services in this area",retry:!1}},[Rc.STRING_UID_ALLOCATOR]:{[Rd.IIIEGAL_APPID]:{desc:"invalid appid",retry:!1},[Rd.IIIEGAL_UID]:{desc:"invalid string uid",retry:!1},[Rd.INTERNAL_ERROR]:{desc:"string uid allocator internal error",retry:!0}}};function MV(L){let k=Il[Math.floor(L/1e4)];if(!k)return{desc:"unknown error",retry:!1};let M=k[L%1e4];if(!M){if(Math.floor(L/1e4)===Rc.ACCESS_POINT){let k=L%1e4;if("1"===k.toString()[0])return{desc:L.toString(),retry:!1};if("2"===k.toString()[0])return{desc:L.toString(),retry:!0}}return{desc:"unknown error",retry:!1}}return M}let Ih={[Rp.K_TIMESTAMP_EXPIRED]:{desc:"K_TIMESTAMP_EXPIRED",action:"failed"},[Rp.K_CHANNEL_PERMISSION_INVALID]:{desc:"K_CHANNEL_PERMISSION_INVALID",action:"failed"},[Rp.K_CERTIFICATE_INVALID]:{desc:"K_CERTIFICATE_INVALID",action:"failed"},[Rp.K_CHANNEL_NAME_EMPTY]:{desc:"K_CHANNEL_NAME_EMPTY",action:"failed"},[Rp.K_CHANNEL_NOT_FOUND]:{desc:"K_CHANNEL_NOT_FOUND",action:"failed"},[Rp.K_TICKET_INVALID]:{desc:"K_TICKET_INVALID",action:"failed"},[Rp.K_CHANNEL_CONFLICTED]:{desc:"K_CHANNEL_CONFLICTED",action:"failed"},[Rp.K_SERVICE_NOT_READY]:{desc:"K_SERVICE_NOT_READY",action:"tryNext"},[Rp.K_SERVICE_TOO_HEAVY]:{desc:"K_SERVICE_TOO_HEAVY",action:"tryNext"},[Rp.K_UID_BANNED]:{desc:"K_UID_BANNED",action:"failed"},[Rp.K_IP_BANNED]:{desc:"K_IP_BANNED",action:"failed"},[Rp.DATASTREAM2_NOT_AVAILABLE]:{desc:"DATASTREAM2_NOT_AVAILABLE",action:"quit"},[Rp.K_AUTO_REBALANCE]:{desc:"k_AUTO_REBALANCE",action:"recover"},[Rp.ERR_INVALID_VENDOR_KEY]:{desc:"ERR_INVALID_VENDOR_KEY",action:"failed"},[Rp.ERR_INVALID_CHANNEL_NAME]:{desc:"ERR_INVALID_CHANNEL_NAME",action:"failed"},[Rp.WARN_NO_AVAILABLE_CHANNEL]:{desc:"WARN_NO_AVAILABLE_CHANNEL",action:"failed"},[Rp.WARN_LOOKUP_CHANNEL_TIMEOUT]:{desc:"WARN_LOOKUP_CHANNEL_TIMEOUT",action:"tryNext"},[Rp.WARN_LOOKUP_CHANNEL_REJECTED]:{desc:"WARN_LOOKUP_CHANNEL_REJECTED",action:"failed"},[Rp.WARN_OPEN_CHANNEL_TIMEOUT]:{desc:"WARN_OPEN_CHANNEL_TIMEOUT",action:"tryNext"},[Rp.WARN_OPEN_CHANNEL_REJECTED]:{desc:"WARN_OPEN_CHANNEL_REJECTED",action:"failed"},[Rp.WARN_REQUEST_DEFERRED]:{desc:"WARN_REQUEST_DEFERRED",action:"failed"},[Rp.ERR_DYNAMIC_KEY_TIMEOUT]:{desc:"ERR_DYNAMIC_KEY_TIMEOUT",action:"failed"},[Rp.ERR_NO_AUTHORIZED]:{desc:"ERR_NO_AUTHORIZED",action:"failed"},[Rp.ERR_VOM_SERVICE_UNAVAILABLE]:{desc:"ERR_VOM_SERVICE_UNAVAILABLE",action:"tryNext"},[Rp.ERR_NO_CHANNEL_AVAILABLE_CODE]:{desc:"ERR_NO_CHANNEL_AVAILABLE_CODE",action:"failed"},[Rp.ERR_MASTER_VOCS_UNAVAILABLE]:{desc:"ERR_MASTER_VOCS_UNAVAILABLE",action:"tryNext"},[Rp.ERR_INTERNAL_ERROR]:{desc:"ERR_INTERNAL_ERROR",action:"tryNext"},[Rp.ERR_NO_ACTIVE_STATUS]:{desc:"ERR_NO_ACTIVE_STATUS",action:"failed"},[Rp.ERR_INVALID_UID]:{desc:"ERR_INVALID_UID",action:"failed"},[Rp.ERR_DYNAMIC_KEY_EXPIRED]:{desc:"ERR_DYNAMIC_KEY_EXPIRED",action:"failed"},[Rp.ERR_STATIC_USE_DYANMIC_KE]:{desc:"ERR_STATIC_USE_DYANMIC_KE",action:"failed"},[Rp.ERR_DYNAMIC_USE_STATIC_KE]:{desc:"ERR_DYNAMIC_USE_STATIC_KE",action:"failed"},[Rp.ERR_NO_VOCS_AVAILABLE]:{desc:"ERR_NO_VOCS_AVAILABLE",action:"tryNext"},[Rp.ERR_NO_VOS_AVAILABLE]:{desc:"ERR_NO_VOS_AVAILABLE",action:"tryNext"},[Rp.ERR_JOIN_CHANNEL_TIMEOUT]:{desc:"ERR_JOIN_CHANNEL_TIMEOUT",action:"tryNext"},[Rp.ERR_JOIN_BY_MULTI_IP]:{desc:"ERR_JOIN_BY_MULTI_IP",action:"recover"},[Rp.ERR_NOT_JOINED]:{desc:"ERR_NOT_JOINED",action:"failed"},[Rp.ERR_REPEAT_JOIN_REQUEST]:{desc:"ERR_REPEAT_JOIN_REQUEST",action:"quit"},[Rp.ERR_REPEAT_JOIN_CHANNEL]:{desc:"ERR_REPEAT_JOIN_CHANNEL",action:"quit"},[Rp.ERR_INVALID_STRINGUID]:{desc:"ERR_INVALID_STRINGUID",action:"failed"},[Rp.ERR_TOO_MANY_USERS]:{desc:"ERR_TOO_MANY_USERS",action:"tryNext"},[Rp.ERR_SET_CLIENT_ROLE_TIMEOUT]:{desc:"ERR_SET_CLIENT_ROLE_TIMEOUT",action:"failed"},[Rp.ERR_SET_CLIENT_ROLE_NO_PERMISSION]:{desc:"ERR_SET_CLIENT_ROLE_TIMEOUT",action:"failed"},[Rp.ERR_SET_CLIENT_ROLE_ALREADY_IN_USE]:{desc:"ERR_SET_CLIENT_ROLE_ALREADY_IN_USE",action:"success"},[Rp.ERR_PUBLISH_REQUEST_INVALID]:{desc:"ERR_PUBLISH_REQUEST_INVALID",action:"failed"},[Rp.ERR_SUBSCRIBE_REQUEST_INVALID]:{desc:"ERR_SUBSCRIBE_REQUEST_INVALID",action:"failed"},[Rp.ERR_NOT_SUPPORTED_MESSAGE]:{desc:"ERR_NOT_SUPPORTED_MESSAGE",action:"failed"},[Rp.ERR_ILLEAGAL_PLUGIN]:{desc:"ERR_ILLEAGAL_PLUGIN",action:"failed"},[Rp.ILLEGAL_CLIENT_ROLE_LEVEL]:{desc:"ILLEGAL_CLIENT_ROLE_LEVEL",action:"failed"},[Rp.ERR_REJOIN_TOKEN_INVALID]:{desc:"ERR_REJOIN_TOKEN_INVALID",action:"failed"},[Rp.ERR_REJOIN_USER_NOT_JOINED]:{desc:"ERR_REJOIN_NOT_JOINED",action:"failed"},[Rp.ERR_INVALID_OPTIONAL_INFO]:{desc:"ERR_INVALID_OPTIONAL_INFO",action:"quit"},[Rp.ERR_TEST_RECOVER]:{desc:"ERR_TEST_RECOVER",action:"recover"},[Rp.ERR_TEST_TRYNEXT]:{desc:"ERR_TEST_TRYNEXT",action:"recover"},[Rp.ERR_TEST_RETRY]:{desc:"ERR_TEST_RETRY",action:"recover"},[Rp.ILLEGAL_AES_PASSWORD]:{desc:"ERR_TEST_RETRY",action:"failed"},[Rp.ERR_TOO_MANY_BROADCASTERS]:{desc:"ERR_TOO_MANY_BROADCASTERS",action:"failed"},[Rp.ERR_TOO_MANY_SUBSCRIBERS]:{desc:"ERR_TOO_MANY_SUBSCRIBERS",action:"failed"},[Rp.ERR_LICENSE_ILLEGAL]:{desc:"ERR_LICENSE_ILLEGAL",action:"quit"},[Rp.ERR_LICENSE_MISSING]:{desc:"ERR_LICENSE_MISSING",action:"quit"},[Rp.ERR_LICENSE_EXPIRED]:{desc:"ERR_LICENSE_EXPIRED",action:"quit"},[Rp.ERR_LICENSE_MINUTES_EXCEEDED]:{desc:"ERR_LICENSE_MINUTES_EXCEEDED",action:"quit"},[Rp.ERR_LICENSE_PERIOD_INVALID]:{desc:"ERR_LICENSE_PERIOD_INVALID",action:"quit"},[Rp.ERR_LICENSE_MULTIPLE_SDK_SERVICE]:{desc:"ERR_LICENSE_MULTIPLE_SDK_SERVICE",action:"quit"}};function VV(L){let k=Ih[L];return k||{desc:"UNKNOWN_ERROR_".concat(L),action:"failed"}}function xV(L,k){var M=Object.keys(L);if(Object.getOwnPropertySymbols){var U=Object.getOwnPropertySymbols(L);k&&(U=U.filter(function(k){return Object.getOwnPropertyDescriptor(L,k).enumerable})),M.push.apply(M,U)}return M}function FV(L){for(var k=1;k<arguments.length;k++){var M=null!=arguments[k]?arguments[k]:{};k%2?xV(Object(M),!0).forEach(function(k){uI(L,k,M[k])}):Object.getOwnPropertyDescriptors?Object.defineProperties(L,Object.getOwnPropertyDescriptors(M)):xV(Object(M)).forEach(function(k){Object.defineProperty(L,k,Object.getOwnPropertyDescriptor(M,k))})}return L}function BV(L,k){if("string"==typeof L)return L;let{proxy:M,host:U,port:V}=L;if(k){let L=wN("JOIN_GATEWAY_FALLBACK_PORT")||443;return 443===L?"wss://".concat(U,"/ws/?p=").concat(Number(V)+150):"wss://".concat(U,":").concat(L,"/ws/?p=").concat(Number(V)+150)}return M?"wss://".concat(M,"/ws/?h=").concat(U,"&p=").concat(V):"wss://".concat(U,":").concat(V)}let Ip=/wss:\/\/(.+)\/ws\/\?h=(.+)&p=([0-9]+)\/?/,I_=/wss:\/\/(.+)\/ws\/\?p=([0-9]+)\/?/,IE=/wss:\/\/(.+):([0-9]+)\/?/,Im=/wss:\/\/(.[^\/]+)\/?/,Ig=0;let YV=class YV{constructor(L,k){uI(this,"id",0),uI(this,"store",void 0),uI(this,"recordIndex",void 0),uI(this,"websockets",[]),uI(this,"try443PortDuration",2e3),uI(this,"forceCloseWSDuration",5e3),uI(this,"try443PortTimeout",null),uI(this,"forceCloseTimeout",null),uI(this,"isTry443PortFailed",!1),uI(this,"isNormalPortFailed",!1),uI(this,"useDoubleDomain",!1),uI(this,"useProxy",!1),uI(this,"startTime",Date.now()),this.id=++Ig,this.try443PortDuration=wN("JOIN_GATEWAY_TRY_443PORT_DURATION")||2e3,this.forceCloseWSDuration=L||5e3,this.store=k}closeAllWebsockets(){this.websockets.forEach(L=>{L.onopen=null,L.onclose=null,L.onmessage=null,L.close()}),this.websockets.length=0}clearTimeout(){this.forceCloseTimeout&&clearTimeout(this.forceCloseTimeout),this.try443PortTimeout&&clearTimeout(this.try443PortTimeout),this.forceCloseTimeout=null,this.try443PortTimeout=null}logger(){var L;let k=Date.now()-this.startTime;for(var M=arguments.length,U=Array(M),V=0;V<M;V++)U[V]=arguments[V];gc.debug("[choose-best-ws ".concat(null===(L=this.store)||void 0===L?void 0:L.clientId," ").concat(this.id,"] ").concat(k,"ms:"),...U)}createWebSocket(L,k,M){this.logger("createWebSocket:",L,{isTry443Port:k,hasTimeoutDetection:M});let U=wN("GATEWAY_DOMAINS"),V=Date.now(),F=[],B=U.find(k=>{var M;return so(M=L.host).call(M,k)});B||(this.useDoubleDomain=!1);let j=[];if(this.useDoubleDomain)U.forEach(M=>{j.push(BV(FV(FV({},L),{},{host:L.host.replace(B,M)}),k))});else{let M=FV({},L);if(k&&B){let L=U.find(L=>L!==B);L&&(M.host=M.host.replace(B,L))}j.push(BV(M,k))}try{j.forEach(L=>{let k=new WebSocket(L);k.binaryType="arraybuffer",F.push(k),this.logger("ws is connecting:",k.url)})}catch(U){if(this.logger("ws create failed"),F.forEach(L=>L.close()),F.length=0,this.useDoubleDomain)return this.useDoubleDomain=!1,this.createWebSocket(L,k,M);if(!k&&443!==Number(L.port))return this.createWebSocket(L,!0,M);throw new ED(f1.WS_ERR,"init websocket failed! Error: ".concat(U.toString()))}let G=xA();this.store&&this.store.recordJoinChannelService({urls:F.map(L=>L.url),service:"gateway"},this.recordIndex),F.forEach(L=>{L.onopen=()=>{this.logger("onopen: ws ".concat(L.url," open cost ").concat(Date.now()-V,"ms")),this.websockets.forEach(k=>{k!==L&&(k.onopen=null,k.onclose=null,k.onmessage=null,k.close(),this.logger("close backup websocket: ".concat(k.url)))}),this.websockets.length=0,G.resolve(L)},L.onclose=M=>{this.logger("onclose: ws ".concat(L.url," closed cost ").concat(Date.now()-V,"ms state: ").concat(L.readyState));let U=F.every(L=>L.readyState===WebSocket.CLOSED||L.readyState===WebSocket.CLOSING);this.logger("".concat(k?"443":"47xx"," websocket closed, all failed: ").concat(U)),U&&(k||this.isTry443PortFailed||this.useProxy)?(this.logger("onclose: all websocket is closed, ".concat(M.reason)),G.reject({code:M.code,reason:RK.A_ROUND_WS_FAILED})):!k&&U&&!this.isNormalPortFailed&&this.try443PortTimeout&&(this.logger("all 47xx websocket is closed, try 443 port"),this.clearTimeout(),l()),k?this.isTry443PortFailed=U:this.isNormalPortFailed=U},L.onmessage=k=>this.logger("".concat(L.url," onmessage: ").concat(k.data))}),this.websockets.push(...F);let d=()=>{this.websockets.forEach(L=>L.readyState!==WebSocket.OPEN&&L.close())},l=()=>{if(G.isResolved)return d();zA().os===fX.MAC_OS&&iw()&&d(),this.createWebSocket(L,!0,!0).then(L=>{G.resolve(L)}).catch(L=>{this.isNormalPortFailed&&G.reject(L),this.logger("try 443 port to create ws failed")}),this.forceCloseTimeout=window.setTimeout(()=>{this.logger("5s timeout close un-opens, isWebsocket created: ",G.isResolved),this.forceCloseTimeout=null,d()},this.forceCloseWSDuration)};return M||(()=>{if(k||this.useProxy)return this.logger("add 5s timeout at ".concat(k?"try-443":"proxy"," condition")),this.forceCloseTimeout=window.setTimeout(()=>{this.forceCloseTimeout=null,d()},this.forceCloseWSDuration);this.try443PortTimeout=window.setTimeout(()=>{this.logger("2s timeout, isWebsocket created: ",G.isResolved),this.try443PortTimeout=null,l()},this.try443PortDuration)})(),G.promise}chooseBestWebsocket(L,k,M,U){var V;let F,B,j;return this.useDoubleDomain=!!k,"string"==typeof L&&(V=L,[,F,B,j]=V.match(Ip)||[],F||([,B,j]=V.match(I_)||[]),B&&j||([,B,j]=V.match(IE)||[]),B&&j||([,B]=V.match(Im)||[]),B||gc.warning("un-destructible url: ",V),L={proxy:F,host:B,port:j||"443"}),this.recordIndex=U,this.useProxy=!!L.proxy,M&&this.useProxy&&(gc.warn("cannot use 443 only when use proxy"),M=!1),this.createWebSocket(L,!!M,!1).finally(()=>this.clearTimeout())}};function zV(L,k){var M=Object.keys(L);if(Object.getOwnPropertySymbols){var U=Object.getOwnPropertySymbols(L);k&&(U=U.filter(function(k){return Object.getOwnPropertyDescriptor(L,k).enumerable})),M.push.apply(M,U)}return M}let qV=class qV extends Hw{get url(){return this.websocket&&this.websocket.url||this._websocketUrl}get reconnectMode(){return this._reconnectMode}set reconnectMode(L){var k;so(k=["tryNext","recover"]).call(k,L)&&this.resetReconnectCount(L),this._reconnectMode=L}get state(){return this._state}set state(L){L!==this._state&&(this._state=L,"reconnecting"===this._state?this.emit(RI.RECONNECTING,this.reconnectReason):"connected"===this._state?this.emit(RI.CONNECTED):"closed"===this._state?this.emit(RI.CLOSED):"failed"===this._state&&this.emit(RI.FAILED))}resetReconnectCount(L){gc.debug("websocket reset reconnect count, reason: "+L),this.reconnectCount=0}constructor(L,k){let M=arguments.length>2&&void 0!==arguments[2]&&arguments[2],U=arguments.length>3&&void 0!==arguments[3]&&arguments[3],V=arguments.length>4&&void 0!==arguments[4]&&arguments[4],F=arguments.length>5?arguments[5]:void 0;super(),uI(this,"_websocketUrl",null),uI(this,"connectionID",0),uI(this,"currentURLIndex",0),uI(this,"urls",[]),uI(this,"_reconnectMode","tryNext"),uI(this,"reconnectReason",void 0),uI(this,"_initMutex",void 0),uI(this,"name",void 0),uI(this,"_state","closed"),uI(this,"reconnectInterrupter",void 0),uI(this,"websocket",void 0),uI(this,"retryConfig",void 0),uI(this,"reconnectCount",0),uI(this,"forceCloseTimeout",5e3),uI(this,"onlineReconnectListener",void 0),uI(this,"useCompress",void 0),uI(this,"tryDoubleDomain",!1),uI(this,"use443PortOnly",!1),uI(this,"wsInflateLength",0),uI(this,"wsDeflateLength",0),uI(this,"closeEstablishingWs",()=>{}),uI(this,"store",void 0),uI(this,"joinGatewayRecordIndex",void 0),this.store=F,this.name=L,this.retryConfig=function(L){for(var k=1;k<arguments.length;k++){var M=null!=arguments[k]?arguments[k]:{};k%2?zV(Object(M),!0).forEach(function(k){uI(L,k,M[k])}):Object.getOwnPropertyDescriptors?Object.defineProperties(L,Object.getOwnPropertyDescriptors(M)):zV(Object(M)).forEach(function(k){Object.defineProperty(L,k,Object.getOwnPropertyDescriptor(M,k))})}return L}({},k),this.useCompress=M,this.tryDoubleDomain=U,this.use443PortOnly=V,this._initMutex=new S_("websocket",F?F.clientId:void 0);let{timeout:B,timeoutFactor:j}=k,G=Math.max(300,Math.floor(3*B/5)),X=Math.max(1.2,Math.floor(8*j)/10);Sa.ONLINE&&(this.retryConfig.timeout=G,this.retryConfig.timeoutFactor=X),Ss.on(So.NETWORK_STATE_CHANGE,(L,k)=>{L!==k&&(this.resetReconnectCount("network state change: ".concat(k," -> ").concat(L)),L===Sa.ONLINE?(this.retryConfig.timeout=G,this.retryConfig.timeoutFactor=X):(this.retryConfig.timeout=B,this.retryConfig.timeoutFactor=j))})}getConnection(){return this.websocket||void 0}async init(L){let k=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5e3,M=await this._initMutex.lock();this._reconnectMode="tryNext",this.forceCloseTimeout=k,this.urls=L,this.state="connecting";try{var U,V;let L=xA(),k=this.urls[this.currentURLIndex];null===(U=this.store)||void 0===U||U.beforeConnect(),V=this.store,gD()||wN("USE_NEW_TOKEN")||!wN("ENABLE_PREALLOC_PC")&&(null==V||!V.autoSubscribe||wN("FORCE_DISABLE_AUTO_SUB"))||this.emit(It.PRE_CONNECT_PC),this.createWebSocketConnection(k).then(L.resolve).catch(L.reject),this.once(RI.CLOSED,()=>{L.reject(new f2(f1.WS_DISCONNECT))}),this.once(RI.CONNECTED,L.resolve),await L.promise}catch(L){}finally{M()}}close(L,k){if(this.currentURLIndex=0,this.resetReconnectCount("close"),this.reconnectInterrupter&&this.reconnectInterrupter(),this.websocket){this.websocket.onclose=null,this.websocket.onopen=null,this.websocket.onmessage=null;let L=this.websocket;k?setTimeout(()=>L.close(),500):L.close(),this.websocket=void 0,this._websocketUrl=null}this.state=L?"failed":"closed",this.closeEstablishingWs&&this.closeEstablishingWs()}reconnect(L,k){if(!this.websocket)return void gc.warning("[".concat(this.name,"] can not reconnect, no websocket"));void 0!==L&&(this.reconnectMode=L),gc.debug("[".concat(this.name,"] reconnect is triggered initiative")),"number"==typeof this.joinGatewayRecordIndex&&this.store&&this.store.recordJoinChannelService({status:"error",errors:[Error(k)]},this.joinGatewayRecordIndex);let M=this.websocket.onclose;this.websocket.onclose=null,this.websocket.close(),M&&M.bind(this.websocket)({code:9999,reason:k})}sendMessage(L){let k=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!this.websocket||this.websocket.readyState!==WebSocket.OPEN)throw new f2(f1.WS_ABORT,"websocket is not ready");try{k||(L=JSON.stringify(L)),this.websocket.send(L)}catch(L){throw new f2(f1.WS_ERR,"send websocket message error"+L.toString())}}setWsInflateData(L){this.wsDeflateLength=this.wsDeflateLength+L.originLength,this.wsInflateLength=this.wsInflateLength+L.compressedLength}getWsInflateData(){let L=this.wsInflateLength,k=this.wsDeflateLength;return this.clearWsInflateData(),{wsInflateLength:L,wsDeflateLength:k}}clearWsInflateData(){this.wsInflateLength=0,this.wsDeflateLength=0}async createWebSocketConnection(L){var k,M;let U=xA();this.connectionID+=1,this.joinGatewayRecordIndex=void 0;let n=L=>{var k;null===(k=this.store)||void 0===k||k.signalChannelOpen(),gc.debug("[".concat(this.name,"] websocket opened:"),L),this.reconnectMode="retry",this.state="connected",this.resetReconnectCount("opened"),U.resolve()},r=async L=>{var k;if(gc.debug("[".concat(this.name,"] websocket close ").concat(null===(k=this.websocket)||void 0===k?void 0:k.url,", code: ").concat(L.code,", reason: ").concat(L.reason,", current mode: ").concat(this.reconnectMode)),this.reconnectCount>=this.retryConfig.maxRetryCount)U.reject(new f2(f1.WS_DISCONNECT,"websocket close: ".concat(L.code))),this.close();else{"connected"===this.state&&(this.reconnectReason=L.reason,this.state="reconnecting");let k=aO(this,RI.WILL_RECONNECT,this.reconnectMode,L.reason)||this.reconnectMode,M=await this.reconnectWithAction(k);if("closed"===this.state)return void gc.debug("[".concat(this.connectionID,"] ws is closed, no need to reconnect"));if(!M)return U.reject(new f2(f1.WS_DISCONNECT,"websocket reconnect failed: ".concat(L.code))),this.close(!0);U.resolve()}};this.websocket&&(this.websocket.onclose=null,this.websocket.close()),wN("GATEWAY_WSS_ADDRESS")&&this.name.startsWith("gateway")&&(L=wN("GATEWAY_WSS_ADDRESS")),gc.debug("[".concat(this.name,"] start connect, url:"),L);let V=null===(k=this.store)||void 0===k?void 0:k.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"gateway"});try{this._websocketUrl=BV(L);let k=await this.chooseBestWebsocketConnection(L);this.websocket=k,n&&n(this.websocket.url),this.websocket.onclose=r,this.websocket.onmessage=L=>{this.emit(RI.ON_MESSAGE,L)},this.websocket.onerror=L=>{gc.warn("[".concat(this.connectionID,"] ws open error ").concat(L))},null===(M=this.store)||void 0===M||M.recordJoinChannelService({endTs:Date.now(),status:"success"},V),this.joinGatewayRecordIndex=V}catch(j){let L="closed"===this.state,k=j instanceof f2,M=k&&j.code===f1.WS_ABORT,F=k&&j.code===f1.WS_ERR,B=k?j.message:j&&(j.reason||j.toString());gc.warning("[choose-best-ws] chooseBestWebsocket error: ".concat(B)),this.store&&this.store.recordJoinChannelService({endTs:Date.now(),status:M?"aborted":"error",errors:[j]},V),L||F?(U.reject(L?new f2(f1.WS_DISCONNECT,"websocket is closed: ".concat(B)):new f2(f1.WS_ERR,"init websocket failed: ".concat(B))),F&&gc.error("[".concat(this.name,"] init websocket failed: ").concat(B))):r&&r(j)}return U.promise}async reconnectWithAction(L){let k=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(this.reconnectCount>=this.retryConfig.maxRetryCount||0===this.urls.length||"closed"===this.state)return!1;gc.warning("[choose-best-ws] action: =>",L),this.onlineReconnectListener||Ss.isOnline||!Ss.onlineWaiter||(this.onlineReconnectListener=Ss.onlineWaiter.then(()=>{this.onlineReconnectListener=void 0}));let M=!0;if(this.reconnectInterrupter=()=>M=!1,k){let k=jO(this.reconnectCount,this.retryConfig);gc.debug("[".concat(this.name,"] wait ").concat(k,"ms to reconnect websocket, mode: ").concat(L)),await lQ.race([yO(k),this.onlineReconnectListener||new lQ(()=>{})])}if("closed"===this._state||!M)return!1;this.reconnectCount+=1;let n=async(L,k)=>{this.emit(RI.RECONNECT_CREATE_CONNECTION,k),await this.createWebSocketConnection(L)};try{if("retry"===L)await n(this.urls[this.currentURLIndex],L);else if("tryNext"===L){if(this.currentURLIndex+=1,this.currentURLIndex>=this.urls.length)return this.reconnectWithAction("recover",!1);gc.debug("[".concat(this.name,"] websocket url length: ").concat(this.urls.length," current index: ").concat(this.currentURLIndex)),await n(this.urls[this.currentURLIndex],L)}else"recover"===L&&(gc.debug("[".concat(this.name,"] request new urls")),this.resetReconnectCount("recover mode"),this.urls=await oO(this,RI.REQUEST_NEW_URLS),this.currentURLIndex=0,await n(this.urls[this.currentURLIndex],L))}catch(V){var U;gc.error("[".concat(this.name,"] reconnect failed ").concat(V&&V.toString()));let M=null==V||null===(U=V.data)||void 0===U?void 0:U.desc;return Array.isArray(M)&&so(M).call(M,"dynamic key expired")?(this.emit(RI.ON_TOKEN_PRIVILEGE_DID_EXPIRE),!1):this.reconnectWithAction(L,k)}return!0}};let XV=class XV extends qV{constructor(L,k){super(L,k,arguments.length>2&&void 0!==arguments[2]&&arguments[2],arguments.length>3&&void 0!==arguments[3]&&arguments[3],arguments.length>4&&void 0!==arguments[4]&&arguments[4],arguments.length>5?arguments[5]:void 0)}async chooseBestWebsocketConnection(L,k){let M=xA(),U=new YV(this.forceCloseTimeout,this.store);this.closeEstablishingWs=()=>{gc.debug("[choose-best-ws] close establishing websockets"),U.closeAllWebsockets(),M.reject(new f2(f1.WS_ABORT,"choose best websocket aborted"))};let V=wN("GATEWAY_DOMAINS");return gc.debug("[choose-best-ws] currentDomain: ",L,", domains: ",V,"total: ".concat(this.urls.length),"current: ".concat(this.currentURLIndex+1)),U.chooseBestWebsocket(L,this.tryDoubleDomain,this.use443PortOnly,k).then(M.resolve).catch(M.reject),M.promise.finally(()=>{this.closeEstablishingWs=void 0})}};let JV=class JV extends qV{constructor(L,k){super(L,k,arguments.length>2&&void 0!==arguments[2]&&arguments[2],arguments.length>3&&void 0!==arguments[3]&&arguments[3],arguments.length>4&&void 0!==arguments[4]&&arguments[4],arguments.length>5?arguments[5]:void 0)}async chooseBestWebsocketConnection(L,k){return new lQ((M,U)=>{var V,F;let B=!1,j=[];this.closeEstablishingWs=()=>{gc.debug("[choose-best-ws] close establishing websockets"),j.forEach(L=>{L.onclose=null,L.onopen=null,L.onmessage=null,L.close()}),U(new f2(f1.WS_ABORT,"choose best websocket aborted"))};let G=wN("GATEWAY_DOMAINS"),X=L.indexOf("?h="),$=G.find(k=>-1!==X?so(L).call(L,k,X):so(L).call(L,k));gc.debug("[choose-best-ws] currentDomain: ",$,", domains: ",G);let ee=!this.tryDoubleDomain||!$;if(!ee&&$){let F=Date.now();try{G.forEach(k=>{let M=-1===X?L.replace($,k):L.substr(0,X)+L.substr(X).replace($,k),U=new WebSocket(M);U.binaryType="arraybuffer",j.push(U),gc.debug("[choose-best-ws] ws is connecting:",U.url)})}catch(L){for(gc.debug("[choose-best-ws] ws create failed, fallback to single url"),j.forEach(L=>L.close());j.length;)j.pop();ee=!0}null===(V=this.store)||void 0===V||V.recordJoinChannelService({urls:j.map(L=>L.url),service:"gateway"},k),j.forEach(L=>{L.onopen=()=>{if(B)return;let k=Date.now()-F;gc.debug("[choose-best-ws] ws open cost ".concat(k,"ms")),j.filter(k=>k!==L).forEach(L=>{gc.debug("[choose-best-ws]close backup websocket: ".concat(L.url)),L.close()}),B=!0,M(L)},L.onclose=L=>{!B&&(j.find(L=>!(L.readyState===WebSocket.CLOSED||L.readyState===WebSocket.CLOSING))||(gc.debug("[choose-best-ws] all websocket is closed"),B=!0,U(L)))},L.onmessage=k=>{gc.debug("[choose-best-ws]".concat(L.url," onmessage: ").concat(k.data))}}),yO(this.forceCloseTimeout).then(()=>{j.forEach(L=>{L.readyState!==WebSocket.OPEN&&L.close()})})}if(ee){let V;gc.debug("[choose-best-ws] use single url: ",L),null===(F=this.store)||void 0===F||F.recordJoinChannelService({urls:[L],service:"gateway"},k);try{V=new WebSocket(L),j.push(V),V.binaryType="arraybuffer"}catch(k){let L=new f2(f1.WS_ERR,"init websocket failed! Error: ".concat(k.toString()));return gc.error("[".concat(this.name,"]").concat(L)),void U(L)}V.onopen=()=>{M(V)},V.onclose=L=>{U(L)},V.onmessage=L=>{gc.debug("[choose-best-ws]".concat(V.url," onmessage: ").concat(L.data))},yO(this.forceCloseTimeout).then(()=>{V&&V.readyState!==WebSocket.OPEN&&V.close()})}}).then(L=>(this.closeEstablishingWs=void 0,L)).catch(L=>{throw this.closeEstablishingWs=void 0,L})}};let ZV=class ZV extends Hw{get connectionState(){return this._connectionState}set connectionState(L){L!==this._connectionState&&(this._connectionState=L,L===R_.CONNECTED?this.emit(RE.WS_CONNECTED):L===R_.RECONNECTING?this.emit(RE.WS_RECONNECTING,this._websocketReconnectReason):L===R_.CLOSED&&this.emit(RE.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket&&this.websocket.url||null}get rtt(){return this.rttRolling.mean()}constructor(L,k){super(),uI(this,"_disconnectedReason",void 0),uI(this,"_websocketReconnectReason",void 0),uI(this,"_connectionState",R_.CLOSED),uI(this,"reconnectToken",void 0),uI(this,"websocket",void 0),uI(this,"openConnectionTime",void 0),uI(this,"clientId",void 0),uI(this,"lastMsgTime",Date.now()),uI(this,"uploadCache",[]),uI(this,"uploadCacheInterval",void 0),uI(this,"rttRolling",new SS(5)),uI(this,"pingpongTimer",void 0),uI(this,"wsInflateDataTimer",void 0),uI(this,"pingpongTimeoutCount",0),uI(this,"ortc",void 0),uI(this,"joinResponse",void 0),uI(this,"multiIpOption",void 0),uI(this,"initError",void 0),uI(this,"spec",void 0),uI(this,"store",void 0),uI(this,"onWebsocketMessage",L=>{if(L.data instanceof ArrayBuffer)return void this.emit(RE.ON_BINARY_DATA,L.data);let k=JSON.parse(L.data);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(k,"_id")){let L="res-@".concat(k._id);this.emit(L,k._result,k._message)}else if(Object.prototype.hasOwnProperty.call(k,"_type")){if(this.emit(k._type,k._message),k._type===RT.ON_NOTIFICATION&&this.handleNotification(k._message),k._type===RT.ON_USER_BANNED)switch(k._message.error_code){case 14:this.close(Se.UID_BANNED);break;case 15:this.close(Se.IP_BANNED);break;case 16:this.close(Se.CHANNEL_BANNED)}if(k._type===RT.ON_USER_LICENSE_BANNED)switch(k._message.error_code){case Rp.ERR_LICENSE_MISSING:this.close(Se.LICENSE_MISSING);break;case Rp.ERR_LICENSE_EXPIRED:this.close(Se.LICENSE_EXPIRED);break;case Rp.ERR_LICENSE_MINUTES_EXCEEDED:this.close(Se.LICENSE_MINUTES_EXCEEDED);break;case Rp.ERR_LICENSE_PERIOD_INVALID:this.close(Se.LICENSE_PERIOD_INVALID);break;case Rp.ERR_LICENSE_MULTIPLE_SDK_SERVICE:this.close(Se.LICENSE_MULTIPLE_SDK_SERVICE);break;case Rp.ERR_LICENSE_ILLEGAL:this.close(Se.LICENSE_ILLEGAL);break;default:this.close()}}}),this.clientId=L.clientId,this.spec=L,this.store=k,this.websocket=new XV("gateway-".concat(this.clientId),this.spec.retryConfig,!0,wN("JOIN_GATEWAY_USE_DUAL_DOMAIN"),wN("JOIN_GATEWAY_USE_443PORT_ONLY"),k),this.handleWebsocketEvents(),window.addEventListener("offline",()=>{this.connectionState===R_.CONNECTED&&this.reconnect("retry",Sr.OFFLINE)})}async request(L,k,M,U){let V=IO(6,""),F=this.websocket.connectionID,a=()=>new lQ((k,M)=>{if(this.connectionState===R_.CONNECTED)return k();let n=()=>{this.off(RE.WS_CLOSED,r),k()},r=()=>{this.off(RE.WS_CONNECTED,n),M(new ED(f1.WS_ABORT))};this.once(RE.WS_CONNECTED,n),this.once(RE.WS_CLOSED,r),L!==Rf.PUBLISH&&L!==Rf.PUBLISH_DATASTREAM&&L!==Rf.SUBSCRIBE&&L!==Rf.SUBSCRIBE_DATASTREAM&&L!==Rf.UNSUBSCRIBE&&L!==Rf.UNSUBSCRIBE_DATASTREAM&&L!==Rf.UNPUBLISH&&L!==Rf.UNPUBLISH_DATASTREAM&&L!==Rf.CONTROL&&L!==Rf.RESTART_ICE||this.once(RE.DISCONNECT_P2P,()=>{M(new ED(f1.DISCONNECT_P2P))}),L!==Rf.PUBLISH&&L!==Rf.RESTART_ICE||this.once(RE.ABORT_P2P_EXECUTION,()=>{M(new ED(f1.DISCONNECT_P2P))})});if(this.connectionState!==R_.CONNECTING&&this.connectionState!==R_.RECONNECTING||L===Rf.JOIN||L===Rf.REJOIN||await a(),this.websocket.sendMessage({_id:V,_type:L,_message:k},!0),U)return;let B=new lQ((M,U)=>{let B=!1,a=(U,V)=>{B=!0,M({isSuccess:"success"===U,message:V||{}}),this.off(RE.WS_CLOSED,c),this.off(RE.WS_RECONNECTING,c),this.emit(RE.REQUEST_SUCCESS,L,k)};this.once("res-@".concat(V),a);let c=()=>{U(new ED(f1.WS_ABORT,"type: ".concat(L))),this.off(RE.WS_CLOSED,c),this.off(RE.WS_RECONNECTING,c),this.off("res-@".concat(V),a)};this.once(RE.WS_CLOSED,c),this.once(RE.WS_RECONNECTING,c),yO(wN("SIGNAL_REQUEST_TIMEOUT")).then(()=>{this.websocket.connectionID!==F||B||(gc.warning("[".concat(this.clientId,"] ws request timeout, type: ").concat(L)),this.emit(RE.REQUEST_TIMEOUT,L,k))})}),j=null;try{j=await B}catch(U){if(this.connectionState===R_.CLOSED||L===Rf.LEAVE)throw new ED(f1.WS_ABORT);return!this.spec.forceWaitGatewayResponse||M?U.throw():L===Rf.JOIN||L===Rf.REJOIN?null:(await a(),await this.request(L,k))}if(j.isSuccess)return j.message;let G=Number(j.message.error_code||j.message.code),X=VV(G),$=new ED(f1.UNEXPECTED_RESPONSE,"".concat(X.desc,": ").concat(j.message.error_str),{code:G,data:j.message,desc:X.desc});return"success"===X.action?j.message:(gc.warning("[".concat(this.clientId,"] [").concat(this.websocket.connectionID,"] unexpected response from type ").concat(L,", error_code: ").concat(G,", message: ").concat(X.desc,", action: ").concat(X.action)),G===Rp.ERR_TOO_MANY_BROADCASTERS?((L===Rf.JOIN||L===Rf.REJOIN)&&(this.initError=$,this.close()),$.throw()):"failed"===X.action?$.throw():"quit"===X.action?(this.initError=$,this.close(),$.throw()):(G===Rp.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=j.message.option,gc.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",Sr.MULTI_IP)):this.reconnect(X.action,Sr.SERVER_ERROR),L===Rf.JOIN||L===Rf.REJOIN?null:await this.request(L,k)))}waitMessage(L,k){return new lQ(M=>{let n=U=>{(!k||k(U))&&(this.off(L,n),M(U))};this.on(L,n)})}uploadWRTCStats(L){if(!this.store.sessionId)return void gc.warn("[".concat(this.clientId,"] no session id when upload wrtc stats"));let k={lts:Date.now(),sid:this.store.sessionId,uid:this.store.intUid,stats:L};this.upload(RS.WRTC_STATS,k)}upload(L,k){let M={_type:L,_message:k};try{this.websocket.sendMessage(M)}catch(k){let L=wN("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(M),this.uploadCache.length>L&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval(()=>{if(this.connectionState!==R_.CONNECTED)return;let L=this.uploadCache.splice(0,1)[0];0===this.uploadCache.length&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(L._type,L._message)},wN("UPLOAD_CACHE_INTERVAL")||2e3))}}send(L,k){this.websocket.sendMessage({_type:L,_message:k})}init(L){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new lQ((k,M)=>{this.once(RE.WS_CONNECTED,()=>k(this.joinResponse)),this.once(RE.WS_CLOSED,L=>M(this.initError||new ED(f1.WS_ABORT,L))),this.connectionState=R_.CONNECTING,this.websocket.init(L).catch(M),this.wsInflateDataTimer&&window.clearInterval(this.wsInflateDataTimer),this.wsInflateDataTimer=window.setInterval(()=>{this.handleWsInflateData()},2e4)})}close(L){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.wsInflateDataTimer&&(this.handleWsInflateData(),window.clearInterval(this.wsInflateDataTimer),this.wsInflateDataTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._disconnectedReason=L||Se.LEAVE,this.connectionState=R_.CLOSED,gc.debug("[".concat(this.clientId,"] ")+"will close websocket in signal"),this.websocket.close()}async join(){if(!this.joinResponse){this.emit(RE.ABORT_P2P_EXECUTION),this.store.signalConnected();let L=await oO(this,RE.REQUEST_JOIN_INFO);this.store.joinReq();let k=await this.request(Rf.JOIN,L);if(this.ortc=null==L?void 0:L.ortc,this.store.joinRep(),!k)return this.emit(RE.REPORT_JOIN_GATEWAY,RK.TIMEOUT,this.url||""),!1;this.joinResponse=k,this.emit(RE.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=R_.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),!0}async rejoin(){if(!this.reconnectToken)throw new ED(f1.UNEXPECTED_ERROR,"can not rejoin, no rejoin token");let L=cO(this,RE.REQUEST_REJOIN_INFO);L.token=this.reconnectToken;let k=await this.request(Rf.REJOIN,L);return!!k&&(this.connectionState=R_.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),k.peers&&k.peers.forEach(L=>{this.emit(RT.ON_USER_ONLINE,{uid:L.uid}),L.audio&&this.emit(RT.ON_ADD_AUDIO_STREAM,{uid:L.uid,uint_id:L.uint_id,audio:!0,ssrcId:L.audio_ssrc}),L.video&&this.emit(RT.ON_ADD_VIDEO_STREAM,{uid:L.uid,uint_id:L.uint_id,video:!0,ssrcId:L.video_ssrc}),L.audio_mute?this.emit(RT.MUTE_AUDIO,{uid:L.uid}):this.emit(RT.UNMUTE_AUDIO,{uid:L.uid}),L.video_mute?this.emit(RT.MUTE_VIDEO,{uid:L.uid}):this.emit(RT.UNMUTE_VIDEO,{uid:L.uid}),L.audio_enable_local?this.emit(RT.ENABLE_LOCAL_AUDIO,{uid:L.uid}):this.emit(RT.DISABLE_LOCAL_AUDIO,{uid:L.uid}),L.video_enable_local?this.emit(RT.ENABLE_LOCAL_VIDEO,{uid:L.uid}):this.emit(RT.DISABLE_LOCAL_VIDEO,{uid:L.uid}),L.audio||L.video||this.emit(RT.ON_REMOVE_STREAM,{uid:L.uid,uint_id:L.uint_id})}),!0)}reconnect(L,k){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(L,k)}async downgradeCodec(L){if(!this.ortc)return!1;let k={downgrade_codec:L,ortc:this.ortc};return!!await this.request(Rf.DOWNGRADE_CODEC,k)}handleNotification(L){gc.debug("[".concat(this.clientId,"] receive notification: "),L);let k=VV(L.code);if(28===L.code&&"detail"in L&&(gc.info("[".concat(this.clientId,"] receive recover notification: "),L.detail),this.emit(RE.RECOVER_NOTIFICATION,L.detail)),"success"!==k.action){if("failed"!==k.action)return"quit"===k.action?("ERR_REPEAT_JOIN_CHANNEL"===k.desc&&this.close(Se.UID_BANNED),void this.close()):void this.reconnect(k.action,Sr.SERVER_ERROR);gc.error("[".concat(this.clientId,"] ignore error: "),k.desc)}}handlePingPong(){if(!this.websocket||"connected"!==this.websocket.state)return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;let L=wN("PING_PONG_TIME_OUT"),k=Date.now();this.pingpongTimeoutCount>=L&&(gc.warning("[".concat(this.clientId,"] PING-PONG Timeout. Last Socket Message: ").concat(k-this.lastMsgTime,"ms")),k-this.lastMsgTime>wN("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",Sr.TIMEOUT):this.request(Rf.PING,void 0,!0).then(()=>{this.pingpongTimeoutCount=0;let L=Date.now()-k;this.rttRolling.add(L),wN("REPORT_STATS")&&this.send(Rf.PING_BACK,{pingpongElapse:L})}).catch(L=>{})}handleWsInflateData(){let{wsInflateLength:L,wsDeflateLength:k}=this.websocket.getWsInflateData();0!==L&&0!==k&&this.upload(RS.WS_INFLATE_DATA_LENGTH,{ws_deflate_length:k,ws_inflate_length:L})}handleWebsocketEvents(){this.websocket.on(RI.RECONNECT_CREATE_CONNECTION,L=>{this.emit(RE.WS_RECONNECT_CREATE_CONNECTION,L)}),this.websocket.on(RI.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(RI.CLOSED,()=>{this.connectionState=R_.CLOSED}),this.websocket.on(RI.FAILED,()=>{this._disconnectedReason=Se.NETWORK_ERROR,this.connectionState=R_.CLOSED}),this.websocket.on(RI.RECONNECTING,L=>{this._websocketReconnectReason=L,this.joinResponse=void 0,this.connectionState===R_.CONNECTED?this.connectionState=R_.RECONNECTING:this.connectionState=R_.CONNECTING}),this.websocket.on(RI.WILL_RECONNECT,(L,k,M)=>{let U=cO(this,RE.IS_P2P_DISCONNECTED),V=U||"retry"!==L;U&&"retry"===L&&(gc.debug("".concat(this.clientId," reconnect mode is retry, but p2p lost, change to tryNext")),L="tryNext",k=RK.P2P_DISCONNECTED),V&&(gc.debug("".concat(this.clientId," will renewSession, reconnect mode: ").concat(L)),this.emit(RE.REPORT_JOIN_GATEWAY,k||RK.UNKNOWN_REASON,this.url||""),this.reconnectToken=void 0,this.emit(RE.DISCONNECT_P2P)),M(L)}),this.websocket.on(RI.CONNECTED,()=>{this.openConnectionTime=Date.now(),this.reconnectToken?this.rejoin().catch(L=>{gc.warning("[".concat(this.clientId,"] rejoin failed ").concat(L)),this.reconnect("tryNext",Sr.SERVER_ERROR)}):this.join().catch(L=>{if(this.emit(RE.REPORT_JOIN_GATEWAY,L,this.url||""),L instanceof ED){if(L.code===f1.UNEXPECTED_RESPONSE&&L.data.code===Rp.ERR_NO_AUTHORIZED)return this.initError=new ED(f1.TOKEN_EXPIRE,"dynamic key expired"),void this.close(Se.TOKEN_EXPIRE);gc.error("[".concat(this.clientId,"] join gateway request failed"),L.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",Sr.SERVER_ERROR):(this.initError=L,this.close())}})}),this.websocket.on(RI.REQUEST_NEW_URLS,(L,k)=>{oO(this,RE.REQUEST_RECOVER,this.multiIpOption).then(L).catch(k)}),this.websocket.on(RI.ON_TOKEN_PRIVILEGE_DID_EXPIRE,()=>{this.emit(RT.ON_TOKEN_PRIVILEGE_DID_EXPIRE)}),this.websocket.on(It.PRE_CONNECT_PC,()=>{this.emit(RE.PRE_CONNECT_PC)})}};let IR=((t0={}).NATIVE_RTC="native_rtc",t0.NATIVE_RTM="native_rtm",t0.WEB_RTC="web_rtc",t0.WEB_RTM="web_rtm",t0),II=((t1={})[t1.CHOOSE_SERVER=11]="CHOOSE_SERVER",t1[t1.CLOUD_PROXY=18]="CLOUD_PROXY",t1[t1.CLOUD_PROXY_5=20]="CLOUD_PROXY_5",t1[t1.CLOUD_PROXY_FALLBACK=26]="CLOUD_PROXY_FALLBACK",t1);function ex(L,k){var M=Object.keys(L);if(Object.getOwnPropertySymbols){var U=Object.getOwnPropertySymbols(L);k&&(U=U.filter(function(k){return Object.getOwnPropertyDescriptor(L,k).enumerable})),M.push.apply(M,U)}return M}function tx(L){for(var k=1;k<arguments.length;k++){var M=null!=arguments[k]?arguments[k]:{};k%2?ex(Object(M),!0).forEach(function(k){uI(L,k,M[k])}):Object.getOwnPropertyDescriptors?Object.defineProperties(L,Object.getOwnPropertyDescriptors(M)):ex(Object(M)).forEach(function(k){Object.defineProperty(L,k,Object.getOwnPropertyDescriptor(M,k))})}return L}function ix(L){return L.match(/^[\.\:\d]+$/)?"".concat(L.replace(/[^\d]/g,"-"),".").concat(wN("TURN_DOMAIN")):(gc.debug("Cannot recognized as ip address: ".concat(L,", use as host2")),L)}function nx(L){try{let k=wN("GATEWAY_DOMAINS").concat(wN("TURN_DOMAIN")).find(k=>so(L).call(L,k));if(k)return L.split(".".concat(k))[0].replace(/-/g,".");return L}catch(k){return gc.debug("serverUrlToIp error, fallback to url",L),L}}function rx(L,k){let M;L.addresses||(L.addresses=[]);let U=function(L,k){if(wN("CONNECT_GATEWAY_WITHOUT_DOMAIN"))return L.map(L=>{let{ip:k,port:M}=L;return{address:"".concat(k,":").concat(M)}});let M=wN("GATEWAY_DOMAINS"),U=M[1]&&so(k).call(k,M[1])?1:0;return L.map(L=>{let{domain_prefix:k,port:V,ip:F}=L;if(k)return{address:"".concat(k,".").concat(M[U++%M.length],":").concat(V)};let B=/^[\.\:\d]+$/.test(F),j=B?"".concat(F.replace(/[^\d]/g,"-"),".").concat(M[U++%M.length],":").concat(V):"".concat(F,":").concat(V);return B||gc.debug("Cannot recognized as ip address: ".concat(F,", use as host3")),{ip:F,port:V,address:j}})}(L.addresses,k),V=Array.isArray(L.detail)&&L.detail[18];if(V&&"string"==typeof V){let L=V.split(";");for(let k=0;k<L.length;k++){var F;let M=_p(F=L[k]).call(F);U[k]&&M&&(U[k].ip6=M)}}let B=L.detail&&L.detail.candidate;if(B){let[L,k]=B.split(":");L&&k&&(M={port:Number(k),ip:L,address:"".concat(L,":").concat(k)})}return{gatewayAddrs:U,apGatewayAddress:M,uid:L.uid,cid:L.cid,cert:L.cert,vid:L.detail&&L.detail[8],uni_lbs_ip:L.detail&&L.detail[1],res:L,csIp:L.detail&&L.detail[502]}}function ox(L){return"number"==typeof L?L:L.exact||L.ideal||L.max||L.min||0}function sx(L){let k=L._encoderConfig;if(!k)return{};let M={resolution:k.width&&k.height?"".concat(ox(k.width),"x").concat(ox(k.height)):void 0,maxVideoBW:k.bitrateMax,minVideoBW:k.bitrateMin};return"number"==typeof k.frameRate?(M.maxFrameRate=k.frameRate,M.minFrameRate=k.frameRate):k.frameRate&&(M.maxFrameRate=k.frameRate.max||k.frameRate.ideal||k.frameRate.exact||k.frameRate.min,M.minFrameRate=k.frameRate.min||k.frameRate.ideal||k.frameRate.exact||k.frameRate.max),M}function ax(L){return L>=0&&L<.17?1:L>=.17&&L<.36?2:L>=.36&&L<.59?3:L>=.59&&L<=1?4:L>1?5:0}function cx(L,k){let M,U,V;switch(k){case II.CHOOSE_SERVER:U=4096,V="choose server";break;case II.CLOUD_PROXY:U=1048576,V="proxy";break;case II.CLOUD_PROXY_5:U=4194304,V="proxy5";break;case II.CLOUD_PROXY_FALLBACK:U=4194310,V="proxy fallback";break;default:throw new ED(f1.UNEXPECTED_ERROR,"multi unlibs response transformer get unknown service id",{csIp:L.detail&&L.detail[502],retry:!1})}if(L.response_body.forEach(k=>{k.buffer&&k.buffer.flag===U&&(M={code:k.buffer.code,addresses:(k.buffer.edges_services||[]).map(L=>tx(tx({},L),{},{ticket:k.buffer.cert})),server_ts:L.enter_ts,uid:k.buffer.uid,cid:k.buffer.cid,cname:k.buffer.cname,detail:tx(tx({},k.buffer.detail),L.detail),flag:k.buffer.flag,opid:L.opid,cert:k.buffer.cert})}),!M)throw new ED(f1.MULTI_UNILBS_RESPONSE_ERROR,"cannot parse response ".concat(V," from multi unilbs response"),{csIp:L.detail&&L.detail[502]});return M}async function dx(L,k){return await lQ.all(L.addresses.map(async L=>({address:ix(L.ip),tcpport:L.port,udpport:L.port,username:k&&wN("ENCRYPT_PROXY_USERNAME_AND_PSW")&&window.isSecureContext?k.toString():SZ.username,password:k&&wN("ENCRYPT_PROXY_USERNAME_AND_PSW")&&window.isSecureContext?await Ww(k.toString()):SZ.password})))}function lx(L,k){let M=k.getMediaStreamTrack(!0).getSettings(),U=k.videoHeight||M.height,V=k.videoWidth||M.width;return U&&V?Math.max(Math.min(U,V)/Math.min(ox(L.height),ox(L.width)),1):(gc.warning("can't get ori-track's height, default scale down 4 times for low stream"),4)}function ux(L){let{candidateType:k,relayProtocol:M,type:U,address:V,port:F,protocol:B}=L,j={candidateType:k,relayProtocol:M,protocol:B};if("local-candidate"!==U){let L=V.split(".");L.length>=4&&(L[1]="*",L[2]="*"),j.address=L.join("."),j.port=F}return j}function hx(L){let k=L.split(":"),M=L.split(/[-.]/),U=so(L).call(L,"-")?"-":".",V=L;return k.length>1?M.length>1?(M[1]="**",V=M[0]+U+"**:"+k[k.length-1]):V=k.length>2?k[0]+U+"**:"+k[k.length-1]:"**:"+k[k.length-1]:M.length>1&&(V=M[0]+U+"**"),V}function px(){let L=arguments.length>0&&void 0!==arguments[0]?arguments[0]:wN("SVC_MODE");if(wN("ENABLE_SVC"))return L in Sj?L:Sj.L1T3}let Iv={[R1.VIDEO]:[{key:"abs-send-time",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"},{key:"video-orientation",extensionName:"urn:3gpp:video-orientation"},{key:"draft-holmer-rmcat-transport-wide-cc-extensions-01",extensionName:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"},{key:"playout-delay",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/playout-delay"},{key:"video-content-type",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/video-content-type"},{key:"color-space",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/color-space"},{key:"video-timing",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/video-timing"}],[R1.AUDIO]:[{key:"ssrc-audio-level",extensionName:"urn:ietf:params:rtp-hdrext:ssrc-audio-level"},{key:"draft-holmer-rmcat-transport-wide-cc-extensions-01",extensionName:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"},{key:"abs-send-time",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"}]};function Ex(L,k,M){k.forEach(k=>{var U;let V=Iv[L].find(L=>{var M;let{key:U}=L;return so(M=k.extensionName).call(M,U)});if(!V)return;let F=M.find(L=>{let{extensionName:k}=L;return so(k).call(k,V.key)});F&&so(U=F.extensionName).call(U,"gdpr_forbidden")&&(k.extensionName=F.extensionName)})}function mx(L,k){k.forEach(k=>{var M;let U=Iv[L].find(L=>{var M;let{key:U}=L;return so(M=k.extensionName).call(M,U)});so(M=k.extensionName).call(M,"gdpr_forbidden")&&U&&(k.extensionName=U.extensionName)})}function fx(L){return"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"===L||so(L).call(L,"abs-send-time")}function Sx(L){return"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"===L||so(L).call(L,"draft-holmer-rmcat-transport-wide-cc-extensions-01")}function gx(L,k){var M=Object.keys(L);if(Object.getOwnPropertySymbols){var U=Object.getOwnPropertySymbols(L);k&&(U=U.filter(function(k){return Object.getOwnPropertyDescriptor(L,k).enumerable})),M.push.apply(M,U)}return M}function Tx(L){for(var k=1;k<arguments.length;k++){var M=null!=arguments[k]?arguments[k]:{};k%2?gx(Object(M),!0).forEach(function(k){uI(L,k,M[k])}):Object.getOwnPropertyDescriptors?Object.defineProperties(L,Object.getOwnPropertyDescriptors(M)):gx(Object(M)).forEach(function(k){Object.defineProperty(L,k,Object.getOwnPropertyDescriptor(M,k))})}return L}function Rx(L){let k=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},M=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},U=arguments.length>3?arguments[3]:void 0,{filterRTX:V,filterVideoFec:F,filterAudioFec:B,filterAudioCodec:j,filterVideoCodec:G,unsupportedVideoUplinkCodec:X,unsupportedVideoDownlinkCodec:$}=k,{useXR:ee}=M,et=[],ei=[],er=[],en=[],ea=!1,eo=!1;if(FN(L).mediaDescriptions.forEach(L=>{U&&U!==L.attributes.direction||("video"!==L.media.mediaType||ea||(ei=L.attributes.payloads,en=L.attributes.extmaps,ea=!0),"audio"!==L.media.mediaType||eo||(et=L.attributes.payloads,er=L.attributes.extmaps,eo=!0))}),!en||0===ei.length)throw Error("Cannot get video capabilities from SDP.");if(!er||0===et.length)throw Error("Cannot get audio capabilities from SDP.");if(ei.forEach(L=>{var k;null!==(k=L.rtpMap)&&void 0!==k&&k.clockRate&&(L.rtpMap.clockRate=parseInt(L.rtpMap.clockRate)),ee&&L.rtcpFeedbacks.push({type:"rrtr"})}),et.forEach(L=>{var k;null!==(k=L.rtpMap)&&void 0!==k&&k.clockRate&&(L.rtpMap.clockRate=parseInt(L.rtpMap.clockRate)),ee&&L.rtcpFeedbacks.push({type:"rrtr"})}),V&&(et=et.filter(L=>{var k;return"rtx"!==(null===(k=L.rtpMap)||void 0===k?void 0:k.encodingName.toLowerCase())}),ei=ei.filter(L=>{var k;return"rtx"!==(null===(k=L.rtpMap)||void 0===k?void 0:k.encodingName.toLowerCase())})),F){let L=ei.filter(L=>{var k;return/(red)|(ulpfec)|(flexfec)/i.test((null===(k=L.rtpMap)||void 0===k?void 0:k.encodingName)||"")}),k=Fx(L,ei).map(L=>L.payloadType),M=[...L.map(L=>L.payloadType),...k];ei=ei.filter(L=>!so(M).call(M,L.payloadType))}if(B&&(et=et.filter(L=>{var k;return!/(red)|(ulpfec)|(flexfec)/i.test((null===(k=L.rtpMap)||void 0===k?void 0:k.encodingName)||"")})),j&&(null==j?void 0:j.length)>0&&(et=et.filter(L=>{var k;return so(j).call(j,(null===(k=L.rtpMap)||void 0===k?void 0:k.encodingName.toLowerCase())||"")})),G&&(null==G?void 0:G.length)>0){let L=ei.filter(L=>{var k;return so(G).call(G,(null===(k=L.rtpMap)||void 0===k?void 0:k.encodingName.toLowerCase())||"")});ei=L.concat(V?[]:Fx(L,ei))}let es=wN("UNSUPPORTED_VIDEO_CODEC");if(es&&es.length>0){let L=ei.filter(L=>L.rtpMap&&so(es).call(es,L.rtpMap.encodingName.toLowerCase())),k=Fx(L,ei),M=L.concat(k).map(L=>L.payloadType);ei=ei.filter(L=>!so(M).call(M,L.payloadType)),gc.debug("unsupportedVideoCodec: ".concat(es,", toBeRemoved: ").concat(M))}if(X&&X.length>0&&"sendonly"===U){let L=ei.filter(L=>L.rtpMap&&so(X).call(X,L.rtpMap.encodingName.toLowerCase())),k=Fx(L,ei),M=L.concat(k).map(L=>L.payloadType);ei=ei.filter(L=>!so(M).call(M,L.payloadType)),gc.debug("unsupportedVideoUplinkCodec: ".concat(X,", toBeRemoved: ").concat(M))}if($&&$.length>0&&"recvonly"===U){let L=ei.filter(L=>L.rtpMap&&so($).call($,L.rtpMap.encodingName.toLowerCase())),k=Fx(L,ei),M=L.concat(k).map(L=>L.payloadType);ei=ei.filter(L=>!so(M).call(M,L.payloadType)),gc.debug("unsupportedVideoDownlinkCodec: ".concat($,", toBeRemoved: ").concat(M))}return{audioCodecs:et,videoCodecs:ei,audioExtensions:er,videoExtensions:en}}function vx(L){let k,M;let U=FN(L);for(let L of U.mediaDescriptions){if(!k){let M=L.attributes.iceUfrag,U=L.attributes.icePwd;if(!M||!U)throw Error("Cannot get iceUfrag or icePwd from SDP.");k={iceUfrag:M,icePwd:U}}if(!M){let k=L.attributes.fingerprints;k.length>0&&(M={fingerprints:k})}}if(!M&&U.attributes.fingerprints.length>0&&(M={fingerprints:U.attributes.fingerprints}),!M||!k)throw Error("Cannot get iceParameters or dtlsParameters from SDP.");return{iceParameters:k,dtlsParameters:M}}function Cx(L,k){let M=[],U=L.attributes.ssrcGroups.filter(L=>"FID"===L.semantic),V=L.attributes.ssrcGroups.find(L=>"SIM"===L.semantic),F=L.attributes.ssrcs;if(V)V.ssrcIds.forEach(L=>{var V;let F=null===(V=U.find(k=>k.ssrcIds[0]===L))||void 0===V?void 0:V.ssrcIds[1];M.push({ssrcId:L,rtx:k?F:void 0})});else if(U.length>0){let L=U[0].ssrcIds[0],V=U[0].ssrcIds[1];M.push({ssrcId:L,rtx:k?V:void 0})}else{if(0===F.length)throw Error("No ssrcs found on local media description.");M.push({ssrcId:F[0].ssrcId})}return M}function yx(L,k,M){let U;let{cname:V}=L,F=[];k&&(F=Ix(k)),0===F.length&&(F=L.iceParameters.candidates.map(L=>({foundation:L.foundation,componentId:"1",transport:L.protocol,priority:L.priority.toString(),connectionAddress:L.ip,port:L.port.toString(),type:L.type,extension:{}})),gc.debug("Using candidates from gateway."));let B={fingerprints:L.dtlsParameters.fingerprints.map(L=>({hashFunction:L.algorithm,fingerprint:L.fingerprint}))},j={iceUfrag:L.iceParameters.iceUfrag,icePwd:L.iceParameters.icePwd};switch(L.dtlsParameters.role){case"server":U="passive";break;case"client":U="active";break;case"auto":U="actpass"}let G=Ux(L.rtpCapabilities),X=[];return Array.isArray(M)&&M.length>0&&M.forEach(L=>{X.push({kind:R1.VIDEO,ssrcMsg:[{ssrcId:L.v,rtx:L.v_rtx}],mslabel:"".concat(L.v,"_").concat(L.a)},{kind:R1.AUDIO,ssrcMsg:[{ssrcId:L.a}],mslabel:"".concat(L.v,"_").concat(L.a)})}),{dtlsParameters:B,iceParameters:j,candidates:F,rtpCapabilities:G,setup:U,cname:V,preSSRCs:X}}function Ix(L){let k=[];return L.ip&&"number"==typeof L.port&&(k=[{foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:L.ip,port:L.port.toString(),type:"host",extension:{}}],gc.debug("Using remote candidate from AP ".concat(hx(L.ip),":").concat(L.port)),L.ip6&&(k.push({foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:L.ip6,port:L.port.toString(),type:"host",extension:{}}),gc.debug("Using IPV6 remote candidate from AP ".concat(hx(L.ip6),":").concat(L.port)))),k}function bx(L,k,M){let U=[],V=[];return L.forEach(L=>{let{ssrcId:F,rtx:B}=L,j=IO(8,"track-"),G={ssrcId:F,attributes:Tx({label:j,mslabel:M=M||IO(10,""),msid:"".concat(M," ").concat(j)},k&&{cname:k})};if(U.push(G),void 0!==B){let L={ssrcId:B,attributes:Tx({label:j,mslabel:M,msid:"".concat(M," ").concat(j)},k&&{cname:k})};U.push(L),V.push({semantic:"FID",ssrcIds:[F,B]})}}),L.length>1&&V.push({semantic:"SIM",ssrcIds:L.map(L=>{let{ssrcId:k}=L;return k})}),{ssrcs:U,ssrcGroups:V}}function Ax(L,k){k instanceof Ts&&L.attributes.payloads.forEach(L=>{var M;let U=null===(M=L.rtpMap)||void 0===M?void 0:M.encodingName.toLowerCase();if(!U||-1===["opus","pcmu","pcma","g722"].indexOf(U))return;L.fmtp||(L.fmtp={parameters:{}}),"opus"===U&&"number"==typeof wN("OPUS_PTIME")?L.fmtp.parameters.ptime=wN("OPUS_PTIME"):L.fmtp.parameters.minptime="10",L.fmtp.parameters.useinbandfec="1";let V=k._encoderConfig;V&&("pcmu"!==U&&"pcma"!==U&&"g722"!==U&&(V.bitrate&&!iw()&&(L.fmtp.parameters.maxaveragebitrate="".concat(Math.floor(1e3*V.bitrate))),V.sampleRate&&(L.fmtp.parameters.maxplaybackrate="".concat(V.sampleRate),L.fmtp.parameters["sprop-maxcapturerate"]="".concat(V.sampleRate)),V.stereo&&(L.fmtp.parameters.stereo="1",L.fmtp.parameters["sprop-stereo"]="1")),k instanceof Tc&&"opus"===U&&k._config.DTX&&(L.fmtp.parameters.usedtx="1"))})}function wx(L){let k=L.attributes.unrecognized.findIndex(L=>"x-google-flag"===L.attField&&"conference"===L.attValue);-1!==k&&L.attributes.unrecognized.splice(k,1)}function Ox(L,k){var M;if(!(k instanceof Tp&&k._encoderConfig&&-1===k._hints.indexOf(gL.SCREEN_TRACK)))return;let U=k._encoderConfig;gf.supportMinBitrate&&U.bitrateMin&&L.attributes.payloads.forEach(L=>{var k,M;so(k=["h264","h265","vp8","vp9","av1"]).call(k,(null===(M=L.rtpMap)||void 0===M?void 0:M.encodingName.toLowerCase())||"")&&(L.fmtp||(L.fmtp={parameters:{}}),L.fmtp.parameters["x-google-min-bitrate"]="".concat(U.bitrateMin))}),gf.supportMinBitrate&&!so(M=k._hints).call(M,gL.LOW_STREAM)&&U.bitrateMax&&L.attributes.payloads.forEach(L=>{var k,M;so(k=["h264","h265","vp8","vp9","av1"]).call(k,(null===(M=L.rtpMap)||void 0===M?void 0:M.encodingName.toLowerCase())||"")&&(L.fmtp||(L.fmtp={parameters:{}}),L.fmtp.parameters["x-google-start-bitrate"]="".concat(wN("X_GOOGLE_START_BITRATE")||Math.floor(U.bitrateMax)))})}function Nx(L){if("video"!==L.media.mediaType)return;let k=zA();if(k.name!==fQ.SAFARI&&k.os!==fX.IOS)return;let M=L.attributes.extmaps.findIndex(L=>/video-orientation/g.test(L.extensionName));-1!==M&&L.attributes.extmaps.splice(M,1)}function Dx(L,k,M){let U,V;if(k){var F,B;if("video"===L.media.mediaType?(U=M.videoExtensions,V=M.videoCodecs):(U=M.audioExtensions,V=M.audioCodecs),!0===k.twcc){let k=U.find(L=>Sx(L.extensionName));if(k){let M=k.extensionName;L.attributes.extmaps.find(L=>Sx(L.extensionName))||L.attributes.extmaps.push({entry:k.entry,extensionName:M});let U=(F=V,L.attributes.payloads.filter(L=>!!F.find(k=>k.payloadType===L.payloadType&&!!k.rtcpFeedbacks.find(L=>"transport-cc"===L.type))));U.forEach(L=>{L.rtcpFeedbacks.find(L=>"transport-cc"===L.type)||L.rtcpFeedbacks.push({type:"transport-cc"})})}}else if(!1===k.twcc){let k=L.attributes.extmaps.findIndex(L=>Sx(L.extensionName));-1!==k&&L.attributes.extmaps.splice(k,1),L.attributes.payloads.forEach(L=>{let k=L.rtcpFeedbacks.findIndex(L=>"transport-cc"===L.type);-1!==k&&L.rtcpFeedbacks.splice(k,1)})}if(!0===k.remb){let k=U.find(L=>fx(L.extensionName));if(k){let M=k.extensionName;L.attributes.extmaps.find(L=>L.extensionName===M)||L.attributes.extmaps.push({entry:k.entry,extensionName:M});let U=(B=V,L.attributes.payloads.filter(L=>!!B.find(k=>k.payloadType===L.payloadType&&!!k.rtcpFeedbacks.find(L=>"goog-remb"===L.type))));U.forEach(L=>{L.rtcpFeedbacks.find(L=>"goog-remb"===L.type)||L.rtcpFeedbacks.push({type:"goog-remb"})})}}else if(!1===k.remb){let k=L.attributes.extmaps.findIndex(L=>fx(L.extensionName));-1!==k&&L.attributes.extmaps.splice(k,1),L.attributes.payloads.forEach(L=>{let k=L.rtcpFeedbacks.findIndex(L=>"goog-remb"===L.type);-1!==k&&L.rtcpFeedbacks.splice(k,1)})}}}function Px(L,k,M){if(iw()||"video"!==L.media.mediaType||!(k instanceof Tp)||"vp9"!==M&&"vp8"!==M||"vp8"===M&&!wN("SIMULCAST")||"vp9"===M&&wN("ENABLE_SVC")||void 0===k._scalabilityMode||k._scalabilityMode.numSpatialLayers<=1)return;let U="vp8"===M?2:k._scalabilityMode.numSpatialLayers,V=L.attributes.ssrcs[0],F=L.attributes.ssrcGroups.find(L=>"FID"===L.semantic&&L.ssrcIds[0]===V.ssrcId),B={semantic:"SIM",ssrcIds:[V.ssrcId]};for(let k=1;k<U;k++)L.attributes.ssrcs.push({ssrcId:V.ssrcId+k,attributes:pO(V.attributes)}),B.ssrcIds.push(V.ssrcId+k),F&&(L.attributes.ssrcs.push({ssrcId:F.ssrcIds[1]+k,attributes:pO(V.attributes)}),L.attributes.ssrcGroups.push({semantic:"FID",ssrcIds:[V.ssrcId+k,F.ssrcIds[1]+k]}));L.attributes.ssrcGroups.unshift(B)}async function Lx(){let L=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},k=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},M=new RTCPeerConnection;M.addTransceiver("video",{direction:"sendonly"}),M.addTransceiver("audio",{direction:"sendonly"}),M.addTransceiver("video",{direction:"recvonly"}),M.addTransceiver("audio",{direction:"recvonly"});let U=(await M.createOffer()).sdp,{send:V,recv:F,sendrecv:B}=function(){let L=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},k=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},M=arguments.length>2?arguments[2]:void 0,U=Rx(M,L,k,"sendonly"),V=Rx(M,L,k,"recvonly"),F={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},B={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},j={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(Mx(U,V,"videoExtensions",F,B,j),Mx(U,V,"videoCodecs",F,B,j),Mx(U,V,"audioExtensions",F,B,j),Mx(U,V,"audioCodecs",F,B,j),wN("RAISE_H264_BASELINE_PRIORITY")){let L=[],k=[];if(j.videoCodecs.forEach((M,U)=>{var V,F,B;if("h264"===(null===(V=M.rtpMap)||void 0===V?void 0:V.encodingName.toLocaleLowerCase())){let V=j.videoCodecs[U+1],G=V&&Hx(M,V),X=null===(F=M.fmtp)||void 0===F?void 0:F.parameters["profile-level-id"],$=null===(B=M.fmtp)||void 0===B?void 0:B.parameters["packetization-mode"];!X||X!==wN("FIRST_H264_PROFILE_LEVEL_ID")||wN("FIRST_PACKETIZATION_MODE")&&$!==wN("FIRST_PACKETIZATION_MODE")?G?k.push([M,V]):k.push([M]):G?L.push([M,V]):L.push([M])}}),L.length>0&&k.length>0){gc.debug("raising H264 baseline profile priority"),j.videoCodecs.forEach((M,U)=>{var V;if("h264"===(null===(V=M.rtpMap)||void 0===V?void 0:V.encodingName.toLocaleLowerCase())){let V=Hx(M,j.videoCodecs[U+1]),F=L.shift()||k.shift()||[];F.length>0&&(V?j.videoCodecs.splice(U,2,...F):j.videoCodecs.splice(U,1,...F))}});let M=B.videoCodecs.filter(L=>{var k,M;return"h264"===(null===(k=L.rtpMap)||void 0===k?void 0:k.encodingName.toLocaleLowerCase())&&(null===(M=L.fmtp)||void 0===M?void 0:M.parameters["profile-level-id"])!==wN("FIRST_H264_PROFILE_LEVEL_ID")});if(M.length>0){let L=Fx(M,B.videoCodecs).map(L=>L.payloadType),k=[...M.map(L=>L.payloadType),...L];B.videoCodecs=B.videoCodecs.filter(L=>!so(k).call(k,L.payloadType))}wN("FILTER_SEND_H264_BASELINE")&&(F.videoCodecs=F.videoCodecs.filter(L=>{var k,M;return!("h264"===(null===(k=L.rtpMap)||void 0===k?void 0:k.encodingName.toLocaleLowerCase())&&(null===(M=L.fmtp)||void 0===M?void 0:M.parameters["profile-level-id"])!==wN("FIRST_H264_PROFILE_LEVEL_ID"))}))}}return{send:F,recv:B,sendrecv:j}}(L,k,U);try{M.close()}catch(L){}return{send:V,recv:F,sendrecv:B}}function kx(){let L={audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},k=Rx(arguments.length>2?arguments[2]:void 0,arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},"recvonly"),M={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},U={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},V={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(Mx(L,k,"videoExtensions",M,U,V),Mx(L,k,"videoCodecs",M,U,V),Mx(L,k,"audioExtensions",M,U,V),Mx(L,k,"audioCodecs",M,U,V),wN("RAISE_H264_BASELINE_PRIORITY")){let L=V.videoCodecs.findIndex(L=>L.rtpMap&&"h264"===L.rtpMap.encodingName.toLocaleLowerCase()&&L.fmtp&&"42001f"===L.fmtp.parameters["profile-level-id"]);if(-1!==L){let k=V.videoCodecs.findIndex(L=>L.rtpMap&&"h264"===L.rtpMap.encodingName.toLocaleLowerCase());if(k<L){gc.debug("raising H264 baseline profile priority");let M=V.videoCodecs[L];V.videoCodecs.splice(L,1),V.videoCodecs.splice(k,0,M)}-1!==k&&(U.videoCodecs=U.videoCodecs.filter(L=>!(L.rtpMap&&"h264"===L.rtpMap.encodingName.toLocaleLowerCase()&&L.fmtp&&"42001f"!==L.fmtp.parameters["profile-level-id"])))}}return{send:M,recv:U,sendrecv:V}}function Mx(L,k,M,U,V,F){if("videoExtensions"===M||"audioExtensions"===M){let B=[];return L[M].forEach(L=>{k[M].some((k,M)=>{if(L.entry===k.entry&&L.extensionName===k.extensionName)return B.push(M),!0})?F[M].push(L):U[M].push(L)}),void k[M].forEach((L,k)=>{-1===B.indexOf(k)&&V[M].push(L)})}if("videoCodecs"===M||"audioCodecs"===M){let B=[];return L[M].forEach(L=>{k[M].some((k,M)=>{if(L.payloadType===k.payloadType&&JSON.stringify(L)===JSON.stringify(k))return B.push(M),!0})?F[M].push(L):U[M].push(L)}),void k[M].forEach((L,k)=>{-1===B.indexOf(k)&&V[M].push(L)})}}function Ux(L){let k,M;let{send:U,recv:V,sendrecv:F}=L;if(!F){if(!U||!V)throw Error("cannot merge rtp capabilities because one of send or recv is empty!");return{send:U,recv:V}}return U?((k={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]}).audioCodecs=[...U.audioCodecs,...F.audioCodecs],k.videoCodecs=[...U.videoCodecs,...F.videoCodecs],k.audioExtensions=[...U.audioExtensions,...F.audioExtensions],k.videoExtensions=[...U.videoExtensions,...F.videoExtensions]):k=F,V?((M={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]}).audioCodecs=[...V.audioCodecs,...F.audioCodecs],M.videoCodecs=[...V.videoCodecs,...F.videoCodecs],M.audioExtensions=[...V.audioExtensions,...F.audioExtensions],M.videoExtensions=[...V.videoExtensions,...F.videoExtensions]):M=F,{send:k,recv:M}}function Vx(L){"audio"===L.media.mediaType&&L.attributes.payloads.filter(L=>{var k;return"opus"===(null===(k=L.rtpMap)||void 0===k?void 0:k.encodingName.toLowerCase())}).forEach(L=>{L.fmtp||(L.fmtp={parameters:{}}),L.fmtp.parameters.stereo="1",L.fmtp.parameters["sprop-stereo"]="1"})}function xx(L,k,M,U){let V=[];if(L===R1.VIDEO){if(wN("H264_PROFILE_LEVEL_ID")&&"h264"===U&&(V=k.videoCodecs.filter(L=>{var k;return so(k=L.rtpMap&&L.rtpMap.encodingName.toLowerCase()||"").call(k,U)&&L&&L.fmtp&&L.fmtp.parameters["profile-level-id"]===wN("H264_PROFILE_LEVEL_ID")})),!Array.isArray(V)||0===V.length){let L=[],F=[],B=[],j=[];if(M.videoCodecs.forEach(k=>{let M=k.rtpMap&&k.rtpMap.encodingName.toLowerCase()||"";so(M).call(M,U)?L.push(k):so(M).call(M,"vp9")?F.push(k):so(M).call(M,"vp8")?B.push(k):so(M).call(M,"h264")&&j.push(k)}),0===L.length){let k="";0!==F.length?(L=F,k="vp9"):0!==B.length?(L=B,k="vp8"):0!==j.length&&(L=j,k="h264"),gc.warning("codec ".concat(U," not included in rtpCapabilities, fallback to default payloads: ").concat(k))}0!==L.length&&(V=k.videoCodecs.filter(k=>L.some(L=>L.payloadType===k.payloadType)))}if(0===V.length&&(gc.warning("codec ".concat(U," not included in rtpCapabilities, fallback to default payloads: ").concat(k.videoCodecs[0].rtpMap&&k.videoCodecs[0].rtpMap.encodingName)),V=k.videoCodecs),wN("USE_PUB_RTX")||wN("USE_SUB_RTX")){let L=Fx(V,k.videoCodecs);V=[...V,...L]}}else{V=k.audioCodecs.filter(L=>{var k;return so(k=L.rtpMap&&L.rtpMap.encodingName.toLowerCase()||"").call(k,U)});let L=k.audioCodecs.filter(L=>{var k;return so(k=L.rtpMap&&L.rtpMap.encodingName.toLowerCase()||"").call(k,"red")});0===V.length&&(gc.warning("codec ".concat(U," not included in rtpCapabilities, fallback to opus")),V=k.audioCodecs.filter(L=>{var k;return so(k=L.rtpMap&&L.rtpMap.encodingName.toLowerCase()||"").call(k,"opus")})),wN("ENABLE_AUDIO_RED")&&0!==L.length&&(V=[...L,...V])}return V}function Fx(L,k){let M=L.map(L=>L.payloadType.toString());return k.filter(L=>L.rtpMap&&"rtx"===L.rtpMap.encodingName&&L.fmtp&&L.fmtp.parameters.apt&&so(M).call(M,L.fmtp&&L.fmtp.parameters.apt))}async function Bx(L,k,M){let U=k.toString(),V=Gx(U,"offer","remote","exchangeSDP");await L.setRemoteDescription({type:"offer",sdp:U});let F=await L.createAnswer();if(!F.sdp)throw Error("cannot get answer sdp");let B=F.sdp;B=jx(B,M||{}),null==V||V(B||""),await L.setLocalDescription({type:"answer",sdp:B})}function jx(L,k,M){let U=FN(L),{useXR:V}=k;return U.mediaDescriptions.forEach(L=>{var k;L.attributes.mid&&(Array.isArray(M)&&!so(M).call(M,L.attributes.mid)||("audio"===L.media.mediaType&&Vx(L),V&&so(k=["audio","video"]).call(k,L.media.mediaType)&&L.attributes.payloads.forEach(L=>{-1===L.rtcpFeedbacks.findIndex(L=>"rrtr"===L.type)&&L.rtcpFeedbacks.push({type:"rrtr"})})))}),BN(U)}function Gx(L,k,M,U){if(wN("SDP_LOGGING"))return gc.upload("exchanging ".concat(M," ").concat(k," SDP during P2PConnection.").concat(U,"\n"),L),"offer"===k?L=>{Gx(L,"answer","local"===M?"remote":"local",U)}:void 0}function Wx(L){let k=wN("COMPATIBLE_SDP_EXTENSION");return!!(Array.isArray(k)&&k.length>0)&&k.some(k=>so(L).call(L,k))}function Hx(L,k){try{var M;return(null===(M=L.fmtp)||void 0===M?void 0:M.parameters.apt)===k.payloadType.toString()}catch(L){return!1}}function Kx(L,k){var M=Object.keys(L);if(Object.getOwnPropertySymbols){var U=Object.getOwnPropertySymbols(L);k&&(U=U.filter(function(k){return Object.getOwnPropertyDescriptor(L,k).enumerable})),M.push.apply(M,U)}return M}function Yx(L,k){return typeof wN(L)===k?wN(L):void 0}function zx(){try{let L=wN("EXPERIMENTS")||{};return"string"==typeof L||Array.isArray(L)?{}:function(L){for(var k=1;k<arguments.length;k++){var M=null!=arguments[k]?arguments[k]:{};k%2?Kx(Object(M),!0).forEach(function(k){uI(L,k,M[k])}):Object.getOwnPropertyDescriptors?Object.defineProperties(L,Object.getOwnPropertyDescriptors(M)):Kx(Object(M)).forEach(function(k){Object.defineProperty(L,k,Object.getOwnPropertyDescriptor(M,k))})}return L}({},L)}catch(L){return gc.debug("handle gateway attributes failed: ",L),{}}}let IC={};function Xx(L){(!(arguments.length>1&&void 0!==arguments[1])||arguments[1])&&gc.debug("install service ".concat(L.name)),IC[L.name]=L}function Jx(L){let k=IC[L];if(!k)throw new f2(f1.INVALID_OPERATION,"".concat(L," not found, please use AgoraRTC.use(").concat(L,"Service) to load it first"));return k}function Zx(L,k){return Jx("DataStream").create(L,k)}function Qx(){return Jx("InterceptFrame").create()}function $x(L,k){var M=Object.keys(L);if(Object.getOwnPropertySymbols){var U=Object.getOwnPropertySymbols(L);k&&(U=U.filter(function(k){return Object.getOwnPropertyDescriptor(L,k).enumerable})),M.push.apply(M,U)}return M}function eF(L){for(var k=1;k<arguments.length;k++){var M=null!=arguments[k]?arguments[k]:{};k%2?$x(Object(M),!0).forEach(function(k){uI(L,k,M[k])}):Object.getOwnPropertyDescriptors?Object.defineProperties(L,Object.getOwnPropertyDescriptors(M)):$x(Object(M)).forEach(function(k){Object.defineProperty(L,k,Object.getOwnPropertyDescriptor(M,k))})}return L}let Iy=new Map;let iF=class iF extends Hw{get state(){return this._state}set state(L){if(L===this._state)return;let k=this._state;this._state=L,"DISCONNECTED"===L&&this._disconnectedReason?this.emit(RH.CONNECTION_STATE_CHANGE,L,k,this._disconnectedReason):this.emit(RH.CONNECTION_STATE_CHANGE,L,k)}get joinGatewayStartTime(){return this._joinGatewayStartTime}set joinGatewayStartTime(L){gc.debug("[".concat(this.store.clientId,"] set joinGatewayStartTime at ").concat(L)),this._joinGatewayStartTime=L}constructor(L,k){var M,U,V;super(),uI(this,"store",void 0),uI(this,"joinInfo",void 0),uI(this,"key",void 0),uI(this,"ntpOffset",0),uI(this,"signal",void 0),uI(this,"role",void 0),uI(this,"isPreallocation",void 0),uI(this,"isPreSub",void 0),uI(this,"inChannelInfo",{joinAt:null,duration:0}),uI(this,"spec",void 0),uI(this,"_state","DISCONNECTED"),uI(this,"_statsCollector",void 0),uI(this,"_disconnectedReason",void 0),uI(this,"isSignalRecover",!1),uI(this,"hasChangeBGPAddress",!1),uI(this,"trafficStatsInterval",void 0),uI(this,"networkQualityInterval",void 0),uI(this,"_joinGatewayStartTime",0),uI(this,"_signalTimeout",!1),uI(this,"_clientRoleOptions",void 0),uI(this,"_isProactiveJoin",!1),this.store=L,this.spec=k,this.signal=this.store.useP2P?(M={spec:eF(eF({},k),{},{retryConfig:k.websocketRetryConfig}),store:L},null===(U=(V=Jx("P2PChannel")).createSubmodule)||void 0===U?void 0:U.call(V,M)):new ZV(eF(eF({},k),{},{retryConfig:k.websocketRetryConfig}),L),this._statsCollector=k.statsCollector,this.role=k.role||"audience",this._clientRoleOptions=k.clientRoleOptions,this.handleSignalEvents()}async join(L,k,M){this.store.joinGatewayStart(),"disabled"!==L.cloudProxyServer&&(this.hasChangeBGPAddress=!0);let U=Date.now(),V=Iy.get(L.cname);if(V||(V=new Map,Iy.set(L.cname,V)),this._isProactiveJoin=!0,V.has(L.uid)){let k=new ED(f1.UID_CONFLICT);throw g_.joinGateway(L.sid,{lts:U,succ:!1,ec:k.code,addr:null,uid:L.uid,cid:L.cid,firstSuccess:this._isProactiveJoin,isProxy:!!L.proxyServer,signalChannel:"0",preload:L.preload}),k}V.set(L.uid,!0),this.joinInfo=L,this.key=k;let F=0;this.joinGatewayStartTime=U;let B=L.proxyServer;try{gc.debug("[".concat(this.store.clientId,"] use websocket join uid ").concat(F));let k=L.gatewayAddrs.map(k=>{let{address:M}=k,[U,V]=M.split(":"),F={host:U,port:V};return L.proxyServer&&(F.proxy=L.proxyServer),F});F=(await this.signal.init(k)).uid,gc.debug("[".concat(this.store.clientId,"] websocket join uid ").concat(F," cost ").concat(Date.now()-this.joinGatewayStartTime))}catch(k){var j;throw gc.error("[".concat(this.store.clientId,"] User join failed"),k.toString()),g_.joinGateway(L.sid,{lts:U,succ:!1,ec:(null===(j=k.data)||void 0===j?void 0:j.desc)||k.code,errorMsg:k.message,addr:this.signal.url,uid:L.uid,cid:L.cid,firstSuccess:this._isProactiveJoin,isProxy:!!B,signalChannel:"0",preload:L.preload}),V.delete(L.uid),this.signal.close(),k}return this.state="CONNECTED",this.inChannelInfo.joinAt=Date.now(),gc.debug("[".concat(this.store.clientId,"] Connected to gateway server")),this.trafficStatsInterval=window.setInterval(()=>{this.updateTrafficStats().catch(L=>{gc.warning("[".concat(this.store.clientId,"] get traffic stats error"),L.toString())})},3e3),this.networkQualityInterval=window.setInterval(()=>{navigator&&void 0!==navigator.onLine&&!navigator.onLine?this.emit(RH.NETWORK_QUALITY,{downlinkNetworkQuality:6,uplinkNetworkQuality:6}):this._signalTimeout?this.emit(RH.NETWORK_QUALITY,{downlinkNetworkQuality:5,uplinkNetworkQuality:5}):"CONNECTED"===this.state&&this._statsCollector.trafficStats?this.emit(RH.NETWORK_QUALITY,{uplinkNetworkQuality:ax(this._statsCollector.trafficStats.B_unq),downlinkNetworkQuality:ax(this._statsCollector.trafficStats.B_dnq)}):this.emit(RH.NETWORK_QUALITY,{uplinkNetworkQuality:0,downlinkNetworkQuality:0})},2e3),this.store.joinGatewayEnd(),F}async leave(){let L=arguments.length>0&&void 0!==arguments[0]&&arguments[0],k=arguments.length>1?arguments[1]:void 0;if("DISCONNECTED"!==this.state){k!==Se.FALLBACK&&(this.state="DISCONNECTING");try{var M;L||this.signal.connectionState!==R_.CONNECTED||await (M=this.signal.request(Rf.LEAVE,void 0,!0),3e3==1/0?M:lQ.race([M,CO(3e3)]))}catch(L){gc.warning("[".concat(this.store.clientId,"] leave request failed, ignore"),L)}this.signal.close(k),k!==Se.FALLBACK&&(this.state="DISCONNECTED"),this.reset()}}async publish(L,k,M){if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new ED(f1.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));let U={state:"offer",p2p_id:this.store.p2pId,ortc:k,mode:this.spec.mode,extend:wN("PUB_EXTEND"),twcc:!!wN("PUBLISH_TWCC"),rtx:!!wN("USE_PUB_RTX")};try{return(await this.signal.request(Rf.PUBLISH,U,!0))._message}catch(U){if(M&&U.data&&U.data.code===Rp.ERR_PUBLISH_REQUEST_INVALID)return gc.warning("[".concat(this.store.clientId,"] receive publish error code, retry"),U.toString()),await this.tryUnpubBeforeRepub(L,k),this.publish(L,k,!1);throw U}}async publishDataChannel(L,k,M){var U;if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new ED(f1.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));let V={stream_id:k.streamId,ordered:k.ordered?1:0,max_retrans_times:null!==(U=k.maxRetransmits)&&void 0!==U?U:10,channel_id:k.channelId,metadata:k.metadata};try{await this.signal.request(Rf.PUBLISH_DATASTREAM,V,!0)}catch(U){if(M&&U.data&&U.data.code===Rp.ERR_PUBLISH_REQUEST_INVALID)return gc.warning("[".concat(this.store.clientId,"] receive publish datachannels error code, retry"),U.toString()),await this.tryUnpubDataChannelBeforeRepub(L,k),this.publishDataChannel(L,k,!1);throw U}}async unpublish(L,k){try{if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new ED(f1.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await this.signal.request(Rf.UNPUBLISH,{stream_id:k,ortc:L},!0)}catch(L){gc.warning("[".concat(this.store.clientId,"] unpublish warning: "),L)}}async unpublishDataChannel(L){try{if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new ED(f1.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await lQ.all(L.map(L=>this.signal.request(Rf.UNPUBLISH_DATASTREAM,{channel_id:L},!0)))}catch(L){gc.warning("unpublish datachannels warning: ",L)}}async presubscribe(L,k,M){if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new ED(f1.INVALID_OPERATION,"can not presubscribe when connection state is ".concat(this.state));let U={stream_id:L,stream_type:k,mode:this.spec.mode,codec:this.spec.codec,p2p_id:this.store.p2pId,twcc:!!wN("SUBSCRIBE_TWCC"),rtx:!!wN("USE_SUB_RTX")||void 0,extend:wN("SUB_EXTEND"),svc:Array.isArray(wN("SVC"))&&0!==wN("SVC").length?wN("SVC"):void 0};try{return await this.signal.request(Rf.PRE_SUBSCRIBE,U,!0)}catch(U){if(M&&U.data&&U.data.code===Rp.ERR_SUBSCRIBE_REQUEST_INVALID)return gc.warning("[".concat(this.store.clientId,"] pre-subscribe error, retry"),U.toString()),this.presubscribe(L,k,!1);throw U}}async subscribe(L,k,M){if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new ED(f1.INVALID_OPERATION,"can not subscribe when connection state is ".concat(this.state));let U={stream_id:L,stream_type:k.stream_type,mode:this.spec.mode,codec:this.spec.codec,p2p_id:this.store.p2pId,twcc:!!wN("SUBSCRIBE_TWCC"),rtx:!!wN("USE_SUB_RTX"),extend:wN("SUB_EXTEND"),ssrcId:k.ssrcId,svc:Array.isArray(wN("SVC"))&&0!==wN("SVC").length?wN("SVC"):void 0};try{return(await this.signal.request(Rf.SUBSCRIBE,U,!0))._message}catch(U){if(M&&U.data&&U.data.code===Rp.ERR_SUBSCRIBE_REQUEST_INVALID)return gc.warning("[".concat(this.store.clientId,"] receiver subscribe error code, retry"),U.toString()),await this.tryUnsubBeforeResub(L,k),await this.subscribe(L,k,!1);throw U}}async subscribeDataChannel(L,k,M){if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new ED(f1.INVALID_OPERATION,"can not subscribe datachannel when connection state is ".concat(this.state));let U={uid:L,stream_id:k.id,channel_id:k.datachannelId};try{return void await this.signal.request(Rf.SUBSCRIBE_DATASTREAM,U,!0)}catch(U){if(M&&U.data&&U.data.code===Rp.ERR_SUBSCRIBE_REQUEST_INVALID)return gc.warning("[".concat(this.store.clientId,"] receiver subscribe datachannel error code, retry"),U.toString()),await this.tryUnsubDataChannelBeforeResub(L,k),await this.subscribeDataChannel(L,k,!1);throw U}}async subscribeAll(L,k){if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new ED(f1.INVALID_OPERATION,"can not massSubscribe when connection state is ".concat(this.state));let M={p2p_id:this.store.p2pId,users:L,dtx:!1,rtx:!!wN("USE_SUB_RTX"),twcc:!!wN("SUBSCRIBE_TWCC"),svc:Array.isArray(wN("SVC"))&&0!==wN("SVC").length?wN("SVC"):void 0};try{return await this.signal.request(Rf.SUBSCRIBE_STREAMS,M,!0)}catch(M){if(k&&M.data&&M.data.code===Rp.ERR_SUBSCRIBE_REQUEST_INVALID)return gc.warning("[".concat(this.store.clientId,"] receiver massSubscribe error code, retry"),M.toString()),await this.tryMassUnsubBeforeResub(L),await this.subscribeAll(L,!1);throw M}}async setVideoProfile(L){let k=function(L){if(!(L.bitrateMax&&L.bitrateMin&&L.frameRate&&L.height&&L.width))return;let k=L.frameRate,M=L.width,U=L.height,V=!0;return"number"!=typeof k&&((k=k.exact||k.ideal||k.max||k.min||0)||(V=!1)),"number"!=typeof M&&((M=M.exact||M.ideal||M.max||M.min||0)||(V=!1)),"number"!=typeof U&&(U=U.exact||U.ideal||U.max||U.min||0,k||(V=!1)),V?{stream_type:0,width:M,height:U,fps:k,start_bps:1e3*L.bitrateMax,min_bps:1e3*L.bitrateMin,target_bps:1e3*L.bitrateMax}:void 0}(L);if(k)return this.signal.request(Rf.SET_VIDEO_PROFILE,k);gc.debug("[".concat(this.store.clientId,"] encoder config is not complete, do not report to gateway"))}async unsubscribe(L,k){try{await this.signal.request(Rf.UNSUBSCRIBE,{p2p_id:this.store.p2pId,ortc:L,stream_id:k},!0)}catch(L){gc.warning("[".concat(this.store.clientId,"] unsubscribe warning: "),L)}}async unsubscribeDataChannel(L,k){try{if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new ED(f1.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await lQ.all(L.map(L=>this.signal.request(Rf.UNSUBSCRIBE_DATASTREAM,{stream_id:L,uid:k},!0)))}catch(L){gc.warning("unsubscribeDataChannel warning: ",L)}}async massUnsubscribe(L){try{await this.signal.request(Rf.UNSUBSCRIBE_STREAMS,L,!0)}catch(L){gc.warning("[".concat(this.store.clientId,"] massUnsubscribeAll warning: "),L)}}async reconnectPC(L){let{iceParameters:k,dtlsParameters:M,rtpCapabilities:U}=L;return{gatewayEstablishParams:await this.signal.request(Rf.CONNECT_PC,{p2p_id:this.store.p2pId,stream_id:this.store.uid,ortc:{iceParameters:k,dtlsParameters:M,rtpCapabilities:U}},!0),gatewayAddress:this.getCurrentGatewayAddress()}}getGatewayInfo(){return this.signal.request(Rf.GATEWAY_INFO)}async renewToken(L){await this.signal.request(Rf.RENEW_TOKEN,L),this.key=L.token}updateClientRole(L,k){k&&(this._clientRoleOptions=Object.assign({},k)),wN("CLIENT_ROLE_OPTIONS")&&(gc.debug("[".concat(this.store.clientId,"] Set roleOptions for ").concat(JSON.stringify(wN("CLIENT_ROLE_OPTIONS"))," instead of ").concat(JSON.stringify(this._clientRoleOptions)," ")),this._clientRoleOptions=Object.assign({},wN("CLIENT_ROLE_OPTIONS"))),this.role=L}async setClientRole(L,k){if(k&&(this._clientRoleOptions=Object.assign({},k)),wN("CLIENT_ROLE_OPTIONS")&&(this._clientRoleOptions=Object.assign({},wN("CLIENT_ROLE_OPTIONS")),gc.debug("[".concat(this.store.clientId,"] Set roleOptions for ").concat(JSON.stringify(wN("CLIENT_ROLE_OPTIONS"))," instead of ").concat(JSON.stringify(this._clientRoleOptions)," "))),"CONNECTED"!==this.state)return void(this.role=L);let M,U=0;"audience"===L?this._clientRoleOptions&&this._clientRoleOptions.delay?(M=this._clientRoleOptions.delay,U=1):U=this._clientRoleOptions&&this._clientRoleOptions.level?this._clientRoleOptions.level:2:U=0;let V=Object.assign({},k);delete V.delay,delete V.level,await this.signal.request(Rf.SET_CLIENT_ROLE,eF(eF({role:L,level:U,delay:M},V),{},{client_ts:Date.now()})),this.role=L}async setRemoteVideoStreamType(L,k){await this.signal.request(Rf.SWITCH_VIDEO_STREAM,{stream_id:L,stream_type:k})}async setDefaultRemoteVideoStreamType(L){await this.signal.request(Rf.DEFAULT_VIDEO_STREAM,{stream_type:L})}async setStreamFallbackOption(L,k){await this.signal.request(Rf.SET_FALLBACK_OPTION,{stream_id:L,fallback_type:k})}async pickSVCLayer(L,k){await this.signal.request(Rf.PICK_SVC_LAYER,{stream_id:L,spatial_layer:k.spatialLayer,temporal_layer:k.temporalLayer})}async setRTM2Flag(L){await this.signal.request(Rf.SET_RTM2_FLAG,{rtm2_flag:L})}async sendExtensionMessage(L,k,M){if(this.store.useP2P)return this.signal.sendExtensionMessage(L,k,M)}getInChannelInfo(){return this.inChannelInfo.joinAt&&(this.inChannelInfo.duration=Date.now()-this.inChannelInfo.joinAt),eF({},this.inChannelInfo)}async getGatewayVersion(){return(await this.signal.request(Rf.GATEWAY_INFO)).version}reset(){if(this.inChannelInfo.joinAt&&(this.inChannelInfo.duration=Date.now()-this.inChannelInfo.joinAt,this.inChannelInfo.joinAt=null),this.trafficStatsInterval&&(window.clearInterval(this.trafficStatsInterval),this.trafficStatsInterval=void 0),this.joinInfo){let L=Iy.get(this.joinInfo.cname);L&&L.delete(this.joinInfo.uid)}this.joinInfo=void 0,this.key=void 0,this.networkQualityInterval&&(window.clearInterval(this.networkQualityInterval),this.networkQualityInterval=void 0)}updateTurnConfigFromSignal(){var L;let k;if(!this.joinInfo)return;let M=(k=(L=("disabled"===this.joinInfo.cloudProxyServer?this.signal.url:this.joinInfo.gatewayAddrs[this.signal.currentURLIndex].address)||"").startsWith("dc")?L.match(/(dc\:\/\/)?([^:]+):(\d+)/):L.match(/(wss\:\/\/)?([^:]+):(\d+)/))?{username:SZ.username,password:SZ.password,turnServerURL:k[2],tcpport:parseInt(k[3])+30,udpport:parseInt(k[3])+30,forceturn:!1}:null;this.joinInfo.turnServer.serversFromGateway=[],M&&"off"!==this.joinInfo.turnServer.mode&&"disabled"===this.joinInfo.cloudProxyServer&&this.joinInfo.turnServer.serversFromGateway.push(eF(eF({},SZ),{},{turnServerURL:M.turnServerURL,tcpport:M.tcpport,udpport:M.udpport,username:this.joinInfo.uid.toString(),password:this.joinInfo.token}))}async updateTrafficStats(){if("CONNECTED"!==this.state)return;let L=await this.signal.request(Rf.TRAFFIC_STATS,void 0,!0);L.timestamp=Date.now(),null!=L.ntp_offset&&(this.ntpOffset=L.ntp_offset),L.peer_delay.forEach(L=>{let k=this._statsCollector.trafficStats&&this._statsCollector.trafficStats.peer_delay.find(k=>k.peer_uid===L.peer_uid);k&&k.B_st!==L.B_st&&hO(()=>{this.emit(RH.STREAM_TYPE_CHANGE,L.peer_uid,L.B_st)})}),this._statsCollector.updateTrafficStats(L)}getJoinMessage(L){var k,M,U;if(!this.joinInfo||!this.key)throw new ED(f1.UNEXPECTED_ERROR,"can not generate join message, no join info");let V=Object.assign({},this.joinInfo.apResponse),F=wN("REPORT_APP_SCENARIO");if("string"!=typeof F)try{F=JSON.stringify(F)}catch(L){F=void 0}F&&F.length>128&&(F=void 0),this.store.hasStartJoinChannel=!0,this.store.isABTestSuccess||this.emit(RH.UPDATE_GATEWAY_CONFIG),U=this.store.clientId,so(T$).call(T$,U)||T$.push(U);let B=TD(this.store),j=!(null===(k=this.isPreallocation)||void 0===k||!k.call(this)),G=RD(this.store),X=zx(),$=rw(87)||ew()||cw(117),ee=(function(){let L=zA();if(L.name!==fQ.SAFARI||!L.browserVersion)return!1;let k=L.browserVersion.split(".");return Number(k[0])>18||18===Number(k[0])&&Number(k[1])>=4}()||lw(18,4,!1))&&hw(18,6,!0)&&"h264"===this.spec.codec&&wN("ENABLE_ABSSENDTIME_AS_SENTTS"),et=eF({license:this.joinInfo.license,p2p_id:this.store.p2pId,session_id:this.joinInfo.sid,app_id:this.joinInfo.appId,channel_key:this.key,channel_name:this.joinInfo.cname,sdk_version:SJ,browser:navigator.userAgent,process_id:wN("PROCESS_ID"),mode:this.store.useP2P?"p2p":this.spec.mode,codec:this.spec.codec,role:this.role,has_changed_gateway:this.hasChangeBGPAddress,ap_response:V,extend:wN("JOIN_EXTEND"),details:{6:this.joinInfo.stringUid,cservice_map:"proxy3"===this.joinInfo.cloudProxyServer?"1":"proxy5"===this.joinInfo.cloudProxyServer?"2":void 0},features:{rejoin:!0},optionalInfo:this.joinInfo.optionalInfo,appScenario:F,attributes:{userAttributes:eF(eF({enableEncodedTransform:(!!wN("ENABLE_AUDIO_METADATA")||!!wN("ENABLE_AUDIO_PTS"))&&$||!!wN("ENABLE_AUDIO_TOPN")&&sw(fQ.CHROME,87,116)||void 0,enableAudioMetadata:!!wN("ENABLE_AUDIO_METADATA")&&$,enableAudioPts:!!wN("ENABLE_AUDIO_PTS")&&$,topnSmoothLevel:wN("TOPN_SMOOTH_LEVEL"),topnNewSpeakerDelay:wN("TOPN_NEW_SPEAKER_DELAY"),topnSwitchHoldMs:wN("TOPN_SWITCH_HOLD_MS"),topnAudioGain:wN("TOPN_AUDIO_GAIN"),enablePublishedUserList:wN("ENABLE_PUBLISHED_USER_LIST"),maxSubscription:wN("MAX_SUBSCRIPTION"),subscribeAudioFilterTopN:Yx("SUBSCRIBE_AUDIO_FILTER_TOPN","number"),enablePublishAudioFilter:Yx("ENABLE_PUBLISH_AUDIO_FILTER","boolean"),enableUserLicenseCheck:Yx("ENABLE_USER_LICENSE_CHECK","boolean"),enableRTX:!0===wN("USE_PUB_RTX")||!0===wN("USE_SUB_RTX")||void 0,disableFEC:wN("DISABLE_FEC"),enableNTPReport:!!wN("ENABLE_NTP_REPORT")||void 0,enableInstantVideo:G,enableFulllinkAvSync:!!wN("ENABLE_FULL_LINK_AV_SYNC")||void 0,enableDataStream2:Yx("ENABLE_DATASTREAM_2","boolean"),enableAutFeedback:!!wN("FORCE_ENABLE_AUT_CC")||!gD()&&(!!wN("ENABLE_AUT_FEEDBACK")||void 0),rtm2Flag:"number"==typeof this.joinInfo.rtmFlag?this.joinInfo.rtmFlag:void 0,enableUserAutoRebalanceCheck:!!wN("ENABLE_USER_AUTO_REBALANCE_CHECK"),enableXR:Yx("USE_XR","boolean"),enableLossbasedBwe:Yx("ENABLE_LOSSBASED_BWE","boolean"),enableAutCC:!!wN("FORCE_ENABLE_AUT_CC")||!gD()&&(!!wN("ENABLE_AUT_CC")||void 0),enableCCFallback:Yx("ENABLE_CC_FALLBACK","boolean"),enablePreallocPC:j,preSubNum:B?Yx("PRE_SUB_NUM","number"):void 0,enablePubTWCC:Yx("PUBLISH_TWCC","boolean"),enableSubTWCC:Yx("SUBSCRIBE_TWCC","boolean"),enablePubRTX:Yx("USE_PUB_RTX","boolean"),enableSubRTX:Yx("USE_SUB_RTX","boolean"),enableSubSVC:wN("ENABLE_SVC")?wN("ENABLE_SVC_DEFAULT_CODECS"):Array.isArray(wN("SVC"))&&0!==wN("SVC").length?wN("SVC"):void 0,enableSvcExtended:wN("ENABLE_SVC")&&Array.isArray(wN("SVC_EXTENDED"))&&0!==wN("SVC_EXTENDED").length?wN("SVC_EXTENDED"):void 0},X),{},{audioDuplicate:Yx("ENABLE_AUDIO_RED","boolean")?null!==(M=Yx("AUDIO_DUPLICATE_NUM","number"))&&void 0!==M?M:2:void 0,senttsUsesAbsSendTime:!!ee||void 0})},join_ts:this.joinGatewayStartTime},L);return this.joinInfo.stringUid&&(et.string_uid=this.joinInfo.stringUid),this.joinInfo.aesmode&&this.joinInfo.aespassword&&(et.aes_mode=this.joinInfo.aesmode,wN("ENCRYPT_AES")?(et.aes_secret=this.joinInfo.aespassword,et.aes_encrypt=!0):et.aes_secret=this.joinInfo.aespassword,this.joinInfo.aessalt&&(et.aes_salt=this.joinInfo.aessalt)),V.addresses[this.signal.websocket.currentURLIndex]&&(et.ap_response.ticket=V.addresses[this.signal.websocket.currentURLIndex].ticket,delete V.addresses),void 0!==this.joinInfo.defaultVideoStream&&(et.default_video_stream=this.joinInfo.defaultVideoStream),et}getRejoinMessage(){if(!this.joinInfo)throw new ED(f1.UNEXPECTED_ERROR,"can not generate rejoin message, no join info");return{session_id:this.joinInfo.sid,channel_name:this.joinInfo.cname,cid:this.joinInfo.cid,uid:this.joinInfo.uid,vid:Number(this.joinInfo.vid)}}handleSignalEvents(){this.signal.on(RE.WS_RECONNECT_CREATE_CONNECTION,L=>{this.joinGatewayStartTime=Date.now()}),this.signal.on(RE.WS_RECONNECTING,L=>{this.joinInfo&&g_.WebSocketQuit(this.joinInfo.sid,{lts:Date.now(),succ:-1,cname:this.joinInfo.cname,uid:this.joinInfo.uid,cid:this.joinInfo.cid,errorCode:L||Sr.NETWORK_ERROR}),this.joinInfo&&(this.state="RECONNECTING",g_.sessionInit(this.joinInfo.sid,{lts:(new Date).getTime(),extend:this.isSignalRecover?{recover:!0}:{rejoin:!0},cname:this.joinInfo.cname,appid:this.joinInfo.appId,mode:this.spec.mode,stringUid:this.joinInfo.stringUid,channelProfile:"live"===this.spec.mode?1:0,channelMode:0,lsid:this.joinInfo.sid,clientRole:"audience"===this.role?2:1,buildFormat:1}),this.isSignalRecover=!1,this.joinGatewayStartTime=Date.now())}),this.signal.on(RE.WS_CLOSED,L=>{let k;switch(L){case Se.LEAVE:k=Sr.LEAVE;break;case Se.UID_BANNED:case Se.IP_BANNED:case Se.CHANNEL_BANNED:case Se.SERVER_ERROR:k=Sr.SERVER_ERROR;break;case Se.FALLBACK:k=Sr.FALLBACK;break;case Se.LICENSE_MISSING:case Se.LICENSE_EXPIRED:case Se.LICENSE_MINUTES_EXCEEDED:case Se.LICENSE_PERIOD_INVALID:case Se.LICENSE_MULTIPLE_SDK_SERVICE:case Se.LICENSE_ILLEGAL:case Se.TOKEN_EXPIRE:k=L;break;default:k=Sr.NETWORK_ERROR}gc.debug("[".concat(this.store.clientId,"] [signal] websocket closed, reason: ").concat(k||"undefined -> "+Sr.NETWORK_ERROR)),this.joinInfo&&g_.WebSocketQuit(this.joinInfo.sid,{lts:Date.now(),succ:L===Se.LEAVE?1:-1,cname:this.joinInfo.cname,uid:this.joinInfo.uid,cid:this.joinInfo.cid,errorCode:k}),this._disconnectedReason=L,L!==Se.FALLBACK&&(this.state="DISCONNECTED"),this.reset()}),this.signal.on(RE.WS_CONNECTED,()=>{if(this.updateTurnConfigFromSignal(),this.state="CONNECTED",this.joinInfo){if("audience"===this.role){let L=wN("CLIENT_ROLE_OPTIONS")||this._clientRoleOptions;L&&(L.level||L.delay)&&(gc.debug("[".concat(this.store.clientId,"] patch to send set client role, role: ").concat(this.role,", mode: ").concat(this.spec.mode,", level: ").concat(L.level,", delay: ").concat(L.delay)),this.setClientRole(this.role,L))}if(g_.joinGateway(this.joinInfo.sid,{lts:this.joinGatewayStartTime,succ:!0,ec:null,vid:this.joinInfo.vid,addr:this.signal.url,uid:this.joinInfo.uid,cid:this.joinInfo.cid,firstSuccess:this._isProactiveJoin,isProxy:!!this.joinInfo.proxyServer,signalChannel:"0",preload:this.joinInfo.preload,isABTestSuccess:this.store.isABTestSuccess}),this._isProactiveJoin=!1,this.joinInfo.useLocalAccessPoint&&1===this.joinInfo.setLocalAPVersion){let L=this.signal.url&&this.signal.url.match(/wss\:\/\/([^:]+):(\d+)/);if(!L)return void gc.error("[".concat(this.store.clientId,"] set local access point after joined failed: ").concat(L));AN("EVENT_REPORT_DOMAIN",L[1]),AN("EVENT_REPORT_BACKUP_DOMAIN",L[1]),AN("LOG_UPLOAD_SERVER","".concat(L[1],":6444"))}}}),this.signal.on(RT.ON_UPLINK_STATS,L=>{this._statsCollector.updateUplinkStats(L)}),this.signal.on(RE.REQUEST_RECOVER,(L,k,M)=>{if(!this.joinInfo)return M(new ED(f1.UNEXPECTED_ERROR,"gateway: can not recover, no join info"));L&&(this.joinInfo.multiIP=L,this.hasChangeBGPAddress=!0),this.isSignalRecover=!0,oO(this,RH.REQUEST_NEW_GATEWAY_LIST).then(k).catch(M)}),this.signal.on(RE.REQUEST_JOIN_INFO,async(L,k,M)=>{var U,V,F,B;if(this.updateTurnConfigFromSignal(),this.store.useP2P)return void L(this.getJoinMessage({ortc:{}}));let j=pO(null===(U=this.joinInfo)||void 0===U?void 0:U.turnServer);if(wN("NEW_TURN_MODE")&&j&&"disabled"===(null===(V=this.joinInfo)||void 0===V?void 0:V.cloudProxyServer)){let L=j.servers.map(L=>"turnServerURL"in L&&wN("USE_TURN_IP")?eF(eF({},L),{},{turnServerURL:nx(L.turnServerURL)}):L),k=null===(B=j.serversFromGateway)||void 0===B?void 0:B.map(L=>wN("USE_TURN_IP")?eF(eF({},L),{},{turnServerURL:nx(L.turnServerURL)}):L),M=this.signal.currentURLIndex;L.length>0&&(L=[L[M%L.length]],j.servers=L),Array.isArray(k)&&k.length>0&&(k=[k[0]],j.serversFromGateway=k),gc.debug("[".concat(this.store.clientId,"] use single turn, use turn server index: ").concat(M))}let{iceParameters:G,dtlsParameters:X,rtpCapabilities:$}=await oO(this,RH.REQUEST_P2P_CONNECTION_PARAMS,{turnServer:j,cloudProxyServer:null===(F=this.joinInfo)||void 0===F?void 0:F.cloudProxyServer});try{L(this.getJoinMessage({ortc:{iceParameters:G,dtlsParameters:X,rtpCapabilities:$,version:"2"}}))}catch(L){k(L)}}),this.signal.on(RE.REQUEST_REJOIN_INFO,L=>{L(this.getRejoinMessage())}),this.signal.on(RE.REPORT_JOIN_GATEWAY,(L,k)=>{var M;if(!this.joinInfo)return;let U,V="";L instanceof ED?(U=(null===(M=L.data)||void 0===M?void 0:M.desc)||L.code,V=L.message):U=L,g_.joinGateway(this.joinInfo.sid,{lts:this.joinGatewayStartTime,succ:!1,ec:U,errorMsg:V,addr:k,uid:this.joinInfo.uid,cid:this.joinInfo.cid,firstSuccess:this._isProactiveJoin,isProxy:!!this.joinInfo.proxyServer,signalChannel:"0",preload:this.joinInfo.preload})}),this.signal.on(RE.IS_P2P_DISCONNECTED,L=>{L(cO(this,RH.IS_P2P_DISCONNECTED))}),this.signal.on(RE.DISCONNECT_P2P,()=>{this.emit(RH.DISCONNECT_P2P)}),this.signal.on(RE.REQUEST_SUCCESS,()=>{this._signalTimeout=!1}),this.signal.on(RE.REQUEST_TIMEOUT,()=>{this._signalTimeout=!0}),this.signal.on(RE.JOIN_RESPONSE,L=>{let k=this.getCurrentGatewayAddress();this.emit(RH.JOIN_RESPONSE,L,k)}),this.signal.on(RE.PRE_CONNECT_PC,async()=>{if(this.joinInfo){var L,k,M;this.updateTurnConfigFromSignal();let U=this.getCurrentGatewayAddress(),V=pO(null===(L=this.joinInfo)||void 0===L?void 0:L.turnServer);if(wN("NEW_TURN_MODE")&&V&&"disabled"===(null===(k=this.joinInfo)||void 0===k?void 0:k.cloudProxyServer)){let L=V.servers.map(L=>"turnServerURL"in L&&wN("USE_TURN_IP")?eF(eF({},L),{},{turnServerURL:nx(L.turnServerURL)}):L),k=null===(M=V.serversFromGateway)||void 0===M?void 0:M.map(L=>wN("USE_TURN_IP")?eF(eF({},L),{},{turnServerURL:nx(L.turnServerURL)}):L),U=this.signal.currentURLIndex;L.length>0&&(L=[L[U%L.length]],V.servers=L),Array.isArray(k)&&k.length>0&&(k=[k[0]],V.serversFromGateway=k),gc.debug("[".concat(this.store.clientId,"] use single turn, use turn server index: ").concat(U,",in pre pc"))}let F=wN("FINGERPRINT")||this.joinInfo.apResponse.addresses[this.signal.currentURLIndex].fingerprint;if(U&&F){let L=Ix(U);this.emit(RH.PRE_CONNECT_PC,{candidates:L,fingerprint:F,turnServer:V})}}}),this.signal.on(RE.RECOVER_NOTIFICATION,L=>{this.joinInfo&&"string"==typeof wN("AP_REQUEST_DETAIL")&&(this.joinInfo.apRequestDetail="".concat(wN("AP_REQUEST_DETAIL"),";").concat(L))})}async tryUnsubBeforeResub(L,k){try{await this.signal.request(Rf.UNSUBSCRIBE,{p2p_id:this.store.p2pId,stream_id:L,ortc:[k]},!0)}catch(L){throw gc.warning("[".concat(this.store.clientId,"] tryUnsubBeforeResub warning"),L),L}}async tryUnsubDataChannelBeforeResub(L,k){try{await this.signal.request(Rf.UNSUBSCRIBE,{stream_id:k.id},!0)}catch(L){throw gc.warning("unsubscribe datachannel warning",L),L}}async tryUnpubBeforeRepub(L,k){try{await this.signal.request(Rf.UNPUBLISH,{stream_id:L,ortc:k},!0)}catch(L){throw gc.warning("[".concat(this.store.clientId,"] tryUnpubBeforeRepub warning: "),L),L}}async tryUnpubDataChannelBeforeRepub(L,k){try{await this.signal.request(Rf.UNPUBLISH_DATASTREAM,{channnel_id:k.channelId},!0)}catch(L){throw gc.warning("unpublish datastream warning: ",L),L}}async tryMassUnsubBeforeResub(L){let k={users:L.map(L=>({stream_id:L.stream_id,stream_type:L.stream_type}))};try{await this.signal.request(Rf.UNSUBSCRIBE_STREAMS,k,!0)}catch(L){throw gc.warning("[".concat(this.store.clientId,"] tryMassUnsubBeforeResub warning"),L),L}}async muteLocal(L,k){let M={action:L.find(L=>L.stream_type===RG.Audio)?"mute_local_audio":"mute_local_video",p2p_id:this.store.p2pId,ortc:L,stream_id:k};try{await this.signal.request(Rf.CONTROL,M,!0,!0)}catch(L){throw gc.warning("[".concat(this.store.clientId,"] gateway muteLocal warning: "),L),L}}async unmuteLocal(L,k){let M={action:L.find(L=>L.stream_type===RG.Audio)?"unmute_local_audio":"unmute_local_video",p2p_id:this.store.p2pId,ortc:L,stream_id:k};try{await this.signal.request(Rf.CONTROL,M,!0,!0)}catch(L){throw gc.warning("[".concat(this.store.clientId,"] gateway unmuteLocal warning: "),L),L}}async muteRemote(L,k){let M={action:L===R1.AUDIO?"mute_remote_audio":"mute_remote_video",p2p_id:this.store.p2pId,stream_id:k};try{await this.signal.request(Rf.CONTROL,M,!0,!0)}catch(L){throw gc.warning("[".concat(this.store.clientId,"] gateway muteRemote warning: "),L),L}}async unmuteRemote(L,k){let M={action:L===R1.AUDIO?"unmute_remote_audio":"unmute_remote_video",p2p_id:this.store.p2pId,stream_id:k};try{await this.signal.request(Rf.CONTROL,M,!0,!0)}catch(L){throw gc.warning("[".concat(this.store.clientId,"] gateway unmuteRemote warning: "),L),L}}uploadWRTCStats(L){this.signal.uploadWRTCStats(L)}upload(L,k){this.signal.upload(L,k)}getSignalRTT(){return this.signal.rtt}async restartICE(L){let k={p2p_id:this.store.p2pId,stream_id:this.store.uid,ortc:L};try{return await this.signal.request(Rf.RESTART_ICE,k,!0)}catch(L){throw gc.warning("[".concat(this.store.clientId,"] P2PChannel.restartICE warning: "),L),L}}reconnect(L,k){"CONNECTED"===this.state&&this.signal.reconnect(L||void 0,k||Sr.P2P_FAILED)}getCurrentGatewayAddress(){var L,k;if(!wN("GATEWAY_WSS_ADDRESS"))return wN("USE_CANDIDATE_FROM_AP_DETAIL")&&null!==(L=this.joinInfo)&&void 0!==L&&L.apGatewayAddress?(gc.debug("[".concat(this.store.clientId,"] use candidate from ap detail, ").concat(JSON.stringify(this.joinInfo.apGatewayAddress))),this.joinInfo.apGatewayAddress):null!==(k=this.joinInfo)&&void 0!==k&&k.gatewayAddrs?this.joinInfo.gatewayAddrs[this.signal.currentURLIndex]:void 0}async setPublishAudioFilterEnabled(L){await this.signal.request(Rf.SET_PARAMETER,{enablePublishAudioFilter:L})}downgradeCodec(L){this.signal.downgradeCodec(L)}};let IA=0,IN=0;function oF(L,k,M,U){return new lQ((V,F)=>{k.timeout=k.timeout||wN("HTTP_CONNECT_TIMEOUT"),k.responseType=k.responseType||"json",k.data&&!M?(k.data=JSON.stringify(k.data),IA+=RO(k.data)):M&&(k.data.size?IA+=k.data.size:k.data instanceof FormData?IA+=vO(k.data):IA+=RO(JSON.stringify(k.data))),k.headers=k.headers||{},k.headers["Content-Type"]=k.headers["Content-Type"]||"application/json",k.method="POST",k.url=L,fG.request(k).then(L=>{"string"==typeof L.data?IN+=RO(L.data):L.data instanceof ArrayBuffer||L.data instanceof Uint8Array?IN+=L.data.byteLength:IN+=RO(JSON.stringify(L.data)),U&&V({data:L.data,headers:L.headers}),V(L.data)}).catch(L=>{fG.isCancel(L)?F(new ED(f1.OPERATION_ABORTED,"cancel token canceled")):"ECONNABORTED"===L.code?F(new ED(f1.NETWORK_TIMEOUT,L.message)):L.response?F(new ED(f1.NETWORK_RESPONSE_ERROR,L.response.status)):F(new ED(f1.NETWORK_ERROR,L.message))})})}/*! formdata-polyfill. MIT License. Jimmy W?rting <https://jimmy.warting.se/opensource> */!function(){function i(L){var k=0;return function(){return k<L.length?{done:!1,value:L[k++]}:{done:!0}}}var L,k,M,U="function"==typeof Object.defineProperties?Object.defineProperty:function(L,k,M){return L==Array.prototype||L==Object.prototype||(L[k]=M.value),L},V=function(L){L=["object"==typeof globalThis&&globalThis,L,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof an&&an];for(var k=0;k<L.length;++k){var M=L[k];if(M&&M.Math==Math)return M}throw Error("Cannot find global object")}(this);function s(L,k){if(k)e:{var M=V;L=L.split(".");for(var F=0;F<L.length-1;F++){var B=L[F];if(!(B in M))break e;M=M[B]}(k=k(F=M[L=L[L.length-1]]))!=F&&null!=k&&U(M,L,{configurable:!0,writable:!0,value:k})}}function a(L){return(L={next:L})[Symbol.iterator]=function(){return this},L}function c(L){var k="undefined"!=typeof Symbol&&Symbol.iterator&&L[Symbol.iterator];return k?k.call(L):{next:i(L)}}if(s("Symbol",function(L){function t(L,k){this.A=L,U(this,"description",{configurable:!0,writable:!0,value:k})}if(L)return L;t.prototype.toString=function(){return this.A};var k="jscomp_symbol_"+(1e9*Math.random()>>>0)+"_",M=0;return function e(L){if(this instanceof e)throw TypeError("Symbol is not a constructor");return new t(k+(L||"")+"_"+M++,L)}}),s("Symbol.iterator",function(L){if(L)return L;L=Symbol("Symbol.iterator");for(var k="Array Int8Array Uint8Array Uint8ClampedArray Int16Array Uint16Array Int32Array Uint32Array Float32Array Float64Array".split(" "),M=0;M<k.length;M++){var F=V[k[M]];"function"==typeof F&&"function"!=typeof F.prototype[L]&&U(F.prototype,L,{configurable:!0,writable:!0,value:function(){return a(i(this))}})}return L}),"function"==typeof Object.setPrototypeOf)M=Object.setPrototypeOf;else{e:{var F={};try{F.__proto__={a:!0},L=F.a;break e}catch(L){}L=!1}M=L?function(L,k){if(L.__proto__=k,L.__proto__!==k)throw TypeError(L+" is not extensible");return L}:null}var B=M;function h(){this.m=!1,this.j=null,this.v=void 0,this.h=1,this.u=this.C=0,this.l=null}function p(L){if(L.m)throw TypeError("Generator is already running");L.m=!0}function _(L,k){return L.h=3,{value:k}}function E(L){this.g=new h,this.G=L}function m(L,k,M,U){try{var V=k.call(L.g.j,M);if(!(V instanceof Object))throw TypeError("Iterator result "+V+" is not an object");if(!V.done)return L.g.m=!1,V;var F=V.value}catch(k){return L.g.j=null,L.g.s(k),f(L)}return L.g.j=null,U.call(L.g,F),f(L)}function f(L){for(;L.g.h;)try{var k=L.G(L.g);if(k)return L.g.m=!1,{value:k.value,done:!1}}catch(k){L.g.v=void 0,L.g.s(k)}if(L.g.m=!1,L.g.l){if(k=L.g.l,L.g.l=null,k.F)throw k.D;return{value:k.return,done:!0}}return{value:void 0,done:!0}}function S(L){this.next=function(k){return L.o(k)},this.throw=function(k){return L.s(k)},this.return=function(k){var M;return p(L.g),(M=L.g.j)?m(L,"return"in M?M.return:function(L){return{value:L,done:!0}},k,L.g.return):(L.g.return(k),f(L))},this[Symbol.iterator]=function(){return this}}function g(L,k){return k=new S(new E(k)),B&&L.prototype&&B(k,L.prototype),k}if(h.prototype.o=function(L){this.v=L},h.prototype.s=function(L){this.l={D:L,F:!0},this.h=this.C||this.u},h.prototype.return=function(L){this.l={return:L},this.h=this.u},E.prototype.o=function(L){return p(this.g),this.g.j?m(this,this.g.j.next,L,this.g.o):(this.g.o(L),f(this))},E.prototype.s=function(L){return p(this.g),this.g.j?m(this,this.g.j.throw,L,this.g.o):(this.g.s(L),f(this))},s("Array.prototype.entries",function(L){return L||function(){var L,k,M,U;return L=this,L instanceof String&&(L+=""),k=0,M=!1,(U={next:function(){if(!M&&k<L.length){var U=k++;return{value:[U,L[U]],done:!1}}return M=!0,{done:!0,value:void 0}}})[Symbol.iterator]=function(){return U},U}}),"undefined"!=typeof Blob&&("undefined"==typeof FormData||!FormData.prototype.keys)){var T=function(L,k){for(var M=0;M<L.length;M++)k(L[M])},R=function(L){return L.replace(/\r?\n|\r/g,"\r\n")},v=function(L,k,M){return k instanceof Blob?(M=void 0!==M?String(M+""):"string"==typeof k.name?k.name:"blob",k.name===M&&"[object Blob]"!==Object.prototype.toString.call(k)||(k=new File([k],M)),[String(L),k]):[String(L),String(k)]},C=function(L,k){if(L.length<k)throw TypeError(k+" argument required, but only "+L.length+" present.")},j="object"==typeof globalThis?globalThis:"object"==typeof window?window:"object"==typeof self?self:this,G=j.FormData,X=j.XMLHttpRequest&&j.XMLHttpRequest.prototype.send,$=j.Request&&j.fetch,ee=j.navigator&&j.navigator.sendBeacon,et=j.Element&&j.Element.prototype,ei=j.Symbol&&Symbol.toStringTag;ei&&(Blob.prototype[ei]||(Blob.prototype[ei]="Blob"),"File"in j&&!File.prototype[ei]&&(File.prototype[ei]="File"));try{new File([],"")}catch(L){j.File=function(L,k,M){return Object.defineProperties(L=new Blob(L,M||{}),{name:{value:k},lastModified:{value:+(M&&void 0!==M.lastModified?new Date(M.lastModified):new Date)},toString:{value:function(){return"[object File]"}}}),ei&&Object.defineProperty(L,ei,{value:"File"}),L}}var D=function(L){return L.replace(/\n/g,"%0A").replace(/\r/g,"%0D").replace(/"/g,"%22")},P=function(L){this.i=[];var k=this;L&&T(L.elements,function(L){if(L.name&&!L.disabled&&"submit"!==L.type&&"button"!==L.type&&!L.matches("form fieldset[disabled] *")){if("file"===L.type){var M=L.files&&L.files.length?L.files:[new File([],"",{type:"application/octet-stream"})];T(M,function(M){k.append(L.name,M)})}else"select-multiple"===L.type||"select-one"===L.type?T(L.options,function(M){!M.disabled&&M.selected&&k.append(L.name,M.value)}):"checkbox"===L.type||"radio"===L.type?L.checked&&k.append(L.name,L.value):(M="textarea"===L.type?R(L.value):L.value,k.append(L.name,M))}})};if((k=P.prototype).append=function(L,k,M){C(arguments,2),this.i.push(v(L,k,M))},k.delete=function(L){C(arguments,1);var k=[];L=String(L),T(this.i,function(M){M[0]!==L&&k.push(M)}),this.i=k},k.entries=function e(){var L,k=this;return g(e,function(M){if(1==M.h&&(L=0),3!=M.h)return L<k.i.length?M=_(M,k.i[L]):(M.h=0,M=void 0),M;L++,M.h=2})},k.forEach=function(L,k){C(arguments,1);for(var M=c(this),U=M.next();!U.done;U=M.next()){var V=c(U.value);U=V.next().value,V=V.next().value,L.call(k,V,U,this)}},k.get=function(L){C(arguments,1);var k=this.i;L=String(L);for(var M=0;M<k.length;M++)if(k[M][0]===L)return k[M][1];return null},k.getAll=function(L){C(arguments,1);var k=[];return L=String(L),T(this.i,function(M){M[0]===L&&k.push(M[1])}),k},k.has=function(L){C(arguments,1),L=String(L);for(var k=0;k<this.i.length;k++)if(this.i[k][0]===L)return!0;return!1},k.keys=function e(){var L,k,M=this;return g(e,function(U){if(1==U.h&&(k=(L=c(M)).next()),3!=U.h)return k.done?void(U.h=0):_(U,c(k.value).next().value);k=L.next(),U.h=2})},k.set=function(L,k,M){C(arguments,2);var U=[],V=v(L=String(L),k,M),F=!0;T(this.i,function(k){k[0]===L?F&&(F=!U.push(V)):U.push(k)}),F&&U.push(V),this.i=U},k.values=function e(){var L,k,M,U=this;return g(e,function(V){if(1==V.h&&(k=(L=c(U)).next()),3!=V.h)return k.done?void(V.h=0):((M=c(k.value)).next(),_(V,M.next().value));k=L.next(),V.h=2})},P.prototype._asNative=function(){for(var L=new G,k=c(this),M=k.next();!M.done;M=k.next()){var U=c(M.value);M=U.next().value,U=U.next().value,L.append(M,U)}return L},P.prototype._blob=function(){var L="----formdata-polyfill-"+Math.random(),k=[],M="--"+L+'\r\nContent-Disposition: form-data; name="';return this.forEach(function(L,U){return"string"==typeof L?k.push(M+D(R(U))+'"\r\n\r\n'+R(L)+"\r\n"):k.push(M+D(R(U))+'"; filename="'+D(L.name)+'"\r\nContent-Type: '+(L.type||"application/octet-stream")+"\r\n\r\n",L,"\r\n")}),k.push("--"+L+"--"),new Blob(k,{type:"multipart/form-data; boundary="+L})},P.prototype[Symbol.iterator]=function(){return this.entries()},P.prototype.toString=function(){return"[object FormData]"},et&&!et.matches&&(et.matches=et.matchesSelector||et.mozMatchesSelector||et.msMatchesSelector||et.oMatchesSelector||et.webkitMatchesSelector||function(L){for(var k=(L=(this.document||this.ownerDocument).querySelectorAll(L)).length;0<=--k&&L.item(k)!==this;);return -1<k}),ei&&(P.prototype[ei]="FormData"),X){var er=j.XMLHttpRequest.prototype.setRequestHeader;j.XMLHttpRequest.prototype.setRequestHeader=function(L,k){er.call(this,L,k),"content-type"===L.toLowerCase()&&(this.B=!0)},j.XMLHttpRequest.prototype.send=function(L){L instanceof P&&(L=L._blob(),this.B||this.setRequestHeader("Content-Type",L.type)),X.call(this,L)}}$&&(j.fetch=function(L,k){return k&&k.body&&k.body instanceof P&&(k.body=k.body._blob()),$.call(this,L,k)}),ee&&(j.navigator.sendBeacon=function(L,k){return k instanceof P&&(k=k._asNative()),ee.call(this,L,k)}),j.FormData=P}}();let sF=()=>{let L=wN("AREAS");return 0===L.length&&L.push(RX.GLOBAL),sE(L).call(L,(L,k,M)=>{let U=aF(k);return U?0===M?U:"".concat(L,",").concat(U):L},"")},aF=L=>L===RX.OVERSEA?"".concat(RZ.ASIA,",").concat(RZ.EUROPE,",").concat(RZ.AFRICA,",").concat(RZ.NORTH_AMERICA,",").concat(RZ.SOUTH_AMERICA,",").concat(RZ.OCEANIA):RZ[L],cF=L=>{let k={CODE:"",WEBCS_DOMAIN:[],WEBCS_DOMAIN_BACKUP_LIST:[],PROXY_CS:[],CDS_AP:[],ACCOUNT_REGISTER:[],UAP_AP:[],EVENT_REPORT_DOMAIN:[],EVENT_REPORT_BACKUP_DOMAIN:[],LOG_UPLOAD_SERVER:[],PROXY_SERVER_TYPE3:[]};return L.map(L=>{let M=R$[L],U=Object.keys(M);U&&U.map(L=>{"CODE"!==L&&(k[L]=k[L].concat(M[L]))})}),k},IP={GLOBAL:{ASIA:[RX.CHINA,RX.JAPAN,RX.INDIA,RX.KOREA,RX.HKMC],EUROPE:[],NORTH_AMERICA:[RX.US],SOUTH_AMERICA:[],OCEANIA:[],AFRICA:[]}},IL=Object.keys(IP[RX.GLOBAL]),Ik=[RX.CHINA,RX.NORTH_AMERICA,RX.EUROPE,RX.ASIA,RX.JAPAN,RX.INDIA,RX.OCEANIA,RX.SOUTH_AMERICA,RX.AFRICA,RX.KOREA,RX.HKMC,RX.US],hF=function(L,k){let M=[];if(so(L).call(L,RX.GLOBAL)){let U=[RX.GLOBAL,RX.OVERSEA],V=Object.keys(R$);if(k===RX.GLOBAL)throw new ED(f1.INVALID_PARAMS,"GLOBAL is an invalid excludedArea value");if(k===RX.CHINA)M=[RX.OVERSEA];else if(so(IL).call(IL,k)){let L=IP[RX.GLOBAL][k]||[],F=[...U,k,...L];M=V.filter(L=>!so(F).call(F,L))}else{let F;if(F=!1,IL.forEach(L=>{var M;so(M=IP[RX.GLOBAL][L]).call(M,k)&&(F=!0)}),F){let L;let F=(IL.forEach(M=>{var U;so(U=IP[RX.GLOBAL][M]).call(U,k)&&(L=M)}),L),B=[...U,F,k];M=V.filter(L=>!so(B).call(B,L))}else M=L}M=function(L){let k=[];return Ik.forEach(M=>{so(L).call(L,M)&&k.push(M)}),k.concat(L.filter(L=>!so(Ik).call(Ik,L)))}(M)}else M=L;return M};function pF(L){var k,M;if(!L&&so(k=wN("AREAS")).call(k,RX.EXTENSIONS))return gc.debug("update area from ap : reset"),void _F(TX,!0);if(!so(M=wN("AREAS")).call(M,RX.GLOBAL)||!L)return;let U=R$.EXTENSIONS;U&&(U={CODE:aF(RX.EXTENSIONS),WEBCS_DOMAIN:["ap-web-1-".concat(L,".agora.io")],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-".concat(L,".ap.sd-rtn.com")],PROXY_CS:["proxy-ap-web-".concat(L,".agora.io")],CDS_AP:["cds-ap-web-1-".concat(L,".agora.io"),"cds-ap-web-2-".concat(L,".ap.sd-rtn.com")],ACCOUNT_REGISTER:["sua-ap-web-1-".concat(L,".agora.io"),"sua-ap-web-2-".concat(L,".ap.sd-rtn.com")],UAP_AP:["uap-ap-web-1-".concat(L,".agora.io"),"uap-ap-web-2-".concat(L,".ap.sd-rtn.com")],EVENT_REPORT_DOMAIN:["statscollector-1-".concat(L,".agora.io")],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-".concat(L,".agora.io")],LOG_UPLOAD_SERVER:["logservice-".concat(L,".agora.io")],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy-".concat(L,".agora.io")]},gc.debug("update area from ap success: ".concat(L,",config is "),U),AN("AREAS",[RX.EXTENSIONS],!0),Object.keys(U).map(L=>{"LOG_UPLOAD_SERVER"===L||"EVENT_REPORT_DOMAIN"===L||"EVENT_REPORT_BACKUP_DOMAIN"===L||"PROXY_SERVER_TYPE3"===L?AN(L,U[L][0]):AN(L,U[L])}))}function _F(L){let k=arguments.length>1&&void 0!==arguments[1]&&arguments[1],M=g_.reportApiInvoke(null,{name:f8.SET_AREA,options:L,tag:f9.TRACER});try{let U=[];if("string"==typeof L&&(U=[L]),Array.isArray(L)&&(L.forEach(L=>{if(!so(RQ).call(RQ,L))throw new ED(f1.INVALID_PARAMS,"invalid area code")}),U=L),"[object Object]"===Object.prototype.toString.call(L)){let{areaCode:k,excludedArea:M}=L;if(!k)throw new ED(f1.INVALID_PARAMS,"area code is needed");let V=k;"string"==typeof k&&(V=[k]),U=M?hF(V,M):V}if(!k){if(S4.AREAS){let L=new ED(f1.PROHIBITED_OPERATION,"setArea is prohibited because of config-distribute");return M.onError(L),void gc.warning("setArea is prohibited because of config-distribute")}if(so(U).call(U,RX.GLOBAL)&&wN("AREAS")===RX.EXTENSIONS){let L=new ED(f1.PROHIBITED_OPERATION,"setArea is prohibited because of ap extensions");return M.onError(L),void gc.warning("setArea is prohibited because of ap extensions")}}AN("AREAS",U,k);let V=cF(U);Object.keys(V).map(L=>{"LOG_UPLOAD_SERVER"===L||"EVENT_REPORT_DOMAIN"===L||"EVENT_REPORT_BACKUP_DOMAIN"===L||"PROXY_SERVER_TYPE3"===L?AN(L,V[L][0]):AN(L,V[L])}),gc.debug("set area success:",U.join(","))}catch(L){throw M.onError(L),L}M.onSuccess()}function EF(L,k){var M=Object.keys(L);if(Object.getOwnPropertySymbols){var U=Object.getOwnPropertySymbols(L);k&&(U=U.filter(function(k){return Object.getOwnPropertyDescriptor(L,k).enumerable})),M.push.apply(M,U)}return M}function mF(L){for(var k=1;k<arguments.length;k++){var M=null!=arguments[k]?arguments[k]:{};k%2?EF(Object(M),!0).forEach(function(k){uI(L,k,M[k])}):Object.getOwnPropertyDescriptors?Object.defineProperties(L,Object.getOwnPropertyDescriptors(M)):EF(Object(M)).forEach(function(k){Object.defineProperty(L,k,Object.getOwnPropertyDescriptor(M,k))})}return L}let IM=1;function SF(L,k,M,U,V){IM+=1;let F={sid:M.sid,command:"convergeAllocateEdge",uid:"666",appId:M.appId,ts:Math.floor(Date.now()/1e3),seq:IM,requestId:IM,version:SJ,cname:M.cname},B={service_name:k,json_body:JSON.stringify(F)},j,G,X=L[0];return GO(async()=>{j=Date.now();let L=await oF(X,{data:B,cancelToken:U,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"}});if(G=Date.now()-j,0!==L.code){let k=new ED(f1.UNEXPECTED_RESPONSE,"live streaming ap error, code"+L.code,{retry:!0,responseTime:G});throw gc.error(k.toString()),k}let M=JSON.parse(L.json_body);if(200!==M.code){let L=new ED(f1.UNEXPECTED_RESPONSE,"live streaming app center error, code: ".concat(M.code,", reason: ").concat(M.reason),{code:M.code,responseTime:G});throw gc.error(L.toString()),L}if(!M.servers||0===M.servers.length){let L=new ED(f1.UNEXPECTED_RESPONSE,"live streaming app center empty server",{code:M.code,responseTime:G});throw gc.error(L.toString()),L}let V={addressList:M.servers.map(L=>"wss://".concat(L.address.replace(/\./g,"-"),".").concat(wN("WORKER_DOMAIN"),":").concat(L.wss,"?serviceName=").concat(encodeURIComponent(k))),workerToken:M.workerToken,vid:M.vid};return wN("LIVE_STREAMING_ADDRESS")&&(V.addressList=wN("LIVE_STREAMING_ADDRESS") instanceof Array?wN("LIVE_STREAMING_ADDRESS"):[wN("LIVE_STREAMING_ADDRESS")]),mF(mF({},V),{},{responseTime:G})},(U,V)=>(g_.apworkerEvent(M.sid,{success:!0,sc:200,serviceName:k,responseDetail:JSON.stringify(U.addressList),firstSuccess:0===V,responseTime:G,serverIp:L[V%L.length]}),!1),(U,V)=>(g_.apworkerEvent(M.sid,{success:!1,sc:U.data&&U.data.code||200,serviceName:k,responseTime:G,serverIp:L[V%L.length]}),!!(U.code!==f1.OPERATION_ABORTED&&U.code!==f1.UNEXPECTED_RESPONSE||U.data&&U.data.retry)&&(X=L[(V+1)%L.length],!0)),V)}let IU=1;function TF(L,k,M,U){let V,{url:F,areaCode:B}=L,{clientId:j,sid:G}=k,X=Date.now(),$=k.role,[ee,et]=IF(k,B,[II.CHOOSE_SERVER]),ei=Ss.networkState;return GO(async()=>{ei&&Ss.networkState===Sa.OFFLINE&&Ss.onlineWaiter&&await lQ.race([Ss.onlineWaiter,yO(U&&U.maxRetryTimeout||Sm.maxRetryTimeout)]),ei=Ss.networkState;let{data:L,headers:B}=await oF(F,{data:ee,cancelToken:M,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);V="1"===B.http3?1:-1,g_.reportResourceTiming(F,G),vF(L,F,k,X,[II.CHOOSE_SERVER],V);let j=cx(L,II.CHOOSE_SERVER);return CF(j),rx(j,F)},L=>(L&&g_.joinChooseServer(G,{role:$,lts:X,succ:!0,csAddr:F,opid:et,serverList:L.gatewayAddrs.map(L=>L.address),ec:null,cid:L.cid.toString(),uid:L.uid.toString(),csIp:L.csIp,unilbsServerIds:[II.CHOOSE_SERVER].toString(),isHttp3:V,corssRegionTagReq:k.apRequestDetail,corssRegionTagRes:L.res.detail&&L.res.detail[38]}),!1),L=>L.code!==f1.OPERATION_ABORTED&&(L.code===f1.CAN_NOT_GET_GATEWAY_SERVER?L.data.retry:(g_.joinChooseServer(G,{role:$,lts:X,succ:!1,csAddr:F,serverList:null,opid:et,ec:L.code,csIp:L.data&&L.data.csIp,unilbsServerIds:[II.CHOOSE_SERVER].toString(),extend:JSON.stringify({networkState:ei}),isHttp3:V,corssRegionTagReq:k.apRequestDetail}),gc.warning("[".concat(j||"sid-".concat(G.slice(0,6)),"] Choose server network error, retry"),L),!0)),U)}function RF(L,k,M,U){let V,F,{url:B,areaCode:j,serviceIds:G}=L,X=Date.now(),$=k.role,[ee,et]=IF(k,j,G);return GO(async()=>{let L;V&&Ss.networkState===Sa.OFFLINE&&Ss.onlineWaiter&&await lQ.race([Ss.onlineWaiter,yO(U&&U.maxRetryTimeout||Sm.maxRetryTimeout)]),V=Ss.networkState;let{data:j,headers:$}=await oF(B,{data:ee,cancelToken:M,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);F="1"===$.http3?1:-1,g_.reportResourceTiming(B,k.sid),vF(j,B,k,X,G,F);let et=cx(j,II.CHOOSE_SERVER),ei=cx(j,"proxy5"===k.cloudProxyServer?II.CLOUD_PROXY_5:"proxy3"===k.cloudProxyServer||"proxy4"===k.cloudProxyServer?II.CLOUD_PROXY:II.CLOUD_PROXY_FALLBACK),er=performance.getEntriesByName(B),en=er[er.length-1];return en&&(L={name:en.name,protocol:"nextHopProtocol"in en?en.nextHopProtocol:"",dnscost:"domainLookupEnd"in en&&"domainLookupStart"in en&&"number"==typeof en.domainLookupEnd&&"number"==typeof en.domainLookupStart?en.domainLookupEnd-en.domainLookupStart:-1,tcpTlsCost:"connectEnd"in en&&"connectStart"in en&&"number"==typeof en.connectEnd&&"number"==typeof en.connectStart?en.connectEnd-en.connectStart:-1,reqCost:"requestStart"in en&&"number"==typeof en.requestStart&&"responseEnd"in en&&"number"==typeof en.responseEnd?en.responseEnd-en.requestStart:-1,handleCost:"leave_ts"in j&&"enter_ts"in j&&"number"==typeof j.leave_ts&&"number"==typeof j.enter_ts?j.leave_ts-j.enter_ts:-1}),CF(et),{gatewayInfo:rx(et,B),proxyInfo:ei,url:B,resourceTimingInfo:L}},L=>(L.gatewayInfo&&g_.joinChooseServer(k.sid,{role:$,lts:X,succ:!0,csAddr:B,serverList:L.gatewayInfo.gatewayAddrs.map(L=>L.address),ec:null,opid:et,cid:L.gatewayInfo.cid.toString(),uid:L.gatewayInfo.uid.toString(),csIp:L.gatewayInfo.csIp,unilbsServerIds:G.toString(),isHttp3:F,corssRegionTagReq:k.apRequestDetail,corssRegionTagRes:L.gatewayInfo.res.detail&&L.gatewayInfo.res.detail[38],resourceTimingInfo:L.resourceTimingInfo?JSON.stringify(L.resourceTimingInfo):void 0}),L.proxyInfo&&g_.joinWebProxyAP(k.sid,{lts:X,sucess:1,apServerAddr:B,turnServerAddrList:L.proxyInfo.addresses.map(L=>L.ip).join(","),errorCode:null,eventType:k.cloudProxyServer,unilbsServerIds:G.toString()}),!1),L=>L.code!==f1.OPERATION_ABORTED&&(L.code===f1.CAN_NOT_GET_GATEWAY_SERVER?L.data.retry:(g_.joinWebProxyAP(k.sid,{lts:X,sucess:0,apServerAddr:B,turnServerAddrList:null,errorCode:L.code,eventType:k.cloudProxyServer,unilbsServerIds:G.toString(),extend:JSON.stringify({networkState:V})}),gc.warning("[".concat(k.clientId,"] multi unilbs network error, retry"),L),!0)),U)}let vF=(L,k,M,U,V,F)=>{let{sid:B,clientId:j,cloudProxyServer:G}=M,X=[],l=j=>{4096===j.flag?g_.joinChooseServer(B,{role:M.role,lts:U,succ:!1,csAddr:k,opid:L.opid,serverList:null,ec:j.error.message,csIp:j.error.data&&j.error.data.csIp,unilbsServerIds:V.toString(),isHttp3:F,corssRegionTagReq:M.apRequestDetail}):1048576!==j.flag&&4194304!==j.flag&&4194310!==j.flag||g_.joinWebProxyAP(B,{lts:U,sucess:0,apServerAddr:k,turnServerAddrList:null,errorCode:j.error.code,eventType:G,unilbsServerIds:V.toString()})};if(L.response_body.forEach(k=>{let M=k.buffer.code;if(23===k.uri&&0===M&&!k.buffer.edges_services){if(4194310===k.buffer.flag)gc.warning("no edge services in ap response of proxy fallback, will not set proxy in iceServers"),k.buffer.edges_services=[];else{let M={error:new ED(f1.CAN_NOT_GET_GATEWAY_SERVER,"no edge services in ap response",{retry:!0,csIp:L.detail[502]}),flag:k.buffer.flag};X.push(M),l(M)}}if(0!==M){let U=MV(M),V={error:new ED(f1.CAN_NOT_GET_GATEWAY_SERVER,U.desc,{desc:U.desc,retry:U.retry,csIp:L.detail[502]}),flag:k.buffer.flag};4194310===k.buffer.flag?gc.warning(V.error.toString()):X.push(V),l(V)}}),X.length)throw gc.warning("[".concat(j||"sid-".concat(B.slice(0,6)),"] multi unilbs ").concat(k," failed, ").concat(X.map(L=>"flag: ".concat(L.flag,", message: ").concat(L.error.message,", retry: ").concat(L.error.data.retry)).join(" | "))),new ED(f1.CAN_NOT_GET_GATEWAY_SERVER,X.map(L=>"flag: ".concat(L.flag,", message: ").concat(L.error.message)).join(" | "),{retry:!!X.find(L=>L.error.data.retry),csIp:L.detail[502],desc:[...new Set(X.map(L=>{var k;return null==L||null===(k=L.error)||void 0===k||null===(k=k.data)||void 0===k?void 0:k.desc}).filter(L=>!!L))]})},CF=L=>{var k,M,U,V,F;if(L.addresses&&0===L.addresses.length&&0===L.code)throw new ED(f1.CAN_NOT_GET_GATEWAY_SERVER,"void gateway address",{retry:!0,csIp:L.detail&&L.detail[502]});if(wN("AP_AREA")&&(null!==(U=L.detail)&&void 0!==U&&U[23]&&"string"==typeof(null===(V=L.detail)||void 0===V?void 0:V[23])?pF(L.detail[23].toLowerCase()):pF()),null!==(k=L.detail)&&void 0!==k&&k[19]&&"string"==typeof(null===(M=L.detail)||void 0===M?void 0:M[19])){let k=L.detail[19],M=null==k?void 0:k.split(";");for(let k=0;k<M.length;k++){let U=_p(F=M[k]).call(F);L.addresses[k]&&M&&(L.addresses[k].fingerprint=U)}}if(wN("GATEWAY_ADDRESS")&&wN("GATEWAY_ADDRESS").length>0){gc.debug("assign gateway address to",wN("GATEWAY_ADDRESS"));let k=wN("GATEWAY_ADDRESS").map(k=>{var M,U;let V=null!==(M=null===(U=L.addresses.find(L=>L.ip===k.ip&&L.port===k.port))||void 0===U?void 0:U.fingerprint)&&void 0!==M?M:"";return{ip:k.ip,port:k.port,ticket:L.addresses[0]&&L.addresses[0].ticket,fingerprint:V}});L.addresses=k}},yF=(L,k)=>{if(L.response_body&&L.response_body.length){let k=L.response_body[0];if(0!==k.buffer.code){let L=MV(k.buffer.code);throw new ED(f1.UPDATE_TICKET_FAILED,"[".concat(k.buffer.code,"]: ").concat(L.desc),{retry:L.retry})}return k.buffer.ticket}throw gc.debug("update ticket request received ap response without response body:",k),new ED(f1.UPDATE_TICKET_FAILED,"cannot find response body from ap response",{retry:!1})},IF=(L,k,M)=>{let U=Math.floor(1e12*Math.random()),V="host"===L.role?"1":"audience"===L.role?"2":void 0,F={appid:L.appId,client_ts:Date.now(),opid:U,sid:L.sid,request_bodies:[{uri:22,buffer:{cname:L.cname,detail:mF(mF(mF({6:L.stringUid,11:k,12:wN("USE_NEW_TOKEN")?"1":void 0},V?{17:V}:{}),{},{22:k},L.apRequestDetail?{33:L.apRequestDetail}:{}),L.apRTM?{26:"RTM2"}:{}),key:L.token,service_ids:M,uid:L.uid||0}}]};F.request_bodies.forEach(k=>{L.multiIP&&L.multiIP.gateway_ip&&(k.buffer.detail[5]=JSON.stringify({vocs_ip:[L.multiIP.uni_lbs_ip],vos_ip:[L.multiIP.gateway_ip]}))});let B=new FormData;return B.append("request",JSON.stringify(F)),[B,U]},bF=(L,k)=>{let M=Math.floor(1e12*Math.random()),U={appid:L.appId,client_ts:Date.now(),opid:M,sid:L.sid,request_bodies:[{uri:28,buffer:{cname:L.cname,detail:{1:"",6:L.stringUid,12:"1"},token:L.token,service_ids:k,uid:L.uid||0,edges_services:L.apResponse.addresses.map(L=>({ip:L.ip,port:L.port}))}}]},V=new FormData;return V.append("request",JSON.stringify(U)),[V,M]},IV=0;function wF(L){return lQ.all(L.map(L=>L.then(L=>{throw L},L=>L))).then(L=>{throw L},L=>L)}let OF=async L=>{let{fragementLength:k,referenceList:M,asyncMapHandler:U,allFailedhandler:V,promisesCollector:F}=L,B=0,j,G=0,l=async()=>{let L=(()=>{let L=B*k,V=L+k;return M.slice(L,V).map(U)})();F&&F.push(...L);try{j=await wF(L)}catch(L){if(G+=k,B++,!(G>=M.length))return void await l();V(L)}L.forEach(L=>L.cancel())};return await l(),j},NF=async L=>{let{referenceList:k,asyncMapHandler:M,closeFn:U}=L,V=k.length,F=0,s=async()=>{let L=M(k.shift());try{return await L}catch(L){if(++F>=V||null!=U&&U(L))throw L;return s()}};return s()};async function DF(){let L;if("undefined"==typeof VideoDecoder)return!0;let k=[18,0,10,13,0,0,0,3,180,253,144,6,136,8,8,8,32,50,85,16,66,128,2,8,32,132,0,8,0,180,90,204,169,166,242,109,241,190,143,149,160,133,4,144,43,122,168,159,120,159,205,39,82,131,57,52,87,187,68,23,248,134,204,226,97,17,49,183,55,236,219,249,221,98,208,215,190,59,179,167,213,47,1,246,150,14,194,245,159,83,35,64,103,218,38,21,82,3,135,21,185,84,248,134],M=[18,0,10,13,0,0,0,3,180,253,144,6,136,8,8,8,32,50,87,16,66,128,2,8,32,132,0,8,0,180,90,204,169,166,242,109,241,190,143,148,62,134,140,92,172,141,77,35,94,181,164,65,169,65,156,154,43,221,162,11,252,67,102,113,48,136,137,219,62,43,113,239,23,126,250,186,252,10,138,218,25,193,244,74,68,194,209,107,23,52,206,199,78,72,98,103,151,71,96,62,51,210,158,72,231,158],U=[18,0,10,13,0,0,0,3,180,253,144,6,136,8,8,8,32,50,87,16,66,128,2,8,32,132,0,8,0,180,90,204,169,166,242,109,241,190,143,143,233,163,51,196,98,95,151,224,22,134,33,240,150,248,67,18,34,196,142,81,238,173,140,80,205,232,132,144,67,12,131,157,4,171,243,86,122,35,6,166,184,243,85,126,13,206,103,152,62,168,160,187,2,241,138,52,211,72,121,128,151,63,147,128,19,42],V=[18,0,50,138,1,48,192,64,253,248,65,17,67,192,32,0,16,0,0,0,0,0,0,0,195,12,48,144,64,32,0,209,75,61,9,204,25,115,79,226,115,63,63,208,70,210,220,153,126,241,237,37,107,195,153,1,99,112,230,189,209,169,130,10,11,22,167,215,159,205,197,7,183,162,26,48,254,141,134,103,32,16,235,45,1,15,18,119,169,110,206,251,51,115,202,60,148,1,46,39,109,25,28,86,168,15,77,211,239,2,58,43,146,26,230,184,81,48,140,226,226,250,222,146,171,133,164,13,188,180,64,122,142,146,32,208,238,170,193,35,53,44,225],F=[18,0,50,107,48,0,133,125,248,65,26,195,64,62,32,31,16,0,0,0,0,0,1,4,16,64,144,64,32,0,204,24,122,65,56,165,18,52,206,218,4,187,51,97,9,29,191,90,253,106,185,31,197,155,52,205,245,185,203,131,20,226,25,124,95,113,220,113,141,15,15,104,211,144,152,237,150,157,127,51,143,24,231,218,171,255,176,241,128,229,149,150,148,66,245,228,91,27,182,228,136,61,182,237,133,45,220,24,103,214,152],B=[18,0,50,122,48,1,9,253,248,65,26,67,64,62,32,31,16,0,0,0,0,0,1,4,16,64,144,64,32,0,198,182,231,242,220,235,163,140,12,36,36,166,46,132,210,4,71,23,218,132,27,30,17,45,244,79,31,243,195,136,100,169,76,88,142,85,204,217,121,168,29,163,198,17,251,223,73,12,212,244,139,123,151,179,75,216,96,208,136,40,229,42,59,149,10,116,228,85,99,93,221,108,255,140,248,20,30,167,122,109,206,164,108,197,110,251,23,243,133,160,63,13,207,177,12,128],j=await new lQ((j,G)=>{let X;(async function(){L&&"closed"!==L.state||await async function(){L=new VideoDecoder({output:L=>{L.close(),clearTimeout(X),j(!0)},error:L=>{clearTimeout(X),j(!1)}}),await L.configure({codec:"av01.0.05M.08",width:160,height:90})}();let G=[k,M,U,V,F,B];for(let k=0;k<G.length;k++){let M=new EncodedVideoChunk({type:0==k?"key":"delta",timestamp:33333*k,duration:33333,data:new Uint8Array(G[k])});try{await L.decode(M)}catch(L){return void j(!1)}}})(),X=setTimeout(()=>{j(!1)},5e3)});return j}async function PF(L,k,M,U){let V=async function(L,k,M,U){let V=null,F=[],s=async()=>{let V=wN("WEBCS_DOMAIN").slice(0,wN("AJAX_REQUEST_CONCURRENT")).map(k=>({url:L.proxyServer?"https://".concat(L.proxyServer,"/ap/?url=").concat(k+"/api/v2/transpond/webrtc?v=2"):"https://".concat(k,"/api/v2/transpond/webrtc?v=2"),areaCode:sF()})),B=U.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:V.map(L=>L.url)}),j=await OF({fragementLength:wN("FRAGEMENT_LENGTH"),referenceList:V,asyncMapHandler:U=>(gc.debug("[".concat(L.clientId,"] Connect to choose_server:"),U.url),TF(U,L,k,M)),allFailedhandler:L=>{throw U.recordJoinChannelService({endTs:Date.now(),status:"error",errors:L},B),L[0]},promisesCollector:F});return U.recordJoinChannelService({endTs:Date.now(),status:"success"},B),j},a=async()=>{if(await yO(1e3),null!==V)return V;let B=wN("WEBCS_DOMAIN_BACKUP_LIST").map(k=>({url:L.proxyServer?"https://".concat(L.proxyServer,"/ap/?url=").concat(k+"/api/v2/transpond/webrtc?v=2"):"https://".concat(k,"/api/v2/transpond/webrtc?v=2"),areaCode:sF()})),j=U.recordJoinChannelService({endTs:void 0,startTs:Date.now(),status:"pending",service:"chooseServer",urls:B.map(L=>L.url)}),G=await OF({fragementLength:wN("FRAGEMENT_LENGTH"),referenceList:B,asyncMapHandler:U=>(gc.debug("[".concat(L.clientId,"] Connect to backup choose_server:"),U.url),TF(U,L,k,M)),allFailedhandler:L=>{throw U.recordJoinChannelService({endTs:Date.now(),status:"error",errors:L},j),L[0]},promisesCollector:F});return U.recordJoinChannelService({endTs:Date.now(),status:"success"},j),G};try{return V=await wF([s(),a()]),F.length&&F.forEach(L=>L.cancel&&"function"==typeof L.cancel&&L.cancel()),V}catch(L){throw L[0]}}(L,k,M,U);return{gatewayInfo:await V}}async function LF(L,k,M,U,V){var F,B;let j=L.cloudProxyServer;if("disabled"===j){if(!U)return;if(L.useLocalAccessPoint)return await PF(L,k,M,V);if(wN("JOIN_WITH_FALLBACK_MEDIA_PROXY")){let{gatewayInfo:U,proxyInfo:B}=await xF(L,k,M,V);if(L.turnServer&&"auto"!==L.turnServer.mode)return{gatewayInfo:U};let j=B.map(L=>({turnServerURL:L.address,tcpport:L.tcpport||SZ.tcpport,udpport:L.udpport||SZ.udpport,username:L.username||SZ.username,password:L.password||SZ.password,forceturn:!1,security:!0}));if(V.useP2P){let k=null!==(F=L.uid)&&void 0!==F?F:U.uid,M="glb:".concat(k.toString()),V=await Ww(M),G=B.map(L=>({turnServerURL:L.address,tcpport:L.tcpport||SZ.tcpport,udpport:L.udpport||SZ.udpport,username:M,password:V,forceturn:!1,security:!0}));j.push(...G)}return L.turnServer={mode:"manual",servers:j},{gatewayInfo:U}}return await PF(L,k,M,V)}let{proxyInfo:G,gatewayInfo:X}=await xF(L,k,M,V),$=G.map(L=>({turnServerURL:L.address,tcpport:"proxy3"===j?void 0:L.tcpport?L.tcpport:SZ.tcpport,udpport:"proxy4"===j?void 0:L.udpport?L.udpport:SZ.udpport,username:L.username||SZ.username,password:L.password||SZ.password,forceturn:"proxy4"!==j,security:"proxy5"===j}));if(V.useP2P){let k=null!==(B=L.uid)&&void 0!==B?B:X.uid,M="glb:".concat(k.toString()),U=await Ww(M),V=G.map(L=>({turnServerURL:L.address,tcpport:"proxy3"===j?void 0:L.tcpport||SZ.tcpport,udpport:"proxy4"===j?void 0:L.udpport||SZ.udpport,username:M,password:U,forceturn:"proxy4"!==j,security:"proxy5"===j}));$.push(...V)}return L.turnServer={mode:"manual",servers:$},gc.debug("[".concat(L.clientId,"] set proxy server: ").concat(L.proxyServer,", mode: ").concat(j)),{gatewayInfo:X}}async function kF(L,k,M,U,V){let F=wN("ACCOUNT_REGISTER").slice(0,wN("AJAX_REQUEST_CONCURRENT")),B=[];B=k.proxyServer?F.map(L=>"https://".concat(k.proxyServer,"/ap/?url=").concat(L+"/api/v1")):F.map(L=>"https://".concat(L,"/api/v1"));let j=null==V?void 0:V.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"stringUID",urls:B});try{let F=await async function(L,k,M,U,V){let F=Date.now(),B={sid:M.sid,opid:10,appid:M.appId,string_uid:k},j=L[0],G=await GO(()=>oF(j+"".concat(-1===j.indexOf("?")?"?":"&","action=stringuid"),{data:B,cancelToken:U,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":72}}),(M,U)=>{if(0===M.code){if(M.uid<=0||M.uid>=4294967296)throw gc.error("Invalid Uint Uid ".concat(k," => ").concat(M.uid),M),g_.reqUserAccount(B.sid,{lts:F,success:!1,serverAddr:j,stringUid:B.string_uid,uid:M.uid,errorCode:f1.INVALID_UINT_UID_FROM_STRING_UID,extend:B}),new ED(f1.INVALID_UINT_UID_FROM_STRING_UID);return g_.reqUserAccount(B.sid,{lts:F,success:!0,serverAddr:j,stringUid:B.string_uid,uid:M.uid,errorCode:null,extend:B}),!1}let V=MV(M.code);return V.retry&&(j=L[(U+1)%L.length]),g_.reqUserAccount(B.sid,{lts:F,success:!1,serverAddr:j,stringUid:B.string_uid,uid:M.uid,errorCode:V.desc,extend:B}),V.retry},(k,M)=>k.code!==f1.OPERATION_ABORTED&&(g_.reqUserAccount(B.sid,{lts:F,success:!1,serverAddr:j,stringUid:B.string_uid,uid:null,errorCode:k.code,extend:B}),j=L[(M+1)%L.length],!0),V);if(0!==G.code){let L=MV(G.code);throw new ED(f1.UNEXPECTED_RESPONSE,L.desc)}return G}(B,L,k,M,U);return null==V||V.recordJoinChannelService({status:"success",endTs:Date.now()},j),F.uid}catch(L){throw null==V||V.recordJoinChannelService({status:"error",endTs:Date.now(),errors:[L]},j),L}}async function MF(L,k,M){let U=wN("ACCOUNT_REGISTER"),V=[];V=k.proxyServer?U.map(L=>"https://".concat(k.proxyServer,"/ap/?url=").concat(L+"/api/v1")):U.map(L=>"https://".concat(L,"/api/v1"));try{let U=await NF({referenceList:V,asyncMapHandler:U=>(async function(L,k,M,U){let V=Date.now(),F={sid:M.sid,opid:10,appid:M.appId,string_uid:k};try{let k=await oF(L+"".concat(-1===L.indexOf("?")?"?":"&","action=stringuid"),{data:F,cancelToken:U,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":72}});if(0!==k.code){let L=MV(k.code);throw new ED(f1.UNEXPECTED_RESPONSE,"preload sua error:".concat(L.desc),L)}if(k.uid<=0||k.uid>=4294967296)throw new ED(f1.INVALID_UINT_UID_FROM_STRING_UID);return{requestTime:V,url:L,req:F,uid:k.uid,elapse:Date.now()-V}}catch(L){throw L}})(U,L,k,M),closeFn:L=>L.code===f1.OPERATION_ABORTED||L.code===f1.UNEXPECTED_RESPONSE&&!L.data.retry});return U}catch(L){throw L}}async function UF(L,k,M){let U=wN("CDS_AP").slice(0,wN("AJAX_REQUEST_CONCURRENT")).map(k=>L.proxyServer?"https://".concat(L.proxyServer,"/ap/?url=").concat(k+"/api/v1"):"https://".concat(k,"/api/v1?action=config")),V=U.map(U=>(function(L,k,M,U){let V=zA(),F={flag:64,cipher_method:0,features:mF(mF(mF(mF(mF({install_id:fN(),device:V.name,system:V.os,system_general:navigator.userAgent,vendor:k.appId,version:SJ,cname:k.cname,session_id:k.sid,proxyServer:k.proxyServer,sdk_type:IR.WEB_RTC,browser_name:V.name,browser_version:V.version,user_agent:navigator.userAgent,channel_name:k.cname},k.stringUid&&{string_uid:k.stringUid}),k.uid&&{uid:k.uid+""}),V.os&&{os_name:V.os}),V.osVersion&&{os_version:V.osVersion}),{},{detail:""})};return GO(()=>oF(L,{data:F,timeout:1e3,cancelToken:M,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":54}}),void 0,L=>L.code!==f1.OPERATION_ABORTED,U)})(U,L,k,M)),F=null,B=null,j={};try{F=await wF(V)}catch(L){if(L.code===f1.OPERATION_ABORTED)throw L;B=L}if(V.forEach(L=>L.cancel()),g_.reportApiInvoke(L.sid,{name:f8.REQUEST_CONFIG_DISTRIBUTE,options:{error:B,res:F}}).onSuccess(),F&&F.test_tags)try{j=function(L){if(!L.test_tags)return{};let k=L.test_tags,M=Object.keys(k),U={};return M.forEach(L=>{var M;let V=_p(M=L.slice(4)).call(M),F=JSON.parse(k[L]),B=F[1];U[V]={tag:F[0]||"",value:B}}),U}(F)}catch(L){}return j}async function VF(L,k){let M=wN("WEBCS_DOMAIN").concat(wN("WEBCS_DOMAIN_BACKUP_LIST")).map(L=>({url:"https://".concat(L,"/api/v2/transpond/webrtc?v=2"),areaCode:sF(),serviceIds:[II.CHOOSE_SERVER,II.CLOUD_PROXY_FALLBACK]}));try{let U=await NF({referenceList:M,asyncMapHandler:M=>(async function(L,k,M){let U,{url:V,areaCode:F,serviceIds:B}=L,j=Date.now(),[G,X]=IF(k,F,B),$=Ss.networkState;try{$&&Ss.networkState===Sa.OFFLINE&&Ss.onlineWaiter&&await lQ.race([Ss.onlineWaiter,yO(Sm.maxRetryTimeout)]),$=Ss.networkState;let{data:L,headers:k}=await oF(V,{data:G,cancelToken:M,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);U="1"===k.http3?1:-1,(L=>{let k=[];if(L.response_body.forEach(M=>{let U=M.buffer.code;if(23===M.uri&&0===U&&!M.buffer.edges_services){if(4194310===M.buffer.flag)M.buffer.edges_services=[];else{let U={error:new ED(f1.CAN_NOT_GET_GATEWAY_SERVER,"no edge services in ap response",{retry:!0,csIp:L.detail[502]}),flag:M.buffer.flag};k.push(U)}}if(0!==U){let V=MV(U),F={error:new ED(f1.CAN_NOT_GET_GATEWAY_SERVER,V.desc,{desc:V.desc,retry:V.retry,csIp:L.detail[502]}),flag:M.buffer.flag};4194310===M.buffer.flag?gc.warning(F.error.toString()):k.push(F)}}),k.length)throw new ED(f1.CAN_NOT_GET_GATEWAY_SERVER,k.map(L=>"flag: ".concat(L.flag,", message: ").concat(L.error.message)).join(" | "),{retry:!!k.find(L=>L.error.data.retry),csIp:L.detail[502],desc:[...new Set(k.map(L=>{var k;return null==L||null===(k=L.error)||void 0===k||null===(k=k.data)||void 0===k?void 0:k.desc}).filter(L=>!!L))]})})(L);let F=cx(L,II.CHOOSE_SERVER),B=cx(L,II.CLOUD_PROXY_FALLBACK);return CF(F),{gatewayInfo:rx(F,V),proxyInfo:B,opid:X,requestTime:j,url:V,isHttp3:U,elapse:Date.now()-j}}catch(L){throw L}})(M,L,k),closeFn:L=>L.code===f1.OPERATION_ABORTED||L.code===f1.CAN_NOT_GET_GATEWAY_SERVER&&!L.data.retry});return U}catch(L){throw L}}async function xF(L,k,M,U){let V,F,B;let j=wN("PROXY_SERVER_TYPE3"),o=(L,k,M)=>{let U=M||j;return Array.isArray(U)&&(U=k%2==0&&j[1]||j[0]),"https://".concat(U,"/ap/?url=").concat(L)},G=null,X=[],c=async()=>{let V=wN("WEBCS_DOMAIN").slice(0,wN("AJAX_REQUEST_CONCURRENT")).map((k,M)=>({url:"disabled"===L.cloudProxyServer&&L.proxyServer?o("".concat(k,"/api/v2/transpond/webrtc?v=2"),M,L.proxyServer):"disabled"===L.cloudProxyServer||"fallback"===L.cloudProxyServer?"https://".concat(k,"/api/v2/transpond/webrtc?v=2"):o("".concat(k,"/api/v2/transpond/webrtc?v=2"),M),areaCode:sF(),serviceIds:[II.CHOOSE_SERVER,"proxy5"===L.cloudProxyServer?II.CLOUD_PROXY_5:"proxy3"===L.cloudProxyServer||"proxy4"===L.cloudProxyServer?II.CLOUD_PROXY:II.CLOUD_PROXY_FALLBACK]})),F=U.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:V.map(L=>L.url)}),B=await OF({fragementLength:wN("FRAGEMENT_LENGTH"),referenceList:V,asyncMapHandler:U=>(gc.debug("[".concat(L.clientId,"] Connect to choose_server:"),U.url),RF(U,L,k,M)),allFailedhandler:L=>{throw U.recordJoinChannelService({endTs:Date.now(),status:"error",errors:L},F),L[0]},promisesCollector:X});return U.recordJoinChannelService({endTs:Date.now(),status:"success"},F),B},d=async()=>{if(await yO(1e3),null!==G)return G;let V=wN("WEBCS_DOMAIN_BACKUP_LIST").map((k,M)=>({url:"disabled"===L.cloudProxyServer&&L.proxyServer?o("".concat(k,"/api/v2/transpond/webrtc?v=2"),M,L.proxyServer):"disabled"===L.cloudProxyServer||"fallback"===L.cloudProxyServer?"https://".concat(k,"/api/v2/transpond/webrtc?v=2"):o("".concat(k,"/api/v2/transpond/webrtc?v=2"),M),areaCode:sF(),serviceIds:[II.CHOOSE_SERVER,"proxy5"===L.cloudProxyServer?II.CLOUD_PROXY_5:"proxy3"===L.cloudProxyServer||"proxy4"===L.cloudProxyServer?II.CLOUD_PROXY:II.CLOUD_PROXY_FALLBACK]})),F=U.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:V.map(L=>L.url)}),B=await OF({fragementLength:wN("FRAGEMENT_LENGTH"),referenceList:V,asyncMapHandler:U=>(gc.debug("[".concat(L.clientId,"] Connect to backup choose_server:"),U.url),RF(U,L,k,M)),allFailedhandler:L=>{throw U.recordJoinChannelService({endTs:Date.now(),status:"error",errors:L},F),L[0]},promisesCollector:X});return U.recordJoinChannelService({endTs:Date.now(),status:"success"},F),B};try{({gatewayInfo:V,proxyInfo:F,url:B}=await wF([c(),d()]))}catch(L){throw L[0]}if(X.length&&X.forEach(L=>L.cancel&&"function"==typeof L.cancel&&L.cancel()),!V||!F)throw new ED(f1.UNEXPECTED_ERROR,"missing gateway or proxy response").print();if(L.apUrl=B,"disabled"!==L.cloudProxyServer&&Array.isArray(j)&&B){let k=/^https?:\/\/(.+?)(\/.*)?$/.exec(B)[1];so(j).call(j,k)&&(L.proxyServer=k,gc.setProxyServer(k),g_.setProxyServer(k))}return G={gatewayInfo:V,proxyInfo:await dx(F,V.uid)}}async function FF(L,k,M){let U=wN("UAP_AP").slice(0,wN("AJAX_REQUEST_CONCURRENT")).map(k=>L.proxyServer?"https://".concat(L.proxyServer,"/ap/?url=").concat(k+"/api/v1?action=uap"):"https://".concat(k,"/api/v1?action=uap")),V=U.map(U=>(function(L,k,M,U){let V={command:"convergeAllocateEdge",sid:k.sid,appId:k.appId,token:k.token,ts:Date.now(),version:SJ,cname:k.cname,uid:k.uid.toString(),requestId:IU,seq:IU};IU+=1;let F={service_name:"tele_channel",json_body:JSON.stringify(V)};return GO(async()=>{let k=await oF(L,{data:F,cancelToken:M,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":61}});if(0!==k.code){let L=new ED(f1.UNEXPECTED_RESPONSE,"cross channel ap error, code"+k.code,{retry:!0});throw gc.error(L.toString()),L}let U=JSON.parse(k.json_body);if(200!==U.code){let L=new ED(f1.UNEXPECTED_RESPONSE,"cross channel app center error, code: ".concat(U.code,", reason: ").concat(U.reason));throw gc.error(L.toString()),L}if(!U.servers||0===U.servers.length){let L=new ED(f1.UNEXPECTED_RESPONSE,"cross channel app center empty server");throw gc.error(L.toString()),L}return{vid:U.vid,workerToken:U.workerToken,addressList:(wN("CHANNEL_MEDIA_RELAY_SERVERS")||U.servers).map(L=>"wss://".concat(L.address.replace(/\./g,"-"),".").concat(wN("WORKER_DOMAIN"),":").concat(L.wss))}},void 0,L=>!!(L.code!==f1.OPERATION_ABORTED&&L.code!==f1.UNEXPECTED_RESPONSE||L.data&&L.data.retry),U)})(U,L,k,M));try{let L=await wF(V);return V.forEach(L=>L.cancel()),L}catch(L){throw L[0]}}async function BF(L,k,M){let U=null,V=[],o=async F=>{let B=wN(F?"WEBCS_DOMAIN_BACKUP_LIST":"WEBCS_DOMAIN").map(k=>L.proxyServer?"https://".concat(L.proxyServer,"/ap/?url=").concat(k+"/api/v2/transpond/webrtc?v=2"):"https://".concat(k,"/api/v2/transpond/webrtc?v=2"));return F&&(await yO(1e3),null!==U)?U:await OF({fragementLength:wN("FRAGEMENT_LENGTH"),referenceList:B,asyncMapHandler:U=>(gc.debug("[".concat(L.clientId,"] update ticket, Connect to ").concat(F?"backup":""," choose_server:"),U),function(L,k,M,U){let[V]=bF(k,[II.CHOOSE_SERVER]),F=Ss.networkState;return GO(async()=>{F&&Ss.networkState===Sa.OFFLINE&&Ss.onlineWaiter&&await lQ.race([Ss.onlineWaiter,yO(U&&U.maxRetryTimeout||Sm.maxRetryTimeout)]),F=Ss.networkState;let k=await oF(L,{data:V,cancelToken:M,headers:{"Content-Type":"multipart/form-data;"}},!0);return yF(k,L)},()=>!1,L=>L.code!==f1.OPERATION_ABORTED&&(L.code===f1.UPDATE_TICKET_FAILED?L.data.retry:(gc.warning("[".concat(k.clientId,"] update ticket network error, retry"),L),!0)),U)}(U,L,k,M)),allFailedhandler:L=>{throw L[0]},promisesCollector:V})};try{return U=await wF([o(!1),o(!0)]),V.length&&V.forEach(L=>L.cancel&&"function"==typeof L.cancel&&L.cancel()),U}catch(L){throw L[0]}}function jF(L,k){var M=Object.keys(L);if(Object.getOwnPropertySymbols){var U=Object.getOwnPropertySymbols(L);k&&(U=U.filter(function(k){return Object.getOwnPropertyDescriptor(L,k).enumerable})),M.push.apply(M,U)}return M}function GF(L){for(var k=1;k<arguments.length;k++){var M=null!=arguments[k]?arguments[k]:{};k%2?jF(Object(M),!0).forEach(function(k){uI(L,k,M[k])}):Object.getOwnPropertyDescriptors?Object.defineProperties(L,Object.getOwnPropertyDescriptors(M)):jF(Object(M)).forEach(function(k){Object.defineProperty(L,k,Object.getOwnPropertyDescriptor(M,k))})}return L}let WF=class WF extends Hw{get isSuccess(){return!!this.configs}constructor(L,k){super(),uI(this,"configs",void 0),uI(this,"store",void 0),uI(this,"joinInfo",void 0),uI(this,"cancelToken",void 0),uI(this,"retryConfig",{timeout:3e3,timeoutFactor:1.5,maxRetryCount:1,maxRetryTimeout:1e4}),uI(this,"interval",void 0),uI(this,"mutex",void 0),uI(this,"mutableParamsRead",!1),uI(this,"configCache",{}),uI(this,"limit_bitrate",void 0),this.mutex=new S_("config-distribute",L),this.store=k}startGetConfigDistribute(L,k){this.joinInfo=L,this.cancelToken=k,this.interval&&this.stopGetConfigDistribute(),wN("ENABLE_CONFIG_DISTRIBUTE")&&(this.updateConfigDistribute(),this.interval=window.setInterval(()=>{this.updateConfigDistribute()},wN("CONFIG_DISTRIBUTE_INTERVAL")))}stopGetConfigDistribute(){this.interval&&clearInterval(this.interval),this.interval=void 0,this.joinInfo=void 0,this.cancelToken=void 0,this.configs=void 0,this.limit_bitrate=void 0}async awaitConfigDistributeComplete(){this.mutex.isLocked&&(await this.mutex.lock())()}async updateConfigDistribute(){let L;if(this.mutableParamsRead||(this.mutableParamsRead=!0,g_.reportApiInvoke(null,{options:void 0,name:f8.LOAD_CONFIG_FROM_LOCALSTORAGE,tag:f9.TRACER}).onSuccess(JSON.stringify(S4))),!this.joinInfo||!this.cancelToken||!this.retryConfig)return void gc.debug("[config-distribute] get config distribute interrupted have no joininfo");let k=await this.mutex.lock();try{L=await UF(this.joinInfo,this.cancelToken,this.retryConfig),gc.debug("[config-distribute] get config distribute",JSON.stringify(L));let k=function(L){var k;let M=uu(k=Object.keys(L).filter(L=>/^webrtc_ng_global_parameter/.test(L))).call(k);for(let k=0;k<M.length;k++)for(let U=M.length-1;U>k;U--){let k=M[U],V=L[k].value;if("number"==typeof V.__priority){let F=V.__priority,B=M[U-1],j=L[B].value;if("number"==typeof j.__priority){if(!(F>j.__priority))continue;M[U]=M[U-1],M[U-1]=k}else M[U]=M[U-1],M[U-1]=k}}let U=Date.now(),V={};return M.forEach(k=>{let M=L[k].value.__expires;M&&M<=U||(V[k]=L[k])}),V}(L);this.cacheGlobalParameterConfig(k),this.store.hasStartJoinChannel||(this.store.isABTestSuccess=!0),this.configs=k}catch(k){let L=new ED(f1.NETWORK_RESPONSE_ERROR,k);gc.warning("[config-distribute] ".concat(L.toString()))}finally{k()}}getBitrateLimit(){return this.limit_bitrate||void 0}handleBitrateLimit(L){hV(L)&&(this.limit_bitrate?this.limit_bitrate&&this.limit_bitrate.id!==L.id&&this.emit(R0.UPDATE_BITRATE_LIMIT,L):this.emit(R0.UPDATE_BITRATE_LIMIT,L))}getLowStreamConfigDistribute(){return this.limit_bitrate&&GF({},this.limit_bitrate.low_stream_uplink)}handleABTestConfigDistribute(L){try{let k={},M=Object.keys(L),U=[];M.forEach(M=>{let V=L[M].value;k[M]=V;let F=V.__id;if(F&&this.configCache[M]&&this.configCache[M].__id===F)return;let B=V.__type,j=L[M].value,G=L[M].tag,X=0;B?B===S5.REALTIME&&(X=1):Object.keys(j).some(L=>Object.prototype.hasOwnProperty.call(S2,L)||!YM()&&Object.prototype.hasOwnProperty.call(S$,L)?(X=1,!0):void 0),U.push({tag:G,isApplied:X,feature:M,params:JSON.stringify(V)})}),U.forEach(L=>{let{tag:k,feature:M,params:U,isApplied:V}=L;this.store.sessionId&&g_.abTest(this.store.sessionId,{intSucc:1,isApplied:V,tag:k,feature:M,params:U,cid:this.store.cid,uid:this.store.intUid})}),this.configCache=k}catch(L){gc.debug("handleABTestConfigDistribute error",L)}}cacheGlobalParameterConfig(L){let k=function(L){let k={};return Object.keys(L).forEach(M=>{let U=L[M].value,V=U.__expires,F=U.__type;Object.keys(U).forEach(L=>{"__id"===L||"__type"===L||"__priority"===L||"__expires"===L||Object.prototype.hasOwnProperty.call(k,L)||(k[L]=GF(GF({value:U[L]},V&&{expires:V}),F&&{type:F}))})}),k}(L);try{var M;let U=null===(M=k.LIMIT_BITRATE)||void 0===M?void 0:M.value;delete k.LIMIT_BITRATE,U&&hV(U)&&this.handleBitrateLimit(U),this.limit_bitrate=U,this.handleGlobalParameterConfig(k),this.handleABTestConfigDistribute(L),function(L){try{let k=Date.now();Object.keys(L).forEach(M=>{let{value:U,type:V,expires:F}=L[M];F&&F<=k||((V===S5.REALTIME||Object.prototype.hasOwnProperty.call(S2,M))&&(S4[M]=U,S3[M]=U,gc.debug("Update realtime parameters from config distribute",M,U)),V||YM()||!Object.prototype.hasOwnProperty.call(S$,M)||(S4[M]=U,S3[M]=U,gc.debug("Update gateway parameters from config distribute",M,U)))})}catch(k){gc.error("Error update config immediately: ".concat(L),k.message)}}(k);let V=JSON.stringify(k),F=window.btoa(V);window.localStorage.setItem("websdk_ng_global_parameter",F),gc.debug("Caching global parameters ".concat(V))}catch(L){gc.error("Error caching global parameters:",L.message)}}handleGlobalParameterConfig(L){try{let k=Date.now();Object.keys(L).forEach(M=>{if("CLIENT_ROLE_OPTIONS"===M&&Object.prototype.hasOwnProperty.call(S3,M)){let{value:U,expires:V}=L[M];V&&V<=k||function(L,k){try{return"object"==typeof L&&"object"==typeof k&&JSON.stringify(L)===JSON.stringify(k)}catch(L){return!1}}(S3[M],U)||(S4[M]=U,S3[M]=U,this.emit(R0.UPDATE_CLIENT_ROLE_OPTIONS,U),gc.debug("Updating client role options: ".concat(JSON.stringify(U))))}})}catch(L){gc.error("Error handling global parameter config:",L.message)}}};let HF=class HF extends Hw{constructor(){super(...arguments),uI(this,"resultStorage",new Map)}setLocalAudioStats(L,k,M){this.record("AUDIO_INPUT_LEVEL_TOO_LOW",L,this.checkAudioInputLevel(M,k)),this.record("SEND_AUDIO_BITRATE_TOO_LOW",L,this.checkSendAudioBitrate(M,k))}setLocalVideoStats(L,k,M){this.record("SEND_VIDEO_BITRATE_TOO_LOW",L,this.checkSendVideoBitrate(M,k)),this.record("FRAMERATE_INPUT_TOO_LOW",L,this.checkFramerateInput(M,k)),this.record("FRAMERATE_SENT_TOO_LOW",L,this.checkFramerateSent(M)),k.muted||this.record("VIDEO_ENCODE_FAILED",L,this.checResolutionSent(M))}setRemoteAudioStats(L,k){let M=L.getUserId();this.record("AUDIO_OUTPUT_LEVEL_TOO_LOW",M,this.checkAudioOutputLevel(k))}setRemoteVideoStats(L,k){let M=L.getUserId();this.record("RECV_VIDEO_DECODE_FAILED",M,this.checkVideoDecode(k))}record(L,k,M){if(wN("STATS_UPDATE_INTERVAL")>500)return;this.resultStorage.has(L)||this.resultStorage.set(L,{result:[],isPrevNormal:!0});let U=this.resultStorage.get(L);if(!U)return;U.result.push(M);let V="VIDEO_ENCODE_FAILED"===L?wN("ENCODE_EXCEPTION_TIMES"):5;if(U.result.length>=V){var F;let M=so(F=U.result).call(F,!0);U.isPrevNormal&&!M&&this.emit("exception",Ij[L],L,k),!U.isPrevNormal&&M&&this.emit("exception",Ij[L]+2e3,L+"_RECOVER",k),U.isPrevNormal=M,U.result=[]}}checkAudioOutputLevel(L){return!(L.receiveBitrate>0&&0===L.receiveLevel)}checkAudioInputLevel(L,k){return k instanceof WL&&!k.isActive||!!k.muted||0!==L.sendVolumeLevel}checkFramerateInput(L,k){let M=null;k._encoderConfig&&k._encoderConfig.frameRate&&(M=ox(k._encoderConfig.frameRate));let U=L.captureFrameRate;return!M||!U||!(M>10&&U<5||M<10&&M>=5&&U<=1)}checkFramerateSent(L){return!(L.captureFrameRate&&L.sendFrameRate&&L.captureFrameRate>5&&L.sendFrameRate<=1)}checResolutionSent(L){var k;return!(!L.codecType||so(k=wN("ENCODE_EXCEPTION_VALIDATE_CODEC")).call(k,L.codecType.toLocaleLowerCase()))||!L.captureFrameRate||0!==L.sendFrameRate||0!==L.sendResolutionWidth||0!==L.sendResolutionHeight}checkSendVideoBitrate(L,k){return!!k.muted||0!==L.sendBitrate}checkSendAudioBitrate(L,k){return k instanceof WL&&!k.isActive||!!k.muted||0!==L.sendBitrate}checkVideoDecode(L){return 0===L.receiveBitrate||0!==L.decodeFrameRate}};let Ij={FRAMERATE_INPUT_TOO_LOW:1001,FRAMERATE_SENT_TOO_LOW:1002,SEND_VIDEO_BITRATE_TOO_LOW:1003,RECV_VIDEO_DECODE_FAILED:1005,AUDIO_INPUT_LEVEL_TOO_LOW:2001,AUDIO_OUTPUT_LEVEL_TOO_LOW:2002,SEND_AUDIO_BITRATE_TOO_LOW:2003,VIDEO_ENCODE_FAILED:2004},IW=new class{markSubscribeStart(L,k){performance.mark("agora-web-sdk/".concat(L,"/subscribe-").concat(k))}markPublishStart(L,k){performance.mark("agora-web-sdk/".concat(L,"/publish-").concat(k))}measureFromSubscribeStart(L,k){let M=performance.getEntriesByName("agora-web-sdk/".concat(L,"/subscribe-").concat(k));if(M.length>0){let L=M[M.length-1];return Math.round(performance.now()-L.startTime)}return 0}measureFromPublishStart(L,k){let M=performance.getEntriesByName("agora-web-sdk/".concat(L,"/publish-").concat(k));if(M.length>0){let L=M[M.length-1];return Math.round(performance.now()-L.startTime)}return 0}};function zF(L,k){var M=Object.keys(L);if(Object.getOwnPropertySymbols){var U=Object.getOwnPropertySymbols(L);k&&(U=U.filter(function(k){return Object.getOwnPropertyDescriptor(L,k).enumerable})),M.push.apply(M,U)}return M}function qF(L){for(var k=1;k<arguments.length;k++){var M=null!=arguments[k]?arguments[k]:{};k%2?zF(Object(M),!0).forEach(function(k){uI(L,k,M[k])}):Object.getOwnPropertyDescriptors?Object.defineProperties(L,Object.getOwnPropertyDescriptors(M)):zF(Object(M)).forEach(function(k){Object.defineProperty(L,k,Object.getOwnPropertyDescriptor(M,k))})}return L}let XF=class XF{constructor(L){uI(this,"store",void 0),uI(this,"onStatsException",void 0),uI(this,"onUploadPublishDuration",void 0),uI(this,"onStatsChanged",void 0),uI(this,"onVideoCodecChanged",void 0),uI(this,"localStats",new Map),uI(this,"remoteStats",new Map),uI(this,"updateStatsInterval",void 0),uI(this,"trafficStats",void 0),uI(this,"trafficStatsPeerList",[]),uI(this,"uplinkStats",void 0),uI(this,"exceptionMonitor",void 0),uI(this,"p2pChannel",void 0),uI(this,"scalabilityMode",Sj.L1T1),uI(this,"updateStats",()=>{this.p2pChannel&&(this.updateRemoteStats(this.p2pChannel),this.updateLocalStats(this.p2pChannel))}),this.store=L,this.exceptionMonitor=new HF,this.exceptionMonitor.on("exception",(L,k,M)=>{this.onStatsException&&this.onStatsException(L,k,M)})}startUpdateStats(){this.updateStatsInterval||(this.updateStatsInterval=window.setInterval(this.updateStats,1e3))}stopUpdateStats(){this.updateStatsInterval&&(window.clearInterval(this.updateStatsInterval),this.updateStatsInterval=void 0)}reset(){this.localStats=new Map,this.remoteStats=new Map,this.trafficStats=void 0,this.trafficStatsPeerList=[],this.uplinkStats=void 0}getLocalAudioTrackStats(){return this.localStats.get(R4.LocalAudioTrack)||qF({},gH)}getLocalVideoTrackStats(){return this.localStats.get(R4.LocalVideoTrack)||qF({},gK)}getRemoteAudioTrackStats(L){let t=(L,k)=>{if(!this.trafficStats)return k;let M=this.trafficStats.peer_delay.find(k=>k.peer_uid===L);return M&&(k.publishDuration=M.B_ppad+(Date.now()-this.trafficStats.timestamp)),k},k={};if(L){var M;let U=null===(M=this.remoteStats.get(L))||void 0===M?void 0:M.audioStats;U&&(k[L]=t(L,U))}else Array.from(this.remoteStats.entries()).forEach(L=>{let[M,{audioStats:U}]=L;U&&(k[M]=t(M,U))});return k}getRemoteNetworkQualityStats(L){let k={};if(L){var M;let U=null===(M=this.remoteStats.get(L))||void 0===M?void 0:M.networkStats;U&&(k[L]=U)}else Array.from(this.remoteStats.entries()).forEach(L=>{let[M,{networkStats:U}]=L;U&&(k[M]=U)});return k}getRemoteVideoTrackStats(L){let t=(L,k)=>{if(!this.trafficStats)return k;let M=this.trafficStats.peer_delay.find(k=>k.peer_uid===L);return M&&(k.publishDuration=M.B_ppvd+(Date.now()-this.trafficStats.timestamp)),k},k={};if(L){var M;let U=null===(M=this.remoteStats.get(L))||void 0===M?void 0:M.videoStats;U&&(k[L]=t(L,U))}else Array.from(this.remoteStats.entries()).forEach(L=>{let[M,{videoStats:U}]=L;U&&(k[M]=t(M,U))});return k}getRTCStats(){let L=0,k=0,M=0,U=0,V=this.localStats.get(R4.LocalAudioTrack);V&&(L+=V.sendBytes,k+=V.sendBitrate);let F=this.localStats.get(R4.LocalVideoTrack);F&&(L+=F.sendBytes,k+=F.sendBitrate);let B=this.localStats.get(R4.LocalVideoLowTrack);B&&(L+=B.sendBytes,k+=B.sendBitrate),this.remoteStats.forEach(L=>{let{audioStats:k,videoStats:V}=L;k&&(M+=k.receiveBytes,U+=k.receiveBitrate),V&&(M+=V.receiveBytes,U+=V.receiveBitrate)});let j=1;return this.trafficStats&&(j+=this.trafficStats.peer_delay.length),{Duration:0,UserCount:j,SendBitrate:k,SendBytes:L,RecvBytes:M,RecvBitrate:U,OutgoingAvailableBandwidth:this.uplinkStats?this.uplinkStats.B_uab/1e3:0,RTT:this.trafficStats?2*this.trafficStats.B_acd:0}}addLocalStats(L){this.localStats.set(L,void 0)}removeLocalStats(L){L?this.localStats.delete(L):this.localStats.clear()}addRemoteStats(L){this.remoteStats.set(L,{})}removeRemoteStats(L){L?this.remoteStats.delete(L):this.remoteStats.clear()}addP2PChannel(L){this.p2pChannel=L}updateTrafficStats(L){L.peer_delay=L.peer_delay.filter(L=>void 0!==L.B_ppad||void 0!==L.B_ppvd),L.peer_delay.filter(L=>-1===this.trafficStatsPeerList.indexOf(L.peer_uid)).forEach(L=>{var k;let M=null===(k=this.p2pChannel)||void 0===k?void 0:k.getRemoteMedia(L.peer_uid),U=null!=M&&M.videoSSRC?IW.measureFromSubscribeStart(this.store.clientId,M.videoSSRC):0,V=null!=M&&M.audioSSRC?IW.measureFromSubscribeStart(this.store.clientId,M.audioSSRC):0;void 0!==L.B_ppad&&void 0!==L.B_ppvd&&(this.onUploadPublishDuration&&this.onUploadPublishDuration(L.peer_uid,L.B_ppad,L.B_ppvd,U>V?U:V),this.trafficStatsPeerList.push(L.peer_uid))}),this.trafficStats=L}updateUplinkStats(L){this.uplinkStats&&this.uplinkStats.B_fir!==L.B_fir&&gc.debug("[".concat(this.store.clientId,"]: Period fir changes to ").concat(L.B_fir)),this.uplinkStats=L}static isRemoteVideoFreeze(L,k,M){if(!L)return!1;let U=!!M&&k.framesDecodeFreezeTime>M.framesDecodeFreezeTime,V=!M||k.framesDecodeCount>M.framesDecodeCount;return U||!V}static isRemoteAudioFreeze(L){return!!L&&L._isFreeze()}isLocalVideoFreeze(L){return!(!L.inputFrame||!L.sentFrame)&&L.inputFrame.frameRate>5&&L.sentFrame.frameRate<3}updateLocalStats(L){Array.from(this.localStats.entries()).forEach(k=>{let[M,U]=k;switch(M){case R4.LocalVideoTrack:case R4.LocalVideoLowTrack:{var V,F;let k=qF({},gK),B=L.getStats(),j=L.getLocalMedia(M);if(B){let M=B.videoSend.find(L=>L.ssrc===(null==j?void 0:j.ssrcs[0].ssrcId));if(M){let F=L.getLocalVideoSize(),B=L.getEncoderConfig(R4.LocalVideoTrack);("H264"===M.codec||"H265"===M.codec||"VP8"===M.codec||"VP9"===M.codec||"AV1X"===M.codec||"AV1"===M.codec)&&(k.codecType=M.codec,(null==U?void 0:U.codecType)!==M.codec&&(null===(V=this.onVideoCodecChanged)||void 0===V||V.call(this,M.codec.toLocaleLowerCase()))),k.sendBytes=M.bytes,k.sendBitrate=U?8*Math.max(0,k.sendBytes-U.sendBytes):0,M.inputFrame?(k.captureFrameRate=M.inputFrame.frameRate,k.captureResolutionHeight=M.inputFrame.height,k.captureResolutionWidth=M.inputFrame.width):F&&(k.captureResolutionWidth=F.width,k.captureResolutionHeight=F.height),M.sentFrame?(k.sendFrameRate=M.sentFrame.frameRate,k.sendResolutionHeight=M.sentFrame.height,k.sendResolutionWidth=M.sentFrame.width):F&&(k.sendResolutionWidth=F.width,k.sendResolutionHeight=F.height),M.avgEncodeMs&&(k.encodeDelay=M.avgEncodeMs),B&&B.bitrateMax?k.targetSendBitrate=1e3*B.bitrateMax:M.targetBitrate&&(k.targetSendBitrate=M.targetBitrate),k.sendPackets=M.packets,k.sendPacketsLost=M.packetsLost,k.sendJitterMs=M.jitterMs,k.sendRttMs=M.rttMs,k.totalDuration=U?U.totalDuration+1:1,k.totalFreezeTime=U?U.totalFreezeTime:0,this.isLocalVideoFreeze(M)&&(k.totalFreezeTime+=1),M.scalabilityMode&&this.scalabilityMode!==M.scalabilityMode&&(gc.debug("[".concat(this.store.clientId,"]: The scalabilityMode of the video sending stream is ").concat(M.scalabilityMode)),this.scalabilityMode=M.scalabilityMode)}this.trafficStats&&(k.currentPacketLossRate=(this.trafficStats.B_pvlr4||0)/100)}this.localStats.set(M,k),((null==U?void 0:U.sendResolutionWidth)!==k.sendResolutionWidth||(null==U?void 0:U.sendResolutionHeight)!==k.sendResolutionHeight)&&(null===(F=this.onStatsChanged)||void 0===F||F.call(this,"resolution",{width:k.sendResolutionWidth,height:k.sendResolutionHeight})),k&&j&&this.exceptionMonitor.setLocalVideoStats(this.store.uid,j.track,k);break}case R4.LocalAudioTrack:{let k=qF({},gH),V=L.getStats(),F=L.getLocalMedia(M);if(V){let M=V.audioSend.find(L=>L.ssrc===(null==F?void 0:F.ssrcs[0].ssrcId));if(M){if("opus"!==M.codec&&"aac"!==M.codec&&"PCMU"!==M.codec&&"PCMA"!==M.codec&&"G722"!==M.codec||(k.codecType=M.codec),M.inputLevel)k.sendVolumeLevel=Math.round(32767*M.inputLevel);else{let M=L.getLocalAudioVolume();M&&(k.sendVolumeLevel=Math.round(32767*M))}k.sendBytes=M.bytes,k.sendPackets=M.packets,k.sendPacketsLost=M.packetsLost,k.sendJitterMs=M.jitterMs,k.sendRttMs=M.rttMs,k.sendBitrate=U?8*Math.max(0,k.sendBytes-U.sendBytes):0}}this.trafficStats&&(k.currentPacketLossRate=(this.trafficStats.B_palr4||0)/100),this.localStats.set(R4.LocalAudioTrack,k),k&&F&&this.exceptionMonitor.setLocalAudioStats(this.store.uid,F.track,k)}}})}updateRemoteStats(L){Array.from(this.remoteStats.entries()).forEach(k=>{var M;let U;let[V,{videoStats:F,audioStats:B,videoPcStats:j}]=k,G=qF({},gY),X=qF({},gX),$=qF({},gJ),{audioTrack:ee,videoTrack:et,audioSSRC:ei,videoSSRC:er}=L.getRemoteMedia(V);U=this.store.useP2P?L.getStats(!0):L.getStats();let en=null==U?void 0:U.audioRecv.find(L=>L.ssrc===ei),ea=null==U?void 0:U.videoRecv.find(L=>L.ssrc===er),eo=this.trafficStats&&this.trafficStats.peer_delay.find(L=>L.peer_uid===V);if(en&&("opus"!==en.codec&&"aac"!==en.codec&&"PCMU"!==en.codec&&"PCMA"!==en.codec&&"G722"!==en.codec||(G.codecType=en.codec),en.outputLevel?G.receiveLevel=Math.round(32767*en.outputLevel):ee&&(G.receiveLevel=Math.round(32767*ee.getVolumeLevel())),G.receiveBytes=en.bytes,G.receivePackets=en.packets,G.receivePacketsLost=en.packetsLost,G.receivePacketsDiscarded=en.packetsDiscarded,G.packetLossRate=G.receivePacketsLost/(G.receivePackets+G.receivePacketsLost),G.receiveBitrate=B?8*Math.max(0,G.receiveBytes-B.receiveBytes):0,G.totalDuration=B?B.totalDuration+1:1,G.totalFreezeTime=B?B.totalFreezeTime:0,G.freezeRate=G.totalFreezeTime/G.totalDuration,G.receiveDelay=en.jitterBufferMs,G.totalDuration>10&&XF.isRemoteAudioFreeze(ee)&&(G.totalFreezeTime+=1)),ea){"H264"!==ea.codec&&"H265"!==ea.codec&&"VP8"!==ea.codec&&"VP9"!==ea.codec&&"AV1X"!==ea.codec&&"AV1"!==ea.codec||(X.codecType=ea.codec),X.receiveBytes=ea.bytes,X.receiveBitrate=F?8*Math.max(0,X.receiveBytes-F.receiveBytes):0,X.decodeFrameRate=ea.decodeFrameRate<0?0:ea.decodeFrameRate,X.renderFrameRate=ea.decodeFrameRate<0?0:ea.decodeFrameRate,ea.outputFrame&&(X.renderFrameRate=ea.outputFrame.frameRate),ea.receivedFrame?(X.receiveFrameRate=ea.receivedFrame.frameRate,X.receiveResolutionHeight=ea.receivedFrame.height,X.receiveResolutionWidth=ea.receivedFrame.width):et&&(X.receiveResolutionHeight=et._videoHeight||0,X.receiveResolutionWidth=et._videoWidth||0),void 0!==ea.framesRateFirefox&&(X.receiveFrameRate=Math.round(ea.framesRateFirefox)),X.receivePackets=ea.packets,X.receivePacketsLost=ea.packetsLost,X.packetLossRate=X.receivePacketsLost/(X.receivePackets+X.receivePacketsLost);let k=F?F.totalFreezeTime:0,U=F?F.totalDuration:0;X.totalDuration=F?F.totalDuration+1:1,X.totalFreezeTime=null!==(M=ea.totalFreezesDuration)&&void 0!==M?M:k||0,X.receiveDelay=ea.jitterBufferMs||0;let V=!!er&&L.getRemoteVideoIsReady(er);void 0===ea.totalFreezesDuration&&et&&V&&XF.isRemoteVideoFreeze(et,ea,j)&&(X.totalFreezeTime+=1),X.freezeRate=Math.max(0,Math.min((X.totalFreezeTime-k)/(X.totalDuration-U),1))}eo&&(G.end2EndDelay=eo.B_ad,X.end2EndDelay=eo.B_vd,G.transportDelay=eo.B_ed,X.transportDelay=eo.B_ed,G.currentPacketLossRate=eo.B_ealr4/100,X.currentPacketLossRate=eo.B_evlr4/100,$.uplinkNetworkQuality=eo.B_punq?eo.B_punq:0,$.downlinkNetworkQuality=eo.B_pdnq?eo.B_pdnq:0),this.remoteStats.set(V,{audioStats:G,videoStats:X,videoPcStats:ea,networkStats:$}),ee&&this.exceptionMonitor.setRemoteAudioStats(ee,G),et&&this.exceptionMonitor.setRemoteVideoStats(et,X)})}};let JF=class JF{constructor(){uI(this,"destChannelMediaInfos",new Map),uI(this,"srcChannelMediaInfo",void 0)}setSrcChannelInfo(L){QU(L),this.srcChannelMediaInfo=L}addDestChannelInfo(L){QU(L),this.destChannelMediaInfos.set(L.channelName,L)}removeDestChannelInfo(L){GU(L),this.destChannelMediaInfos.delete(L)}getSrcChannelMediaInfo(){return this.srcChannelMediaInfo}getDestChannelMediaInfo(){return this.destChannelMediaInfos}};function ZF(L){if(!(L instanceof JF))return new ED(f1.INVALID_PARAMS,"Config should be instance of [ChannelMediaRelayConfiguration]").throw();let k=L.getSrcChannelMediaInfo(),M=L.getDestChannelMediaInfo();return k?0===M.size?new ED(f1.INVALID_PARAMS,"destChannelMediaInfo should not be empty").throw():void 0:new ED(f1.INVALID_PARAMS,"srcChannelMediaInfo should not be empty").throw()}let QF=class QF{get hasVideo(){return this._video_enabled_&&!this._video_muted_&&this._video_added_}get hasAudio(){return this._audio_enabled_&&!this._audio_muted_&&this._audio_added_}get audioTrack(){if(this.hasAudio||this._audio_pre_subscribed)return this._audioTrack}get videoTrack(){if(this.hasVideo||this._video_pre_subscribed)return this._videoTrack}get dataChannels(){return this._dataChannels}constructor(L,k){uI(this,"uid",void 0),uI(this,"_uintid",void 0),uI(this,"_trust_in_room_",!0),uI(this,"_trust_audio_enabled_state_",!0),uI(this,"_trust_video_enabled_state_",!0),uI(this,"_trust_audio_mute_state_",!0),uI(this,"_trust_video_mute_state_",!0),uI(this,"_audio_muted_",!1),uI(this,"_video_muted_",!1),uI(this,"_audio_enabled_",!0),uI(this,"_video_enabled_",!0),uI(this,"_audio_added_",!1),uI(this,"_video_added_",!1),uI(this,"_is_pre_created",!1),uI(this,"_video_pre_subscribed",!1),uI(this,"_audio_pre_subscribed",!1),uI(this,"_trust_video_stream_added_state_",!0),uI(this,"_trust_audio_stream_added_state_",!0),uI(this,"_audioTrack",void 0),uI(this,"_videoTrack",void 0),uI(this,"_dataChannels",[]),uI(this,"_audioSSRC",void 0),uI(this,"_videoSSRC",void 0),uI(this,"_audioOrtc",void 0),uI(this,"_videoOrtc",void 0),uI(this,"_cname",void 0),uI(this,"_rtxSsrcId",void 0),uI(this,"_videoMid",void 0),uI(this,"_audioMid",void 0),this.uid=L,this._uintid=k}};function $F(L,k){var M=Object.keys(L);if(Object.getOwnPropertySymbols){var U=Object.getOwnPropertySymbols(L);k&&(U=U.filter(function(k){return Object.getOwnPropertyDescriptor(L,k).enumerable})),M.push.apply(M,U)}return M}function eB(L){for(var k=1;k<arguments.length;k++){var M=null!=arguments[k]?arguments[k]:{};k%2?$F(Object(M),!0).forEach(function(k){uI(L,k,M[k])}):Object.getOwnPropertyDescriptors?Object.defineProperties(L,Object.getOwnPropertyDescriptors(M)):$F(Object(M)).forEach(function(k){Object.defineProperty(L,k,Object.getOwnPropertyDescriptor(M,k))})}return L}function rB(L,k){var M=Object.keys(L);if(Object.getOwnPropertySymbols){var U=Object.getOwnPropertySymbols(L);k&&(U=U.filter(function(k){return Object.getOwnPropertyDescriptor(L,k).enumerable})),M.push.apply(M,U)}return M}function oB(L){for(var k=1;k<arguments.length;k++){var M=null!=arguments[k]?arguments[k]:{};k%2?rB(Object(M),!0).forEach(function(k){uI(L,k,M[k])}):Object.getOwnPropertyDescriptors?Object.defineProperties(L,Object.getOwnPropertyDescriptors(M)):rB(Object(M)).forEach(function(k){Object.defineProperty(L,k,Object.getOwnPropertyDescriptor(M,k))})}return L}var IG=((t2=IG||{})[t2.DOWN=0]="DOWN",t2[t2.UP=1]="UP",t2);let IH=new Map;function cB(L,k,M,U){let{scale:V}=L;if(0===V&&U===IG.UP||V>=k.length-1&&U===IG.DOWN)return L;let F=oB(oB({},L),{},{scale:U===IG.DOWN?++V:--V});switch(M){case"maintain-framerate":F=oB(oB({},F),k[V].motion);break;case"maintain-resolution":F=oB(oB({},F),k[V].detail);break;case"balanced":F=oB(oB({},F),k[V].balanced)}return F}function dB(L,k){if(k){let M={overUse:0,underUse:0,adaptationList:lB(k)};IH.set(L,M)}else IH.delete(L)}function lB(L){let k=oB({},L),{bitrateMax:M,frameRate:U,scaleResolutionDownBy:V,bitrateMin:F}=k,{MIN_FRAME_RATE:B,MAX_THRESHOLD_FRAMERATE:j,MAX_SCALE:G,BITRATE_MIN_THRESHOLD:X,BITRATE_MAX_THRESHOLD:$,BWE_SCALE_UP_THRESHOLD:ee,BWE_SCALE_DOWN_THRESHOLD:et,PERF_SCALE_DOWN_THRESHOLD:ei,PERF_SCALE_UP_THRESHOLD:er,BALANCE_BITRATE_FACTOR:en,BALANCE_FRAMERATE_FACTOR:ea,BALANCE_RESOLUTION_FACTOR:eo,MOTION_RESOLUTION_FACTOR:es,MOTION_BITRATE_FACTOR:ec,DETAIL_FRAMERATE_FACTOR:ed,DETAIL_BITRATE_FACTOR:el}=S0,eu=Math.min(k.frameRate,j),eh=[{scale:0,threshold:{bwe_down:Math.round(Math.pow(et,1)*M),bwe_up:M,fps_down:Math.round(Math.pow(ei,1)*eu),fps_up:U},balanced:{scaleResolutionDownBy:1,frameRate:U,bitrateMax:M,bitrateMin:F},motion:{scaleResolutionDownBy:1,frameRate:U,bitrateMax:M,bitrateMin:F},detail:{scaleResolutionDownBy:1,frameRate:U,bitrateMax:M,bitrateMin:F}}];for(let L=1;L<=G;L++){let k={bwe_up:Math.round(Math.pow(ee,L)*M),bwe_down:Math.round(Math.pow(et,L+1)*M),fps_up:Math.round(Math.pow(er,L)*eu),fps_down:Math.round(Math.pow(ei,L+1)*eu)},j={scaleResolutionDownBy:V/Math.pow(eo,L),frameRate:Math.max(Math.round(Math.pow(ea,L)*U),B),bitrateMax:Math.max(Math.round(Math.pow(en,L)*M),$),bitrateMin:Math.max(Math.round(Math.pow(en,L)*F),X)},G={scaleResolutionDownBy:V/Math.pow(es,L),frameRate:U,bitrateMax:Math.max(Math.round(Math.pow(ec,L)*M),$),bitrateMin:Math.max(Math.round(Math.pow(ec,L)*F),X)},ep={scaleResolutionDownBy:1,frameRate:Math.max(Math.round(Math.pow(ed,L)*U),B),bitrateMax:Math.max(Math.round(Math.pow(el,L)*M),$),bitrateMin:Math.max(Math.round(Math.pow(el,L)*F),X)};eh.push({scale:L,threshold:k,balanced:j,motion:G,detail:ep})}return eh}function uB(L,k,M,U,V,F){let B,j;let G=IH.get(L)||{overUse:0,underUse:0,adaptationList:lB(V)},{adaptationList:X}=G;IH.set(L,G);let{OVERUSE_TIMES_THRESHOLD:$,UNDERUSE_TIMES_THRESHOLD:ee}=S0,{scale:et}=U;return"number"==typeof k&&k>0&&function(L,k,M,U){if(k>=M.length)return!1;let{threshold:{fps_down:V}}=M[k];return wN("FORCE_AG_HIGH_FRAMERATE")&&"maintain-framerate"===U&&(V=M[0].threshold.fps_down),L<V}(k,et,X,F)&&(G.overUse++,j=SV.CPU,G.overUse>$)||"number"==typeof M&&M>0&&function(L,k,M){if(k>=M.length)return!1;let{threshold:{bwe_down:U}}=M[k];return L<U}(M,et,X)&&(G.overUse++,j=SV.BANDWIDTH,G.overUse>$)?(G.overUse=0,G.underUse=0,[B=cB(U,X,F,IG.DOWN),j]):("number"==typeof k&&k>0&&"number"==typeof M&&M>0&&function(L,k,M,U){if(0===k)return;let{threshold:{fps_up:V}}=M[k];return wN("FORCE_AG_HIGH_FRAMERATE")&&"maintain-framerate"===U&&(V=M[1].threshold.fps_up),L>V}(k,et,X,F)&&function(L,k,M){if(0===k)return;let{threshold:{bwe_up:U}}=M[k];return L>U}(M,et,X)&&(G.underUse++,G.underUse>ee&&(G.overUse=0,G.underUse=0,0===(B=cB(U,X,F,IG.UP)).scale&&(j=SV.NONE))),[B,j])}function hB(L,k){var M=Object.keys(L);if(Object.getOwnPropertySymbols){var U=Object.getOwnPropertySymbols(L);k&&(U=U.filter(function(k){return Object.getOwnPropertyDescriptor(L,k).enumerable})),M.push.apply(M,U)}return M}function pB(L){for(var k=1;k<arguments.length;k++){var M=null!=arguments[k]?arguments[k]:{};k%2?hB(Object(M),!0).forEach(function(k){uI(L,k,M[k])}):Object.getOwnPropertyDescriptors?Object.defineProperties(L,Object.getOwnPropertyDescriptors(M)):hB(Object(M)).forEach(function(k){Object.defineProperty(L,k,Object.getOwnPropertyDescriptor(M,k))})}return L}let IK=new Map;function EB(L,k){let M=IK.get(L);if(M){let{timer:k}=M;window.clearTimeout(k),IK.delete(L)}k.qualityLimitationReason=SV.NONE,dB(L)}function mB(L,k){var M;let U;switch(k){case R4.LocalAudioTrack:U=RG.Audio;break;case R4.LocalVideoTrack:U=so(M=L._hints).call(M,gL.SCREEN_TRACK)?RG.Screen:RG.High;break;case R4.LocalVideoLowTrack:U=RG.Low}return U}function fB(L){if(L.some(L=>L._bypassWebAudio))throw new f2(f1.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");if(!gf.webAudioMediaStreamDest)throw new f2(f1.NOT_SUPPORTED,"cannot publish multiple tracks because your browser does not support audio mixing")}function SB(L,k){fB(L);let M=k||new WL;return L.forEach(L=>M.addAudioTrack(L)),M}let IY=!gf.supportUnifiedPlan||wN("CHROME_FORCE_PLAN_B")&&vw();function TB(L){let k=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return IY?Jx("PlanBConnection").create({spec:k,store:L}):new IJ(k,L)}function RB(L){return L&&("disconnected"===L.iceConnectionState||"checking"===L.iceConnectionState||"failed"===L.iceConnectionState)}function vB(L){try{if(L.iceServers)return!1;if(L.turnServer&&"off"!==L.turnServer.mode){if(Qw(L.turnServer.servers))return!1;if(wN("FORCE_TURN_TCP")||L.turnServer.servers.concat(L.turnServer.serversFromGateway||[]).some(L=>L.forceturn))return!0}return!1}catch(L){return!1}}function yB(L,k){var M=Object.keys(L);if(Object.getOwnPropertySymbols){var U=Object.getOwnPropertySymbols(L);k&&(U=U.filter(function(k){return Object.getOwnPropertyDescriptor(L,k).enumerable})),M.push.apply(M,U)}return M}function IB(L){for(var k=1;k<arguments.length;k++){var M=null!=arguments[k]?arguments[k]:{};k%2?yB(Object(M),!0).forEach(function(k){uI(L,k,M[k])}):Object.getOwnPropertyDescriptors?Object.defineProperties(L,Object.getOwnPropertyDescriptors(M)):yB(Object(M)).forEach(function(k){Object.defineProperty(L,k,Object.getOwnPropertyDescriptor(M,k))})}return L}let IJ=(OU((nt=class e extends _V{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get dtlsTransportState(){var L,k;return null!==(L=null===(k=this.peerConnection.getReceivers()[0])||void 0===k||null===(k=k.transport)||void 0===k?void 0:k.state)&&void 0!==L?L:null}get localCodecs(){return[...new Set(this.localCapabilities&&this.localCapabilities.send.videoCodecs.map(L=>L.rtpMap&&L.rtpMap.encodingName.toLowerCase()||"").filter(L=>{var k;return so(k=Object.keys(S8)).call(k,L)}))]}constructor(L,k){super(L,k),uI(this,"id",IO(5,"connection-")),uI(this,"store",void 0),uI(this,"peerConnection",void 0),uI(this,"forceTurn",!1),uI(this,"remoteSDP",void 0),uI(this,"initialOffer",void 0),uI(this,"transportEventReceiver",void 0),uI(this,"statsFilter",void 0),uI(this,"extension",{useXR:wN("USE_XR")}),uI(this,"localCapabilities",void 0),uI(this,"remoteCodecs",void 0),uI(this,"localCandidateCount",0),uI(this,"allCandidatesReceived",!1),uI(this,"isPreallocation",!1),uI(this,"preMediaMap",new Map),uI(this,"dataStreamChannelMap",new Map),uI(this,"establishPromise",void 0),uI(this,"recoveredDataChannelIds",[]),uI(this,"currentDataChannelId",1),uI(this,"supportAV1RtpSpec",!1),uI(this,"mutex",void 0),uI(this,"qualityLimitationReason",SV.NONE),uI(this,"isFirstConnected",!1),this.store=k,this.forceTurn=vB(L),this.mutex=new S_("P2PConnection-mutex",k.clientId),this.peerConnection=new RTCPeerConnection(e.resolvePCConfiguration(L),{optional:[{googDscp:!0}]}),this.isFirstConnected=!1,this.statsFilter=EN(this.peerConnection,wN("STATS_UPDATE_INTERVAL"),void 0,iw()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,L.isPreallocation&&(this.isPreallocation=!0),this.establishPromise=this.establish()}getPreMedia(L){return this.preMediaMap.get(L)}isPreSub(){return this.preMediaMap.size>0}async updateRemoteRTPCapabilities(L,k){if(this.remoteCodecs=k,!this.remoteSDP)return void gc.debug("[P2PConnection] cannot updateRemoteRTPCapabilities before remote SDP created, local codecs: ".concat(this.localCodecs,", codecs: ").concat(k));if(this.remoteSDP.updateRemoteCodec(L,k,this.store.codec)){let L=await this.peerConnection.createOffer(),k=this.logSDPExchange(L.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(L);let M=this.remoteSDP.toString();null==k||k(M),await this.peerConnection.setRemoteDescription({type:"answer",sdp:M})}else gc.debug("[P2PConnection] updateRemoteRTPCapabilities no need to exchange SDP.")}async establish(){var L,k;try{let M;this.peerConnection.addTransceiver("video",{direction:"recvonly"}),this.peerConnection.addTransceiver("audio",{direction:"recvonly"});let U=await this.peerConnection.createOffer();if(!U.sdp)throw Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");let V=vx(U.sdp),F=await Lx({filterRTX:!wN("USE_PUB_RTX")&&!wN("USE_SUB_RTX"),filterVideoFec:wN("FILTER_VIDEO_FEC"),filterAudioFec:wN("FILTER_AUDIO_FEC"),filterVideoCodec:wN("FILTER_VIDEO_CODEC"),unsupportedVideoUplinkCodec:wN("UNSUPPORTED_VIDEO_UPLINK_CODEC"),unsupportedVideoDownlinkCodec:wN("UNSUPPORTED_VIDEO_DOWNLINK_CODEC")},this.extension);if(this.localCapabilities=Ux(F),this.initialOffer=U,wN("ENABLE_SVC")&&"av1"==this.store.codec){let k=await async function(){try{let L=new RTCPeerConnection;L.addTransceiver("video",{direction:"sendonly",sendEncodings:[{scalabilityMode:Sj.L1T3}]});let k=await L.createOffer();if(!k.sdp)return void L.close();let M=FN(k.sdp).mediaDescriptions[0];if(!M)return;let U=M.attributes.extmaps.find(L=>"https://aomediacodec.github.io/av1-rtp-spec/#dependency-descriptor-rtp-header-extension"===L.extensionName);return L.close(),U}catch(L){return}}();k&&(this.supportAV1RtpSpec=!0,null===(L=F.send)||void 0===L||L.videoExtensions.push(k))}return U.sdp&&Wx(U.sdp)&&((k=M=pO(F)).send&&(mx(R1.VIDEO,k.send.videoExtensions),mx(R1.AUDIO,k.send.audioExtensions)),k.recv&&(mx(R1.VIDEO,k.recv.videoExtensions),mx(R1.AUDIO,k.recv.audioExtensions)),k.sendrecv&&(mx(R1.VIDEO,k.sendrecv.videoExtensions),mx(R1.AUDIO,k.sendrecv.audioExtensions))),IB(IB({},V),{},{rtpCapabilities:M||F,offerSDP:U.sdp})}catch(L){throw new f2(f1.GET_LOCAL_CONNECTION_PARAMS_FAILED,L.toString())}}async connect(L){var k,M;try{if(!this.initialOffer)throw Error("Cannot establish P2PConnection without initial offer.");this.initialOffer.sdp&&Wx(this.initialOffer.sdp)&&(k=L.rtpCapabilities,M=this.localCapabilities,k.send&&(Ex(R1.VIDEO,k.send.videoExtensions,M.send.videoExtensions),Ex(R1.AUDIO,k.send.audioExtensions,M.send.audioExtensions)),k.recv&&(Ex(R1.VIDEO,k.recv.videoExtensions,M.recv.videoExtensions),Ex(R1.AUDIO,k.recv.audioExtensions,M.recv.audioExtensions))),this.remoteSDP=new class{get localCapabilities(){return pO(this._localCapabilities)}get rtpCapabilities(){return pO(this._rtpCapabilities)}get candidates(){return pO(this._candidates)}get iceParameters(){return pO(this._iceParameters)}get dtlsParameters(){return pO(this._dtlsParameters)}constructor(L){let k=arguments.length>1&&void 0!==arguments[1]&&arguments[1],M=arguments.length>2&&void 0!==arguments[2]&&arguments[2];uI(this,"sessionDesc",void 0),uI(this,"_localCapabilities",void 0),uI(this,"_rtpCapabilities",void 0),uI(this,"_candidates",void 0),uI(this,"_originCandidates",void 0),uI(this,"_iceParameters",void 0),uI(this,"_isUseExtmapAllowMixed",void 0),uI(this,"_isUseLocalCodecs",void 0),uI(this,"_dtlsParameters",void 0),uI(this,"setup",void 0),uI(this,"currentMidIndex",void 0),uI(this,"cname",void 0),uI(this,"useLocalCodecsMids",[]),uI(this,"preloadSsrcs",[]),uI(this,"firefoxSsrcMidMap",new Map),this._isUseExtmapAllowMixed=k,this._isUseLocalCodecs=M,L=pO(L);let{iceParameters:U,dtlsParameters:V,candidates:F,rtpCapabilities:B,setup:j,localCapabilities:G,cname:X}=L;this._rtpCapabilities=B,this._candidates=F,this._originCandidates=pO(F),this._iceParameters=U,this._dtlsParameters=V,this._localCapabilities=G,this.setup=j,this.cname=X,[this.sessionDesc]=this.updateRemoteRTPCapabilities(B),this.currentMidIndex=this.sessionDesc.mediaDescriptions.length-1}checkPreloadSsrcs(L){return L.length===this.preloadSsrcs.length&&L.every(L=>{var k;return so(k=this.preloadSsrcs).call(k,L)})}preloadRemoteMedia(L){let k=0,M=[],U=[];for(;L>0;){let V=[eB({ssrcId:4e4+k},wN("USE_SUB_RTX")?{rtx:4e4+k+1}:{})],F="".concat(4e4+k,"_").concat(2e4+k),{ssrcs:B,ssrcGroups:j}=bx(V,this.cname,wN("SYNC_GROUP")?F:void 0),G=this.preCreateOrRecycleSendMedia("video",B,j,void 0),X=[{ssrcId:2e4+k}],$="".concat(4e4+k,"_").concat(2e4+k),{ssrcs:ee,ssrcGroups:et}=bx(X,this.cname,wN("SYNC_GROUP")?$:void 0),ei=this.preCreateOrRecycleSendMedia("audio",ee,et,void 0);L--,k+=2,M.push(G,ei),U.push(B[0].ssrcId,ee[0].ssrcId)}return this.useLocalCodecsMids.push(...M),this.preloadSsrcs=U,{mids:M,preSSRCs:U,isAvailable:!0}}preCreateOrRecycleSendMedia(L,k,M,U){let V=this.rtpCapabilities.send.videoCodecs,F=this._isUseLocalCodecs||0===V.length?this.localCapabilities.recv:this.rtpCapabilities.send;gc.debug("create or recycle send media without remote rtp capabilities, ssrcs ",k[0].ssrcId);let B=L===R1.VIDEO?F.videoCodecs:F.audioCodecs,j=L===R1.VIDEO?F.videoExtensions:F.audioExtensions;this.currentMidIndex+=1;let G="".concat(this.currentMidIndex),X={media:{mediaType:L,port:"9",protos:["UDP","TLS","RTP","SAVPF"],fmts:B.map(L=>L.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:j,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:k,ssrcGroups:M,rtcpFeedbackWildcards:[],payloads:B,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"localhost"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(G)}};return X=this.mungSendMediaDesc(X,U),this.sessionDesc.mediaDescriptions.push(X),this.updateBundleMids(),G}toString(){return BN(this.sessionDesc)}send(L,k,M,U){let{ssrcs:V,ssrcGroups:F}=bx(k,this.cname,wN("SYNC_GROUP")?M:void 0),B=this.findPreloadMediaDesc(V);if(B){if(iw()&&this.firefoxSsrcMidMap.set(V[0].ssrcId,B.attributes.mid),U&&(U.twcc||U.remb)){let L=this.sessionDesc.mediaDescriptions.indexOf(B);return this.sessionDesc.mediaDescriptions[L]=this.mungSendMediaDesc(B,U),{mid:B.attributes.mid,needExchangeSDP:!0}}return{mid:B.attributes.mid,needExchangeSDP:!1}}{let k;let M=this.findAvailableMediaIndex(L,V);return -1===M||1===M&&($A()||function(){let L=zA();return!(L.name!==fQ.CHROME||!L.osVersion)&&90>=Number(L.version)}()||wN("ENABLE_ENCODED_TRANSFORM")&&QA())||0===M&&!function(L){let k=zA();return!(k.name!==fQ.FIREFOX||!k.osVersion)&&138===Number(k.version)}(0)&&wN("USE_SUB_RTX")||_w()?(k=this.createOrRecycleSendMedia(L,V,F,"sendonly",U),this.updateBundleMids()):((k=pO(this.sessionDesc.mediaDescriptions[M])).attributes.direction="sendonly",k.attributes.ssrcs=V,k.attributes.ssrcGroups=F,this.sessionDesc.mediaDescriptions[M]=this.mungSendMediaDesc(k,U)),iw()&&this.firefoxSsrcMidMap.set(V[0].ssrcId,k.attributes.mid),{mid:k.attributes.mid,needExchangeSDP:!0}}}sendDataChannel(){let{mediaDesc:L,needExchangeSDP:k}=this.createOrRecycleDataChannel();return this.updateBundleMids(),{mid:L.attributes.mid,needExchangeSDP:k}}batchSend(L){let k=L.map(L=>{let{kind:k,ssrcMsg:M,mslabel:U}=L;return this.send(k,M,U)}),M=[],U=!1;return k.forEach(L=>{let{mid:k,needExchangeSDP:V}=L;V&&(U=!0),M.push(k)}),{mids:M,needExchangeSDP:U}}stopSending(L){let k=this.sessionDesc.mediaDescriptions.filter(k=>k.attributes.mid&&-1!==L.indexOf(k.attributes.mid));if(k.length!==L.length)throw Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.stopSending.");k.forEach(L=>{"0"===L.attributes.mid||iw()||_w()?L.attributes.ssrcs=[]:(L.attributes.ssrcs=[],L.attributes.direction="inactive",L.media.port="0")}),this.updateBundleMids()}mute(L){let k=this.sessionDesc.mediaDescriptions.find(k=>k.attributes.mid===L);if(!k)throw Error("mediaDescription not found with ".concat(L," in remote SDP when calling RemoteSDP.mute."));k.attributes.direction="inactive"}unmute(L){let k=this.sessionDesc.mediaDescriptions.find(k=>k.attributes.mid===L);if(!k)throw Error("mediaDescription not found with ".concat(L," in remote SDP when calling RemoteSDP.unmute."));k.attributes.direction="sendonly"}muteRemote(L){let k=this.sessionDesc.mediaDescriptions.filter(k=>so(L).call(L,k.attributes.mid||""));if(k.length!==L.length)throw Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");k.forEach(L=>{L.attributes.direction="inactive"})}unmuteRemote(L){let k=this.sessionDesc.mediaDescriptions.filter(k=>so(L).call(L,k.attributes.mid||""));if(k.length!==L.length)throw Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");k.forEach(L=>{L.attributes.direction="recvonly"})}receive(L,k,M,U){L.forEach((L,V)=>{this.createOrRecycleRecvMedia(L,[],"recvonly",k,M,U[V])}),this.updateBundleMids()}stopReceiving(L){let k=this.sessionDesc.mediaDescriptions.filter(k=>-1!==L.indexOf(k.attributes.mid));if(k.length!==L.length)throw Error("MediaDescriptions' length doesn't match mids's length when calling RemoteSDP.receive.");k.forEach(L=>{L.media.port="0",L.attributes.direction="inactive"}),this.updateBundleMids()}updateRemoteRTPCapabilities(L){var k,M,U,V;let F=this.sessionDesc||FN((k=this._isUseExtmapAllowMixed,"v=0\no=- 0 0 IN IP4 127.0.0.1\ns=AgoraGateway\nt=0 0\na=group:BUNDLE 0 1\na=msid-semantic: WMS\na=ice-lite".concat(k?"\na=extmap-allow-mixed":"","\nm=video 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 localhost\na=sendonly\na=rtcp-mux\na=rtcp-rsize\na=mid:0\nm=audio 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 localhost\na=sendonly\na=rtcp-mux\na=rtcp-rsize\na=mid:1\n")));this._rtpCapabilities=L;let B=!1,j=this.rtpCapabilities.send,G=this.localCapabilities.send,X=this.localCapabilities.recv,$=X.videoCodecs,ee=X.audioCodecs,et=X.videoExtensions,ei=X.audioExtensions;for(let L of F.mediaDescriptions)if("sendonly"!==L.attributes.direction||"string"!=typeof L.attributes.mid||!so(M=this.useLocalCodecsMids).call(M,L.attributes.mid)){if(B=!0,L.attributes.iceUfrag=this._iceParameters.iceUfrag,L.attributes.icePwd=this._iceParameters.icePwd,L.attributes.fingerprints=this._dtlsParameters.fingerprints,L.attributes.candidates=this._candidates,L.attributes.setup=this.setup,"application"===L.media.mediaType&&(L.attributes.sctpPort="5000"),"video"===L.media.mediaType){if(this._isUseLocalCodecs&&"sendonly"===L.attributes.direction){L.media.fmts=$.map(L=>L.payloadType.toString(10)),L.attributes.payloads=$,L.attributes.extmaps=et;let k=L.attributes.mid;"string"!=typeof k||so(U=this.useLocalCodecsMids).call(U,k)||this.useLocalCodecsMids.push(k)}else if(0===j.videoCodecs.length){let k=G.videoCodecs.filter(L=>{var k,M;return null===(k=L.rtpMap)||void 0===k?void 0:so(M=k.encodingName.toLowerCase()).call(M,"vp8")})||[G.videoCodecs[0]];L.media.fmts=k.map(L=>L.payloadType.toString(10)),L.attributes.payloads=k,L.attributes.extmaps=[]}else L.media.fmts=j.videoCodecs.map(L=>L.payloadType.toString(10)),L.attributes.payloads=j.videoCodecs,L.attributes.extmaps=j.videoExtensions}if("audio"===L.media.mediaType){if(this._isUseLocalCodecs&&"sendonly"===L.attributes.direction){L.media.fmts=ee.map(L=>L.payloadType.toString(10)),L.attributes.payloads=ee,L.attributes.extmaps=ei;let k=L.attributes.mid;"string"!=typeof k||so(V=this.useLocalCodecsMids).call(V,k)||this.useLocalCodecsMids.push(k)}else if(0===j.audioCodecs.length){let k=G.audioCodecs.filter(L=>{var k,M;return null===(k=L.rtpMap)||void 0===k?void 0:so(M=k.encodingName.toLowerCase()).call(M,"opus")})||[G.audioCodecs[0]];L.media.fmts=k.map(L=>L.payloadType.toString(10)),L.attributes.payloads=k,L.attributes.extmaps=[]}else L.media.fmts=j.audioCodecs.map(L=>L.payloadType.toString(10)),L.attributes.payloads=j.audioCodecs,L.attributes.extmaps=j.audioExtensions,Vx(L)}}return this.sessionDesc=F,this.currentMidIndex=F.mediaDescriptions.length-1,[this.sessionDesc,B]}updateCandidates(L){let k=this._originCandidates.filter(L=>"udp"===L.transport),M=[];if(k.forEach(L=>{M.push(eB(eB({},L),{},{foundation:"tcpcandidate",priority:Number(L.priority)-1+"",transport:"tcp",port:Number(L.port)+90+""}))}),0!==k.length){switch(L){case R2.TCP_RELAY:this._candidates=M;break;case R2.UDP_TCP_RELAY:case R2.RELAY:this._candidates=[...k,...M];break;default:this._candidates=k}for(let L of this.sessionDesc.mediaDescriptions)L.attributes.candidates=this.candidates}}restartICE(L){L=pO(L),this._iceParameters=L,this.sessionDesc.mediaDescriptions.forEach(k=>{k.attributes.iceUfrag=L.iceUfrag,k.attributes.icePwd=L.icePwd})}predictReceivingMids(L){let k=[];for(let M=0;M<L;M++)k.push((this.currentMidIndex+M+1).toString(10));return k}findAvailableMediaIndex(L,k){return this.sessionDesc.mediaDescriptions.findIndex(M=>{let U=M.media.mediaType===L&&"0"!==M.media.port&&("sendonly"===M.attributes.direction||"sendrecv"===M.attributes.direction)&&0===M.attributes.ssrcs.length;if(iw()){if(U){let L=this.firefoxSsrcMidMap.get(k[0].ssrcId);return!(L||"0"!==M.attributes.mid&&"1"!==M.attributes.mid)||!(!L||L!==M.attributes.mid)}return!1}return U})}createOrRecycleDataChannel(){for(let L of this.sessionDesc.mediaDescriptions)if("application"===L.media.mediaType)return{mediaDesc:L,needExchangeSDP:!1};this.currentMidIndex+=1;let L="".concat(this.currentMidIndex),k={media:{mediaType:"application",port:"9",protos:["UDP","DTLS","SCTP"],fmts:["webrtc-datachannel"]},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:[],fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:[],ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:[],rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"localhost"},setup:this.setup,mid:"".concat(L),sctpPort:"5000"}};return this.sessionDesc.mediaDescriptions.push(k),{mediaDesc:k,needExchangeSDP:!0}}createOrRecycleRecvMedia(L,k,M,U,V,F){let B=L._mediaStreamTrack.kind,j=this.rtpCapabilities.recv,G=xx(B,j,this.localCapabilities.send,B===R1.VIDEO?U:V),X=B===R1.VIDEO?j.videoExtensions:j.audioExtensions;this.currentMidIndex+=1;let $="".concat(this.currentMidIndex),ee={media:{mediaType:B,port:"9",protos:["UDP","TLS","RTP","SAVPF"],fmts:G.map(L=>L.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:X,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:k,ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:G,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"localhost"},setup:this.setup,direction:M,rtcpMux:!0,rtcpRsize:!0,mid:"".concat($)}};ee=this.mungRecvMediaDsec(ee,L,F);let et=this.findFirstClosedMedia(B);if(et){let L=this.sessionDesc.mediaDescriptions.indexOf(et);this.sessionDesc.mediaDescriptions[L]=ee}else this.sessionDesc.mediaDescriptions.push(ee);return ee}updateRemoteDtlsParameters(L){let k=new Set(this._dtlsParameters.fingerprints.map(L=>L.fingerprint)),M=new Set(L.map(L=>L.fingerprint)),U=!1;for(let L of(k.size!==M.size&&(U=!0),k))M.has(L)||(U=!0);return U}updateRemoteCodec(L,k,M){let U;let V=[...new Set(this._rtpCapabilities.recv.videoCodecs.map(L=>L.rtpMap&&L.rtpMap.encodingName.toLowerCase()||"").filter(L=>{var k;return so(k=Object.keys(S8)).call(k,L)}))],F=new Set(k);if(V.every(L=>F.has(L)))return gc.debug("codecs has not changed, no need to updateRemoteCodec, codecs: ".concat(k)),!1;let B=this._rtpCapabilities.recv.videoCodecs.filter(L=>k.some(k=>{var M;return so(M=L.rtpMap&&L.rtpMap.encodingName.toLowerCase()||"").call(M,k)}));if(0===B.length)return gc.debug("updateRemoteCodec failed, because cannot find matched codec, remoteCapabilities codecs: ".concat(V," codecs: ").concat(k)),!1;let j=[...new Set(B.map(L=>L.rtpMap&&L.rtpMap.encodingName.toLowerCase()||""))];if(gc.debug("updateRemoteCodec, from ".concat(V," to ").concat(j)),0===L.length)U=this.sessionDesc.mediaDescriptions.filter(L=>"video"===L.media.mediaType&&"recvonly"===L.attributes.direction);else if((U=this.sessionDesc.mediaDescriptions.filter(k=>k.attributes.mid&&"video"===k.media.mediaType&&so(L).call(L,k.attributes.mid)&&"recvonly"===k.attributes.direction)).length!==L.length)return gc.debug("updateRemoteCodec failed, because cannot find mids, mids: ".concat(L,", codecs: ").concat(k)),!1;if(wN("USE_PUB_RTX")||wN("USE_SUB_RTX")){let L=Fx(B,this.rtpCapabilities.recv.videoCodecs);B.push(...L)}this._rtpCapabilities.recv.videoCodecs=B;let G=this.localCapabilities.send,X=this.rtpCapabilities.recv,$=xx(R1.VIDEO,X,G,M);return U.forEach(L=>{let k=$.map(L=>L.payloadType.toString(10));gc.debug("updateRemoteCodec mid: ".concat(L.attributes.mid,", from"),L.attributes.payloads,"to",$),L.attributes.payloads=$,L.media.fmts=k}),!0}createOrRecycleSendMedia(L,k,M,U,V){let F=this.rtpCapabilities.send.videoCodecs,B=this._isUseLocalCodecs||0===F.length?this.localCapabilities.recv:this.rtpCapabilities.send,j=L===R1.VIDEO?B.videoCodecs:B.audioCodecs,G=L===R1.VIDEO?B.videoExtensions:B.audioExtensions;this.currentMidIndex+=1;let X="".concat(this.currentMidIndex),$={media:{mediaType:L,port:"9",protos:["UDP","TLS","RTP","SAVPF"],fmts:j.map(L=>L.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:G,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:k,ssrcGroups:M,rtcpFeedbackWildcards:[],payloads:j,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"localhost"},setup:this.setup,direction:U,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(X)}};$=this.mungSendMediaDesc($,V);let ee=this.findFirstClosedMedia(L);if(ee){let L=this.sessionDesc.mediaDescriptions.indexOf(ee);this.sessionDesc.mediaDescriptions[L]=$}else this.sessionDesc.mediaDescriptions.push($);return $}updateBundleMids(){this.sessionDesc.attributes.groups[0].identificationTag=this.sessionDesc.mediaDescriptions.filter(L=>"0"!==L.media.port).map(L=>L.attributes.mid)}mungRecvMediaDsec(L,k,M){let U=pO(L);return wx(U),Ax(U,k),Ox(U,k),Nx(U),Dx(U,M,this.localCapabilities.send),U}mungSendMediaDesc(L,k){let M=pO(L);return Dx(M,k,this.localCapabilities.recv),Vx(M),M}updateRecvMedia(L,k){let M=this.sessionDesc.mediaDescriptions.findIndex(k=>k.attributes.mid===L);if(-1!==M){let L=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[M],k);this.sessionDesc.mediaDescriptions[M]=L}}bumpMid(L){this.currentMidIndex+=L}findFirstClosedMedia(L){return this.sessionDesc.mediaDescriptions.find(k=>iw()?"0"===k.media.port&&k.media.mediaType===L:"0"===k.media.port)}findPreloadMediaDesc(L){return this.sessionDesc.mediaDescriptions.find(k=>{var M;return(null===(M=k.attributes)||void 0===M||null===(M=M.ssrcs[0])||void 0===M?void 0:M.ssrcId)===L[0].ssrcId})}getSSRC(L){var k;return null===(k=this.sessionDesc.mediaDescriptions.find(k=>k.attributes.mid===L))||void 0===k?void 0:k.attributes.ssrcs}}(IB(IB({},L),{},{localCapabilities:this.localCapabilities}),this.supportAV1RtpSpec,!(!wN("ENABLE_PRE_SUB_WITH_PRE_PC")||!wN("PRE_USE_LOCAL_CODECS"))&&TD(this.store)),L.preallocation&&(this.isPreallocation=!0),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0&&this.remoteSDP.updateRemoteCodec([],this.remoteCodecs,this.store.codec);let U=this.remoteSDP.toString(),V=jx(this.initialOffer.sdp,this.extension),F=this.logSDPExchange(V||"","offer","local","connect");this.store.descriptionStart(),await this.peerConnection.setLocalDescription({type:"offer",sdp:V}),null==F||F(U),await this.peerConnection.setRemoteDescription({type:"answer",sdp:U});let B=this.peerConnection.getTransceivers()[0];if(null!=B&&B.receiver&&this.tryBindTransportEvents(B.receiver),TD(this.store)){if(L.preallocation&&wN("ENABLE_PRE_SUB_WITH_PRE_PC")){let L=wN("PRE_SUB_NUM"),{mids:k,preSSRCs:M}=this.remoteSDP.preloadRemoteMedia(L);await Bx(this.peerConnection,this.remoteSDP,this.extension),gc.debug("[".concat(this.store.clientId,"] [P2PConnection] preload media, in pre pc,add preload ssrcs ").concat(M)),this.presetMedia(k,M)}else{let{preSSRCs:k=[]}=L,M=k.map(L=>L.ssrcMsg[0].ssrcId);if(0===k.length)return;let{mids:U}=this.remoteSDP.batchSend(k.map(L=>Object.assign({},L)));await Bx(this.peerConnection,this.remoteSDP,this.extension),gc.debug("[P2PConnection.connect] preload media, after join, add preload ssrcs ".concat(M)),this.presetMedia(U,M)}}}catch(L){throw new f2(f1.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(L.toString()))}}presetMedia(L,k){L.forEach((L,M)=>{this.peerConnection.getTransceivers().forEach(U=>{if(null!=U.mid&&L===U.mid&&U.receiver.track){let V;let F=U.receiver.track;"video"===F.kind&&wN("ENABLE_PRE_RENDER")&&((V=new XL({trackId:"track-".concat(F.kind,"-unknown-").concat(this.store.clientId,"_").concat(IO(5,""))},!0)).updateVideoTrack(F),V.onFirstVideoFrameRender=()=>{var L;let U=this.preMediaMap.get(k[M]);U&&(U.firstVideoRender=Date.now()),null===(L=this.onFirstVideoRender)||void 0===L||L.call(this,k[M])},V.play(this.store.sessionId||void 0)),this.preMediaMap.set(k[M],{mid:L,track:F,player:V,transceiver:U})}}),this.store.peerReceiver()})}checkDtlsParameters(L){return!!this.remoteSDP&&L.length>0&&this.remoteSDP.updateRemoteDtlsParameters(L)}async updateRemoteConnect(L){try{if(!this.remoteSDP)throw Error("Cannot call P2PConnection.updateRemoteConnect before remote SDP created");let k=!1,{rtpCapabilities:M}=L;if([,k]=this.remoteSDP.updateRemoteRTPCapabilities(M),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0){let L=this.remoteSDP.updateRemoteCodec([],this.remoteCodecs,this.store.codec);k=k||L}let{preSSRCs:U=[]}=L,V=U.map(L=>L.ssrcMsg[0].ssrcId);if(!this.remoteSDP.checkPreloadSsrcs(V)){let L=[],k=[];if(Array.from(this.preMediaMap.entries()).every(M=>{let[U,{mid:V,player:F,track:B}]=M;return L.push(V),k.push(U),this.preMediaMap.delete(U),F&&F.destroy(),!0}),L.length>0&&(this.remoteSDP.stopSending(L),await Bx(this.peerConnection,this.remoteSDP,this.extension),gc.warn("[P2PConnection.updateRemoteConnect] preload media, failed, del preload ssrcs ".concat(k)),g_.reportApiInvoke(this.store.sessionId,{name:f8.PRELOAD_MEDIA_FAILED,options:[U,k],tag:f9.TRACER}).onSuccess()),U.length>0){let{mids:L}=this.remoteSDP.batchSend(U.map(L=>Object.assign({},L)));await Bx(this.peerConnection,this.remoteSDP,this.extension),gc.debug("[P2PConnection.updateRemoteConnect] preload media, after join, add preload ssrcs ".concat(V)),this.presetMedia(L,V)}}k?(await Bx(this.peerConnection,this.remoteSDP,this.extension),gc.debug("[P2PConnection] updateRemoteConnect by exchanging SDP.")):gc.debug("[P2PConnection] updateRemoteConnect no need to exchange SDP, because no need to update remote codecs (use local codecs)")}catch(L){throw new f2(f1.EXCHANGE_SDP_FAILED,"P2PConnection.updateRemoteConnect failed; ".concat(L.toString()))}}send(L,k,M){var U=this;return qb(function*(){let V=yield Jb(U.mutex.lock("From P2PConnection.send"));try{let V;if(!U.remoteSDP)throw Error("Cannot call P2PConnection.send before remote SDP created");let F=[],B=px();L.forEach(L=>{let k=U.peerConnection.addTransceiver(L._mediaStreamTrack,IB({direction:"sendonly"},"video"===L.trackMediaType&&U.supportAV1RtpSpec&&B?{sendEncodings:[{scalabilityMode:B}]}:{}));F.push(k),L._updateRtpTransceiver(k)}),iw()&&!0===wN("SIMULCAST")&&(yield Jb(U.applySimulcastForFirefox(F,L)));let j=yield Jb(U.peerConnection.createOffer()),G=U.remoteSDP.predictReceivingMids(L.length),X=U.mungSendOfferSDP(j.sdp,L,G),$=FN(X),ee=G.map(L=>{let k=$.mediaDescriptions.find(k=>k.attributes.mid===L);if(!k)throw Error("Cannot extract ssrc from mediaDescription.");return Cx(k,wN("USE_PUB_RTX"))});try{V=yield ee}catch(B){V=[],U.remoteSDP.receive(L,k,M,V);let F=U.remoteSDP.toString();throw yield Jb(U.peerConnection.setLocalDescription({type:"offer",sdp:X})),yield Jb(U.peerConnection.setRemoteDescription({type:"answer",sdp:F})),yield Jb(U.stopSending(G,!0)),B}U.remoteSDP.receive(L,k,M,V);let et=U.remoteSDP.toString(),ei=U.logSDPExchange(X,"offer","local","send");return yield Jb(U.peerConnection.setLocalDescription({type:"offer",sdp:X})),yield Jb(U.applySimulcastEncodings(F,L)),yield Jb(U.applySendEncodings(F,L)),null==ei||ei(et),yield Jb(U.peerConnection.setRemoteDescription({type:"answer",sdp:et})),F.map((L,k)=>{let M=G[k];return{localSSRC:ee[k],id:M,transceiver:L}})}catch(L){throw L instanceof f2?L:new f2(f1.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(L.toString()))}finally{V()}})()}async createDataChannels(L,k){try{if(!this.remoteSDP)throw Error("Cannot call P2PConnection.createDataChannels before remote SDP created");let M=this.dataStreamChannelMap.get(L);if(M&&"open"===M.readyState)gc.debug("[P2PConnection] Channels are already available and can be reused directly.");else{let k=this.currentDataChannelId<1023?this.currentDataChannelId++:this.recoveredDataChannelIds.shift();if("number"!=typeof k)throw Error("create DataChannel error, because cannot get dc id");(M=this.peerConnection.createDataChannel("datastream-channel",{id:k,negotiated:!0,ordered:!1,maxRetransmits:wN("DATASTREAM_MAX_RETRANSMITS")})).binaryType="arraybuffer",this.dataStreamChannelMap.set(L,M)}k.forEach(L=>{L._updateOriginDataChannel(M)});let{needExchangeSDP:U}=this.remoteSDP.sendDataChannel();if(U){let L=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:L});let k=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(k),gc.debug("[P2PConnection] createDataChannels by exchanging SDP.")}else gc.debug("[P2PConnection] createDataChannels no need to exchange SDP.");return}catch(L){throw L instanceof f2?L:new f2(f1.EXCHANGE_SDP_FAILED,"P2PConnection.createDataChannels failed; ".concat(L.toString()))}}async stopDataChannels(L){try{let k=this.dataStreamChannelMap.get(L);return k&&(k.id&&this.recoveredDataChannelIds.push(k.id),k.close()),void this.dataStreamChannelMap.delete(L)}catch(L){throw L instanceof f2?L:new f2(f1.DATACHANNEL_FAILED,"P2PConnection.stopDataChannels failed; ".concat(L.toString()))}}async stopSending(L,k){let M=k?void 0:await this.mutex.lock("From P2PConnection.stopSending");try{if(!this.remoteSDP)throw Error("Cannot call P2PConnection.stopSending before remote SDP created");let k=this.peerConnection.getTransceivers().filter(k=>-1!==L.indexOf(k.mid));if(k.length!==L.length)throw Error("Transceivers' length doesn't match mids' length when trying to call P2PConnection.stopSending.");k.map(L=>{var k;EB(this.id+L.mid,this),L.direction="inactive",null===(k=L.stop)||void 0===k||k.call(L)});let M=await this.peerConnection.createOffer(),U=this.logSDPExchange(M.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(M),this.remoteSDP.stopReceiving(L);let V=this.remoteSDP.toString();null==U||U(V),await this.peerConnection.setRemoteDescription({type:"answer",sdp:V})}catch(L){throw new f2(f1.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(L.toString()))}finally{M&&M()}}async receive(L,k,M,U){try{if(!this.remoteSDP)throw Error("Cannot call P2PConnection.receive ".concat(L," before remoteSDP created."));let{mid:V,needExchangeSDP:F}=this.remoteSDP.send(L,k,M,U);F&&(await Bx(this.peerConnection,this.remoteSDP,this.extension),gc.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(L," by exchanging SDP.")));let B=this.peerConnection.getTransceivers().find(L=>L.mid===V);if(!B)throw Error("Cannot get transceiver after setLocalDescription.");return{track:B.receiver.track,id:V,transceiver:B}}catch(L){throw new f2(f1.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(L.toString()))}}async batchReceive(L){try{if(!this.remoteSDP)throw Error("Cannot call P2PConnection.batchReceive before remoteSDP created.");let{mids:k,needExchangeSDP:M}=this.remoteSDP.batchSend(L);return M&&(await Bx(this.peerConnection,this.remoteSDP,this.extension),gc.debug("[".concat(this.store.clientId,"] [P2PConnection] batchReceive by exchanging SDP."))),k.map(L=>{let k=this.peerConnection.getTransceivers().find(k=>k.mid===L);if(!k)throw Error("Cannot get transceiver after setLocalDescription.");return{track:k.receiver.track,id:L,transceiver:k}})}catch(L){throw new f2(f1.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(L.toString()))}}async stopReceiving(L){try{if(!this.remoteSDP)throw Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");L.forEach(L=>{Array.from(this.preMediaMap.entries()).some(k=>{let[M,{mid:U,player:V}]=k;if(U===L)return this.preMediaMap.delete(M),V&&V.destroy(),!0})}),this.remoteSDP.stopSending(L);let k=this.remoteSDP.toString(),M=this.logSDPExchange(k,"offer","remote","stopReceiving");await this.peerConnection.setRemoteDescription({type:"offer",sdp:k});let U=await this.peerConnection.createAnswer();null==M||M(U.sdp||""),await this.peerConnection.setLocalDescription(U)}catch(L){throw new f2(f1.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(L.toString()))}}async muteRemote(L){try{if(!this.remoteSDP)throw Error("Cannot call P2PConnection.muteRemote mid=".concat(L," before remote SDP created."));this.remoteSDP.mute(L);let k=this.remoteSDP.toString(),M=this.logSDPExchange(k,"offer","remote","muteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:k});let U=await this.peerConnection.createAnswer();null==M||M(U.sdp||""),await this.peerConnection.setLocalDescription(U)}catch(L){throw new f2(f1.EXCHANGE_SDP_FAILED,"P2PConnection.muteRemote failed; ".concat(L.toString()))}}async unmuteRemote(L){try{if(!this.remoteSDP)throw Error("Cannot call P2PConnection.unmuteRemote mid=".concat(L," before remote SDP created."));this.remoteSDP.unmute(L);let k=this.remoteSDP.toString(),M=this.logSDPExchange(k,"offer","remote","unmuteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:k});let U=await this.peerConnection.createAnswer();null==M||M(U.sdp||""),await this.peerConnection.setLocalDescription(U)}catch(L){throw new f2(f1.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteRemote failed; ".concat(L.toString()))}}async muteLocal(L){try{if(!this.remoteSDP)throw Error("Cannot call P2PConnection.muteLocal before remote SDP created.");let k=this.peerConnection.getTransceivers().filter(k=>k.mid&&-1!==L.indexOf(k.mid));if(k.length!==L.length)throw Error("Transceivers' length doesn't match mids' length.");k.map(L=>{L.direction="inactive"});let M=await this.peerConnection.createOffer(),U=this.logSDPExchange(M.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(M),this.remoteSDP.muteRemote(L);let V=this.remoteSDP.toString();null==U||U(V),await this.peerConnection.setRemoteDescription({type:"answer",sdp:V})}catch(L){throw new f2(f1.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(L.toString()))}}async unmuteLocal(L){try{if(!this.remoteSDP)throw Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");let k=this.peerConnection.getTransceivers().filter(k=>k.mid&&-1!==L.indexOf(k.mid));if(k.length!==L.length)throw Error("Transceivers' length doesn't match mids' length.");k.map(async(L,k)=>{L.direction="sendonly"});let M=await this.peerConnection.createOffer(),U=this.logSDPExchange(M.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(M),this.remoteSDP.unmuteRemote(L),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0&&this.remoteSDP.updateRemoteCodec(L,this.remoteCodecs,this.store.codec);let V=this.remoteSDP.toString();null==U||U(V),await this.peerConnection.setRemoteDescription({type:"answer",sdp:V})}catch(L){throw new f2(f1.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(L.toString()))}}restartICE(L){var k=this;return qb(function*(){let M=yield Jb(k.mutex.lock("From P2PConnection.restartICE"));try{if(!k.remoteSDP)throw Error("Cannot restartICE before remoteSDP created.");let M=gf.supportPCSetConfiguration,U=wN("FORCE_TURN_TCP")||k.forceTurn;if(L===R2.RELAY&&!M)return;if(M&&!U){let M=L===R2.RELAY?"relay":"all",U=k.peerConnection.getConfiguration();U.iceTransportPolicy!==M&&(gc.debug("[".concat(k.store.clientId,"] restartICE change iceTransportPolicy from [").concat(U.iceTransportPolicy,"] to [").concat(M,"]")),U.iceTransportPolicy=M,k.peerConnection.setConfiguration(U))}k.remoteSDP.updateCandidates(L);let V=yield Jb(k.peerConnection.createOffer({iceRestart:!0}));if(!V.sdp)throw Error("Cannot restartICE because restart offer SDP does not exist.");let F=vx(V.sdp),{remoteIceParameters:B}=yield F.iceParameters;k.remoteSDP.restartICE(B);let j=k.remoteSDP.toString(),G=k.logSDPExchange(V.sdp||"","offer","local","restartICE");k.store.descriptionStart(),yield Jb(k.peerConnection.setLocalDescription(V)),null==G||G(j),yield Jb(k.peerConnection.setRemoteDescription({type:"answer",sdp:j}))}catch(L){gc.warning("[".concat(k.store.clientId,"] restart ICE failed, abort operation"),L)}finally{M()}})()}async extendCandidate(){if(!this.remoteSDP||this.isFirstConnected)return;let L=await this.mutex.lock("From P2PConnection.extendCandidate");try{this.remoteSDP.updateCandidates(R2.TCP_RELAY),await Bx(this.peerConnection,this.remoteSDP,this.extension)}catch(L){gc.warning("[".concat(this.store.clientId,"] extend candidate failed, abort operation"),L)}finally{L()}}close(){var L;this.peerConnection.getTransceivers().forEach(L=>{EB(this.id+L.mid,this)}),this.preMediaMap.forEach(L=>{let{player:k}=L;k&&k.destroy()}),this.preMediaMap.clear(),this.peerConnection.close(),null===(L=this.onConnectionStateChange)||void 0===L||L.call(this,"closed"),this.tryUnbindTransportEvents(),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.transportEventReceiver=void 0,this.statsFilter.destroy(),this.dataStreamChannelMap.clear(),this.recoveredDataChannelIds=[],this.currentDataChannelId=1}getStats(){return IB(IB({},this.statsFilter.getStats()),{},{qualityLimitationReason:this.qualityLimitationReason})}getRemoteVideoIsReady(L){return this.statsFilter.getVideoIsReady(L)}async updateEncoderConfig(L,k){try{if(!this.remoteSDP)throw Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");let M=await this.peerConnection.createOffer(),U=this.mungSendOfferSDP(M.sdp,[k],[L]);this.remoteSDP.updateRecvMedia(L,k);let V=this.remoteSDP.toString(),F=this.logSDPExchange(U,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:U}),null==F||F(V),await this.peerConnection.setRemoteDescription({type:"answer",sdp:V})}catch(L){throw new f2(f1.EXCHANGE_SDP_FAILED,L.toString())}}async updateSendParameters(L,k){let M=this.peerConnection.getTransceivers().filter(k=>k.mid===L);1===M.length&&(this.isVP8Simulcast(k)?iw()||await this.applySimulcastEncodings(M,[k]):await this.applySendEncodings(M,[k]))}setStatsRemoteVideoIsReady(L,k){this.statsFilter.setVideoIsReady2(L,k)}async replaceTrack(L,k){let M=this.peerConnection.getTransceivers().find(L=>L.mid===k);M&&await M.sender.replaceTrack(L._mediaStreamTrack)}async getSelectedCandidatePair(){let L=this.peerConnection.getReceivers();if(L.length>0&&L[0].transport&&L[0].transport.iceTransport&&L[0].transport.iceTransport.getSelectedCandidatePair&&L[0].transport.iceTransport.getSelectedCandidatePair()){let k=L[0].transport.iceTransport,{local:M,remote:U}=k.getSelectedCandidatePair();return{local:IB(IB({},Sv),{},{candidateType:M.type,protocol:M.protocol,address:M.address,port:M.port}),remote:IB(IB({},Sv),{},{candidateType:U.type,protocol:U.protocol,address:U.address,port:U.port})}}return this.statsFilter.getSelectedCandidatePair()}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var L;null===(L=this.onICEConnectionStateChange)||void 0===L||L.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var L;"connected"===this.peerConnection.connectionState&&(this.isFirstConnected=!0),null===(L=this.onConnectionStateChange)||void 0===L||L.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidateerror=L=>{if(L&&(L.errorCode||L.errorText)){var k;let M="code: ".concat(L.errorCode,", message: ").concat(L.errorText),U=L.port?"local: ".concat(L.port):"",V=hx(L.url||"");gc.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICECandidateError(").concat(M,"), url: ").concat(V||"",", host_candidate:").concat(U)),null===(k=this.onICECandidateError)||void 0===k||k.call(this,M)}},this.peerConnection.onicegatheringstatechange=L=>{L&&L.target&&"iceGatheringState"in L.target&&gc.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] RTCPeerConnection.onicegatheringstatechange(").concat(L.target.iceGatheringState,")"))},this.peerConnection.onicecandidate=L=>{L.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,gc.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout(()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,gc.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))},wN("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(L){let k={iceServers:[]},M=L.cloudProxyServer||"disabled";return L.iceServers?k.iceServers=L.iceServers:L.turnServer&&(Qw(L.turnServer.servers)?k.iceServers=L.turnServer.servers:wN("NEW_TURN_MODE")&&k.iceServers&&"disabled"===M?(wN("USE_TURN_SERVER_OF_GATEWAY")?L.turnServer.serversFromGateway&&k.iceServers.push(...e.newTurnServerConfigToIceServers(L.turnServer.serversFromGateway)):k.iceServers.push(...e.newTurnServerConfigToIceServers(L.turnServer.servers)),wN("NEW_FORCE_TURN")&&(k.iceTransportPolicy="relay")):"off"!==L.turnServer.mode&&(k.iceServers&&k.iceServers.push(...e.turnServerConfigToIceServers(L.turnServer.servers)),wN("USE_TURN_SERVER_OF_GATEWAY")&&k.iceServers&&L.turnServer.serversFromGateway&&k.iceServers.push(...e.turnServerConfigToIceServers(L.turnServer.serversFromGateway)),wN("FORCE_TURN_TCP")?k.iceTransportPolicy="relay":L.turnServer.servers.concat(L.turnServer.serversFromGateway||[]).forEach(L=>{L.forceturn&&(k.iceTransportPolicy="relay")}))),wN("ENABLE_ENCODED_TRANSFORM")&&gf.supportWebRTCEncodedTransform&&(k.encodedInsertableStreams=!0),k}static turnServerConfigToIceServers(L){let k=[];return L.forEach(L=>{L.security?L.tcpport&&k.push({username:L.username,credential:L.password,credentialType:"password",urls:"turns:".concat(ix(L.turnServerURL),":").concat(L.tcpport,"?transport=tcp")}):(L.udpport&&!wN("FORCE_TURN_TCP")&&k.push({username:L.username,credential:L.password,credentialType:"password",urls:"turn:".concat(L.turnServerURL,":").concat(L.udpport,"?transport=udp")}),L.tcpport&&k.push({username:L.username,credential:L.password,credentialType:"password",urls:"turn:".concat(L.turnServerURL,":").concat(L.tcpport,"?transport=tcp")}))}),k}static newTurnServerConfigToIceServers(L){let k=[];return L.forEach(L=>{let M=wN("NEW_TURN_MODE");1===M?k.push({username:L.username,credential:L.password,credentialType:"password",urls:"turn:".concat(L.turnServerURL,":3478?transport=udp")}):2===M?k.push({username:L.username,credential:L.password,credentialType:"password",urls:"turn:".concat(L.turnServerURL,":3478?transport=tcp")}):3===M?k.push({username:L.username,credential:L.password,credentialType:"password",urls:"turns:".concat(ix(L.turnServerURL),":443?transport=tcp")}):4===M&&(k.push({username:L.username,credential:L.password,credentialType:"password",urls:"turn:".concat(L.turnServerURL,":3478?transport=udp")}),k.push({username:L.username,credential:L.password,credentialType:"password",urls:"turn:".concat(L.turnServerURL,":3478?transport=tcp")}),k.push({username:L.username,credential:L.password,credentialType:"password",urls:"turns:".concat(ix(L.turnServerURL),":443?transport=tcp")}))}),k}tryBindTransportEvents(L){let k=L.transport;if(k){this.transportEventReceiver=L,k.onstatechange=()=>{var L;null!=k&&k.state&&(null===(L=this.onDTLSTransportStateChange)||void 0===L||L.call(this,k.state))},k.onerror=L=>{var k;null===(k=this.onDTLSTransportError)||void 0===k||k.call(this,"error"in L?L.error:L)};let M=k.iceTransport;M&&(M.onstatechange=()=>{var L;let M=null==k?void 0:k.iceTransport.state;M&&(null===(L=this.onICETransportStateChange)||void 0===L||L.call(this,M))},M.getSelectedCandidatePair&&(M.onselectedcandidatepairchange=()=>{if(M.getSelectedCandidatePair()){let{local:L,remote:k}=M.getSelectedCandidatePair()||{};if(L&&k){let M=L.address+":"+L.port,U=k.address+":"+k.port;gc.info("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] selectedcandidatepairchange: local ").concat(JSON.stringify(hx(M)),", remote ").concat(JSON.stringify(hx(U))))}}}))}}tryUnbindTransportEvents(){this.transportEventReceiver&&this.transportEventReceiver.transport&&(this.transportEventReceiver.transport.onstatechange=null,this.transportEventReceiver.transport.onerror=null,this.transportEventReceiver.transport.iceTransport&&(this.transportEventReceiver.transport.iceTransport.onstatechange=null))}async updateRtpSenderEncodings(L,k){var M,U,V,F,B,j,G,X;if(!k){let M=this.peerConnection.getSenders();k=M.find(k=>k.track===L._mediaStreamTrack)}if(!k)return gc.warn("[".concat(L.getTrackId(),"] no rtpSender found}"));if(this.isVP8Simulcast(L))return gc.warn("[updateRtpSenderEncodings] Track is VP8 simulcast, please apply simulcast encodings");if(!gf.supportSetRtpSenderParameters)return gc.warn("[updateRtpSenderEncodings] Browser not support set rtp-sender parameters");let $={},ee={};switch(L._optimizationMode){case"motion":$.degradationPreference="maintain-framerate";break;case"detail":$.degradationPreference="maintain-resolution";break;case"balanced":$.degradationPreference="balanced"}let et=(j=this.peerConnection,G=L._mediaStreamTrack,j.getTransceivers().find(L=>L.sender.track===G||L.receiver.track===G)),ei=JP(L);if(!(!wN("ENABLE_AG_ADAPTATION")||!(L instanceof T_||so(X=L._hints).call(X,gL.CUSTOM_TRACK))||!wN("FORCE_SUPPORT_AG_ADAPTATION")&&!(lw(14,0,!1)&&uw(17,4,!0)||dw(14)&&hw(17,4,!0)))&&et&&k&&ei&&this.getLocalVideoStats&&so(M=["vp8","vp9"]).call(M,this.store.codec)){let M=$.degradationPreference||(so(V=L._hints).call(V,gL.CUSTOM_TRACK)?wN("CUSTOM_ADAPTATION_DEFAULT_MODE"):"maintain-framerate");!function(L,k,M,U,V,F){if(EB(L,M),V(k),"balanced"!==U&&"maintain-framerate"!==U&&"maintain-resolution"!==U)return;let B=-1;dB(L,k);let j=window.setInterval(()=>{let j=IK.get(L);if(!wN("ENABLE_AG_ADAPTATION")||!j)return EB(L,M),void V(k);let G=F();if(G.sendPackets>0&&G.OutgoingAvailableBandwidth>0){if(-1===B)return void(B=Date.now());if(Date.now()-B<1e3)return;let F=G.sendFrameRate,X=G.OutgoingAvailableBandwidth,[$,ee]=uB(L,F,X,j.adaptationConfig,k,U);ee&&(M.qualityLimitationReason=ee),$&&j.adaptationConfig.scale!==$.scale&&(gc.debug("[".concat(L,"] applyAdaptation: ").concat(M.qualityLimitationReason,"\n           sendFps ").concat(F,", bwe ").concat(X,", switch from ").concat(j.adaptationConfig.scale," to ").concat($.scale," ")),j.adaptationConfig=pB(pB({},j.adaptationConfig),$),V($))}},wN("CHECK_LOCAL_STATS_INTERVAL")),G=pB({},k);IK.set(L,{timer:j,adaptationConfig:G,originConfig:k,adaptationFunc:V}),gc.debug("[".concat(L,"] start adaptation, originConfig: ").concat(JSON.stringify(k),", degradationPreference: ").concat(U))}(this.id+et.mid,ei,this,M,L=>{k&&this.updateAdaptation(k,L)},this.getLocalVideoStats.bind(this))}if(L._encoderConfig){let{bitrateMax:k,frameRate:M,scaleResolutionDownBy:U}=L._encoderConfig;k&&(ee.maxBitrate=1e3*k),(so(F=L._hints).call(F,gL.LOW_STREAM)||L.isUseScaleResolutionDownBy)&&(M&&(ee.maxFramerate=ox(M)),U&&U>=1&&(ee.scaleResolutionDownBy=U))}let{maxFramerate:er}=wN("ENCODER_CONFIG_LIMIT");if(er&&"number"==typeof er&&(ee.maxFramerate=ee.maxFramerate?Math.min(ee.maxFramerate,er):er),wN("DSCP_TYPE")&&vw()){let L=wN("DSCP_TYPE");so(B=["very-low","low","medium","high"]).call(B,L)&&(ee.networkPriority=L)}let en=k.getParameters(),ea=null===(U=en.encodings)||void 0===U?void 0:U[0];iw()&&!ea&&($.encodings=[ee]),ea&&Object.assign(ea,ee),Object.assign(en,$),gc.debug("[".concat(L.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(en.encodings))),await k.setParameters(en),await async function(L,k,M){try{var U;if(!gf.supportSetRtpSenderParameters||"vp9"!==L&&"av1"!==L||!wN("ENABLE_SVC"))return;let V={},F=k.getParameters(),B=null===(U=F.encodings)||void 0===U?void 0:U[0];V.scalabilityMode=px(M),B&&Object.assign(B,V),Object.assign(F,{}),await k.setParameters(F),gc.debug("[updateAdaptation] updateRtpSenderEncodings scalabilityMode success: ".concat(JSON.stringify(F.encodings)))}catch(L){gc.debug("[updateAdaptation] updateRtpSenderEncodings scalabilityMode failed",L)}}(this.store.codec,k,wN("SVC_MODE"))}async updateAdaptation(L,k){var M,U;if(!L)return gc.debug("[updateAdaptation] no rtpSender found");if(!gf.supportSetRtpSenderParameters)return gc.debug("[updateAdaptation] Browser not support set rtp-sender parameters");let V={},{bitrateMax:F,frameRate:B,scaleResolutionDownBy:j}=k;F&&(V.maxBitrate=1e3*F),B&&(V.maxFramerate=ox(B)),j&&j>=1&&so(M=["vp8","vp9"]).call(M,this.store.codec)&&(V.scaleResolutionDownBy=j);let G=L.getParameters(),X=null===(U=G.encodings)||void 0===U?void 0:U[0];X&&Object.assign(X,V),Object.assign(G,{});try{await L.setParameters(G),gc.debug("[updateAdaptation] updateRtpSenderEncodings: ".concat(JSON.stringify(G.encodings)))}catch(k){"transport"in L&&(!L.transport||"connected"!==L.transport.state)?gc.debug("[updateAdaptation] rtpSender transport not connected}"):"connected"!==this.peerConnectionState?gc.debug("[updateAdaptation] peerConnection not connected}"):gc.debug("[updateAdaptation] updateRtpSenderEncodings failed",k)}}async applySendEncodings(L,k){try{if(!gf.supportSetRtpSenderParameters||L.length!==k.length)return;for(let M=0;M<L.length;M++){let U=L[M],V=k[M];V instanceof Tp&&!this.isVP8Simulcast(V)&&await this.updateRtpSenderEncodings(V,U.sender)}}catch(L){gc.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(L,k,M){let U=FN(L);return k.forEach((L,k)=>{let V=M[k],F=U.mediaDescriptions.find(L=>L.attributes.mid===V);F&&(Ax(F,L),Px(F,L,this.store.codec))}),BN(U)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=L=>{var k;null===(k=this.onFirstAudioReceived)||void 0===k||k.call(this,L)},this.statsFilter.onFirstVideoReceived=L=>{var k;null===(k=this.onFirstVideoReceived)||void 0===k||k.call(this,L)},this.statsFilter.onFirstAudioDecoded=L=>{var k;null===(k=this.onFirstAudioDecoded)||void 0===k||k.call(this,L)},this.statsFilter.onFirstVideoDecoded=(L,k,M)=>{var U;null===(U=this.onFirstVideoDecoded)||void 0===U||U.call(this,L,k,M)},this.statsFilter.onSelectedLocalCandidateChanged=(L,k)=>{var M;null===(M=this.onSelectedLocalCandidateChanged)||void 0===M||M.call(this,L,k)},this.statsFilter.onSelectedRemoteCandidateChanged=(L,k)=>{var M;null===(M=this.onSelectedRemoteCandidateChanged)||void 0===M||M.call(this,L,k)},this.statsFilter.onFirstVideoDecodedTimeout=L=>{var k;null===(k=this.onFirstVideoDecodedTimeout)||void 0===k||k.call(this,L)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(L,k){if(L.length===k.length)for(let j=0;j<L.length;j++){var M,U,V,F,B;let G=L[j],X=k[j];if(X instanceof Tp&&!so(M=X._hints).call(M,gL.LOW_STREAM)&&null!==(U=X._encoderConfig)&&void 0!==U&&U.bitrateMax&&(null===(V=X._encoderConfig)||void 0===V?void 0:V.bitrateMax)>200&&null!==(F=X._scalabilityMode)&&void 0!==F&&F.numSpatialLayers&&(null===(B=X._scalabilityMode)||void 0===B?void 0:B.numSpatialLayers)>1&&"vp8"===this.store.codec){let L={},k={high:1e3*(X._encoderConfig.bitrateMax-50),medium:5e4};L.encodings=[{rid:"m",active:!0,maxBitrate:k.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:k.high}];let M=G.sender.getParameters();await G.sender.setParameters(Object.assign(M,L))}}}async applySimulcastEncodings(L,k){if(!iw()&&L.length===k.length)for(let M=0;M<L.length;M++){let U=k[M];if(U instanceof Tp&&this.isVP8Simulcast(U)){let k=L[M],V={},F={high:1e3*(U._encoderConfig.bitrateMax-50),medium:5e4};V.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:F.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:F.medium,scaleResolutionDownBy:4}];let B=k.sender.getParameters();await k.sender.setParameters(Object.assign(B,V))}}}isVP8Simulcast(L){var k,M,U,V,F;return!!(L instanceof Tp&&wN("SIMULCAST")&&"vp8"===this.store.codec&&!so(k=L._hints).call(k,gL.LOW_STREAM)&&null!==(M=L._encoderConfig)&&void 0!==M&&M.bitrateMax&&(null===(U=L._encoderConfig)||void 0===U?void 0:U.bitrateMax)>200&&null!==(V=L._scalabilityMode)&&void 0!==V&&V.numSpatialLayers&&(null===(F=L._scalabilityMode)||void 0===F?void 0:F.numSpatialLayers)>1)}logSDPExchange(L,k,M,U){if(wN("SDP_LOGGING"))return gc.upload("[".concat(this.store.clientId,"] exchanging ").concat(M," ").concat(k," SDP during P2PConnection.").concat(U,"\n"),L),"offer"===k?L=>{this.logSDPExchange(L,"answer","local"===M?"remote":"local",U)}:void 0}async getRemoteSSRC(L){if(!this.remoteSDP)return;let k=this.remoteSDP.getSSRC(L);return k&&0!==k.length?k[0].ssrcId:void 0}setConfiguration(L){if(gf.supportPCSetConfiguration){let k=e.resolvePCConfiguration(L);this.peerConnection.setConfiguration(k)}L.isPreallocation&&(this.isPreallocation=!0)}}).prototype,"updateRemoteRTPCapabilities",[AB],Object.getOwnPropertyDescriptor(nt.prototype,"updateRemoteRTPCapabilities"),nt.prototype),OU(nt.prototype,"connect",[AB],Object.getOwnPropertyDescriptor(nt.prototype,"connect"),nt.prototype),OU(nt.prototype,"updateRemoteConnect",[AB],Object.getOwnPropertyDescriptor(nt.prototype,"updateRemoteConnect"),nt.prototype),OU(nt.prototype,"createDataChannels",[AB],Object.getOwnPropertyDescriptor(nt.prototype,"createDataChannels"),nt.prototype),OU(nt.prototype,"receive",[AB],Object.getOwnPropertyDescriptor(nt.prototype,"receive"),nt.prototype),OU(nt.prototype,"batchReceive",[AB],Object.getOwnPropertyDescriptor(nt.prototype,"batchReceive"),nt.prototype),OU(nt.prototype,"stopReceiving",[AB],Object.getOwnPropertyDescriptor(nt.prototype,"stopReceiving"),nt.prototype),OU(nt.prototype,"muteRemote",[AB],Object.getOwnPropertyDescriptor(nt.prototype,"muteRemote"),nt.prototype),OU(nt.prototype,"unmuteRemote",[AB],Object.getOwnPropertyDescriptor(nt.prototype,"unmuteRemote"),nt.prototype),OU(nt.prototype,"muteLocal",[AB],Object.getOwnPropertyDescriptor(nt.prototype,"muteLocal"),nt.prototype),OU(nt.prototype,"unmuteLocal",[AB],Object.getOwnPropertyDescriptor(nt.prototype,"unmuteLocal"),nt.prototype),OU(nt.prototype,"close",[AB],Object.getOwnPropertyDescriptor(nt.prototype,"close"),nt.prototype),OU(nt.prototype,"updateEncoderConfig",[AB],Object.getOwnPropertyDescriptor(nt.prototype,"updateEncoderConfig"),nt.prototype),OU(nt.prototype,"updateSendParameters",[AB],Object.getOwnPropertyDescriptor(nt.prototype,"updateSendParameters"),nt.prototype),OU(nt.prototype,"replaceTrack",[AB],Object.getOwnPropertyDescriptor(nt.prototype,"replaceTrack"),nt.prototype),OU(nt.prototype,"updateAdaptation",[AB],Object.getOwnPropertyDescriptor(nt.prototype,"updateAdaptation"),nt.prototype),OU(nt.prototype,"getRemoteSSRC",[AB],Object.getOwnPropertyDescriptor(nt.prototype,"getRemoteSSRC"),nt.prototype),nt);function AB(L,k,M){let U=L[k];if("function"!=typeof U)throw Error("Cannot use mutex on object property.");return M.value=async function(){let L=this.mutex,M=await L.lock("From P2PConnection.".concat(k));try{for(var V=arguments.length,F=Array(V),B=0;B<V;B++)F[B]=arguments[B];return await U.apply(this,F)}finally{M()}},M}function wB(L,k){let M=document.createElement("video"),U=document.createElement("canvas");M.setAttribute("style","display:none"),U.setAttribute("style","display:none"),M.setAttribute("muted",""),M.muted=!0,M.setAttribute("autoplay",""),M.autoplay=!0,M.setAttribute("playsinline",""),U.width=ox(k.width),U.height=ox(k.height);let V=ox(k.framerate||15);document.body.append(M),document.body.append(U);let F=L._mediaStreamTrack;M.srcObject=new MediaStream([F]),M.play();let B=U.getContext("2d");if(!B)throw new ED(f1.UNEXPECTED_ERROR,"can not get canvas context");let j=U.captureStream(gf.supportRequestFrame?0:V).getVideoTracks()[0];j.canvas||(j.canvas=U),U.startCapture=()=>{if(!M)return U.stopCapture&&U.stopCapture();if(M.paused&&M.play(),M.videoHeight>2&&M.videoWidth>2){let L=M.videoWidth,k=M.videoHeight/L,V=U.width*k;Math.abs(V-U.height)>=2&&(gc.debug("adjust low stream resolution","".concat(U.width,"x").concat(U.height," -> ").concat(U.width,"x").concat(V)),U.height=V)}B.drawImage(M,0,0,U.width,U.height),j.requestFrame&&j.requestFrame(),F!==L._mediaStreamTrack&&(F=L._mediaStreamTrack,M.srcObject=new MediaStream([F]))},U.stopCapture=SP(()=>U.startCapture&&U.startCapture(),V);let G=j.stop;return j.stop=()=>{G.call(j),M&&(M.remove(),M.srcObject=null,M=null),U&&(U.width=0,U.remove(),U.stopCapture&&U.stopCapture(),U.startCapture=void 0,U.stopCapture=void 0,U=null),gc.debug("clean low stream renderer")},j}var IX=((t3=IX||{})[t3.Video_Send_Type=190]="Video_Send_Type",t3),IQ=((t5=IQ||{})[t5.Video_Send_Qp_Sum=2143]="Video_Send_Qp_Sum",t5[t5.Video_Send_Freeze=2082]="Video_Send_Freeze",t5[t5.Video_Recv_Qp_Sum=2144]="Video_Recv_Qp_Sum",t5[t5.Video_Recv_Freeze=2084]="Video_Recv_Freeze",t5[t5.Video_Render_Freeze_Time=2109]="Video_Render_Freeze_Time",t5[t5.Video_Render_Freeze_Time_Render=2147]="Video_Render_Freeze_Time_Render",t5[t5.Video_Render_Freeze_Time_Render2=2223]="Video_Render_Freeze_Time_Render2",t5[t5.Audio_Recv_Freeze=2083]="Audio_Recv_Freeze",t5),IZ=((t4=IZ||{})[t4.Video_Send_Retransmit=2062]="Video_Send_Retransmit",t4[t4.Video_Send_Target_Encoded=2064]="Video_Send_Target_Encoded",t4[t4.Video_Send_Actual_Encoded=2060]="Video_Send_Actual_Encoded",t4[t4.Video_Send_Transmit=2066]="Video_Send_Transmit",t4[t4.Video_Send_Bandwidth=2061]="Video_Send_Bandwidth",t4[t4.Video_Capture_Height=2033]="Video_Capture_Height",t4[t4.Video_Capture_Width=2035]="Video_Capture_Width",t4[t4.Video_Capture_Frame_Rate=2034]="Video_Capture_Frame_Rate",t4[t4.Video_Send_Low_Height=2073]="Video_Send_Low_Height",t4[t4.Video_Send_Low_Frame_Rate=2075]="Video_Send_Low_Frame_Rate",t4[t4.Video_Send_Low_Width=2077]="Video_Send_Low_Width",t4[t4.Video_Send_Low_Bitrate=2069]="Video_Send_Low_Bitrate",t4[t4.Video_Send_Low_Package_Lost=2070]="Video_Send_Low_Package_Lost",t4[t4.Video_Send_Low_Package_Rate=2071]="Video_Send_Low_Package_Rate",t4[t4.Video_Send_Frame_Rate=2002]="Video_Send_Frame_Rate",t4[t4.Video_Send_Width=2003]="Video_Send_Width",t4[t4.Video_Send_Height=2004]="Video_Send_Height",t4[t4.Video_Send_Disabled=2095]="Video_Send_Disabled",t4[t4.Video_Send_Adaptation=2032]="Video_Send_Adaptation",t4[t4.Video_Send_Player_Status=2128]="Video_Send_Player_Status",t4[t4.Video_Send_Nacks=2009]="Video_Send_Nacks",t4[t4.Video_Send_Plis=2010]="Video_Send_Plis",t4[t4.Video_Send_Firs=2011]="Video_Send_Firs",t4[t4.Video_Send_Avg_Encode=2007]="Video_Send_Avg_Encode",t4[t4.Video_Send_Huge_Frame_Sent=2174]="Video_Send_Huge_Frame_Sent",t4[t4.Video_Send_Bytes_Retransmit=2173]="Video_Send_Bytes_Retransmit",t4[t4.Video_Send_Packages_Retransmit=2172]="Video_Send_Packages_Retransmit",t4[t4.Video_Send_Key_Frames_Encoded=2207]="Video_Send_Key_Frames_Encoded",t4[t4.Video_Send_Bitrate=2012]="Video_Send_Bitrate",t4[t4.Video_Send_Package_Rate=2031]="Video_Send_Package_Rate",t4[t4.Video_Send_Package_Lost=2005]="Video_Send_Package_Lost",t4[t4.Audio_Capture_PCM_Level=2104]="Audio_Capture_PCM_Level",t4[t4.Audio_Send_Level=2038]="Audio_Send_Level",t4[t4.Audio_Send_Bitrate=2039]="Audio_Send_Bitrate",t4[t4.Audio_Send_Package_Rate=2040]="Audio_Send_Package_Rate",t4[t4.Audio_Send_AEC_Return_Loss=2041]="Audio_Send_AEC_Return_Loss",t4[t4.Audio_Send_AEC_Return_Loss_Enhancement=2042]="Audio_Send_AEC_Return_Loss_Enhancement",t4[t4.Audio_Send_Freeze=2081]="Audio_Send_Freeze",t4[t4.Audio_Send_Disabled=2096]="Audio_Send_Disabled",t4[t4.Audio_Send_Bytes_Retransmit=2179]="Audio_Send_Bytes_Retransmit",t4[t4.Audio_Send_Packages_Retransmit=2180]="Audio_Send_Packages_Retransmit",t4[t4.Video_Recv_Height=2019]="Video_Recv_Height",t4[t4.Video_Recv_Width=2018]="Video_Recv_Width",t4[t4.Video_Recv_Frame_Rate_Output=2155]="Video_Recv_Frame_Rate_Output",t4[t4.Video_Recv_Jitter_Buffer=2023]="Video_Recv_Jitter_Buffer",t4[t4.Video_Recv_Current_Delay=2024]="Video_Recv_Current_Delay",t4[t4.Video_Recv_Nacks=2026]="Video_Recv_Nacks",t4[t4.Video_Recv_Plis=2027]="Video_Recv_Plis",t4[t4.Video_Recv_Firs=2028]="Video_Recv_Firs",t4[t4.Video_Recv_Disabled=2101]="Video_Recv_Disabled",t4[t4.Video_Recv_Player_Status=2129]="Video_Recv_Player_Status",t4[t4.Video_Recv_I_Frame_Delay=2149]="Video_Recv_I_Frame_Delay",t4[t4.Video_Render_Frame_Rate_Render=2022]="Video_Render_Frame_Rate_Render",t4[t4.Video_Render_Freeze_Duration=2156]="Video_Render_Freeze_Duration",t4[t4.Audio_Render_Level=2043]="Audio_Render_Level",t4[t4.Audio_Render_Freeze_Time_80ms=2226]="Audio_Render_Freeze_Time_80ms",t4[t4.Audio_Render_Freeze_Time_200ms=2227]="Audio_Render_Freeze_Time_200ms",t4[t4.Audio_Render_Freeze_Samples_80ms=2228]="Audio_Render_Freeze_Samples_80ms",t4[t4.Audio_Render_Freeze_Samples_200ms=2229]="Audio_Render_Freeze_Samples_200ms",t4[t4.Audio_Recv_PCM_Level=2105]="Audio_Recv_PCM_Level",t4[t4.Audio_Recv_Disabled=2102]="Audio_Recv_Disabled",t4[t4.Audio_Recv_Jitter_Buffer=2054]="Audio_Recv_Jitter_Buffer",t4[t4.Audio_Recv_Current_Delay=2047]="Audio_Recv_Current_Delay",t4[t4.Audio_Recv_Player_Status=2130]="Audio_Recv_Player_Status",t4[t4.Audio_Recv_Bitrate=2044]="Audio_Recv_Bitrate",t4[t4.Audio_Recv_Concealed_Samples=2148]="Audio_Recv_Concealed_Samples",t4[t4.Audio_Recv_Total_Samples_Received=2224]="Audio_Recv_Total_Samples_Received",t4),I$=((t6=I$||{})[t6.Video_Render_Frame_Rate_Decode=2021]="Video_Render_Frame_Rate_Decode",t6[t6.Video_Recv_Frame_Rate=2020]="Video_Recv_Frame_Rate",t6[t6.Video_Recv_Frame_Dropped=2181]="Video_Recv_Frame_Dropped",t6[t6.Video_Recv_Bytes_Retransmit=2175]="Video_Recv_Bytes_Retransmit",t6[t6.Video_Recv_Packages_Retransmit=2176]="Video_Recv_Packages_Retransmit",t6[t6.Video_Recv_Packages_Discarded=2198]="Video_Recv_Packages_Discarded",t6[t6.Video_Recv_Avg_Decode=2200]="Video_Recv_Avg_Decode",t6[t6.Video_Recv_Avg_Processing_Delay=2202]="Video_Recv_Avg_Processing_Delay",t6[t6.Video_Recv_Avg_Assembly_Time=2203]="Video_Recv_Avg_Assembly_Time",t6[t6.Video_Recv_Avg_Inter_Frame_Delay=2204]="Video_Recv_Avg_Inter_Frame_Delay",t6[t6.Video_Recv_Key_Frames_Decoded=2206]="Video_Recv_Key_Frames_Decoded",t6[t6.Video_Recv_Package_Lost=2014]="Video_Recv_Package_Lost",t6[t6.Video_Recv_Bitrate=2029]="Video_Recv_Bitrate",t6[t6.Video_Recv_Package_Rate=2078]="Video_Recv_Package_Rate",t6[t6.Audio_Recv_Jitter=2055]="Audio_Recv_Jitter",t6[t6.Audio_Recv_Bytes_Retransmit=2178]="Audio_Recv_Bytes_Retransmit",t6[t6.Audio_Recv_Packages_Retransmit=2177]="Audio_Recv_Packages_Retransmit",t6[t6.Audio_Recv_Packages_Discarded=2199]="Audio_Recv_Packages_Discarded",t6[t6.Audio_Recv_Avg_Processing_Delay=2201]="Audio_Recv_Avg_Processing_Delay",t6[t6.Audio_Recv_Package_Rate=2046]="Audio_Recv_Package_Rate",t6[t6.Audio_Recv_Package_Lost=2045]="Audio_Recv_Package_Lost",t6),I0=((t8=I0||{})[t8.RTT=2006]="RTT",t8[t8.CONN_TYPE=801]="CONN_TYPE",t8[t8.STATS_UPDATE_INTERVAL=2205]="STATS_UPDATE_INTERVAL",t8),I1=((t9=I1||{})[t9.RTC_PEER_CONNECTION_STATE=2219]="RTC_PEER_CONNECTION_STATE",t9);function FB(L,k,M){null!=M&&Number.isFinite(M)&&(L[k]=Math.round(Math.max(0,M)))}function BB(L){let k={[I0.CONN_TYPE]:0,[I0.RTT]:L.rtt,[I0.STATS_UPDATE_INTERVAL]:L.updateInterval?Math.round(Math.max(0,L.updateInterval)):void 0};switch(L.selectedCandidatePair.localCandidate.candidateType){case"relay":{let M=L.selectedCandidatePair.localCandidate.relayProtocol;"udp"===M&&(k[I0.CONN_TYPE]=1),"tcp"===M&&(k[I0.CONN_TYPE]=3),"tls"===M&&(k[I0.CONN_TYPE]=4);break}case"srflx":k[I0.CONN_TYPE]=2;break;case"unknown":k[I0.CONN_TYPE]=5;break;default:k[I0.CONN_TYPE]=0}return k}function jB(L){let k=0;switch(L){case"none":k=0;break;case"cpu":k=1;break;case"bandwidth":k=2;break;case"other":k=3}return k}let GB=class GB extends Hw{constructor(L){super(),uI(this,"store",void 0),uI(this,"uploadWRTCStatsTimer",void 0),uI(this,"uploadOutboundDenoiserStatsTimer",void 0),uI(this,"uploadExtStatsTimer",void 0),uI(this,"uploadExtUsageStatsTimer",void 0),uI(this,"uploadInboundExtStatsTimer",void 0),uI(this,"requestStats",void 0),uI(this,"requestTransportStats",void 0),uI(this,"requestLocalMedia",void 0),uI(this,"requestRemoteMedia",void 0),uI(this,"requestAllTracks",void 0),uI(this,"requestVideoIsReady",void 0),uI(this,"requestUploadStats",void 0),uI(this,"requestUpload",void 0),uI(this,"uploadOutboundStarted",!1),uI(this,"uploadInboundStarted",!1),uI(this,"uploadTransportStarted",!1),uI(this,"uploadBaseStatsStarted",!1),uI(this,"uploadExtensionUsageStarted",!1),uI(this,"lastRecvStats",void 0),uI(this,"lastSendStats",void 0),uI(this,"lastRefRecvStats",void 0),uI(this,"lastRefSendStats",void 0),uI(this,"lastNormalRecvStats",void 0),uI(this,"lastNormalSendStats",void 0),uI(this,"lastExtendStats",{}),uI(this,"needUploadStats",{}),uI(this,"needUploadRenderFreezeTime",!0),uI(this,"lastUploadCompensateTime",-1),uI(this,"uploadCompensateDeltaTime",0),this.store=L}uploadWRTCStats(L){let k,M;if(!this.requestStats||!this.requestUploadStats)return;let U=L%3==0,V=L%6==0,F=L%60==0;if(this.uploadTransportStarted&&(k=this.requestStats(),this.store.useP2P&&(M=this.requestStats(!0))),!k&&this.uploadOutboundStarted&&(k=this.requestStats()),!M&&this.uploadInboundStarted&&(M=this.requestStats(!0)),k||M){var B;let j={};if(this.uploadTransportStarted&&k){let L=this.getTransportStats(k,M,U);L&&(j.misc=[L])}if(this.uploadOutboundStarted&&k){let L=this.getOutboundStats(k,V?this.lastNormalSendStats:void 0,U?this.lastRefSendStats:void 0,this.lastSendStats,F);L&&(j.outbound=[L])}if(this.uploadInboundStarted&&M){this.uploadCompensateStats(L);let k=this.getInboundStats(M,V?this.lastNormalRecvStats:void 0,U?this.lastRefRecvStats:void 0,this.lastRecvStats);k&&(j.inbound=k)}let G=null===(B=this.requestTransportStats)||void 0===B?void 0:B.call(this).connectState;G&&(Array.isArray(j.misc)?j.misc[0]&&j.misc[0].addition&&(j.misc[0].addition[I1.RTC_PEER_CONNECTION_STATE]=SW[G]):j.misc=[{addition:{[I1.RTC_PEER_CONNECTION_STATE]:SW[G]}}]),this.needUploadStats.sendType&&(Array.isArray(j.outbound)&&j.outbound[0]&&j.outbound[0].high&&(j.outbound[0].high[IX.Video_Send_Type]=this.needUploadStats.sendType),this.needUploadStats.sendType=void 0),this.requestUploadStats(j)}this.lastRecvStats=M,this.lastSendStats=k,V&&(this.lastNormalRecvStats=M,this.lastNormalSendStats=k),U&&(this.lastRefRecvStats=M,this.lastRefSendStats=k)}startUploadWRTCStats(){if(this.uploadWRTCStatsTimer)return;this.uploadBaseStatsStarted=!0;let L=1;this.uploadWRTCStatsTimer=window.setInterval(()=>{if(!this.uploadTransportStarted&&!this.uploadInboundStarted&&!this.uploadOutboundStarted){if(this.uploadBaseStatsStarted){var k,M;let L=null===(k=this.requestTransportStats)||void 0===k?void 0:k.call(this);return void(L&&(null===(M=this.requestUploadStats)||void 0===M||M.call(this,{misc:[{addition:{[I1.RTC_PEER_CONNECTION_STATE]:SW[L.connectState]}}]})))}return this.stopUploadWRTCStats()}this.uploadWRTCStats(L),61==++L&&(L=1)},1e3)}uploadCompensateStats(L){if(!this.requestStats||!this.requestUploadStats||!this.requestRemoteMedia)return;let k=L%3==0&&this.needUploadRenderFreezeTime;if(!this.uploadInboundStarted||!k)return;if(-1===this.lastUploadCompensateTime)return void(this.lastUploadCompensateTime=Date.now());let M=Math.max(-6e3,Date.now()-this.lastUploadCompensateTime-6e3);if(this.uploadCompensateDeltaTime+=M,this.lastUploadCompensateTime=Date.now(),this.uploadCompensateDeltaTime<6e3)return;let U=Math.min(Math.floor(this.uploadCompensateDeltaTime/6e3),10);this.uploadCompensateDeltaTime-=6e3*U;let V=this.requestStats(!0);Array(U).fill(0).forEach(()=>{if(!this.requestStats||!this.requestUploadStats||!this.requestRemoteMedia)return;let L={};if(this.uploadInboundStarted&&V){let k=this.requestRemoteMedia()||[],M=[];k.forEach(L=>{let[k,U]=L,F={peer:k.uid};if(k._videoSSRC&&this.requestVideoIsReady&&this.requestVideoIsReady(k._videoSSRC)&&U.has(R1.VIDEO)&&k.videoTrack){let L=function(L,k,M){if(!k.videoRecv.find(k=>k.ssrc===L))return;let U={};if(M&&M._player){let L=M._player,{renderFreezeAccTime2:k,videoElementStatus:V}=L;if("visible"===TS.visibility&&V===g1.PLAYING&&gf.supportRequestVideoFrameCallback){let M=Math.min(6e3,k);L.renderFreezeAccTime2=Math.max(0,k-M),FB(U,IQ.Video_Render_Freeze_Time_Render2,M),wN("USE_NEW_RENDER_FREEZE_TIME")&&FB(U,IQ.Video_Render_Freeze_Time_Render,M)}}return U}(k._videoSSRC,V,k.videoTrack);L&&(F.video=L)}F.video&&M.push(F)}),M.length>0&&(L.inbound=M,this.requestUploadStats(L))}})}stopUploadWRTCStats(){window.clearInterval(this.uploadWRTCStatsTimer),this.uploadWRTCStatsTimer=void 0,this.lastSendStats&&(this.lastSendStats.videoSend=[],this.lastSendStats.audioSend=[],this.lastSendStats=void 0),this.lastRecvStats&&(this.lastRecvStats.videoRecv=[],this.lastRecvStats.audioRecv=[],this.lastRecvStats=void 0),this.lastRefSendStats&&(this.lastRefSendStats.videoSend=[],this.lastRefSendStats.audioSend=[],this.lastRefSendStats=void 0),this.lastRefRecvStats&&(this.lastRefRecvStats.videoRecv=[],this.lastRefRecvStats.audioRecv=[],this.lastRefRecvStats=void 0),this.lastNormalSendStats&&(this.lastNormalSendStats.videoSend=[],this.lastNormalSendStats.audioSend=[],this.lastNormalSendStats=void 0),this.lastNormalRecvStats&&(this.lastNormalRecvStats.videoRecv=[],this.lastNormalRecvStats.audioRecv=[],this.lastNormalRecvStats=void 0),this.lastExtendStats={},this.needUploadStats={},this.lastUploadCompensateTime=-1,this.uploadCompensateDeltaTime=0,this.needUploadRenderFreezeTime=!0}getTransportStats(L,k,M){if(!this.requestStats)return;if(!M)return null==L.rtt?void 0:{addition:{[I0.RTT]:L.rtt,[I0.CONN_TYPE]:void 0,[I0.STATS_UPDATE_INTERVAL]:L.updateInterval||void 0}};let U=BB(L);if(this.store.useP2P){if(k){let L=BB(k);U[I0.CONN_TYPE]+=L[I0.CONN_TYPE]<<3}U[I0.CONN_TYPE]+=110}else U[I0.CONN_TYPE]+=100;return{addition:U}}getOutboundStats(L,k,M,U,V){let F,B,j;if(!this.requestUploadStats||!this.requestLocalMedia)return;let G=this.requestLocalMedia();if(G&&0!==G.length)return G.forEach(U=>{let[G,{track:X,ssrcs:$}]=U;switch(G){case R4.LocalVideoLowTrack:case R4.LocalVideoTrack:if(G===R4.LocalVideoTrack){var ee;let U=function(L,k,M,U,V,F){let B=k.videoSend.find(k=>k.ssrc===L);if(!B)return;let j={},{sentFrame:G,inputFrame:X}=B;if(U&&(FB(j,IQ.Video_Send_Qp_Sum,B.qpSumPerFrame),X&&G)){let L=X.frameRate,k=G.frameRate;j[IQ.Video_Send_Freeze]=!(L<=5)&&(L<=10?k<3:L<=20?k<4:k<5)?1:0}if(V){switch(G&&(FB(j,IZ.Video_Send_Height,G.height),FB(j,IZ.Video_Send_Width,G.width),FB(j,IZ.Video_Send_Frame_Rate,G.frameRate)),j[IZ.Video_Send_Disabled]=M._originMediaStreamTrack&&!M._originMediaStreamTrack.enabled||M._mediaStreamTrack&&!M._mediaStreamTrack.enabled?1:0,B.adaptionChangeReason){case"none":j[IZ.Video_Send_Adaptation]=0;break;case"cpu":j[IZ.Video_Send_Adaptation]=1;break;case"bandwidth":j[IZ.Video_Send_Adaptation]=2;break;case"other":j[IZ.Video_Send_Adaptation]=3}let U=0;B.adaptionChangeReason&&(U+=jB(B.adaptionChangeReason)),k.qualityLimitationReason&&(U+=jB(k.qualityLimitationReason)<<3),j[IZ.Video_Send_Adaptation]=U,j[IZ.Video_Send_Player_Status]=g3[M._player?M._player.videoElementStatus:"uninit"],FB(j,IZ.Video_Send_Nacks,B.nacksCount),FB(j,IZ.Video_Send_Plis,B.plisCount),FB(j,IZ.Video_Send_Firs,B.firsCount),FB(j,IZ.Video_Send_Avg_Encode,B.avgEncodeMs),FB(j,IZ.Video_Send_Huge_Frame_Sent,B.hugeFramesSent),FB(j,IZ.Video_Send_Bytes_Retransmit,B.retransmittedBytesSent),FB(j,IZ.Video_Send_Packages_Retransmit,B.retransmittedPacketsSent),FB(j,IZ.Video_Send_Key_Frames_Encoded,B.keyFramesEncoded);let F=V.videoSend.find(k=>k.ssrc===L);if(F){let L=3e3;F.timestamp&&B.timestamp&&(L=B.timestamp-F.timestamp),null!=F.packets&&null!=B.packets&&FB(j,IZ.Video_Send_Package_Rate,1e3*(B.packets-F.packets)/L),null!=B.packetsLost&&null!=F.packetsLost&&FB(j,IZ.Video_Send_Package_Lost,B.packetsLost-F.packetsLost),null!=F.bytes&&null!=B.bytes&&FB(j,IZ.Video_Send_Bitrate,8*(B.bytes-F.bytes)/L)}}return j}($[0].ssrcId,L,X,k,M),F="CameraVideoTrack"===X.__className__?3:so(ee=X._hints).call(ee,gL.SCREEN_TRACK)?7:10;(this.lastExtendStats.sendType!==F||V)&&(this.needUploadStats={sendType:F},this.lastExtendStats.sendType=F);let j=X&&function(L,k,M,U){let V=k.videoSend.find(k=>k.ssrc===L);if(!V)return null;let F={};if(U){let L=V.inputFrame,k=L&&L.height||M.videoHeight||0,U=L&&L.width||M.videoWidth||0,B=L&&L.frameRate||0;FB(F,IZ.Video_Capture_Height,k),FB(F,IZ.Video_Capture_Width,U),FB(F,IZ.Video_Capture_Frame_Rate,B)}return F}($[0].ssrcId,L,X,!!M),G=function(L,k){let M={};return k&&(FB(M,IZ.Video_Send_Retransmit,L.bitrate.retransmit),FB(M,IZ.Video_Send_Target_Encoded,L.bitrate.targetEncoded),FB(M,IZ.Video_Send_Actual_Encoded,L.bitrate.actualEncoded),FB(M,IZ.Video_Send_Transmit,L.bitrate.transmit),FB(M,IZ.Video_Send_Bandwidth,L.sendBandwidth)),M}(L,!!M);B=Object.assign({},U,j,G)}else j=function(L,k,M,U,V){let F=k.videoSend.find(k=>k.ssrc===L);if(!F)return;let B={};if(U){let k=F.sentFrame;k&&(FB(B,IZ.Video_Send_Low_Height,k.height),FB(B,IZ.Video_Send_Low_Width,k.width),FB(B,IZ.Video_Send_Low_Frame_Rate,k.frameRate));let M=U.videoSend.find(k=>k.ssrc===L);if(M){let L=6e3;M.timestamp&&F.timestamp&&(L=F.timestamp-M.timestamp),null!=M.packets&&null!=F.packets&&FB(B,IZ.Video_Send_Low_Package_Rate,1e3*(F.packets-M.packets)/L),null!=F.packetsLost&&null!=M.packetsLost&&FB(B,IZ.Video_Send_Low_Package_Lost,F.packetsLost-M.packetsLost),null!=M.bytes&&null!=F.bytes&&FB(B,IZ.Video_Send_Low_Bitrate,8*(F.bytes-M.bytes)/L)}}return B}($[0].ssrcId,L,0,M);break;case R4.LocalAudioTrack:F=X&&function(L,k,M,U,V,F){let B=k.audioSend.find(k=>k.ssrc===L);if(!B)return;let j={};if(V){j[IZ.Audio_Send_Disabled]=M._originMediaStreamTrack&&!M._originMediaStreamTrack.enabled||M._mediaStreamTrack&&!M._mediaStreamTrack.enabled?1:0;let k=100*M._source.getAccurateVolumeLevel(),U=B.inputLevel;null!=U&&FB(j,IZ.Audio_Send_Level,Math.ceil(50*Math.log10(100*U+1))),FB(j,IZ.Audio_Capture_PCM_Level,k),FB(j,IZ.Audio_Send_AEC_Return_Loss,B.aecReturnLoss),FB(j,IZ.Audio_Send_AEC_Return_Loss_Enhancement,B.aecReturnLossEnhancement),FB(j,IZ.Audio_Send_Bytes_Retransmit,B.retransmittedBytesSent),FB(j,IZ.Audio_Send_Packages_Retransmit,B.retransmittedPacketsSent),j[IZ.Audio_Send_Freeze]=0;let F=V.audioSend.find(k=>k.ssrc===L);if(F){let L=6e3;F.timestamp&&B.timestamp&&(L=B.timestamp-F.timestamp),null!=F.bytes&&null!=B.bytes&&FB(j,IZ.Audio_Send_Bitrate,8*(B.bytes-F.bytes)/L),null!=F.packets&&null!=B.packets&&FB(j,IZ.Audio_Send_Package_Rate,1e3*(B.packets-F.packets)/L)}}return j}($[0].ssrcId,L,X,0,M)}}),{high:B,low:j,audio:F}}getInboundStats(L,k,M,U){if(!this.requestRemoteMedia)return;let V=this.requestRemoteMedia()||[],F=[];return V.forEach(V=>{let[B,j]=V,G={peer:B.uid};if(j.has(R1.VIDEO)&&B.videoTrack){let V=B._videoSSRC&&this.requestVideoIsReady&&this.requestVideoIsReady(B._videoSSRC)||!1,F=B.videoTrack?function(L,k,M,U,V,F,B,j){let G=k.videoRecv.find(k=>k.ssrc===L);if(!G)return;let X={},{receivedFrame:$,outputFrame:ee,decodeFrameRate:et}=G;FB(X,I$.Video_Render_Frame_Rate_Decode,et),G.framesRateFirefox&&FB(X,I$.Video_Recv_Frame_Rate,G.framesRateFirefox),$&&FB(X,I$.Video_Recv_Frame_Rate,$.frameRate),FB(X,I$.Video_Recv_Frame_Dropped,G.framesDroppedCount),FB(X,I$.Video_Recv_Bytes_Retransmit,G.retransmittedBytesReceived),FB(X,I$.Video_Recv_Packages_Retransmit,G.retransmittedPacketsReceived),FB(X,I$.Video_Recv_Packages_Discarded,G.packetsDiscarded),FB(X,I$.Video_Recv_Avg_Decode,G.avgDecodeMs),FB(X,I$.Video_Recv_Avg_Processing_Delay,G.avgProcessingDelayMs),FB(X,I$.Video_Recv_Avg_Assembly_Time,G.avgFramesAssembledFromMultiplePacketsMs),FB(X,I$.Video_Recv_Avg_Inter_Frame_Delay,G.avgInterFrameDelayMs),FB(X,I$.Video_Recv_Key_Frames_Decoded,G.keyFramesDecoded);let ei=j&&j.videoRecv.find(k=>k.ssrc===L);if(ei){let L=k.timestamp-j.timestamp||1e3;null!=G.packetsLost&&null!=ei.packetsLost&&FB(X,I$.Video_Recv_Package_Lost,G.packetsLost-ei.packetsLost),null!=ei.bytes&&null!=G.bytes&&FB(X,I$.Video_Recv_Bitrate,8*(G.bytes-ei.bytes)/L),null!=ei.packets&&null!=G.packets&&FB(X,I$.Video_Recv_Package_Rate,1e3*(G.packets-ei.packets)/L)}let er=F&&F.videoRecv.find(k=>k.ssrc===L);if(er&&(FB(X,IQ.Video_Recv_Qp_Sum,G.qpSumPerFrame),X[IQ.Video_Recv_Freeze]=U&&XF.isRemoteVideoFreeze(M,G,er)?1:0),B){var en;let k=B.videoRecv.find(k=>k.ssrc===L);$?(FB(X,IZ.Video_Recv_Height,$.height),FB(X,IZ.Video_Recv_Width,$.width)):M&&(FB(X,IZ.Video_Recv_Height,M._videoHeight||0),FB(X,IZ.Video_Recv_Width,M._videoWidth||0)),ee&&FB(X,IZ.Video_Recv_Frame_Rate_Output,ee.frameRate);let U=null===(en=M._player)||void 0===en?void 0:en.rendFrameRate.toFixed(0);if(U&&FB(X,IZ.Video_Render_Frame_Rate_Render,+U),FB(X,IZ.Video_Recv_Jitter_Buffer,G.jitterBufferMs),FB(X,IZ.Video_Recv_Current_Delay,G.currentDelayMs),FB(X,IZ.Video_Recv_Firs,G.firsCount),FB(X,IZ.Video_Recv_Nacks,G.nacksCount),FB(X,IZ.Video_Recv_Plis,G.plisCount),M){X[IZ.Video_Recv_Disabled]=M._originMediaStreamTrack.enabled&&M._mediaStreamTrack.enabled?0:1;let L=M._player;if(L){let{freezeTimeCounterList:M,renderFreezeAccTime:U,renderFreezeAccTime2:F,videoElementStatus:B}=L;if(M&&M.length>0&&FB(X,IQ.Video_Render_Freeze_Time,M.splice(0,1)[0]),V&&"visible"===TS.visibility&&B===g1.PLAYING&&gf.supportRequestVideoFrameCallback){let k=Math.min(6e3,F);L.renderFreezeAccTime2=Math.max(0,F-k),FB(X,IQ.Video_Render_Freeze_Time_Render2,k);let M=Math.min(6e3,U);L.renderFreezeAccTime=Math.max(0,U-M),FB(X,IQ.Video_Render_Freeze_Time_Render,wN("USE_NEW_RENDER_FREEZE_TIME")?k:M)}if("number"==typeof G.totalFreezesDuration){let L=k&&k.totalFreezesDuration?G.totalFreezesDuration-k.totalFreezesDuration:G.totalFreezesDuration;FB(X,IZ.Video_Render_Freeze_Duration,1e3*L)}}}if(X[IZ.Video_Recv_Player_Status]=g3[M._player?M._player.videoElementStatus:"uninit"],k&&void 0!==G.totalInterFrameDelay&&void 0!==G.totalSquaredInterFrameDelay&&void 0!==k.totalInterFrameDelay&&void 0!==k.totalSquaredInterFrameDelay){let L=G.totalInterFrameDelay-k.totalInterFrameDelay,M=G.totalSquaredInterFrameDelay-k.totalSquaredInterFrameDelay,U=G.framesDecodeCount-k.framesDecodeCount,V=L/U*1e3,F=Math.round(1e3*Math.sqrt((M-Math.pow(L,2)/U)/U));!isNaN(F)&&V+F>Math.max(3*V,V+150)&&(X[IZ.Video_Recv_I_Frame_Delay]=F)}}return X}(B._videoSSRC,L,B.videoTrack,!0===V,this.needUploadRenderFreezeTime,k,M,U):void 0;F&&(G.video=F)}if(j.has(R1.AUDIO)&&B.audioTrack){let V=B.audioTrack?function(L,k,M,U,V,F){let B=k.audioRecv.find(k=>k.ssrc===L);if(!B)return;let j={};FB(j,I$.Audio_Recv_Jitter,B.jitterMs),FB(j,I$.Audio_Recv_Bytes_Retransmit,B.retransmittedBytesReceived),FB(j,I$.Audio_Recv_Packages_Retransmit,B.retransmittedPacketsReceived),FB(j,I$.Audio_Recv_Packages_Discarded,B.packetsDiscarded),FB(j,I$.Audio_Recv_Avg_Processing_Delay,B.avgProcessingDelayMs);let G=F&&F.audioRecv.find(k=>k.ssrc===L);if(G&&(null!=B.packets&&null!=G.packets&&FB(j,I$.Audio_Recv_Package_Rate,1e3*(B.packets-G.packets)/1e3),null!=B.packetsLost&&null!=G.packetsLost&&FB(j,I$.Audio_Recv_Package_Lost,B.packetsLost-G.packetsLost)),U){let{receivedFrames:L,droppedFrames:k}=B;null!=L&&null!=k&&(j[IQ.Audio_Recv_Freeze]=0===L||100*k/L>20?1:0)}if(V){let k=100*M._source.getAccurateVolumeLevel(),U=B.outputLevel;null!=U&&FB(j,IZ.Audio_Render_Level,Math.ceil(50*Math.log10(100*U+1))),FB(j,IZ.Audio_Recv_PCM_Level,k),M&&(j[IZ.Audio_Recv_Disabled]=M._originMediaStreamTrack.enabled&&M._mediaStreamTrack.enabled?0:1),FB(j,IZ.Audio_Recv_Jitter_Buffer,B.jitterBufferMs),FB(j,IZ.Audio_Recv_Current_Delay,B.jitterBufferMs),j[IZ.Audio_Recv_Player_Status]=g3[To.getPlayerState(M.getTrackId())];let F=V.audioRecv.find(k=>k.ssrc===L);if(F){null!=F.bytes&&null!=B.bytes&&FB(j,IZ.Audio_Recv_Bitrate,8*(B.bytes-F.bytes)/3e3);let L=B.concealedSamples-F.concealedSamples;L>0&&FB(j,IZ.Audio_Recv_Concealed_Samples,L);let k=B.totalSamplesReceived-F.totalSamplesReceived;k>0&&FB(j,IZ.Audio_Recv_Total_Samples_Received,k);let M=B.freezeSamples80-F.freezeSamples80;M>0&&FB(j,IZ.Audio_Render_Freeze_Samples_80ms,M);let U=B.freezeSamples200-F.freezeSamples200;U>0&&FB(j,IZ.Audio_Render_Freeze_Samples_200ms,U);let V=B.freezeMs80-F.freezeMs80;FB(j,IZ.Audio_Render_Freeze_Time_80ms,V<0?0:V);let G=B.freezeMs200-F.freezeMs200;FB(j,IZ.Audio_Render_Freeze_Time_200ms,G<0?0:G)}}return j}(B._audioSSRC,L,B.audioTrack,k,M,U):void 0;V&&(G.audio=V)}(G.video||G.audio)&&F.push(G)}),this.needUploadRenderFreezeTime=!this.needUploadRenderFreezeTime,F}startUploadTransportStats(){this.uploadTransportStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats()}stopUploadTransportStats(){this.uploadTransportStarted=!1}startUploadOutboundStats(){this.uploadOutboundStarted||(this.uploadOutboundStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats(),this.uploadOutboundDenoiserStatsTimer&&window.clearInterval(this.uploadOutboundDenoiserStatsTimer),this.uploadOutboundDenoiserStatsTimer=window.setInterval(()=>{if(!this.requestAllTracks||!this.requestUpload)return;let L=(this.requestAllTracks()||[]).find(L=>L instanceof Tc);if(L&&L._external.getDenoiserStats){let k=L._external.getDenoiserStats();k&&this.requestUpload(RS.DENOISER_STATS,k)}},2e3),this.uploadExtStatsTimer&&window.clearInterval(this.uploadExtStatsTimer),this.uploadExtStatsTimer=window.setInterval(()=>{this.requestAllTracks&&this.requestUpload&&this.requestAllTracks().forEach(L=>{L.getProcessorStats().forEach(L=>{this.requestUpload&&this.requestUpload(L.type,L.stats)})})},2e3))}stopUploadOutboundStats(){this.uploadOutboundStarted&&(this.uploadOutboundStarted=!1,this.lastSendStats&&(this.lastSendStats.videoSend=[],this.lastSendStats.audioSend=[],this.lastSendStats=void 0),this.lastRefSendStats&&(this.lastRefSendStats.videoSend=[],this.lastRefSendStats.audioSend=[],this.lastRefSendStats=void 0),this.lastNormalSendStats&&(this.lastNormalSendStats.videoSend=[],this.lastNormalSendStats.audioSend=[],this.lastNormalSendStats=void 0),this.lastExtendStats={},this.needUploadStats={},this.uploadOutboundDenoiserStatsTimer&&window.clearInterval(this.uploadOutboundDenoiserStatsTimer),this.uploadOutboundDenoiserStatsTimer=void 0,this.uploadExtStatsTimer&&window.clearInterval(this.uploadExtStatsTimer),this.uploadExtStatsTimer=void 0)}startUploadInboundStats(){this.uploadInboundStarted||(this.uploadInboundStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats(),this.uploadInboundExtStatsTimer&&window.clearInterval(this.uploadInboundExtStatsTimer),this.uploadInboundExtStatsTimer=window.setInterval(()=>{this.requestUpload&&this.requestRemoteMedia&&(this.requestRemoteMedia()||[]).forEach(L=>{let[k,M]=L;M.has(R1.VIDEO)&&k.videoTrack&&k.videoTrack.getProcessorStats().forEach(L=>{this.requestUpload&&this.requestUpload(L.type,L.stats)}),M.has(R1.AUDIO)&&k.audioTrack&&k.audioTrack.getProcessorStats().forEach(L=>{this.requestUpload&&this.requestUpload(L.type,L.stats)})})},2e3))}stopUploadInboundStats(){this.uploadInboundStarted&&(this.uploadInboundStarted=!1,this.lastRecvStats&&(this.lastRecvStats.videoRecv=[],this.lastRecvStats.audioRecv=[],this.lastRecvStats=void 0),this.lastRefRecvStats&&(this.lastRefRecvStats.videoRecv=[],this.lastRefRecvStats.audioRecv=[],this.lastRefRecvStats=void 0),this.lastNormalRecvStats&&(this.lastNormalRecvStats.videoRecv=[],this.lastNormalRecvStats.audioRecv=[],this.lastNormalRecvStats=void 0),this.lastUploadCompensateTime=-1,this.uploadCompensateDeltaTime=0,this.needUploadRenderFreezeTime=!0,this.uploadInboundExtStatsTimer&&window.clearInterval(this.uploadInboundExtStatsTimer),this.uploadInboundExtStatsTimer=void 0)}startUploadExtensionUsageStats(){if(this.uploadExtensionUsageStarted)return;this.uploadExtensionUsageStarted=!0,this.uploadExtUsageStatsTimer&&window.clearInterval(this.uploadExtUsageStatsTimer);let L=new Map;this.uploadExtUsageStatsTimer=window.setInterval(async()=>{let k=Date.now(),M={connectionInterval:wN("EXTENSION_USAGE_UPLOAD_INTERVAL")/1e3,details:[],lts:k},U=[],V=this.requestAllTracks&&this.requestAllTracks()||[];for(let L of V)!L.muted&&L.enabled&&(U=U.concat(await L.getProcessorUsage()));let F=this.requestRemoteMedia&&this.requestRemoteMedia()||[];for(let[L,k]of F)k.has(R1.VIDEO)&&L.videoTrack&&(U=U.concat(await L.videoTrack.getProcessorUsage())),k.has(R1.AUDIO)&&L.audioTrack&&(U=U.concat(await L.audioTrack.getProcessorUsage()));if(0===U.length)return;M.details=function(L,k){let M={};for(let{id:B,value:j,level:G,direction:X}of L){var U,V,F;let L=null!==(U=k.get(B))&&void 0!==U?U:0,$=2===j?L+wN("EXTENSION_USAGE_UPLOAD_INTERVAL")/1e3:L;k.set(B,$),M[B]?(2===j&&(M[B].value=j),G>M[B].level&&(M[B].level=G),"remote"===X&&(M[B].remoteUidCount+=1),M[B].totalTs=null!==(V=k.get(B))&&void 0!==V?V:0):M[B]={value:j,level:G,remoteUidCount:"local"===X?0:1,totalTs:null!==(F=k.get(B))&&void 0!==F?F:0}}return Object.keys(M).map(L=>{let{level:k,value:U,totalTs:V}=M[L];return{id:L,level:k,value:U,totalTs:V}})}(U,L);let B=Date.now(),j=B>k?B:k+1;this.requestUpload&&this.requestUpload(RS.EXTENSION_USAGE_STATS,{usageStats:M,sendTs:j})},wN("EXTENSION_USAGE_UPLOAD_INTERVAL"))}stopUploadExtensionUsageStats(){this.uploadExtensionUsageStarted&&(this.uploadExtensionUsageStarted=!1,this.uploadExtUsageStatsTimer&&window.clearInterval(this.uploadExtUsageStatsTimer),this.uploadExtUsageStatsTimer=void 0)}stopUploadBaseStats(){this.uploadBaseStatsStarted=!1}};let I2=wN("ICE_RESTART_INTERVAL"),I3=new Map,I5=new Map,I4=[R2.UDP_TCP_RELAY,R2.TCP_RELAY,R2.RELAY],I6=wN("JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE")&&gf.supportPCSetConfiguration;function qB(L){let k=arguments.length>1&&void 0!==arguments[1]&&arguments[1],M=I3.get(L.id);M&&(window.clearTimeout(M),I3.delete(L.id));let U=I5.get(L.id);k&&U&&U.index===I4.length-1&&(gc.debug("[".concat(L.id,"] reset ICE restart policy")),I5.delete(L.id))}function XB(L,k,M){if(0===I3.size&&0===I5.size&&(Array.isArray(wN("RESTART_SEQUENCE"))&&wN("RESTART_SEQUENCE").length>0&&!function(L,k){if(L.length!==k.length)return!1;for(let M=0;M<L.length;M+=1){let U=L[M];if(L.filter(L=>L===U).length!==k.filter(L=>L===U).length)return!1}return!0}(I4,wN("RESTART_SEQUENCE"))&&(I4=wN("RESTART_SEQUENCE").filter(L=>{var k;if(so(k=Object.values(R2)).call(k,L))return!0}),gc.debug("use reconnection policy from config distribution, queues: ".concat(I4.join(" => ")))),I6=wN("JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE")&&gf.supportPCSetConfiguration),0===I4.length)return void M();let U,{index:V=0,type:F}=I5.get(L.id)||{};if(I6&&F===R2.RELAY)return void M();let B=F&&V>=I4.length-1;if(I6)F=R2.RELAY;else{if(B)return void M();F?F=I4[++V]:(F=I4[0],V=0)}gc.debug("[".concat(L.id,"] choose ICE restart policy: ").concat(F,", index: ").concat(V)),k(F),I5.set(L.id,{index:V,type:F}),U=window.setTimeout(()=>XB(L,k,M),I2),I3.set(L.id,U)}function ZB(L,k){var M=Object.keys(L);if(Object.getOwnPropertySymbols){var U=Object.getOwnPropertySymbols(L);k&&(U=U.filter(function(k){return Object.getOwnPropertyDescriptor(L,k).enumerable})),M.push.apply(M,U)}return M}function QB(L){for(var k=1;k<arguments.length;k++){var M=null!=arguments[k]?arguments[k]:{};k%2?ZB(Object(M),!0).forEach(function(k){uI(L,k,M[k])}):Object.getOwnPropertyDescriptors?Object.defineProperties(L,Object.getOwnPropertyDescriptors(M)):ZB(Object(M)).forEach(function(k){Object.defineProperty(L,k,Object.getOwnPropertyDescriptor(M,k))})}return L}function $B(L){var k,M,U,V=2;for("undefined"!=typeof Symbol&&(M=fS,U=Symbol.iterator);V--;){if(M&&null!=(k=L[M]))return k.call(L);if(U&&null!=(k=L[U]))return new ej(k.call(L));M="@@asyncIterator",U="@@iterator"}throw TypeError("Object is not async iterable")}function ej(L){function t(L){if(Object(L)!==L)return lQ.reject(TypeError(L+" is not an object."));var k=L.done;return lQ.resolve(L.value).then(function(L){return{value:L,done:k}})}return(ej=function(L){this.s=L,this.n=L.next}).prototype={s:null,n:null,next:function(){return t(this.n.apply(this.s,arguments))},return:function(L){var k=this.s.return;return void 0===k?lQ.resolve({value:L,done:!0}):t(k.apply(this.s,arguments))},throw:function(L){var k=this.s.return;return void 0===k?lQ.reject(L):t(k.apply(this.s,arguments))}},new ej(L)}let I8=(OU((nr=class extends Hw{get state(){return this._state}set state(L){let k=this._state;this._state=L,this.emit(R8.StateChange,k,this._state)}constructor(L,k){super(),uI(this,"isPlanB",void 0),uI(this,"store",void 0),uI(this,"statsUploader",void 0),uI(this,"connection",void 0),uI(this,"localTrackMap",new Map),uI(this,"remoteUserMap",new Map),uI(this,"localDataChannels",[]),uI(this,"remoteDataChannelMap",new Map),uI(this,"pendingLocalTracks",[]),uI(this,"pendingRemoteTracks",[]),uI(this,"pendingLocalDataChannels",[]),uI(this,"pendingRemoteDataChannels",[]),uI(this,"statsCollector",void 0),uI(this,"shouldForwardP2PCreation",void 0),uI(this,"iceFailedCount",0),uI(this,"dtlsFailedCount",0),uI(this,"mutex",void 0),uI(this,"_state",R6.Disconnected),uI(this,"_pcStatsUploadType",wN("NEW_ICE_RESTART")?R3.FIRST_CONNECTION:R3.OLD_FIRST_CONNECTION),uI(this,"_isStartRestartIce",!1),uI(this,"_restartTimer",void 0),uI(this,"_isTryConnecting",!1),uI(this,"_iceError",null),uI(this,"_forceTurn",!1),uI(this,"_isWaitPcToRePub",!1),uI(this,"handleMuteLocalTrack",async(L,k,M)=>{let U=await this.mutex.lock("Locking from P2PChannel.handleMuteLocalTrack");try{if(!this.connection||this.state!==R6.Connected)return void M(new f2(f1.INVALID_OPERATION,"Cannot call P2PChannel.handleMuteLocalTrack before connection established."));let U=this.filterTobeMutedTracks(L);if(0===U.length)return void k();let V=U.find(L=>"videoLowTrack"===L[0]);if(V){let L=V[1];this.store.enableInstantMuteRestore?(L.track._originMediaStreamTrack.enabled=!1,gc.info("[".concat(this.store.clientId,"] P2PChannel muteLocalLowTrack without close sender because enableInstantMuteRestore is true"))):L.track._originMediaStreamTrack.stop()}this.store.enableInstantMuteRestore?gc.info("[".concat(this.store.clientId,"] P2PChannel muteLocalTrack without close sender because enableInstantMuteRestore is true")):await this.connection.muteLocal(U.map(L=>{let[,{id:k}]=L;return k}));let F=this.createMuteMessage(U);await sO(this,R8.RequestMuteLocal,F),k()}catch(L){M(L)}finally{U()}}),uI(this,"handleUnmuteLocalTrack",async(L,k,M)=>{let U=await this.mutex.lock("Locking from P2PChannel.handleUnmuteLocalTrack");try{if(!this.connection||this.state!==R6.Connected)return void M(new f2(f1.INVALID_OPERATION,"Cannot call P2PChannel.handleUnmuteLocalTrack before connection established."));let U=this.filterTobeUnmutedTracks(L);if(0===U.length)return void k();let V=U.find(L=>"videoLowTrack"===L[0]);if(V){let k=V[1];if(this.store.enableInstantMuteRestore)k.track._originMediaStreamTrack.enabled=!0,gc.info("[".concat(this.store.clientId,"] P2PChannel unmuteLocalLowTrack without close sender because enableInstantMuteRestore is true"));else{if(k.track._originMediaStreamTrack.stop(),!wN("DISABLE_DUAL_STREAM_USE_ENCODING")&&gf.supportDualStreamEncoding){let M=L._mediaStreamTrack.clone();k.track._mediaStreamTrack=M,k.track._originMediaStreamTrack=M}else{let M=wB(L,cO(this,R8.RequestLowStreamParameter));k.track._mediaStreamTrack=M,k.track._originMediaStreamTrack=M}await new lQ((L,M)=>{this.handleReplaceTrack(k.track,L,M,!0)})}}this.store.enableInstantMuteRestore?gc.info("[".concat(this.store.clientId,"] P2PChannel unmuteLocalTrack without close sender because enableInstantMuteRestore is true")):await this.connection.unmuteLocal(U.map(L=>{let[,{id:k}]=L;return k}));let F=this.createUnmuteMessage(U);await sO(this,R8.RequestUnmuteLocal,F),k()}catch(L){M(L)}finally{U()}}),uI(this,"handleUpdateVideoEncoder",async(L,k,M,U)=>{let V;U||(V=await this.mutex.lock("Locking from P2PChannel.handleUpdateVideoEncoder"));try{let M=this.localTrackMap.get(R4.LocalVideoTrack);if(!this.connection||!M||M.track!==L||this.state!==R6.Connected)return void k();let{id:U,track:V}=M;await this.connection.updateSendParameters(U,V),await this.connection.updateEncoderConfig(U,V),this.emit(R8.UpdateVideoEncoder,V),k()}catch(L){M(L)}finally{var F;null===(F=V)||void 0===F||F()}}),uI(this,"handleUpdateVideoSendParameters",async(L,k,M)=>{let U=await this.mutex.lock("Locking from P2PChannel.handleUpdateVideoSendParameters");try{let M=this.localTrackMap.get(R4.LocalVideoTrack);if(!this.connection||!M||M.track!==L||this.state!==R6.Connected)return void k();let{id:U,track:V}=M;await this.connection.updateSendParameters(U,V),k()}catch(L){M(L)}finally{U()}}),uI(this,"handleReplaceMixingTrack",async(L,k,M,U)=>{let V;if(!this.connection||this.state!==R6.Connected)return void k();let F=SB([L]);gc.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection will replace audioTrack [").concat(F.getTrackId(),"]")),"boolean"==typeof U&&U||(V=await this.mutex.lock("From P2PChannel.handleReplaceMixingTrack"));try{await this.replaceTrack(L,F),k()}catch(L){M(L)}finally{var B;null===(B=V)||void 0===B||B()}}),uI(this,"handleReplaceTrack",async(L,k,M,U)=>{var V,F;let B;gc.debug("[".concat(this.store.clientId,"] P2PChannel handleReplaceTrack for [track-id-").concat(L.getTrackId(),"]")),"boolean"==typeof U&&U||(B=await this.mutex.lock("From P2PChannel.handleReplaceTrack"));try{let M=Array.from(this.localTrackMap.entries()).find(k=>{let[,{track:M}]=k;return L===M});if(!this.connection||!M||this.state!==R6.Connected)return void k();if(await (null===(V=this.connection)||void 0===V?void 0:V.replaceTrack(L,M[1].id)),this.isPlanB){let k=M[1];k.id=L._mediaStreamTrack.id,this.localTrackMap.set(M[0],k)}if(M[0]===R4.LocalVideoTrack&&!wN("DISABLE_DUAL_STREAM_USE_ENCODING")&&gf.supportDualStreamEncoding){let k=this.localTrackMap.get(R4.LocalVideoLowTrack);if(k){let M=L._mediaStreamTrack.clone();k.track._originMediaStreamTrack.stop(),k.track._mediaStreamTrack=M,k.track._originMediaStreamTrack=M,await new lQ((L,M)=>{this.handleReplaceTrack(k.track,L,M,!0)})}}k()}catch(L){M(L)}finally{null===(F=B)||void 0===F||F()}}),uI(this,"handleGetRTCStats",L=>{L(this.statsCollector.getRTCStats())}),uI(this,"handleGetLocalVideoStats",L=>{L(this.statsCollector.getLocalVideoTrackStats())}),uI(this,"handleGetLocalAudioStats",L=>{L(this.statsCollector.getLocalAudioTrackStats())}),uI(this,"handleGetRemoteVideoStats",L=>this.statsCollector.getRemoteVideoTrackStats(L.uid)[L.uid]),uI(this,"handleGetRemoteAudioStats",L=>this.statsCollector.getRemoteAudioTrackStats(L.uid)[L.uid]),this.store=L,this.statsCollector=k,this.statsCollector.addP2PChannel(this),this.statsUploader=new GB(this.store),this.bindStatsUploaderEvents(),this.mutex=new S_("P2PChannel-mutex",this.store.clientId),this.isPlanB=!gf.supportUnifiedPlan||wN("CHROME_FORCE_PLAN_B")&&vw(),this.shouldForwardP2PCreation=wN("FORWARD_P2P_CREATION")&&gf.supportPCSetConfiguration&&Rw(),this.shouldForwardP2PCreation&&(this.connection=TB(this.store),this.emit(R8.PeerConnectionStateChange,this.connection.peerConnectionState),this.bindConnectionEvents(this.connection))}async startP2PConnection(L,k){var M;this.state=R6.New,this._forceTurn=vB(L),gc.debug("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] forceTurn: ").concat(this._forceTurn));let U=this.shouldForwardP2PCreation&&"closed"===(null===(M=this.connection)||void 0===M?void 0:M.peerConnectionState);if((!this.shouldForwardP2PCreation||U||k)&&((U||k)&&this.connection&&(gc.warning("[".concat(this.store.clientId,"] P2PChannel.startP2PConnection ForwardP2P closed.")),this.resetConnection(this.connection)),this.connection=TB(this.store,L),this.emit(R8.PeerConnectionStateChange,this.connection.peerConnectionState),this.bindConnectionEvents(this.connection)),!this.connection)throw new f2(f1.UNEXPECTED_ERROR,"Cannot P2PChannel.startConnection before P2PConnection initialization .");return this._pcStatsUploadType=wN("NEW_ICE_RESTART")?R3.FIRST_CONNECTION:R3.OLD_FIRST_CONNECTION,this._isTryConnecting=!0,this._isStartRestartIce=!1,this._iceError=null,this.connection.setConfiguration(L),this.connection.establishPromise}async connect(L){if(!this.connection)throw new f2(f1.UNEXPECTED_ERROR,"Cannot P2PChannel.connect before P2PChannel.startP2PConnection .");if(this.isPreallocation()&&this.state===R6.Connected){if(this.connection instanceof IJ&&this.connection.checkDtlsParameters(L.dtlsParameters.fingerprints))return gc.debug("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] dtls parameters mismatch, try next.")),g_.reportApiInvoke(this.store.sessionId,{name:f8.MISMATCH_DTLS_PARAMETERS,options:[L.dtlsParameters.fingerprints],tag:f9.TRACER}).onSuccess(),void setTimeout(()=>{this.emit(R8.RequestReconnect)});await this.connection.updateRemoteConnect(L)}else this.store.peerConnectionStart(),await this.connection.connect(L),this.statsUploader.startUploadTransportStats(),this.statsUploader.startUploadExtensionUsageStats(),this.state=R6.Connected}updateRemoteRTPCapabilities(L){let k=Array.from(this.localTrackMap.entries()).filter(L=>{var k;let[M]=L;return so(k=[R4.LocalVideoLowTrack,R4.LocalVideoTrack]).call(k,M)}),M=k.map(L=>{let[,{id:k}]=L;return k}),U=k.map(L=>{let[k]=L;return k});if(this.connection instanceof IJ){if(g_.updateRemoteRTPCapabilities(this.store.sessionId,{trackTypes:JSON.stringify(U),localCodecs:JSON.stringify(this.connection.localCodecs),remoteCodecs:JSON.stringify(L)}),!so(L).call(L,this.store.codec)){let k=["vp9","vp8","h264"].find(k=>so(L).call(L,k));k&&(this.store.codec=k,gc.debug("[".concat(this.store.clientId,"] [").concat(this.store.p2pId," updateRemoteRTPCapabilities] default codec is not available, hence the fallback to ").concat(k,".")))}this.connection.updateRemoteRTPCapabilities(M,L)}}async getEstablishParams(){var L;if(this.connection instanceof IJ&&"closed"!==this.connection.peerConnectionState&&so(L=[R6.New,R6.Connected]).call(L,this.state))return this.connection.establishPromise}async publishDataChannel(L){if(!this.connection||this.state!==R6.Connected){if(this.state===R6.Disconnected)throw new f2(f1.UNEXPECTED_ERROR,"PeerConnection already disconnected.");return L.forEach(L=>{var k;so(k=this.pendingLocalDataChannels).call(k,L)||this.pendingLocalDataChannels.push(L)}),[]}let k=this.filterTobePublishedDataChannels(L);return 0===k.length?[]:(k.forEach(L=>{let k=Date.now();this.store.publish(L.id.toString(),"datachannel",k)}),await this.connection.createDataChannels(this.store.uid,k),k.forEach(L=>{this.localDataChannels.push(L);let k=Date.now();this.store.publish(L.id+"","datachannel",void 0,k)}),L.map(L=>({streamId:L.id,ordered:L.ordered,maxRetransmits:L.maxRetransmits,metadata:L.metadata,channelId:L._originDataChannelId})))}publish(L,k,M){var U=this;return qb(function*(){let V=yield Jb(U.mutex.lock("From P2PChannel.publish"));try{var F;let V=U.connection&&so(F=["disconnected","failed"]).call(F,U.connection.peerConnectionState);if(!U.connection||U.state!==R6.Connected||V){if(U.state===R6.Disconnected)throw new f2(f1.UNEXPECTED_ERROR,"PeerConnection already disconnected.");U.throwIfTrackTypeNotMatch(L);let k=L.filter(L=>-1===U.pendingLocalTracks.indexOf(L));return U.pendingLocalTracks=U.pendingLocalTracks.concat(k),void(V&&(U._isWaitPcToRePub=!0))}U.store.pubId=U.store.pubId+1,IW.markPublishStart(U.store.clientId,U.store.pubId);let B=U.filterTobePublishedTracks(L,k,M);if(0===B.length)return void(yield Jb(U.tryToUnmuteAudio(L)));yield*Zb($B(U.doPublish(U.connection,B)))}finally{V()}})()}doPublish(L,k){var M=this;return qb(function*(){let U;k.forEach(L=>{let{track:k,type:U}=L,V=Date.now();M.store.publish(k.getTrackId(),U===R4.LocalAudioTrack?"audio":"video",V)}),M.bindLocalTrackEvents(k);let V=k.map(L=>{let{track:k}=L;return k}),F=yield Jb(L.send(V,M.store.codec,M.store.audioCodec)),B=(yield Jb(F.next())).value,j=M.createGatewayPublishMessage(k,B);try{U=yield j}catch(L){throw F.throw(L),(null==L?void 0:L.code)===f1.WS_ABORT&&k.forEach(L=>{let{track:k}=L;-1===M.pendingLocalTracks.indexOf(k)&&M.pendingLocalTracks.push(k)}),M.unbindLocalTrackEvents(k),L}let G=M.mapPubResToRemoteConfig(j,U,V),X=(yield Jb(F.next(G))).value;if(M.state===R6.Disconnected)throw new f2(f1.UNEXPECTED_ERROR,"PeerConnection already disconnected.");wN("ENABLE_VIDEO_SEI");let $=wN("ENABLE_ENCODED_TRANSFORM"),ee=wN("ENABLE_AUDIO_METADATA");V.forEach(async L=>{let k=L.getRTCRtpTransceiver();if(!k||!$)return;let{interceptLocalVideoFrame:M,interceptLocalAudioFrame:U}=Qx();L.trackMediaType===R1.VIDEO?await M(k.sender,L):L.trackMediaType===R1.AUDIO&&await U(k.sender,{metadata:ee?()=>{let k=L.metadata.shift();return k&&k.value}:void 0})}),k.forEach(L=>{let{type:k}=L;M.statsCollector.addLocalStats(k)}),M.assignLocalTracks(k,X),M.statsUploader.startUploadOutboundStats(),k.forEach(L=>{let{track:k,type:U}=L,V=Date.now();M.store.publish(k.getTrackId(),U===R4.LocalAudioTrack?"audio":"video",void 0,V)})})()}async updateVideoStreamParameter(L,k){let M=this.localTrackMap.get(k);if(!M||!this.connection)return;if(!(M.track instanceof Tp))return gc.warn("[updateVideoStreamParameter]: track is not an instance of LocalVideoTrack");let{track:U}=M,V=function(L,k){let M={};return L.height&&L.width&&(M.scaleResolutionDownBy=lx(L,k)),M.maxFramerate=L.framerate?ox(L.framerate):void 0,M.maxBitrate=L.bitrate?1e3*L.bitrate:void 0,M}(L,U);if(U._encoderConfig||(U._encoderConfig={}),k!==R4.LocalVideoLowTrack||!wN("DISABLE_DUAL_STREAM_USE_ENCODING")&&gf.supportDualStreamEncoding)null!=V.scaleResolutionDownBy&&(U._encoderConfig.scaleResolutionDownBy=V.scaleResolutionDownBy);else{let k=U._originMediaStreamTrack;if(!k.canvas)return gc.warn("[".concat(U.getTrackId(),"] no canvas on track"));!function(L,k){let M=L.canvas;k.width&&(M.width=ox(k.width)),k.height&&(M.height=ox(k.height)),k.framerate&&(M.stopCapture&&M.stopCapture(),M.stopCapture=SP(()=>{!M.startCapture&&M.stopCapture&&M.stopCapture(),M.startCapture&&M.startCapture()},ox(k.framerate)))}(k,L)}null!=V.maxBitrate&&(U._encoderConfig.bitrateMax=V.maxBitrate/1e3),null!=V.maxFramerate&&(U._encoderConfig.frameRate&&"object"==typeof U._encoderConfig.frameRate?U._encoderConfig.frameRate.max=V.maxFramerate:U._encoderConfig.frameRate={max:V.maxFramerate}),gc.debug("[".concat(U.getTrackId(),"] LowStreamEncoderConfig: , ").concat(JSON.stringify(U._encoderConfig))),await this.connection.updateRtpSenderEncodings(U)}publishLowStream(L){var k=this;return qb(function*(){if(!k.connection||k.state!==R6.Connected)return;let M=yield Jb(k.mutex.lock("Locking from P2PChannel.publishLowStream"));try{let M=k.localTrackMap.get(R4.LocalVideoTrack);if(!M)throw new f2(f1.UNEXPECTED_ERROR,"Could not find high stream");if(k.localTrackMap.has(R4.LocalVideoLowTrack))throw new f2(f1.UNEXPECTED_ERROR,"[".concat(k.store.clientId,"] Can't publish low stream when stream already publish"));let V=[{track:k.getLowVideoTrack(M.track,L),type:R4.LocalVideoLowTrack}];if(yield*Zb($B(k.doPublish(k.connection,V))),M.track.muted||!M.track.enabled){var U;let L=null===(U=k.localTrackMap.get(R4.LocalVideoLowTrack))||void 0===U?void 0:U.id;void 0!==L&&(yield Jb(k.connection.muteLocal([L])))}}finally{M()}})()}async republish(){this.pendingLocalTracks.length>0&&(gc.debug("[".concat(this.store.clientId,"] Emit P2PChannelEvents.RequestRePublish to republish tracks.")),await oO(this,R8.RequestRePublish,this.pendingLocalTracks),this.emit(R8.MediaReconnectEnd,this.store.uid),this.pendingLocalTracks=[]),this.pendingLocalDataChannels.length>0&&(gc.debug("Emit P2PChannelEvents.RequestRePublishDataChannel to republish datachannels."),await oO(this,R8.RequestRePublishDataChannel,this.pendingLocalDataChannels),this.pendingLocalDataChannels=[]),this._isWaitPcToRePub=!1}async reSubscribe(L){for(let L=this.pendingRemoteTracks.length-1;L>=0;L--){let{user:k,kind:M}=this.pendingRemoteTracks[L];(M!==R1.AUDIO||k._audio_added_&&k._audioSSRC)&&(M!==R1.VIDEO||k._video_added_&&k._videoSSRC)||this.pendingRemoteTracks.splice(L,1)}if(L)await oO(this,R8.RequestReSubscribe,this.pendingRemoteTracks);else for(let{user:L,kind:k}of this.pendingRemoteTracks)await this.subscribe(L,k,k===R1.VIDEO?L._videoSSRC:L._audioSSRC);this.pendingRemoteTracks.forEach(L=>{let{user:k}=L;this.emit(R8.MediaReconnectEnd,k.uid)}),this.pendingRemoteTracks=[]}async unpublish(L){if(!this.connection||this.state!==R6.Connected)return void L.forEach(L=>{let k=this.pendingLocalTracks.indexOf(L);-1!==k&&this.pendingLocalTracks.splice(k,1)});let k=this.filterTobeUnpublishedTracks(L);if(0===k.length)return;let M=k.find(L=>"videoLowTrack"===L[0]);return M&&M[1].track.close(),this.doUnpublish(this.connection,k)}async unpublishDataChannel(L){if(!this.connection||this.state!==R6.Connected)return void L.forEach(L=>{let k=this.pendingLocalDataChannels.indexOf(L);-1!==k&&this.pendingLocalDataChannels.splice(k,1)});let k=this.filterTobeUnpublishedDataChannels(L);return 0!==k.length?(k.forEach(L=>{let k=this.localDataChannels.indexOf(L);-1!==k&&this.localDataChannels.splice(k,1)}),0===this.localDataChannels.length&&await this.connection.stopDataChannels(this.store.uid),k.map(L=>L.id)):void 0}async unpublishLowStream(){if(!this.connection||this.state!==R6.Connected)return;let L=this.localTrackMap.get(R4.LocalVideoLowTrack);if(!L)return;L.track.close();let k=[[R4.LocalVideoLowTrack,L]];return this.doUnpublish(this.connection,k)}async doUnpublish(L,k){let M=this.createGatewayUnpublishMessage(k);return await L.stopSending(k.map(L=>{let[,{id:k}]=L;return k})),this.withdrawLocalTracks(k),this.unbindLocalTrackEvents(k.map(L=>{let[k,{track:M}]=L;return{type:k,track:M}})),k.forEach(L=>{let[k]=L;this.statsCollector.removeLocalStats(k)}),0===this.localTrackMap.size&&this.statsUploader.stopUploadOutboundStats(),M}async subscribeDataChannel(L,k){if(!this.connection||this.state!==R6.Connected)throw new f2(f1.INVALID_OPERATION,"Cannot subscribe remote user when peerConnection disconnected.");let M=k.filter(k=>{var M;return!(null!==(M=this.remoteDataChannelMap.get(L))&&void 0!==M&&M.get(k.id))});if(0!==M.length)return await this.connection.createDataChannels(L.uid,M),M.forEach(k=>{var M;this.remoteDataChannelMap.has(L)?null===(M=this.remoteDataChannelMap.get(L))||void 0===M||M.set(k.id,k):this.remoteDataChannelMap.set(L,new Map([[k.id,k]]));let U=this.pendingRemoteDataChannels.findIndex(M=>{let{user:U,id:V}=M;return U.uid===L.uid&&V===k.id});-1!==U&&this.pendingRemoteDataChannels.splice(U,1)}),M.map(L=>L.id)}async subscribe(L,k,M,U,V){var F;let B,j,G,X;if(!this.connection||this.state!==R6.Connected)throw new f2(f1.INVALID_OPERATION,"Cannot subscribe remote user when peerConnection disconnected.");if(null!==(F=this.remoteUserMap.get(L))&&void 0!==F&&F.has(k))return;let $=this.connection.getPreMedia(M);if($)gc.debug("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] preSSRCMap has ssrcId: ").concat(M,", no need to send sub to gateway.")),G=$.transceiver,B=$.track,j=$.mid,X=$.player,$.firstVideoRender&&this.store.firstVideoFrameDecoded(L.uid,{firstPreRender:$.firstVideoRender});else if(V){let M=V.find(L=>{let{stream_type:M}=L;return M===k});if(!M)throw new f2(f1.UNEXPECTED_ERROR,"Cannot subscribe to remote ".concat(k," for user: ").concat(L.uid," because subscribe answer from gateway does not contain stream_type: ").concat(k,"."));let U=await this.connection.receive(k,M.ssrcs,String(L._uintid),M.attributes);this.connection instanceof IJ&&(G=U.transceiver),B=U.track,j=U.id}else{let V=await this.connection.receive(k,[{ssrcId:M,rtx:U}],String(L._uintid),void 0);this.connection instanceof IJ&&(G=V.transceiver),B=V.track,j=V.id}if(k===R1.AUDIO?(L._audioTrack?L._audioTrack._updateOriginMediaStreamTrack(B):(L._audioTrack=new Tf(B,L.uid,L._uintid,this.store),gc.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(L._audioTrack.getTrackId()))),G&&L._audioTrack._updateRtpTransceiver(G),this.bindRemoteTrackEvents(L,L._audioTrack)):(L._videoTrack?L._videoTrack._updateOriginMediaStreamTrack(B):(L._videoTrack=new TE(B,L.uid,L._uintid,this.store,X),gc.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(L._videoTrack.getTrackId())),L._videoTrack.once(gj.PLAY_START,()=>{this.store.firstVideoFrameDecoded(L.uid,{playStart:Date.now()})}),L._videoTrack.once(gj.PLAY_END,()=>{this.store.firstVideoFrameDecoded(L.uid,{playEnd:Date.now()}),this.reportVideoFirstFrameRender(L)}),X?L._videoTrack.once(gj.FIRST_FRAME_RENDER,()=>{this.store.firstVideoFrameDecoded(L.uid,{firstRender:Date.now()}),this.reportVideoFirstFrameRender(L)}):L._videoTrack.once(gj.FIRST_FRAME_DECODED,()=>{this.store.firstVideoFrameDecoded(L.uid,{firstRender:Date.now()}),this.reportVideoFirstFrameRender(L)})),G&&L._videoTrack._updateRtpTransceiver(G),this.bindRemoteTrackEvents(L,L._videoTrack)),G&&wN("ENABLE_ENCODED_TRANSFORM")){let{interceptRemoteVideoFrame:M,interceptRemoteAudioFrame:U}=Qx();k==R1.VIDEO?await M(G.receiver,{onSei:wN("ENABLE_VIDEO_SEI")&&(k=>{var M;return null===(M=L._videoTrack)||void 0===M?void 0:M._onSei(k)})}):k==R1.AUDIO&&await U(G.receiver,{enableTopn:!!wN("ENABLE_AUDIO_TOPN"),enableMetadata:!!wN("ENABLE_AUDIO_METADATA"),enablePts:!!wN("ENABLE_AUDIO_PTS"),onMetadata:L=>{this.safeEmit(R8.AudioMetadata,L)},onPts:L=>{this.safeEmit(R8.AudioPts,L)}})}let ee=this.remoteUserMap.get(L);ee?ee.set(k,j):this.remoteUserMap.set(L,new Map([[k,j]])),this.statsCollector.addRemoteStats(L.uid),this.statsUploader.startUploadInboundStats();let et=this.pendingRemoteTracks.findIndex(M=>{let{user:U,kind:V}=M;return U.uid===L.uid&&k===V});-1!==et&&(this.pendingRemoteTracks.splice(et,1),this.emit(R8.MediaReconnectEnd,L.uid))}async massSubscribe(L){return this.massSubscribeNoLock(L)}async massSubscribeNoLock(L){if(!this.connection||this.state!==R6.Connected)throw new f2(f1.INVALID_OPERATION,"Cannot subscribeAll remote users when peerConnection disconnected.");L=L.filter(L=>{var k;let{user:M,mediaType:U}=L;return!(null!==(k=this.remoteUserMap.get(M))&&void 0!==k&&k.has(U))});let k=[],M=new Map;L.forEach(L=>{if(!this.connection)return;let U=this.connection.getPreMedia(L.ssrcId);if(U){let{track:k,mid:V,transceiver:F,player:B}=U;M.set(L.ssrcId,{track:k,id:V,transceiver:F,player:B})}else k.push(L)});let U=await this.connection.batchReceive(k.map(L=>{let{user:k,mediaType:M,ssrcId:U,rtxSsrcId:V}=L;return{kind:M,ssrcMsg:[{ssrcId:U,rtx:V}],mslabel:String(k._uintid)}}));for(let{user:V,mediaType:F,ssrcId:B}of(k.forEach((L,k)=>{M.set(L.ssrcId,U[k])}),L)){let L=M.get(B);if(!L)return void gc.debug("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] cannot find ").concat(V.uid," subscribe data,").concat(F,", ").concat(B));let{track:k,id:U,transceiver:j,player:G}=L;if(j&&wN("ENABLE_ENCODED_TRANSFORM")){let{interceptRemoteVideoFrame:L,interceptRemoteAudioFrame:k}=Qx();F==R1.VIDEO?await L(j.receiver,{onSei:wN("ENABLE_VIDEO_SEI")&&(L=>{var k;return null===(k=V._videoTrack)||void 0===k?void 0:k._onSei(L)})}):F==R1.AUDIO&&await k(j.receiver,{enableTopn:!!wN("ENABLE_AUDIO_TOPN"),enableMetadata:!!wN("ENABLE_AUDIO_METADATA"),enablePts:!!wN("ENABLE_AUDIO_PTS"),onMetadata:L=>{this.safeEmit(R8.AudioMetadata,L)},onPts:L=>{this.safeEmit(R8.AudioPts,L)}})}if(F===R1.AUDIO?(V._audioTrack?V._audioTrack._updateOriginMediaStreamTrack(k):(V._audioTrack=new Tf(k,V.uid,V._uintid,this.store),gc.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(V._audioTrack.getTrackId()))),j&&V._audioTrack._updateRtpTransceiver(j),this.bindRemoteTrackEvents(V,V._audioTrack)):(V._videoTrack?V._videoTrack._updateOriginMediaStreamTrack(k):(V._videoTrack=new TE(k,V.uid,V._uintid,this.store,G),gc.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(V._videoTrack.getTrackId()))),j&&V._videoTrack._updateRtpTransceiver(j),this.bindRemoteTrackEvents(V,V._videoTrack)),wN("ENABLE_VIDEO_SEI")&&j){let{interceptRemoteVideoFrame:L,interceptRemoteAudioFrame:k}=Qx();F==R1.VIDEO?await L(j.receiver,{onSei:L=>{var k;null===(k=V._videoTrack)||void 0===k||k._onSei(L)}}):F==R1.AUDIO&&await k(j.receiver)}let X=this.remoteUserMap.get(V);X?X.set(F,U):this.remoteUserMap.set(V,new Map([[F,U]])),this.statsCollector.addRemoteStats(V.uid),this.statsUploader.startUploadInboundStats();let $=this.pendingRemoteTracks.findIndex(L=>{let{user:k,kind:M}=L;return k.uid===V.uid&&F===M});-1!==$&&(this.pendingRemoteTracks.splice($,1),this.emit(R8.MediaReconnectEnd,V.uid))}}async unsubscribe(L,k,M){let U=this.pendingRemoteTracks.filter(M=>{let{user:U,kind:V}=M;return void 0!==k?U.uid===L.uid&&k===V:U.uid===L.uid});if(U.forEach(L=>{let k=this.pendingRemoteTracks.indexOf(L);this.pendingRemoteTracks.splice(k,1)}),this.connection&&this.state===R6.Connected||M||U.forEach(k=>{var M,U;let{kind:V}=k;V===R1.AUDIO?(null===(M=L._audioTrack)||void 0===M||M._destroy(),L._audioTrack=void 0):V===R1.VIDEO&&(null===(U=L._videoTrack)||void 0===U||U._destroy(),L._videoTrack=void 0)}),!this.connection||this.state!==R6.Connected)return;let V=this.filterTobeUnSubscribedTracks(L,k);if(0===V.length)return;await this.connection.stopReceiving(V.map(L=>{let[,{id:k}]=L;return k}));let F=this.createUnsubscribeMessage(V);return this.withdrawRemoteTracks(V),0===this.remoteUserMap.size&&this.statsUploader.stopUploadInboundStats(),V.forEach(L=>{var k,U,V;let[F,{kind:B}]=L;B===R1.VIDEO&&F._videoSSRC&&(null===(k=this.connection)||void 0===k||k.setStatsRemoteVideoIsReady(F._videoSSRC,!1)),B===R1.VIDEO?(this.unbindRemoteTrackEvents(F._videoTrack),M||(null===(U=F._videoTrack)||void 0===U||U._destroy(),F._videoTrack=void 0)):B!==R1.AUDIO||(this.unbindRemoteTrackEvents(F._audioTrack),M||(null===(V=F._audioTrack)||void 0===V||V._destroy(),F._audioTrack=void 0))}),F}async unsubscribeDataChannel(L,k){if(k.forEach(L=>{let k=this.pendingRemoteDataChannels.findIndex(k=>k.id===L.id);-1!==k&&this.pendingRemoteDataChannels.splice(k,1)}),!this.connection)return;let M=this.filterTobeUnSubscribedDataChannels(L,k);if(0===M.length)return;k.forEach(L=>{L._close()});let U=this.remoteDataChannelMap.get(L);return M.forEach(L=>{U&&U.delete(L.id)}),U&&0===U.size&&(this.remoteDataChannelMap.delete(L),await this.connection.stopDataChannels(L.uid)),M.map(L=>L.id)}async massUnsubscribe(L){return this.massUnsubscribeNoLock(L)}async massUnsubscribeNoLock(L){let k=[];for(let{user:M,mediaType:U}of L){let L=this.pendingRemoteTracks.filter(L=>{let{user:k,kind:V}=L;return void 0!==U?k.uid===M.uid&&U===V:k.uid===M.uid});L.forEach(L=>{let k=this.pendingRemoteTracks.indexOf(L);this.pendingRemoteTracks.splice(k,1)}),k=k.concat(L)}if(!this.connection||this.state!==R6.Connected)return void k.forEach(L=>{var k,M;let{user:U,kind:V}=L;V===R1.AUDIO?(null===(k=U._audioTrack)||void 0===k||k._destroy(),U._audioTrack=void 0):V===R1.VIDEO&&(null===(M=U._videoTrack)||void 0===M||M._destroy(),U._videoTrack=void 0)});let M=sE(L).call(L,(L,k)=>{let{user:M,mediaType:U}=k,V=this.filterTobeUnSubscribedTracks(M,U);return L.concat(V)},[]);if(0===M.length)return;await this.connection.stopReceiving(M.map(L=>{let[,{id:k}]=L;return k}));let U=this.createUnsubscribeAllMessage(M);return this.withdrawRemoteTracks(M),0===this.remoteUserMap.size&&this.statsUploader.stopUploadInboundStats(),M.forEach(L=>{var k,M,U;let[V,{kind:F}]=L;F===R1.VIDEO&&V._videoSSRC&&(null===(k=this.connection)||void 0===k||k.setStatsRemoteVideoIsReady(V._videoSSRC,!1)),F===R1.VIDEO?(this.unbindRemoteTrackEvents(V._videoTrack),null===(M=V._videoTrack)||void 0===M||M._destroy(),V._videoTrack=void 0):F===R1.AUDIO&&(this.unbindRemoteTrackEvents(V._audioTrack),null===(U=V._audioTrack)||void 0===U||U._destroy(),V._audioTrack=void 0)}),U}isPreSubScribe(L){return!!this.connection&&this.state===R6.Connected&&!!this.connection.getPreMedia(L)}async muteRemote(L,k){if(!this.connection)return;let M=this.remoteUserMap.get(L);if(!M)return void gc.warning("[".concat(this.store.clientId,"] P2PChannel.muteRemote has no remote user ").concat(L.uid,"."));if(!M.get(k))return void gc.warning("[".concat(this.store.clientId,"] P2PChannel.muteRemote has no remote user ").concat(L.uid," media type ").concat(k,"."));let U=k===R1.VIDEO?L._videoSSRC:L._audioSSRC;void 0!==U&&this.connection.setStatsRemoteVideoIsReady(U,!1)}async unmuteRemote(L,k){return this.unmuteRemoteNoLock(L,k)}async unmuteRemoteNoLock(L,k){if(!this.connection)return;let M=this.remoteUserMap.get(L);if(!M)return void gc.warning("[".concat(this.store.clientId,"] P2PChannel.unmuteRemote has no remote user ").concat(L.uid,"."));M.get(k)||gc.warning("[".concat(this.store.clientId,"] P2PChannel.unmuteRemote has no remote user ").concat(L.uid," media type ").concat(k,"."))}addAudioMetadata(L){let k=this.localTrackMap.get(R4.LocalAudioTrack),M=k&&k.track;M&&M.metadata.push(L)}getAllTracks(L){let k=this.localTrackMap.get(R4.LocalAudioTrack);if((null==k?void 0:k.track)instanceof WL){let M=k.track;return Array.from(this.localTrackMap.entries()).filter(L=>{let[k]=L;return k!==R4.LocalAudioTrack}).filter(k=>{let[M]=k;return!(L&&M===R4.LocalVideoLowTrack)}).map(L=>{let[,{track:k}]=L;return k}).concat(M.trackList)}return Array.from(this.localTrackMap.entries()).filter(k=>{let[M]=k;return!(L&&M===R4.LocalVideoLowTrack)}).map(L=>{let[,{track:k}]=L;return k})}getAllDataChannels(){return this.localDataChannels}reportPublishEvent(L,k,M,U,V){if(L){let M=this.localTrackMap.get(R4.LocalAudioTrack),F=U?this.localTrackMap.get(R4.LocalVideoLowTrack):this.localTrackMap.get(R4.LocalVideoTrack);g_.publish(this.store.sessionId,{eventElapse:IW.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:L,ec:k,audioName:null==M?void 0:M.track.getTrackLabel(),videoName:null==F?void 0:F.track.getTrackLabel(),screenshare:-1!==(null==F?void 0:F.track._hints.indexOf(gL.SCREEN_TRACK)),audio:!!M,video:!!F,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:V})}else{var F;M||(M=[]);let B=M.find(L=>L instanceof Ts),j=U?null===(F=this.localTrackMap.get(R4.LocalVideoTrack))||void 0===F?void 0:F.track:M.find(L=>L instanceof Tp);g_.publish(this.store.sessionId,{eventElapse:IW.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:L,ec:k,audioName:null==B?void 0:B.getTrackLabel(),videoName:null==j?void 0:j.getTrackLabel(),screenshare:-1!==(null==j?void 0:j._hints.indexOf(gL.SCREEN_TRACK)),audio:!!B,video:!!j,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:V})}}reportSubscribeEvent(L,k,M,U){let V=U===R1.VIDEO?M._videoSSRC:M._audioSSRC;V&&g_.subscribe(this.store.sessionId,{succ:L,ec:k,video:U===R1.VIDEO,audio:U===R1.AUDIO,peerid:M.uid,subscribeRequestid:V,p2pid:this.store.p2pId,eventElapse:IW.measureFromSubscribeStart(this.store.clientId,V),preSsrc:this.isPreSubScribe(V)})}reset(){gc.debug("[".concat(this.store.clientId,"] P2PChannel.reset")),this.mutex=new S_("P2PChannel-mutex",this.store.clientId),this.connection&&(this.resetConnection(this.connection),this.connection=void 0),this.shouldForwardP2PCreation&&(this.connection=TB(this.store),this.emit(R8.PeerConnectionStateChange,this.connection.peerConnectionState),this.bindConnectionEvents(this.connection)),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),this.statsUploader.stopUploadExtensionUsageStats(),this.statsUploader.stopUploadBaseStats(),this.unbindLocalTrackEvents(),this.unbindAllRemoteTrackEvents(),this.unbindRtpTransceiver();let L=this.localTrackMap.get(R4.LocalAudioTrack);if((null==L?void 0:L.track)instanceof WL){if(L.track.trackList.length>0){let k=L.track;L.track.trackList.forEach(L=>{k.removeAudioTrack(L)})}L.track.close()}this.localTrackMap.clear(),this.remoteUserMap.clear(),this.statsCollector.removeRemoteStats(),this.statsCollector.removeLocalStats(),this.iceFailedCount=0,this.dtlsFailedCount=0,this.pendingLocalTracks=[],this.pendingRemoteTracks=[],this.localDataChannels=[],this.remoteDataChannelMap.clear(),this.pendingLocalDataChannels=[],this.pendingRemoteDataChannels=[],this.state=R6.Disconnected}getStats(){var L;return null===(L=this.connection)||void 0===L?void 0:L.getStats()}getRemoteVideoIsReady(L){var k;return(null===(k=this.connection)||void 0===k?void 0:k.getRemoteVideoIsReady(L))||!1}getLocalAudioVolume(){let L=this.localTrackMap.get(R4.LocalAudioTrack);if(L)return L.track.getVolumeLevel()}getLocalVideoSize(){let L=this.localTrackMap.get(R4.LocalVideoTrack);if(L)return{width:L.track.videoWidth||0,height:L.track.videoHeight||0}}getEncoderConfig(L){let k=this.localTrackMap.get(L);return k&&k.track instanceof Tp||k&&k.track instanceof Ts?k.track._encoderConfig:void 0}getLocalMedia(L){return this.localTrackMap.get(L)}hasLocalMedia(){return this.localTrackMap.size>0}hasRemoteMedia(L,k){if(!L)return this.remoteUserMap.size>0;let M=this.remoteUserMap.get(L);return!!M&&(!k||M.has(k))}async hasRemoteMediaWithLock(L,k){if(!L)return this.remoteUserMap.size>0;let M=this.remoteUserMap.get(L);return!!M&&(!k||M.has(k))}getRemoteMedia(L){var k;let M=Array.from(gn(k=this.remoteUserMap).call(k)).find(k=>k.uid===L);return M?{audioTrack:M.audioTrack,audioSSRC:M._audioSSRC,videoTrack:M.videoTrack,videoSSRC:M._videoSSRC}:{}}getAudioLevels(){let L=Array.from(this.remoteUserMap.entries()).map(L=>{let[k]=L;return{uid:k.uid,level:k.audioTrack?100*k.audioTrack._source.getAccurateVolumeLevel():0}}),k=this.localTrackMap.get(R4.LocalAudioTrack);return k&&L.push({level:100*k.track._source.getAccurateVolumeLevel(),uid:this.store.uid}),L=uu(L).call(L,(L,k)=>L.level-k.level)}async disconnectForReconnect(){this.connection&&(gc.debug("[".concat(this.store.clientId,"] P2PChannel.disconnectForReconnect closing P2PConnection")),this.state=R6.Reconnecting,wN("KEEP_LAST_FRAME")&&0!==this.remoteUserMap.size&&Array.from(this.remoteUserMap.entries()).forEach(L=>{var k;let[M]=L;M._videoTrack&&M._videoTrack._player&&(null===(k=M._videoTrack._player.getVideoElement())||void 0===k||k.pause(),M._videoTrack._player.isKeepLastFrame=!0,M._videoTrack._originMediaStreamTrack.stop())}),this.resetConnection(this.connection),this.connection=void 0,this.shouldForwardP2PCreation&&(this.connection=TB(this.store),this.emit(R8.PeerConnectionStateChange,this.connection.peerConnectionState),this.bindConnectionEvents(this.connection)),0!==this.localTrackMap.size&&(Array.from(this.localTrackMap.entries()).forEach(L=>{var k;let[M,{track:U}]=L;switch(M){case R4.LocalVideoTrack:so(k=U._hints).call(k,gL.LOW_STREAM)?U.close():this.pendingLocalTracks.push(U);break;case R4.LocalAudioTrack:U instanceof WL?this.pendingLocalTracks=this.pendingLocalTracks.concat(U.trackList):this.pendingLocalTracks.push(U);case R4.LocalVideoLowTrack:}}),this.emit(R8.MediaReconnectStart,this.store.uid)),this.unbindLocalTrackEvents(),this.localTrackMap.clear(),0!==this.remoteUserMap.size&&Array.from(this.remoteUserMap.entries()).forEach(L=>{let[k,M]=L;Array.from(gn(M).call(M)).forEach(L=>{this.setPendingRemoteMedia(k,L)}),this.emit(R8.MediaReconnectStart,k.uid)}),this.unbindAllRemoteTrackEvents(),this.remoteUserMap.clear(),0!==this.localDataChannels.length&&(this.localDataChannels.forEach(L=>{this.pendingLocalDataChannels.push(L)}),this.localDataChannels.length=0),0!==this.remoteDataChannelMap.size&&(Array.from(this.remoteDataChannelMap.entries()).forEach(L=>{let[k,M]=L;Array.from(gn(M).call(M)).forEach(L=>{this.setPendingRemoteDataChannel(k,L)})}),this.remoteDataChannelMap.clear()),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),gc.debug("[".concat(this.store.clientId,"] P2PChannel disconnected, waiting to reconnect.")))}hasPendingRemoteDataChannel(L,k){for(let M of this.pendingRemoteDataChannels){let{user:U,id:V}=M;if((L instanceof QF?L.uid:L)===U.uid&&V===k)return!0}return!1}setPendingRemoteDataChannel(L,k){this.hasPendingRemoteDataChannel(L,k)||this.pendingRemoteDataChannels.push({user:L,id:k})}hasPendingRemoteMedia(L,k){for(let M of this.pendingRemoteTracks){let{user:U,kind:V}=M;if((L instanceof QF?L.uid:L)===U.uid&&k===V)return!0}return!1}setPendingRemoteMedia(L,k){this.hasPendingRemoteMedia(L,k)||this.pendingRemoteTracks.push({user:L,kind:k})}restartICE(L){var k=this;return qb(function*(){let M;if(!k.connection||k.state!==R6.Connected)return;let U=yield Jb(k.mutex.lock("From P2PChannel.restartICE"));try{M=yield Jb(k.connection.restartICE(L));let U=yield Jb(M.next());if(U.done)return;let V=U.value,F=yield V;switch(RB(k.connection)&&k.reportPCStats(Date.now(),!1,k._pcStatsUploadType),L){case R2.UDP_TCP_RELAY:k._pcStatsUploadType=R3.UDP_TCP_RESTART;break;case R2.TCP_RELAY:k._pcStatsUploadType=R3.TCP_RESTART;break;case R2.RELAY:k._pcStatsUploadType=R3.RELAY_RESTART;break;default:k._pcStatsUploadType=R3.OLD_RESTART}k._isTryConnecting=!0,M.next(F)}catch(L){var V;null===(V=M)||void 0===V||V.throw(L)}finally{U()}})()}getUplinkNetworkQuality(){if(!this.connection)return 0;let L=this.connection.getStats(),k=this.localTrackMap.get(R4.LocalVideoTrack),M=this.localTrackMap.get(R4.LocalAudioTrack),U=L.videoSend.find(L=>L.ssrc===(null==k?void 0:k.ssrcs[0].ssrcId)),V=L.audioSend.find(L=>L.ssrc===(null==M?void 0:M.ssrcs[0].ssrcId));if(!U||!V)return 1;let F=aO(this,R8.NeedSignalRTT),B=U?U.rttMs:void 0,j=V?V.rttMs:void 0,G=B&&j?(B+j)/2:B||j,X=100*L.sendPacketLossRate*.7/50+.3*((G&&F?(G+F)/2:G||F)||0)/1500,$=X<.17?1:X<.36?2:X<.59?3:X<.1?4:5,ee=null==k?void 0:k.track;if(ee&&ee._encoderConfig&&-1===ee._hints.indexOf(gL.SCREEN_TRACK)){let k=ee._encoderConfig.bitrateMax,M=L.bitrate.actualEncoded;if(k&&M){let L=(1e3*k-M)/(1e3*k);return TQ[L<.15?0:L<.3?1:L<.45?2:L<.6?3:4][$]}}return $}getDownlinkNetworkQuality(){if(!this.connection)return 0;let L=this.connection.getStats(),k=0;return Array.from(this.remoteUserMap.entries()).forEach(M=>{let[U]=M,V=U._audioSSRC,F=U._videoSSRC,B=L.audioRecv.find(L=>L.ssrc===V),j=L.videoRecv.find(L=>L.ssrc===F);if(!B&&!j)return void(k+=1);let G=aO(this,R8.NeedSignalRTT),X=L.rtt,$=(X&&G?(X+G)/2:X||G)||0,ee=B?B.jitterMs:void 0,et=L.recvPacketLossRate,ei=.7*et*100/50+.3*$/1500;ee&&(ei=.6*et*100/50+.2*$/1500+.2*ee/400),k+=ei<.1?1:ei<.17?2:ei<.36?3:ei<.59?4:5}),this.remoteUserMap.size>0?Math.round(k/this.remoteUserMap.size):k}async muteLocalTrack(L){return new lQ((k,M)=>{this.handleMuteLocalTrack(L,k,M)})}async replaceTrack(L,k){var M;if(gc.debug("[".concat(this.store.clientId,"] P2PChannel replaceTrack from [").concat(L.getTrackId(),"] to [").concat(k.getTrackId(),"]")),!this.connection||this.state!==R6.Connected)return;let U=Array.from(this.localTrackMap.entries()).find(k=>{let[,{track:M}]=k;return L===M});if(!U)return;let V=U[0];if(L!==k&&(this.unbindLocalTrackEvents([{track:L,type:V}]),this.bindLocalTrackEvents([{track:k,type:V}]),U[1].track=k),await (null===(M=this.connection)||void 0===M?void 0:M.replaceTrack(k,U[1].id)),this.isPlanB){let L=U[1];L.id=k._mediaStreamTrack.id,this.localTrackMap.set(V,L)}if(V===R4.LocalVideoTrack&&!wN("DISABLE_DUAL_STREAM_USE_ENCODING")&&gf.supportDualStreamEncoding){let k=this.localTrackMap.get(R4.LocalVideoLowTrack);if(k){let M=L._mediaStreamTrack.clone();k.track._originMediaStreamTrack.stop(),k.track._mediaStreamTrack=M,k.track._originMediaStreamTrack=M,await new lQ((L,M)=>{this.handleReplaceTrack(k.track,L,M,!0)})}}}filterTobePublishedTracks(L,k,M){let U=[],V=this.getAllTracks();L=uO(L=L.filter(L=>-1===V.indexOf(L)));let F,B=!1,j=this.localTrackMap.get(R4.LocalAudioTrack);for(let V of L){if(V instanceof Tp&&(this.localTrackMap.has(R4.LocalVideoTrack)||B?new f2(f1.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS).throw():(U.push({track:V,type:R4.LocalVideoTrack}),B=!0),k)){let L=this.getLowVideoTrack(V,M);U.push({track:L,type:R4.LocalVideoLowTrack})}if(V instanceof Ts){if(j){let L=j.track;if(L instanceof WL)fB([V]),L.addAudioTrack(V),this.bindLocalAudioTrackEvents(V,!0);else{let k=SB([L,V]);gc.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection will replace audioTrack [").concat(k.getTrackId(),"]")),this.replaceTrack(L,k)}}else F instanceof WL?(fB([V]),F.addAudioTrack(V)):F=F||!V._useAudioElement&&gf.webAudioMediaStreamDest&&!V._bypassWebAudio?SB(F?[V,F]:[V]):V}}return F&&(gc.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection will send audioTrack [").concat(F.getTrackId(),"]")),U.push({track:F,type:R4.LocalAudioTrack})),U}filterTobeUnpublishedTracks(L){let k=[],M=this.getAllTracks();for(let U of L=uO(L=L.filter(L=>-1!==M.indexOf(L)))){if(U instanceof Ts){let L=this.localTrackMap.get(R4.LocalAudioTrack);if(!L)continue;L.track instanceof WL?(L.track.removeAudioTrack(U),this.unbindLocalAudioTrackEvents(U),0===L.track.trackList.length&&(k.push([R4.LocalAudioTrack,L]),L.track.close())):k.push([R4.LocalAudioTrack,L])}if(U instanceof Tp){let L=this.localTrackMap.get(R4.LocalVideoTrack);if(!L)continue;k.push([R4.LocalVideoTrack,L]);let M=this.localTrackMap.get(R4.LocalVideoLowTrack);M&&k.push([R4.LocalVideoLowTrack,M])}}return k}filterTobePublishedDataChannels(L){return L=(L=uO(L)).filter(L=>-1===this.localDataChannels.findIndex(k=>k.id===L.id))}filterTobeUnpublishedDataChannels(L){return L=(L=(L=uO(L)).filter(L=>-1!==this.localDataChannels.indexOf(L))).filter(L=>L._originDataChannel)}bindLocalTrackEvents(L){L.forEach(L=>{let{track:k,type:M}=L;switch(M){case R4.LocalVideoTrack:k.addListener(gN.GET_STATS,this.handleGetLocalVideoStats),k.addListener(gN.GET_RTC_STATS,this.handleGetRTCStats),k.addListener(gN.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),k.addListener(gN.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),k.addListener(gN.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),k.addListener(gN.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this.handleUpdateVideoSendParameters),k.addListener(gN.NEED_REPLACE_TRACK,this.handleReplaceTrack),k.addListener(gN.NEED_MUTE_TRACK,this.handleMuteLocalTrack),k.addListener(gN.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case R4.LocalAudioTrack:this.bindLocalAudioTrackEvents(k);case R4.LocalVideoLowTrack:}})}bindLocalAudioTrackEvents(L,k){L instanceof WL?L.trackList.forEach(L=>{L.addListener(gN.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),L.addListener(gN.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),L.addListener(gN.GET_STATS,this.handleGetLocalAudioStats),L.addListener(gN.NEED_MUTE_TRACK,this.handleMuteLocalTrack),L.addListener(gN.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)}):(L.addListener(gN.GET_STATS,this.handleGetLocalAudioStats),L.addListener(gN.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),L.addListener(gN.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),L.addListener(gN.NEED_MUTE_TRACK,this.handleMuteLocalTrack),L.addListener(gN.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack),k||(L.addListener(gN.NEED_REPLACE_TRACK,this.handleReplaceTrack),L.addListener(gN.NEED_REPLACE_MIXING_TRACK,this.handleReplaceMixingTrack)))}unbindLocalTrackEvents(L){L||(L=Array.from(this.localTrackMap.entries()).map(L=>{let[k,{track:M}]=L;return{track:M,type:k}})),L.forEach(L=>{let{track:k,type:M}=L;switch(M){case R4.LocalVideoTrack:k.off(gN.GET_STATS,this.handleGetLocalVideoStats),k.off(gN.GET_RTC_STATS,this.handleGetRTCStats),k.off(gN.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),k.off(gN.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),k.off(gN.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),k.off(gN.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this.handleUpdateVideoSendParameters),k.off(gN.NEED_REPLACE_TRACK,this.handleReplaceTrack),k.off(gN.NEED_MUTE_TRACK,this.handleMuteLocalTrack),k.off(gN.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case R4.LocalAudioTrack:this.unbindLocalAudioTrackEvents(k);case R4.LocalVideoLowTrack:}})}unbindLocalAudioTrackEvents(L){L instanceof WL?L.trackList.forEach(L=>{L.off(gN.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),L.off(gN.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),L.off(gN.GET_STATS,this.handleGetLocalAudioStats),L.off(gN.NEED_MUTE_TRACK,this.handleMuteLocalTrack),L.off(gN.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)}):(L.off(gN.GET_STATS,this.handleGetLocalAudioStats),L.off(gN.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),L.off(gN.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),L.off(gN.NEED_REPLACE_TRACK,this.handleReplaceTrack),L.off(gN.NEED_REPLACE_MIXING_TRACK,this.handleReplaceMixingTrack),L.off(gN.NEED_MUTE_TRACK,this.handleMuteLocalTrack),L.off(gN.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack))}bindRemoteTrackEvents(L,k){k instanceof TE&&k.addListener(gN.GET_STATS,k=>{k(this.handleGetRemoteVideoStats(L))}),k instanceof Tf&&k.addListener(gN.GET_STATS,k=>{k(this.handleGetRemoteAudioStats(L))})}unbindRemoteTrackEvents(L){L&&L.removeAllListeners(gN.GET_STATS)}unbindAllRemoteTrackEvents(){Array.from(this.remoteUserMap.entries()).forEach(L=>{let[k,M]=L;M.has(R1.AUDIO)&&this.unbindRemoteTrackEvents(k._audioTrack),M.has(R1.VIDEO)&&this.unbindRemoteTrackEvents(k._videoTrack)})}createGatewayPublishMessage(L,k){return L.map((L,M)=>{var U;let V,F,{track:B,type:j}=L;switch(j){case R4.LocalAudioTrack:V=RG.Audio,F={dtx:B instanceof Tc&&B._config.DTX,hq:!1,lq:!1,stereo:!1,speech:!1};break;case R4.LocalVideoTrack:V=so(U=B._hints).call(U,gL.SCREEN_TRACK)?RG.Screen:RG.High,F=QB(QB({},sx(B)),{},{codec:this.store.codec,svc_mode:px()});break;case R4.LocalVideoLowTrack:V=RG.Low,F=QB(QB({},sx(B)),{},{codec:this.store.codec,svc_mode:px()})}return{stream_type:V,attributes:F,ssrcs:k[M]}})}createGatewayUnpublishMessage(L){return L.map(L=>{var k;let M,[U,{track:V,ssrcs:F,id:B}]=L;switch(U){case R4.LocalVideoTrack:M=so(k=V._hints).call(k,gL.SCREEN_TRACK)?RG.Screen:RG.High;break;case R4.LocalAudioTrack:M=RG.Audio;break;case R4.LocalVideoLowTrack:M=RG.Low}return{stream_type:M,ssrcs:F,mid:B}})}assignLocalTracks(L,k){L.forEach((L,M)=>{let{track:U,type:V}=L;this.localTrackMap.set(V,{track:U,id:k[M].id,ssrcs:k[M].localSSRC})})}withdrawLocalTracks(L){L.forEach(L=>{let[k]=L;this.localTrackMap.delete(k)})}bindConnectionEvents(L){L.onConnectionStateChange=async k=>{if(gc.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onConnectionStateChange(").concat(k,")")),this.emit(R8.PeerConnectionStateChange,k),"connecting"===k&&L instanceof IJ&&!iw()&&wN("FIRST_TCP_CANDIDATE")&&window.setTimeout(()=>{"connecting"===k&&L.extendCandidate()},wN("FIRST_TCP_CANDIDATE_INTERVAL")),"connected"!==k||this.store.keyMetrics.peerConnectionEnd||this.store.peerConnectionEnd(),"connected"===k&&(this._restartTimer&&(window.clearTimeout(this._restartTimer),this._restartTimer=void 0),L instanceof IJ&&qB(L,!0),this._isTryConnecting&&this.reportPCStats(Date.now(),!0,this._pcStatsUploadType),this._isTryConnecting=!1,this._isStartRestartIce=!1,this._pcStatsUploadType=R3.DISCONNECTED_OR_FAILED,"CONNECTED"===aO(this,R8.QueryClientConnectionState)&&this._isWaitPcToRePub)){let L=this.pendingLocalTracks.map(L=>L.getTrackId()),k=this.pendingLocalDataChannels.map(L=>"dc_".concat(L.id));g_.reportApiInvoke(this.store.sessionId,{name:f8.REPUB_AFTER_PC_CONNECTED,options:L.concat(k),tag:f9.TRACER}).onSuccess(),this.republish()}if(wN("NEW_ICE_RESTART")&&L instanceof IJ&&!iw()&&!this._forceTurn){if(so(R5).call(R5,k)){if(this._isStartRestartIce)return;this._isStartRestartIce=!0;let t=k=>{RB(L)&&(gc.debug("[".concat(this.store.clientId,"] [P2PChannel] try to restartICE, type is ").concat(k)),"CONNECTED"===aO(this,R8.QueryClientConnectionState)&&this.emit(R8.RequestRestartICE,k))},i=()=>{RB(L)&&(this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),gc.debug("[".concat(this.store.clientId,"] P2PConnection disconnected timeout, force reconnect")),setTimeout(()=>this.emit(R8.P2PLost),0),this.iceFailedCount+=1,this.requestReconnect())};return void(this._restartTimer=window.setTimeout(()=>{XB(L,t,i)},800))}}else{if("disconnected"===k&&"disconnected"===L.iceConnectionState)return setTimeout(()=>{"disconnected"===L.iceConnectionState&&wN("ICE_RESTART")&&"CONNECTED"===aO(this,R8.QueryClientConnectionState)&&this.emit(R8.RequestRestartICE)},800),void setTimeout(()=>{"disconnected"===L.peerConnectionState&&(gc.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection disconnected timeout 4000ms, force reconnect")),this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),this._isTryConnecting=!1,setTimeout(()=>this.emit(R8.P2PLost),0),this.iceFailedCount+=1,this.requestReconnect())},4e3);"failed"===k&&(gc.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection state failed, force reconnect")),this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),setTimeout(()=>this.emit(R8.P2PLost),0),this.iceFailedCount+=1,await this.requestReconnect())}},L.onICEConnectionStateChange=L=>{"connected"!==L||this.store.keyMetrics.iceConnectionEnd||this.store.iceConnectionEnd(),gc.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICEConnectionStateChange(").concat(L,")")),g_.reportApiInvoke(this.store.sessionId,{name:"ICEConnectionStateChange",options:L,tag:f9.TRACER}).onSuccess(),this.emit(R8.IceConnectionStateChange,L)},L.onICETransportStateChange=L=>{gc.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICETransportStateChange(").concat(L,")"))},L.onDTLSTransportStateChange=L=>{gc.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportStateChange(").concat(L,")"))},L.onDTLSTransportError=L=>{gc.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportError(").concat(L,")"))},L.onFirstAudioDecoded=L=>{var k,M;let U=Array.from(gn(k=this.remoteUserMap).call(k)).find(k=>k._audioSSRC===L);U&&(this.store.subscribe(U.uid,"audio",void 0,void 0,void 0,Date.now()),null===(M=U.audioTrack)||void 0===M||M.emit(gj.FIRST_FRAME_DECODED),g_.firstRemoteFrame(this.store.sessionId,gl.FIRST_AUDIO_DECODE,gh.FIRST_AUDIO_DECODE,{peer:U._uintid,subscribeElapse:IW.measureFromSubscribeStart(this.store.clientId,L),subscribeRequestid:L,p2pid:this.store.p2pId}))},L.onFirstAudioReceived=L=>{var k;let M=Array.from(gn(k=this.remoteUserMap).call(k)).find(k=>k._audioSSRC===L);M&&g_.firstRemoteFrame(this.store.sessionId,gl.FIRST_AUDIO_RECEIVED,gh.FIRST_AUDIO_RECEIVED,{peer:M._uintid,subscribeElapse:IW.measureFromSubscribeStart(this.store.clientId,L),subscribeRequestid:L,p2pid:this.store.p2pId})},L.onFirstVideoDecoded=(L,k,M)=>{var U;let V=Array.from(gn(U=this.remoteUserMap).call(U)).find(k=>k._videoSSRC===L);V&&this.store.firstVideoFrameDecoded(V.uid,{firstDecoded:Date.now()}),this.reportVideoFirstFrameDecoded(L,k,M)},L.onFirstVideoRender=L=>{var k;let M=Array.from(gn(k=this.remoteUserMap).call(k)).find(k=>k._videoSSRC===L);M&&(this.store.firstVideoFrameDecoded(M.uid,{firstPreRender:Date.now()}),this.reportVideoFirstFrameRender(M))},L.onFirstVideoReceived=L=>{var k;let M=Array.from(gn(k=this.remoteUserMap).call(k)).find(k=>k._videoSSRC===L);M&&(this.store.firstVideoFrameDecoded(M.uid,{firstReceived:Date.now()}),g_.firstRemoteFrame(this.store.sessionId,gl.FIRST_VIDEO_RECEIVED,gh.FIRST_VIDEO_RECEIVED,{peer:M._uintid,subscribeElapse:IW.measureFromSubscribeStart(this.store.clientId,L),subscribeRequestid:L,p2pid:this.store.p2pId}))},L.onSelectedLocalCandidateChanged=(L,k)=>{let M="relay"===L.candidateType,U="relay"===k.candidateType;"unknown"!==k.candidateType&&M===U||this.emit(R8.ConnectionTypeChange,M),gc.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedLocalCandidateChanged(").concat(JSON.stringify(ux(k))," -> ").concat(JSON.stringify(ux(L)),")"))},L.onSelectedRemoteCandidateChanged=(L,k)=>{gc.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedRemoteCandidateChanged(").concat(JSON.stringify(ux(k))," -> ").concat(JSON.stringify(ux(L)),")"))},L.onFirstVideoDecodedTimeout=L=>{this.reportVideoFirstFrameDecoded(L,void 0,void 0,!0)},L.getLocalVideoStats=()=>{let L=this.statsCollector.getLocalVideoTrackStats(),k=this.statsCollector.getRTCStats();return QB(QB({},L),k)},L.onICECandidateError=L=>{this._iceError=L}}resetConnection(L){L instanceof IJ&&(I5.delete(L.id),qB(L)),L.close(),this.emit(R8.PeerConnectionStateChange,"closed"),L.onConnectionStateChange=void 0,L.onICEConnectionStateChange=void 0,L.onICETransportStateChange=void 0,L.onDTLSTransportStateChange=void 0,L.onDTLSTransportError=void 0,L.onFirstAudioDecoded=void 0,L.onFirstAudioReceived=void 0,L.onFirstVideoDecoded=void 0,L.onFirstVideoReceived=void 0,L.onSelectedLocalCandidateChanged=void 0,L.onSelectedRemoteCandidateChanged=void 0,L.onFirstVideoDecodedTimeout=void 0,L.getLocalVideoStats=void 0,this._isWaitPcToRePub=!1}filterTobeMutedTracks(L){let k=[];if(-1===this.getAllTracks().indexOf(L))return k;let M=this.localTrackMap.get(R4.LocalAudioTrack);if(L instanceof Ts&&(null==M?void 0:M.track)instanceof WL)return M.track.isActive||k.push([R4.LocalAudioTrack,M]),k;let U=Array.from(this.localTrackMap.entries()).find(k=>{let[,{track:M}]=k;return L===M});if(U&&(k.push(U),U[0]===R4.LocalVideoTrack)){let L=this.localTrackMap.get(R4.LocalVideoLowTrack);L&&k.push([R4.LocalVideoLowTrack,L])}return k}filterTobeUnmutedTracks(L){let k=[],M=this.localTrackMap.get(R4.LocalAudioTrack);if(L instanceof Ts&&(null==M?void 0:M.track)instanceof WL)return M.track.isActive&&k.push([R4.LocalAudioTrack,M]),k;let U=Array.from(this.localTrackMap.entries()).find(k=>{let[,{track:M}]=k;return L===M});if(U){if(U[0]===R4.LocalVideoTrack){k.push(U);let L=this.localTrackMap.get(R4.LocalVideoLowTrack);L&&k.push([R4.LocalVideoLowTrack,L])}else k.push(U)}return k}createMuteMessage(L){return L.map(L=>{var k;let M,[U,{track:V,ssrcs:F,id:B}]=L;switch(U){case R4.LocalAudioTrack:M=RG.Audio;break;case R4.LocalVideoTrack:M=so(k=V._hints).call(k,gL.SCREEN_TRACK)?RG.Screen:RG.High;break;case R4.LocalVideoLowTrack:M=RG.Low}return{stream_type:M,ssrcs:F,mid:B}})}createUnmuteMessage(L){return L.map(L=>{var k;let M,[U,{track:V,ssrcs:F,id:B}]=L;switch(U){case R4.LocalAudioTrack:M=RG.Audio;break;case R4.LocalVideoTrack:M=so(k=V._hints).call(k,gL.SCREEN_TRACK)?RG.Screen:RG.High;break;case R4.LocalVideoLowTrack:M=RG.Low}return{stream_type:M,ssrcs:F,mid:B}})}filterTobeUnSubscribedTracks(L,k){let M=[],U=this.remoteUserMap.get(L);if(!U)return M;if(k){let V=U.get(k);if(!V)return M;M.push([L,{kind:k,id:V}])}else Array.from(U.entries()).forEach(k=>{let[U,V]=k;M.push([L,{kind:U,id:V}])});return M}filterTobeUnSubscribedDataChannels(L,k){let M=[];return k.forEach(k=>{var U;null!==(U=this.remoteDataChannelMap.get(L))&&void 0!==U&&U.has(k.id)&&M.push(k)}),M}createUnsubscribeMessage(L){let k=[];return L.forEach(L=>{let[M,{kind:U,id:V}]=L;switch(U){case R1.VIDEO:return void(M._videoSSRC&&k.push({stream_type:R1.VIDEO,ssrcId:M._videoSSRC}));case R1.AUDIO:return void(M._audioSSRC&&k.push({stream_type:R1.AUDIO,ssrcId:M._audioSSRC}))}}),k}createUnsubscribeAllMessage(L){let k=new Map;return L.forEach(L=>{let[M,{kind:U}]=L;if(k.has(M)){let L=k.get(M);U===R1.VIDEO?L|=RJ.Video:L|=RJ.Audio,k.set(M,L)}else U===R1.VIDEO?k.set(M,RJ.Video):k.set(M,RJ.Audio)}),{users:Array.from(k.entries()).map(L=>{let[k,M]=L;return{stream_id:k.uid,stream_type:M}})}}withdrawRemoteTracks(L){L.forEach(L=>{let[k,{kind:M}]=L,U=this.remoteUserMap.get(k);U&&(U.delete(M),0===Array.from(U.entries()).length&&this.remoteUserMap.delete(k))})}async updateBitrateLimit(L){let k=this.localTrackMap.get(R4.LocalVideoTrack),M=this.localTrackMap.get(R4.LocalVideoLowTrack);k&&(await k.track.setBitrateLimit(L.uplink),await new lQ((L,M)=>{this.handleUpdateVideoEncoder(k.track,L,M,!0)})),M&&L.low_stream_uplink&&(await M.track.setBitrateLimit({max_bitrate:L.low_stream_uplink.bitrate,min_bitrate:L.low_stream_uplink.bitrate||0}),await new lQ((L,k)=>{this.handleUpdateVideoEncoder(M.track,L,k,!0)}))}isP2PDisconnected(){return!this.connection||"connected"!==this.connection.peerConnectionState}isPreallocation(){return this.connection instanceof IJ&&this.connection.isPreallocation}isPreSub(){return this.connection instanceof IJ&&this.connection.isPreSub()}mapPubResToRemoteConfig(L,k,M){return L.map((L,U)=>{var V;let{stream_type:F}=L,B=null===(V=k.find(L=>{let{stream_type:k}=L;return F===k}))||void 0===V?void 0:V.attributes;if(B&&wN("DISABLE_SCREEN_SHARE_REMB")){let L=M[U]._hints;(so(L).call(L,gL.SCREEN_TRACK)||so(L).call(L,gL.SCREEN_LOW_TRACK))&&(B.remb=!1,gc.debug("disable remb for screen share, hints:",L))}return B})}async tryToUnmuteAudio(L){for(let M=0;M<L.length;M++)if(L[M]instanceof Ts){var k;let U=this.filterTobeUnmutedTracks(L[M]);if(0===U.length)continue;await (null===(k=this.connection)||void 0===k?void 0:k.unmuteLocal(U.map(L=>{let[,{id:k}]=L;return k})));let V=this.createUnmuteMessage(U);return void await sO(this,R8.RequestUnmuteLocal,V)}}bindStatsUploaderEvents(){this.statsUploader.requestStats=()=>this.getStats(),this.statsUploader.requestLocalMedia=()=>Array.from(this.localTrackMap.entries()),this.statsUploader.requestRemoteMedia=()=>Array.from(this.remoteUserMap.entries()),this.statsUploader.requestVideoIsReady=L=>{var k;return!(null===(k=this.connection)||void 0===k||!k.getRemoteVideoIsReady(L))},this.statsUploader.requestUpload=(L,k)=>this.emit(R8.RequestUpload,L,k),this.statsUploader.requestUploadStats=L=>this.emit(R8.RequestUploadStats,L),this.statsUploader.requestAllTracks=()=>this.getAllTracks(),this.statsUploader.requestTransportStats=()=>{var L;return{connectState:(null===(L=this.connection)||void 0===L?void 0:L.peerConnectionState)||"closed"}}}unbindStatsUploaderEvents(){this.statsUploader.requestStats=void 0,this.statsUploader.requestLocalMedia=void 0,this.statsUploader.requestRemoteMedia=void 0,this.statsUploader.requestVideoIsReady=void 0}async requestReconnect(){this.dtlsFailedCount+=1,await yO(jO(this.dtlsFailedCount,Sm)),this.emit(R8.RequestReconnect)}async reconnectP2P(){let L=Array.from(this.localTrackMap.entries()),k=this.createGatewayUnpublishMessage(L);Array.from(this.remoteUserMap.entries()),k.length>0&&await oO(this,R8.RequestUnpublishForReconnectPC,k),this.disconnectForReconnect(),this.emit(R8.RequestReconnectPC)}canPublishLowStream(){return this.localTrackMap.has(R4.LocalVideoTrack)||this.pendingLocalTracks.some(L=>L instanceof Tp)}throwIfTrackTypeNotMatch(L){if(L.filter(L=>L instanceof Tp).length>1)throw new f2(f1.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(L.filter(L=>L instanceof Ts).length>1&&(L.some(L=>L instanceof Ts&&L._bypassWebAudio)||!gf.webAudioMediaStreamDest))throw new f2(f1.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode");for(let k of L){if(k instanceof Tp&&this.pendingLocalTracks.some(L=>L instanceof Tp))throw new f2(f1.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(k instanceof Ts&&this.pendingLocalTracks.some(L=>L instanceof Ts)&&(!gf.webAudioMediaStreamDest||k._bypassWebAudio||this.pendingLocalTracks.some(L=>L instanceof Ts&&L._bypassWebAudio)))throw new f2(f1.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode")}}getLowVideoTrack(L,k){var M;let U;let V=!wN("DISABLE_DUAL_STREAM_USE_ENCODING")&&gf.supportDualStreamEncoding,F=QB(QB({},{width:160,height:120,framerate:15,bitrate:50}),k);U=V?L._mediaStreamTrack.clone():wB(L,F);let B=IO(8,"track-low-"),j=new Tp(U,QB(QB({},V&&{scaleResolutionDownBy:lx(F,L)}),{},{frameRate:F.framerate,bitrateMax:F.bitrate,bitrateMin:F.bitrate}),void 0,void 0,B);return j.on(gF.TRANSCEIVER_UPDATED,k=>{L._updateRtpTransceiver(k,gk.LOW_STREAM)}),j._hints.push(gL.LOW_STREAM),so(M=L._hints).call(M,gL.SCREEN_TRACK)&&j._hints.push(gL.SCREEN_LOW_TRACK),L.on("sei-to-send",L=>{j.emit("sei-to-send",L)}),L.addListener(gN.NEED_CLOSE,()=>{j.close()}),j}async globalLock(){return this.mutex.lock("From P2PChannel.globalLock")}async reportPCStats(L,k,M){let U=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;if(this.connection&&this.connection instanceof IJ){var V,F,B,j;let G=this.store.keyMetrics.descriptionStart||0,{iceConnectionState:X,dtlsTransportState:$,peerConnectionState:ee}=this.connection,{local:et,remote:ei}=await this.connection.getSelectedCandidatePair();g_.pcStats(this.store.sessionId,{startTime:G,eventElapse:L-G||0,iceconnectionsate:X,dtlsstate:$,connectionstate:ee,intSucc:k?1:2,error:this._iceError||U||"",selectedLocalCandidateProtocol:null!==(V=null==et?void 0:et.protocol)&&void 0!==V?V:"",selectedLocalCandidateType:null!==(F=et.candidateType)&&void 0!==F?F:"",selectedLocalCandidateAddress:"".concat(et.address,":").concat(et.port),selectedRemoteCandidateProtocol:null!==(B=ei.protocol)&&void 0!==B?B:"",selectedRemoteCandidateType:null!==(j=ei.candidateType)&&void 0!==j?j:"",selectedRemoteCandidateAddress:"".concat(ei.address,":").concat(ei.port),restartCnt:M,preallocation:this.connection.isPreallocation}),this._iceError=null}}reportVideoFirstFrameRender(L){let k=this.store.keyMetrics,M=k.firstVideoFrameDecoded.find(k=>k.userId===L.uid);if(!M)return;let{isInternalUpload:U,isExternalUpload:V}=M;if(U&&V)return;let{subscribeEnd:F,firstPreRender:B,peerPublishDuration:j,peerPubStatusMs:G}=M,{firstRender:X=0}=M;if(F&&(X||B)&&j&&G){M.isInternalUpload=!0;let{playEnd:U}=M;U&&(M.isExternalUpload=!0);let{firstPreRender:V=0}=M;X=V||X;let B=L.videoTrack,$={peer:L._uintid,width:(null==B?void 0:B._videoWidth)||0,height:(null==B?void 0:B._videoHeight)||0,ssrc:L._videoSSRC||0,p2pid:this.store.p2pId,peerPublishDuration:j,peerPubStatusMs:G,joinChannelStart:k.joinStart||0,preloadStart:k.preloadStart||0,preloadEnd:k.preloadEnd||0,apStart:k.requestAPStart||0,apEnd:k.requestAPEnd||0,suaEnd:k.requestSUAEnd||0,beforeConnect:k.beforeConnect||0,peerReceiver:k.peerReceiver||0,ice:k.iceConnectionEnd||0,pc:k.peerConnectionEnd||0,signalConnected:k.signalConnected||0,joinReq:k.joinReq||0,joinRes:k.joinRep||0,userJoinNotify:M.userJoinNotify||0,videoAddNotify:M.videoAddNotify||0,subscribeStart:M.subscribeStart||0,subscribeEnd:M.subscribeEnd||0,firstReceived:M.firstReceived||0,firstDecoded:M.firstDecoded||0,firstPreRender:V||0,firstRender:U?Math.max(X,U):Math.max(X,F),playStart:M.playStart||0,playEnd:M.playEnd||0,isPreSub:!(!L._videoSSRC||!this.isPreSubScribe(L._videoSSRC)),isPrePc:this.isPreallocation(),isPreInstantVideo:RD(this.store)};g_.firstXLAPeerFirstVideoFrame(this.store.sessionId,$)}}reportVideoFirstFrameDecoded(L,k,M,U){var V;let F=Array.from(gn(V=this.remoteUserMap).call(V)).find(k=>k._videoSSRC===L);if(F){U||this.store.subscribe(F.uid,"video",void 0,void 0,void 0,void 0,Date.now());let V=this.store.keyMetrics,B=V.subscribe.find(L=>L.userId===F.uid&&"video"===L.type);g_.firstRemoteVideoDecode(this.store.sessionId,gl.FIRST_VIDEO_DECODE,gh.FIRST_VIDEO_DECODE,{peer:F._uintid,videowidth:k,videoheight:M,subscribeElapse:IW.measureFromSubscribeStart(this.store.clientId,L),subscribeRequestid:L,p2pid:this.store.p2pId,apEnd:V.requestAPEnd||0,apStart:V.requestAPStart||0,joinGwEnd:V.joinGatewayEnd||0,joinGwStart:V.joinGatewayStart||0,pcEnd:V.peerConnectionEnd||0,pcStart:V.peerConnectionStart||0,subscriberEnd:(null==B?void 0:B.subscribeEnd)||0,subscriberStart:(null==B?void 0:B.subscribeStart)||0,videoAddNotify:(null==B?void 0:B.streamAdded)||0,state:U?1:0,firstFrame:(null==B?void 0:B.firstFrame)||0})}}async remoteMediaSsrcChanged(L,k,M){if(!this.connection)return!1;let U=this.remoteUserMap.get(L);if(!U)return!1;let V=U.get(k);if(!V)return!1;let F=await this.connection.getRemoteSSRC(V);return void 0!==F&&F!==M}unbindRtpTransceiver(){0!==this.localTrackMap.size&&Array.from(this.localTrackMap.entries()).forEach(L=>{let[k,{track:M}]=L;k===R4.LocalVideoLowTrack?M._updateRtpTransceiver(void 0,gk.LOW_STREAM):M._updateRtpTransceiver(void 0)})}}).prototype,"startP2PConnection",[ij],Object.getOwnPropertyDescriptor(nr.prototype,"startP2PConnection"),nr.prototype),OU(nr.prototype,"connect",[ij],Object.getOwnPropertyDescriptor(nr.prototype,"connect"),nr.prototype),OU(nr.prototype,"updateRemoteRTPCapabilities",[ij],Object.getOwnPropertyDescriptor(nr.prototype,"updateRemoteRTPCapabilities"),nr.prototype),OU(nr.prototype,"publishDataChannel",[ij],Object.getOwnPropertyDescriptor(nr.prototype,"publishDataChannel"),nr.prototype),OU(nr.prototype,"unpublish",[ij],Object.getOwnPropertyDescriptor(nr.prototype,"unpublish"),nr.prototype),OU(nr.prototype,"unpublishDataChannel",[ij],Object.getOwnPropertyDescriptor(nr.prototype,"unpublishDataChannel"),nr.prototype),OU(nr.prototype,"unpublishLowStream",[ij],Object.getOwnPropertyDescriptor(nr.prototype,"unpublishLowStream"),nr.prototype),OU(nr.prototype,"subscribeDataChannel",[ij],Object.getOwnPropertyDescriptor(nr.prototype,"subscribeDataChannel"),nr.prototype),OU(nr.prototype,"subscribe",[ij],Object.getOwnPropertyDescriptor(nr.prototype,"subscribe"),nr.prototype),OU(nr.prototype,"massSubscribe",[ij],Object.getOwnPropertyDescriptor(nr.prototype,"massSubscribe"),nr.prototype),OU(nr.prototype,"unsubscribe",[ij],Object.getOwnPropertyDescriptor(nr.prototype,"unsubscribe"),nr.prototype),OU(nr.prototype,"unsubscribeDataChannel",[ij],Object.getOwnPropertyDescriptor(nr.prototype,"unsubscribeDataChannel"),nr.prototype),OU(nr.prototype,"massUnsubscribe",[ij],Object.getOwnPropertyDescriptor(nr.prototype,"massUnsubscribe"),nr.prototype),OU(nr.prototype,"muteRemote",[ij],Object.getOwnPropertyDescriptor(nr.prototype,"muteRemote"),nr.prototype),OU(nr.prototype,"unmuteRemote",[ij],Object.getOwnPropertyDescriptor(nr.prototype,"unmuteRemote"),nr.prototype),OU(nr.prototype,"hasRemoteMediaWithLock",[ij],Object.getOwnPropertyDescriptor(nr.prototype,"hasRemoteMediaWithLock"),nr.prototype),OU(nr.prototype,"disconnectForReconnect",[ij],Object.getOwnPropertyDescriptor(nr.prototype,"disconnectForReconnect"),nr.prototype),OU(nr.prototype,"updateBitrateLimit",[ij],Object.getOwnPropertyDescriptor(nr.prototype,"updateBitrateLimit"),nr.prototype),OU(nr.prototype,"remoteMediaSsrcChanged",[ij],Object.getOwnPropertyDescriptor(nr.prototype,"remoteMediaSsrcChanged"),nr.prototype),nr);function ij(L,k,M){let U=L[k];if("function"!=typeof U)throw Error("Cannot use mutex on object property.");return M.value=async function(){let L=this.mutex,M=await L.lock("From P2PChannel.".concat(k));try{for(var V=arguments.length,F=Array(V),B=0;B<V;B++)F[B]=arguments[B];return await U.apply(this,F)}finally{M()}},M}function nj(L,k){var M=Object.keys(L);if(Object.getOwnPropertySymbols){var U=Object.getOwnPropertySymbols(L);k&&(U=U.filter(function(k){return Object.getOwnPropertyDescriptor(L,k).enumerable})),M.push.apply(M,U)}return M}function rj(L){for(var k=1;k<arguments.length;k++){var M=null!=arguments[k]?arguments[k]:{};k%2?nj(Object(M),!0).forEach(function(k){uI(L,k,M[k])}):Object.getOwnPropertyDescriptors?Object.defineProperties(L,Object.getOwnPropertyDescriptors(M)):nj(Object(M)).forEach(function(k){Object.defineProperty(L,k,Object.getOwnPropertyDescriptor(M,k))})}return L}let I9=Date.now(),I7=new Map,ve=new Map;async function dj(L){let k=I7.get(L),M=Array.isArray(k)&&k[k.length-1],U=ve.get(L);if(!M)return void(U.isSyncing=!1);let V={uid:M.uid,payload:M.payload};0===U.firstRecvTs&&(U.firstRecvTs=M.recvTs,U.firstSendTs=M.sendTs);let F=M.sendTs-U.firstSendTs,B=F-(Date.now()-U.firstRecvTs);B>0&&(U.firstRecvTs=Date.now()-F);let j=M.mediaDelay+B;j<=0?(k.pop(),lj(M.context,V),j=0):j=Math.min(j,20),setTimeout(()=>k.length&&dj(L),j)}function lj(L,k){L.safeEmit(Si.STREAM_MESSAGE,k.uid,k.payload),L.onStreamMessage&&L.onStreamMessage(k)}function uj(L){var k;let M=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,U=arguments.length>2?arguments[2]:void 0;if(!L.syncWithAudio)return lj(U,{uid:L.uid,payload:L.payload});let V="".concat(U.id,"-").concat(L.uid),F=I7.get(V)||[],B=F.findIndex(k=>L.sendTs>=k.sendTs),j=rj(rj({},L),{},{context:U,mediaDelay:M,recvTs:Date.now()});-1===B?F.push(j):F.splice(B,0,j),I7.set(V,F);let G=!1;ve.has(V)?G=!(null===(k=ve.get(V))||void 0===k||!k.isSyncing):ve.set(V,{isSyncing:G,firstRecvTs:0,firstSendTs:0}),G||dj(V)}let vt=zA().name;function pj(L,k){var M=Object.keys(L);if(Object.getOwnPropertySymbols){var U=Object.getOwnPropertySymbols(L);k&&(U=U.filter(function(k){return Object.getOwnPropertyDescriptor(L,k).enumerable})),M.push.apply(M,U)}return M}function _j(L){for(var k=1;k<arguments.length;k++){var M=null!=arguments[k]?arguments[k]:{};k%2?pj(Object(M),!0).forEach(function(k){uI(L,k,M[k])}):Object.getOwnPropertyDescriptors?Object.defineProperties(L,Object.getOwnPropertyDescriptors(M)):pj(Object(M)).forEach(function(k){Object.defineProperty(L,k,Object.getOwnPropertyDescriptor(M,k))})}return L}let vi="websdk_ng_cache_parameter",vr=wN("MAX_PRELOAD_ASYNC_LENGTH"),vn=new Map,va=[],vo=null,vs=0,vc=0,vd=new Map,vl=function(L,k){let M=[],U=0,r=async()=>{let L=M.shift();L&&await L(),M.length>0&&U<k?r():U--};return async function(){for(var V=arguments.length,F=Array(V),B=0;B<V;B++)F[B]=arguments[B];return new lQ(async(V,B)=>{M.push(async()=>{try{let k=await L(...F);V(k)}catch(L){B(L)}}),U<k&&(U++,r())})}}(bj,vr),vh=fG.CancelToken.source();async function bj(L,k,M,U,V,F){try{let B,j;if(!wN("ENABLE_PRELOAD"))return;if(!gf.supportWebCrypto)return void mO(()=>{gc.warn("Your browser does not support preloading, this feature  be run in a secure environment")},"preload_webcrypto_not_supported");if(!M&&null!==M)throw new f2(f1.INVALID_PARAMS,"Invalid token: ".concat(M,". If you don not use token, set it to null"));M&&kw(M,"token",1,2047),kw(L,"appid",1,2047),GU(k),U&&WU(U);let G=bO();gc.debug("preload channel ".concat(k,", uid is ").concat(U));let X={appId:L,cname:k,token:M||L,uid:"string"!=typeof U?U:null,sid:G,proxyServer:V};"string"==typeof U?(X.stringUid=U,[j,B]=await lQ.all([MF(U,{sid:G,appId:L},vh.token),VF(_j(_j({},X),{},{token:M||L,uid:0}),vh.token)]),X.uid=j.uid,B.gatewayInfo.uid=X.uid,B.gatewayInfo.res.uid=X.uid):(F&&(X.stringUid=F),B=await VF(X,vh.token));let $={sid:G,appId:L,cname:k,token:M||L,uid:X.stringUid||U,intUid:X.uid||B.gatewayInfo.uid,stringUid:X.stringUid,ts:Date.now(),sua:j,ap:B};await async function(L){let k;try{L.uid&&wj({appId:L.appId,cname:L.cname,token:L.token,uid:L.uid,stringUid:L.stringUid});let M=kj(L),U=await async function(L,k){try{let M=await window.crypto.subtle.importKey("raw",gO(k),"AES-GCM",!1,["encrypt"]),U=await window.crypto.subtle.encrypt({name:"AES-GCM",iv:new Uint8Array(1)},M,fO(window.btoa(JSON.stringify(L))));return SO(new Uint8Array(U))}catch(L){return}}(L,L.token||L.appId);if(!U)return;k=Pj(vi);let V=k?JSON.parse(k):[];V.push({[M]:U}),V.length>wN("AP_CACHE_NUM")&&V.shift(),Lj(vi,JSON.stringify(V))}catch(L){gc.warn("Error caching server parameters:",L.message),Lj(vi,"")}}($),vs++}catch(L){throw vc++,function(L){vo||(vo=window.setTimeout(()=>{let k="";vd.forEach((L,M)=>{k+="".concat(M,": ").concat(L," ;")}),g_.reportApiInvoke(null,{name:f8.PRELOAD,options:{success:vs,failed:vc,err:k}}).onError(L),vs=0,vc=0,vd.clear(),vo=null},1e4));let k=vd.get(L.code)||0;vd.set(L.code,k+1)}(L),L}}async function Aj(L){try{if(wN("AP_REQUEST_DETAIL")||wN("ENABLE_ROLE_SELECT_EDGE"))return;let k=wj(L);if(!k||"disabled"!==L.cloudProxyServer)return;let M=await async function(L,k){try{let M=await window.crypto.subtle.importKey("raw",gO(k),"AES-GCM",!1,["decrypt"]),U=await window.crypto.subtle.decrypt({name:"AES-GCM",iv:new Uint8Array(1)},M,fO(L));return JSON.parse(window.atob(SO(new Uint8Array(U))))}catch(L){return}}(k,L.token||L.appId);if(!M||!function(L,k){let M=L.cname===k.cname&&L.appId===k.appId&&L.token===k.token;return!!M&&(k.stringUid?L.stringUid===k.stringUid:"number"==typeof k.uid?L.uid===k.uid:L.uid==k.uid)}(M,L))return;if(M&&Date.now()-M.ts<wN("AP_CACHE_LIFETIME"))return M}catch(L){gc.warn("Error get preloadInfo",L.message)}}function wj(L){let k;try{if(!(k=Pj(vi)))return;let M=JSON.parse(k),U=kj(L),V=function(L,k){for(let M=L.length-1;M>=0;M--)if(k(L[M]))return M;return -1}(M,L=>U in L);if(-1===V)return;let F=M.splice(V,1)[0];return Lj(vi,JSON.stringify(M)),F[U]}catch(L){gc.warn("Error delete preload info: ".concat(k),L.message),Lj(vi,"")}}function Oj(L){if(L){let k=vn.get(L);k&&(window.clearTimeout(k),k=null,vn.delete(L)),so(va).call(va,L)||"disabled"!==L.cloudProxyServer||va.push(L)}if(vn.size<wN("AP_CACHE_NUM")&&va.length>0){let L=va.shift();vn.set(L,window.setTimeout(async()=>{let{appId:k,cname:M,token:U,stringUid:V,uid:F,proxyServer:B}=L;try{await vl(k,M,U,F,B,V),vn.has(L)&&Oj(L)}catch(k){gc.warn("update preload failed",k.message),Nj(L)}},wN("AP_UPDATE_INTERVAL")))}}function Nj(L){let k=va.indexOf(L);-1!==k&&va.splice(k,1);let M=vn.get(L);M&&(window.clearTimeout(M),M=null,vn.delete(L),Oj())}function Dj(L,k){let M=L.sua,U=L.ap;k&&M&&g_.reqUserAccount(L.sid,{lts:M.requestTime,elapse:M.elapse,success:!0,serverAddr:M.url,stringUid:k,uid:L.intUid,errorCode:null,extend:M.req}),g_.reportResourceTiming(L.ap.url,L.sid),g_.joinWebProxyAP(L.sid,{lts:U.requestTime,elapse:U.elapse,sucess:1,apServerAddr:U.url,turnServerAddrList:U.proxyInfo.addresses.map(L=>L.ip).join(","),eventType:"disabled",unilbsServerIds:[II.CHOOSE_SERVER,II.CLOUD_PROXY_FALLBACK].toString()}),g_.joinChooseServer(L.sid,{lts:U.requestTime,elapse:U.elapse,succ:!0,csAddr:U.url,opid:U.opid,serverList:U.gatewayInfo.gatewayAddrs.map(L=>L.address),ec:null,cid:U.gatewayInfo.cid.toString(),uid:U.gatewayInfo.uid.toString(),csIp:U.gatewayInfo.csIp,unilbsServerIds:[II.CHOOSE_SERVER].toString(),isHttp3:U.isHttp3})}function Pj(L){return window.atob(window.localStorage.getItem(L)||"")}function Lj(L,k){window.localStorage.setItem(L,window.btoa(k))}function kj(L){let k="".concat(L.appId,"_").concat(L.cname);return"string"==typeof L.uid&&(k+="_s_".concat(L.uid)),"number"==typeof L.uid&&(k+="_".concat(L.uid)),L.token&&(k+="_".concat(L.token)),MO(k)}function Mj(L){let k,M,U,V,F,B,j,G,X,$,ee,et,ei,er,en,ea,eo,es,ec,ed,el,eu,eh,ep,e_=function(){let L=vp.pop();return L?(L.offset=L.limit=0,L):{bytes:new Uint8Array(64),offset:0,limit:0}}();return void 0!==(k=L.appId)&&(Jj(e_,10),Yj(e_,k)),void 0!==(M=L.cid)&&(Jj(e_,16),Jj(e_,M)),void 0!==(U=L.cname)&&(Jj(e_,26),Yj(e_,U)),void 0!==(V=L.deviceId)&&(Jj(e_,34),Yj(e_,V)),void 0!==(F=L.elapse)&&(Jj(e_,40),Qj(e_,F)),void 0!==(B=L.fileSize)&&(Jj(e_,48),Qj(e_,xj(B))),void 0!==(j=L.height)&&(Jj(e_,56),Qj(e_,xj(j))),void 0!==(G=L.jpg)&&(Jj(e_,66),Jj(e_,G.length),Hj(e_,G)),void 0!==(X=L.networkType)&&(Jj(e_,72),Qj(e_,xj(X))),void 0!==($=L.osType)&&(Jj(e_,80),Qj(e_,xj($))),void 0!==(ee=L.requestId)&&(Jj(e_,90),Yj(e_,ee)),void 0!==(et=L.sdkVersion)&&(Jj(e_,98),Yj(e_,et)),void 0!==(ei=L.sequence)&&(Jj(e_,104),Qj(e_,xj(ei))),void 0!==(er=L.sid)&&(Jj(e_,114),Yj(e_,er)),void 0!==(en=L.timestamp)&&(Jj(e_,120),Qj(e_,en)),void 0!==(ea=L.uid)&&(Jj(e_,128),Jj(e_,ea)),void 0!==(eo=L.vid)&&(Jj(e_,136),Jj(e_,eo)),void 0!==(es=L.width)&&(Jj(e_,144),Qj(e_,xj(es))),void 0!==(ec=L.service)&&(Jj(e_,152),Jj(e_,ec)),void 0!==(ed=L.callbackData)&&(Jj(e_,162),Jj(e_,ed.length),Hj(e_,ed)),void 0!==(el=L.ticket)&&(Jj(e_,170),Yj(e_,el)),void 0!==(eu=L.vendorConfigs)&&(Jj(e_,178),Yj(e_,eu)),eh=e_.bytes,ep=e_.limit,eh.length===ep?eh:eh.subarray(0,ep)}function Uj(L){return function(L){let k={};e:for(;!jj(L);){let M=Xj(L);switch(M>>>3){case 0:break e;case 1:k.code=Xj(L);break;case 2:k.msg=Kj(L,Xj(L));break;case 3:k.requestId=Kj(L,Xj(L));break;case 4:k.timestamp=Zj(L,!1);break;default:Vj(L,7&M)}}return k}({bytes:L,offset:0,limit:L.length})}function Vj(L,k){switch(k){case 0:for(;128&zj(L););break;case 2:Bj(L,Xj(L));break;case 5:Bj(L,4);break;case 1:Bj(L,8);break;default:throw Error("Unimplemented type: "+k)}}function xj(L){return{low:L|=0,high:L>>31,unsigned:L>=0}}let vp=[];function Bj(L,k){if(L.offset+k>L.limit)throw Error("Skip past limit");L.offset+=k}function jj(L){return L.offset>=L.limit}function Gj(L,k){let M=L.bytes,U=L.offset,V=L.limit,F=U+k;if(F>M.length){let k=new Uint8Array(2*F);k.set(M),L.bytes=k}return L.offset=F,F>V&&(L.limit=F),U}function Wj(L,k){let M=L.offset;if(M+k>L.limit)throw Error("Read past limit");return L.offset+=k,M}function Hj(L,k){let M=Gj(L,k.length);L.bytes.set(k,M)}function Kj(L,k){let M=Wj(L,k),U=String.fromCharCode,V=L.bytes,F="";for(let L=0;L<k;L++){let B,j,G,X,$=V[L+M];0==(128&$)?F+=U($):192==(224&$)?L+1>=k?F+="�":128!=(192&(B=V[L+M+1]))?F+="�":(X=(31&$)<<6|63&B)<128?F+="�":(F+=U(X),L++):224==(240&$)?L+2>=k?F+="�":32896!=(49344&((B=V[L+M+1])|(j=V[L+M+2])<<8))?F+="�":(X=(15&$)<<12|(63&B)<<6|63&j)<2048||X>=55296&&X<=57343?F+="�":(F+=U(X),L+=2):240==(248&$)?L+3>=k?F+="�":8421504!=(12632256&((B=V[L+M+1])|(j=V[L+M+2])<<8|(G=V[L+M+3])<<16))?F+="�":(X=(7&$)<<18|(63&B)<<12|(63&j)<<6|63&G)<65536||X>1114111?F+="�":(X-=65536,F+=U(55296+(X>>10),56320+(1023&X)),L+=3):F+="�"}return F}function Yj(L,k){let M=k.length,U=0;for(let L=0;L<M;L++){let V=k.charCodeAt(L);V>=55296&&V<=56319&&L+1<M&&(V=(V<<10)+k.charCodeAt(++L)-56613888),U+=V<128?1:V<2048?2:V<65536?3:4}Jj(L,U);let V=Gj(L,U),F=L.bytes;for(let L=0;L<M;L++){let U=k.charCodeAt(L);U>=55296&&U<=56319&&L+1<M&&(U=(U<<10)+k.charCodeAt(++L)-56613888),U<128?F[V++]=U:(U<2048?F[V++]=U>>6&31|192:(U<65536?F[V++]=U>>12&15|224:(F[V++]=U>>18&7|240,F[V++]=U>>12&63|128),F[V++]=U>>6&63|128),F[V++]=63&U|128)}}function zj(L){return L.bytes[Wj(L,1)]}function qj(L,k){let M=Gj(L,1);L.bytes[M]=k}function Xj(L){let k,M=0,U=0;do k=zj(L),M<32&&(U|=(127&k)<<M),M+=7;while(128&k);return U}function Jj(L,k){for(k>>>=0;k>=128;)qj(L,127&k|128),k>>>=7;qj(L,k)}function Zj(L,k){let M,U=0,V=0,F=0;return U=127&(M=zj(L)),128&M&&(U|=(127&(M=zj(L)))<<7,128&M&&(U|=(127&(M=zj(L)))<<14,128&M&&(U|=(127&(M=zj(L)))<<21,128&M&&(V=127&(M=zj(L)),128&M&&(V|=(127&(M=zj(L)))<<7,128&M&&(V|=(127&(M=zj(L)))<<14,128&M&&(V|=(127&(M=zj(L)))<<21,128&M&&(F=127&(M=zj(L)),128&M&&(F|=(127&(M=zj(L)))<<7))))))))),{low:U|V<<28,high:V>>>4|F<<24,unsigned:k}}function Qj(L,k){let M=k.low>>>0,U=(k.low>>>28|k.high<<4)>>>0,V=k.high>>>24,F=0===V?0===U?M<16384?M<128?1:2:M<2097152?3:4:U<16384?U<128?5:6:U<2097152?7:8:V<128?9:10,B=Gj(L,F),j=L.bytes;switch(F){case 10:j[B+9]=V>>>7&1;case 9:j[B+8]=9!==F?128|V:127&V;case 8:j[B+7]=8!==F?U>>>21|128:U>>>21&127;case 7:j[B+6]=7!==F?U>>>14|128:U>>>14&127;case 6:j[B+5]=6!==F?U>>>7|128:U>>>7&127;case 5:j[B+4]=5!==F?128|U:127&U;case 4:j[B+3]=4!==F?M>>>21|128:M>>>21&127;case 3:j[B+2]=3!==F?M>>>14|128:M>>>14&127;case 2:j[B+1]=2!==F?M>>>7|128:M>>>7&127;case 1:j[B]=1!==F?128|M:127&M}}let v_={},vE={},vm=18446744073709552e3/2,vf=dG(0,!0),vS=dG(0),vg=lG(0,-2147483648,!1),vT=lG(-1,2147483647,!1),vR=lG(-1,-1,!0);function dG(L,k){let M,U,V;return k?(V=0<=(L>>>=0)&&L<256)&&(U=vE[L])?U:(M=lG(L,0,!0),V&&(vE[L]=M),M):(V=-128<=(L|=0)&&L<128)&&(U=v_[L])?U:(M=lG(L,L<0?-1:0,!1),V&&(v_[L]=M),M)}function lG(L,k,M){return{low:0|L,high:0|k,unsigned:!!M}}function uG(L,k){if(isNaN(L))return k?vf:vS;if(k){if(L<0)return vf;if(L>=18446744073709552e3)return vR}else{if(L<=-vm)return vg;if(L+1>=vm)return vT}return L<0?k?vf:vS:lG(L%4294967296|0,L/4294967296|0,k)}function hG(L,k){var M=Object.keys(L);if(Object.getOwnPropertySymbols){var U=Object.getOwnPropertySymbols(L);k&&(U=U.filter(function(k){return Object.getOwnPropertyDescriptor(L,k).enumerable})),M.push.apply(M,U)}return M}let pG=class pG extends Hw{get connectionState(){return this._connectionState}set connectionState(L){if(this._connectionState===L)return;let k=this._connectionState;this._connectionState=L,this.emit(In.CONNECTION_STATE_CHANGE,L,k)}get quality(){return this._quality}set quality(L){this._quality=L>1?1:L<.1?.1:L,this._qualityTimer&&(window.clearTimeout(this._qualityTimer),this._qualityTimer=null),this._quality>=1||(this._qualityTimer=window.setTimeout(()=>{this.quality=this._quality/this._qualityRatio},6e4))}constructor(L){var k;super(),uI(this,"name","AgoraRTCImageModeration"),uI(this,"_connectionState",Ir.CONNECTING),uI(this,"_sequence",0),uI(this,"_moderationStartTime",void 0),uI(this,"_workerConnection",void 0),uI(this,"_workerMessageLengthLimit",void 0),uI(this,"_qualityRatio",void 0),uI(this,"_connectInfo",void 0),uI(this,"_cancelTokenSource",fG.CancelToken.source()),uI(this,"_retryConfig",void 0),uI(this,"_moderationInterval",void 0),uI(this,"_moderationTimer",null),uI(this,"_moderationMode",1),uI(this,"_quality",1),uI(this,"_qualityTimer",null),uI(this,"_ticket",void 0),uI(this,"_moderationIntervalMinimum",void 0),uI(this,"_uploadFailedNum",0),uI(this,"_uploadNum",0),uI(this,"_uploadTimer",null),uI(this,"_extraInfo",void 0),uI(this,"_vendor",""),uI(this,"_encoder",new TextEncoder),uI(this,"_moderationId",void 0),uI(this,"inspectImage",()=>{if(this.connectionState!==Ir.CONNECTED)throw new ED(f1.OPERATION_ABORTED,"image moderation service connection status is ".concat(this.connectionState));this._moderationTimer&&(window.clearInterval(this._moderationTimer),this._moderationTimer=null),this._moderationTimer=window.setInterval(()=>{this.connectionState===Ir.CONNECTED?this.requestToInspectImage():gc.debug("[".concat(this._moderationId,"] Moderation State is not connected , "),this.connectionState)},this._moderationInterval<this._moderationIntervalMinimum?this._moderationIntervalMinimum:this._moderationInterval),this.requestToInspectImage()}),this._moderationId=IO(5,"image-moderation-"),this._workerMessageLengthLimit=wN("IMAGE_MODERATION_WORKER_MESSAGE_LENGTH_LIMIT"),this._moderationIntervalMinimum=wN("IMAGE_MODERATION_INTERVAL_MINIMUM"),this._moderationInterval=null!==(k=L.interval)&&void 0!==k?k:1e3,L.extraInfo&&(this._extraInfo=this._encoder.encode(L.extraInfo)),L.vendor&&(this._vendor=L.vendor),this._qualityRatio=wN("IMAGE_MODERATION_QUALITY_RATIO"),this._moderationStartTime=Number(Date.now()),this._workerConnection=new JV("worker-"+this._moderationId,Sm),this.on(In.STATE_CHANGE,(L,k)=>{gc.debug("[".concat(this._moderationId,"] Moderation operation :").concat(Ia[L]," ").concat(k||""))}),this.handleWorkerEvents()}async init(L,k){this.emit(In.STATE_CHANGE,Ia.CONNECT_AP),this._connectInfo=L;let M=this._cancelTokenSource.token;return this._retryConfig=k,new lQ((U,V)=>{this.on(In.CONNECTION_STATE_CHANGE,(L,k)=>{L===Ir.CONNECTED&&U()}),this.requestAP(L,M,k).then(L=>{this.connectWorker(L)}).catch(L=>{V(L)})})}updateConfig(L){var k;this._moderationInterval=null!==(k=L.interval)&&void 0!==k?k:1e3,L.extraInfo&&(this._extraInfo=this._encoder.encode(L.extraInfo)),L.vendor&&(this._vendor=L.vendor),gc.debug("[".concat(this._moderationId,"] updateConfig: ").concat(JSON.stringify(L))),this.connectionState===Ir.CONNECTED&&this.inspectImage()}async requestAP(L,k,M){let U=wN("WEBCS_DOMAIN").map(L=>"https://".concat(L,"/api/v1")),V=await function(L,k,M,U){let{appId:V,areaCode:F,cname:B,sid:j,token:G,uid:X}=k;IV++;let $="moderation_plugin",ee={service_name:$,json_body:JSON.stringify({appId:V,areaCode:F,cname:B,command:"allocateEdge",requestId:IV,seq:IV,sid:j,appToken:G,ts:Date.now(),uid:X+""})},et,ei,er=L[0];return GO(async()=>{et=Date.now();let L=await oF(er,{data:ee,cancelToken:M,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"},params:{action:"wrtc_gateway"}});if(ei=Date.now()-et,0!==L.code){let k=new ED(f1.UNEXPECTED_RESPONSE,"moderation plugin ap error, code"+L.code,{retry:!0,responseTime:ei});throw gc.error(k.toString()),k}let k=JSON.parse(L.json_body);if(200!==k.code){let L=new ED(f1.UNEXPECTED_RESPONSE,"moderation plugin ap error, code: ".concat(k.code,", reason: ").concat(k.reason),{code:k.code,responseTime:ei});throw gc.error(L.toString()),L}if(!k.servers||!Array.isArray(k.servers)||0===k.servers.length){let L=new ED(f1.UNEXPECTED_RESPONSE,"moderation plugin ap empty server",{code:k.code,responseTime:ei});throw gc.error(L.toString()),L}if(!k.servers.some(L=>!!L.wss)){let L=new ED(f1.UNEXPECTED_RESPONSE,"moderation plugin ap empty port",{code:k.code,responseTime:ei});throw gc.error(L.toString()),L}let U=wN("IMAGE_MODERATION_WORKER_HOST");return{addressList:k.servers.map(L=>{let{address:k,wss:M}=L;if(k&&M)return"wss://".concat(k.replace(/\./g,"-"),".").concat(U,":").concat(M,"/moderation")}).filter(L=>!!L),workerToken:k.workerToken,vid:k.vid,ticket:k.appTicket,responseTime:ei}},(k,M)=>(g_.apworkerEvent(j,{success:!0,sc:200,serviceName:$,responseDetail:JSON.stringify(k.addressList),firstSuccess:0===M,responseTime:ei,serverIp:L[M%L.length]}),!1),(k,M)=>(g_.apworkerEvent(j,{success:!1,sc:k.data&&k.data.code||200,serviceName:$,responseTime:ei,serverIp:L[M%L.length]}),!!(k.code!==f1.OPERATION_ABORTED&&k.code!==f1.UNEXPECTED_RESPONSE||k.data&&k.data.retry)&&(er=L[(M+1)%L.length],!0)),U)}(U,L,k,M);this.emit(In.STATE_CHANGE,Ia.AP_CONNECTED);let{addressList:F,ticket:B}=V;return this._ticket=B,F}async connectWorker(L){this.emit(In.STATE_CHANGE,Ia.CONNECT_WORKER),await this._workerConnection.init(L,1e4)}handleWorkerEvents(){this._workerConnection.on(RI.CONNECTED,async()=>{this.emit(In.STATE_CHANGE,Ia.WORKER_CONNECTED,this._workerConnection.url),this.connectionState=Ir.CONNECTED}),this._workerConnection.on(RI.CLOSED,()=>{this.connectionState=Ir.CLOSED}),this._workerConnection.on(RI.FAILED,()=>{this.connectionState=Ir.CLOSED}),this._workerConnection.on(RI.RECONNECTING,()=>{this.connectionState=this.connectionState===Ir.CONNECTED?Ir.RECONNECTING:Ir.CONNECTING}),this._workerConnection.on(RI.ON_MESSAGE,async L=>{if(L.data instanceof ArrayBuffer){let k=Uj(new Uint8Array(L.data));wN("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&gc.debug("[".concat(this._moderationId,"] Response message for worker of image moderation "),JSON.stringify(k)),this._uploadNum++,void 0===k.code||0===k.code||(this._uploadFailedNum++,gc.error("[".concat(this._moderationId,"] Error response from worke, code is ").concat(k.code,", msg is ").concat(k.msg)),this._uploadTimer||(this._uploadTimer=window.setTimeout(()=>{g_.reportApiInvoke(this._connectInfo.sid||null,{name:f8.IMAGE_MODERATION_UPLOAD,options:[this._uploadFailedNum,this._uploadNum,k.code],tag:f9.TRACER}).onError(new ED(f1.IMAGE_MODERATION_UPLOAD_FAILED,k.msg)),this._uploadTimer=null},wN("IMAGE_MODERATION_UPLOAD_REPORT_INTERVAL"))))}else gc.error("[".concat(this._moderationId,"] Unexpected message type from worker"))}),this._workerConnection.on(RI.WILL_RECONNECT,(L,k,M)=>{"recover"===L&&M(L),M("tryNext")}),this._workerConnection.on(RI.REQUEST_NEW_URLS,(L,k)=>{this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(L).catch(k)})}static intToLong(L){return{low:L|=0,high:L>>31,unsigned:L>=0}}async requestToInspectImage(){let L=aO(this,In.CLIENT_LOCAL_VIDEO_TRACK),k={appId:this._connectInfo.appId,cname:this._connectInfo.cname,cid:this._connectInfo.cid,sid:this._connectInfo.sid,uid:this._connectInfo.uid,vid:this._connectInfo.vid};if(L){if(!L.isPlaying)return void(wN("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&gc.debug("Only the track being played can be inspected"));this._sequence++;let M=await this.generateRequestData(L,k);this._workerConnection.sendMessage(M,!0,!0)}else wN("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&gc.debug("Only the track being published can be inspected")}async generateRequestData(L,k){let{appId:M,cname:U,cid:V,vid:F,sid:B,uid:j}=k,G=Date.now(),X=await L.getCurrentFrameImage("image/jpeg",this.quality),$=await ZP(X,M,U),ee=this._sequence+"-"+V+"-"+j+"-"+G+"-"+IO(12,""),et={appId:M,cid:V,cname:U,deviceId:"",elapse:pG.intToLong(Number(G-this._moderationStartTime)),fileSize:X.buffer.byteLength,height:X.height,width:X.width,jpg:$,networkType:6,osType:7,requestId:ee,sdkVersion:"4.24.0",sequence:this._sequence,sid:B,timestamp:uG(G),uid:j,vid:F,service:this._moderationMode,ticket:this._ticket,callbackData:this._extraInfo,vendorConfigs:this._vendor};void 0===this._extraInfo&&delete et.callbackData;let ei=Mj(et);if(ei.byteLength<this._workerMessageLengthLimit){if(wN("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")){let L=function(L){for(var k=1;k<arguments.length;k++){var M=null!=arguments[k]?arguments[k]:{};k%2?hG(Object(M),!0).forEach(function(k){uI(L,k,M[k])}):Object.getOwnPropertyDescriptors?Object.defineProperties(L,Object.getOwnPropertyDescriptors(M)):hG(Object(M)).forEach(function(k){Object.defineProperty(L,k,Object.getOwnPropertyDescriptor(M,k))})}return L}({},et);delete L.jpg,gc.debug("[".concat(this._moderationId,"] Request message for worker of image moderation service: "),JSON.stringify(L))}return ei}{let k=this.quality*this._qualityRatio;return this.quality=k,await this.generateRequestData(L,{appId:M,cname:U,cid:V,vid:F,sid:B,uid:j})}}close(){this._cancelTokenSource.cancel(),this._cancelTokenSource=fG.CancelToken.source(),this._workerConnection&&this._workerConnection.close(),this._moderationTimer&&window.clearInterval(this._moderationTimer),this._moderationTimer=null,this._uploadTimer&&window.clearTimeout(this._uploadTimer),this._uploadTimer=null,this.connectionState=Ir.CLOSED,this.emit(In.STATE_CHANGE,Ia.CLOSED)}};function _G(L){if(Pw(L.interval,"interval",1e3,1/0),L&&L.extraInfo&&L.extraInfo.length>1024)throw new ED(f1.INVALID_PARAMS,"config.extraInfo length cannot exceed 1024 bytes");if(L&&L.vendor&&L.vendor.length>1024)throw new ED(f1.INVALID_PARAMS,"config.vendor length cannot exceed 1024 bytes")}function rW(L,k){var M=Object.keys(L);if(Object.getOwnPropertySymbols){var U=Object.getOwnPropertySymbols(L);k&&(U=U.filter(function(k){return Object.getOwnPropertyDescriptor(L,k).enumerable})),M.push.apply(M,U)}return M}function oW(L){for(var k=1;k<arguments.length;k++){var M=null!=arguments[k]?arguments[k]:{};k%2?rW(Object(M),!0).forEach(function(k){uI(L,k,M[k])}):Object.getOwnPropertyDescriptors?Object.defineProperties(L,Object.getOwnPropertyDescriptors(M)):rW(Object(M)).forEach(function(k){Object.defineProperty(L,k,Object.getOwnPropertyDescriptor(M,k))})}return L}S_.setLogger(gc);let vI=(nn=pD(),na=pD({argsMap:(L,k)=>{if(!Array.isArray(k)){if(!(k instanceof uP))return[k];k=[k]}return k.map(L=>L?Object(L).toString():"null")}}),no=pD({argsMap:(L,k)=>(k||(k=[]),Array.isArray(k)||k.trackMediaType!==gW.DATA?(Array.isArray(k)||(k=[k]),k.map(L=>L.getTrackId())):[k.getChannelId()])}),ns=pD({argsMap:(L,k,M,U)=>["object"==typeof k?k.uid:k,M,U]}),nc=pD({argsMap:(L,k,M)=>[k,M]}),nd=pD({argsMap:(L,k)=>k.map(L=>{let{user:k,mediaType:M}=L;return[null==k?void 0:k.uid,M]})}),nl=pD({argsMap:(L,k,M,U)=>["object"==typeof k?k.uid:k,M,U]}),nu=pD({argsMap:(L,k)=>k.map(L=>{let{user:k,mediaType:M}=L;return{uid:null==k?void 0:k.uid,mediaType:M}})}),nh=pD(),np=pD(),n_=pD(),nE=pD(),nm=pD(),nf=pD(),ng=pD(),nT=pD(),nR=pD(),nI=pD(),nv=pD(),nC=pD(),ny=pD(),nA=pD(),nb=pD(),nO=pD({argsMap:(L,k)=>[k]}),nN=pD(),nD=pD(),nP=pD(),nL=pD(),nk=pD(),nM=pD(),nU=pD(),nV=pD(),nF=pD({argsMap:(L,k)=>(Array.isArray(k)||(k=[k]),[JSON.stringify(k)])}),nB=pD(),nW=pD(),nG=pD(),nH=pD(),nY=pD(),nq=pD(),nJ=pD({reportResult:!0}),nX=pD(),OU((nQ=class extends Hw{get connectionState(){return this._gateway.state}get remoteUsers(){return this._users}get localTracks(){return this._p2pChannel.getAllTracks(!0)}get uid(){return this._uid}get channelName(){return this._channelName}get localDataChannels(){return this._p2pChannel.getAllDataChannels()}get mode(){return this._config.mode}get role(){var L;return(null===(L=this._config)||void 0===L?void 0:L.role)||"audience"}get codec(){return this._config.codec}get audioCodec(){return this._config.audioCodec||"opus"}get isStringUID(){return!!this._joinInfo&&!!this._joinInfo.stringUid}get __className__(){return"Client"}constructor(L,k){var M;let U;if(super(),uI(this,"store",void 0),uI(this,"_uid",void 0),uI(this,"_channelName",void 0),uI(this,"_uintUid",void 0),uI(this,"_users",[]),uI(this,"_config",void 0),uI(this,"_clientId",void 0),uI(this,"_appId",void 0),uI(this,"_sessionId",null),uI(this,"_key",void 0),uI(this,"_rtmConfig",{}),uI(this,"_joinInfo",void 0),uI(this,"_gateway",void 0),uI(this,"_statsCollector",void 0),uI(this,"_configDistribute",void 0),uI(this,"_leaveMutex",void 0),uI(this,"_publishMutex",void 0),uI(this,"_renewTokenMutex",void 0),uI(this,"_subscribeMutex",void 0),uI(this,"_encryptionMode","none"),uI(this,"_encryptionSecret",null),uI(this,"_encryptionSalt",null),uI(this,"_encryptDataStream",!1),uI(this,"_encryptDataStreamKey",null),uI(this,"_encryptDataStreamIv",null),uI(this,"_proxyServer",void 0),uI(this,"_turnServer",{servers:[],mode:"auto"}),uI(this,"_cloudProxyServerMode","disabled"),uI(this,"_isDualStreamEnabled",!1),uI(this,"_defaultStreamFallbackType",void 0),uI(this,"_lowStreamParameter",void 0),uI(this,"_streamFallbackTypeCacheMap",new Map),uI(this,"_remoteStreamTypeCacheMap",new Map),uI(this,"_axiosCancelSource",fG.CancelToken.source()),uI(this,"_audioVolumeIndicationInterval",void 0),uI(this,"_networkQualityInterval",void 0),uI(this,"_userOfflineTimeout",void 0),uI(this,"_streamRemovedTimeout",void 0),uI(this,"_liveTranscodeStreamingClient",void 0),uI(this,"_liveRawStreamingClient",void 0),uI(this,"_channelMediaRelayClient",void 0),uI(this,"_networkQualitySensitivity","normal"),uI(this,"_p2pChannel",void 0),uI(this,"_useLocalAccessPoint",!1),uI(this,"_setLocalAPVersion",void 0),uI(this,"_joinAndNotLeaveYet",!1),uI(this,"_numberOfJoinCount",0),uI(this,"_joinResponse",null),uI(this,"_remoteDefaultVideoStreamType",void 0),uI(this,"_inspect",void 0),uI(this,"_moderation",void 0),uI(this,"_license",void 0),uI(this,"_pendingPublishedUsers",[]),uI(this,"ntpAlignErrorCount",0),uI(this,"remoteInboundOffset",0),uI(this,"_peerConnectionState",void 0),uI(this,"_handleLocalTrackEnable",(L,k,M)=>{this.publish(L,!1).then(k).catch(M)}),uI(this,"_handleLocalTrackDisable",(L,k,M)=>{this.unpublish(L).then(k).catch(M)}),uI(this,"_handleUserOnline",L=>{if(wN("BLOCK_LOCAL_CLIENT")&&KM(L.uid,this.channelName))return void gc.debug("[".concat(L.uid,"] will be ignored in local"));this.isStringUID&&"string"!=typeof L.uid&&gc.error("[".concat(this._clientId,"] StringUID is Mixed with UintUID"));let k=this._users.find(k=>k.uid===L.uid);if(k)k._trust_in_room_=!0,k._is_pre_created&&(k._is_pre_created=!1,this.safeEmit(Si.USER_JOINED,k));else{let k=new QF(L.uid,L.uint_id||L.uid);this._users.push(k),gc.debug("[".concat(this._clientId,"] user online"),L.uid),this.store.firstVideoFrameDecoded(k.uid,{userJoinNotify:Date.now()}),this.safeEmit(Si.USER_JOINED,k)}}),uI(this,"_handleUserOffline",L=>{if(wN("BLOCK_LOCAL_CLIENT")&&KM(L.uid,this.channelName))return;let k=this._users.find(k=>k.uid===L.uid);k&&(this._handleRemoveStream(L),this._handleRemoveDataChannels(L),k._audio_pre_subscribed||k._video_pre_subscribed?k._is_pre_created=!0:lO(this._users,k),this._remoteStreamTypeCacheMap.delete(k.uid),this._streamFallbackTypeCacheMap.delete(k.uid),gc.debug("[".concat(this._clientId,"] user offline"),L.uid,"reason:",L.reason),this.safeEmit(Si.USER_LEAVED,k,L.reason))}),uI(this,"_handleAddAudioOrVideoStream",(L,k,M,U,V,F,B,j)=>{if(wN("BLOCK_LOCAL_CLIENT")&&KM(k,this.channelName))return;let G=this._users.find(L=>L.uid===k);if(!G)return void gc.error("[".concat(this._clientId,"] can not find target user!(on_add_stream)"));gc.debug("[".concat(this._clientId,"] stream added with uid ").concat(k,", type ").concat(L)),this.store.subscribe(G.uid,L,void 0,void 0,void 0,Date.now()),"video"===L&&this.store.firstVideoFrameDecoded(G.uid,{videoAddNotify:Date.now()});let X="audio"===L?G.hasAudio:G.hasVideo;if(G._uintid||(G._uintid=F||k),"audio"===L?G._trust_audio_stream_added_state_=!0:G._trust_video_stream_added_state_=!0,"audio"===L?(G._audio_added_=!0,void 0!==M&&(G._audioSSRC=M),void 0!==U&&(G._cname=U),B&&(G._audioOrtc=B)):(G._video_added_=!0,void 0!==M&&(G._videoSSRC=M),void 0!==U&&(G._cname=U),void 0!==j&&(G._rtxSsrcId=j),B&&(G._videoOrtc=B)),("audio"===L?G.hasAudio:G.hasVideo)&&!X&&(gc.info("[".concat(this._clientId,"] remote user ").concat(G.uid," published ").concat(L)),this.safeEmit(Si.USER_PUBLISHED,G,L)),"video"===L?g_.onGatewayStream(this._sessionId,gl.ON_ADD_VIDEO_STREAM,gh.ON_ADD_VIDEO_STREAM,{peer:F||k,ssrc:G._videoSSRC}):g_.onGatewayStream(this._sessionId,gl.ON_ADD_AUDIO_STREAM,gh.ON_ADD_AUDIO_STREAM,{peer:F||k,ssrc:G._audioSSRC}),this._p2pChannel.remoteMediaSsrcChanged(G,L,M).then(k=>{if(k&&(gc.debug("[".concat(this._clientId,"] resubscribe ").concat(L," for user ").concat(G.uid," after rejoin because SSRC id changed.")),this._p2pChannel instanceof I8))return this._p2pChannel.unsubscribe(G,L,!0).then(()=>this._subscribe(G,L,!0).catch(L=>{gc.error("[".concat(this._clientId,"] resubscribe error"),L.toString())}))}),this._p2pChannel.hasPendingRemoteMedia(G,L)&&(gc.debug("[".concat(this._clientId,"] resubscribe ").concat(L," for user ").concat(G.uid," after reconnect.")),this._subscribe(G,L,!0).catch(L=>{gc.error("[".concat(this._clientId,"] resubscribe error"),L.toString())})),"video"===L&&!$A()&&!nw()){let L=this._getEncodingName(V);(null==L?void 0:L.toLocaleLowerCase())==S8.av1&&DF().then(k=>{k||this._gateway.downgradeCodec(L)})}}),uI(this,"_handleRemoveStream",L=>{if(wN("BLOCK_LOCAL_CLIENT")&&KM(L.uid,this.channelName))return;let k=this._users.find(k=>k.uid===L.uid);if(!k)return void gc.warning("[".concat(this._clientId,"] can not find target user!(on_remove_stream)"));gc.debug("[".concat(this._clientId,"] stream removed with uid ").concat(L.uid));let i=()=>{};k.hasAudio&&k.hasVideo?i=()=>{gc.info("[".concat(this._clientId,"] remote user ").concat(k.uid," unpublished audio track")),this.safeEmit(Si.USER_UNPUBLISHED,k,"audio"),gc.info("[".concat(this._clientId,"] remote user ").concat(k.uid," unpublished video track")),this.safeEmit(Si.USER_UNPUBLISHED,k,"video")}:k.hasVideo?i=()=>{gc.info("[".concat(this._clientId,"] remote user ").concat(k.uid," unpublished video track")),this.safeEmit(Si.USER_UNPUBLISHED,k,"video")}:k.hasAudio&&(i=()=>{gc.info("[".concat(this._clientId,"] remote user ").concat(k.uid," unpublished audio track")),this.safeEmit(Si.USER_UNPUBLISHED,k,"audio")}),k._video_pre_subscribed||k._audio_pre_subscribed||(k._trust_audio_stream_added_state_=!0,k._trust_video_stream_added_state_=!0,k._audio_added_=!1,k._video_added_=!1,this._p2pChannel instanceof I8&&this._p2pChannel.unsubscribe(k).then(L=>{if(L)return this._gateway.unsubscribe(L,k.uid)}),k._audioSSRC=void 0,k._videoSSRC=void 0,k._audioOrtc=void 0,k._videoOrtc=void 0,k._rtxSsrcId=void 0),g_.onGatewayStream(this._sessionId,gl.ON_REMOVE_STREAM,gh.ON_REMOVE_STREAM,{peer:L.uint_id||L.uid}),i()}),uI(this,"_handleSetStreamLocalEnable",(L,k,M)=>{if(wN("BLOCK_LOCAL_CLIENT")&&KM(k,this.channelName))return;let U=this._users.find(L=>L.uid===k);if(!U)return void gc.error("[".concat(this._clientId,"] can not find target user!(disable_local)"));gc.debug("[".concat(this._clientId,"] local ").concat(L," ").concat(M?"enabled":"disabled"," with uid ").concat(k));let V="audio"===L?U.hasAudio:U.hasVideo;if("audio"===L){U._trust_audio_enabled_state_=!0;let L=U._audio_enabled_;if(U._audio_enabled_=M,U._audio_enabled_===L)return;{let L=U._audio_enabled_?"enable-local-audio":"disable-local-audio";gc.debug("[".concat(this._clientId,"] user-info-updated, uid: ").concat(k,", msg: ").concat(L)),this.safeEmit(Si.USER_INFO_UPDATED,k,L)}}else{U._trust_video_enabled_state_=!0;let L=U._video_enabled_;if(U._video_enabled_=M,U._video_enabled_===L)return;{let L=U._video_enabled_?"enable-local-video":"disable-local-video";gc.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(k,", msg: ").concat(L)),this.safeEmit(Si.USER_INFO_UPDATED,k,L)}}let F="audio"===L?U.hasAudio:U.hasVideo;return V!==F?!V&&F?(gc.info("[".concat(this._clientId,"] remote user ").concat(k," published ").concat(L)),void this.safeEmit(Si.USER_PUBLISHED,U,L)):("video"===L&&U._videoTrack&&U._videoTrack._destroy(),"audio"===L&&U._audioTrack,this._p2pChannel.muteRemote(U,L),gc.info("[".concat(this._clientId,"] remote user ").concat(k," unpublished ").concat(L)),void this.safeEmit(Si.USER_UNPUBLISHED,U,L)):void 0}),uI(this,"_handleMuteStream",(L,k,M)=>{if(wN("BLOCK_LOCAL_CLIENT")&&KM(L,this.channelName))return;gc.debug("[".concat(this._clientId,"] receive mute message"),L,k,M);let U=this._users.find(k=>k.uid===L);if(!U)return void gc.warning("[".concat(this._clientId,"] can not find remote user, ignore mute event, uid: ").concat(L));let V="audio"===k?U.hasAudio:U.hasVideo;if("audio"===k){U._trust_audio_mute_state_=!0;let k=U._audio_muted_;if(U._audio_muted_=M,U._audio_muted_===k)return;{let k=U._audio_muted_?"mute-audio":"unmute-audio";gc.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(L,", msg: ").concat(k)),this.safeEmit(Si.USER_INFO_UPDATED,L,k)}}else{U._trust_video_mute_state_=!0;let k=U._video_muted_;if(U._video_muted_=M,U._video_muted_===k)return;{let k=U._video_muted_?"mute-video":"unmute-video";gc.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(L,", msg: ").concat(k)),this.safeEmit(Si.USER_INFO_UPDATED,L,k)}}let F="audio"===k?U.hasAudio:U.hasVideo;if(V!==F){if(!V&&F)return("audio"===k?U._audioSSRC:U._videoSSRC)?(gc.info("[".concat(this._clientId,"] remote user ").concat(L," published ").concat(k)),void this.safeEmit(Si.USER_PUBLISHED,U,k)):void gc.warning("[".concat(this._clientId,"] remote user ").concat(L," receive ").concat(k," unmute message  before add stream message, ").concat(k," SSRC doesn't exist yet."));"video"===k&&U._videoTrack&&!U._video_pre_subscribed&&U._videoTrack._destroy(),"audio"===k&&U._audioTrack,this._p2pChannel.muteRemote(U,k),gc.info("[".concat(this._clientId,"] remote user ").concat(L," unpublished ").concat(k)),this.safeEmit(Si.USER_UNPUBLISHED,U,k)}}),uI(this,"_handleP2PLost",async L=>{gc.debug("[".concat(this._clientId,"] receive p2p lost"),L),parseInt(L.p2pid,10)===this.store.p2pId?await this._p2pChannel.requestReconnect():gc.warning("[".concat(this._clientId,"] P2PLost stream not found"),L)}),uI(this,"_handleTokenWillExpire",()=>{gc.debug("[".concat(this._clientId,"] received message onTokenPrivilegeWillExpire")),this.safeEmit(Si.ON_TOKEN_PRIVILEGE_WILL_EXPIRE)}),uI(this,"_handleBeforeUnload",L=>{"beforeunload"===L.type&&void 0!==L.returnValue&&""!==L.returnValue||(this.leave(),gc.info("[".concat(this._clientId,"] auto leave onbeforeunload or pagehide")))}),uI(this,"_handleUpdateNetworkQuality",()=>{if("normal"===this._networkQualitySensitivity)return;if(navigator&&void 0!==navigator.onLine&&!navigator.onLine)return void this.safeEmit(Si.NETWORK_QUALITY,{downlinkNetworkQuality:6,uplinkNetworkQuality:6});let L={downlinkNetworkQuality:0,uplinkNetworkQuality:0};L.uplinkNetworkQuality=this._p2pChannel.getUplinkNetworkQuality(),L.downlinkNetworkQuality=this._p2pChannel.getDownlinkNetworkQuality(),this.safeEmit(Si.NETWORK_QUALITY,L)}),uI(this,"_handleP2PAddAudioOrVideoStream",(L,k,M,U)=>{let V=this._users.find(L=>L.uid===k);if(!V)return void gc.error("[".concat(this._clientId,"] can not find target user!(on_add_stream)"));gc.debug("[".concat(this._clientId,"] stream added with uid ").concat(k,", type ").concat(L)),this.store.subscribe(V.uid,L,void 0,void 0,void 0,Date.now());let F="audio"===L?V.hasAudio:V.hasVideo;"audio"===L?V._trust_audio_stream_added_state_=!0:V._trust_video_stream_added_state_=!0,"audio"===L?(V._audio_added_=!0,void 0!==M&&(V._audioSSRC=M),void 0!==U&&(V._audioMid=U)):(V._video_added_=!0,void 0!==M&&(V._videoSSRC=M),void 0!==U&&(V._videoMid=U)),("audio"===L?V.hasAudio:V.hasVideo)&&!F&&(gc.info("[".concat(this._clientId,"] remote user ").concat(V.uid," published ").concat(L)),this.safeEmit(Si.USER_PUBLISHED,V,L)),this._p2pChannel.hasPendingRemoteMedia(V,L)&&(gc.debug("[".concat(this._clientId,"] resubscribe ").concat(L," for user ").concat(V.uid," after reconnect.")),this._subscribe(V,L,!0).catch(L=>{gc.error("[".concat(this._clientId,"] resubscribe error"),L.toString())}))}),this._config=L,this._clientId=k||IO(5,"client-"),this.store=new class{constructor(L,k,M,U){Iw(this,"state",void 0),this.state={codec:L,audioCodec:k,mode:M,clientId:U,sessionId:null,p2pId:0,dcId:0,pubId:0,subId:0,keyMetrics:{publish:[],subscribe:[],firstVideoFrameDecoded:[]},joinChannelServiceRecords:[],cloudProxyServerMode:"disabled",useP2P:!1,p2pTransport:SQ.Default,hasStartJoinChannel:!1,isABTestSuccess:!1,autoSubscribe:!1,enableInstantMuteRestore:!1}}dispatch(L){this.state=function(L,k){switch(k.type){case S6.SET_SESSION_ID:return Aw(Aw({},L),{},{sessionId:k.sessionId});case S6.SET_P2P_ID:return Aw(Aw({},L),{},{p2pId:k.p2pId});case S6.SET_UID:return Aw(Aw({},L),{},{uid:k.uid});case S6.SET_INT_UID:return Aw(Aw({},L),{},{intUid:k.intUid});case S6.SET_PUB_ID:return Aw(Aw({},L),{},{pubId:k.pubId});case S6.KEY_METRIC_CLIENT_CREATED:return Aw(Aw({},L),{},{keyMetrics:Aw(Aw({},L.keyMetrics),{},{clientCreated:k.metric})});case S6.KEY_METRIC_JOIN_START:return Aw(Aw({},L),{},{keyMetrics:Aw(Aw({},L.keyMetrics),{},{joinStart:k.metric})});case S6.KEY_METRIC_PRELOAD_START:return Aw(Aw({},L),{},{keyMetrics:Aw(Aw({},L.keyMetrics),{},{preloadStart:k.metric})});case S6.KEY_METRIC_PRELOAD_END:return Aw(Aw({},L),{},{keyMetrics:Aw(Aw({},L.keyMetrics),{},{preloadEnd:k.metric})});case S6.KEY_METRIC_JOIN_END:return Aw(Aw({},L),{},{keyMetrics:Aw(Aw({},L.keyMetrics),{},{joinEnd:k.metric})});case S6.KEY_METRIC_REQUEST_AP_START:return Aw(Aw({},L),{},{keyMetrics:Aw(Aw({},L.keyMetrics),{},{requestAPStart:k.metric})});case S6.KEY_METRIC_REQUEST_AP_END:return Aw(Aw({},L),{},{keyMetrics:Aw(Aw({},L.keyMetrics),{},{requestAPEnd:k.metric})});case S6.KEY_METRIC_REQUEST_SUA_END:return Aw(Aw({},L),{},{keyMetrics:Aw(Aw({},L.keyMetrics),{},{requestSUAEnd:k.metric})});case S6.KEY_METRIC_BEFORE_CONNECT:return Aw(Aw({},L),{},{keyMetrics:Aw(Aw({},L.keyMetrics),{},{beforeConnect:k.metric})});case S6.KEY_METRIC_PEER_RECEIVER:return Aw(Aw({},L),{},{keyMetrics:Aw(Aw({},L.keyMetrics),{},{peerReceiver:k.metric})});case S6.KEY_METRIC_SIGNAL_CONNECTED:return Aw(Aw({},L),{},{keyMetrics:Aw(Aw({},L.keyMetrics),{},{signalConnected:k.metric})});case S6.KEY_METRIC_JOIN_REQ:return Aw(Aw({},L),{},{keyMetrics:Aw(Aw({},L.keyMetrics),{},{joinReq:k.metric})});case S6.KEY_METRIC_JOIN_REP:return Aw(Aw({},L),{},{keyMetrics:Aw(Aw({},L.keyMetrics),{},{joinRep:k.metric})});case S6.KEY_METRIC_JOIN_GATEWAY_START:return Aw(Aw({},L),{},{keyMetrics:Aw(Aw({},L.keyMetrics),{},{joinGatewayStart:k.metric})});case S6.KEY_METRIC_JOIN_GATEWAY_END:return Aw(Aw({},L),{},{keyMetrics:Aw(Aw({},L.keyMetrics),{},{joinGatewayEnd:k.metric})});case S6.KEY_METRIC_PEER_CONNECTION_START:return Aw(Aw({},L),{},{keyMetrics:Aw(Aw({},L.keyMetrics),{},{peerConnectionStart:k.metric})});case S6.KEY_METRIC_PEER_CONNECTION_END:return Aw(Aw({},L),{},{keyMetrics:Aw(Aw({},L.keyMetrics),{},{peerConnectionEnd:k.metric})});case S6.KEY_METRIC_DESCRIPTION_START:return Aw(Aw({},L),{},{keyMetrics:Aw(Aw({},L.keyMetrics),{},{descriptionStart:k.metric})});case S6.KEY_METRIC_SIGNAL_CHANNEL_OPEN:return Aw(Aw({},L),{},{keyMetrics:Aw(Aw({},L.keyMetrics),{},{signalChannelOpen:k.metric})});case S6.KEY_METRIC_ICE_CONNECTION_END:return Aw(Aw({},L),{},{keyMetrics:Aw(Aw({},L.keyMetrics),{},{iceConnectionEnd:k.metric})});case S6.KEY_METRIC_PUBLISH:{let M=L.keyMetrics.publish,U=M.findIndex(L=>L.trackId===k.metric.trackId);return -1!==U?(M[U]=Aw(Aw({},M[U]),k.metric),Aw(Aw({},L),{},{keyMetrics:Aw(Aw({},L.keyMetrics),{},{publish:[...M]})})):Aw(Aw({},L),{},{keyMetrics:Aw(Aw({},L.keyMetrics),{},{publish:[...L.keyMetrics.publish,k.metric]})})}case S6.KEY_METRIC_SUBSCRIBE:{let M=L.keyMetrics.subscribe,U=M.findIndex(L=>L.userId===k.metric.userId&&L.type===k.metric.type);return -1!==U?(M[U]=Aw(Aw({},M[U]),k.metric),Aw(Aw({},L),{},{keyMetrics:Aw(Aw({},L.keyMetrics),{},{subscribe:[...M]})})):Aw(Aw({},L),{},{keyMetrics:Aw(Aw({},L.keyMetrics),{},{subscribe:[...L.keyMetrics.subscribe,k.metric]})})}case S6.KEY_METRIC_FIRST_VIDEO_FRAME_DECODED:{let M=L.keyMetrics.firstVideoFrameDecoded,U=M.findIndex(L=>L.userId===k.metric.userId);return -1!==U?(M[U]=Aw(Aw({},M[U]),k.metric),Aw(Aw({},L),{},{keyMetrics:Aw(Aw({},L.keyMetrics),{},{firstVideoFrameDecoded:[...M]})})):Aw(Aw({},L),{},{keyMetrics:Aw(Aw({},L.keyMetrics),{},{firstVideoFrameDecoded:[...L.keyMetrics.firstVideoFrameDecoded,k.metric]})})}case S6.RESET_FIRST_VIDEO_FRAME_DECODED:return L.keyMetrics.firstVideoFrameDecoded=[],L;case S6.SET_CLOUD_PROXY_SERVER_MODE:return L.cloudProxyServerMode=k.mode,L;case S6.RECORD_JOIN_CHANNEL_SERVICE:return"number"!=typeof k.index?L.joinChannelServiceRecords=[...L.joinChannelServiceRecords,k.record]:(L.joinChannelServiceRecords[k.index]=Aw(Aw({},L.joinChannelServiceRecords[k.index]),k.record),L.joinChannelServiceRecords=[...L.joinChannelServiceRecords]),L;case S6.RESET_JOIN_CHANNEL_SERVICE_RECORDS:return L.joinChannelServiceRecords=[],L;case S6.RESET_KEY_METRICS:return L.keyMetrics={publish:[],subscribe:[],firstVideoFrameDecoded:[]},L;case S6.SET_USE_P2P:return Aw(Aw({},L),{},{useP2P:k.val});case S6.SET_TRANSPORT_TYPE:return Aw(Aw({},L),{},{p2pTransport:k.val});default:return L}}(this.state,L)}set autoSubscribe(L){this.state.autoSubscribe=L}get autoSubscribe(){return this.state.autoSubscribe}set enableInstantMuteRestore(L){this.state.enableInstantMuteRestore=L}get enableInstantMuteRestore(){return this.state.enableInstantMuteRestore}set sessionId(L){this.dispatch({type:S6.SET_SESSION_ID,sessionId:L})}get sessionId(){return this.state.sessionId}set cid(L){this.state.cid=L}get cid(){return this.state.cid}set codec(L){this.state.codec=L}get codec(){return this.state.codec}get mode(){return this.state.mode}get audioCodec(){return this.state.audioCodec}get clientId(){return this.state.clientId}set p2pId(L){this.dispatch({type:S6.SET_P2P_ID,p2pId:L})}get p2pId(){return this.state.p2pId}set dcId(L){this.dispatch({type:S6.SET_DC_ID,dcId:L})}get dcId(){return this.state.dcId}set uid(L){this.dispatch({type:S6.SET_UID,uid:L})}get uid(){return this.state.uid}set intUid(L){this.dispatch({type:S6.SET_INT_UID,intUid:L})}get intUid(){return this.state.intUid}set pubId(L){this.dispatch({type:S6.SET_PUB_ID,pubId:L})}get pubId(){return this.state.pubId}set cloudProxyServerMode(L){this.dispatch({type:S6.SET_CLOUD_PROXY_SERVER_MODE,mode:L})}get cloudProxyServerMode(){return this.state.cloudProxyServerMode}set useP2P(L){this.dispatch({type:S6.SET_USE_P2P,val:L})}get useP2P(){return this.state.useP2P}set p2pTransport(L){this.dispatch({type:S6.SET_TRANSPORT_TYPE,val:L})}get p2pTransport(){return this.state.p2pTransport}set hasStartJoinChannel(L){this.state.hasStartJoinChannel=L}get hasStartJoinChannel(){return this.state.hasStartJoinChannel}set isABTestSuccess(L){this.state.isABTestSuccess=L}get isABTestSuccess(){return this.state.isABTestSuccess}clientCreated(){this.dispatch({type:S6.KEY_METRIC_CLIENT_CREATED,metric:Date.now()})}joinStart(){this.dispatch({type:S6.KEY_METRIC_JOIN_START,metric:Date.now()})}preloadStart(){this.dispatch({type:S6.KEY_METRIC_PRELOAD_START,metric:Date.now()})}preloadEnd(){this.dispatch({type:S6.KEY_METRIC_PRELOAD_END,metric:Date.now()})}joinEnd(){this.dispatch({type:S6.KEY_METRIC_JOIN_END,metric:Date.now()})}requestAPStart(){this.dispatch({type:S6.KEY_METRIC_REQUEST_AP_START,metric:Date.now()})}requestAPEnd(){this.dispatch({type:S6.KEY_METRIC_REQUEST_AP_END,metric:Date.now()})}requestSUAEnd(){this.dispatch({type:S6.KEY_METRIC_REQUEST_SUA_END,metric:Date.now()})}beforeConnect(){this.dispatch({type:S6.KEY_METRIC_BEFORE_CONNECT,metric:Date.now()})}peerReceiver(){this.dispatch({type:S6.KEY_METRIC_PEER_RECEIVER,metric:Date.now()})}signalConnected(){this.dispatch({type:S6.KEY_METRIC_SIGNAL_CONNECTED,metric:Date.now()})}joinReq(){this.dispatch({type:S6.KEY_METRIC_JOIN_REQ,metric:Date.now()})}joinRep(){this.dispatch({type:S6.KEY_METRIC_JOIN_REP,metric:Date.now()})}joinGatewayStart(){this.dispatch({type:S6.KEY_METRIC_JOIN_GATEWAY_START,metric:Date.now()})}joinGatewayEnd(){this.dispatch({type:S6.KEY_METRIC_JOIN_GATEWAY_END,metric:Date.now()})}peerConnectionStart(){this.dispatch({type:S6.KEY_METRIC_PEER_CONNECTION_START,metric:Date.now()})}peerConnectionEnd(){this.dispatch({type:S6.KEY_METRIC_PEER_CONNECTION_END,metric:Date.now()})}firstVideoFrameDecoded(L,k){this.dispatch({type:S6.KEY_METRIC_FIRST_VIDEO_FRAME_DECODED,metric:Aw({userId:L},k)})}descriptionStart(){this.dispatch({type:S6.KEY_METRIC_DESCRIPTION_START,metric:Date.now()})}signalChannelOpen(){this.dispatch({type:S6.KEY_METRIC_SIGNAL_CHANNEL_OPEN,metric:Date.now()})}iceConnectionEnd(){this.dispatch({type:S6.KEY_METRIC_ICE_CONNECTION_END,metric:Date.now()})}publish(L,k,M,U){this.dispatch({type:S6.KEY_METRIC_PUBLISH,metric:Aw(Aw({trackId:L,type:k},M&&{publishStart:M}),U&&{publishEnd:U})})}subscribe(L,k,M,U,V,F,B){this.dispatch({type:S6.KEY_METRIC_SUBSCRIBE,metric:Aw(Aw(Aw(Aw(Aw({userId:L,type:k},M&&{subscribeStart:M}),U&&{subscribeEnd:U}),V&&{firstFrame:V}),F&&{streamAdded:F}),B&&{firstDecoded:B})})}massSubscribe(L,k,M,U){L.forEach(L=>{this.dispatch({type:S6.KEY_METRIC_SUBSCRIBE,metric:Aw(Aw(Aw({userId:L.userId,type:L.type},k&&{subscribeStart:k}),M&&{subscribeEnd:M}),U&&{firstFrame:U})})})}get keyMetrics(){return this.state.keyMetrics}recordJoinChannelService(L,k){"gateway"===L.service&&Array.isArray(L.urls)&&(L.urls=L.urls.map(L=>L.replace(/(\d+)-\d+-\d+-(\d+)/,"$1-*-*-$2")));try{return"number"!=typeof k?(this.dispatch({type:S6.RECORD_JOIN_CHANNEL_SERVICE,record:Aw(Aw({},L),{},{sessionId:this.sessionId,cloudProxyMode:this.cloudProxyServerMode,uid:this.uid})}),this.state.joinChannelServiceRecords.length-1):(k<0||k>=this.state.joinChannelServiceRecords.length||this.dispatch({type:S6.RECORD_JOIN_CHANNEL_SERVICE,record:L,index:k}),k)}catch(L){return 0}}resetJoinChannelServiceRecords(){this.dispatch({type:S6.RESET_JOIN_CHANNEL_SERVICE_RECORDS})}resetKeyMetrics(){this.dispatch({type:S6.RESET_KEY_METRICS})}resetFirstVideoFrameDecoded(){this.dispatch({type:S6.RESET_FIRST_VIDEO_FRAME_DECODED})}get joinChannelServiceRecords(){try{return this.state.joinChannelServiceRecords}catch(L){return[]}}}(L.codec,L.audioCodec,L.mode,this._clientId),this._leaveMutex=new S_("client-leave",this._clientId),this._publishMutex=new S_("client-publish",this._clientId),this._renewTokenMutex=new S_("client-renewtoken",this._clientId),this._subscribeMutex=new S_("client-subscribe",this._clientId),this.store.clientCreated(),L.proxyServer&&this.setProxyServer(L.proxyServer,!0),L.turnServer&&this.setTurnServer(L.turnServer,!0),gc.info("[".concat(this._clientId,"] Initializing AgoraRTC client v").concat(SJ," build: ").concat(S1,", mode: ").concat(this.mode,", codec: ").concat(this.codec)),L.clientRoleOptions)try{eO(L.clientRoleOptions),U=Object.assign({},L.clientRoleOptions)}catch(L){gc.warning("[".concat(this._clientId,"] ").concat(L.toString()))}this._statsCollector=new XF(this.store),this._statsCollector.onStatsException=(L,k,M)=>{gc.warn("[".concat(this._clientId,"] receive exception msg, code: ").concat(L,", msg: ").concat(k,", uid: ").concat(M)),L===Ij.VIDEO_ENCODE_FAILED&&this.localTracks.forEach(L=>{L instanceof T_&&wN("ENABLE_ENCODE_EXCEPTION")&&L.findClosestProfile()}),this.safeEmit(Si.EXCEPTION,{code:L,msg:k,uid:M})},this._statsCollector.onUploadPublishDuration=(L,k,M,U)=>{let V=this._users.find(k=>k.uid===L);V&&(this.store.keyMetrics&&(this.store.firstVideoFrameDecoded(V._uintid,{peerPublishDuration:M,peerPubStatusMs:Date.now()}),this._p2pChannel.reportVideoFirstFrameRender(V)),g_.peerPublishStatus(this._sessionId,{subscribeElapse:U,audioPublishDuration:k,videoPublishDuration:M,peer:V._uintid}))},this._statsCollector.onVideoCodecChanged=L=>{if(wN("VIDEO_STANDARD_BITRATE_VERSION")&&("av1"===L||"h265"===L||"h264"===L)){let k=this.localTracks.find(L=>L instanceof Tp);k&&1!==k._saveEncodeBitrateRatio&&k.setSaveEncodeBitrateRatio("h264"===L?wN("BASELINE_MORE_H264_BITRATE_RATIO"):void 0)}},this.store.useP2P="p2p"===L.mode,this._gateway=new iF(this.store,{clientId:this._clientId,mode:this.mode,codec:this.codec,websocketRetryConfig:L.websocketRetryConfig||Sm,httpRetryConfig:L.httpRetryConfig||Sm,forceWaitGatewayResponse:void 0===L.forceWaitGatewayResponse||L.forceWaitGatewayResponse,statsCollector:this._statsCollector,role:L.role,clientRoleOptions:U}),this._configDistribute=new WF(this._clientId,this.store),this.store.useP2P?(this._p2pChannel=(M={store:this.store,statsCollector:this._statsCollector},Jx("P2PChannel").create(M)),this._handleP2PEvents()):this._p2pChannel=new I8(this.store,this._statsCollector),this._handleP2PChannelEvents(),this._handleGatewayEvents(),this._handleGatewaySignalEvents()}async joinMeta(L,k,M,U,V){let F=!(arguments.length>5&&void 0!==arguments[5])||arguments[5],B=arguments.length>6&&void 0!==arguments[6]&&arguments[6];AN("JOIN_GATEWAY_USE_443PORT_ONLY",F),AN("JOIN_GATEWAY_USE_DUAL_DOMAIN",B);let j=this._gateway.signal.websocket;return j instanceof XV&&(j.use443PortOnly=F,j.tryDoubleDomain=B),async function(L,k,M){fH.get(L)||fH.set(L,[]),fY.get(L)||fY.set(L,k),fJ.get(L)||fJ.set(L,0);let U=fH.get(L),V=fY.get(L);if(!U||!V)throw Error("concurrent: deferQueue or maxConcurrency is null");if(fJ.get(L)===V){let L=xA();U.push(L),await L.promise}fJ.set(L,fJ.get(L)+1);for(var F=arguments.length,B=Array(F>3?F-3:0),j=3;j<F;j++)B[j-3]=arguments[j];let G=await M(...B);return fJ.set(L,fJ.get(L)-1),fJ.get(L)===V-1&&U.length>0&&(U[0].resolve(),U.shift()),0===fJ.get(L)&&(fH.set(L,[]),fY.set(L,0),fJ.set(L,0)),G}("client.join",wN("JOIN_MAX_CONCURRENCY"),this.join.bind(this),L,k,M,U,V)}async join(L,k,M,U,V){var F;let B;let j=++this._numberOfJoinCount;this.store.joinStart(),U&&(this.store.uid=U);let G="HTTPS"===(Sf||Sf||(Sf=(window.location.protocol.split(":")[0]||"").toUpperCase())),X=XO()?window.isSecureContext:"Browser Not Support";(XO()||G)&&window.isSecureContext||gc.warning("The website must be running in a secure context (About secure context: https://developer.mozilla.org/en-US/docs/Web/Security/Secure_Contexts ), otherwise the media collection will be restricted by the browser"),g_.setAppId(L);try{if(!M&&null!==M)throw new ED(f1.INVALID_PARAMS,"Invalid token: ".concat(M,". If you don not use token, set it to null"));if(M&&kw(M,"token",1,2047),kw(L,"appid",1,2047),GU(k),U&&WU(U),V){if("string"==typeof V)kw(V,"optionalInfo",1,256),B=V;else{if("object"!=typeof V)throw new ED(f1.INVALID_PARAMS,"Invalid options: options is not a string or object");{let{autoSubscribe:L,enableInstantMuteRestore:k}=V;L&&(Nw(L,"autoSubscribe"),gc.info("[".concat(this._clientId,"] join: autoSubscribe: ").concat(L)),this.store.autoSubscribe=L),k&&(Nw(k,"enableInstantMuteRestore"),gc.info("[".concat(this._clientId,"] join: enableInstantMuteRestore: ").concat(k)),this.store.enableInstantMuteRestore=k)}}}}catch(V){throw g_.reportApiInvoke(bO(),{name:f8.JOIN,options:[L,k,M,U],states:{isHttps:G,isSecureContext:X},tag:f9.TRACER}).onError(V),V}if(this._leaveMutex.isLocked&&(gc.debug("[".concat(this._clientId,"] join: waiting leave operation")),(await this._leaveMutex.lock())(),gc.debug("[".concat(this._clientId,"] join: continue"))),this._joinAndNotLeaveYet=!0,"DISCONNECTED"!==this.connectionState){let V=new ED(f1.INVALID_OPERATION,"[".concat(this._clientId,"] Client already in connecting/connected state"));throw g_.reportApiInvoke(bO(),{name:f8.JOIN,options:[L,k,M,U],states:{isHttps:G,isSecureContext:X},tag:f9.TRACER}).onError(V),V}this._gateway.state="CONNECTING",this.store.preloadStart();let $=await Aj({appId:L,cname:k,uid:U,stringUid:"string"==typeof U?U:void 0,token:M||L,cloudProxyServer:this._cloudProxyServerMode});if(this.store.preloadEnd(),!this._joinAndNotLeaveYet)throw new ED(f1.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));let ee=(null==$?void 0:$.sid)||bO();gc.info("[".concat(this._clientId,"] start join channel ").concat(k,", join number: ").concat(j)),this._sessionId||(this._sessionId=ee,this.store.sessionId=this._sessionId);let et=g_.reportApiInvoke(ee,{id:this._clientId,name:f8.JOIN,options:[L,k,M,U],states:{isHttps:G,isSecureContext:X},tag:f9.TRACER}),ei=oW(oW(oW({},this._rtmConfig),{},{role:this.role,clientId:this._clientId,appId:L,sid:this._sessionId,cname:k,uid:"string"!=typeof U?U:null,turnServer:this._turnServer,proxyServer:this._proxyServer,token:M||L,cloudProxyServer:this._cloudProxyServerMode,optionalInfo:B,license:this._license,useLocalAccessPoint:this._useLocalAccessPoint,preload:!!$},void 0!==this._remoteDefaultVideoStreamType&&{defaultVideoStream:this._remoteDefaultVideoStreamType}),{},{apRequestDetail:wN("AP_REQUEST_DETAIL")||void 0});if(this._useLocalAccessPoint&&(ei.setLocalAPVersion=this._setLocalAPVersion),"string"==typeof U&&(ei.stringUid=U,this._uintUid?(ei.uid=this._uintUid,this._uintUid=void 0):ei.uid=0),"none"!==this._encryptionMode&&this._encryptionSecret){if(ei.aesmode=this._encryptionMode,ei.aespassword=await (async L=>{let k=function(L){let k=window.atob("MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDCMnXAHkKIGAM+x4N22gCI+Wyu\nSTM9ztkT3uYslTT2PuKmZfPzhH6kVdO7PTjGCOZnAsyb3oTtWat0KcxQ4jxvqQV+\nHvYl3iI1Yd4vl2c3qRMJPLtRDfNxa2Mcxgq7e9aEUibzdd0st+OJAy3tOj/Y0aVy\nxQiYDz3vqa6bP29adwIDAQAB"),M=new Uint8Array(new ArrayBuffer(k.length));for(let L=0;L<k.length;L+=1)M[L]=k.charCodeAt(L);return M}(),M=await window.crypto.subtle.importKey("spki",k,{name:"RSA-OAEP",hash:"SHA-256"},!0,["encrypt"]),U=jw(L),V=await window.crypto.subtle.encrypt({name:"RSA-OAEP"},M,U);return function(L){let k="";for(let M=0;M<L.length;M+=1)k+=String.fromCharCode(L[M]);return window.btoa(k)}(new Uint8Array(V))})(this._encryptionSecret),!this._joinAndNotLeaveYet)throw new ED(f1.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));this._encryptionSalt&&(ei.aessalt=this._encryptionSalt)}if(this._encryptDataStream&&("aes-128-gcm2"===this._encryptionMode||"aes-256-gcm2"===this._encryptionMode)){if(this._encryptionSalt&&this._encryptionSecret){if(window.crypto.subtle){let L=new TextEncoder,k=wN("USE_PURE_ENCRYPTION_MASTER_KEY")?L.encode(ei.appId+this._encryptionSecret+this._encryptionSecret):L.encode(ei.appId+ei.cname+this._encryptionSecret);this._encryptDataStreamIv=await async function(L,k,M){let U=await window.crypto.subtle.importKey("raw",k,"PBKDF2",!1,["deriveBits","deriveKey"]),V="aes-128-gcm2"===L?128:256,F=await window.crypto.subtle.deriveBits({name:"PBKDF2",iterations:1e3,hash:"SHA-256",salt:M},U,V+96);return new Uint8Array(F).subarray(V/8)}(this._encryptionMode,k,fO(this._encryptionSalt)),this._encryptDataStreamKey=await async function(L,k,M){let U=await window.crypto.subtle.importKey("raw",k,"PBKDF2",!1,["deriveBits","deriveKey"]);return await window.crypto.subtle.deriveKey({name:"PBKDF2",iterations:1e3,hash:"SHA-256",salt:M},U,{name:"AES-GCM",length:"aes-128-gcm2"===L?128:256},!0,["encrypt","decrypt"])}(this._encryptionMode,k,fO(this._encryptionSalt))}else X?gc.warning("[".concat(this._clientId,"] encrypt datastream must be running in a secure context, fallback to plain data stream")):gc.warning("[".concat(this._clientId,"] current browser do not support WebCrypto ,fallback to plain data stream")),this._encryptDataStream=!1}else this._encryptDataStream=!1,gc.debug("[".concat(this._clientId,"] no salt / secret, cannot support encrypt data stream, fallback to plain data stream"))}this._startSession(this._sessionId,{channel:k,appId:L,stringUid:ei.stringUid});let er=this._sessionId;setTimeout(()=>{"CONNECTING"===this.connectionState&&er===this._sessionId&&g_.joinChannelTimeout(this._sessionId,5)},5e3);try{let U;let V=ei.cloudProxyServer;if(so(F=["proxy3","proxy4","proxy5"]).call(F,V)){let L=wN("PROXY_SERVER_TYPE3");Array.isArray(L)?ei.proxyServer=L[0]:ei.proxyServer=L}if(g_.setProxyServer(ei.proxyServer),gc.setProxyServer(ei.proxyServer),this.store.requestAPStart(),$){if(gc.debug("[".concat(this._clientId,"] get serverInfo Success from Preload Cache ").concat(ei.stringUid?", ".concat(ei.stringUid," => ").concat($.intUid):""," ")),ei.stringUid&&!ei.uid&&(ei.uid=$.intUid),U={gatewayInfo:$.ap.gatewayInfo},wN("JOIN_WITH_FALLBACK_MEDIA_PROXY")&&"auto"===ei.turnServer.mode){if(0===$.ap.proxyInfo.addresses.length)gc.warning("no edge services in ap response of proxy fallback, will not set proxy in iceServers");else{let L=(await dx($.ap.proxyInfo,$.ap.gatewayInfo.uid)).map(L=>({turnServerURL:L.address,tcpport:L.tcpport||SZ.tcpport,udpport:L.udpport||SZ.udpport,username:L.username||SZ.username,password:L.password||SZ.password,forceturn:!1,security:!0}));ei.turnServer={mode:"manual",servers:L}}}Dj($,ei.stringUid)}else{if(ei.stringUid&&!ei.uid){let L;[L,U]=await lQ.all([kF(ei.stringUid,ei,this._axiosCancelSource.token,this._config.httpRetryConfig||Sm,this.store).finally(()=>{this.store.requestSUAEnd()}),LF(ei,this._axiosCancelSource.token,this._config.httpRetryConfig||Sm,!0,this.store).finally(()=>{this.store.requestAPEnd()})]),gc.debug("[".concat(this._clientId,"] getUserAccount Success ").concat(ei.stringUid," => ").concat(L)),ei.uid=L,U.gatewayInfo.uid=L,U.gatewayInfo.res.uid=L}else U=await LF(ei,this._axiosCancelSource.token,this._config.httpRetryConfig||Sm,!0,this.store);if(!this._joinAndNotLeaveYet)throw new ED(f1.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"))}this.store.requestAPEnd(),setTimeout(()=>{this._configDistribute.startGetConfigDistribute(ei,this._axiosCancelSource.token),this._configDistribute.on(R0.UPDATE_BITRATE_LIMIT,L=>{this._p2pChannel.updateBitrateLimit(L)}),this._configDistribute.on(R0.UPDATE_CLIENT_ROLE_OPTIONS,L=>{this._setClientRoleOptions(L)})},0),this._key=M||L;let B=U.gatewayInfo,j=ei.uid?ei.uid:B.uid;this._joinInfo=oW(oW({},ei),{},{cid:B.cid,uid:j,vid:B.vid,apResponse:B.res,apGatewayAddress:B.apGatewayAddress,uni_lbs_ip:B.uni_lbs_ip,gatewayAddrs:B.gatewayAddrs}),this.store.intUid=j,this.store.cid=B.cid;let G=await this._joinGateway();if(!this._joinAndNotLeaveYet)throw new ED(f1.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));et.onSuccess(G),this._appId=L,this._channelName=ei.cname,this._uid=G,this.store.uid=G,setTimeout(()=>{this._networkQualityInterval&&window.clearInterval(this._networkQualityInterval),this._networkQualityInterval=window.setInterval(this._handleUpdateNetworkQuality,2e3),window.addEventListener($A()?"beforeunload":"pagehide",this._handleBeforeUnload),this._statsCollector.startUpdateStats()},0);let X=ei.stringUid?"string uid: ".concat(ei.stringUid,",uid: ").concat(ei.uid):"uid: ".concat(this._uid);return gc.info("[".concat(this._clientId,"] Joining channel success: channel: ").concat(k,",").concat(X)),setTimeout(()=>{gc.startUpload()},5e3),this.store.joinEnd(),so(TZ).call(TZ,this)||TZ.push(this),"disabled"===this._cloudProxyServerMode&&gf.supportWebCrypto&&wN("ENABLE_PRELOAD")&&Oj(this._joinInfo),G}catch(k){let L=Array.isArray(k)?k[0]:k;throw L&&L.code===f1.OPERATION_ABORTED?gc.warning("[".concat(this._clientId,"] join number: ").concat(j,", Joining channel failed, rollback"),L):gc.error("[".concat(this._clientId,"] join number: ").concat(j,", Joining channel failed, rollback"),L),L.code!==f1.OPERATION_ABORTED&&this._numberOfJoinCount===j&&(this._gateway.state="DISCONNECTED",this._reset()),et.onError(L),L}}_joinGateway(){if(!this._joinInfo||!this._key)throw new ED(f1.INVALID_OPERATION);return this._gateway.join(this._joinInfo,this._key,!("disabled"!==this._joinInfo.cloudProxyServer||this._joinInfo.proxyServer||!wN("JOIN_WITH_FALLBACK_SIGNAL_PROXY")))}async leave(){gc.info("[".concat(this._clientId,"] Leaving channel")),window.removeEventListener($A()?"beforeunload":"pagehide",this._handleBeforeUnload),this._reset(),function(L){let k=TZ.indexOf(L);-1!==k&&TZ.splice(k,1)}(this),this._statsCollector.stopUpdateStats();let L=await this._leaveMutex.lock();if("DISCONNECTED"===this.connectionState)return gc.info("[".concat(this._clientId,"] Leaving channel repeated, success")),void L();await this._gateway.leave("CONNECTED"!==this.connectionState,Se.LEAVE),gc.info("[".concat(this._clientId,"] Leaving channel success")),this._joinAndNotLeaveYet=!1,this.store.resetJoinChannelServiceRecords(),L()}async publish(L){let k=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(!Array.isArray(L)){if(!(L instanceof uP))return this._publishDataChannel(L);L=[L]}if(0===L.length)throw new ED(f1.INVALID_PARAMS,"param list is empty");let M=L;if("audience"===this._gateway.role)throw new ED(f1.INVALID_OPERATION,"audience can not publish stream");for(let L of M){if(!(L instanceof uP))throw new ED(f1.INVALID_PARAMS,"parameter is not local track");if(!L._enabled&&k)throw new ED(f1.TRACK_IS_DISABLED,"can not publish a disabled track: ".concat(L.getTrackId()))}gc.info("[".concat(this._clientId,"] Publishing tracks, id ").concat(M.map(L=>"".concat(L.getTrackId()," "))));let U=await this._publishMutex.lock();await this._configDistribute.awaitConfigDistributeComplete(),k&&M.forEach(L=>{let k=this._configDistribute.getBitrateLimit();L instanceof Tp&&k&&L.setBitrateLimit(k.uplink)});try{await this._publishHighStream(M),gc.info("[".concat(this._clientId,"] Publish success, id ").concat(M.map(L=>"".concat(L.getTrackId()," "))))}catch(L){throw gc.error("[".concat(this._clientId,"] publish error"),L.toString()),L}finally{U()}}async _publishDataChannel(L){if(null==L)throw new ED(f1.INVALID_PARAMS,"parameter is not local track or datachannel config, config is ".concat(JSON.stringify(L)));Pw(L.id,"id",0,65535,!0),Nw(L.ordered,"ordered"),kw(L.metadata,"metadata",0,512),gc.info("[".concat(this._clientId,"] Publishing datachannels, id ").concat(L.id));let k=await this._publishMutex.lock();try{if(-1!==this._p2pChannel.getAllDataChannels().findIndex(k=>k.id===L.id))throw new ED(f1.INVALID_PARAMS,"Invalid id: ".concat(L.id,". If you want to republish the datachannel, unpublish first"));if(!this._joinInfo||void 0===this._uid)throw new ED(f1.INVALID_OPERATION,"Can't publish datachannel, haven't joined yet!");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new ED(f1.INVALID_OPERATION,"can not publish datachannel in ".concat(this.connectionState," state"));if("auto"===this._turnServer.mode&&wN("FORCE_TURN")&&!wN("TURN_ENABLE_TCP")&&!wN("TURN_ENABLE_UDP"))throw new ED(f1.UNEXPECTED_ERROR,"force TURN With No TURN Configuration");let k=Zx(L,!1),M=await this._p2pChannel.publishDataChannel([k]);if(M.length>0){if("number"!=typeof k._originDataChannelId)throw gc.error("[".concat(this._clientId,"] can not publish with mediaType datachannel, cannot get RTCDatachannel id")),new ED(f1.CREATE_DATACHANNEL_ERROR);try{await lQ.all(M.map(L=>this._uid&&this._gateway.publishDataChannel(this._uid,L,!0))),await k._waitTillOpen()}catch(L){if(L.code!==f1.DISCONNECT_P2P)throw L}}return gc.info("[".concat(this._clientId,"] Publish dataChannels success, id ").concat(k.id)),k}catch(L){throw gc.error("[".concat(this._clientId,"] publish datachannels error"),L.toString()),L}finally{k()}}async unpublish(L){if(!this._joinInfo||void 0===this._uid)throw new ED(f1.INVALID_OPERATION,"Can't unpublish stream, haven't joined yet!");let k=[];if(L){if(Array.isArray(L))k=L;else{if(!(L instanceof uP))return this._unpublishDataChannel([L]);k=[L]}}else this.store.useP2P||await this._unpublishDataChannel(),k=this._p2pChannel.getAllTracks(!0);gc.info("[".concat(this._clientId,"] Unpublish tracks, tracks ").concat(k.map(L=>"".concat(L.getTrackId()," "))," "));let M=await this._publishMutex.lock();try{if(this.store.useP2P){let L=await this._p2pChannel.unpublish(k);L&&await this._gateway.sendExtensionMessage(Io.UNPUBLISH,{unpubMsg:L},!0)}else{let L=await this._p2pChannel.unpublish(k);L&&await this._gateway.unpublish(L,this._uid),gc.info("[".concat(this._clientId,"] Unpublish success,tracks ").concat(k.map(L=>"".concat(L.getTrackId()))))}}catch(L){throw gc.error("[".concat(this._clientId,"] unpublish error"),L.toString()),L}finally{M&&M()}}async _unpublishDataChannel(L){void 0!==L&&0!==L.length||(L=this._p2pChannel.getAllDataChannels()),gc.info("[".concat(this._clientId,"] Unpublish datachannels, datachannels ").concat(L.map(L=>"".concat(L.id," "))," "));let k=await this._publishMutex.lock();try{let k=await this._p2pChannel.unpublishDataChannel(L);k&&await this._gateway.unpublishDataChannel(k),gc.info("[".concat(this._clientId,"] Unpublish dataChannel success,dataChannel ").concat(L.map(L=>"".concat(L.id))))}catch(L){throw gc.error("[".concat(this._clientId,"] unpublish dataChannel error"),L.toString()),L}finally{k&&k()}}async subscribe(L,k,M){if(!(L instanceof QF)){let k=this.remoteUsers.find(k=>k.uid===L);if(!k)throw new ED(f1.INVALID_REMOTE_USER,"user is not in the channel");L=k}return"datachannel"===k?this._subscribeDataChannel(L,M):this._subscribe(L,k)}async presubscribe(L,k){if(Dw(k,"mediaType",["audio","video"]),this.store.useP2P)throw new ED(f1.INVALID_OPERATION,"can't presub at p2p mode");if(!this._joinInfo)throw new ED(f1.INVALID_OPERATION,"can't presub when not join");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new ED(f1.INVALID_OPERATION,"can't presub in ".concat(this.connectionState," state"));let M=k===R1.AUDIO,U=k===R1.VIDEO,V=await this._subscribeMutex.lock();try{let{ssrcId:V,ortc:F,rtxSsrcId:B,cname:j,uint_id:G}=await this._gateway.presubscribe(L,k,!0);if(null==V)throw new ED(f1.UNEXPECTED_RESPONSE,"no ssrc id");let X=this._users.find(k=>k.uid===L);X||((X=new QF(L,G||L))._is_pre_created=!0,this._users.push(X)),j&&(X._cname=j),X._uintid||(X._uintid=G||L),M&&(X._audioSSRC=V,X._audio_pre_subscribed=!0,F&&(X._audioOrtc=F)),U&&(X._videoSSRC=V,X._video_pre_subscribed=!0,F&&(X._videoOrtc=F),null!=B&&(X._rtxSsrcId=B)),gc.info("[".concat(this._clientId,"] presub succeed ssrc: ").concat(V)),await this._p2pChannel.subscribe(X,k,V,B,F);let $=M?X._audioTrack:X._videoTrack;if(!$)throw new ED(f1.UNEXPECTED_ERROR,"can not find remote track in user");return M&&(X._trust_audio_stream_added_state_=!0,X._audio_added_=!0),U&&(X._trust_video_stream_added_state_=!0,X._video_added_=!0),$}catch(k){throw gc.error("[".concat(this._clientId,"] presub user ").concat(L," error"),k),k}finally{V()}}async _subscribeDataChannel(L,k){var M,U;if(Pw(k,"channelId",0,65535,!0),!this._joinInfo)throw new ED(f1.INVALID_OPERATION,"Can't subscribe datachannel, not joined");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new ED(f1.INVALID_OPERATION,"Can't subscribe datachannel in ".concat(this.connectionState," state"));let V=this._users.find(k=>k===L);if(!V)throw gc.error("[".concat(this._clientId,"] can not subscribe ").concat(L.uid,", this user is not in the channel")),new ED(f1.INVALID_REMOTE_USER,"user is not in the channel");if(!L.hasAudio&&!L.hasVideo&&0===L._dataChannels.length)throw gc.error("[".concat(this._clientId,"] can not subscribe ").concat(L.uid,", user is not published")),new ED(f1.INVALID_REMOTE_USER,"user is not published");let F=null===(M=L._dataChannels)||void 0===M?void 0:M.find(L=>L.id===k);if(!F)throw gc.error("[".concat(this._clientId,"] can not subscribe ").concat(L.uid," with mediaType datachannel, remote datachannel is not published")),new ED(f1.REMOTE_USER_IS_NOT_PUBLISHED);let B=await this._subscribeMutex.lock();gc.info("[".concat(this._clientId,"] subscribe user ").concat(L.uid,", mediaType: datachannel"));try{let k=await this._p2pChannel.subscribeDataChannel(L,[F]);if(k&&so(k).call(k,F.id))try{if("number"!=typeof F._originDataChannelId)throw gc.error("[".concat(this._clientId,"] can not subscribe ").concat(L.uid," with mediaType datachannel, cannot get RTCDatachannel")),new ED(f1.CREATE_DATACHANNEL_ERROR);let k={id:F.id,datachannelId:F._originDataChannelId,ordered:F.ordered,maxRetransmits:F.maxRetransmits,metadata:null!==(U=F.metadata)&&void 0!==U?U:""};await this._gateway.subscribeDataChannel(L.uid,k,!0),await F._waitTillOpen()}catch(k){if((null==k?void 0:k.code)!==f1.WS_ABORT)throw await this._p2pChannel.unsubscribeDataChannel(L,[F]),k;await this._p2pChannel.unsubscribeDataChannel(L,[F]),this._p2pChannel.setPendingRemoteDataChannel(L,F.id)}return gc.info("[".concat(this._clientId,"] subscribe success user ").concat(L.uid,", mediaType: datachannel")),F}finally{B()}}async _p2pSubscribe(L,k,M){if(Dw(k,"mediaType",["audio","video"]),!this._joinInfo)throw new ED(f1.INVALID_OPERATION,"Can't subscribe stream, not joined");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new ED(f1.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));let U=this._users.find(k=>k===L);if(!U){let k=new ED(f1.INVALID_REMOTE_USER,"user is not in the channel");throw gc.error("[".concat(this._clientId,"] can not subscribe ").concat(L.uid,", this user is not in the channel")),k}if(!L.hasAudio&&!L.hasVideo){let k=new ED(f1.INVALID_REMOTE_USER,"user is not published");throw gc.error("[".concat(this._clientId,"] can not subscribe ").concat(L.uid,", user is not published")),k}if(!M&&("audio"===k&&!L.hasAudio||"video"===k&&!L.hasVideo)){let M=new ED(f1.REMOTE_USER_IS_NOT_PUBLISHED);throw gc.error("[".concat(this._clientId,"] can not subscribe ").concat(L.uid," with mediaType ").concat(k,", remote track is not published")),M}let V=await this._subscribeMutex.lock();gc.info("[".concat(this._clientId,"] subscribe user ").concat(L.uid,", mediaType: ").concat(k));try{if(await this._p2pChannel.hasRemoteMediaWithLock(L,k))await this._p2pChannel.unmuteRemote(L,k);else try{let M="audio"===k?L._audioSSRC:L._videoSSRC,U="audio"===k?L._audioMid:L._videoMid;this.store.subscribe(L.uid,k,Date.now()),this.store.useP2P&&await this._p2pChannel.subscribe(L,k,M,U)}catch(L){throw L}gc.info("[".concat(this._clientId,"] subscribe success user ").concat(L.uid,", mediaType: ").concat(k)),this._defaultStreamFallbackType&&this.setStreamFallbackOption(L.uid,this._defaultStreamFallbackType).catch(L=>{gc.warning("[".concat(this._clientId,"] auto set fallback failed"),L)});let M="audio"===k?L._audioTrack:L._videoTrack;if(!M)throw new ED(f1.UNEXPECTED_ERROR,"can not find remote track in user object");return M}catch(k){throw gc.error("[".concat(this._clientId,"] subscribe user ").concat(L.uid," error"),k),k}finally{V()}}async _subscribe(L,k,M){if(this.store.useP2P)return this._p2pSubscribe(L,k);if(Dw(k,"mediaType",["audio","video"]),!this._joinInfo)throw new ED(f1.INVALID_OPERATION,"Can't subscribe stream, not joined");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new ED(f1.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));let U=this._users.find(k=>k===L);if(!U){let k=new ED(f1.INVALID_REMOTE_USER,"user is not in the channel");throw gc.error("[".concat(this._clientId,"] can not subscribe ").concat(L.uid,", this user is not in the channel")),k}if(!L.hasAudio&&!L.hasVideo){let k=new ED(f1.INVALID_REMOTE_USER,"user is not published");throw gc.error("[".concat(this._clientId,"] can not subscribe ").concat(L.uid,", user is not published")),k}if(!(M||("audio"!==k||L.hasAudio&&void 0!==L._audioSSRC)&&("video"!==k||L.hasVideo&&void 0!==L._videoSSRC))){let M=new ED(f1.REMOTE_USER_IS_NOT_PUBLISHED);throw gc.error("[".concat(this._clientId,"] can not subscribe ").concat(L.uid," with mediaType ").concat(k,", remote track is not published")),M}let V="audio"===k?L._audioSSRC:L._videoSSRC,F="audio"===k?L._audioOrtc:L._videoOrtc,B="video"===k?L._rtxSsrcId:void 0,j={stream_type:"audio"===k?R1.AUDIO:R1.VIDEO,ssrcId:V};"video"===k&&this.store.firstVideoFrameDecoded(L.uid,{subscribeStart:Date.now()});let G=await this._subscribeMutex.lock();gc.info("[".concat(this._clientId,"] subscribe user ").concat(L.uid,", mediaType: ").concat(k));try{if(await this._p2pChannel.hasRemoteMediaWithLock(L,k))await this._p2pChannel.unmuteRemote(L,k);else try{let M="audio"===k?L._audioSSRC:L._videoSSRC;void 0!==M&&M!==V&&(V=M,F="audio"===k?L._audioOrtc:L._videoOrtc,B="video"===k?L._rtxSsrcId:void 0,j={stream_type:"audio"===k?R1.AUDIO:R1.VIDEO,ssrcId:V}),IW.markSubscribeStart(this.store.clientId,V),this.store.subscribe(L.uid,k,Date.now()),await this._p2pChannel.subscribe(L,k,V,B,F);try{this._p2pChannel.isPreSubScribe(V)||await this._gateway.subscribe(L.uid,j,!0)}catch(M){if((null==M?void 0:M.code)!==f1.WS_ABORT)throw await this._p2pChannel.unsubscribe(L,k),M;await this._p2pChannel.unsubscribe(L,k,!0),this._p2pChannel.setPendingRemoteMedia(L,k)}this.store.subscribe(L.uid,k,void 0,Date.now()),this._p2pChannel.reportSubscribeEvent(!0,null,L,k)}catch(M){throw this._p2pChannel.reportSubscribeEvent(!1,null==M?void 0:M.code,L,k),M}gc.info("[".concat(this._clientId,"] subscribe success user ").concat(L.uid,", mediaType: ").concat(k)),this._defaultStreamFallbackType&&this.setStreamFallbackOption(L.uid,this._defaultStreamFallbackType).catch(L=>{gc.warning("[".concat(this._clientId,"] auto set fallback failed"),L)});let M="audio"===k?L._audioTrack:L._videoTrack;if(!M)throw new ED(f1.UNEXPECTED_ERROR,"can not find remote track in user object");return"video"===k&&(this.store.firstVideoFrameDecoded(L.uid,{subscribeEnd:Date.now()}),this._p2pChannel.reportVideoFirstFrameRender(L)),M}catch(k){throw gc.error("[".concat(this._clientId,"] subscribe user ").concat(L.uid," error"),k),k}finally{G()}}async massSubscribe(L){if(Mw(L,"subscribeList"),!this._joinInfo)throw new ED(f1.INVALID_OPERATION,"Can't subscribe stream, not joined");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new ED(f1.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));let k=Date.now(),M=new Map,U=await this._subscribeMutex.lock();gc.info("[".concat(this._clientId,"]start massSubscribe user ").concat(L.map(L=>{let{user:k,mediaType:M}=L;return"user: ".concat(null==k?void 0:k.uid,", mediaType: ").concat(M)}).join("; ")));let V=(L=[...L]).map(L=>{let{user:k,mediaType:M}=L;return{user:k,mediaType:M}}),F=await this._p2pChannel.globalLock();try{var B;for(let k=L.length-1;k>=0;k--){let U=L[k],{user:F,mediaType:B}=U;if(Dw(B,"mediaType",["audio","video"]),!F){let L=new ED(f1.INVALID_PARAMS,"user property does not exist in subscribeList item");throw gc.error("[".concat(this._clientId,"] user property does not exist in subscribeList item")),L}let j=this._users.find(L=>L===F);if(!j){let M=new ED(f1.INVALID_REMOTE_USER,"user is not in the channel");gc.error("[".concat(this._clientId,"] can not massSubscribe ").concat(F.uid,", this user is not in the channel")),V[k].error=M,L.splice(k,1);continue}if("audio"===B&&(!F.hasAudio||void 0===F._audioSSRC)||"video"===B&&(!F.hasVideo||void 0===F._videoSSRC)){let M=new ED(f1.REMOTE_USER_IS_NOT_PUBLISHED);gc.error("[".concat(this._clientId,"] can not subscribe ").concat(F.uid," with mediaType ").concat(B,", remote user is not published")),V[k].error=M,L.splice(k,1);continue}let G=RJ.Video|RJ.LwoVideo,X=M.get(F);if(X){if("video"===B?X&G:X&RJ.Audio){L.splice(k,1),gc.warning("[".concat(this._clientId,"] repeat massSubscribe user:").concat(F.uid,", mediaType:").concat(B," twice"));continue}M.set(F,X|("video"===B?G:RJ.Audio))}else M.set(F,"video"===B?G:RJ.Audio)}for(let k=L.length-1;k>=0;k--){let U=L[k],{user:V,mediaType:F}=U,B=RJ.Video|RJ.LwoVideo;if(this._p2pChannel.hasRemoteMedia(V,F)){await this._p2pChannel.unmuteRemoteNoLock(V,F);let U=M.get(V);M.set(V,"video"===F?U^B:U^RJ.Audio),L.splice(k,1)}}this.store.massSubscribe(L.map(L=>({userId:L.user.uid,type:L.mediaType})),k);let U=sE(B=Array.from(M.entries())).call(B,(L,k)=>{let[M,U]=k;if(0===U)return L;let V={stream_id:M.uid,stream_type:U};return U&RJ.Audio&&(V.audio_ssrc=M._audioSSRC),U&RJ.Video&&(V.video_ssrc=M._videoSSRC),L.push(V),L},[]);try{L.length>0&&await this._p2pChannel.massSubscribeNoLock(L.map(L=>{let{user:k,mediaType:M}=L;return{user:k,mediaType:M,ssrcId:M===R1.VIDEO?k._videoSSRC:k._audioSSRC,rtxSsrcId:M===R1.VIDEO?k._rtxSsrcId:void 0}}));let M=new Map;if((U=U.filter(L=>L.video_ssrc&&!this._p2pChannel.isPreSubScribe(L.video_ssrc)||L.audio_ssrc&&!this._p2pChannel.isPreSubScribe(L.audio_ssrc)||!L.video_ssrc&&!L.audio_ssrc)).length>0){let L=await this._gateway.subscribeAll(U,!0);((null==L?void 0:L.users)||[]).forEach(L=>{let{stream_id:k,video_error_code:U,audio_error_code:V,error_code:F}=L;(U||V||F)&&M.set(k,{video_error_code:U,audio_error_code:V,error_code:F})})}if(Array.from(M.entries()).length>0){let L=[];Array.from(M.entries()).forEach(k=>{let[M,U]=k,V=this.remoteUsers.find(L=>L.uid===M);if(V){let k;U.error_code||U.video_error_code&&U.audio_error_code?k=void 0:U.video_error_code?k=R1.VIDEO:U.audio_error_code&&(k=R1.AUDIO),L.push({user:V,mediaType:k})}}),L.length>0&&await this._p2pChannel.massUnsubscribeNoLock(L)}for(let L of V){let k=M.get(L.user.uid);if(k){let M=k.error_code||"audio"===L.mediaType&&k.audio_error_code||"video"===L.mediaType&&k.video_error_code;if(M){let k=VV(M);gc.error("user:".concat(L.user.uid," mediaType:").concat(L.mediaType," has massSubscribe error ").concat(k.desc)),L.error=new ED(f1.SUBSCRIBE_FAILED,"code ".concat(M,": ").concat(k.desc))}}L.error||("video"===L.mediaType?L.track=L.user.videoTrack:L.track=L.user.audioTrack)}return this.store.massSubscribe(V.filter(L=>!L.error).map(L=>({userId:L.user.uid,type:L.mediaType})),void 0,Date.now()),V.forEach(L=>{var M;g_.subscribe(this.store.sessionId,{succ:!!L.error,ec:(null===(M=L.error)||void 0===M?void 0:M.code)||null,video:L.mediaType===R1.VIDEO,audio:L.mediaType===R1.AUDIO,peerid:L.user.uid,subscribeRequestid:L.mediaType===R1.VIDEO?L.user._videoSSRC:L.user._audioSSRC,p2pid:this.store.p2pId,eventElapse:Math.floor(performance.now()-k),preSsrc:this._p2pChannel.isPreSubScribe(L.user._videoSSRC)},!0)}),gc.info("[".concat(this._clientId,"] massSubscribe success ").concat(L.map(L=>{let{user:k,mediaType:M}=L;return"user: ".concat(null==k?void 0:k.uid,", mediaType: ").concat(M)}).join("; "))),V}catch(k){throw await this._p2pChannel.massUnsubscribeNoLock(L),k}}finally{F(),U()}}async unsubscribe(L,k,M){if(!(L instanceof QF)){let k=this.remoteUsers.find(k=>k.uid===L);if(!k)throw new ED(f1.INVALID_REMOTE_USER,"user is not in the channel");L=k}if(k||this.store.useP2P){if("datachannel"===k)return this._unsubscribeDataChannel(L,M)}else await this._unsubscribeDataChannel(L,M);if(k&&Dw(k,"mediaType",["audio","video"]),!this._joinInfo)throw new ED(f1.INVALID_OPERATION,"Can't unsubscribe stream, haven't joined yet!");let U=this._users.find(k=>k===L);if(!U){let k=new ED(f1.INVALID_REMOTE_USER,"user is not in the channel");throw gc.error("[".concat(this._clientId,"] can not unsubscribe ").concat(L.uid,", user is not in the channel")),k}gc.info("[".concat(this._clientId,"] unsubscribe uid: ").concat(L.uid,", mediaType: ").concat(k));let V=await this._subscribeMutex.lock();try{if(this.store.useP2P)await this._p2pChannel.unsubscribe(L,k);else{let M=await this._p2pChannel.unsubscribe(L,k);M&&await this._gateway.unsubscribe(M,L.uid),k&&"audio"!==k||(L._audio_pre_subscribed=!1),k&&"video"!==k||(L._video_pre_subscribed=!1),L._is_pre_created&&lO(this._users,L),gc.info("[".concat(this._clientId,"] unsubscribe success uid: ").concat(L.uid,", mediaType: ").concat(k))}}catch(k){if(k.code===f1.DISCONNECT_P2P)return void gc.warning("disconnecting p2p, abort unsubscribe request.");throw gc.error("[".concat(this._clientId,"] unsubscribe user ").concat(L.uid," error"),k.toString()),k}finally{V()}}async _unsubscribeDataChannel(L,k){let M;if(k&&Pw(k,"id",0,65535,!0),!this._joinInfo)throw new ED(f1.INVALID_OPERATION,"Can't unsubscribe datachannel, haven't joined yet!");let U=this._users.find(k=>k===L);if(!U){let k=new ED(f1.INVALID_REMOTE_USER,"user is not in the channel");throw gc.error("[".concat(this._clientId,"] can not unsubscribe ").concat(L.uid,", user is not in the channel")),k}if("number"==typeof k){let U=L._dataChannels.find(L=>L.id===k);U&&(M=[U])}else M=L._dataChannels;if(void 0===M){let M=new ED(f1.REMOTE_USER_IS_NOT_PUBLISHED);throw gc.error("[".concat(this._clientId,"] can not unsubscribe ").concat(L.uid," with channelId ").concat(k,", remote datachannel is not published")),M}gc.info("[".concat(this._clientId,"] unsubscribe uid: ").concat(L.uid,", mediaType: datachannel, ids: ").concat(M.map(L=>L.id)));try{let k=await this._p2pChannel.unsubscribeDataChannel(L,M);k&&await this._gateway.unsubscribeDataChannel(k,L.uid),gc.info("[".concat(this._clientId,"] unsubscribe datachannel success uid: ").concat(L.uid,", mediaType: datachannel, ids: ").concat(k))}catch(k){if(k.code===f1.DISCONNECT_P2P)return void gc.warning("disconnecting p2p, abort unsubscribe request.");throw gc.error("[".concat(this._clientId,"] unsubscribe user ").concat(L.uid," error"),k.toString()),k}}async massUnsubscribe(L){if(Mw(L,"unsubscribeList"),!this._joinInfo)throw new ED(f1.INVALID_OPERATION,"Can't unsubscribeAll stream, haven't joined yet!");gc.info("[".concat(this._clientId,"] start massUnsubscribe ").concat(L.map(L=>{let{user:k,mediaType:M}=L;return"user: ".concat(null==k?void 0:k.uid,", mediaType: ").concat(M,";")}).join())),L=[...L];let k=new Map;for(let M=L.length-1;M>=0;M--){let{user:U,mediaType:V}=L[M];if(!U){let L=new ED(f1.INVALID_PARAMS,"user property does not exist in unsubscribeList item");throw gc.error("[".concat(this._clientId,"] user property does not exist in unsubscribeList item")),L}Dw(V,"mediaType",["video","audio",void 0]);let F=this._users.find(L=>L===U);if(!F){gc.warning("[".concat(this._clientId,"] can not unsubscribe ").concat(U.uid,", user is not in the channel")),L.splice(M,1);continue}let B=RJ.Video|RJ.LwoVideo;if(k.has(U)){let F;let j=k.get(U);switch(V){case"video":F=j&B;break;case"audio":F=j&RJ.Audio;break;default:F=j&(RJ.Audio|B)}if(F){gc.warning("[".concat(this._clientId,"] repeat massUnsubscribe user:").concat(U.uid,",mediaType:").concat(V," twice.")),L.splice(M,1);continue}V?"audio"===V?k.set(U,j|RJ.Audio):"video"===V&&k.set(U,j|B):k.set(U,j|RJ.Audio|B)}else V?"audio"===V?k.set(U,RJ.Audio):"video"===V&&k.set(U,B):k.set(U,RJ.Audio|B)}try{let k=await this._p2pChannel.massUnsubscribe(L);k&&await this._gateway.massUnsubscribe(k),gc.info("[".concat(this._clientId,"] massUnsubscribe success ").concat(L.map(L=>{let{user:k,mediaType:M}=L;return"user: ".concat(null==k?void 0:k.uid,", mediaType: ").concat(M,";")}).join()))}catch(L){if(L.code===f1.DISCONNECT_P2P)return void gc.warning("[".concat(this._clientId,"] disconnecting p2p, abort unsubscribe request."));throw gc.error("[".concat(this._clientId,"] massUnsubscribe error"),L.toString()),L}}async setLowStreamParameter(L){(function(L){if(!L)throw new f2(f1.INVALID_PARAMS);Uw(L.width)||Lw(L.width,"streamParameter.width"),Uw(L.height)||Lw(L.height,"streamParameter.height"),Uw(L.framerate)||Lw(L.framerate,"streamParameter.framerate"),Uw(L.bitrate)||Pw(L.bitrate,"streamParameter.bitrate")})(L),(!L.width&&L.height||L.width&&!L.height)&&gc.warning("[".concat(this._clientId,"] The width and height parameters take effect only when both are set")),gc.info("[".concat(this._clientId,"] set low stream parameter to"),JSON.stringify(L));let k=this._configDistribute.getLowStreamConfigDistribute();if(k&&k.bitrate&&L.bitrate&&k.bitrate<L.bitrate&&(L.bitrate=k.bitrate),this._lowStreamParameter=L,this._isDualStreamEnabled)return this._p2pChannel.updateVideoStreamParameter(L,R4.LocalVideoLowTrack)}async enableDualStream(){if(!gf.supportDualStream)throw g_.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!1}),new ED(f1.NOT_SUPPORTED,"Your browser is not support dual stream");if(this._isDualStreamEnabled)throw new ED(f1.INVALID_OPERATION,"Dual stream is already enabled");if(this._p2pChannel.canPublishLowStream())try{await this._publishLowStream()}catch(L){throw g_.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!1}),L}this._isDualStreamEnabled=!0,g_.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!0}),gc.info("[".concat(this._clientId,"] enable dual stream"))}async disableDualStream(){if(this._isDualStreamEnabled){if(!this._joinInfo)throw new ED(f1.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if(this._p2pChannel.getLocalMedia(R4.LocalVideoLowTrack))try{let L=await this._p2pChannel.unpublishLowStream();L&&await this._gateway.unpublish(L,this._joinInfo.stringUid||this._joinInfo.uid)}catch(L){throw g_.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!1,succ:!1}),L}this._isDualStreamEnabled=!1,g_.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!1,succ:!0}),gc.info("[".concat(this._clientId,"] disable dual stream"))}}async setClientRole(L,k){if(Dw(L,"role",["audience","host"]),k&&eO(k),"rtc"===this.mode||"p2p"===this.mode)throw gc.warning("[".concat(this._clientId,"]").concat(this.mode," mode can not use setClientRole")),new ED(f1.INVALID_OPERATION,"".concat(this.mode," mode can not use setClientRole"));if(k&&k.level&&"host"===L)throw new ED(f1.INVALID_OPERATION,"host mode can not set audience latency level");if("audience"===L&&this._p2pChannel.hasLocalMedia())throw new ED(f1.INVALID_OPERATION,"can not set client role to audience when publishing stream");let M=this._config.role;this._joinInfo&&(this._joinInfo.role=L),L!==M&&wN("ENABLE_ROLE_SELECT_EDGE")?(this._gateway.updateClientRole(L,k),this._config.role=L,this._gateway.reconnect("recover",Sr.REGIONAL_DISTRIBUTION)):(await this._gateway.setClientRole(L,k),this._config.role=L),gc.info("[".concat(this._clientId,"] set client role to ").concat(L,", level: ").concat(k&&k.level))}async _setClientRoleOptions(L){if("rtc"===this.mode||"p2p"===this.mode||"audience"!==this._config.role||this._p2pChannel.hasLocalMedia())return;let k=!1;try{L&&eO(L),await this._gateway.setClientRole(this._config.role,L),k=!0}catch(L){}finally{gc.info("[".concat(this._clientId,"] set client role options ").concat(k?"succeed":"failed",", options is ").concat(L))}}getRemoteInboundOffset(){var L;let k=null===(L=this._p2pChannel.getStats())||void 0===L?void 0:L.audioSend[0];if(!k||!k.timestamp)return 0;let M=k.timestamp-Date.now();return Math.abs(M)>1e3+k.rttMs+100?this.ntpAlignErrorCount+=1:this.ntpAlignErrorCount=0,this.ntpAlignErrorCount>=3?M:0}getNtpWallTimeInMs(){return"visible"===document.visibilityState&&(this.remoteInboundOffset=this.getRemoteInboundOffset()),this.remoteInboundOffset+Date.now()+this._gateway.ntpOffset}setProxyServer(L,k){if(kw(L,"proxyServer"),!k){if("DISCONNECTED"!==this.connectionState)throw new ED(f1.INVALID_OPERATION,"Set proxy server before join channel");if("disabled"!==this._cloudProxyServerMode||this._useLocalAccessPoint)throw new ED(f1.INVALID_OPERATION,"You have already set the proxy")}this._proxyServer=L,g_.setProxyServer(this._proxyServer),gc.setProxyServer(this._proxyServer),gc.info("[".concat(this._clientId,"] Set proxy server ").concat(k?"by initialize call":""," success."))}setTurnServer(L,k){if(Array.isArray(L)||(L=[L]),!k){if("DISCONNECTED"!==this.connectionState)throw new ED(f1.INVALID_OPERATION,"Set turn server before join channel");if("disabled"!==this._cloudProxyServerMode||this._useLocalAccessPoint)throw new ED(f1.INVALID_OPERATION,"You have already set the proxy")}if(Qw(L))return this._turnServer={servers:L,mode:"original-manual"},void gc.info("[".concat(this._clientId,"] Set original turnserver ").concat(k?"by initialize call":""," success: ").concat(L.map(L=>L.urls).join(","),"."));L.forEach(L=>$w(L)),this._turnServer={servers:L,mode:"manual"},gc.info("[".concat(this._clientId,"] Set turnserver ").concat(k?"by initialize call":""," success."))}setLicense(L){if("DISCONNECTED"!==this.connectionState)throw new ED(f1.INVALID_OPERATION,"you should set license before join channel");if(kw(L,"license",32,32),!/^[A-Za-z\d]+$/.test(L))throw new ED(f1.INVALID_PARAMS,"license should only contains characters from A-Z a-z 0-9");this._license=L,gc.info("[".concat(this._clientId,"] set license success"),L)}startProxyServer(L){let k;if("DISCONNECTED"!==this.connectionState)throw new ED(f1.INVALID_OPERATION,"Start proxy server before join channel");if(this._proxyServer||"manual"===this._turnServer.mode||this._useLocalAccessPoint)throw new ED(f1.INVALID_OPERATION,"You have already set the proxy");switch(void 0===L&&(L=3),L){case 1:case 2:throw new ED(f1.NOT_SUPPORTED,"proxy mode 1/2 has been deprecated and not supported.");case 3:k="proxy3";break;case 4:k="proxy4";break;case 5:k="proxy5";break;default:throw new ED(f1.INVALID_PARAMS,"proxy server mode must be ".concat("3|4|5"))}this._cloudProxyServerMode=k,this.store.cloudProxyServerMode=k,gc.info("[".concat(this._clientId,"] set cloud proxy server mode to"),this._cloudProxyServerMode)}stopProxyServer(){if("DISCONNECTED"!==this.connectionState)throw new ED(f1.INVALID_OPERATION,"Stop proxy server after leave channel");g_.setProxyServer(),gc.setProxyServer(),this._cloudProxyServerMode="disabled",this.store.cloudProxyServerMode="disabled",gc.info("[".concat(this._clientId,"] set cloud proxy server mode to"),this._cloudProxyServerMode),this._proxyServer=void 0,this._turnServer={mode:"auto",servers:[]}}setLocalAccessPointsV2(L){if(!L.accessPoints)throw new ED(f1.INVALID_PARAMS,"accessPoints is required.");Mw(L.accessPoints.serverList,"accessPoints.serverList"),kw(L.accessPoints.domain,"accessPoints.domain");let t=(L,k)=>{Pw(L,k,0,65535,!0)},k=443;if(L.accessPoints.port&&(t(L.accessPoints.port,"accessPoints.port"),k=L.accessPoints.port),this._proxyServer||"disabled"!==this._cloudProxyServerMode)throw new ED(f1.INVALID_OPERATION,"set local access point failed, You have already set the cloud proxy");wN("CLOSE_AFB_FOR_LOCAL_AP")&&(AN("JOIN_WITH_FALLBACK_SIGNAL_PROXY",!1),AN("JOIN_WITH_FALLBACK_MEDIA_PROXY",!1));let M=/^((\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.){3}(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/,U=L.accessPoints.domain,V=L.accessPoints.serverList.map(L=>M.test(L)?"".concat(L.replace(/\./g,"-"),".").concat(U):L),F=V.map(L=>"".concat(L,":").concat(k));this._useLocalAccessPoint=!0,this._setLocalAPVersion=2,AN("WEBCS_DOMAIN",F),AN("WEBCS_DOMAIN_BACKUP_LIST",F),AN("GATEWAY_DOMAINS",[U]),L.report&&L.report.hostname&&Array.isArray(L.report.hostname)&&L.report.hostname.length?(Mw(L.report.hostname,"report.hostname"),AN("EVENT_REPORT_DOMAIN",L.report.hostname[0]),AN("EVENT_REPORT_BACKUP_DOMAIN",L.report.hostname[1]||L.report.hostname[0])):(AN("EVENT_REPORT_DOMAIN",V[0]),AN("EVENT_REPORT_BACKUP_DOMAIN",V[1]||V[0]));let B=6443;L.report&&L.report.port&&(t(L.report.port,"report.port"),B=L.report.port),AN("STATS_COLLECTOR_PORT",B),L.report?AN("ENABLE_EVENT_REPORT",!0):AN("ENABLE_EVENT_REPORT",!1);let j="";L.log&&L.log.hostname&&Array.isArray(L.log.hostname)&&L.log.hostname.length?(Mw(L.log.hostname,"log.hostname"),j=L.log.hostname[0]):j=V[0];let G=6444;L.log&&L.log.port&&(t(L.log.port,"log.port"),G=L.log.port),AN("LOG_UPLOAD_SERVER","".concat(j,":").concat(G));let X=[];L.cds&&L.cds.hostname&&Array.isArray(L.cds.hostname)&&L.cds.hostname.length?(Mw(L.cds.hostname,"cds.hostname"),X=L.cds.hostname):X=V;let $=443;L.cds&&L.cds.port&&(t(L.cds.port,"cds.port"),$=L.cds.port),AN("CDS_AP",X.map(L=>"".concat(L,":").concat($))),L.cds?AN("ENABLE_CONFIG_DISTRIBUTE",!0):AN("ENABLE_CONFIG_DISTRIBUTE",!1),gc.info("set local access point v2 success")}setLocalAccessPoints(L,k){if(Mw(L,"serverList"),kw(k,"domain"),this._proxyServer||"disabled"!==this._cloudProxyServerMode)throw new ED(f1.INVALID_OPERATION,"set local access point failed, You have already set the cloud proxy");let M=/^(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/;L=L.map(L=>M.test(L)?"".concat(L.replace(/\./g,"-"),".").concat(k):L),this._useLocalAccessPoint=!0,this._setLocalAPVersion=1,AN("WEBCS_DOMAIN",L),AN("WEBCS_DOMAIN_BACKUP_LIST",L),AN("GATEWAY_DOMAINS",[k]),AN("EVENT_REPORT_DOMAIN",L[0]),AN("EVENT_REPORT_BACKUP_DOMAIN",L[1]||L[0]),AN("LOG_UPLOAD_SERVER","".concat(L[0],":6444")),gc.info("[".concat(this._clientId,"] set local access point success"))}async setRemoteDefaultVideoStreamType(L){if(Dw(L,"streamType",[0,1,4,5,6,7,8,9]),this._remoteDefaultVideoStreamType=L,this._joinInfo)try{await this._gateway.setDefaultRemoteVideoStreamType(L),this._joinInfo.defaultVideoStream=this._remoteDefaultVideoStreamType}catch(L){throw gc.error("[".concat(this._clientId,"] set default remote video stream type error"),L.toString()),L}else gc.debug("[".concat(this._clientId,"] haven't joined yet, cache remoteDefaultVideoStreamType ").concat(L))}async setRemoteVideoStreamType(L,k){Dw(k,"streamType",[0,1,4,5,6,7,8,9]);try{await this._gateway.setRemoteVideoStreamType(L,k),setTimeout(()=>{let k=this._users.find(k=>k.uid===L);k&&k.videoTrack&&k.videoTrack.updateMediaStreamTrackResolution()},2e3)}catch(L){throw gc.error("[".concat(this._clientId,"] set remote video stream type error"),L.toString()),L}gc.info("[".concat(this._clientId,"] set remote ").concat(L," video stream type to ").concat(k)),this._remoteStreamTypeCacheMap.set(L,k)}async setStreamFallbackOption(L,k){Dw(k,"fallbackType",[0,1,2,3,4,5,6,7,8]);try{await this._gateway.setStreamFallbackOption(L,k)}catch(L){throw gc.error("[".concat(this._clientId,"] set stream fallback option"),L.toString()),L}gc.info("[".concat(this._clientId,"] set remote ").concat(L," stream fallback type to ").concat(k)),this._streamFallbackTypeCacheMap.set(L,k)}setEncryptionConfig(L,k,M,U){Dw(L,"encryptionMode",["aes-128-xts","aes-256-xts","aes-128-ecb","sm4-128-ecb","aes-128-gcm","aes-256-gcm","aes-128-gcm2","aes-256-gcm2","none"]),kw(k,"secret");let V=["aes-128-gcm2","aes-256-gcm2"];if(so(V).call(V,L)){if(!M||!(M instanceof Uint8Array&&32===M.length))throw new ED(f1.INVALID_PARAMS,"salt must be an Uint8Array and exactly equal to 32 bytes")}else if(M)throw new ED(f1.INVALID_PARAMS,"current encrypt mode does not need salt");if(U){if(Nw(U,"encryptDataStream"),!so(V).call(V,L))throw new ED(f1.INVALID_PARAMS,"current encrypt mode does not support data stream");this._encryptDataStream=!0}RegExp("^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.*[!@#$%^&*,.<>?/:;'\"|{}\\[\\]])(?=.{8,})").test(k)||gc.warning("The secret is not strong:\n      The secret must contain at least 1 lowercase alphabetical character,\n      The secret must contain at least 1 uppercase alphabetical character,\n      The secret must contain at least 1 numeric character,\n      The secret must contain at least one special character,\n      The secret must be eight characters or longer.\n      "),this._encryptionMode=L,this._encryptionSecret=k,M&&(this._encryptionSalt=SO(M))}async renewToken(L){if(kw(L,"token",1,2047),!this._key||!this._joinInfo)throw new ED(f1.INVALID_OPERATION,"renewToken should not be called before user join");let k=this._key;this._key=L,this._joinInfo&&(this._joinInfo.token=L);let M=await this._renewTokenMutex.lock();try{if(wN("USE_NEW_TOKEN")){gc.debug("[".concat(this._clientId,"] start renew token with ticket from unilbs"));let k=await BF(this._joinInfo,this._axiosCancelSource.token,this._config.httpRetryConfig||Sm);gc.debug("[".concat(this._clientId,"] get ticket from unilbs success")),await this._gateway.renewToken({token:L,ticket:k})}else gc.debug("[".concat(this._clientId,"] start renew token without ticket")),await this._gateway.renewToken({token:L});gc.debug("[".concat(this._clientId,"] renewToken success"))}catch(L){throw this._key=k,this._joinInfo.token=k,gc.error("[".concat(this._clientId,"] renewToken failed"),L.toString()),L}finally{M()}}enableAudioVolumeIndicator(){this._audioVolumeIndicationInterval?gc.warning("you have already enabled audio volume indicator!"):this._audioVolumeIndicationInterval=window.setInterval(()=>{let L=this._p2pChannel.getAudioLevels();this.safeEmit(Si.VOLUME_INDICATOR,L)},wN("AUDIO_VOLUME_INDICATION_INTERVAL")||2e3)}getRTCStats(){let L=this._statsCollector.getRTCStats(),k=this._gateway.getInChannelInfo();return L.Duration=Math.round(k.duration/1e3),L}async startLiveStreaming(L,k){if(!k){if("h264"!==this.codec)throw new ED(f1.LIVE_STREAMING_INVALID_RAW_STREAM,"raw streaming is only support h264");if(!this._p2pChannel.hasLocalMedia())throw new ED(f1.LIVE_STREAMING_INVALID_RAW_STREAM,"can not find stream to raw streaming")}if(this._liveRawStreamingClient&&this._liveRawStreamingClient.hasUrl(L)||this._liveTranscodeStreamingClient&&this._liveTranscodeStreamingClient.hasUrl(L))throw new ED(f1.LIVE_STREAMING_TASK_CONFLICT);let M=k?Rv.TRANSCODE:Rv.RAW;return this._createLiveStreamingClient(M).startLiveStreamingTask(L,M)}setLiveTranscoding(L){return this._createLiveStreamingClient(Rv.TRANSCODE).setTranscodingConfig(L)}async stopLiveStreaming(L){let k=[this._liveRawStreamingClient,this._liveTranscodeStreamingClient].filter(k=>k&&k.hasUrl(L));if(!k.length)throw new ED(f1.INVALID_PARAMS,"can not find live streaming url to stop");await lQ.all(k.map(k=>k&&k.stopLiveStreamingTask(L)))}async startChannelMediaRelay(L){ZF(L);let k=this._createChannelMediaRelayClient();await k.startChannelMediaRelay(L)}async updateChannelMediaRelay(L){ZF(L);let k=this._createChannelMediaRelayClient();await k.updateChannelMediaRelay(L)}async stopChannelMediaRelay(){let L=this._createChannelMediaRelayClient();await L.stopChannelMediaRelay(),this._statsCollector.onStatsChanged&&(this._statsCollector.onStatsChanged=void 0)}sendAudioMetadata(L){this._p2pChannel instanceof I8&&this._p2pChannel.addAudioMetadata(L)}async sendStreamMessage(L){var k;let M=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(!this._joinInfo)throw new ED(f1.INVALID_OPERATION,"can not send data stream, not joined");if(("string"==typeof L||L instanceof Uint8Array)&&(L={payload:L}),"string"==typeof L.payload){let k=new TextEncoder;L.payload=k.encode(L.payload)}let U=!1;if(this._encryptDataStream&&this._encryptDataStreamIv&&this._encryptDataStreamKey&&window.crypto.subtle&&so(k=["aes-128-gcm2","aes-256-gcm2"]).call(k,this._encryptionMode)&&(U=!0,L.payload=await async function(L,k,M){var U;let V=sE(U=Array.from(M)).call(U,(L,k)=>L+k,0),F={serverTs:0,seq:S9++,length:M.length,checkSum:V},B=new Uint8Array(PO(V,2)),j=new ArrayBuffer(10),G=new DataView(j);G.setUint32(0,F.serverTs),G.setUint16(4,F.seq),G.setUint16(6,F.length),G.setUint16(8,F.checkSum);let X=16-M.length%16;M=TO(M,new Uint8Array(X));let $=await window.crypto.subtle.encrypt({name:"AES-GCM",iv:L,tagLength:128,additionalData:B},k,M);return TO(new Uint8Array(j),new Uint8Array($))}(this._encryptDataStreamIv,this._encryptDataStreamKey,L.payload)),new Blob([L.payload]).size>1024)throw new ED(f1.INVALID_PARAMS,U?"encrypted stream message out of range.":"stream message out of range.");return this._gateway.signal.request(Rf.DATA_STREAM,{payload:SO(L.payload),syncWithAudio:L.syncWithAudio,sendTs:Date.now()-I9},!M)}sendMetadata(L){if(!this._joinInfo)throw new ED(f1.INVALID_OPERATION,"can not send metadata, not joined");if(new Blob([L]).size>1024)throw new ED(f1.METADATA_OUT_OF_RANGE);return this._gateway.signal.request(Rf.SEND_METADATA,{session_id:this._joinInfo.sid,metadata:SO(L)})}async sendCustomReportMessage(L){if(Array.isArray(L)||(L=[L]),L.forEach(cD),!this._joinInfo)throw new ED(f1.INVALID_OPERATION,"can not send custom report, not joined");await g_.sendCustomReportMessage(this._joinInfo.sid,L)}getLocalAudioStats(){return this._statsCollector.getLocalAudioTrackStats()}getRemoteAudioStats(){return this._statsCollector.getRemoteAudioTrackStats()}getLocalVideoStats(){return this._statsCollector.getLocalVideoTrackStats()}getRemoteVideoStats(){return this._statsCollector.getRemoteVideoTrackStats()}getRemoteNetworkQuality(){let L=this._statsCollector.getRemoteNetworkQualityStats();if(wN("DELETE_NEQ_AFTER_USER_LEAVE")){let k=this._users.map(L=>L.uid+"");Object.keys(L).forEach(M=>{so(k).call(k,M)||delete L[M]})}return L}async pickSVCLayer(L,k){Dw(k.spatialLayer,"spatialLayer",[0,1,2,3]),Dw(k.temporalLayer,"temporalLayer",[0,1,2,3]);try{await this._gateway.pickSVCLayer(L,k)}catch(L){throw gc.error("[".concat(this._clientId,"] pick SVC layer failed"),L.toString()),L}}async setRTMConfig(L){let{apRTM:k=!1,rtmFlag:M}=L;if(Nw(k,"apRTM"),Pw(M,"rtmFlag",0),this._rtmConfig.apRTM=k,this._rtmConfig.rtmFlag=M,gc.debug("[".concat(this._clientId,"] setRTMconfig ").concat(JSON.stringify(L)," in ").concat(this.connectionState," state")),("CONNECTED"===this.connectionState||"RECONNECTING"===this.connectionState)&&this._joinInfo)return this._joinInfo.apRTM=k,this._joinInfo.rtmFlag=M,this._gateway.setRTM2Flag(M)}_reset(){if(gc.debug("[".concat(this._clientId,"] reset client")),function(L){let k=T$.indexOf(L);-1!==k&&T$.splice(k,1)}(this._clientId),this.store.hasStartJoinChannel=!1,this.store.isABTestSuccess=!1,this.store.autoSubscribe=!1,this._axiosCancelSource.cancel(),this._axiosCancelSource=fG.CancelToken.source(),this._streamFallbackTypeCacheMap=new Map,this._remoteStreamTypeCacheMap=new Map,this._configDistribute.stopGetConfigDistribute(),this._joinInfo&&Nj(this._joinInfo),this._joinInfo=void 0,this._proxyServer=void 0,this._defaultStreamFallbackType=void 0,this._sessionId&&g_.removeSid(this._sessionId),this._sessionId=null,this.store.sessionId=null,this.store.resetFirstVideoFrameDecoded(),this._statsCollector.reset(),this._key=void 0,this._appId=void 0,this._uid=void 0,this.store.uid=void 0,this._channelName=void 0,this._encryptionMode="none",this._encryptionSecret=null,this._encryptionSalt=null,this._encryptDataStreamKey=null,this._encryptDataStreamIv=null,this._pendingPublishedUsers=[],this._users.forEach(L=>{L._audioTrack&&L._audioTrack._destroy(),L._videoTrack&&L._videoTrack._destroy(),L._dataChannels&&(L._dataChannels.forEach(L=>L._close()),L._dataChannels.length=0)}),this._users=[],this._audioVolumeIndicationInterval&&(window.clearInterval(this._audioVolumeIndicationInterval),this._audioVolumeIndicationInterval=void 0),"fallback"===this._cloudProxyServerMode&&(this._cloudProxyServerMode="disabled",this.store.cloudProxyServerMode="disabled"),this._p2pChannel.reset(),this._publishMutex=new S_("client-publish",this._clientId),this._subscribeMutex=new S_("client-subscribe",this._clientId),this._networkQualityInterval&&(window.clearInterval(this._networkQualityInterval),this._networkQualityInterval=void 0),this._liveRawStreamingClient&&(this._liveRawStreamingClient.terminate(),this._liveRawStreamingClient.removeAllListeners(),this._liveRawStreamingClient=void 0),this._liveTranscodeStreamingClient&&(this._liveTranscodeStreamingClient.terminate(),this._liveTranscodeStreamingClient.removeAllListeners(),this._liveTranscodeStreamingClient=void 0),this._channelMediaRelayClient&&(this._channelMediaRelayClient.dispose(),this._channelMediaRelayClient=void 0),this._inspect)try{this._inspect.close(),this._inspect=void 0}catch(L){}if(this._moderation)try{this.setImageModeration(!1)}catch(L){}}_startSession(L,k){var M;let U=L||bO();L?gc.debug("[".concat(this._clientId,"] new Session ").concat(U)):gc.debug("[".concat(this._clientId,"] renewSession ").concat(this._sessionId," => ").concat(U));let V=L?"":this._sessionId||"";this._sessionId=U,this.store.sessionId=U,g_.addSid(U);let F={lts:(new Date).getTime(),mode:this.mode,buildFormat:1,stringUid:(null==k?void 0:k.stringUid)||(null===(M=this._joinInfo)||void 0===M?void 0:M.stringUid),channelProfile:"live"===this.mode?1:0,channelMode:0,isABTestSuccess:Number(this._configDistribute.isSuccess),lsid:V,clientRole:"audience"===this.role?2:1};g_.sessionInit(this._sessionId,oW({cname:k.channel,appid:k.appId},F)),this._joinInfo&&(this._joinInfo.sid=U),this._gateway.joinInfo&&(this._gateway.joinInfo.sid=U)}async _publishHighStream(L){if(!this._joinInfo||void 0===this._uid)throw new ED(f1.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new ED(f1.INVALID_OPERATION,"can not publish stream in ".concat(this.connectionState," state"));if("auto"===this._turnServer.mode&&wN("FORCE_TURN")&&!wN("TURN_ENABLE_TCP")&&!wN("TURN_ENABLE_UDP"))throw new ED(f1.UNEXPECTED_ERROR,"force TURN With No TURN Configuration");gc.debug("[".concat(this._clientId,"] publish high stream"));try{let M=await this._p2pChannel.publish(L,this._isDualStreamEnabled,this._lowStreamParameter);if(this.store.useP2P){let L=(await M.next()).value;if(L){try{await this._gateway.sendExtensionMessage(Io.PUBLISH,L,!0)}catch(L){throw M.throw(L),L}await M.next()}this._p2pChannel.reportPublishEvent(!0,null)}else{let U=(await M.next()).value;if(U){var k;let L;try{L=await this._gateway.publish(this._uid,U,!0)}catch(L){if(L.code!==f1.DISCONNECT_P2P)throw M.throw(L),L}await M.next((null===(k=L)||void 0===k?void 0:k.ortc)||[])}for(let k of(this._p2pChannel.reportPublishEvent(!0,null),L))k instanceof Tp&&k._encoderConfig&&this._gateway.setVideoProfile(k._encoderConfig).catch(L=>{gc.debug("[".concat(this._clientId,"] stop setVideoProfile, because websocket is closed"))}),!k.muted&&k.enabled||await this._p2pChannel.muteLocalTrack(k)}}catch(k){if(this._p2pChannel.reportPublishEvent(!1,null==k?void 0:k.code,L),(null==k?void 0:k.code)===f1.WS_ABORT)return;throw k}}async _publishLowStream(){if(!this._joinInfo||void 0===this._uid)throw new ED(f1.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new ED(f1.INVALID_OPERATION,"can not publish stream in ".concat(this.connectionState," state"));gc.debug("[".concat(this._clientId,"] publish low stream"));let L=this._configDistribute.getLowStreamConfigDistribute();L&&L.bitrate&&(this._lowStreamParameter||(this._lowStreamParameter={width:160,height:120,framerate:15,bitrate:50}),this._lowStreamParameter&&this._lowStreamParameter.bitrate&&L.bitrate<this._lowStreamParameter.bitrate&&(this._lowStreamParameter.bitrate=L.bitrate));try{let L=await this._p2pChannel.publishLowStream(this._lowStreamParameter),M=(await L.next()).value;if(M){var k;let U;try{U=await this._gateway.publish(this._uid,M,!0)}catch(k){if(k.code!==f1.DISCONNECT_P2P)throw L.throw(k),k}L.next((null===(k=U)||void 0===k?void 0:k.ortc)||[]),this._p2pChannel.reportPublishEvent(!0,null,void 0,!0)}}catch(L){if(this._p2pChannel.reportPublishEvent(!1,null==L?void 0:L.code,void 0,!0),(null==L?void 0:L.code)===f1.WS_ABORT)return;throw L}}_createLiveStreamingClient(L){let t=()=>{var L;if(!this._joinInfo||!this._appId)return new ED(f1.INVALID_OPERATION,"can not create live streaming client, please join channel first").throw();let k=(L={joinInfo:this._joinInfo,appId:this._appId,websocketRetryConfig:this._config.websocketRetryConfig,httpRetryConfig:this._config.httpRetryConfig},Jx("LiveStreaming").create(L));return k.onLiveStreamError=(L,k)=>{g_.reportApiInvoke(this._sessionId,{name:f8.ON_LIVE_STREAM_ERROR,options:[L,k],tag:f9.TRACER}).onSuccess(),this.safeEmit(Si.LIVE_STREAMING_ERROR,L,k)},k.onLiveStreamWarning=(L,k)=>{g_.reportApiInvoke(this._sessionId,{name:f8.ON_LIVE_STREAM_WARNING,options:[L,k],tag:f9.TRACER}).onSuccess(),this.safeEmit(Si.LIVE_STREAMING_WARNING,L,k)},k.on(RN.REQUEST_WORKER_MANAGER_LIST,(L,k,M)=>{if(!this._joinInfo)return M(new ED(f1.INVALID_OPERATION,"can not find join info to get worker manager"));(async function(L,k,M,U){let V=wN("UAP_AP").slice(0,wN("AJAX_REQUEST_CONCURRENT")).map(L=>k.proxyServer?"https://".concat(k.proxyServer,"/ap/?url=").concat(L+"/api/v1?action=uap"):"https://".concat(L,"/api/v1?action=uap"));return await SF(V,L,k,M,U)})(L,this._joinInfo,this._axiosCancelSource.token,Sm).then(k).catch(M)}),k};return L===Rv.RAW?(this._liveRawStreamingClient=this._liveRawStreamingClient||t(),this._liveRawStreamingClient):(this._liveTranscodeStreamingClient=this._liveTranscodeStreamingClient||t(),this._liveTranscodeStreamingClient)}_createChannelMediaRelayClient(){var L;if(!this._joinInfo)return new ED(f1.INVALID_OPERATION,"can not create channel media relay client, please join channel first").throw();if(!this._channelMediaRelayClient){let{sendResolutionWidth:k,sendResolutionHeight:M}=this.getLocalVideoStats(),U=(L={joinInfo:this._joinInfo,clientId:this._clientId,websocketRetryConfig:this._config.websocketRetryConfig,httpRetryConfig:this._config.httpRetryConfig,resolution:{width:k,height:M}},Jx("ChannelMediaRelay").create(L));U.on("state",L=>{L===RV.RELAY_STATE_FAILURE&&U&&U.dispose(),this.safeEmit(Si.CHANNEL_MEDIA_RELAY_STATE,L)}),U.on("event",L=>{this.safeEmit(Si.CHANNEL_MEDIA_RELAY_EVENT,L)}),this._channelMediaRelayClient=U,this._statsCollector.onStatsChanged=(L,k)=>{var M;"resolution"===L&&(null===(M=this._channelMediaRelayClient)||void 0===M||M.setVideoProfile(k))}}return this._channelMediaRelayClient}_handleUpdateDataChannel(L,k){let{added:M,deleted:U}=L,V=[];if(k){let L=[];this._users.forEach(k=>{k._dataChannels.forEach(U=>{M.every(L=>L.uid!==k._uintid||L.stream_id!==U.id)&&L.push({uid:k._uintid,stream_id:U.id,ordered:U.ordered,max_retrans_times:U.maxRetransmits,metadata:U.metadata})})}),L.length>0&&this._handleUpdateDataChannel({added:[],deleted:L})}Array.isArray(M)&&M.length>0&&M.forEach(L=>{let{uid:M,stream_id:U,ordered:F,max_retrans_times:B,metadata:j}=L,G=this._users.find(L=>L._uintid===M);if(!G)return void gc.error("[".concat(this._clientId,"] can not find target user!(on_add_data_channel)"));if(gc.debug("[".concat(this._clientId,"] data_channel added with uid ").concat(M)),so(V).call(V,G)||V.push(G),G._uintid||(G._uintid=M),!(-1!==G._dataChannels.findIndex(k=>k.id===L.stream_id))){let L={id:U,ordered:!!F,maxRetransmits:B,metadata:j},M=Zx(L,!0);G._dataChannels.push(M),gc.info("[".concat(this._clientId,"] remote user ").concat(G.uid," published datachannel")),k||this.safeEmit(Si.USER_PUBLISHED,G,"datachannel",L)}this._p2pChannel.hasPendingRemoteDataChannel(G,L.stream_id)&&(gc.debug("[".concat(this._clientId,"] resubscribe datachannel for user ").concat(G.uid," after reconnect.")),this._subscribeDataChannel(G,L.stream_id).catch(L=>{gc.error("[".concat(this._clientId,"] resubscribe datachannel error"),L.toString())}))}),k&&(this.safeEmit(Si.PUBLISHED_USER_LIST,this._pendingPublishedUsers),this._pendingPublishedUsers=[]),Array.isArray(U)&&U.length>0&&U.forEach(L=>{let{uid:k,stream_id:M}=L,U=this._users.find(L=>L._uintid===k);if(!U)return void gc.error("[".concat(this._clientId,"] can not find target user!(on_delete_data_channel)"));let V=U._dataChannels.find(k=>k.id===L.stream_id);V&&(gc.debug("[".concat(this._clientId,"] data_stream delete with uid ").concat(k)),this._p2pChannel.unsubscribeDataChannel(U,[V]).then(L=>{if(U._dataChannels=U._dataChannels.filter(L=>L!==V),L)return this._gateway.unsubscribeDataChannel(L,U.uid)}),gc.info("[".concat(this._clientId,"] remote user ").concat(k," unpublished datachannel ,id:").concat(V.id)),this.safeEmit(Si.USER_UNPUBLISHED,U,"datachannel",V._config))})}_getEncodingName(L){var k,M;if(!this._joinResponse)return;let U=null===(k=this._joinResponse.ortc.rtpCapabilities.sendrecv)||void 0===k?void 0:k.videoCodecs;if(U){for(let k of U)if(k.payloadType===L)return null==k||null===(M=k.rtpMap)||void 0===M?void 0:M.encodingName}}_handleRemoveDataChannels(L){let k=this._users.find(k=>k.uid===L.uid);k?void 0!==k._dataChannels&&k._dataChannels.length>0&&(gc.debug("[".concat(this._clientId,"] datachannel removed with uid ").concat(L.uid)),this._p2pChannel.unsubscribeDataChannel(k,k._dataChannels).then(L=>{if(L)return this._gateway.unsubscribeDataChannel(L,k.uid)}),(()=>{gc.info("[".concat(this._clientId,"] remote user ").concat(k.uid," unpublished datachannel")),k._dataChannels.forEach(L=>{this.safeEmit(Si.USER_UNPUBLISHED,k,"datachannel",L._config)})})()):gc.warning("[".concat(this._clientId,"] can not find target user!(on_remove_datachannel)"))}_handleGatewayEvents(){this._gateway.on(RH.UPDATE_GATEWAY_CONFIG,()=>{!function(){let L;try{L=window.localStorage.getItem("websdk_ng_global_parameter")}catch(L){return void gc.error("Error loading sdk config",L.message)}if(L)try{let k=JSON.parse(window.atob(L)),M=Date.now();Object.keys(k).forEach(L=>{let{value:U,type:V,expires:F}=k[L];F&&F<=M||V||YM()||!Object.prototype.hasOwnProperty.call(S$,L)||(S4[L]=U,S3[L]=U,gc.debug("Update gateway parameters from config distribute",L,U))})}catch(L){gc.error("Error update config from local cache",L.message)}}()}),this._gateway.on(RH.DISCONNECT_P2P,async()=>{await this._p2pChannel.disconnectForReconnect()}),this._gateway.on(RH.CONNECTION_STATE_CHANGE,(L,k,M)=>{var U,V;if(M===Se.FALLBACK)return;let r=()=>{this.safeEmit(Si.CONNECTION_STATE_CHANGE,L,k,M)};if(g_.reportApiInvoke(this._sessionId||(null===(U=this._gateway.joinInfo)||void 0===U?void 0:U.sid)||null,{name:f8.CONNECTION_STATE_CHANGE,options:[L,k,M],tag:f9.TRACER}).onSuccess(JSON.stringify({cur:L,prev:k,reason:M})),gc.info("[".concat(this._clientId,"] signal connection state change: ").concat(k," -> ").concat(L)),"DISCONNECTED"===L)return this._reset(),void r();"RECONNECTING"===L?(this._users.forEach(L=>{L._trust_in_room_=!1,L._trust_audio_enabled_state_=!1,L._trust_video_enabled_state_=!1,L._trust_audio_mute_state_=!1,L._trust_video_mute_state_=!1,L._trust_audio_stream_added_state_=!1,L._trust_video_stream_added_state_=!1,L._is_pre_created||(L._audio_pre_subscribed||(L._audioSSRC=void 0,L._audioOrtc=void 0),L._video_pre_subscribed||(L._videoSSRC=void 0,L._videoOrtc=void 0,L._rtxSsrcId=void 0),L._cname=void 0)}),this._userOfflineTimeout&&window.clearTimeout(this._userOfflineTimeout),this._streamRemovedTimeout&&window.clearTimeout(this._streamRemovedTimeout),this._userOfflineTimeout=void 0,this._streamRemovedTimeout=void 0):"CONNECTED"===L&&(this._streamFallbackTypeCacheMap.forEach((L,k)=>{this._gateway.setStreamFallbackOption(k,L).catch(L=>{gc.warning("[".concat(this._clientId,"] auto set stream fallback option failed"),L)})}),this._remoteStreamTypeCacheMap.forEach((L,k)=>{this._gateway.setRemoteVideoStreamType(k,L).catch(L=>{gc.warning("[".concat(this._clientId,"] auto set remote stream type failed"),L)})}),void 0!==this._remoteDefaultVideoStreamType&&void 0===(null===(V=this._joinInfo)||void 0===V?void 0:V.defaultVideoStream)&&this.setRemoteDefaultVideoStreamType(this._remoteDefaultVideoStreamType).then(()=>{gc.debug("[".concat(this._clientId,"] setRemoteDefaultVideoStreamType after gateway connected"))}).catch(L=>{gc.error("[".concat(this._clientId,"] setRemoteDefaultVideoStreamType after gateway failed, ").concat(L))}),this.store.useP2P||(this._p2pChannel.republish(),this._userOfflineTimeout=window.setTimeout(()=>{"CONNECTED"===this.connectionState&&(this._userOfflineTimeout=void 0,this._users.filter(L=>!L._trust_in_room_).forEach(L=>{gc.debug("[".concat(this._clientId,"] user offline timeout, emit user offline ").concat(L.uid)),this._handleUserOffline({uid:L.uid})}))},3e3),this._streamRemovedTimeout=window.setTimeout(()=>{"CONNECTED"===this.connectionState&&(this._streamRemovedTimeout=void 0,this._users.forEach(L=>{L._trust_audio_mute_state_||(gc.debug("[".concat(this._clientId,"] auto dispatch audio unmute event ").concat(L.uid)),this._handleMuteStream(L.uid,R1.AUDIO,!1)),L._trust_video_mute_state_||(gc.debug("[".concat(this._clientId,"] auto dispatch video unmute event ").concat(L.uid)),this._handleMuteStream(L.uid,R1.VIDEO,!1)),L._trust_audio_enabled_state_||(gc.debug("[".concat(this._clientId,"] auto dispatch enable local audio ").concat(L.uid)),this._handleSetStreamLocalEnable("audio",L.uid,!0)),L._trust_video_enabled_state_||(gc.debug("[".concat(this._clientId,"] auto dispatch enable local video ").concat(L.uid)),this._handleSetStreamLocalEnable("video",L.uid,!0)),L._trust_video_stream_added_state_||(gc.debug("[".concat(this._clientId,"] auto dispatch reset video stream added ").concat(L.uid)),this._handleResetAddStream(L,"video")),L._trust_audio_stream_added_state_||(gc.debug("[".concat(this._clientId,"] auto dispatch reset audio stream added ").concat(L.uid)),this._handleResetAddStream(L,"audio")),L._video_added_||L._audio_added_||(gc.debug("[".concat(this._clientId,"] auto dispatch stream remove ").concat(L.uid)),this._handleRemoveStream({uid:L.uid,uint_id:L._uintid}))}))},1e3))),r()}),this._gateway.on(RH.REQUEST_NEW_GATEWAY_LIST,async(L,k)=>{if(!this._joinInfo)return k(new ED(f1.UNEXPECTED_ERROR,"can not recover, no join info"));try{let k;let M=await Aj(oW(oW({},this._joinInfo),{},{uid:this._joinInfo.uid,stringUid:void 0}));M?(k=M.ap,Dj(M),this._joinInfo.preload=!0):(k=await PF(this._joinInfo,this._axiosCancelSource.token,this._config.httpRetryConfig||Sm,this.store),this._joinInfo.preload=!1),this._joinInfo&&(this._joinInfo.apResponse=k.gatewayInfo.res,this._joinInfo.gatewayAddrs=k.gatewayInfo.gatewayAddrs,this._joinInfo.uni_lbs_ip=k.gatewayInfo.uni_lbs_ip);let U=[];k.gatewayInfo.gatewayAddrs.forEach(L=>{let{address:k}=L,[M,V]=k.split(":");this._joinInfo&&this._joinInfo.proxyServer?U.push({proxy:this._joinInfo.proxyServer,host:M,port:V}):U.push({host:M,port:V})}),L(U)}catch(L){k(L)}}),this._gateway.on(RH.NETWORK_QUALITY,L=>{"normal"===this._networkQualitySensitivity&&this.safeEmit(Si.NETWORK_QUALITY,L)}),this._gateway.on(RH.STREAM_TYPE_CHANGE,(L,k)=>{this.safeEmit(Si.STREAM_TYPE_CHANGED,L,k),g_.reportApiInvoke(this._sessionId,{name:f8.STREAM_TYPE_CHANGE,options:[L,k],tag:f9.TRACER}).onSuccess(JSON.stringify({uid:L,streamType:k}))}),this._gateway.isPreSub=()=>"isPreSub"in this._p2pChannel&&this._p2pChannel.isPreSub(),this._gateway.isPreallocation=()=>"isPreallocation"in this._p2pChannel&&this._p2pChannel.isPreallocation(),this._gateway.on(RH.IS_P2P_DISCONNECTED,L=>{L(!!this._p2pChannel.isP2PDisconnected()||!(this._p2pChannel.hasLocalMedia()||this._p2pChannel.hasRemoteMedia()))}),this._gateway.on(RH.REQUEST_P2P_CONNECTION_PARAMS,async(L,k,M)=>{try{let M=await this._p2pChannel.getEstablishParams();M&&"isPreallocation"in this._p2pChannel&&this._p2pChannel.isPreallocation()||(M=await this._p2pChannel.startP2PConnection(L)),k(M)}catch(L){M(L)}}),this._gateway.on(RH.JOIN_RESPONSE,(L,k)=>{let M;if(this.store.useP2P)return;this._joinResponse=L,L.attributes?M=L.attributes.userAttributes.preSubSsrcs:gc.debug("no attributes in joinResponse");let U=yx(L.ortc,k,M);this._p2pChannel.connect(U)}),this._gateway.on(RH.PRE_CONNECT_PC,async L=>{let{candidates:k,fingerprint:M,turnServer:U}=L;if(this._joinInfo&&k.length>0&&!this._p2pChannel.isPlanB){let{cert:L,cid:F}=this._joinInfo.apResponse,B="".concat(F,"_").concat(L);if(B.length<4||B.length>256)return;await this._p2pChannel.startP2PConnection({turnServer:U,cloudProxyServer:this._joinInfo.cloudProxyServer,isPreallocation:!0});try{var V;await this._p2pChannel.connect({iceParameters:{iceUfrag:"".concat(F,"_").concat(L),icePwd:"".concat(F,"_").concat(L)},dtlsParameters:{fingerprints:[{hashFunction:"sha-256",fingerprint:null!==(V=wN("FINGERPRINT"))&&void 0!==V?V:M}]},candidates:k,rtpCapabilities:{send:{audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},recv:{audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]}},setup:"active",cname:"o/i14u9pJrxRKAsu",preallocation:!0})}catch(L){L.code&&L.code===f1.EXCHANGE_SDP_FAILED&&await this._p2pChannel.startP2PConnection({turnServer:U,cloudProxyServer:this._joinInfo.cloudProxyServer},!0)}}})}_handleGatewaySignalEvents(){this._gateway.signal.on(RT.ON_USER_ONLINE,this._handleUserOnline),this._gateway.signal.on(RT.ON_USER_OFFLINE,this._handleUserOffline),this._gateway.signal.on(RT.ON_ADD_AUDIO_STREAM,L=>this._handleAddAudioOrVideoStream("audio",L.uid,L.ssrcId,L.cname,L.pt,L.uint_id,L.ortc)),this._gateway.signal.on(RT.ON_ADD_VIDEO_STREAM,L=>this._handleAddAudioOrVideoStream("video",L.uid,L.ssrcId,L.cname,L.pt,L.uint_id,L.ortc,L.rtxSsrcId)),this._gateway.signal.on(RT.ON_REMOTE_DATASTREAM_UPDATE,L=>{this._handleUpdateDataChannel(L)}),this._gateway.signal.on(RT.ON_REMOTE_FULL_DATASTREAM_INFO,L=>{this._handleUpdateDataChannel({added:L.datastreams||[],deleted:[]},!0)}),this._gateway.signal.on(RT.ON_REMOVE_STREAM,this._handleRemoveStream),this._gateway.signal.on(RT.ON_P2P_LOST,this._handleP2PLost),this._gateway.signal.on(RT.MUTE_AUDIO,L=>this._handleMuteStream(L.uid,R1.AUDIO,!0)),this._gateway.signal.on(RT.UNMUTE_AUDIO,L=>this._handleMuteStream(L.uid,R1.AUDIO,!1)),this._gateway.signal.on(RT.MUTE_VIDEO,L=>this._handleMuteStream(L.uid,R1.VIDEO,!0)),this._gateway.signal.on(RT.UNMUTE_VIDEO,L=>this._handleMuteStream(L.uid,R1.VIDEO,!1)),this._gateway.signal.on(RT.RECEIVE_METADATA,L=>{let k=fO(L.metadata);this.safeEmit(Si.RECEIVE_METADATA,L.uid,k)}),this._gateway.signal.on(RT.ON_DATA_STREAM,async L=>{var k;if(!L)return;let M=fO(L.payload);if(this._encryptDataStream&&this._encryptDataStreamIv&&this._encryptDataStreamKey&&window.crypto.subtle&&so(k=["aes-128-gcm2","aes-256-gcm2"]).call(k,this._encryptionMode)){if(L.payload.length<10)throw new ED(f1.UNEXPECTED_RESPONSE,"payload length ".concat(L.payload.length," is less than header length ").concat(10));let k=await async function(L,k,M){let U=M.subarray(0,10),V=U.slice(8,10),F=(V[0]<<8)+V[1],B=(U[6]<<8)+U[7],j=await window.crypto.subtle.decrypt({name:"AES-GCM",iv:L,tagLength:128,additionalData:new Uint8Array(PO(F,2))},k,M.subarray(10));return new Uint8Array(j).subarray(0,B)}(this._encryptDataStreamIv,this._encryptDataStreamKey,M);M=k}let U=0;if(L.ordered||L.syncWithAudio){let k=this._p2pChannel.getStats(),M=this.remoteUsers.find(k=>k.uid===L.uid),V=null==k?void 0:k.audioRecv.find(L=>L.ssrc===(null==M?void 0:M._audioSSRC));U=null==V?void 0:V.jitterBufferMs}(null==U||Number.isNaN(U))&&(U=0),uj(oW(oW({},L),{},{payload:M}),U,{id:this._clientId,onStreamMessage:"function"==typeof this.onStreamMessage?this.onStreamMessage.bind(this):void 0,safeEmit:this.safeEmit.bind(this)})}),this._gateway.signal.on(RT.ON_CRYPT_ERROR,()=>{mO(()=>{gc.warning("[".concat(this._clientId,"] on crypt error")),this.safeEmit(Si.CRYPT_ERROR)},this._sessionId)}),this._gateway.signal.on(RT.ON_TOKEN_PRIVILEGE_WILL_EXPIRE,this._handleTokenWillExpire),this._gateway.signal.on(RT.ON_TOKEN_PRIVILEGE_DID_EXPIRE,()=>{gc.warning("[".concat(this._clientId,"] received message onTokenPrivilegeDidExpire, please get new token and join again")),this._gateway.leave(!0,Se.TOKEN_EXPIRE),this.safeEmit(Si.ON_TOKEN_PRIVILEGE_DID_EXPIRE),this._reset()}),this._gateway.signal.on(RT.ON_STREAM_FALLBACK_UPDATE,L=>{gc.debug("[".concat(this._clientId,"] stream fallback peerId: ").concat(L.stream_id,", attr: ").concat(L.stream_type)),this.safeEmit(Si.STREAM_FALLBACK,L.stream_id,1===L.stream_type?"fallback":"recover")}),this._gateway.signal.on(RT.ON_PUBLISH_STREAM,L=>{this.uid===this._uid&&(this._p2pChannel.reportPublishEvent(!0,null,void 0,!1,JSON.stringify({proxy:L.proxy})),gc.info("[".concat(this._clientId,"] on publish stream, ").concat(JSON.stringify(L))))}),this._gateway.signal.on(RT.ENABLE_LOCAL_VIDEO,L=>{this._handleSetStreamLocalEnable("video",L.uid,!0)}),this._gateway.signal.on(RT.DISABLE_LOCAL_VIDEO,L=>{this._handleSetStreamLocalEnable("video",L.uid,!1)}),this._gateway.signal.on(RE.REQUEST_TIMEOUT,(L,k)=>{if(this._joinInfo)switch(L){case Rf.PUBLISH:{if(!k)return;let L=k.ortc;if(L){var M,U;let V=L.some(L=>{let{stream_type:k}=L;return k===RG.Audio}),F=L.some(L=>{let{stream_type:k}=L;return k!==RG.Audio}),B=L.some(L=>{let{stream_type:k}=L;return k===RG.Screen||k===RG.ScreenLow});"offer"===k.state&&g_.publish(this._joinInfo.sid,{eventElapse:IW.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:!1,ec:f1.TIMEOUT,audio:V,video:F,p2pid:k.p2p_id,publishRequestid:this.store.pubId,screenshare:B,audioName:V?null===(M=L.find(L=>{let{stream_type:k}=L;return k===RG.Audio}))||void 0===M||null===(M=M.ssrcs[0])||void 0===M?void 0:M.ssrcId.toString():void 0,videoName:F?null===(U=L.find(L=>{let{stream_type:k}=L;return k!==RG.Audio}))||void 0===U||null===(U=U.ssrcs[0])||void 0===U?void 0:U.ssrcId.toString():void 0})}break}case Rf.SUBSCRIBE:k&&g_.subscribe(this._joinInfo.sid,{succ:!1,ec:f1.TIMEOUT,audio:k.stream_type===R1.AUDIO,video:k.stream_type===R1.VIDEO,peerid:k.stream_id,subscribeRequestid:k.ssrcId,p2pid:this.store.p2pId,eventElapse:IW.measureFromSubscribeStart(this.store.clientId,k.ssrcId),preSsrc:this._p2pChannel.isPreSubScribe(k.ssrcId)})}}),this._gateway.signal.on(RT.ON_P2P_OK,L=>{this.uid,this._uid}),this._gateway.signal.on(RT.ON_PUBLISHED_USER_LIST,L=>{if(null==L||!L.users)return;wN("BLOCK_LOCAL_CLIENT")&&(L.users=L.users.filter(L=>!KM(L.string_id||L.stream_id,this.channelName)));let k=[],M=[];for(let U of L.users){let L=this._users.find(L=>L._uintid===U.stream_id);L?L._trust_in_room_=!0:(L=new QF(U.string_id||U.stream_id,U.stream_id),this._users.push(L),this.store.firstVideoFrameDecoded(L.uid,{userJoinNotify:Date.now()}),0===this.getListeners(Si.PUBLISHED_USER_LIST).length&&(gc.debug("[".concat(this._clientId,"] user online"),U.stream_id),this.safeEmit(Si.USER_JOINED,L)));let V=RJ.Audio&U.stream_type,F=(RJ.Video|RJ.LwoVideo)&U.stream_type,B=0!=(65280&U.stream_type),j=V&&L.hasAudio,G=F&&L.hasVideo;F&&(L._trust_video_stream_added_state_=!0,L._video_added_=!0,L._videoSSRC=U.video_ssrc,L._rtxSsrcId=U.video_rtx),V&&(L._trust_audio_stream_added_state_=!0,L._audio_added_=!0,L._audioSSRC=U.audio_ssrc),V&&!j&&0===this.getListeners(Si.PUBLISHED_USER_LIST).length&&(gc.info("[".concat(this._clientId,"] remote user ").concat(L.uid," published audio")),this.safeEmit(Si.USER_PUBLISHED,L,"audio")),F&&!G&&0===this.getListeners(Si.PUBLISHED_USER_LIST).length&&(gc.info("[".concat(this._clientId,"] remote user ").concat(L.uid," published video")),this.safeEmit(Si.USER_PUBLISHED,L,"video")),(V&&!j||F&&!G||B)&&k.push(L),F&&this._p2pChannel.hasPendingRemoteMedia(L,"video")&&M.push({user:L,mediaType:"video"}),V&&this._p2pChannel.hasPendingRemoteMedia(L,"audio")&&M.push({user:L,mediaType:"audio"})}M.length>0&&(gc.debug("[".concat(this._clientId,"] RE massSubscribe after reconnect ").concat(M.map(L=>"user: ".concat(L.user.uid,", mediaType: ").concat(L.mediaType)).join("; ")," ")),this.massSubscribe(M).catch(L=>{gc.error("[".concat(this._clientId,"] mass resubscribe error"),L.toString())})),this.getListeners(Si.PUBLISHED_USER_LIST).length>0?wN("ENABLE_DATASTREAM_2")?this._pendingPublishedUsers=k:(gc.info("[".concat(this._clientId,"] client emit user-list event, users: ").concat(k.map(L=>L.uid).join(", "))),this.safeEmit(Si.PUBLISHED_USER_LIST,k)):gc.info("[".concat(this._clientId,"] client not emit user-list event case there is no user-list listener, users: ").concat(k.map(L=>L.uid).join(", ")))}),this._gateway.signal.on(RT.ON_RTP_CAPABILITY_CHANGE,L=>{let{video_codec:k}=L;this._p2pChannel instanceof I8&&this._p2pChannel.updateRemoteRTPCapabilities(k.map(L=>L.toLowerCase()).filter(L=>{var k;return so(k=Object.keys(S8)).call(k,L)}))})}_handleP2PEvents(){this._gateway.signal.on(RT.ON_USER_OFFLINE,()=>{this._p2pChannel.disconnectForReconnect()}),this._gateway.signal.on(Io.PUBLISH,(L,k,M)=>{let{uid:U}=L;L.forEach(L=>{let{kind:V,ssrcs:F,mid:B,isMuted:j}=L;this._handleP2PAddAudioOrVideoStream(V,U,F[0].ssrcId,B);let G=this._users.find(L=>L.uid===U);return G&&this.store.useP2P?this._p2pChannel.mockSubscribe(G,V,F[0].ssrcId,B).then(()=>{k()}).catch(M):k(),this._handleMuteStream(U,V,!!j)})}),this._gateway.signal.on(Io.CALL,async(L,k,M)=>{if(this.store.useP2P)try{var U;k(await this._p2pChannel.startP2P({turnServer:null===(U=this._joinInfo)||void 0===U?void 0:U.turnServer},L))}catch(L){M(L)}}),this._gateway.signal.on(RE.P2P_CONNECTION,async L=>{this.store.useP2P&&(await this._p2pChannel).p2pConnect(L)}),this._gateway.signal.on(Io.UNPUBLISH,async(L,k,M)=>{if(this.store.useP2P){let{unpubMsg:U,uid:V}=L,F=this._users.find(L=>L.uid===V);if(!F)return gc.warning("[".concat(this._clientId,"] can not find remote user, ignore mute event, uid: ").concat(V)),void k();try{U.forEach(async L=>{let{stream_type:k}=L,M=k===RG.Audio?R1.AUDIO:R1.VIDEO;await this._p2pChannel.unsubscribe(F,M),this._handleMuteStream(V,M,!0)}),k()}catch(L){M(L)}}}),this._gateway.signal.on(Io.CONTROL,async(L,k)=>{let{action:M}=L;switch(M){case Ic.MUTE_LOCAL_VIDEO:this._handleMuteStream(k,R1.VIDEO,!0);break;case Ic.MUTE_LOCAL_AUDIO:this._handleMuteStream(k,R1.AUDIO,!0);break;case Ic.UNMUTE_LOCAL_VIDEO:this._handleP2PAddAudioOrVideoStream("video",k),this._handleMuteStream(k,R1.VIDEO,!1);break;case Ic.UNMUTE_LOCAL_AUDIO:this._handleP2PAddAudioOrVideoStream("audio",k),this._handleMuteStream(k,R1.AUDIO,!1)}}),this._gateway.signal.on(Io.RESTART_ICE,async(L,k,M)=>{if(this.store.useP2P)try{let{direction:M,iceParameter:U}=L;M!==RR.SEND_ONLY||U?k(await this._p2pChannel.restartICE(M,U)):(this._p2pChannel.handleDisconnect(M),k())}catch(L){M(L)}}),this._gateway.signal.on(Io.CANDIDATE,L=>{if(this.store.useP2P){let{candidate:k,direction:M}=L;this._p2pChannel.addRemoteCandidate(k,M)}}),this._p2pChannel.on(R8.RequestP2PRestartICE,async(L,k,M)=>{try{let{direction:M}=L;k(await this._gateway.sendExtensionMessage(Io.RESTART_ICE,L,M===RR.SEND_ONLY))}catch(L){M(L)}}),this._p2pChannel.on(R8.LocalCandidate,L=>{this._gateway.sendExtensionMessage(Io.CANDIDATE,JSON.stringify(L),!0)}),this._p2pChannel.on(R8.RequestP2PMuteLocal,async(L,k,M)=>{try{await this._gateway.sendExtensionMessage(Io.CONTROL,L,!0),k()}catch(L){M(L)}}),this._p2pChannel.on(R8.RequestP2PUnmuteRemote,async(L,k,M)=>{if(this._joinInfo)try{await this._gateway.unmuteRemote(L,this._joinInfo.stringUid||this._joinInfo.uid),k()}catch(L){L.code===f1.DISCONNECT_P2P?k():M(L)}else k()}),this._p2pChannel.on(R8.RequestP2PMuteRemote,async(L,k,M)=>{if(this._joinInfo)try{await this._gateway.muteRemote(L,this._joinInfo.stringUid||this._joinInfo.uid),k()}catch(L){L.code===f1.DISCONNECT_P2P?k():M(L)}else k()}),this._p2pChannel.on(R8.StateChange,(L,k)=>{k===R6.Connected&&this._p2pChannel.republish()})}_handleP2PChannelEvents(){this._p2pChannel.on(R8.PeerConnectionStateChange,L=>{let k=this._peerConnectionState;L!==k&&(this.safeEmit(Si.PEERCONNECTION_STATE_CHANGE,L,k),this._peerConnectionState=L)}),this._p2pChannel.on(R8.RequestMuteLocal,async(L,k,M)=>{if(this._joinInfo)try{await this._gateway.muteLocal(L,this._joinInfo.stringUid||this._joinInfo.uid),k()}catch(L){L.code===f1.DISCONNECT_P2P?k():M(L)}else k()}),this._p2pChannel.on(R8.RequestUnmuteLocal,async(L,k,M)=>{if(this._joinInfo)try{await this._gateway.unmuteLocal(L,this._joinInfo.stringUid||this._joinInfo.uid),k()}catch(L){L.code===f1.DISCONNECT_P2P?k():M(L)}else k()}),this._p2pChannel.on(R8.RequestRePublish,(L,k,M)=>{this.publish(L,!1).then(k).catch(M)}),this._p2pChannel.on(R8.RequestRePublishDataChannel,(L,k,M)=>{lQ.all(L.map(async L=>{let k=await this._p2pChannel.publishDataChannel([L]);try{k.forEach(L=>{this._uid&&this._gateway.publishDataChannel(this._uid,L,!0)})}catch(L){if(L.code!==f1.DISCONNECT_P2P)throw L}})).then(k).catch(M)}),this._p2pChannel.on(R8.RequestReSubscribe,async(L,k,M)=>{try{for(let{user:k,kind:M}of L)M===R1.VIDEO?await this.subscribe(k,"video"):await this.subscribe(k,"audio");k()}catch(L){M(L)}}),this._p2pChannel.on(R8.RequestUpload,(L,k)=>{this._gateway.upload(L,k)}),this._p2pChannel.on(R8.RequestUploadStats,L=>{this._gateway.uploadWRTCStats(L)}),this._p2pChannel.on(R8.MediaReconnectStart,L=>{this.safeEmit(Si.MEDIA_RECONNECT_START,L)}),this._p2pChannel.on(R8.MediaReconnectEnd,L=>{this.safeEmit(Si.MEDIA_RECONNECT_END,L)}),this._p2pChannel.on(R8.NeedSignalRTT,L=>{L(this._gateway.getSignalRTT())}),this._p2pChannel.on(R8.RequestRestartICE,async L=>{let k;if(this.store.useP2P)return;let M=await this._p2pChannel.restartICE(L),U=await M.next();if(U.done)return;let V=U.value;try{k=await this._gateway.restartICE({iceParameters:V})}catch(L){return void M.throw(L)}let{iceParameters:F}=function(L){let k=L.iceParameters;return{iceParameters:{iceUfrag:k.iceUfrag,icePwd:k.icePwd}}}(k);await M.next({remoteIceParameters:F})}),this._p2pChannel.on(R8.RequestReconnect,async()=>{this._gateway.reconnect()}),this._p2pChannel.on(R8.RequestReconnectPC,async()=>{var L;let{iceParameters:k,dtlsParameters:M,rtpCapabilities:U}=await this._p2pChannel.startP2PConnection({turnServer:null===(L=this._joinInfo)||void 0===L?void 0:L.turnServer}),{gatewayEstablishParams:V,gatewayAddress:F}=await this._gateway.reconnectPC({iceParameters:k,dtlsParameters:M,rtpCapabilities:U}),B=yx(V,F);await this._p2pChannel.connect(B),await this._p2pChannel.republish(),await this._p2pChannel.reSubscribe()}),this._p2pChannel.on(R8.RequestUnpublishForReconnectPC,async(L,k,M)=>{this._joinInfo&&void 0!==this._uid?(await this._gateway.unpublish(L,this._uid),k()):M()}),this._p2pChannel.on(R8.P2PLost,()=>{this.safeEmit(Si.P2P_LOST,this.store.uid)}),this._p2pChannel.on(R8.UpdateVideoEncoder,L=>{L._encoderConfig&&this._gateway.setVideoProfile(L._encoderConfig)}),this._p2pChannel.on(R8.ConnectionTypeChange,L=>{this.safeEmit(Si.IS_USING_CLOUD_PROXY,L)}),this._p2pChannel.on(R8.RequestLowStreamParameter,L=>{L(this._lowStreamParameter||{width:160,height:120,framerate:15,bitrate:50})}),this._p2pChannel.on(R8.QueryClientConnectionState,L=>{L(this.connectionState)}),this._p2pChannel.on(R8.AudioMetadata,L=>{this.safeEmit(Si.AUDIO_METADATA,L)}),this._p2pChannel.on(R8.AudioPts,L=>{this.safeEmit(Si.AUDIO_PTS,Number(L))})}getKeyMetrics(){return this.store.keyMetrics}async enableContentInspect(L){if(!this._joinInfo||"CONNECTED"!==this.connectionState)throw new ED(f1.INVALID_OPERATION,"[".concat(this._clientId,"] can not create content inspect, please join channel first"));if(this._inspect)throw new ED(f1.INVALID_OPERATION,"[".concat(this._clientId,"] Inspect content service already in connecting/connected state"));try{let k=Jx("ContentInspect").create({config:L});this._inspect=k,this.handleVideoInspectEvents(k);let{appId:M,cname:U,sid:V,token:F,uid:B,cid:j,vid:G}=this._joinInfo;await k.init({appId:M,areaCode:"",cname:U,sid:V,token:F,uid:B,cid:j,vid:G?Number(G):0},Sm)}catch(L){throw Array.isArray(L)?L[0]:L}}handleVideoInspectEvents(L){L.on(Ie.CONNECTION_STATE_CHANGE,(k,M)=>{if(this.safeEmit(Si.CONTENT_INSPECT_CONNECTION_STATE_CHANGE,k,M),M===R9.CONNECTED){if("CONNECTED"!==this.connectionState)return void this.safeEmit(Si.CONTENT_INSPECT_ERROR,new ED(f1.OPERATION_ABORTED,"Content inspect was cancelled because it left the channel"));L.inspectImage()}}),L.on(Ie.INSPECT_RESULT,(L,k)=>{var M;if((null==k?void 0:k.code)===f1.INVALID_OPERATION&&"DISCONNECTED"===this.connectionState)return gc.debug("Stop inspect content because that has left channel"),null==this||null===(M=this._inspect)||void 0===M||M.close(),void(this._inspect=void 0);this.safeEmit(Si.CONTENT_INSPECT_RESULT,L,k)}),L.on(Ie.CLIENT_LOCAL_VIDEO_TRACK,L=>{L(this.localTracks.filter(L=>"video"===L.trackMediaType)[0])})}async disableContentInspect(){if(!this._inspect)throw new ED(f1.INVALID_OPERATION,"[".concat(this._clientId,"] inspectVideoContent not started"));try{this._inspect.close(),this._inspect=void 0}catch(L){throw Array.isArray(L)?L[0]:L}}async setImageModeration(L,k){if(Nw(L,"enabled"),L){if(!k)throw new ED(f1.INVALID_PARAMS,"config is required");if(_G(k),!this._joinInfo)throw new ED(f1.INVALID_OPERATION,"can not create image moderation, please join channel first");try{if(this._moderation)this._moderation.updateConfig(k);else{let L=Jx("ImageModeration").create({config:k});this._moderation=L,this.handleImageModerationEvents(L);let{appId:M,cname:U,sid:V,token:F,uid:B,cid:j,vid:G}=this._joinInfo;await L.init({appId:M,areaCode:"",cname:U,sid:V,token:F,uid:B,cid:j,vid:G?Number(G):0},Sm)}}catch(L){throw Array.isArray(L)?L[0]:L}}else{if(!this._moderation)throw new ED(f1.INVALID_OPERATION,"[".concat(this._clientId,"] image moderation not started"));try{this._moderation.close(),this._moderation.removeAllListeners(),this._moderation=void 0}catch(L){throw Array.isArray(L)?L[0]:L}}}handleImageModerationEvents(L){L.on(In.CONNECTION_STATE_CHANGE,(k,M)=>{if(this.safeEmit(Si.IMAGE_MODERATION_CONNECTION_STATE_CHANGE,k,M),k===Ir.CONNECTED){if("CONNECTED"!==this.connectionState)throw this.setImageModeration(!1),new ED(f1.OPERATION_ABORTED,"Image moderation was cancelled because it left the channel");L.inspectImage()}}),L.on(In.CLIENT_LOCAL_VIDEO_TRACK,L=>{L(this.localTracks.filter(L=>"video"===L.trackMediaType)[0])})}setP2PTransport(L){if(Dw(L,"transport",["default","auto","relay","sd-rtn"]),"p2p"!==this.mode)throw new ED(f1.INVALID_OPERATION,"only p2p mode can set p2pTransport");this.store.p2pTransport=L,gc.info("[".concat(this._clientId,"] set client p2pTransport to ").concat(L))}getJoinChannelServiceRecords(){return gc.debug("getJoinChannelServiceRecords"),this.store.joinChannelServiceRecords}async setPublishAudioFilterEnabled(L){Nw(L,"enabled"),AN("ENABLE_PUBLISH_AUDIO_FILTER",L),this._joinInfo&&await this._gateway.setPublishAudioFilterEnabled(L)}_handleResetAddStream(L,k){switch(k){case"audio":L._audio_added_=!1,L._trust_audio_stream_added_state_=!0;break;case"video":L._video_added_=!1,L._trust_video_stream_added_state_=!0}}}).prototype,"leave",[nn],Object.getOwnPropertyDescriptor(nQ.prototype,"leave"),nQ.prototype),OU(nQ.prototype,"publish",[na],Object.getOwnPropertyDescriptor(nQ.prototype,"publish"),nQ.prototype),OU(nQ.prototype,"unpublish",[no],Object.getOwnPropertyDescriptor(nQ.prototype,"unpublish"),nQ.prototype),OU(nQ.prototype,"subscribe",[ns],Object.getOwnPropertyDescriptor(nQ.prototype,"subscribe"),nQ.prototype),OU(nQ.prototype,"presubscribe",[nc],Object.getOwnPropertyDescriptor(nQ.prototype,"presubscribe"),nQ.prototype),OU(nQ.prototype,"massSubscribe",[nd],Object.getOwnPropertyDescriptor(nQ.prototype,"massSubscribe"),nQ.prototype),OU(nQ.prototype,"unsubscribe",[nl],Object.getOwnPropertyDescriptor(nQ.prototype,"unsubscribe"),nQ.prototype),OU(nQ.prototype,"massUnsubscribe",[nu],Object.getOwnPropertyDescriptor(nQ.prototype,"massUnsubscribe"),nQ.prototype),OU(nQ.prototype,"setLowStreamParameter",[nh],Object.getOwnPropertyDescriptor(nQ.prototype,"setLowStreamParameter"),nQ.prototype),OU(nQ.prototype,"enableDualStream",[np],Object.getOwnPropertyDescriptor(nQ.prototype,"enableDualStream"),nQ.prototype),OU(nQ.prototype,"disableDualStream",[n_],Object.getOwnPropertyDescriptor(nQ.prototype,"disableDualStream"),nQ.prototype),OU(nQ.prototype,"setClientRole",[nE],Object.getOwnPropertyDescriptor(nQ.prototype,"setClientRole"),nQ.prototype),OU(nQ.prototype,"_setClientRoleOptions",[nm],Object.getOwnPropertyDescriptor(nQ.prototype,"_setClientRoleOptions"),nQ.prototype),OU(nQ.prototype,"setProxyServer",[nf],Object.getOwnPropertyDescriptor(nQ.prototype,"setProxyServer"),nQ.prototype),OU(nQ.prototype,"setTurnServer",[ng],Object.getOwnPropertyDescriptor(nQ.prototype,"setTurnServer"),nQ.prototype),OU(nQ.prototype,"setLicense",[nT],Object.getOwnPropertyDescriptor(nQ.prototype,"setLicense"),nQ.prototype),OU(nQ.prototype,"startProxyServer",[nR],Object.getOwnPropertyDescriptor(nQ.prototype,"startProxyServer"),nQ.prototype),OU(nQ.prototype,"stopProxyServer",[nI],Object.getOwnPropertyDescriptor(nQ.prototype,"stopProxyServer"),nQ.prototype),OU(nQ.prototype,"setLocalAccessPointsV2",[nv],Object.getOwnPropertyDescriptor(nQ.prototype,"setLocalAccessPointsV2"),nQ.prototype),OU(nQ.prototype,"setLocalAccessPoints",[nC],Object.getOwnPropertyDescriptor(nQ.prototype,"setLocalAccessPoints"),nQ.prototype),OU(nQ.prototype,"setRemoteDefaultVideoStreamType",[ny],Object.getOwnPropertyDescriptor(nQ.prototype,"setRemoteDefaultVideoStreamType"),nQ.prototype),OU(nQ.prototype,"setRemoteVideoStreamType",[nA],Object.getOwnPropertyDescriptor(nQ.prototype,"setRemoteVideoStreamType"),nQ.prototype),OU(nQ.prototype,"setStreamFallbackOption",[nb],Object.getOwnPropertyDescriptor(nQ.prototype,"setStreamFallbackOption"),nQ.prototype),OU(nQ.prototype,"setEncryptionConfig",[nO],Object.getOwnPropertyDescriptor(nQ.prototype,"setEncryptionConfig"),nQ.prototype),OU(nQ.prototype,"renewToken",[nN],Object.getOwnPropertyDescriptor(nQ.prototype,"renewToken"),nQ.prototype),OU(nQ.prototype,"enableAudioVolumeIndicator",[nD],Object.getOwnPropertyDescriptor(nQ.prototype,"enableAudioVolumeIndicator"),nQ.prototype),OU(nQ.prototype,"startLiveStreaming",[nP],Object.getOwnPropertyDescriptor(nQ.prototype,"startLiveStreaming"),nQ.prototype),OU(nQ.prototype,"setLiveTranscoding",[nL],Object.getOwnPropertyDescriptor(nQ.prototype,"setLiveTranscoding"),nQ.prototype),OU(nQ.prototype,"stopLiveStreaming",[nk],Object.getOwnPropertyDescriptor(nQ.prototype,"stopLiveStreaming"),nQ.prototype),OU(nQ.prototype,"startChannelMediaRelay",[nM],Object.getOwnPropertyDescriptor(nQ.prototype,"startChannelMediaRelay"),nQ.prototype),OU(nQ.prototype,"updateChannelMediaRelay",[nU],Object.getOwnPropertyDescriptor(nQ.prototype,"updateChannelMediaRelay"),nQ.prototype),OU(nQ.prototype,"stopChannelMediaRelay",[nV],Object.getOwnPropertyDescriptor(nQ.prototype,"stopChannelMediaRelay"),nQ.prototype),OU(nQ.prototype,"sendCustomReportMessage",[nF],Object.getOwnPropertyDescriptor(nQ.prototype,"sendCustomReportMessage"),nQ.prototype),OU(nQ.prototype,"pickSVCLayer",[nB],Object.getOwnPropertyDescriptor(nQ.prototype,"pickSVCLayer"),nQ.prototype),OU(nQ.prototype,"setRTMConfig",[nW],Object.getOwnPropertyDescriptor(nQ.prototype,"setRTMConfig"),nQ.prototype),OU(nQ.prototype,"enableContentInspect",[nG],Object.getOwnPropertyDescriptor(nQ.prototype,"enableContentInspect"),nQ.prototype),OU(nQ.prototype,"disableContentInspect",[nH],Object.getOwnPropertyDescriptor(nQ.prototype,"disableContentInspect"),nQ.prototype),OU(nQ.prototype,"setImageModeration",[nY],Object.getOwnPropertyDescriptor(nQ.prototype,"setImageModeration"),nQ.prototype),OU(nQ.prototype,"setP2PTransport",[nq],Object.getOwnPropertyDescriptor(nQ.prototype,"setP2PTransport"),nQ.prototype),OU(nQ.prototype,"getJoinChannelServiceRecords",[nJ],Object.getOwnPropertyDescriptor(nQ.prototype,"getJoinChannelServiceRecords"),nQ.prototype),OU(nQ.prototype,"setPublishAudioFilterEnabled",[nX],Object.getOwnPropertyDescriptor(nQ.prototype,"setPublishAudioFilterEnabled"),nQ.prototype),nQ);let aW=class aW{constructor(L,k){uI(this,"id",0),uI(this,"element",void 0),uI(this,"peerPair",void 0),uI(this,"context",void 0),uI(this,"audioPlayerElement",void 0),uI(this,"audioTrack",void 0),aW.count+=1,this.id=aW.count,this.element=L,this.context=k}initPeers(){this.peerPair=[new RTCPeerConnection,new RTCPeerConnection],this.peerPair[1].ontrack=L=>{let k=document.createElement("audio");k.srcObject=new MediaStream([L.track]),k.play(),this.audioPlayerElement=k}}async switchSdp(){if(!this.peerPair)return;let e=async(L,k)=>{let M="offer"===k?await L.createOffer():await L.createAnswer();return await L.setLocalDescription(M),"complete"===L.iceGatheringState?L.localDescription:new lQ(k=>{L.onicegatheringstatechange=()=>{"complete"===L.iceGatheringState&&k(L.localDescription)}})},t=async(L,k)=>await L.setRemoteDescription(k);try{let L=await e(this.peerPair[0],"offer");await t(this.peerPair[1],L);let k=await e(this.peerPair[1],"answer");await t(this.peerPair[0],k)}catch(L){throw new ED(f1.LOCAL_AEC_ERROR,L.toString()).print()}}async getTracksFromMediaElement(L){let k;if(this.audioTrack)return this.audioTrack;try{L instanceof HTMLVideoElement&&(L.captureStream?L.captureStream():L.mozCaptureStream()),k=this.context.createMediaStreamDestination(),this.context.createMediaElementSource(L).connect(k)}catch(L){throw new ED(f1.LOCAL_AEC_ERROR,L.toString()).print()}if(!k)throw new ED(f1.LOCAL_AEC_ERROR,"no dest node when local aec").print();let M=k.stream.getAudioTracks()[0];return this.audioTrack=M,M}getElement(){return this.element}async startEchoCancellation(){this.context.resume(),this.peerPair&&this.close(),this.initPeers();let L=this.element,k=await this.getTracksFromMediaElement(L);this.peerPair&&this.peerPair[0].addTrack(k),await this.switchSdp()}close(){gc.debug("close echo cancellation unit, id is",this.id),this.audioPlayerElement&&this.audioPlayerElement.pause(),this.peerPair&&this.peerPair.forEach(L=>{L.close()}),this.peerPair=void 0,this.audioPlayerElement=void 0}};uI(aW,"count",0);let vv=window.AudioContext||window.webkitAudioContext,vC=new(nZ=pD({report:g_}),OU((n$=class{constructor(){uI(this,"units",[]),uI(this,"context",void 0)}processExternalMediaAEC(L){if(!this._doesEnvironmentNeedAEC())return gc.debug("the system does not need to process local aec"),-1;this.context||(this.context=new vv);let k=this.units.find(k=>k&&k.getElement()===L);return k||(k=new aW(L,this.context),this.units.push(k)),k.startEchoCancellation(),gc.debug("start processing local audio echo cancellation, id is",k.id),k.id}_doesEnvironmentNeedAEC(){return zA().name!==fQ.SAFARI}}).prototype,"processExternalMediaAEC",[nZ],Object.getOwnPropertyDescriptor(n$.prototype,"processExternalMediaAEC"),n$.prototype),n$);function hW(L,k){var M=Object.keys(L);if(Object.getOwnPropertySymbols){var U=Object.getOwnPropertySymbols(L);k&&(U=U.filter(function(k){return Object.getOwnPropertyDescriptor(L,k).enumerable})),M.push.apply(M,U)}return M}function pW(L){for(var k=1;k<arguments.length;k++){var M=null!=arguments[k]?arguments[k]:{};k%2?hW(Object(M),!0).forEach(function(k){uI(L,k,M[k])}):Object.getOwnPropertyDescriptors?Object.defineProperties(L,Object.getOwnPropertyDescriptors(M)):hW(Object(M)).forEach(function(k){Object.defineProperty(L,k,Object.getOwnPropertyDescriptor(M,k))})}return L}let vy=window||document;function EW(L){let k=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!vy)return;let M=yK._cspEventHandlerPointer;if(M&&k)return void console.error(M,k);let n=L=>{if(!(L&&L.blockedURI&&(yK.onSecurityPolicyViolation||yK.getListeners(Ii.SECURITY_POLICY_VIOLATION).length>0)))return;let k=L.blockedURI;wN("CSP_DETECTED_HOSTNAME_LIST").some(L=>so(k).call(k,L))&&(yK.onSecurityPolicyViolation&&"function"==typeof yK.onSecurityPolicyViolation&&yK.onSecurityPolicyViolation(L),yK.getListeners(Ii.SECURITY_POLICY_VIOLATION).length>0&&yK.safeEmit(Ii.SECURITY_POLICY_VIOLATION,L))};M&&vy.removeEventListener("securitypolicyviolation",M),(k||L&&"function"==typeof L||yK.getListeners(Ii.SECURITY_POLICY_VIOLATION).length>0)&&vy.addEventListener("securitypolicyviolation",n),yK._cspEventHandlerPointer=n}var vb=RegExp.prototype,vN=i(function(L){return L===vb||al(vb,L)?wI(L):L.flags});function RW(L){let k=L.length;for(;--k>=0;)L[k]=0}let vD=new Uint8Array([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0]),vL=new Uint8Array([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13]),vk=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7]),vM=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),vU=Array(576);RW(vU);let vV=Array(60);RW(vV);let vj=Array(512);RW(vj);let vW=Array(256);RW(vW);let vG=Array(29);RW(vG);let vH=Array(30);function UW(L,k,M,U,V){this.static_tree=L,this.extra_bits=k,this.extra_base=M,this.elems=U,this.max_length=V,this.has_stree=L&&L.length}function BW(L,k){this.dyn_tree=L,this.max_code=0,this.stat_desc=k}RW(vH);let jW=L=>L<256?vj[L]:vj[256+(L>>>7)],GW=(L,k)=>{L.pending_buf[L.pending++]=255&k,L.pending_buf[L.pending++]=k>>>8&255},WW=(L,k,M)=>{L.bi_valid>16-M?(L.bi_buf|=k<<L.bi_valid&65535,GW(L,L.bi_buf),L.bi_buf=k>>16-L.bi_valid,L.bi_valid+=M-16):(L.bi_buf|=k<<L.bi_valid&65535,L.bi_valid+=M)},HW=(L,k,M)=>{WW(L,M[2*k],M[2*k+1])},KW=(L,k)=>{let M=0;do M|=1&L,L>>>=1,M<<=1;while(--k>0);return M>>>1},YW=(L,k,M)=>{let U=Array(16),V,F,B=0;for(V=1;V<=15;V++)B=B+M[V-1]<<1,U[V]=B;for(F=0;F<=k;F++){let k=L[2*F+1];0!==k&&(L[2*F]=KW(U[k]++,k))}},zW=L=>{let k;for(k=0;k<286;k++)L.dyn_ltree[2*k]=0;for(k=0;k<30;k++)L.dyn_dtree[2*k]=0;for(k=0;k<19;k++)L.bl_tree[2*k]=0;L.dyn_ltree[512]=1,L.opt_len=L.static_len=0,L.sym_next=L.matches=0},qW=L=>{L.bi_valid>8?GW(L,L.bi_buf):L.bi_valid>0&&(L.pending_buf[L.pending++]=L.bi_buf),L.bi_buf=0,L.bi_valid=0},XW=(L,k,M,U)=>{let V=2*k,F=2*M;return L[V]<L[F]||L[V]===L[F]&&U[k]<=U[M]},JW=(L,k,M)=>{let U=L.heap[M],V=M<<1;for(;V<=L.heap_len&&(V<L.heap_len&&XW(k,L.heap[V+1],L.heap[V],L.depth)&&V++,!XW(k,U,L.heap[V],L.depth));)L.heap[M]=L.heap[V],M=V,V<<=1;L.heap[M]=U},ZW=(L,k,M)=>{let U,V,F,B,j=0;if(0!==L.sym_next)do U=(255&L.pending_buf[L.sym_buf+j++])+((255&L.pending_buf[L.sym_buf+j++])<<8),V=L.pending_buf[L.sym_buf+j++],0===U?HW(L,V,k):(HW(L,(F=vW[V])+256+1,k),0!==(B=vD[F])&&WW(L,V-=vG[F],B),HW(L,F=jW(--U),M),0!==(B=vL[F])&&WW(L,U-=vH[F],B));while(j<L.sym_next);HW(L,256,k)},QW=(L,k)=>{let M=k.dyn_tree,U=k.stat_desc.static_tree,V=k.stat_desc.has_stree,F=k.stat_desc.elems,B,j,G,X=-1;for(L.heap_len=0,L.heap_max=573,B=0;B<F;B++)0!==M[2*B]?(L.heap[++L.heap_len]=X=B,L.depth[B]=0):M[2*B+1]=0;for(;L.heap_len<2;)M[2*(G=L.heap[++L.heap_len]=X<2?++X:0)]=1,L.depth[G]=0,L.opt_len--,V&&(L.static_len-=U[2*G+1]);for(k.max_code=X,B=L.heap_len>>1;B>=1;B--)JW(L,M,B);G=F;do B=L.heap[1],L.heap[1]=L.heap[L.heap_len--],JW(L,M,1),j=L.heap[1],L.heap[--L.heap_max]=B,L.heap[--L.heap_max]=j,M[2*G]=M[2*B]+M[2*j],L.depth[G]=(L.depth[B]>=L.depth[j]?L.depth[B]:L.depth[j])+1,M[2*B+1]=M[2*j+1]=G,L.heap[1]=G++,JW(L,M,1);while(L.heap_len>=2);L.heap[--L.heap_max]=L.heap[1],((L,k)=>{let M=k.dyn_tree,U=k.max_code,V=k.stat_desc.static_tree,F=k.stat_desc.has_stree,B=k.stat_desc.extra_bits,j=k.stat_desc.extra_base,G=k.stat_desc.max_length,X,$,ee,et,ei,er,en=0;for(et=0;et<=15;et++)L.bl_count[et]=0;for(M[2*L.heap[L.heap_max]+1]=0,X=L.heap_max+1;X<573;X++)(et=M[2*M[2*($=L.heap[X])+1]+1]+1)>G&&(et=G,en++),M[2*$+1]=et,$>U||(L.bl_count[et]++,ei=0,$>=j&&(ei=B[$-j]),er=M[2*$],L.opt_len+=er*(et+ei),F&&(L.static_len+=er*(V[2*$+1]+ei)));if(0!==en){do{for(et=G-1;0===L.bl_count[et];)et--;L.bl_count[et]--,L.bl_count[et+1]+=2,L.bl_count[G]--,en-=2}while(en>0);for(et=G;0!==et;et--)for($=L.bl_count[et];0!==$;)(ee=L.heap[--X])>U||(M[2*ee+1]!==et&&(L.opt_len+=(et-M[2*ee+1])*M[2*ee],M[2*ee+1]=et),$--)}})(L,k),YW(M,X,L.bl_count)},$W=(L,k,M)=>{let U,V,F=-1,B=k[1],j=0,G=7,X=4;for(0===B&&(G=138,X=3),k[2*(M+1)+1]=65535,U=0;U<=M;U++)V=B,B=k[2*(U+1)+1],++j<G&&V===B||(j<X?L.bl_tree[2*V]+=j:0!==V?(V!==F&&L.bl_tree[2*V]++,L.bl_tree[32]++):j<=10?L.bl_tree[34]++:L.bl_tree[36]++,j=0,F=V,0===B?(G=138,X=3):V===B?(G=6,X=3):(G=7,X=4))},eH=(L,k,M)=>{let U,V,F=-1,B=k[1],j=0,G=7,X=4;for(0===B&&(G=138,X=3),U=0;U<=M;U++)if(V=B,B=k[2*(U+1)+1],!(++j<G&&V===B)){if(j<X)do HW(L,V,L.bl_tree);while(0!=--j);else 0!==V?(V!==F&&(HW(L,V,L.bl_tree),j--),HW(L,16,L.bl_tree),WW(L,j-3,2)):j<=10?(HW(L,17,L.bl_tree),WW(L,j-3,3)):(HW(L,18,L.bl_tree),WW(L,j-11,7));j=0,F=V,0===B?(G=138,X=3):V===B?(G=6,X=3):(G=7,X=4)}},vY=!1,iH=(L,k,M,U)=>{WW(L,0+(U?1:0),3),qW(L),GW(L,M),GW(L,~M),M&&L.pending_buf.set(L.window.subarray(k,k+M),L.pending),L.pending+=M};var vq={_tr_init:L=>{vY||((()=>{let L,M,U,V,j;let G=Array(16);for(U=0,V=0;V<28;V++)for(vG[V]=U,L=0;L<1<<vD[V];L++)vW[U++]=V;for(vW[U-1]=V,j=0,V=0;V<16;V++)for(vH[V]=j,L=0;L<1<<vL[V];L++)vj[j++]=V;for(j>>=7;V<30;V++)for(vH[V]=j<<7,L=0;L<1<<vL[V]-7;L++)vj[256+j++]=V;for(M=0;M<=15;M++)G[M]=0;for(L=0;L<=143;)vU[2*L+1]=8,L++,G[8]++;for(;L<=255;)vU[2*L+1]=9,L++,G[9]++;for(;L<=279;)vU[2*L+1]=7,L++,G[7]++;for(;L<=287;)vU[2*L+1]=8,L++,G[8]++;for(YW(vU,287,G),L=0;L<30;L++)vV[2*L+1]=5,vV[2*L]=KW(L,5);k=new UW(vU,vD,257,286,15),F=new UW(vV,vL,0,30,15),B=new UW([],vk,0,19,7)})(),vY=!0),L.l_desc=new BW(L.dyn_ltree,k),L.d_desc=new BW(L.dyn_dtree,F),L.bl_desc=new BW(L.bl_tree,B),L.bi_buf=0,L.bi_valid=0,zW(L)},_tr_stored_block:iH,_tr_flush_block:(L,k,M,U)=>{let V,F,B=0;L.level>0?(2===L.strm.data_type&&(L.strm.data_type=(L=>{let k,M=4093624447;for(k=0;k<=31;k++,M>>>=1)if(1&M&&0!==L.dyn_ltree[2*k])return 0;if(0!==L.dyn_ltree[18]||0!==L.dyn_ltree[20]||0!==L.dyn_ltree[26])return 1;for(k=32;k<256;k++)if(0!==L.dyn_ltree[2*k])return 1;return 0})(L)),QW(L,L.l_desc),QW(L,L.d_desc),B=(L=>{let k;for($W(L,L.dyn_ltree,L.l_desc.max_code),$W(L,L.dyn_dtree,L.d_desc.max_code),QW(L,L.bl_desc),k=18;k>=3&&0===L.bl_tree[2*vM[k]+1];k--);return L.opt_len+=3*(k+1)+5+5+4,k})(L),V=L.opt_len+3+7>>>3,(F=L.static_len+3+7>>>3)<=V&&(V=F)):V=F=M+5,M+4<=V&&-1!==k?iH(L,k,M,U):4===L.strategy||F===V?(WW(L,2+(U?1:0),3),ZW(L,vU,vV)):(WW(L,4+(U?1:0),3),((L,k,M,U)=>{let V;for(WW(L,k-257,5),WW(L,M-1,5),WW(L,U-4,4),V=0;V<U;V++)WW(L,L.bl_tree[2*vM[V]+1],3);eH(L,L.dyn_ltree,k-1),eH(L,L.dyn_dtree,M-1)})(L,L.l_desc.max_code+1,L.d_desc.max_code+1,B+1),ZW(L,L.dyn_ltree,L.dyn_dtree)),zW(L),U&&qW(L)},_tr_tally:(L,k,M)=>(L.pending_buf[L.sym_buf+L.sym_next++]=k,L.pending_buf[L.sym_buf+L.sym_next++]=k>>8,L.pending_buf[L.sym_buf+L.sym_next++]=M,0===k?L.dyn_ltree[2*M]++:(L.matches++,k--,L.dyn_ltree[2*(vW[M]+256+1)]++,L.dyn_dtree[2*jW(k)]++),L.sym_next===L.sym_end),_tr_align:L=>{WW(L,2,3),HW(L,256,vU),16===L.bi_valid?(GW(L,L.bi_buf),L.bi_buf=0,L.bi_valid=0):L.bi_valid>=8&&(L.pending_buf[L.pending++]=255&L.bi_buf,L.bi_buf>>=8,L.bi_valid-=8)}},cH=(L,k,M,U)=>{let V=65535&L|0,F=L>>>16&65535|0,B=0;for(;0!==M;){B=M>2e3?2e3:M,M-=B;do F=F+(V=V+k[U++]|0)|0;while(--B);V%=65521,F%=65521}return V|F<<16|0};let vJ=new Uint32Array((()=>{let L,k=[];for(var M=0;M<256;M++){L=M;for(var U=0;U<8;U++)L=1&L?3988292384^L>>>1:L>>>1;k[M]=L}return k})());var lH=(L,k,M,U)=>{let V=U+M;L^=-1;for(let M=U;M<V;M++)L=L>>>8^vJ[255&(L^k[M])];return -1^L},vX={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"},vQ={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_MEM_ERROR:-4,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8};let{_tr_init:vZ,_tr_stored_block:v$,_tr_flush_block:v0,_tr_tally:v1,_tr_align:v2}=vq,{Z_NO_FLUSH:v3,Z_PARTIAL_FLUSH:v5,Z_FULL_FLUSH:v4,Z_FINISH:v6,Z_BLOCK:v8,Z_OK:v9,Z_STREAM_END:v7,Z_STREAM_ERROR:Ce,Z_DATA_ERROR:Ci,Z_BUF_ERROR:Cr,Z_DEFAULT_COMPRESSION:Cn,Z_FILTERED:Co,Z_HUFFMAN_ONLY:Cs,Z_RLE:Cd,Z_FIXED:Cl,Z_DEFAULT_STRATEGY:Ch,Z_UNKNOWN:Cp,Z_DEFLATED:C_}=vQ,YH=(L,k)=>(L.msg=vX[k],k),zH=L=>2*L-(L>4?9:0),qH=L=>{let k=L.length;for(;--k>=0;)L[k]=0},XH=L=>{let k,M,U,V=L.w_size;U=k=L.hash_size;do M=L.head[--U],L.head[U]=M>=V?M-V:0;while(--k);U=k=V;do M=L.prev[--U],L.prev[U]=M>=V?M-V:0;while(--k)},JH=(L,k,M)=>(k<<L.hash_shift^M)&L.hash_mask,ZH=L=>{let k=L.state,M=k.pending;M>L.avail_out&&(M=L.avail_out),0!==M&&(L.output.set(k.pending_buf.subarray(k.pending_out,k.pending_out+M),L.next_out),L.next_out+=M,k.pending_out+=M,L.total_out+=M,L.avail_out-=M,k.pending-=M,0===k.pending&&(k.pending_out=0))},QH=(L,k)=>{v0(L,L.block_start>=0?L.block_start:-1,L.strstart-L.block_start,k),L.block_start=L.strstart,ZH(L.strm)},$H=(L,k)=>{L.pending_buf[L.pending++]=k},eK=(L,k)=>{L.pending_buf[L.pending++]=k>>>8&255,L.pending_buf[L.pending++]=255&k},tK=(L,k,M,U)=>{let V=L.avail_in;return V>U&&(V=U),0===V?0:(L.avail_in-=V,k.set(L.input.subarray(L.next_in,L.next_in+V),M),1===L.state.wrap?L.adler=cH(L.adler,k,V,M):2===L.state.wrap&&(L.adler=lH(L.adler,k,V,M)),L.next_in+=V,L.total_in+=V,V)},iK=(L,k)=>{let M,U,V=L.max_chain_length,F=L.strstart,B=L.prev_length,j=L.nice_match,G=L.strstart>L.w_size-262?L.strstart-(L.w_size-262):0,X=L.window,$=L.w_mask,ee=L.prev,et=L.strstart+258,ei=X[F+B-1],er=X[F+B];L.prev_length>=L.good_match&&(V>>=2),j>L.lookahead&&(j=L.lookahead);do if(X[(M=k)+B]===er&&X[M+B-1]===ei&&X[M]===X[F]&&X[++M]===X[F+1]){F+=2,M++;do;while(X[++F]===X[++M]&&X[++F]===X[++M]&&X[++F]===X[++M]&&X[++F]===X[++M]&&X[++F]===X[++M]&&X[++F]===X[++M]&&X[++F]===X[++M]&&X[++F]===X[++M]&&F<et);if(U=258-(et-F),F=et-258,U>B){if(L.match_start=k,B=U,U>=j)break;ei=X[F+B-1],er=X[F+B]}}while((k=ee[k&$])>G&&0!=--V);return B<=L.lookahead?B:L.lookahead},nK=L=>{let k,M,U;let V=L.w_size;do{if(M=L.window_size-L.lookahead-L.strstart,L.strstart>=V+(V-262)&&(L.window.set(L.window.subarray(V,V+V-M),0),L.match_start-=V,L.strstart-=V,L.block_start-=V,L.insert>L.strstart&&(L.insert=L.strstart),XH(L),M+=V),0===L.strm.avail_in)break;if(k=tK(L.strm,L.window,L.strstart+L.lookahead,M),L.lookahead+=k,L.lookahead+L.insert>=3)for(U=L.strstart-L.insert,L.ins_h=L.window[U],L.ins_h=JH(L,L.ins_h,L.window[U+1]);L.insert&&(L.ins_h=JH(L,L.ins_h,L.window[U+3-1]),L.prev[U&L.w_mask]=L.head[L.ins_h],L.head[L.ins_h]=U,U++,L.insert--,!(L.lookahead+L.insert<3)););}while(L.lookahead<262&&0!==L.strm.avail_in)},rK=(L,k)=>{let M,U,V,F=L.pending_buf_size-5>L.w_size?L.w_size:L.pending_buf_size-5,B=0,j=L.strm.avail_in;do{if(M=65535,V=L.bi_valid+42>>3,L.strm.avail_out<V||(V=L.strm.avail_out-V,M>(U=L.strstart-L.block_start)+L.strm.avail_in&&(M=U+L.strm.avail_in),M>V&&(M=V),M<F&&(0===M&&k!==v6||k===v3||M!==U+L.strm.avail_in)))break;B=k===v6&&M===U+L.strm.avail_in?1:0,v$(L,0,0,B),L.pending_buf[L.pending-4]=M,L.pending_buf[L.pending-3]=M>>8,L.pending_buf[L.pending-2]=~M,L.pending_buf[L.pending-1]=~M>>8,ZH(L.strm),U&&(U>M&&(U=M),L.strm.output.set(L.window.subarray(L.block_start,L.block_start+U),L.strm.next_out),L.strm.next_out+=U,L.strm.avail_out-=U,L.strm.total_out+=U,L.block_start+=U,M-=U),M&&(tK(L.strm,L.strm.output,L.strm.next_out,M),L.strm.next_out+=M,L.strm.avail_out-=M,L.strm.total_out+=M)}while(0===B);return(j-=L.strm.avail_in)&&(j>=L.w_size?(L.matches=2,L.window.set(L.strm.input.subarray(L.strm.next_in-L.w_size,L.strm.next_in),0),L.strstart=L.w_size,L.insert=L.strstart):(L.window_size-L.strstart<=j&&(L.strstart-=L.w_size,L.window.set(L.window.subarray(L.w_size,L.w_size+L.strstart),0),L.matches<2&&L.matches++,L.insert>L.strstart&&(L.insert=L.strstart)),L.window.set(L.strm.input.subarray(L.strm.next_in-j,L.strm.next_in),L.strstart),L.strstart+=j,L.insert+=j>L.w_size-L.insert?L.w_size-L.insert:j),L.block_start=L.strstart),L.high_water<L.strstart&&(L.high_water=L.strstart),B?4:k!==v3&&k!==v6&&0===L.strm.avail_in&&L.strstart===L.block_start?2:(V=L.window_size-L.strstart,L.strm.avail_in>V&&L.block_start>=L.w_size&&(L.block_start-=L.w_size,L.strstart-=L.w_size,L.window.set(L.window.subarray(L.w_size,L.w_size+L.strstart),0),L.matches<2&&L.matches++,V+=L.w_size,L.insert>L.strstart&&(L.insert=L.strstart)),V>L.strm.avail_in&&(V=L.strm.avail_in),V&&(tK(L.strm,L.window,L.strstart,V),L.strstart+=V,L.insert+=V>L.w_size-L.insert?L.w_size-L.insert:V),L.high_water<L.strstart&&(L.high_water=L.strstart),V=L.bi_valid+42>>3,F=(V=L.pending_buf_size-V>65535?65535:L.pending_buf_size-V)>L.w_size?L.w_size:V,((U=L.strstart-L.block_start)>=F||(U||k===v6)&&k!==v3&&0===L.strm.avail_in&&U<=V)&&(M=U>V?V:U,B=k===v6&&0===L.strm.avail_in&&M===U?1:0,v$(L,L.block_start,M,B),L.block_start+=M,ZH(L.strm)),B?3:1)},oK=(L,k)=>{let M,U;for(;;){if(L.lookahead<262){if(nK(L),L.lookahead<262&&k===v3)return 1;if(0===L.lookahead)break}if(M=0,L.lookahead>=3&&(L.ins_h=JH(L,L.ins_h,L.window[L.strstart+3-1]),M=L.prev[L.strstart&L.w_mask]=L.head[L.ins_h],L.head[L.ins_h]=L.strstart),0!==M&&L.strstart-M<=L.w_size-262&&(L.match_length=iK(L,M)),L.match_length>=3){if(U=v1(L,L.strstart-L.match_start,L.match_length-3),L.lookahead-=L.match_length,L.match_length<=L.max_lazy_match&&L.lookahead>=3){L.match_length--;do L.strstart++,L.ins_h=JH(L,L.ins_h,L.window[L.strstart+3-1]),M=L.prev[L.strstart&L.w_mask]=L.head[L.ins_h],L.head[L.ins_h]=L.strstart;while(0!=--L.match_length);L.strstart++}else L.strstart+=L.match_length,L.match_length=0,L.ins_h=L.window[L.strstart],L.ins_h=JH(L,L.ins_h,L.window[L.strstart+1])}else U=v1(L,0,L.window[L.strstart]),L.lookahead--,L.strstart++;if(U&&(QH(L,!1),0===L.strm.avail_out))return 1}return L.insert=L.strstart<2?L.strstart:2,k===v6?(QH(L,!0),0===L.strm.avail_out?3:4):L.sym_next&&(QH(L,!1),0===L.strm.avail_out)?1:2},sK=(L,k)=>{let M,U,V;for(;;){if(L.lookahead<262){if(nK(L),L.lookahead<262&&k===v3)return 1;if(0===L.lookahead)break}if(M=0,L.lookahead>=3&&(L.ins_h=JH(L,L.ins_h,L.window[L.strstart+3-1]),M=L.prev[L.strstart&L.w_mask]=L.head[L.ins_h],L.head[L.ins_h]=L.strstart),L.prev_length=L.match_length,L.prev_match=L.match_start,L.match_length=2,0!==M&&L.prev_length<L.max_lazy_match&&L.strstart-M<=L.w_size-262&&(L.match_length=iK(L,M),L.match_length<=5&&(L.strategy===Co||3===L.match_length&&L.strstart-L.match_start>4096)&&(L.match_length=2)),L.prev_length>=3&&L.match_length<=L.prev_length){V=L.strstart+L.lookahead-3,U=v1(L,L.strstart-1-L.prev_match,L.prev_length-3),L.lookahead-=L.prev_length-1,L.prev_length-=2;do++L.strstart<=V&&(L.ins_h=JH(L,L.ins_h,L.window[L.strstart+3-1]),M=L.prev[L.strstart&L.w_mask]=L.head[L.ins_h],L.head[L.ins_h]=L.strstart);while(0!=--L.prev_length);if(L.match_available=0,L.match_length=2,L.strstart++,U&&(QH(L,!1),0===L.strm.avail_out))return 1}else if(L.match_available){if((U=v1(L,0,L.window[L.strstart-1]))&&QH(L,!1),L.strstart++,L.lookahead--,0===L.strm.avail_out)return 1}else L.match_available=1,L.strstart++,L.lookahead--}return L.match_available&&(U=v1(L,0,L.window[L.strstart-1]),L.match_available=0),L.insert=L.strstart<2?L.strstart:2,k===v6?(QH(L,!0),0===L.strm.avail_out?3:4):L.sym_next&&(QH(L,!1),0===L.strm.avail_out)?1:2};function aK(L,k,M,U,V){this.good_length=L,this.max_lazy=k,this.nice_length=M,this.max_chain=U,this.func=V}let Cm=[new aK(0,0,0,0,rK),new aK(4,4,8,4,oK),new aK(4,5,16,8,oK),new aK(4,6,32,32,oK),new aK(4,4,16,16,sK),new aK(8,16,32,32,sK),new aK(8,16,128,128,sK),new aK(8,32,128,256,sK),new aK(32,128,258,1024,sK),new aK(32,258,258,4096,sK)];function dK(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=C_,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new Uint16Array(1146),this.dyn_dtree=new Uint16Array(122),this.bl_tree=new Uint16Array(78),qH(this.dyn_ltree),qH(this.dyn_dtree),qH(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new Uint16Array(16),this.heap=new Uint16Array(573),qH(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new Uint16Array(573),qH(this.depth),this.sym_buf=0,this.lit_bufsize=0,this.sym_next=0,this.sym_end=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}let lK=L=>{if(!L)return 1;let k=L.state;return k&&k.strm===L&&(42===k.status||57===k.status||69===k.status||73===k.status||91===k.status||103===k.status||113===k.status||666===k.status)?0:1},uK=L=>{if(lK(L))return YH(L,Ce);L.total_in=L.total_out=0,L.data_type=Cp;let k=L.state;return k.pending=0,k.pending_out=0,k.wrap<0&&(k.wrap=-k.wrap),k.status=2===k.wrap?57:k.wrap?42:113,L.adler=2===k.wrap?0:1,k.last_flush=-2,vZ(k),v9},hK=L=>{var k;let M=uK(L);return M===v9&&((k=L.state).window_size=2*k.w_size,qH(k.head),k.max_lazy_match=Cm[k.level].max_lazy,k.good_match=Cm[k.level].good_length,k.nice_match=Cm[k.level].nice_length,k.max_chain_length=Cm[k.level].max_chain,k.strstart=0,k.block_start=0,k.lookahead=0,k.insert=0,k.match_length=k.prev_length=2,k.match_available=0,k.ins_h=0),M},pK=(L,k,M,U,V,F)=>{if(!L)return Ce;let B=1;if(k===Cn&&(k=6),U<0?(B=0,U=-U):U>15&&(B=2,U-=16),V<1||V>9||M!==C_||U<8||U>15||k<0||k>9||F<0||F>Cl||8===U&&1!==B)return YH(L,Ce);8===U&&(U=9);let j=new dK;return L.state=j,j.strm=L,j.status=42,j.wrap=B,j.gzhead=null,j.w_bits=U,j.w_size=1<<j.w_bits,j.w_mask=j.w_size-1,j.hash_bits=V+7,j.hash_size=1<<j.hash_bits,j.hash_mask=j.hash_size-1,j.hash_shift=~~((j.hash_bits+3-1)/3),j.window=new Uint8Array(2*j.w_size),j.head=new Uint16Array(j.hash_size),j.prev=new Uint16Array(j.w_size),j.lit_bufsize=1<<V+6,j.pending_buf_size=4*j.lit_bufsize,j.pending_buf=new Uint8Array(j.pending_buf_size),j.sym_buf=j.lit_bufsize,j.sym_end=3*(j.lit_bufsize-1),j.level=k,j.strategy=F,j.method=M,hK(L)};var Cf={deflateInit:(L,k)=>pK(L,k,C_,15,8,Ch),deflateInit2:pK,deflateReset:hK,deflateResetKeep:uK,deflateSetHeader:(L,k)=>lK(L)||2!==L.state.wrap?Ce:(L.state.gzhead=k,v9),deflate:(L,k)=>{if(lK(L)||k>v8||k<0)return L?YH(L,Ce):Ce;let M=L.state;if(!L.output||0!==L.avail_in&&!L.input||666===M.status&&k!==v6)return YH(L,0===L.avail_out?Cr:Ce);let U=M.last_flush;if(M.last_flush=k,0!==M.pending){if(ZH(L),0===L.avail_out)return M.last_flush=-1,v9}else if(0===L.avail_in&&zH(k)<=zH(U)&&k!==v6)return YH(L,Cr);if(666===M.status&&0!==L.avail_in)return YH(L,Cr);if(42===M.status&&0===M.wrap&&(M.status=113),42===M.status){let k=C_+(M.w_bits-8<<4)<<8;if(k|=(M.strategy>=Cs||M.level<2?0:M.level<6?1:6===M.level?2:3)<<6,0!==M.strstart&&(k|=32),eK(M,k+=31-k%31),0!==M.strstart&&(eK(M,L.adler>>>16),eK(M,65535&L.adler)),L.adler=1,M.status=113,ZH(L),0!==M.pending)return M.last_flush=-1,v9}if(57===M.status){if(L.adler=0,$H(M,31),$H(M,139),$H(M,8),M.gzhead)$H(M,(M.gzhead.text?1:0)+(M.gzhead.hcrc?2:0)+(M.gzhead.extra?4:0)+(M.gzhead.name?8:0)+(M.gzhead.comment?16:0)),$H(M,255&M.gzhead.time),$H(M,M.gzhead.time>>8&255),$H(M,M.gzhead.time>>16&255),$H(M,M.gzhead.time>>24&255),$H(M,9===M.level?2:M.strategy>=Cs||M.level<2?4:0),$H(M,255&M.gzhead.os),M.gzhead.extra&&M.gzhead.extra.length&&($H(M,255&M.gzhead.extra.length),$H(M,M.gzhead.extra.length>>8&255)),M.gzhead.hcrc&&(L.adler=lH(L.adler,M.pending_buf,M.pending,0)),M.gzindex=0,M.status=69;else if($H(M,0),$H(M,0),$H(M,0),$H(M,0),$H(M,0),$H(M,9===M.level?2:M.strategy>=Cs||M.level<2?4:0),$H(M,3),M.status=113,ZH(L),0!==M.pending)return M.last_flush=-1,v9}if(69===M.status){if(M.gzhead.extra){let k=M.pending,U=(65535&M.gzhead.extra.length)-M.gzindex;for(;M.pending+U>M.pending_buf_size;){let V=M.pending_buf_size-M.pending;if(M.pending_buf.set(M.gzhead.extra.subarray(M.gzindex,M.gzindex+V),M.pending),M.pending=M.pending_buf_size,M.gzhead.hcrc&&M.pending>k&&(L.adler=lH(L.adler,M.pending_buf,M.pending-k,k)),M.gzindex+=V,ZH(L),0!==M.pending)return M.last_flush=-1,v9;k=0,U-=V}let V=new Uint8Array(M.gzhead.extra);M.pending_buf.set(V.subarray(M.gzindex,M.gzindex+U),M.pending),M.pending+=U,M.gzhead.hcrc&&M.pending>k&&(L.adler=lH(L.adler,M.pending_buf,M.pending-k,k)),M.gzindex=0}M.status=73}if(73===M.status){if(M.gzhead.name){let k,U=M.pending;do{if(M.pending===M.pending_buf_size){if(M.gzhead.hcrc&&M.pending>U&&(L.adler=lH(L.adler,M.pending_buf,M.pending-U,U)),ZH(L),0!==M.pending)return M.last_flush=-1,v9;U=0}k=M.gzindex<M.gzhead.name.length?255&M.gzhead.name.charCodeAt(M.gzindex++):0,$H(M,k)}while(0!==k);M.gzhead.hcrc&&M.pending>U&&(L.adler=lH(L.adler,M.pending_buf,M.pending-U,U)),M.gzindex=0}M.status=91}if(91===M.status){if(M.gzhead.comment){let k,U=M.pending;do{if(M.pending===M.pending_buf_size){if(M.gzhead.hcrc&&M.pending>U&&(L.adler=lH(L.adler,M.pending_buf,M.pending-U,U)),ZH(L),0!==M.pending)return M.last_flush=-1,v9;U=0}k=M.gzindex<M.gzhead.comment.length?255&M.gzhead.comment.charCodeAt(M.gzindex++):0,$H(M,k)}while(0!==k);M.gzhead.hcrc&&M.pending>U&&(L.adler=lH(L.adler,M.pending_buf,M.pending-U,U))}M.status=103}if(103===M.status){if(M.gzhead.hcrc){if(M.pending+2>M.pending_buf_size&&(ZH(L),0!==M.pending))return M.last_flush=-1,v9;$H(M,255&L.adler),$H(M,L.adler>>8&255),L.adler=0}if(M.status=113,ZH(L),0!==M.pending)return M.last_flush=-1,v9}if(0!==L.avail_in||0!==M.lookahead||k!==v3&&666!==M.status){let U=0===M.level?rK(M,k):M.strategy===Cs?((L,k)=>{let M;for(;;){if(0===L.lookahead&&(nK(L),0===L.lookahead)){if(k===v3)return 1;break}if(L.match_length=0,M=v1(L,0,L.window[L.strstart]),L.lookahead--,L.strstart++,M&&(QH(L,!1),0===L.strm.avail_out))return 1}return L.insert=0,k===v6?(QH(L,!0),0===L.strm.avail_out?3:4):L.sym_next&&(QH(L,!1),0===L.strm.avail_out)?1:2})(M,k):M.strategy===Cd?((L,k)=>{let M,U,V,F;let B=L.window;for(;;){if(L.lookahead<=258){if(nK(L),L.lookahead<=258&&k===v3)return 1;if(0===L.lookahead)break}if(L.match_length=0,L.lookahead>=3&&L.strstart>0&&(U=B[V=L.strstart-1])===B[++V]&&U===B[++V]&&U===B[++V]){F=L.strstart+258;do;while(U===B[++V]&&U===B[++V]&&U===B[++V]&&U===B[++V]&&U===B[++V]&&U===B[++V]&&U===B[++V]&&U===B[++V]&&V<F);L.match_length=258-(F-V),L.match_length>L.lookahead&&(L.match_length=L.lookahead)}if(L.match_length>=3?(M=v1(L,1,L.match_length-3),L.lookahead-=L.match_length,L.strstart+=L.match_length,L.match_length=0):(M=v1(L,0,L.window[L.strstart]),L.lookahead--,L.strstart++),M&&(QH(L,!1),0===L.strm.avail_out))return 1}return L.insert=0,k===v6?(QH(L,!0),0===L.strm.avail_out?3:4):L.sym_next&&(QH(L,!1),0===L.strm.avail_out)?1:2})(M,k):Cm[M.level].func(M,k);if(3!==U&&4!==U||(M.status=666),1===U||3===U)return 0===L.avail_out&&(M.last_flush=-1),v9;if(2===U&&(k===v5?v2(M):k!==v8&&(v$(M,0,0,!1),k===v4&&(qH(M.head),0===M.lookahead&&(M.strstart=0,M.block_start=0,M.insert=0))),ZH(L),0===L.avail_out))return M.last_flush=-1,v9}return k!==v6?v9:M.wrap<=0?v7:(2===M.wrap?($H(M,255&L.adler),$H(M,L.adler>>8&255),$H(M,L.adler>>16&255),$H(M,L.adler>>24&255),$H(M,255&L.total_in),$H(M,L.total_in>>8&255),$H(M,L.total_in>>16&255),$H(M,L.total_in>>24&255)):(eK(M,L.adler>>>16),eK(M,65535&L.adler)),ZH(L),M.wrap>0&&(M.wrap=-M.wrap),0!==M.pending?v9:v7)},deflateEnd:L=>{if(lK(L))return Ce;let k=L.state.status;return L.state=null,113===k?YH(L,Ci):v9},deflateSetDictionary:(L,k)=>{let M=k.length;if(lK(L))return Ce;let U=L.state,V=U.wrap;if(2===V||1===V&&42!==U.status||U.lookahead)return Ce;if(1===V&&(L.adler=cH(L.adler,k,M,0)),U.wrap=0,M>=U.w_size){0===V&&(qH(U.head),U.strstart=0,U.block_start=0,U.insert=0);let L=new Uint8Array(U.w_size);L.set(k.subarray(M-U.w_size,M),0),k=L,M=U.w_size}let F=L.avail_in,B=L.next_in,j=L.input;for(L.avail_in=M,L.next_in=0,L.input=k,nK(U);U.lookahead>=3;){let L=U.strstart,k=U.lookahead-2;do U.ins_h=JH(U,U.ins_h,U.window[L+3-1]),U.prev[L&U.w_mask]=U.head[U.ins_h],U.head[U.ins_h]=L,L++;while(--k);U.strstart=L,U.lookahead=2,nK(U)}return U.strstart+=U.lookahead,U.block_start=U.strstart,U.insert=U.lookahead,U.lookahead=0,U.match_length=U.prev_length=2,U.match_available=0,L.next_in=B,L.input=j,L.avail_in=F,U.wrap=V,v9},deflateInfo:"pako deflate (from Nodeca project)"};let fK=(L,k)=>Object.prototype.hasOwnProperty.call(L,k);var CS={assign:function(L){let k=Array.prototype.slice.call(arguments,1);for(;k.length;){let M=k.shift();if(M){if("object"!=typeof M)throw TypeError(M+"must be non-object");for(let k in M)fK(M,k)&&(L[k]=M[k])}}return L},flattenChunks:L=>{let k=0;for(let M=0,U=L.length;M<U;M++)k+=L[M].length;let M=new Uint8Array(k);for(let k=0,U=0,V=L.length;k<V;k++){let V=L[k];M.set(V,U),U+=V.length}return M}};let Cg=!0;try{String.fromCharCode.apply(null,new Uint8Array(1))}catch(L){Cg=!1}let CT=new Uint8Array(256);for(let L=0;L<256;L++)CT[L]=L>=252?6:L>=248?5:L>=240?4:L>=224?3:L>=192?2:1;CT[254]=CT[254]=1;var CR={string2buf:L=>{if("function"==typeof TextEncoder&&TextEncoder.prototype.encode)return(new TextEncoder).encode(L);let k,M,U,V,F,B=L.length,j=0;for(V=0;V<B;V++)55296==(64512&(M=L.charCodeAt(V)))&&V+1<B&&56320==(64512&(U=L.charCodeAt(V+1)))&&(M=65536+(M-55296<<10)+(U-56320),V++),j+=M<128?1:M<2048?2:M<65536?3:4;for(k=new Uint8Array(j),F=0,V=0;F<j;V++)55296==(64512&(M=L.charCodeAt(V)))&&V+1<B&&56320==(64512&(U=L.charCodeAt(V+1)))&&(M=65536+(M-55296<<10)+(U-56320),V++),M<128?k[F++]=M:(M<2048?k[F++]=192|M>>>6:(M<65536?k[F++]=224|M>>>12:(k[F++]=240|M>>>18,k[F++]=128|M>>>12&63),k[F++]=128|M>>>6&63),k[F++]=128|63&M);return k},buf2string:(L,k)=>{let M,U;let V=k||L.length;if("function"==typeof TextDecoder&&TextDecoder.prototype.decode)return(new TextDecoder).decode(L.subarray(0,k));let F=Array(2*V);for(U=0,M=0;M<V;){let k=L[M++];if(k<128){F[U++]=k;continue}let B=CT[k];if(B>4)F[U++]=65533,M+=B-1;else{for(k&=2===B?31:3===B?15:7;B>1&&M<V;)k=k<<6|63&L[M++],B--;B>1?F[U++]=65533:k<65536?F[U++]=k:(k-=65536,F[U++]=55296|k>>10&1023,F[U++]=56320|1023&k)}}return((L,k)=>{if(k<65534&&L.subarray&&Cg)return String.fromCharCode.apply(null,L.length===k?L:L.subarray(0,k));let M="";for(let U=0;U<k;U++)M+=String.fromCharCode(L[U]);return M})(F,U)},utf8border:(L,k)=>{(k=k||L.length)>L.length&&(k=L.length);let M=k-1;for(;M>=0&&128==(192&L[M]);)M--;return M<0||0===M?k:M+CT[L[M]]>k?M:k}},vK=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0};let CI=Object.prototype.toString,{Z_NO_FLUSH:Cv,Z_SYNC_FLUSH:CC,Z_FULL_FLUSH:Cy,Z_FINISH:CN,Z_OK:CL,Z_STREAM_END:Ck,Z_DEFAULT_COMPRESSION:CM,Z_DEFAULT_STRATEGY:CU,Z_DEFLATED:CV}=vQ;function LK(L){this.options=CS.assign({level:CM,method:CV,chunkSize:16384,windowBits:15,memLevel:8,strategy:CU},L||{});let k=this.options;k.raw&&k.windowBits>0?k.windowBits=-k.windowBits:k.gzip&&k.windowBits>0&&k.windowBits<16&&(k.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new vK,this.strm.avail_out=0;let M=Cf.deflateInit2(this.strm,k.level,k.method,k.windowBits,k.memLevel,k.strategy);if(M!==CL)throw Error(vX[M]);if(k.header&&Cf.deflateSetHeader(this.strm,k.header),k.dictionary){let L;if(L="string"==typeof k.dictionary?CR.string2buf(k.dictionary):"[object ArrayBuffer]"===CI.call(k.dictionary)?new Uint8Array(k.dictionary):k.dictionary,(M=Cf.deflateSetDictionary(this.strm,L))!==CL)throw Error(vX[M]);this._dict_set=!0}}function kK(L,k){let M=new LK(k);if(M.push(L,!0),M.err)throw M.msg||vX[M.err];return M.result}LK.prototype.push=function(L,k){let M,U;let V=this.strm,F=this.options.chunkSize;if(this.ended)return!1;for(U=k===~~k?k:!0===k?CN:Cv,"string"==typeof L?V.input=CR.string2buf(L):"[object ArrayBuffer]"===CI.call(L)?V.input=new Uint8Array(L):V.input=L,V.next_in=0,V.avail_in=V.input.length;;)if(0===V.avail_out&&(V.output=new Uint8Array(F),V.next_out=0,V.avail_out=F),(U===CC||U===Cy)&&V.avail_out<=6)this.onData(V.output.subarray(0,V.next_out)),V.avail_out=0;else{if((M=Cf.deflate(V,U))===Ck)return V.next_out>0&&this.onData(V.output.subarray(0,V.next_out)),M=Cf.deflateEnd(this.strm),this.onEnd(M),this.ended=!0,M===CL;if(0!==V.avail_out){if(U>0&&V.next_out>0)this.onData(V.output.subarray(0,V.next_out)),V.avail_out=0;else if(0===V.avail_in)break}else this.onData(V.output)}return!0},LK.prototype.onData=function(L){this.chunks.push(L)},LK.prototype.onEnd=function(L){L===CL&&(this.result=CS.flattenChunks(this.chunks)),this.chunks=[],this.err=L,this.msg=this.strm.msg};var VK=function(L,k){let M,U,V,F,B,j,G,X,$,ee,et,ei,er,en,ea,eo,es,ec,ed,el,eu,eh,ep,e_;let eE=L.state;M=L.next_in,ep=L.input,U=M+(L.avail_in-5),V=L.next_out,e_=L.output,F=V-(k-L.avail_out),B=V+(L.avail_out-257),j=eE.dmax,G=eE.wsize,X=eE.whave,$=eE.wnext,ee=eE.window,et=eE.hold,ei=eE.bits,er=eE.lencode,en=eE.distcode,ea=(1<<eE.lenbits)-1,eo=(1<<eE.distbits)-1;e:do for(ei<15&&(et+=ep[M++]<<ei,ei+=8,et+=ep[M++]<<ei,ei+=8),es=er[et&ea];;){if(et>>>=ec=es>>>24,ei-=ec,0==(ec=es>>>16&255))e_[V++]=65535&es;else{if(!(16&ec)){if(0==(64&ec)){es=er[(65535&es)+(et&(1<<ec)-1)];continue}if(32&ec){eE.mode=16191;break e}L.msg="invalid literal/length code",eE.mode=16209;break e}for(ed=65535&es,(ec&=15)&&(ei<ec&&(et+=ep[M++]<<ei,ei+=8),ed+=et&(1<<ec)-1,et>>>=ec,ei-=ec),ei<15&&(et+=ep[M++]<<ei,ei+=8,et+=ep[M++]<<ei,ei+=8),es=en[et&eo];;){if(et>>>=ec=es>>>24,ei-=ec,!(16&(ec=es>>>16&255))){if(0==(64&ec)){es=en[(65535&es)+(et&(1<<ec)-1)];continue}L.msg="invalid distance code",eE.mode=16209;break e}if(el=65535&es,ei<(ec&=15)&&(et+=ep[M++]<<ei,(ei+=8)<ec&&(et+=ep[M++]<<ei,ei+=8)),(el+=et&(1<<ec)-1)>j){L.msg="invalid distance too far back",eE.mode=16209;break e}if(et>>>=ec,ei-=ec,el>(ec=V-F)){if((ec=el-ec)>X&&eE.sane){L.msg="invalid distance too far back",eE.mode=16209;break e}if(eu=0,eh=ee,0===$){if(eu+=G-ec,ec<ed){ed-=ec;do e_[V++]=ee[eu++];while(--ec);eu=V-el,eh=e_}}else if($<ec){if(eu+=G+$-ec,(ec-=$)<ed){ed-=ec;do e_[V++]=ee[eu++];while(--ec);if(eu=0,$<ed){ed-=ec=$;do e_[V++]=ee[eu++];while(--ec);eu=V-el,eh=e_}}}else if(eu+=$-ec,ec<ed){ed-=ec;do e_[V++]=ee[eu++];while(--ec);eu=V-el,eh=e_}for(;ed>2;)e_[V++]=eh[eu++],e_[V++]=eh[eu++],e_[V++]=eh[eu++],ed-=3;ed&&(e_[V++]=eh[eu++],ed>1&&(e_[V++]=eh[eu++]))}else{eu=V-el;do e_[V++]=e_[eu++],e_[V++]=e_[eu++],e_[V++]=e_[eu++],ed-=3;while(ed>2);ed&&(e_[V++]=e_[eu++],ed>1&&(e_[V++]=e_[eu++]))}break}}break}while(M<U&&V<B);M-=ed=ei>>3,ei-=ed<<3,et&=(1<<ei)-1,L.next_in=M,L.next_out=V,L.avail_in=M<U?U-M+5:5-(M-U),L.avail_out=V<B?B-V+257:257-(V-B),eE.hold=et,eE.bits=ei};let CB=new Uint16Array([3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0]),Cj=new Uint8Array([16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78]),CW=new Uint16Array([1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0]),CG=new Uint8Array([16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64]);var WK=(L,k,M,U,V,F,B,j)=>{let G=j.bits,X,$,ee,et,ei,er,en=0,ea=0,eo=0,es=0,ec=0,ed=0,el=0,eu=0,eh=0,ep=0,e_=null,eE=new Uint16Array(16),em=new Uint16Array(16),ef,eS,eT,eR=null;for(en=0;en<=15;en++)eE[en]=0;for(ea=0;ea<U;ea++)eE[k[M+ea]]++;for(ec=G,es=15;es>=1&&0===eE[es];es--);if(ec>es&&(ec=es),0===es)return V[F++]=20971520,V[F++]=20971520,j.bits=1,0;for(eo=1;eo<es&&0===eE[eo];eo++);for(ec<eo&&(ec=eo),eu=1,en=1;en<=15;en++)if(eu<<=1,(eu-=eE[en])<0)return -1;if(eu>0&&(0===L||1!==es))return -1;for(em[1]=0,en=1;en<15;en++)em[en+1]=em[en]+eE[en];for(ea=0;ea<U;ea++)0!==k[M+ea]&&(B[em[k[M+ea]]++]=ea);if(0===L?(e_=eR=B,er=20):1===L?(e_=CB,eR=Cj,er=257):(e_=CW,eR=CG,er=0),ep=0,ea=0,en=eo,ei=F,ed=ec,el=0,ee=-1,et=(eh=1<<ec)-1,1===L&&eh>852||2===L&&eh>592)return 1;for(;;){ef=en-el,B[ea]+1<er?(eS=0,eT=B[ea]):B[ea]>=er?(eS=eR[B[ea]-er],eT=e_[B[ea]-er]):(eS=96,eT=0),X=1<<en-el,eo=$=1<<ed;do V[ei+(ep>>el)+($-=X)]=ef<<24|eS<<16|eT|0;while(0!==$);for(X=1<<en-1;ep&X;)X>>=1;if(0!==X?(ep&=X-1,ep+=X):ep=0,ea++,0==--eE[en]){if(en===es)break;en=k[M+B[ea]]}if(en>ec&&(ep&et)!==ee){for(0===el&&(el=ec),ei+=eo,eu=1<<(ed=en-el);ed+el<es&&!((eu-=eE[ed+el])<=0);)ed++,eu<<=1;if(eh+=1<<ed,1===L&&eh>852||2===L&&eh>592)return 1;V[ee=ep&et]=ec<<24|ed<<16|ei-F|0}}return 0!==ep&&(V[ei+ep]=en-el<<24|4194304),j.bits=ec,0};let{Z_FINISH:CH,Z_BLOCK:CK,Z_TREES:CY,Z_OK:CJ,Z_STREAM_END:CX,Z_NEED_DICT:CQ,Z_STREAM_ERROR:CZ,Z_DATA_ERROR:C$,Z_MEM_ERROR:C0,Z_BUF_ERROR:C1,Z_DEFLATED:C2}=vQ,lY=L=>(L>>>24&255)+(L>>>8&65280)+((65280&L)<<8)+((255&L)<<24);function uY(){this.strm=null,this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new Uint16Array(320),this.work=new Uint16Array(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}let hY=L=>{if(!L)return 1;let k=L.state;return!k||k.strm!==L||k.mode<16180||k.mode>16211?1:0},pY=L=>{if(hY(L))return CZ;let k=L.state;return L.total_in=L.total_out=k.total=0,L.msg="",k.wrap&&(L.adler=1&k.wrap),k.mode=16180,k.last=0,k.havedict=0,k.flags=-1,k.dmax=32768,k.head=null,k.hold=0,k.bits=0,k.lencode=k.lendyn=new Int32Array(852),k.distcode=k.distdyn=new Int32Array(592),k.sane=1,k.back=-1,CJ},_Y=L=>{if(hY(L))return CZ;let k=L.state;return k.wsize=0,k.whave=0,k.wnext=0,pY(L)},EY=(L,k)=>{let M;if(hY(L))return CZ;let U=L.state;return k<0?(M=0,k=-k):(M=5+(k>>4),k<48&&(k&=15)),k&&(k<8||k>15)?CZ:(null!==U.window&&U.wbits!==k&&(U.window=null),U.wrap=M,U.wbits=k,_Y(L))},mY=(L,k)=>{if(!L)return CZ;let M=new uY;L.state=M,M.strm=L,M.window=null,M.mode=16180;let U=EY(L,k);return U!==CJ&&(L.state=null),U},C3,C5,C4=!0,TY=L=>{if(C4){C3=new Int32Array(512),C5=new Int32Array(32);let k=0;for(;k<144;)L.lens[k++]=8;for(;k<256;)L.lens[k++]=9;for(;k<280;)L.lens[k++]=7;for(;k<288;)L.lens[k++]=8;for(WK(1,L.lens,0,288,C3,0,L.work,{bits:9}),k=0;k<32;)L.lens[k++]=5;WK(2,L.lens,0,32,C5,0,L.work,{bits:5}),C4=!1}L.lencode=C3,L.lenbits=9,L.distcode=C5,L.distbits=5},RY=(L,k,M,U)=>{let V;let F=L.state;return null===F.window&&(F.wsize=1<<F.wbits,F.wnext=0,F.whave=0,F.window=new Uint8Array(F.wsize)),U>=F.wsize?(F.window.set(k.subarray(M-F.wsize,M),0),F.wnext=0,F.whave=F.wsize):((V=F.wsize-F.wnext)>U&&(V=U),F.window.set(k.subarray(M-U,M-U+V),F.wnext),(U-=V)?(F.window.set(k.subarray(M-U,M),0),F.wnext=U,F.whave=F.wsize):(F.wnext+=V,F.wnext===F.wsize&&(F.wnext=0),F.whave<F.wsize&&(F.whave+=V))),0};var C6={inflateReset:_Y,inflateReset2:EY,inflateResetKeep:pY,inflateInit:L=>mY(L,15),inflateInit2:mY,inflate:(L,k)=>{let M,U,V,F,B,j,G,X,$,ee,et,ei,er,en,ea,eo,es,ec,ed,el,eu,eh,ep,e_,eE=0,em=new Uint8Array(4),ef=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]);if(hY(L)||!L.output||!L.input&&0!==L.avail_in)return CZ;16191===(V=L.state).mode&&(V.mode=16192),G=L.next_out,B=L.output,$=L.avail_out,j=L.next_in,F=L.input,X=L.avail_in,ee=V.hold,et=V.bits,ei=X,er=$,e_=CJ;e:for(;;)switch(V.mode){case 16180:if(0===V.wrap){V.mode=16192;break}for(;et<16;){if(0===X)break e;X--,ee+=F[j++]<<et,et+=8}if(2&V.wrap&&35615===ee){0===V.wbits&&(V.wbits=15),V.check=0,em[0]=255&ee,em[1]=ee>>>8&255,V.check=lH(V.check,em,2,0),ee=0,et=0,V.mode=16181;break}if(V.head&&(V.head.done=!1),!(1&V.wrap)||(((255&ee)<<8)+(ee>>8))%31){L.msg="incorrect header check",V.mode=16209;break}if((15&ee)!==C2){L.msg="unknown compression method",V.mode=16209;break}if(ee>>>=4,et-=4,ep=8+(15&ee),0===V.wbits&&(V.wbits=ep),ep>15||ep>V.wbits){L.msg="invalid window size",V.mode=16209;break}V.dmax=1<<V.wbits,V.flags=0,L.adler=V.check=1,V.mode=512&ee?16189:16191,ee=0,et=0;break;case 16181:for(;et<16;){if(0===X)break e;X--,ee+=F[j++]<<et,et+=8}if(V.flags=ee,(255&vN(V))!==C2){L.msg="unknown compression method",V.mode=16209;break}if(57344&vN(V)){L.msg="unknown header flags set",V.mode=16209;break}V.head&&(V.head.text=ee>>8&1),512&vN(V)&&4&V.wrap&&(em[0]=255&ee,em[1]=ee>>>8&255,V.check=lH(V.check,em,2,0)),ee=0,et=0,V.mode=16182;case 16182:for(;et<32;){if(0===X)break e;X--,ee+=F[j++]<<et,et+=8}V.head&&(V.head.time=ee),512&vN(V)&&4&V.wrap&&(em[0]=255&ee,em[1]=ee>>>8&255,em[2]=ee>>>16&255,em[3]=ee>>>24&255,V.check=lH(V.check,em,4,0)),ee=0,et=0,V.mode=16183;case 16183:for(;et<16;){if(0===X)break e;X--,ee+=F[j++]<<et,et+=8}V.head&&(V.head.xflags=255&ee,V.head.os=ee>>8),512&vN(V)&&4&V.wrap&&(em[0]=255&ee,em[1]=ee>>>8&255,V.check=lH(V.check,em,2,0)),ee=0,et=0,V.mode=16184;case 16184:if(1024&vN(V)){for(;et<16;){if(0===X)break e;X--,ee+=F[j++]<<et,et+=8}V.length=ee,V.head&&(V.head.extra_len=ee),512&vN(V)&&4&V.wrap&&(em[0]=255&ee,em[1]=ee>>>8&255,V.check=lH(V.check,em,2,0)),ee=0,et=0}else V.head&&(V.head.extra=null);V.mode=16185;case 16185:if(1024&vN(V)&&((en=V.length)>X&&(en=X),en&&(V.head&&(ep=V.head.extra_len-V.length,V.head.extra||(V.head.extra=new Uint8Array(V.head.extra_len)),V.head.extra.set(F.subarray(j,j+en),ep)),512&vN(V)&&4&V.wrap&&(V.check=lH(V.check,F,en,j)),X-=en,j+=en,V.length-=en),V.length))break e;V.length=0,V.mode=16186;case 16186:if(2048&vN(V)){if(0===X)break e;en=0;do ep=F[j+en++],V.head&&ep&&V.length<65536&&(V.head.name+=String.fromCharCode(ep));while(ep&&en<X);if(512&vN(V)&&4&V.wrap&&(V.check=lH(V.check,F,en,j)),X-=en,j+=en,ep)break e}else V.head&&(V.head.name=null);V.length=0,V.mode=16187;case 16187:if(4096&vN(V)){if(0===X)break e;en=0;do ep=F[j+en++],V.head&&ep&&V.length<65536&&(V.head.comment+=String.fromCharCode(ep));while(ep&&en<X);if(512&vN(V)&&4&V.wrap&&(V.check=lH(V.check,F,en,j)),X-=en,j+=en,ep)break e}else V.head&&(V.head.comment=null);V.mode=16188;case 16188:if(512&vN(V)){for(;et<16;){if(0===X)break e;X--,ee+=F[j++]<<et,et+=8}if(4&V.wrap&&ee!==(65535&V.check)){L.msg="header crc mismatch",V.mode=16209;break}ee=0,et=0}V.head&&(V.head.hcrc=vN(V)>>9&1,V.head.done=!0),L.adler=V.check=0,V.mode=16191;break;case 16189:for(;et<32;){if(0===X)break e;X--,ee+=F[j++]<<et,et+=8}L.adler=V.check=lY(ee),ee=0,et=0,V.mode=16190;case 16190:if(0===V.havedict)return L.next_out=G,L.avail_out=$,L.next_in=j,L.avail_in=X,V.hold=ee,V.bits=et,CQ;L.adler=V.check=1,V.mode=16191;case 16191:if(k===CK||k===CY)break e;case 16192:if(V.last){ee>>>=7&et,et-=7&et,V.mode=16206;break}for(;et<3;){if(0===X)break e;X--,ee+=F[j++]<<et,et+=8}switch(V.last=1&ee,et-=1,3&(ee>>>=1)){case 0:V.mode=16193;break;case 1:if(TY(V),V.mode=16199,k===CY){ee>>>=2,et-=2;break e}break;case 2:V.mode=16196;break;case 3:L.msg="invalid block type",V.mode=16209}ee>>>=2,et-=2;break;case 16193:for(ee>>>=7&et,et-=7&et;et<32;){if(0===X)break e;X--,ee+=F[j++]<<et,et+=8}if((65535&ee)!=(ee>>>16^65535)){L.msg="invalid stored block lengths",V.mode=16209;break}if(V.length=65535&ee,ee=0,et=0,V.mode=16194,k===CY)break e;case 16194:V.mode=16195;case 16195:if(en=V.length){if(en>X&&(en=X),en>$&&(en=$),0===en)break e;B.set(F.subarray(j,j+en),G),X-=en,j+=en,$-=en,G+=en,V.length-=en;break}V.mode=16191;break;case 16196:for(;et<14;){if(0===X)break e;X--,ee+=F[j++]<<et,et+=8}if(V.nlen=257+(31&ee),ee>>>=5,et-=5,V.ndist=1+(31&ee),ee>>>=5,et-=5,V.ncode=4+(15&ee),ee>>>=4,et-=4,V.nlen>286||V.ndist>30){L.msg="too many length or distance symbols",V.mode=16209;break}V.have=0,V.mode=16197;case 16197:for(;V.have<V.ncode;){for(;et<3;){if(0===X)break e;X--,ee+=F[j++]<<et,et+=8}V.lens[ef[V.have++]]=7&ee,ee>>>=3,et-=3}for(;V.have<19;)V.lens[ef[V.have++]]=0;if(V.lencode=V.lendyn,V.lenbits=7,M={bits:V.lenbits},e_=WK(0,V.lens,0,19,V.lencode,0,V.work,M),V.lenbits=M.bits,e_){L.msg="invalid code lengths set",V.mode=16209;break}V.have=0,V.mode=16198;case 16198:for(;V.have<V.nlen+V.ndist;){for(;es=(eE=V.lencode[ee&(1<<V.lenbits)-1])>>>24,ec=eE>>>16&255,ed=65535&eE,!(es<=et);){if(0===X)break e;X--,ee+=F[j++]<<et,et+=8}if(ed<16)ee>>>=es,et-=es,V.lens[V.have++]=ed;else{if(16===ed){for(U=es+2;et<U;){if(0===X)break e;X--,ee+=F[j++]<<et,et+=8}if(ee>>>=es,et-=es,0===V.have){L.msg="invalid bit length repeat",V.mode=16209;break}ep=V.lens[V.have-1],en=3+(3&ee),ee>>>=2,et-=2}else if(17===ed){for(U=es+3;et<U;){if(0===X)break e;X--,ee+=F[j++]<<et,et+=8}ee>>>=es,et-=es,ep=0,en=3+(7&ee),ee>>>=3,et-=3}else{for(U=es+7;et<U;){if(0===X)break e;X--,ee+=F[j++]<<et,et+=8}ee>>>=es,et-=es,ep=0,en=11+(127&ee),ee>>>=7,et-=7}if(V.have+en>V.nlen+V.ndist){L.msg="invalid bit length repeat",V.mode=16209;break}for(;en--;)V.lens[V.have++]=ep}}if(16209===V.mode)break;if(0===V.lens[256]){L.msg="invalid code -- missing end-of-block",V.mode=16209;break}if(V.lenbits=9,M={bits:V.lenbits},e_=WK(1,V.lens,0,V.nlen,V.lencode,0,V.work,M),V.lenbits=M.bits,e_){L.msg="invalid literal/lengths set",V.mode=16209;break}if(V.distbits=6,V.distcode=V.distdyn,M={bits:V.distbits},e_=WK(2,V.lens,V.nlen,V.ndist,V.distcode,0,V.work,M),V.distbits=M.bits,e_){L.msg="invalid distances set",V.mode=16209;break}if(V.mode=16199,k===CY)break e;case 16199:V.mode=16200;case 16200:if(X>=6&&$>=258){L.next_out=G,L.avail_out=$,L.next_in=j,L.avail_in=X,V.hold=ee,V.bits=et,VK(L,er),G=L.next_out,B=L.output,$=L.avail_out,j=L.next_in,F=L.input,X=L.avail_in,ee=V.hold,et=V.bits,16191===V.mode&&(V.back=-1);break}for(V.back=0;es=(eE=V.lencode[ee&(1<<V.lenbits)-1])>>>24,ec=eE>>>16&255,ed=65535&eE,!(es<=et);){if(0===X)break e;X--,ee+=F[j++]<<et,et+=8}if(ec&&0==(240&ec)){for(el=es,eu=ec,eh=ed;es=(eE=V.lencode[eh+((ee&(1<<el+eu)-1)>>el)])>>>24,ec=eE>>>16&255,ed=65535&eE,!(el+es<=et);){if(0===X)break e;X--,ee+=F[j++]<<et,et+=8}ee>>>=el,et-=el,V.back+=el}if(ee>>>=es,et-=es,V.back+=es,V.length=ed,0===ec){V.mode=16205;break}if(32&ec){V.back=-1,V.mode=16191;break}if(64&ec){L.msg="invalid literal/length code",V.mode=16209;break}V.extra=15&ec,V.mode=16201;case 16201:if(V.extra){for(U=V.extra;et<U;){if(0===X)break e;X--,ee+=F[j++]<<et,et+=8}V.length+=ee&(1<<V.extra)-1,ee>>>=V.extra,et-=V.extra,V.back+=V.extra}V.was=V.length,V.mode=16202;case 16202:for(;es=(eE=V.distcode[ee&(1<<V.distbits)-1])>>>24,ec=eE>>>16&255,ed=65535&eE,!(es<=et);){if(0===X)break e;X--,ee+=F[j++]<<et,et+=8}if(0==(240&ec)){for(el=es,eu=ec,eh=ed;es=(eE=V.distcode[eh+((ee&(1<<el+eu)-1)>>el)])>>>24,ec=eE>>>16&255,ed=65535&eE,!(el+es<=et);){if(0===X)break e;X--,ee+=F[j++]<<et,et+=8}ee>>>=el,et-=el,V.back+=el}if(ee>>>=es,et-=es,V.back+=es,64&ec){L.msg="invalid distance code",V.mode=16209;break}V.offset=ed,V.extra=15&ec,V.mode=16203;case 16203:if(V.extra){for(U=V.extra;et<U;){if(0===X)break e;X--,ee+=F[j++]<<et,et+=8}V.offset+=ee&(1<<V.extra)-1,ee>>>=V.extra,et-=V.extra,V.back+=V.extra}if(V.offset>V.dmax){L.msg="invalid distance too far back",V.mode=16209;break}V.mode=16204;case 16204:if(0===$)break e;if(en=er-$,V.offset>en){if((en=V.offset-en)>V.whave&&V.sane){L.msg="invalid distance too far back",V.mode=16209;break}en>V.wnext?(en-=V.wnext,ea=V.wsize-en):ea=V.wnext-en,en>V.length&&(en=V.length),eo=V.window}else eo=B,ea=G-V.offset,en=V.length;en>$&&(en=$),$-=en,V.length-=en;do B[G++]=eo[ea++];while(--en);0===V.length&&(V.mode=16200);break;case 16205:if(0===$)break e;B[G++]=V.length,$--,V.mode=16200;break;case 16206:if(V.wrap){for(;et<32;){if(0===X)break e;X--,ee|=F[j++]<<et,et+=8}if(er-=$,L.total_out+=er,V.total+=er,4&V.wrap&&er&&(L.adler=V.check=vN(V)?lH(V.check,B,er,G-er):cH(V.check,B,er,G-er)),er=$,4&V.wrap&&(vN(V)?ee:lY(ee))!==V.check){L.msg="incorrect data check",V.mode=16209;break}ee=0,et=0}V.mode=16207;case 16207:if(V.wrap&&vN(V)){for(;et<32;){if(0===X)break e;X--,ee+=F[j++]<<et,et+=8}if(4&V.wrap&&ee!==(4294967295&V.total)){L.msg="incorrect length check",V.mode=16209;break}ee=0,et=0}V.mode=16208;case 16208:e_=CX;break e;case 16209:e_=C$;break e;case 16210:return C0;default:return CZ}return L.next_out=G,L.avail_out=$,L.next_in=j,L.avail_in=X,V.hold=ee,V.bits=et,(V.wsize||er!==L.avail_out&&V.mode<16209&&(V.mode<16206||k!==CH))&&RY(L,L.output,L.next_out,er-L.avail_out),ei-=L.avail_in,er-=L.avail_out,L.total_in+=ei,L.total_out+=er,V.total+=er,4&V.wrap&&er&&(L.adler=V.check=vN(V)?lH(V.check,B,er,L.next_out-er):cH(V.check,B,er,L.next_out-er)),L.data_type=V.bits+(V.last?64:0)+(16191===V.mode?128:0)+(16199===V.mode||16194===V.mode?256:0),(0===ei&&0===er||k===CH)&&e_===CJ&&(e_=C1),e_},inflateEnd:L=>{if(hY(L))return CZ;let k=L.state;return k.window&&(k.window=null),L.state=null,CJ},inflateGetHeader:(L,k)=>{if(hY(L))return CZ;let M=L.state;return 0==(2&M.wrap)?CZ:(M.head=k,k.done=!1,CJ)},inflateSetDictionary:(L,k)=>{let M;let U=k.length;return hY(L)?CZ:0!==(M=L.state).wrap&&16190!==M.mode?CZ:16190===M.mode&&cH(1,k,U,0)!==M.check?C$:RY(L,k,U,U)?(M.mode=16210,C0):(M.havedict=1,CJ)},inflateInfo:"pako inflate (from Nodeca project)"},yY=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1};let C8=Object.prototype.toString,{Z_NO_FLUSH:C9,Z_FINISH:C7,Z_OK:ye,Z_STREAM_END:yt,Z_NEED_DICT:yi,Z_STREAM_ERROR:yr,Z_DATA_ERROR:yn,Z_MEM_ERROR:ya}=vQ;function kY(L){this.options=CS.assign({chunkSize:65536,windowBits:15,to:""},L||{});let k=this.options;k.raw&&k.windowBits>=0&&k.windowBits<16&&(k.windowBits=-k.windowBits,0===k.windowBits&&(k.windowBits=-15)),!(k.windowBits>=0&&k.windowBits<16)||L&&L.windowBits||(k.windowBits+=32),k.windowBits>15&&k.windowBits<48&&0==(15&k.windowBits)&&(k.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new vK,this.strm.avail_out=0;let M=C6.inflateInit2(this.strm,k.windowBits);if(M!==ye||(this.header=new yY,C6.inflateGetHeader(this.strm,this.header),k.dictionary&&("string"==typeof k.dictionary?k.dictionary=CR.string2buf(k.dictionary):"[object ArrayBuffer]"===C8.call(k.dictionary)&&(k.dictionary=new Uint8Array(k.dictionary)),k.raw&&(M=C6.inflateSetDictionary(this.strm,k.dictionary))!==ye)))throw Error(vX[M])}function MY(L,k){let M=new kY(k);if(M.push(L),M.err)throw M.msg||vX[M.err];return M.result}kY.prototype.push=function(L,k){let M,U,V;let F=this.strm,B=this.options.chunkSize,j=this.options.dictionary;if(this.ended)return!1;for(U=k===~~k?k:!0===k?C7:C9,"[object ArrayBuffer]"===C8.call(L)?F.input=new Uint8Array(L):F.input=L,F.next_in=0,F.avail_in=F.input.length;;){for(0===F.avail_out&&(F.output=new Uint8Array(B),F.next_out=0,F.avail_out=B),(M=C6.inflate(F,U))===yi&&j&&((M=C6.inflateSetDictionary(F,j))===ye?M=C6.inflate(F,U):M===yn&&(M=yi));F.avail_in>0&&M===yt&&F.state.wrap>0&&0!==L[F.next_in];)C6.inflateReset(F),M=C6.inflate(F,U);switch(M){case yr:case yn:case yi:case ya:return this.onEnd(M),this.ended=!0,!1}if(V=F.avail_out,F.next_out&&(0===F.avail_out||M===yt)){if("string"===this.options.to){let L=CR.utf8border(F.output,F.next_out),k=F.next_out-L,M=CR.buf2string(F.output,L);F.next_out=k,F.avail_out=B-k,k&&F.output.set(F.output.subarray(L,L+k),0),this.onData(M)}else this.onData(F.output.length===F.next_out?F.output:F.output.subarray(0,F.next_out))}if(M!==ye||0!==V){if(M===yt)return M=C6.inflateEnd(this.strm),this.onEnd(M),this.ended=!0,!0;if(0===F.avail_in)break}}return!0},kY.prototype.onData=function(L){this.chunks.push(L)},kY.prototype.onEnd=function(L){L===ye&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=CS.flattenChunks(this.chunks)),this.chunks=[],this.err=L,this.msg=this.strm.msg};let{Deflate:yo,deflate:ys,deflateRaw:yc,gzip:yd}={Deflate:LK,deflate:kK,deflateRaw:function(L,k){return(k=k||{}).raw=!0,kK(L,k)},gzip:function(L,k){return(k=k||{}).gzip=!0,kK(L,k)},constants:vQ},{Inflate:yl,inflate:yh,inflateRaw:yp,ungzip:y_}={Inflate:kY,inflate:MY,inflateRaw:function(L,k){return(k=k||{}).raw=!0,MY(L,k)},ungzip:MY,constants:vQ};var ym=((t7=ym||{})[t7.ONE_BYTE=0]="ONE_BYTE",t7[t7.TWO_BYTE=1]="TWO_BYTE",t7);let qY=class qY{constructor(){uI(this,"_sequence",0),uI(this,"_startTime",Date.now()),uI(this,"isUseOneByte",!0)}get startTime(){let L=Date.now()-this._startTime;return L<65536?L:(this._startTime+=65536,this.startTime)}get sequence(){return this._sequence<4294967296?this._sequence++:(this._sequence-=4294967296,this.sequence)}serialize(L){let k={commonPacketHeader:{length:0,reserved:0,extension:0,sequence:this.sequence},commonStreamHeader:this.startTime,extension:void 0,payload:L};if(L.byteLength>128){let M=new Uint8Array(4);M.set([1,0,0,0]);let U={id:0,length:4,data:M.buffer},V={profile:this.isUseOneByte?0:1,length:this.isUseOneByte?5:6,datas:[U]};k.commonPacketHeader.extension=1,k.extension=V,k.payload=this.compress(L),k.commonPacketHeader.length=8+(k.extension.length+2)+k.payload.byteLength}else k.commonPacketHeader.length=8+k.payload.byteLength;wN("SHOW_DATASTREAM2_LOG")&&gc.debug("send data header: ".concat(JSON.stringify(k.commonPacketHeader)));let M=new ArrayBuffer(k.commonPacketHeader.length),U=new Uint8Array(M),V=new DataView(M),F=0;if(V.setUint16(F,k.commonPacketHeader.extension<<15|k.commonPacketHeader.reserved<<14|k.commonPacketHeader.length,!0),F+=2,V.setUint32(F,k.commonPacketHeader.sequence,!0),F+=4,V.setUint16(F,k.commonStreamHeader,!0),F+=2,k.extension){let L=this.serializeExtension(k.extension);U.set(new Uint8Array(L),F),F+=L.byteLength}if(U.set(new Uint8Array(k.payload),F),(F+=k.payload.byteLength)!==k.commonPacketHeader.length)throw Error("serialize error!");return M}deserialize(L){let k,M;if(L.byteLength<4)return new ArrayBuffer(0);let U=new DataView(L),V=0,F=U.getUint16(V,!0);V+=2;let B={length:16383&F,reserved:(16384&F)>>14,extension:(32768&F)>>15,sequence:U.getUint16(V+2,!0)<<16|U.getUint16(V,!0)};if(V+=4,wN("SHOW_DATASTREAM2_LOG")&&gc.debug("receive data header: ".concat(JSON.stringify(B))),U.getUint16(V,!0),V+=2,B.extension){M=this.deserializeExtension(L.slice(V)),V+=2+M.length,k=L.slice(V);let U=!1;if(M.datas.length>0){let L=M.datas.find(L=>0===L.id);L&&(U=1==(1&new DataView(L.data).getUint32(0,!0)))}k=U?this.decompress(k):k}else k=L.slice(8);return k}serializeExtension(L){let{profile:k,length:M,datas:U}=L,V=new ArrayBuffer(M+2),F=new Uint8Array(V),B=new DataView(V),j=0;if(B.setUint8(j++,k),B.setUint8(j++,M),U.forEach(L=>{k?(B.setUint8(j++,L.id),B.setUint8(j++,L.length)):B.setUint8(j++,L.id|L.length<<4),F.set(new Uint8Array(L.data),j),j+=L.data.byteLength}),j!==M+2)throw Error("serialize extension error, is ".concat(j,"!==").concat(M+2));return V}deserializeExtension(L){let k=new DataView(L),M=0,U=k.getUint8(M);M++;let V=k.getUint8(M);M++;let F=U===ym.TWO_BYTE,B=[],j=new DataView(L,2),G=0;for(;G<V;){let L=0,k=0,M=new ArrayBuffer(0);F?(L=j.getUint8(G),G++,k=j.getUint8(G)):(L=15&j.getUint8(G),k=j.getUint8(G)>>4),G++,k>0&&(M=j.buffer.slice(G+2,G+2+k),G+=M.byteLength),B.push({id:L,length:k,data:M})}if(G!==V)throw Error("parse error");return{profile:U,length:V,datas:B}}decompress(L){return yh(new Uint8Array(L))}compress(L){return ys(new Uint8Array(L))}};let JY=class JY extends Hw{constructor(L,k,M){super(),uI(this,"ws",void 0),uI(this,"requestId",1),uI(this,"heartBeatTimer",void 0),uI(this,"joinInfo",void 0),uI(this,"clientId",void 0),uI(this,"onOpen",()=>{this.emit("open"),this.startHeartBeatCheck()}),uI(this,"onClose",L=>{this.emit("close"),this.dispose()}),uI(this,"onMessage",L=>{let k=JSON.parse(L.data);if(!k||"serverResponse"!==k.command||!k.requestId)return k&&"serverStatus"===k.command&&k.serverStatus&&k.serverStatus.command?(this.emit("status",k.serverStatus),void this.emit(k.serverStatus.command,k.serverStatus)):void 0;this.emit("req_".concat(k.requestId),k)}),this.joinInfo=L,this.clientId=k,this.ws=new JV("cross-channel-".concat(this.clientId),M),this.ws.on(RI.RECONNECTING,()=>{this.ws.reconnectMode="retry",this.emit("reconnecting")}),this.ws.on(RI.CONNECTED,this.onOpen),this.ws.on(RI.ON_MESSAGE,this.onMessage),this.ws.on(RI.CLOSED,this.onClose)}isConnect(){return"connected"===this.ws.state}sendMessage(L){let k=this.requestId++;return L.requestId=k,L.seq=k,this.ws.sendMessage(L),k}waitStatus(L){return new lQ((k,M)=>{let U=window.setTimeout(()=>{M(new ED(f1.TIMEOUT,"wait status timeout, status: ".concat(L)))},5e3);this.once(L,V=>{window.clearTimeout(U),V.state&&0!==V.state?M(new ED(f1.CROSS_CHANNEL_WAIT_STATUS_ERROR,"wait status error, status: ".concat(L))):k(void 0)}),this.once("dispose",()=>{window.clearTimeout(U),M(new ED(f1.WS_ABORT))})})}async request(L){if("closed"===this.ws.state)throw new ED(f1.WS_DISCONNECT);"connected"!==this.ws.state&&await new lQ((L,k)=>{this.ws.once(RI.CLOSED,()=>k(new ED(f1.WS_ABORT))),this.ws.once(RI.CONNECTED,L)});let k=this.sendMessage(L),M=new lQ((L,M)=>{let n=()=>{M(new ED(f1.WS_ABORT))};this.ws.once(RI.RECONNECTING,n),this.ws.once(RI.CLOSED,n),this.once("req_".concat(k),L),yO(3e3).then(()=>{this.removeAllListeners("req_".concat(k)),this.ws.off(RI.RECONNECTING,n),this.ws.off(RI.CLOSED,n),M(new ED(f1.TIMEOUT,"cross channel ws request timeout"))})}),U=await M;if(!U||200!==U.code)throw new ED(f1.CROSS_CHANNEL_SERVER_ERROR_RESPONSE,"response: ".concat(JSON.stringify(U)));return U}async connect(L){this.ws.removeAllListeners(RI.REQUEST_NEW_URLS),this.ws.on(RI.REQUEST_NEW_URLS,k=>{k(L)}),await this.ws.init(L)}dispose(){this.clearHeartBeatCheck(),this.emit("dispose"),this.removeAllListeners(),this.ws.close()}sendPing(L){let k=this.requestId++;return L.requestId=k,this.ws.sendMessage(L),k}startHeartBeatCheck(){this.heartBeatTimer&&window.clearInterval(this.heartBeatTimer),this.heartBeatTimer=window.setInterval(()=>{this.sendPing({command:"ping",appId:this.joinInfo.appId,cname:this.joinInfo.cname,uid:this.joinInfo.uid.toString(),sid:this.joinInfo.sid,ts:+new Date,requestId:0})},3e3)}clearHeartBeatCheck(){window.clearInterval(this.heartBeatTimer),this.heartBeatTimer=void 0}};let ZY=class ZY extends Hw{set state(L){L!==this._state&&(L!==RV.RELAY_STATE_FAILURE&&(this.errorCode=Rj.RELAY_OK),this.emit("state",L,this.errorCode),this._state=L)}get state(){return this._state}constructor(L,k,M,U,V){super(),uI(this,"joinInfo",void 0),uI(this,"sid",void 0),uI(this,"clientId",void 0),uI(this,"cancelToken",fG.CancelToken.source()),uI(this,"workerToken",void 0),uI(this,"requestId",0),uI(this,"signal",void 0),uI(this,"prevChannelMediaConfig",void 0),uI(this,"httpRetryConfig",void 0),uI(this,"_resolution",void 0),uI(this,"_state",RV.RELAY_STATE_IDLE),uI(this,"errorCode",Rj.RELAY_OK),uI(this,"onStatus",L=>{gc.debug("[".concat(this.clientId,"] ChannelMediaStatus: ").concat(JSON.stringify(L))),L&&L.command&&("onAudioPacketReceived"===L.command&&this.emit("event",RU.PACKET_RECEIVED_AUDIO_FROM_SRC),"onVideoPacketReceived"===L.command&&this.emit("event",RU.PACKET_RECEIVED_VIDEO_FROM_SRC),"onSrcTokenPrivilegeDidExpire"===L.command&&(this.errorCode=Rj.SRC_TOKEN_EXPIRED,this.state=RV.RELAY_STATE_FAILURE),"onDestTokenPrivilegeDidExpire"===L.command&&(this.errorCode=Rj.DEST_TOKEN_EXPIRED,this.state=RV.RELAY_STATE_FAILURE))}),uI(this,"onReconnect",async()=>{gc.debug("[".concat(this.clientId,"] ChannelMediaSocket disconnect, reconnecting")),this.emit("event",RU.NETWORK_DISCONNECTED),this.state=RV.RELAY_STATE_IDLE,this.prevChannelMediaConfig&&this.sendStartRelayMessage(this.prevChannelMediaConfig).catch(L=>{this.state!==RV.RELAY_STATE_IDLE&&(gc.error("auto restart channel media relay failed",L.toString()),this.errorCode=Rj.SERVER_CONNECTION_LOST,this.state=RV.RELAY_STATE_FAILURE)})}),this.joinInfo=L,this.clientId=k,this.sid=bO(),this.signal=new JY(this.joinInfo,this.clientId,M),this.httpRetryConfig=U,this._resolution=V}async startChannelMediaRelay(L){if(this.state!==RV.RELAY_STATE_IDLE)throw new ED(f1.INVALID_OPERATION);this.state=RV.RELAY_STATE_CONNECTING,await this.connect(),gc.debug("[".concat(this.clientId,"] startChannelMediaRelay: connect success"));try{await this.sendStartRelayMessage(L)}catch(L){if(L.data&&L.data.serverResponse&&"SetSourceChannel"===L.data.serverResponse.command)throw new ED(f1.CROSS_CHANNEL_FAILED_JOIN_SRC);if(L.data&&L.data.serverResponse&&"SetDestChannelStatus"===L.serverResponse.command)throw new ED(f1.CROSS_CHANNEL_FAILED_JOIN_DEST);if(L.data&&L.data.serverResponse&&"StartPacketTransfer"===L.serverResponse.command)throw new ED(f1.CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST);throw L}this.prevChannelMediaConfig=L}async updateChannelMediaRelay(L){if(this.state!==RV.RELAY_STATE_RUNNING)throw new ED(f1.INVALID_OPERATION);await this.sendUpdateMessage(L),this.prevChannelMediaConfig=L}async setVideoProfile(L){if(this._resolution=L,this.state!==RV.RELAY_STATE_RUNNING)throw new ED(f1.INVALID_OPERATION);let k=this.genMessage(Rk.SetVideoProfile);await this.signal.request(k),gc.debug("[".concat(this.clientId,"] startChannelMediaRelay: setVideoProfile success"))}async stopChannelMediaRelay(){await this.sendStopRelayMessage(),gc.debug("[".concat(this.clientId,"] stopChannelMediaRelay: send stop message success")),this.state=RV.RELAY_STATE_IDLE,this.dispose()}dispose(){gc.debug("[".concat(this.clientId,"] disposeChannelMediaRelay")),this.cancelToken.cancel(),this.cancelToken=fG.CancelToken.source(),this.state=RV.RELAY_STATE_IDLE,this.emit("dispose"),this.signal.dispose(),this.prevChannelMediaConfig=void 0}async connect(){let L=await FF(this.joinInfo,this.cancelToken.token,this.httpRetryConfig);this.workerToken=L.workerToken,await this.signal.connect(L.addressList),this.emit("event",RU.NETWORK_CONNECTED),this.signal.on("status",this.onStatus),this.signal.on("reconnecting",this.onReconnect)}async sendStartRelayMessage(L){let k=this.genMessage(Rk.StopPacketTransfer);await this.signal.request(k),await this.signal.waitStatus("Normal Quit"),gc.debug("[".concat(this.clientId,"] startChannelMediaRelay: StopPacketTransfer success"));let M=this.genMessage(Rk.SetSdkProfile,L);await this.signal.request(M),gc.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSdkProfile success"));let U=this.genMessage(Rk.SetSourceChannel,L);await this.signal.request(U),await this.signal.waitStatus("SetSourceChannelStatus"),this.emit("event",RU.PACKET_JOINED_SRC_CHANNEL),gc.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSourceChannel success"));let V=this.genMessage(Rk.SetSourceUserId,L);await this.signal.request(V),gc.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSourceUserId success"));let F=this.genMessage(Rk.SetDestChannel,L);await this.signal.request(F),await this.signal.waitStatus("SetDestChannelStatus"),this.emit("event",RU.PACKET_JOINED_DEST_CHANNEL),gc.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetDestChannel success"));let B=this.genMessage(Rk.StartPacketTransfer,L);await this.signal.request(B),this.emit("event",RU.PACKET_SENT_TO_DEST_CHANNEL),this.state=RV.RELAY_STATE_RUNNING,gc.debug("[".concat(this.clientId,"] startChannelMediaRelay: StartPacketTransfer success")),this.setVideoProfile(this._resolution)}async sendUpdateMessage(L){let k=this.genMessage(Rk.UpdateDestChannel,L);await this.signal.request(k),this.emit("event",RU.PACKET_UPDATE_DEST_CHANNEL),gc.debug("[".concat(this.clientId,"] sendUpdateMessage: UpdateDestChannel success"))}async sendStopRelayMessage(){let L=this.genMessage(Rk.StopPacketTransfer);await this.signal.request(L),gc.debug("[".concat(this.clientId,"] sendStopRelayMessage: StopPacketTransfer success"))}genMessage(L,k){let M=[],U=[],V=[];this.requestId+=1;let F={appId:this.joinInfo.appId,cname:this.joinInfo.cname,uid:this.joinInfo.uid.toString(),sdkVersion:SJ,sid:this.sid,ts:Date.now(),requestId:this.requestId,seq:this.requestId,allocate:!0,clientRequest:{}};"4.24.0"===F.sdkVersion&&(F.sdkVersion="0.0.1");let B=null,j=null;switch(L){case Rk.SetSdkProfile:return F.clientRequest={command:"SetSdkProfile",type:"multi_channel"},F;case Rk.SetSourceChannel:if(!(j=k&&k.getSrcChannelMediaInfo()))throw new ED(f1.UNEXPECTED_ERROR,"can not find source config");return F.clientRequest={command:"SetSourceChannel",uid:"0",channelName:j.channelName,token:j.token||this.joinInfo.appId},F;case Rk.SetSourceUserId:if(!(j=k&&k.getSrcChannelMediaInfo()))throw new ED(f1.UNEXPECTED_ERROR,"can not find source config");return F.clientRequest={command:"SetSourceUserId",uid:j.uid+""},F;case Rk.SetDestChannel:if(!(B=k&&k.getDestChannelMediaInfo()))throw new ED(f1.UNEXPECTED_ERROR,"can not find dest config");return B.forEach(L=>{M.push(L.channelName),U.push(L.uid+""),V.push(L.token||this.joinInfo.appId)}),F.clientRequest={command:"SetDestChannel",channelName:M,uid:U,token:V},F;case Rk.StartPacketTransfer:return F.clientRequest={command:"StartPacketTransfer"},F;case Rk.Reconnect:return F.clientRequest={command:"Reconnect"},F;case Rk.StopPacketTransfer:return F.clientRequest={command:"StopPacketTransfer"},F;case Rk.UpdateDestChannel:if(!(B=k&&k.getDestChannelMediaInfo()))throw new ED(f1.UNEXPECTED_ERROR,"can not find dest config");return B.forEach(L=>{M.push(L.channelName),U.push(L.uid+""),V.push(L.token||this.joinInfo.appId)}),F.clientRequest={command:"UpdateDestChannel",channelName:M,uid:U,token:V},F;case Rk.SetVideoProfile:F.clientRequest={command:"SetVideoProfile",width:this._resolution.width,height:this._resolution.height}}return F}};function $Y(L,k){var M=Object.keys(L);if(Object.getOwnPropertySymbols){var U=Object.getOwnPropertySymbols(L);k&&(U=U.filter(function(k){return Object.getOwnPropertyDescriptor(L,k).enumerable})),M.push.apply(M,U)}return M}function ez(L){for(var k=1;k<arguments.length;k++){var M=null!=arguments[k]?arguments[k]:{};k%2?$Y(Object(M),!0).forEach(function(k){uI(L,k,M[k])}):Object.getOwnPropertyDescriptors?Object.defineProperties(L,Object.getOwnPropertyDescriptors(M)):$Y(Object(M)).forEach(function(k){Object.defineProperty(L,k,Object.getOwnPropertyDescriptor(M,k))})}return L}let tz=class tz extends Hw{constructor(L,k,M,U){super(),uI(this,"spec",void 0),uI(this,"token",void 0),uI(this,"websocket",void 0),uI(this,"pingpongTimer",void 0),uI(this,"reconnectMode","retry"),uI(this,"serviceMode",void 0),uI(this,"reqId",0),uI(this,"commandReqId",0),uI(this,"handleWebSocketOpen",()=>{this.reconnectMode="retry",this.startPingPong()}),uI(this,"handleWebSocketMessage",L=>{if(!L.data)return;let k=JSON.parse(L.data);k.requestId?this.emit("@".concat(k.requestId,"-").concat(k.sid),k):(g_.workerEvent(this.spec.sid,{actionType:"status",serverCode:k.code,workerType:this.serviceMode===Rv.TRANSCODE?1:2}),this.emit(Rb.PUBLISH_STREAM_STATUS,k))}),this.spec=k,this.token=L,this.serviceMode=U,this.websocket=new JV("live-streaming",M),this.websocket.on(RI.CONNECTED,this.handleWebSocketOpen),this.websocket.on(RI.ON_MESSAGE,this.handleWebSocketMessage),this.websocket.on(RI.REQUEST_NEW_URLS,(L,k)=>{oO(this,Rb.REQUEST_NEW_ADDRESS).then(L).catch(k)}),this.websocket.on(RI.RECONNECTING,()=>{this.websocket.reconnectMode=this.reconnectMode})}init(L){return this.websocket.init(L)}async request(L,k,M,U){this.reqId+=1,"request"===L&&(this.commandReqId+=1);let V=this.commandReqId,F=this.reqId;if(!F||!this.websocket)throw new ED(f1.UNEXPECTED_ERROR);let B=ez({command:L,sdkVersion:"4.24.0"===SJ?"0.0.1":SJ,seq:F,requestId:F,allocate:M,cname:this.spec.cname,appId:this.spec.appId,sid:this.spec.sid,uid:this.spec.uid.toString(),ts:Math.floor(Date.now()/1e3)},k);if("closed"===this.websocket.state)throw new ED(f1.WS_DISCONNECT);let a=()=>new lQ((L,k)=>{this.websocket.once(RI.CLOSED,()=>k(new ED(f1.WS_ABORT))),this.websocket.once(RI.CONNECTED,L)});"connected"!==this.websocket.state&&await a(),B.clientRequest&&(B.clientRequest.workerToken=this.token);let j=new lQ((L,k)=>{let i=()=>{k(new ED(f1.WS_ABORT))};this.websocket.once(RI.RECONNECTING,i),this.websocket.once(RI.CLOSED,i),this.once("@".concat(F,"-").concat(this.spec.sid),k=>{L(k)})});U&&g_.workerEvent(this.spec.sid,ez(ez({},U),{},{requestId:V,actionType:"request",payload:JSON.stringify(k.clientRequest),serverCode:0,code:0}));let G=Date.now();this.websocket.sendMessage(B);let X=null;try{X=await j}catch(U){if("closed"===this.websocket.state)throw U;return await a(),await this.request(L,k,M)}return U&&g_.workerEvent(this.spec.sid,ez(ez({},U),{},{requestId:V,actionType:"response",payload:JSON.stringify(X.serverResponse),serverCode:X.code,success:200===X.code,responseTime:Date.now()-G})),200!==X.code&&this.handleResponseError(X),X}tryNextAddress(){this.reconnectMode="tryNext",this.websocket.reconnect("tryNext")}close(){let L="4.24.0"===SJ?"0.0.1":SJ;this.reqId+=1,"connected"===this.websocket.state?(this.websocket.sendMessage({command:"request",appId:this.spec.appId,cname:this.spec.cname,uid:this.spec.uid.toString(),sdkVersion:L,sid:this.spec.sid,seq:this.reqId,ts:Math.floor(Date.now()/1e3),requestId:this.reqId,clientRequest:{command:"DestroyWorker"}}),this.websocket.close(!1,!0)):this.websocket.close(!1),this.pingpongTimer&&(window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0)}handleResponseError(L){switch(L.code){case RL.LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM:return void gc.warning("live stream response already exists stream");case RL.LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR:case RL.LIVE_STREAM_RESPONSE_BAD_STREAM:case RL.LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR:return new ED(f1.LIVE_STREAMING_INVALID_ARGUMENT,"",{code:L.code}).throw();case RL.LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST:if("UnpublishStream"===L.serverResponse.command)return;throw new ED(f1.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream response wm worker not exist",{retry:!0});case RL.LIVE_STREAM_RESPONSE_NOT_AUTHORIZED:return new ED(f1.LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED,"",{code:L.code}).throw();case RL.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE:{let k=new ED(f1.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE);return this.emit(Rb.WARNING,k,L.serverResponse.url)}case RL.LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN:{let k=new ED(f1.LIVE_STREAMING_WARN_FREQUENT_REQUEST);return this.emit(Rb.WARNING,k,L.serverResponse.url)}case RL.LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH:throw new ED(f1.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream response wm worker not exist",{retry:!0});case RL.LIVE_STREAM_RESPONSE_NOT_SUPPORTED:return new ED(f1.LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED,"",{code:L.code}).throw();case RL.LIVE_STREAM_RESPONSE_MAX_STREAM_NUM:{let k=new ED(f1.LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT);return this.emit(Rb.WARNING,k,L.serverResponse.url)}case RL.LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR:return new ED(f1.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"",{code:L.code}).throw();case RL.LIVE_STREAM_RESPONSE_RESOURCE_LIMIT:throw new ED(f1.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream resource limit",{retry:!0,changeAddress:!0});case RL.LIVE_STREAM_RESPONSE_WORKER_LOST:case RL.LIVE_STREAM_RESPONSE_WORKER_QUIT:if("UnpublishStream"===L.serverResponse.command)return;throw new ED(f1.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{retry:!0,changeAddress:!0});case RL.ERROR_FAIL_SEND_MESSAGE:if("UnpublishStream"===L.serverResponse.command)return;if("UpdateTranscoding"===L.serverResponse.command||"ControlStream"===L.serverResponse.command)return new ED(f1.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{code:L.code}).throw();throw new ED(f1.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{retry:!0,changeAddress:!0});case RL.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN:case RL.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT:case RL.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE:case RL.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH:return new ED(f1.LIVE_STREAMING_CDN_ERROR,"",{code:L.code}).throw()}}startPingPong(){this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(()=>{"connected"===this.websocket.state&&this.request("ping",{}).catch(AO)},6e3)}};function iz(L,k){var M=Object.keys(L);if(Object.getOwnPropertySymbols){var U=Object.getOwnPropertySymbols(L);k&&(U=U.filter(function(k){return Object.getOwnPropertyDescriptor(L,k).enumerable})),M.push.apply(M,U)}return M}function nz(L){for(var k=1;k<arguments.length;k++){var M=null!=arguments[k]?arguments[k]:{};k%2?iz(Object(M),!0).forEach(function(k){uI(L,k,M[k])}):Object.getOwnPropertyDescriptors?Object.defineProperties(L,Object.getOwnPropertyDescriptors(M)):iz(Object(M)).forEach(function(k){Object.defineProperty(L,k,Object.getOwnPropertyDescriptor(M,k))})}return L}let rz=class rz extends Hw{constructor(L){let k=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Sm,M=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Sm;super(),uI(this,"onLiveStreamWarning",void 0),uI(this,"onLiveStreamError",void 0),uI(this,"spec",void 0),uI(this,"retryTimeout",1e4),uI(this,"connection",void 0),uI(this,"httpRetryConfig",void 0),uI(this,"wsRetryConfig",void 0),uI(this,"streamingTasks",new Map),uI(this,"isStartingStreamingTask",!1),uI(this,"taskMutex",new S_("live-streaming")),uI(this,"cancelToken",fG.CancelToken.source()),uI(this,"transcodingConfig",void 0),uI(this,"uapResponse",void 0),uI(this,"lastTaskId",1),uI(this,"statusError",new Map),this.spec=L,this.httpRetryConfig=M,this.wsRetryConfig=k}async setTranscodingConfig(L){var k;let M=nz(nz({},RA),L);66!==M.videoCodecProfile&&77!==M.videoCodecProfile&&100!==M.videoCodecProfile&&(gc.debug("[".concat(this.spec.clientId,"] set transcoding config, fix video codec profile: ").concat(M.videoCodecProfile," -> 100")),M.videoCodecProfile=100),M.transcodingUsers||(M.transcodingUsers=M.userConfigs),M.transcodingUsers&&(M.transcodingUsers=M.transcodingUsers.map(L=>nz(nz(nz({},RC),L),{},{zOrder:L.zOrder?L.zOrder+1:1}))),Uw(M.width)||Pw(M.width,"config.width",0,1e4),Uw(M.height)||Pw(M.height,"config.height",0,1e4),Uw(M.videoBitrate)||Pw(M.videoBitrate,"config.videoBitrate",1,1e6),Uw(M.videoFrameRate)||Pw(M.videoFrameRate,"config.videoFrameRate"),Uw(M.lowLatency)||Nw(M.lowLatency,"config.lowLatency"),Uw(M.audioSampleRate)||Dw(M.audioSampleRate,"config.audioSampleRate",[32e3,44100,48e3]),Uw(M.audioBitrate)||Pw(M.audioBitrate,"config.audioBitrate",1,128),Uw(M.audioChannels)||Dw(M.audioChannels,"config.audioChannels",[1,2,3,4,5]),Uw(M.videoGop)||Pw(M.videoGop,"config.videoGop"),Uw(M.videoCodecProfile)||Dw(M.videoCodecProfile,"config.videoCodecProfile",[66,77,100]),Uw(M.userCount)||Pw(M.userCount,"config.userCount",0,17),Uw(M.backgroundColor)||Pw(M.backgroundColor,"config.backgroundColor",0,16777215),Uw(M.userConfigExtraInfo)||kw(M.userConfigExtraInfo,"config.userConfigExtraInfo",0,4096,!1),M.transcodingUsers&&!Uw(M.transcodingUsers)&&(Mw(M.transcodingUsers,"config.transcodingUsers"),M.transcodingUsers.forEach((L,k)=>{WU(L.uid),Uw(L.x)||Pw(L.x,"transcodingUser[".concat(k,"].x"),0,1e4),Uw(L.y)||Pw(L.y,"transcodingUser[".concat(k,"].y"),0,1e4),Uw(L.width)||Pw(L.width,"transcodingUser[".concat(k,"].width"),0,1e4),Uw(L.height)||Pw(L.height,"transcodingUser[".concat(k,"].height"),0,1e4),Uw(L.zOrder)||Pw(L.zOrder-1,"transcodingUser[".concat(k,"].zOrder"),0,100),Uw(L.alpha)||Pw(L.alpha,"transcodingUser[".concat(k,"].alpha"),0,1,!1)})),Uw(M.watermark)||zU(M.watermark,"watermark"),Uw(M.backgroundImage)||zU(M.backgroundImage,"backgroundImage"),M.images&&!Uw(M.images)&&(Mw(M.images,"config.images"),M.images.forEach((L,k)=>{zU(L,"images[".concat(k,"]"))}));let U=[];M.images&&U.push(...M.images.map(L=>nz(nz(nz({},Ry),L),{},{zOrder:255}))),M.backgroundImage&&(U.push(nz(nz(nz({},Ry),M.backgroundImage),{},{zOrder:0})),delete M.backgroundImage),M.watermark&&(U.push(nz(nz(nz({},Ry),M.watermark),{},{zOrder:255})),delete M.watermark),M.images=U,M.transcodingUsers&&(M.userConfigs=M.transcodingUsers.map(L=>nz({},L)),M.userCount=M.transcodingUsers.length,delete M.transcodingUsers);let V=(M.userConfigs||[]).map(L=>"number"==typeof L.uid?lQ.resolve(L.uid):kF(L.uid,this.spec,this.cancelToken.token,this.httpRetryConfig));if((await lQ.all(V)).forEach((L,k)=>{M.userConfigs&&M.userConfigs[k]&&(M.userConfigs[k].uid=L)}),this.transcodingConfig=M,this.connection)try{let L=await this.connection.request("request",{clientRequest:{command:"UpdateTranscoding",transcodingConfig:this.transcodingConfig}},!1,{command:"UpdateTranscoding",workerType:1,requestByUser:!0,tid:Array.from(l1(k=this.streamingTasks).call(k)).map(L=>L.taskId).join("#")});gc.debug("[".concat(this.spec.clientId,"] update live transcoding config success, code: ").concat(L.code,", config:"),JSON.stringify(this.transcodingConfig))}catch(L){if(!L.data||!L.data.retry)throw L;L.data.changeAddress&&this.connection.tryNextAddress(),this.streamingTasks.forEach(k=>{gc.warning("[".concat(this.spec.clientId,"] live streaming receive error"),L.toString(),"try to republish",k.url),this.startLiveStreamingTask(k.url,k.mode,L).then(()=>{gc.debug("[".concat(this.spec.clientId,"] live streaming republish ").concat(k.url," success"))}).catch(L=>{gc.error("[".concat(this.spec.clientId,"] live streaming republish failed"),k.url,L.toString()),this.onLiveStreamError&&this.onLiveStreamError(k.url,L)})})}}async startLiveStreamingTask(L,k,M){if(!this.transcodingConfig&&k===Rv.TRANSCODE)throw new ED(f1.INVALID_OPERATION,"[LiveStreaming] no transcoding config found, can not start transcoding streaming task");let U={command:"PublishStream",ts:Date.now(),url:L,uid:this.spec.uid.toString(),autoDestroyTime:100,acceptImageTimeout:!0};gc.debug("[".concat(this.spec.clientId,"] start live streaming ").concat(L,", mode: ").concat(k));let V=await this.taskMutex.lock();if(!this.connection&&M)return void V();if(this.streamingTasks.get(L)&&!M)return V(),new ED(f1.LIVE_STREAMING_TASK_CONFLICT).throw();try{this.connection||(this.connection=await this.connect(k))}catch(L){throw V(),L}switch(k){case Rv.TRANSCODE:U.transcodingConfig=nz({},this.transcodingConfig);case Rv.RAW:}this.uapResponse&&this.uapResponse.vid&&(U.vid=this.uapResponse.vid),this.isStartingStreamingTask=!0;let F=this.lastTaskId++;try{let B=new lQ((k,U)=>{yO(this.retryTimeout).then(()=>{if(M)return U(M);let k=this.statusError.get(L);return k?(this.statusError.delete(L),U(k)):void 0})}),j=await lQ.race([this.connection.request("request",{clientRequest:U},!0,{url:L,command:"PublishStream",workerType:k===Rv.TRANSCODE?1:2,requestByUser:!M,tid:F.toString()}),B]);this.isStartingStreamingTask=!1,gc.debug("[".concat(this.spec.clientId,"] live streaming started, code: ").concat(j.code)),this.streamingTasks.set(L,{clientRequest:U,mode:k,url:L,taskId:F}),V()}catch(U){if(V(),this.isStartingStreamingTask=!1,!U.data||!U.data.retry||M)throw U;return U.data.changeAddress&&this.connection.tryNextAddress(),await this.startLiveStreamingTask(L,k,U)}}stopLiveStreamingTask(L){return new lQ((k,M)=>{let U=this.streamingTasks.get(L);if(!U||!this.connection)return new ED(f1.UNEXPECTED_ERROR,"can not find streaming task to stop").throw();let V=U.mode;U.abortTask=()=>{gc.debug("[".concat(this.spec.clientId,"] stop live streaming success(worker exception)")),this.streamingTasks.delete(L),k()},this.connection.request("request",{clientRequest:{command:"UnpublishStream",url:U.url}},!1,{url:L,command:"UnPublishStream",workerType:V===Rv.TRANSCODE?1:2,requestByUser:!0,tid:(this.lastTaskId++).toString()}).then(M=>{gc.debug("[".concat(this.spec.clientId,"] stop live streaming success, code: ").concat(M.code)),this.streamingTasks.delete(L),0===this.streamingTasks.size&&(this.connection&&this.connection.close(),this.connection=void 0),k()}).catch(M)})}resetAllTask(){var L;let k=Array.from(l1(L=this.streamingTasks).call(L));for(let L of(this.terminate(),k))this.startLiveStreamingTask(L.url,L.mode).catch(k=>{this.onLiveStreamError&&this.onLiveStreamError(L.url,k)})}terminate(){this.cancelToken&&this.cancelToken.cancel(),this.streamingTasks=new Map,this.isStartingStreamingTask=!1,this.statusError=new Map,this.cancelToken=fG.CancelToken.source(),this.uapResponse=void 0,this.connection&&this.connection.close(),this.connection=void 0}async connect(L){if(this.connection)throw new ED(f1.UNEXPECTED_ERROR,"live streaming connection has already connected");let k=await oO(this,RN.REQUEST_WORKER_MANAGER_LIST,L);return this.uapResponse=k,this.connection=new tz(k.workerToken,this.spec,this.wsRetryConfig,L),this.connection.on(Rb.WARNING,(L,k)=>this.onLiveStreamWarning&&this.onLiveStreamWarning(k,L)),this.connection.on(Rb.PUBLISH_STREAM_STATUS,L=>this.handlePublishStreamServer(L)),this.connection.on(Rb.REQUEST_NEW_ADDRESS,(k,M)=>{if(!this.connection)return M(new ED(f1.UNEXPECTED_ERROR,"can not get new live streaming address list"));oO(this,RN.REQUEST_WORKER_MANAGER_LIST,L).then(L=>{this.uapResponse=L,k(L.addressList)}).catch(M)}),await this.connection.init(k.addressList),this.connection}handlePublishStreamServer(L){let k=L.serverStatus&&L.serverStatus.url||"empty_url",M=this.streamingTasks.get(k),U=L.reason;switch(L.code){case RL.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN:case RL.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT:case RL.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE:case RL.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH:{let U=new ED(f1.LIVE_STREAMING_CDN_ERROR,"",{code:L.code});if(M)return gc.error(U.toString()),this.onLiveStreamError&&this.onLiveStreamError(k,U);if(!this.isStartingStreamingTask)return;this.statusError.set(k,U)}case RL.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE:{let L=new ED(f1.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE,U);return this.onLiveStreamWarning&&this.onLiveStreamWarning(k,L)}case RL.LIVE_STREAM_RESPONSE_WORKER_LOST:case RL.LIVE_STREAM_RESPONSE_WORKER_QUIT:{var V;if(!this.connection)return;this.connection.tryNextAddress();let k=Array.from(l1(V=this.streamingTasks).call(V));for(let M of k)M.abortTask?M.abortTask():(gc.warning("[".concat(this.spec.clientId,"] publish stream status code"),L.code,"try to republish",M.url),this.startLiveStreamingTask(M.url,M.mode,new ED(f1.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"",{code:L.code})).then(()=>{gc.debug("[".concat(this.spec.clientId,"] republish live stream success"),M.url)}).catch(L=>{gc.error(L.toString()),this.onLiveStreamError&&this.onLiveStreamError(M.url,L)}));return}}}hasUrl(L){return this.streamingTasks.has(L)}};function sz(L){let k,M,U=fz();return function(L,k){let M=L.appId;void 0!==M&&(Dz(k,10),yz(k,M));let U=L.cid;void 0!==U&&(Dz(k,16),Dz(k,U));let V=L.cname;void 0!==V&&(Dz(k,26),yz(k,V));let F=L.deviceId;void 0!==F&&(Dz(k,34),yz(k,F));let B=L.elapse;void 0!==B&&(Dz(k,40),Pz(k,B));let j=L.fileSize;void 0!==j&&(Dz(k,48),Pz(k,Ez(j)));let G=L.height;void 0!==G&&(Dz(k,56),Pz(k,Ez(G)));let X=L.jpg;void 0!==X&&(Dz(k,66),Dz(k,X.length),function(L,k){let M=Rz(L,k.length);L.bytes.set(k,M)}(k,X));let $=L.networkType;void 0!==$&&(Dz(k,72),Pz(k,Ez($)));let ee=L.osType;void 0!==ee&&(Dz(k,80),Pz(k,Ez(ee)));let et=L.requestId;void 0!==et&&(Dz(k,90),yz(k,et));let ei=L.sdkVersion;void 0!==ei&&(Dz(k,98),yz(k,ei));let er=L.sequence;void 0!==er&&(Dz(k,104),Pz(k,Ez(er)));let en=L.sid;void 0!==en&&(Dz(k,114),yz(k,en));let ea=L.timestamp;void 0!==ea&&(Dz(k,120),Pz(k,ea));let eo=L.uid;void 0!==eo&&(Dz(k,128),Dz(k,eo));let es=L.vid;void 0!==es&&(Dz(k,136),Dz(k,es));let ec=L.width;void 0!==ec&&(Dz(k,144),Pz(k,Ez(ec)));let ed=L.service;void 0!==ed&&(Dz(k,152),Dz(k,ed));let el=L.callbackData;void 0!==el&&(Dz(k,162),yz(k,el));let eu=L.jpgEncryption;void 0!==eu&&(Dz(k,168),Dz(k,eu));let eh=L.requestType;void 0!==eh&&(Dz(k,176),Dz(k,eh));let ep=L.scorePorn;void 0!==ep&&(Dz(k,185),Oz(k,ep));let e_=L.scoreSexy;void 0!==e_&&(Dz(k,193),Oz(k,e_));let eE=L.scoreNeutral;void 0!==eE&&(Dz(k,201),Oz(k,eE));let em=L.scene;void 0!==em&&(Dz(k,208),Dz(k,em));let ef=L.ossFilePrefix;void 0!==ef&&(Dz(k,218),yz(k,ef));let eS=L.serviceVendor;if(void 0!==eS)for(let L of eS){Dz(k,226);let M=fz();dz(L,M),Dz(k,M.limit),Iz(k,M),Sz(M)}}(L,U),k=U.bytes,M=U.limit,k.length===M?k:k.subarray(0,M)}function az(L){return function(L){let k={};e:for(;!Tz(L);){let M=Nz(L);switch(M>>>3){case 0:break e;case 1:k.code=Nz(L);break;case 2:k.msg=Cz(L,Nz(L));break;case 3:{let M=lz(L);k.data=cz(L),L.limit=M;break}default:uz(L,7&M)}}return k}({bytes:L,offset:0,limit:L.length})}function cz(L){let k={};e:for(;!Tz(L);){let M=Nz(L);switch(M>>>3){case 0:break e;case 1:k.requestId=Cz(L,Nz(L));break;case 2:k.requestType=Nz(L)>>>0;break;case 3:k.scorePorn=wz(L);break;case 4:k.scoreSexy=wz(L);break;case 5:k.scoreNeutral=wz(L);break;case 6:k.requestScene=Nz(L)>>>0;break;case 7:k.scene=Nz(L)>>>0;break;default:uz(L,7&M)}}return k}function dz(L,k){let M=L.service;void 0!==M&&(Dz(k,8),Dz(k,M));let U=L.vendor;void 0!==U&&(Dz(k,16),Dz(k,U));let V=L.token;void 0!==V&&(Dz(k,26),yz(k,V));let F=L.callbackUrl;void 0!==F&&(Dz(k,34),yz(k,F))}function lz(L){let k=Nz(L),M=L.limit;return L.limit=L.offset+k,M}function uz(L,k){switch(k){case 0:for(;128&bz(L););break;case 2:gz(L,Nz(L));break;case 5:gz(L,4);break;case 1:gz(L,8);break;default:throw Error("Unimplemented type: "+k)}}let yf=new Float32Array(1);new Uint8Array(yf.buffer);let yg=new Float64Array(1),yT=new Uint8Array(yg.buffer);function Ez(L){return{low:L|=0,high:L>>31,unsigned:L>=0}}let yR=[];function fz(){let L=yR.pop();return L?(L.offset=L.limit=0,L):{bytes:new Uint8Array(64),offset:0,limit:0}}function Sz(L){yR.push(L)}function gz(L,k){if(L.offset+k>L.limit)throw Error("Skip past limit");L.offset+=k}function Tz(L){return L.offset>=L.limit}function Rz(L,k){let M=L.bytes,U=L.offset,V=L.limit,F=U+k;if(F>M.length){let k=new Uint8Array(2*F);k.set(M),L.bytes=k}return L.offset=F,F>V&&(L.limit=F),U}function vz(L,k){let M=L.offset;if(M+k>L.limit)throw Error("Read past limit");return L.offset+=k,M}function Cz(L,k){let M=vz(L,k),U=String.fromCharCode,V=L.bytes,F="";for(let L=0;L<k;L++){let B,j,G,X,$=V[L+M];0==(128&$)?F+=U($):192==(224&$)?L+1>=k?F+="�":128!=(192&(B=V[L+M+1]))?F+="�":(X=(31&$)<<6|63&B)<128?F+="�":(F+=U(X),L++):224==(240&$)?L+2>=k?F+="�":32896!=(49344&((B=V[L+M+1])|(j=V[L+M+2])<<8))?F+="�":(X=(15&$)<<12|(63&B)<<6|63&j)<2048||X>=55296&&X<=57343?F+="�":(F+=U(X),L+=2):240==(248&$)?L+3>=k?F+="�":8421504!=(12632256&((B=V[L+M+1])|(j=V[L+M+2])<<8|(G=V[L+M+3])<<16))?F+="�":(X=(7&$)<<18|(63&B)<<12|(63&j)<<6|63&G)<65536||X>1114111?F+="�":(X-=65536,F+=U(55296+(X>>10),56320+(1023&X)),L+=3):F+="�"}return F}function yz(L,k){let M=k.length,U=0;for(let L=0;L<M;L++){let V=k.charCodeAt(L);V>=55296&&V<=56319&&L+1<M&&(V=(V<<10)+k.charCodeAt(++L)-56613888),U+=V<128?1:V<2048?2:V<65536?3:4}Dz(L,U);let V=Rz(L,U),F=L.bytes;for(let L=0;L<M;L++){let U=k.charCodeAt(L);U>=55296&&U<=56319&&L+1<M&&(U=(U<<10)+k.charCodeAt(++L)-56613888),U<128?F[V++]=U:(U<2048?F[V++]=U>>6&31|192:(U<65536?F[V++]=U>>12&15|224:(F[V++]=U>>18&7|240,F[V++]=U>>12&63|128),F[V++]=U>>6&63|128),F[V++]=63&U|128)}}function Iz(L,k){let M=Rz(L,k.limit),U=L.bytes,V=k.bytes;for(let L=0,F=k.limit;L<F;L++)U[L+M]=V[L]}function bz(L){return L.bytes[vz(L,1)]}function Az(L,k){let M=Rz(L,1);L.bytes[M]=k}function wz(L){let k=vz(L,8),M=L.bytes;return yT[0]=M[k++],yT[1]=M[k++],yT[2]=M[k++],yT[3]=M[k++],yT[4]=M[k++],yT[5]=M[k++],yT[6]=M[k++],yT[7]=M[k++],yg[0]}function Oz(L,k){let M=Rz(L,8),U=L.bytes;yg[0]=k,U[M++]=yT[0],U[M++]=yT[1],U[M++]=yT[2],U[M++]=yT[3],U[M++]=yT[4],U[M++]=yT[5],U[M++]=yT[6],U[M++]=yT[7]}function Nz(L){let k,M=0,U=0;do k=bz(L),M<32&&(U|=(127&k)<<M),M+=7;while(128&k);return U}function Dz(L,k){for(k>>>=0;k>=128;)Az(L,127&k|128),k>>>=7;Az(L,k)}function Pz(L,k){let M=k.low>>>0,U=(k.low>>>28|k.high<<4)>>>0,V=k.high>>>24,F=0===V?0===U?M<16384?M<128?1:2:M<2097152?3:4:U<16384?U<128?5:6:U<2097152?7:8:V<128?9:10,B=Rz(L,F),j=L.bytes;switch(F){case 10:j[B+9]=V>>>7&1;case 9:j[B+8]=9!==F?128|V:127&V;case 8:j[B+7]=8!==F?U>>>21|128:U>>>21&127;case 7:j[B+6]=7!==F?U>>>14|128:U>>>14&127;case 6:j[B+5]=6!==F?U>>>7|128:U>>>7&127;case 5:j[B+4]=5!==F?128|U:127&U;case 4:j[B+3]=4!==F?M>>>21|128:M>>>21&127;case 3:j[B+2]=3!==F?M>>>14|128:M>>>14&127;case 2:j[B+1]=2!==F?M>>>7|128:M>>>7&127;case 1:j[B]=1!==F?128|M:127&M}}function Lz(L,k){var M=Object.keys(L);if(Object.getOwnPropertySymbols){var U=Object.getOwnPropertySymbols(L);k&&(U=U.filter(function(k){return Object.getOwnPropertyDescriptor(L,k).enumerable})),M.push.apply(M,U)}return M}let yI=new Map([["moderation",1],["supervise",2]]);let Mz=class Mz extends Hw{get connectionState(){return this._connectionState}set connectionState(L){if(this._connectionState===L)return;let k=this._connectionState;this._connectionState=L,this.emit(Ie.CONNECTION_STATE_CHANGE,k,L)}get inspectType(){return this._inspectType}set inspectType(L){var k;this._inspectMode=sE(k=L.map(L=>yI.get(L)||0)).call(k,(L,k)=>L+k),this._inspectType=L}get quality(){return this._quality}set quality(L){this._quality=L>1?1:L<.1?.1:L,this.qualityTimer&&(window.clearTimeout(this.qualityTimer),this.qualityTimer=null),this._quality>=1||(this.qualityTimer=window.setTimeout(()=>{this.quality=this._quality/this.qualityRatio},6e4))}constructor(L){super(),uI(this,"name","AgoraRTCVideoContentInspect"),uI(this,"_connectionState",R9.CONNECTING),uI(this,"_innerConnectionState",void 0),uI(this,"sequence",0),uI(this,"inspectStartTime",void 0),uI(this,"workerManagerConnection",void 0),uI(this,"workerConnection",void 0),uI(this,"workerMessageLengthLimit",void 0),uI(this,"inspectIntervalMinimum",void 0),uI(this,"qualityRatio",void 0),uI(this,"_connectInfo",void 0),uI(this,"_cancelTokenSource",fG.CancelToken.source()),uI(this,"_retryConfig",void 0),uI(this,"wmSequence",0),uI(this,"inspectInterval",void 0),uI(this,"inspectTimer",null),uI(this,"ossFilePrefix",void 0),uI(this,"extraInfo",void 0),uI(this,"_inspectType",void 0),uI(this,"_inspectMode",void 0),uI(this,"_quality",1),uI(this,"qualityTimer",null),uI(this,"_inspectId",void 0),uI(this,"_needWorkUrlOnly",!1),uI(this,"inspectImage",()=>{if(this.connectionState!==R9.CONNECTED)throw new ED(f1.OPERATION_ABORTED,"content inspect service connection status is ".concat(this.connectionState));this.inspectTimer&&(window.clearInterval(this.inspectTimer),this.inspectTimer=null),this.inspectTimer=window.setInterval(()=>{this.connectionState===R9.CONNECTED?this.requestToInspectImage():gc.debug("[".concat(this._inspectId,"] Inspect State is not connected , "),this.connectionState)},this.inspectInterval<this.inspectIntervalMinimum?this.inspectIntervalMinimum:this.inspectInterval),this.requestToInspectImage()}),this._inspectId=IO(5,"inspect-"),this.workerMessageLengthLimit=wN("VIDEO_INSPECT_WORKER_MESSAGE_LENGTH_LIMIT"),this.inspectIntervalMinimum=wN("VIDEO_INSPECT_INTERVAL_MINIMUM"),this.qualityRatio=wN("VIDEO_INSPECT_QUALITY_RATIO"),this.inspectInterval=L.interval,this.ossFilePrefix=L.ossFilePrefix,this.extraInfo=L.extraInfo,this.inspectType=L.inspectType,this.inspectStartTime=Number(Date.now()),this.workerManagerConnection=new JV("worker-manager-"+this._inspectId,Sm),this.on(Ie.STATE_CHANGE,(L,k)=>{this._innerConnectionState=L,gc.debug("[".concat(this._inspectId,"] Inspect operation :").concat(R7[L]," ").concat(k||""))}),this.handleWorkerManagerEvents(),this.workerConnection=new JV("worker-"+this._inspectId,Sm),this.handleWorkerEvents()}async init(L,k){this.emit(Ie.STATE_CHANGE,R7.CONNECT_AP),this._connectInfo=L;let M=this._cancelTokenSource.token;return this._retryConfig=k,new lQ((U,V)=>{this.on(Ie.CONNECTION_STATE_CHANGE,(L,k)=>{k===R9.CONNECTED&&U()}),this.requestAP(L,M,k).then(L=>{this.connectWorkerManager(L)}).catch(L=>{V(L)})})}async requestAP(L,k,M){let U=wN("WEBCS_DOMAIN").map(L=>"https://".concat(L,"/api/v1")),V=await function(L,k,M,U){let{appId:V,areaCode:F,cname:B,sid:j,token:G,uid:X}=k;IV++;let $="image_moderation_api",ee={service_name:$,json_body:JSON.stringify({appId:V,areaCode:F,cname:B,command:"allocateEdge",requestId:IV,seq:IV,sid:j,token:G,ts:Date.now(),uid:X+""})},et,ei,er=L[0];return GO(async()=>{et=Date.now();let L=await oF(er,{data:ee,cancelToken:M,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"},params:{action:"wrtc_gateway"}});if(ei=Date.now()-et,0!==L.code){let k=new ED(f1.UNEXPECTED_RESPONSE,"image inspect ap error, code"+L.code,{retry:!0,responseTime:ei});throw gc.error(k.toString()),k}let k=JSON.parse(L.json_body);if(200!==k.code){let L=new ED(f1.UNEXPECTED_RESPONSE,"image inspect ap error, code: ".concat(k.code,", reason: ").concat(k.reason),{code:k.code,responseTime:ei});throw gc.error(L.toString()),L}if(!k.servers||!Array.isArray(k.servers)||0===k.servers.length){let L=new ED(f1.UNEXPECTED_RESPONSE,"image inspect ap empty server",{code:k.code,responseTime:ei});throw gc.error(L.toString()),L}let U=wN("VIDEO_INSPECT_WORKER_MANAGER_HOST"),V=wN("VIDEO_INSPECT_WORKER_MANAGER_PORT");return{addressList:k.servers.map(L=>{let{address:k,wss:M}=L;if(k&&M)return"wss://".concat(k.replace(/\./g,"-"),".").concat(U,":").concat(V||M)}).filter(L=>!!L),workerToken:k.workerToken,vid:k.vid,responseTime:ei}},(k,M)=>(g_.apworkerEvent(j,{success:!0,sc:200,serviceName:$,responseDetail:JSON.stringify(k.addressList),firstSuccess:0===M,responseTime:ei,serverIp:L[M%L.length]}),!1),(k,M)=>(g_.apworkerEvent(j,{success:!1,sc:k.data&&k.data.code||200,serviceName:$,responseTime:ei,serverIp:L[M%L.length]}),!!(k.code!==f1.OPERATION_ABORTED&&k.code!==f1.UNEXPECTED_RESPONSE||k.data&&k.data.retry)&&(er=L[(M+1)%L.length],!0)),U)}(U,L,k,M);this.emit(Ie.STATE_CHANGE,R7.AP_CONNECTED);let{addressList:F}=V;return this.wmSequence++,F}async connectWorkerManager(L){let k=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this._needWorkUrlOnly=k,this.emit(Ie.STATE_CHANGE,R7.CONNECT_WORKER_MANAGER),await this.workerManagerConnection.init(L,1e4)}async connectWorker(L){await this.workerConnection.init([L])}handleWorkerManagerEvents(){this.workerManagerConnection.on(RI.CONNECTED,async()=>{this.emit(Ie.STATE_CHANGE,R7.WORKER_MANAGER_CONNECTED,this.workerManagerConnection.url),this.workerManagerConnection.sendMessage({appId:this._connectInfo.appId,cname:this._connectInfo.cname,uid:this._connectInfo.uid+"",sdkVersion:"4.24.0",sid:this._connectInfo.sid,seq:this.wmSequence,ts:Number(Date.now()),requestId:Math.floor(1e12*Math.random()),allocate:!0,clientRequest:{command:"join"}},!0)}),this.workerManagerConnection.on(RI.CLOSED,()=>{this._innerConnectionState<R7.GET_WORKER_MANAGER_RESPONSE&&gc.debug("[".concat(this._inspectId,"] Inspect worker manager is closed before connecting worker"))}),this.workerManagerConnection.on(RI.FAILED,()=>{this._innerConnectionState<R7.GET_WORKER_MANAGER_RESPONSE&&gc.debug("[".concat(this._inspectId,"] Connecting inspect worker manager is failed before connecting worker"))}),this.workerManagerConnection.on(RI.RECONNECTING,()=>{this._innerConnectionState<R7.GET_WORKER_MANAGER_RESPONSE&&gc.debug("[".concat(this._inspectId,"] Inspect worker manager is reconnecting before connecting worker"))}),this.workerManagerConnection.on(RI.ON_MESSAGE,async L=>{this.emit(Ie.STATE_CHANGE,R7.GET_WORKER_MANAGER_RESPONSE);let k=this.workerManagerConnection.url;this.workerManagerConnection.close();let M=JSON.parse(L.data);if(200!==M.code)throw gc.error("[".concat(this._inspectId,"] Unexpected code ").concat(M.code," from worker manager")),new ED(f1.UNEXPECTED_RESPONSE,"response code of worker is unexpected",M);if(!(M.serverResponse&&M.serverResponse.portWss&&k))throw gc.error("[".concat(this._inspectId,"] Unexpected content from worker manager : ").concat(JSON.stringify(M))),new ED(f1.UNEXPECTED_RESPONSE,"response content of worker is unexpected",M);{let L=wN("VIDEO_INSPECT_WORKER_PORT")||M.serverResponse.portWss,U=k.replace(/:\d+\/?$/,":".concat(L));this.emit(Ie.STATE_CHANGE,R7.CONNECT_WORKER,U),this._needWorkUrlOnly?this.emit(Ie.REQUEST_NEW_WORKER_URL,U):await this.connectWorker(U)}}),this.workerManagerConnection.on(RI.WILL_RECONNECT,(L,k,M)=>{M(L)}),this.workerManagerConnection.on(RI.REQUEST_NEW_URLS,(L,k)=>{this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(L).catch(k)})}handleWorkerEvents(){this.workerConnection.on(RI.CONNECTED,async()=>{this.emit(Ie.STATE_CHANGE,R7.WORKER_CONNECTED,this.workerConnection.url),this.connectionState=R9.CONNECTED}),this.workerConnection.on(RI.ON_MESSAGE,async L=>{if(L.data instanceof ArrayBuffer){let M=az(new Uint8Array(L.data));if(wN("SHOW_VIDEO_INSPECT_WORKER_MESSAGE")&&gc.debug("[".concat(this._inspectId,"] Response message for worker of inspect content "),JSON.stringify(M)),200===M.code){if(Array.isArray(this.inspectType)&&1===this.inspectType.length&&"supervise"===this.inspectType[0])return void this.emit(Ie.INSPECT_RESULT,void 0,void 0);if(M.data&&M.data.scorePorn&&M.data.scoreSexy&&M.data.scoreNeutral){var k;let L={porn:M.data.scorePorn,sexy:M.data.scoreSexy,neutral:M.data.scoreNeutral},U=sE(k=Object.keys(L)).call(k,(k,M)=>L[k]>L[M]?k:M,"porn"),V=Object.keys(L).find(L=>L===U);this.emit(Ie.INSPECT_RESULT,V)}else this.emit(Ie.INSPECT_RESULT,void 0,new ED(f1.UNEXPECTED_RESPONSE,M.code+"","There is an unexpected data on message"))}else this.emit(Ie.INSPECT_RESULT,void 0,new ED(f1.UNEXPECTED_RESPONSE,M.code+"",M.msg))}else gc.error("[".concat(this._inspectId,"] Unexpected message type from worker")),this.emit(Ie.INSPECT_RESULT,void 0,new ED(f1.UNEXPECTED_RESPONSE,"invalid worker message type"))}),this.workerConnection.on(RI.CLOSED,()=>{this.connectionState=R9.CLOSED}),this.workerConnection.on(RI.FAILED,()=>{this.connectionState=R9.CLOSED}),this.workerConnection.on(RI.RECONNECTING,()=>{this.connectionState=this.connectionState===R9.CONNECTED?R9.RECONNECTING:R9.CONNECTING}),this.workerConnection.on(RI.WILL_RECONNECT,(L,k,M)=>{"recover"===L&&M(L),M("tryNext")}),this.workerConnection.on(RI.REQUEST_NEW_URLS,(L,k)=>{this.workerManagerConnection.close(),this.once(Ie.REQUEST_NEW_WORKER_URL,k=>{L([k])}),this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(L=>{this.connectWorkerManager(L,!0)}).catch(L=>{k(L)})})}async requestToInspectImage(){this.sequence++;let L=aO(this,Ie.CLIENT_LOCAL_VIDEO_TRACK),k={appId:this._connectInfo.appId,cname:this._connectInfo.cname,cid:this._connectInfo.cid,sid:this._connectInfo.sid,uid:this._connectInfo.uid,vid:this._connectInfo.vid};if(L){if(!L.isPlaying)return void this.emit(Ie.INSPECT_RESULT,void 0,new ED(f1.INVALID_OPERATION,"Only the track being played can be inspected"));let M=await this.generateRequestData(L,k);this.workerConnection.sendMessage(M,!0,!0)}else this.emit(Ie.INSPECT_RESULT,void 0,new ED(f1.INVALID_OPERATION,"Only the track being published can be inspected"))}async generateRequestData(L,k){var M;let{appId:U,cname:V,cid:F,vid:B,sid:j,uid:G}=k,X=Date.now(),$=await L.getCurrentFrameImage("image/jpeg",this.quality),ee=await ZP($,U,V),et=this.sequence+"-"+F+"-"+G+"-"+X+"-"+IO(12,""),ei={appId:U,cid:F,cname:V,deviceId:"",elapse:{low:M=0|Number(X-this.inspectStartTime),high:M>>31,unsigned:M>=0},fileSize:ee.byteLength,jpgEncryption:2,height:$.height,width:$.width,jpg:ee,networkType:6,osType:7,requestId:et,sdkVersion:"4.24.0",sequence:this.sequence,sid:j,timestamp:uG(X),uid:G,vid:B,service:this._inspectMode,callbackData:this.extraInfo,ossFilePrefix:this.ossFilePrefix};void 0===this.extraInfo&&delete ei.callbackData,void 0===this.ossFilePrefix&&delete ei.ossFilePrefix;let er=sz(ei);if(er.byteLength<this.workerMessageLengthLimit){if(wN("SHOW_VIDEO_INSPECT_WORKER_MESSAGE")){let L=function(L){for(var k=1;k<arguments.length;k++){var M=null!=arguments[k]?arguments[k]:{};k%2?Lz(Object(M),!0).forEach(function(k){uI(L,k,M[k])}):Object.getOwnPropertyDescriptors?Object.defineProperties(L,Object.getOwnPropertyDescriptors(M)):Lz(Object(M)).forEach(function(k){Object.defineProperty(L,k,Object.getOwnPropertyDescriptor(M,k))})}return L}({},ei);delete L.jpg,gc.debug("[".concat(this._inspectId,"] Request message for worker of inspect content "),JSON.stringify(L))}return er}{let k=this.quality*this.qualityRatio;return this.quality=k,await this.generateRequestData(L,{appId:U,cname:V,cid:F,vid:B,sid:j,uid:G})}}close(){this._cancelTokenSource.cancel(),this._cancelTokenSource=fG.CancelToken.source(),this.workerManagerConnection&&this.workerManagerConnection.close(),this.workerConnection&&this.workerConnection.close(),this.inspectTimer&&window.clearInterval(this.inspectTimer),this.inspectTimer=null,this.connectionState=R9.CLOSED,this.emit(Ie.STATE_CHANGE,R7.CLOSED)}};var yv=i(aB.Object.getOwnPropertySymbols),yC=o$.indexOf,yy=y([].indexOf),yA=!!yy&&1/yy([1],1,-0)<0;Oi({target:"Array",proto:!0,forced:yA||!Wn("indexOf")},{indexOf:function(L){var k=arguments.length>1?arguments[1]:void 0;return yA?yy(this,L,k)||0:yC(this,L,k)}});var yN=Qi("Array","indexOf"),yL=Array.prototype,yk=i(function(L){var k=L.indexOf;return L===yL||al(yL,L)&&k===yL.indexOf?yN:k});function Xz(L,k){if(null==L)return{};var M,U,V=function(L,k){if(null==L)return{};var M={};for(var U in L)if(({}).hasOwnProperty.call(L,U)){if(-1!==yk(k).call(k,U))continue;M[U]=L[U]}return M}(L,k);if(yv){var F=yv(L);for(U=0;U<F.length;U++)M=F[U],-1===yk(k).call(k,M)&&({}).propertyIsEnumerable.call(L,M)&&(V[M]=L[M])}return V}let yM=class{get localCapabilities(){return pO(this._localCapabilities)}get rtpCapabilities(){return pO(this._rtpCapabilities)}get candidates(){return pO(this._candidates)}get iceParameters(){return pO(this._iceParameters)}get dtlsParameters(){return pO(this._dtlsParameters)}constructor(L){let k;uI(this,"sessionDesc",void 0),uI(this,"_localCapabilities",void 0),uI(this,"_rtpCapabilities",void 0),uI(this,"_candidates",void 0),uI(this,"_iceParameters",void 0),uI(this,"_dtlsParameters",void 0),uI(this,"setup",void 0),uI(this,"currentMidIndex",void 0),uI(this,"cname","o/i14u9pJrxRKAsu"),uI(this,"firefoxSsrcMidMap",new Map),L=pO(L);let{remoteIceParameters:M,remoteDtlsParameters:U,candidates:V,remoteRTPCapabilities:F,localCapabilities:B,direction:j,setup:G,videoCodec:X,audioCodec:$}=L;this.setup=G,k=j===RR.RECEIVE_ONLY?FN("v=0\no=- 0 0 IN IP4 127.0.0.1\ns=AgoraGateway\nt=0 0\na=group:BUNDLE 0 1\na=msid-semantic: WMS\na=extmap-allow-mixed\nm=video 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 localhost\na=sendonly\na=rtcp-mux\na=rtcp-rsize\na=mid:0\nm=audio 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 localhost\na=sendonly\na=rtcp-mux\na=rtcp-rsize\na=mid:1\n"):FN("v=0\no=- 0 0 IN IP4 127.0.0.1\ns=AgoraGateway\nt=0 0\na=group:BUNDLE 0 1\na=msid-semantic: WMS\na=extmap-allow-mixed\nm=video 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 localhost\na=recvonly\na=rtcp-mux\na=rtcp-rsize\na=mid:0\nm=audio 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 localhost\na=recvonly\na=rtcp-mux\na=rtcp-rsize\na=mid:1\n"),this._rtpCapabilities=F,this._candidates=V,this._iceParameters=M,this._dtlsParameters=U,this._localCapabilities=B;let ee=j===RR.RECEIVE_ONLY?this.rtpCapabilities.send:this.rtpCapabilities.recv,et=j===RR.RECEIVE_ONLY?this._localCapabilities.recv:this._localCapabilities.send,ei=j===RR.RECEIVE_ONLY?F.send.videoCodecs:xx(R1.VIDEO,ee,et,X),er=j===RR.RECEIVE_ONLY?F.send.audioCodecs:xx(R1.AUDIO,ee,et,$);for(let L of k.mediaDescriptions)L.attributes.iceUfrag=M.iceUfrag,L.attributes.icePwd=M.icePwd,L.attributes.fingerprints=U.fingerprints,L.attributes.candidates=V,L.attributes.setup=this.setup,"application"===L.media.mediaType&&(L.attributes.sctpPort="5000"),"video"===L.media.mediaType&&(L.media.fmts=ei.map(L=>L.payloadType.toString(10)),L.attributes.payloads=ei,L.attributes.extmaps=ee.videoExtensions),"audio"===L.media.mediaType&&(L.media.fmts=er.map(L=>L.payloadType.toString(10)),L.attributes.payloads=er,L.attributes.extmaps=ee.audioExtensions,Vx(L));this.sessionDesc=k,this.currentMidIndex=k.mediaDescriptions.length-1}toString(){return BN(this.sessionDesc)}hasMid(L){return Array.isArray(L)?L.every(L=>this.hasMid(L)):this.sessionDesc.mediaDescriptions.some(k=>k.attributes.mid===L)}send(L,k,M,U,V){M=M.replace(/ /g,"-");let{ssrcs:F,ssrcGroups:B}=bx(k,this.cname,wN("SYNC_GROUP")?M:void 0),j=this.findPreloadMediaDesc(F);if(j){if(iw()&&this.firefoxSsrcMidMap.set(F[0].ssrcId,j.attributes.mid),V&&(V.twcc||V.remb)){let L=this.sessionDesc.mediaDescriptions.indexOf(j);return this.sessionDesc.mediaDescriptions[L]=this.mungSendMediaDesc(j,V),{mid:j.attributes.mid,needExchangeSDP:!0}}return{mid:j.attributes.mid,needExchangeSDP:!1}}{let k;let M=this.findAvailableMediaIndex(L,F,U);return -1===M?(k=this.createOrRecycleSendMedia(L,F,B,"sendonly",U,V),this.updateBundleMids()):((k=pO(this.sessionDesc.mediaDescriptions[M])).attributes.direction="sendonly",k.attributes.ssrcs=F,k.attributes.ssrcGroups=B,this.sessionDesc.mediaDescriptions[M]=this.mungSendMediaDesc(k,V)),iw()&&this.firefoxSsrcMidMap.set(F[0].ssrcId,k.attributes.mid),{needExchangeSDP:!0,mid:k.attributes.mid}}}stopSending(L){let k=this.sessionDesc.mediaDescriptions.filter(k=>k.attributes.mid&&-1!==L.indexOf(k.attributes.mid));if(k.length!==L.length)throw Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.stopSending.");k.forEach(L=>{L.attributes.ssrcs=[]}),this.updateBundleMids()}receive(L,k,M){let U=[];return L.forEach(L=>{let V=L._mediaStreamTrack.kind,F=this.findAvailableRecvMediaIndex(V),B,j=!1;-1===F?(j=!0,B=this.createOrRecycleRecvMedia(L,[],"recvonly",k,M),this.updateBundleMids()):(B=pO(this.sessionDesc.mediaDescriptions[F])).attributes.direction="recvonly",U.push({mid:B.attributes.mid,needCreateTransceiver:j})}),U}stopReceiving(L){let k=this.sessionDesc.mediaDescriptions.filter(k=>-1!==L.indexOf(k.attributes.mid));if(k.length!==L.length)throw Error("MediaDescriptions' length doesn't match mids's length when calling RemoteSDP.receive.");k.forEach(L=>{L.media.port="0",L.attributes.direction="inactive"}),this.updateBundleMids()}addRemoteCandidate(L){let{foundation:k,protocol:M,address:U,port:V,type:F,relatedAddress:B,relatedPort:j,priority:G}=new RTCIceCandidate(L),X={foundation:null!=k?k:"",componentId:"1",transport:null!=M?M:"",priority:G?G+"":"",connectionAddress:null!=U?U:"",port:V?V+"":"",type:F?F+"":"",relAddr:null!=B?B:"",relPort:j?j+"":"",extension:{}};this.candidates.some(L=>L.priority===X.priority&&L.connectionAddress===X.connectionAddress&&L.port===X.port)||(this._candidates.push(X),this.sessionDesc.mediaDescriptions.forEach(L=>{L.attributes.candidates=this.candidates}))}clearRemoteCandidate(){this._candidates=[],this.sessionDesc.mediaDescriptions[0].attributes.candidates=this._candidates}createOrRecycleRecvMedia(L,k,M,U,V){let F=L._mediaStreamTrack.kind,B=this.rtpCapabilities.recv,j=xx(F,B,this.localCapabilities.send,F===R1.AUDIO?V:U),G=F===R1.VIDEO?B.videoExtensions:B.audioExtensions,X="".concat(++this.currentMidIndex),$={media:{mediaType:F,port:"9",protos:["UDP","TLS","RTP","SAVPF"],fmts:j.map(L=>L.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:[],extmaps:G,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:k,ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:j,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"localhost"},setup:this.setup,direction:M,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(X)}};$=this.mungRecvMediaDsec($,L);let ee=this.findFirstClosedMedia(F);if(ee){let L=this.sessionDesc.mediaDescriptions.indexOf(ee);this.sessionDesc.mediaDescriptions[L]=$}else this.sessionDesc.mediaDescriptions.push($);return $}muteRemote(L){let k=this.sessionDesc.mediaDescriptions.filter(k=>so(L).call(L,k.attributes.mid||""));if(k.length!==L.length)throw Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");k.forEach(L=>{L.attributes.direction="inactive"})}unmuteRemote(L){let k=this.sessionDesc.mediaDescriptions.filter(k=>so(L).call(L,k.attributes.mid||""));if(k.length!==L.length)throw Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");k.forEach(L=>{L.attributes.direction="recvonly"})}findAvailableMediaIndex(L,k,M){return this.sessionDesc.mediaDescriptions.findIndex(U=>{let V=U.media.mediaType===L&&"0"!==U.media.port&&("sendonly"===U.attributes.direction||"sendrecv"===U.attributes.direction)&&0===U.attributes.ssrcs.length;if(iw()){if(V){let L=this.firefoxSsrcMidMap.get(k[0].ssrcId);return!(L||"0"!==U.attributes.mid&&"1"!==U.attributes.mid)||!(!L||L!==U.attributes.mid)}return!1}return V&&U.attributes.mid===M})}findAvailableRecvMediaIndex(L){return this.sessionDesc.mediaDescriptions.findIndex(k=>{let M=k.media.mediaType===L&&"0"!==k.media.port&&("recvonly"===k.attributes.direction||"sendrecv"===k.attributes.direction);return"0"!==k.attributes.mid&&"1"!==k.attributes.mid&&M})}predictReceivingMids(L){let k=[];for(let M=0;M<L;M++)k.push((this.currentMidIndex+M+1).toString(10));return k}restartICE(L){L=pO(L),this._iceParameters=L,this.sessionDesc.mediaDescriptions.forEach(k=>{k.attributes.iceUfrag=L.iceUfrag,k.attributes.icePwd=L.icePwd})}createOrRecycleSendMedia(L,k,M,U,V,F){let B=this.rtpCapabilities.send,j=L===R1.VIDEO?B.videoCodecs:B.audioCodecs,G=L===R1.VIDEO?B.videoExtensions:B.audioExtensions;iw()&&(V="".concat(++this.currentMidIndex));let X={media:{mediaType:L,port:"9",protos:["UDP","TLS","RTP","SAVPF"],fmts:j.map(L=>L.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:[],extmaps:G,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:k,ssrcGroups:M,rtcpFeedbackWildcards:[],payloads:j,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"localhost"},setup:this.setup,direction:U,rtcpMux:!0,rtcpRsize:!0,mid:V}};X=this.mungSendMediaDesc(X,F);let $=this.findFirstClosedMedia(L);if($){let L=this.sessionDesc.mediaDescriptions.indexOf($);this.sessionDesc.mediaDescriptions[L]=X}else this.sessionDesc.mediaDescriptions.push(X);return X}mungRecvMediaDsec(L,k,M){let U=pO(L);return wx(U),Ax(U,k),Ox(U,k),Nx(U),Dx(U,M,this.localCapabilities.send),U}mungSendMediaDesc(L,k){let M=pO(L);return Dx(M,k,this.localCapabilities.recv),Vx(M),M}updateRecvMedia(L,k){let M=this.sessionDesc.mediaDescriptions.findIndex(k=>k.attributes.mid===L);if(-1!==M){let L=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[M],k);this.sessionDesc.mediaDescriptions[M]=L}}updateBundleMids(){this.sessionDesc.attributes.groups[0].identificationTag=this.sessionDesc.mediaDescriptions.filter(L=>"0"!==L.media.port).map(L=>L.attributes.mid)}findPreloadMediaDesc(L){return this.sessionDesc.mediaDescriptions.find(k=>{var M;return(null===(M=k.attributes)||void 0===M||null===(M=M.ssrcs[0])||void 0===M?void 0:M.ssrcId)===L[0].ssrcId})}findFirstClosedMedia(L){return this.sessionDesc.mediaDescriptions.find(k=>iw()?"0"===k.media.port&&k.media.mediaType===L:"0"===k.media.port)}},yU=["sdp"];function $z(L,k){var M=Object.keys(L);if(Object.getOwnPropertySymbols){var U=Object.getOwnPropertySymbols(L);k&&(U=U.filter(function(k){return Object.getOwnPropertyDescriptor(L,k).enumerable})),M.push.apply(M,U)}return M}function eq(L){for(var k=1;k<arguments.length;k++){var M=null!=arguments[k]?arguments[k]:{};k%2?$z(Object(M),!0).forEach(function(k){uI(L,k,M[k])}):Object.getOwnPropertyDescriptors?Object.defineProperties(L,Object.getOwnPropertyDescriptors(M)):$z(Object(M)).forEach(function(k){Object.defineProperty(L,k,Object.getOwnPropertyDescriptor(M,k))})}return L}let yV=(OU((n0=class e extends pV{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get dtlsTransportState(){var L,k;return null!==(L=null===(k=this.peerConnection.getReceivers()[0])||void 0===k||null===(k=k.transport)||void 0===k?void 0:k.state)&&void 0!==L?L:null}get localCodecs(){return[]}set isInRestartIce(L){this._isInRestartIce=L}get isInRestartIce(){return this._isInRestartIce}constructor(L,k,M){super(L,k),uI(this,"direction",void 0),uI(this,"name",void 0),uI(this,"store",void 0),uI(this,"spec",void 0),uI(this,"peerConnection",void 0),uI(this,"initialOffer",void 0),uI(this,"transport",void 0),uI(this,"statsFilter",void 0),uI(this,"localCandidateCount",0),uI(this,"_isInRestartIce",!1),uI(this,"mutex",void 0),uI(this,"onLocalCandidate",void 0),uI(this,"remoteSDP",void 0),uI(this,"pendingCandidates",[]),uI(this,"localCapabilities",void 0),uI(this,"isReady",!1),uI(this,"restartCnt",0),uI(this,"curTurnServerIndex",0),this.store=k,this.spec=L,this.mutex=new S_("P2PConnection-mutex",k.clientId),this.peerConnection=new RTCPeerConnection(e.resolvePCConfiguration(L,k.p2pTransport),{optional:[{googDscp:!0}]}),this.direction=null!=M?M:RR.SEND_ONLY,this.name=this.direction===RR.SEND_ONLY?"sendP2PConnection":"recvP2PConnection",this.statsFilter=EN(this.peerConnection,wN("STATS_UPDATE_INTERVAL"),void 0,iw()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1}async establish(L){try{let k=await Lx();if(this.localCapabilities=Ux(k),L){let{sdp:k}=L,M=Xz(L,yU),U=function(){let L={audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},k=Rx(arguments.length>2?arguments[2]:void 0,arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},"sendonly"),M={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},U={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},V={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(Mx(k,L,"videoExtensions",M,U,V),Mx(k,L,"videoCodecs",M,U,V),Mx(k,L,"audioExtensions",M,U,V),Mx(k,L,"audioCodecs",M,U,V),wN("RAISE_H264_BASELINE_PRIORITY")){let L=V.videoCodecs.findIndex(L=>L.rtpMap&&"h264"===L.rtpMap.encodingName.toLocaleLowerCase()&&L.fmtp&&"42001f"===L.fmtp.parameters["profile-level-id"]);if(-1!==L){let k=V.videoCodecs.findIndex(L=>L.rtpMap&&"h264"===L.rtpMap.encodingName.toLocaleLowerCase());if(k<L){gc.debug("raising H264 baseline profile priority");let M=V.videoCodecs[L];V.videoCodecs.splice(L,1),V.videoCodecs.splice(k,0,M)}-1!==k&&wN("FILTER_SEND_H264_BASELINE")&&(M.videoCodecs=M.videoCodecs.filter(L=>!(L.rtpMap&&"h264"===L.rtpMap.encodingName.toLocaleLowerCase()&&L.fmtp&&"42001f"!==L.fmtp.parameters["profile-level-id"])))}}return{send:M,recv:U,sendrecv:V}}({},{},k);this.remoteSDP=new yM({remoteIceParameters:M.iceParameters,remoteDtlsParameters:M.dtlsParameters,candidates:[],remoteRTPCapabilities:U,localCapabilities:this.localCapabilities,direction:this.direction,setup:"actpass",videoCodec:this.store.codec,audioCodec:this.store.audioCodec}),await this.setRemoteDescription({type:"offer",sdp:this.remoteSDP.toString()}),this.isReady=!0;let V=await this.peerConnection.createAnswer();if(!V.sdp)throw Error("Cannot get answer sdp when trying to establish PeerConnection.");let F=vx(V.sdp);await this.peerConnection.setLocalDescription(V);let B=await kx({},{},V.sdp);this.localCapabilities=Ux(B);let j=this.peerConnection.getTransceivers()[0];return null!=j&&j.receiver&&j.receiver.transport&&this.tryBindTransportEvents(j.receiver.transport),eq(eq({},F),{},{sdp:V.sdp})}{this.peerConnection.addTransceiver("video",{direction:"sendonly"}),this.peerConnection.addTransceiver("audio",{direction:"sendonly"});let L=await this.peerConnection.createOffer();if(!L.sdp)throw Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");let k=vx(L.sdp);return this.initialOffer=L,eq(eq({},k),{},{sdp:L.sdp})}}catch(L){throw new f2(f1.GET_LOCAL_CONNECTION_PARAMS_FAILED,L.toString())}}async connect(L){try{if(!this.initialOffer)throw Error("Cannot establish P2PConnection without initial offer.");await this.peerConnection.setLocalDescription(this.initialOffer);let{sdp:k,iceParameters:M,dtlsParameters:U}=L,V=await kx({},{},k);this.remoteSDP=new yM({remoteIceParameters:M,remoteDtlsParameters:U,candidates:[],remoteRTPCapabilities:V,localCapabilities:this.localCapabilities,direction:this.direction,setup:"active",videoCodec:this.store.codec,audioCodec:this.store.audioCodec}),await this.setRemoteDescription({type:"answer",sdp:this.remoteSDP.toString()});let F=this.peerConnection.getTransceivers()[0];null!=F&&F.sender&&F.sender.transport&&this.tryBindTransportEvents(F.sender.transport)}catch(L){throw new f2(f1.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(L.toString()))}}async addRemoteCandidate(L){try{L&&this.pendingCandidates.push(L),this.peerConnection.remoteDescription&&this.isReady&&(this.pendingCandidates.forEach(L=>{this.peerConnection.addIceCandidate(L)}),this.pendingCandidates=[])}catch(L){throw new f2(f1.ADD_CANDIDATE_FAILED,"P2PConnection.addRemoteCandidate failed; ".concat(L.toString()))}}send(L,k,M){var U=this;return qb(function*(){let V=yield Jb(U.mutex.lock("From P2PConnection.send"));try{if(!U.remoteSDP)throw Error("Cannot call P2PConnection.send before remote SDP created");let V=[],F=U.remoteSDP.receive(L,k,M);L.forEach((L,k)=>{if(F[k].needCreateTransceiver){let k=U.peerConnection.addTransceiver(L._mediaStreamTrack,{direction:"sendonly"});V.push(k),L._updateRtpTransceiver(k)}else{let M=U.peerConnection.getTransceivers().find(L=>L.mid===F[k].mid);if(!M)throw Error("cannot find transceiver when sendPeerconnection send, mid is ".concat(F[k].mid));V.push(M),L._updateRtpTransceiver(M)}}),iw()&&!0===wN("SIMULCAST")&&(yield Jb(U.applySimulcastForFirefox(V,L)));let B=F.map(L=>L.mid),j=yield Jb(U.peerConnection.createOffer()),G=U.mungSendOfferSDP(j.sdp,L,B),X=FN(G),$=B.map(L=>{let k=X.mediaDescriptions.find(k=>k.attributes.mid===L);if(!k)throw Error("Cannot extract ssrc from mediaDescription.");return Cx(k,wN("USE_PUB_RTX"))}),ee=V.map((L,k)=>{let M=B[k];return{localSSRC:$[k],id:M}});yield Jb(U.peerConnection.setLocalDescription({type:"offer",sdp:G}));try{yield ee}catch(k){let L=U.remoteSDP.toString();throw yield Jb(U.peerConnection.setLocalDescription({type:"offer",sdp:G})),yield Jb(U.peerConnection.setRemoteDescription({type:"answer",sdp:L})),yield Jb(U.stopSending(B,!0)),k}yield Jb(U.applySimulcastEncodings(V,L)),yield Jb(U.applySendEncodings(V,L));let et=U.remoteSDP.toString(),ei=U.logSDPExchange(G,"offer","local","send");return null==ei||ei(et),yield Jb(U.setRemoteDescription({type:"answer",sdp:et})),V.map((L,k)=>{let M=B[k];return{localSSRC:$[k],id:M}})}catch(L){throw L instanceof f2?L:new f2(f1.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(L.toString()))}finally{V()}})()}async stopSending(L,k){let M=k?void 0:await this.mutex.lock("From P2PConnection.stopSending");try{if(!this.remoteSDP)throw Error("Cannot call P2PConnection.stopSending before remote SDP created");let k=this.peerConnection.getTransceivers().filter(k=>-1!==L.indexOf(k.mid));if(k.length!==L.length)throw Error("Transceivers' length (".concat(k.length,") doesn't match mids' length (").concat(L.length,") when trying to call P2PConnection.stopSending."));k.map(L=>{var k;L.direction="inactive",null===(k=L.stop)||void 0===k||k.call(L)});let M=await this.peerConnection.createOffer(),U=this.logSDPExchange(M.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(M),this.remoteSDP.stopReceiving(L);let V=this.remoteSDP.toString();null==U||U(V),await this.setRemoteDescription({type:"answer",sdp:V})}catch(L){throw new f2(f1.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(L.toString()))}finally{M&&M()}}async receive(L,k,M,U){try{if(!this.remoteSDP)throw Error("Cannot call P2PConnection.receive ".concat(L," before remoteSDP created."));let{mid:V,needExchangeSDP:F}=this.remoteSDP.send(L,k,M,U);if(F){let k=this.remoteSDP.toString(),M=this.logSDPExchange(k,"offer","remote","receive");await this.setRemoteDescription({type:"offer",sdp:k});let U=await this.peerConnection.createAnswer(),F=this.mungReceiveAnswerSDP(U.sdp,V,L);null==M||M(F||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:F}),gc.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(L," by exchanging SDP."))}else gc.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(L," no need to exchange SDP."));let B=this.peerConnection.getTransceivers().find(L=>L.mid===V);if(!B||null===B.mid)throw Error("Cannot get transceiver after setLocalDescription.");return{track:B.receiver.track,mid:B.mid,transceiver:B}}catch(L){throw new f2(f1.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(L.toString()))}}async mockReceive(L,k,M,U){try{if(!this.remoteSDP)throw Error("Cannot call P2PConnection.receive ".concat(L," before remoteSDP created."));let{mid:V,needExchangeSDP:F}=this.remoteSDP.send(L,k,M,U);if(F){let k=this.remoteSDP.toString(),M=this.logSDPExchange(k,"offer","remote","receive");await this.setRemoteDescription({type:"offer",sdp:k});let U=await this.peerConnection.createAnswer(),F=this.mungReceiveAnswerSDP(U.sdp,V,L);null==M||M(F||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:F}),gc.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(L," by exchanging SDP."))}else gc.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(L," no need to exchange SDP."))}catch(L){throw new f2(f1.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(L.toString()))}}async stopReceiving(L){try{if(!this.remoteSDP)throw Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(L);let k=this.remoteSDP.toString(),M=this.logSDPExchange(k,"offer","remote","stopReceiving");await this.setRemoteDescription({type:"offer",sdp:k});let U=await this.peerConnection.createAnswer();null==M||M(U.sdp||""),await this.peerConnection.setLocalDescription(U)}catch(L){throw new f2(f1.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(L.toString()))}}async restartICE(L){try{if(this.store.p2pTransport===SQ.Auto&&(this.store.p2pTransport=SQ.SdRtn,gf.supportPCSetConfiguration&&this.peerConnection.setConfiguration(e.resolvePCConfiguration(this.spec,this.store.p2pTransport))),this.restartCnt>3&&(this.restartCnt=0,gf.supportPCSetConfiguration&&this.peerConnection.setConfiguration(e.resolvePCConfiguration(this.spec,this.store.p2pTransport,++this.curTurnServerIndex))),!L){this.restartCnt++,this.isReady=!1;let L=await this.peerConnection.createOffer({iceRestart:!0});if(!L.sdp)throw Error("Cannot restartICE because restart offer SDP does not exist.");let{iceParameters:k}=vx(L.sdp);return this.store.descriptionStart(),this.direction===RR.SEND_ONLY&&await this.peerConnection.setLocalDescription(L),k}if(!this.remoteSDP)throw Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");if(this.remoteSDP.restartICE(L),this.store.descriptionStart(),this.direction===RR.RECEIVE_ONLY){this.restartCnt++,await this.setRemoteDescription({type:"offer",sdp:this.remoteSDP.toString()});let L=await this.peerConnection.createAnswer();if(!L.sdp)throw Error("Cannot get answer sdp when trying to iceRestart.");let{iceParameters:k}=vx(L.sdp);return await this.peerConnection.setLocalDescription(L),k}await this.setRemoteDescription({type:"answer",sdp:this.remoteSDP.toString()}),this.isReady=!0}catch(L){throw new f2(f1.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(L.toString()))}}close(){var L;this.peerConnection.close(),this.peerConnection.onicecandidate=null,null===(L=this.onConnectionStateChange)||void 0===L||L.call(this,"closed"),this.tryUnbindTransportEvents(),this.unbindPCEvents(),this.unbindStatsEvents(),this.transport=void 0,this.statsFilter.destroy()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(L){return this.statsFilter.getVideoIsReady(L)}async updateEncoderConfig(L,k){try{if(!this.remoteSDP)throw Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");let M=await this.peerConnection.createOffer(),U=this.mungSendOfferSDP(M.sdp,[k],[L]);this.remoteSDP.updateRecvMedia(L,k);let V=this.remoteSDP.toString(),F=this.logSDPExchange(U,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:U}),null==F||F(V),await this.peerConnection.setRemoteDescription({type:"answer",sdp:V})}catch(L){throw new f2(f1.EXCHANGE_SDP_FAILED,L.toString())}}async updateSendParameters(L,k){let M=this.peerConnection.getTransceivers().filter(k=>k.mid===L);1===M.length&&(this.isVP8Simulcast(k)?iw()||await this.applySimulcastEncodings(M,[k]):await this.applySendEncodings(M,[k]))}setStatsRemoteVideoIsReady(L,k){this.statsFilter.setVideoIsReady2(L,k)}async replaceTrack(L,k){let M=this.peerConnection.getTransceivers().find(L=>L.mid===k);M&&await M.sender.replaceTrack(L._mediaStreamTrack)}async getSelectedCandidatePair(){let L=this.peerConnection.getReceivers();if(L.length>0&&L[0].transport&&L[0].transport.iceTransport&&L[0].transport.iceTransport.getSelectedCandidatePair&&L[0].transport.iceTransport.getSelectedCandidatePair()){let k=L[0].transport.iceTransport,{local:M,remote:U}=k.getSelectedCandidatePair();return{local:eq(eq({},Sv),{},{candidateType:M.type,protocol:M.protocol,address:M.address,port:M.port}),remote:eq(eq({},Sv),{},{candidateType:U.type,protocol:U.protocol,address:U.address,port:U.port})}}return this.statsFilter.getSelectedCandidatePair()}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var L,k;so(L=["connected","completed"]).call(L,this.peerConnection.iceConnectionState)&&(this.isReady=!1),null===(k=this.onICEConnectionStateChange)||void 0===k||k.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var L;"connected"===this.peerConnection.connectionState&&(this.restartCnt=0),null===(L=this.onConnectionStateChange)||void 0===L||L.call(this,this.peerConnection.connectionState)},this.startICECandidate()}startICECandidate(){this.peerConnection.onicecandidate||(this.localCandidateCount=0,this.peerConnection.onicecandidate=L=>{if(L.candidate){var k;L.candidate.candidate&&(null===(k=this.onLocalCandidate)||void 0===k||k.call(this,L.candidate.toJSON())),this.localCandidateCount+=1}else gc.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount)})}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(L,k){var M;let U=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,V={iceServers:[]};return L.iceServers?V.iceServers=L.iceServers:L.turnServer&&"off"!==L.turnServer.mode&&(Qw(L.turnServer.servers)?V.iceServers=L.turnServer.servers:(V.iceServers&&V.iceServers.push(...e.turnServerConfigToIceServers(L.turnServer.servers,k,U)),wN("USE_TURN_SERVER_OF_GATEWAY")&&V.iceServers&&L.turnServer.serversFromGateway&&V.iceServers.push(...e.turnServerConfigToIceServers(L.turnServer.serversFromGateway,k,U)),so(M=[SQ.Relay,SQ.SdRtn]).call(M,k)&&(V.iceTransportPolicy="relay"),wN("FORCE_TURN_TCP")?V.iceTransportPolicy="relay":L.turnServer.servers.concat(L.turnServer.serversFromGateway||[]).forEach(L=>{L.forceturn&&(V.iceTransportPolicy="relay")}))),wN("ENABLE_ENCODED_TRANSFORM")&&gf.supportWebRTCEncodedTransform&&(V.encodedInsertableStreams=!0),gc.debug("P2PConnection p2pTransport is ".concat(k)),V}static turnServerConfigToIceServers(L,k){let M=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,U=[],V=L.filter(L=>L.tcpport);gc.debug("P2PConnection turnServers is ".concat(V,", current index is ").concat(M));let F=V.length>M?V[M]:V[0];switch(k){case SQ.SdRtn:let B=L.filter(L=>{var k;return so(k=L.username).call(k,"glb:")&&L.turnServerURL==L.turnServerURL}),j=B.length>M?B[M]:B[0];j&&(U.push({username:j.username,credential:j.password,credentialType:"password",urls:"turn:".concat(ix(j.turnServerURL),":").concat(j.tcpport,"?transport=udp")}),U.push({username:j.username,credential:j.password,credentialType:"password",urls:"turns:".concat(ix(j.turnServerURL),":").concat(j.tcpport,"?transport=tcp")}));break;case SQ.Relay:F&&(U.push({username:F.username,credential:F.password,credentialType:"password",urls:"turn:".concat(F.turnServerURL,":").concat(F.tcpport,"?transport=udp")}),U.push({username:F.username,credential:F.password,credentialType:"password",urls:"turns:".concat(ix(F.turnServerURL),":").concat(F.tcpport,"?transport=tcp")}));break;default:F&&(U.push({username:F.username,credential:F.password,credentialType:"password",urls:"turn:".concat(F.turnServerURL,":").concat(F.tcpport,"?transport=udp")}),U.push({username:F.username,credential:F.password,credentialType:"password",urls:"turns:".concat(ix(F.turnServerURL),":").concat(F.tcpport,"?transport=tcp")}),U.push({username:F.username,credential:F.password,credentialType:"password",urls:"stun:".concat(F.turnServerURL,":").concat(F.tcpport)}))}return U}tryBindTransportEvents(L){if(L){this.transport=L,L.onstatechange=()=>{var k;null!=L&&L.state&&(null===(k=this.onDTLSTransportStateChange)||void 0===k||k.call(this,L.state))},L.onerror=L=>{var k;null===(k=this.onDTLSTransportError)||void 0===k||k.call(this,"error"in L?L.error:L)};let k=L.iceTransport;k&&(k.onstatechange=()=>{var k;let M=null==L?void 0:L.iceTransport.state;M&&(null===(k=this.onICETransportStateChange)||void 0===k||k.call(this,M))},k.getSelectedCandidatePair&&(k.onselectedcandidatepairchange=()=>{if(k.getSelectedCandidatePair()){let{local:L,remote:M}=k.getSelectedCandidatePair()||{};if(L&&M){let k=L.address+":"+L.port,U=M.address+":"+M.port;gc.info("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] selectedcandidatepairchange: local ").concat(JSON.stringify(hx(k)),", remote ").concat(JSON.stringify(hx(U))))}}}))}}tryUnbindTransportEvents(){this.transport&&(this.transport.onstatechange=null,this.transport.onerror=null,this.transport.iceTransport&&(this.transport.iceTransport.onstatechange=null))}async updateRtpSenderEncodings(L,k){var M,U,V;if(k||(k=this.peerConnection.getSenders().find(k=>k.track===L._mediaStreamTrack)),!k)return gc.warn("[".concat(L.getTrackId(),"] no rtpSender found}"));if(this.isVP8Simulcast(L))return gc.warn("[updateRtpSenderEncodings] Track is VP8 simulcast, please apply simulcast encodings");if(!gf.supportSetRtpSenderParameters)return gc.warn("[updateRtpSenderEncodings] Browser not support set rtp-sender parameters");let F={},B={};switch(L._optimizationMode){case"motion":F.degradationPreference="maintain-framerate";break;case"detail":F.degradationPreference="maintain-resolution";break;default:F.degradationPreference="balanced"}if(L._encoderConfig){let{bitrateMax:k,frameRate:M,scaleResolutionDownBy:V}=L._encoderConfig;k&&(B.maxBitrate=1e3*k),so(U=L._hints).call(U,gL.LOW_STREAM)&&(M&&(B.maxFramerate=ox(M)),V&&V>=1&&(B.scaleResolutionDownBy=V))}if(wN("DSCP_TYPE")&&vw()){let L=wN("DSCP_TYPE");so(V=["very-low","low","medium","high"]).call(V,L)&&(B.networkPriority=L)}let j=k.getParameters(),G=null===(M=j.encodings)||void 0===M?void 0:M[0];iw()&&!G&&(F.encodings=[B]),G&&Object.assign(G,B),Object.assign(j,F),gc.debug("[".concat(L.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(j.encodings))),await k.setParameters(j)}async applySendEncodings(L,k){try{if(!gf.supportSetRtpSenderParameters||L.length!==k.length)return;for(let M=0;M<L.length;M++){let U=L[M],V=k[M];V instanceof Tp&&!this.isVP8Simulcast(V)&&await this.updateRtpSenderEncodings(V,U.sender)}}catch(L){gc.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(L,k,M){let U=FN(L);return k.forEach((L,k)=>{let V=M[k],F=U.mediaDescriptions.find(L=>L.attributes.mid===V);F&&(Ax(F,L),Px(F,L,this.store.codec))}),BN(U)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=L=>{var k;null===(k=this.onFirstAudioReceived)||void 0===k||k.call(this,L)},this.statsFilter.onFirstVideoReceived=L=>{var k;null===(k=this.onFirstVideoReceived)||void 0===k||k.call(this,L)},this.statsFilter.onFirstAudioDecoded=L=>{var k;null===(k=this.onFirstAudioDecoded)||void 0===k||k.call(this,L)},this.statsFilter.onFirstVideoDecoded=(L,k,M)=>{var U;null===(U=this.onFirstVideoDecoded)||void 0===U||U.call(this,L,k,M)},this.statsFilter.onSelectedLocalCandidateChanged=(L,k)=>{var M;null===(M=this.onSelectedLocalCandidateChanged)||void 0===M||M.call(this,L,k)},this.statsFilter.onSelectedRemoteCandidateChanged=(L,k)=>{var M;null===(M=this.onSelectedRemoteCandidateChanged)||void 0===M||M.call(this,L,k)},this.statsFilter.onFirstVideoDecodedTimeout=L=>{var k;null===(k=this.onFirstVideoDecodedTimeout)||void 0===k||k.call(this,L)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(L,k){if(L.length===k.length)for(let j=0;j<L.length;j++){var M,U,V,F,B;let G=L[j],X=k[j];if(X instanceof Tp&&!so(M=X._hints).call(M,gL.LOW_STREAM)&&null!==(U=X._encoderConfig)&&void 0!==U&&U.bitrateMax&&(null===(V=X._encoderConfig)||void 0===V?void 0:V.bitrateMax)>200&&null!==(F=X._scalabilityMode)&&void 0!==F&&F.numSpatialLayers&&(null===(B=X._scalabilityMode)||void 0===B?void 0:B.numSpatialLayers)>1&&"vp8"===this.store.codec){let L={},k={high:1e3*(X._encoderConfig.bitrateMax-50),medium:5e4};L.encodings=[{rid:"m",active:!0,maxBitrate:k.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:k.high}];let M=G.sender.getParameters();await G.sender.setParameters(Object.assign(M,L))}}}async applySimulcastEncodings(L,k){if(!iw()&&L.length===k.length)for(let M=0;M<L.length;M++){let U=k[M];if(U instanceof Tp&&this.isVP8Simulcast(U)){let k=L[M],V={},F={high:1e3*(U._encoderConfig.bitrateMax-50),medium:5e4};V.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:F.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:F.medium,scaleResolutionDownBy:4}];let B=k.sender.getParameters();await k.sender.setParameters(Object.assign(B,V))}}}isVP8Simulcast(L){var k,M,U,V,F;return!!(L instanceof Tp&&wN("SIMULCAST")&&"vp8"===this.store.codec&&!so(k=L._hints).call(k,gL.LOW_STREAM)&&null!==(M=L._encoderConfig)&&void 0!==M&&M.bitrateMax&&(null===(U=L._encoderConfig)||void 0===U?void 0:U.bitrateMax)>200&&null!==(V=L._scalabilityMode)&&void 0!==V&&V.numSpatialLayers&&(null===(F=L._scalabilityMode)||void 0===F?void 0:F.numSpatialLayers)>1)}logSDPExchange(L,k,M,U){if(wN("SDP_LOGGING"))return gc.upload("[".concat(this.store.clientId,"] exchanging ").concat(M," ").concat(k," SDP during P2PConnection.").concat(U,"\n"),L),"offer"===k?L=>{this.logSDPExchange(L,"answer","local"===M?"remote":"local",U)}:void 0}async muteLocal(L){try{if(!this.remoteSDP)throw Error("Cannot call P2PConnection.muteLocal before remote SDP created.");let k=this.peerConnection.getTransceivers().filter(k=>k.mid&&-1!==L.indexOf(k.mid));if(k.length!==L.length)throw Error("Transceivers' length doesn't match mids' length.");k.map(L=>{L.direction="inactive"});let M=await this.peerConnection.createOffer(),U=this.logSDPExchange(M.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(M),this.remoteSDP.muteRemote(L);let V=this.remoteSDP.toString();null==U||U(V),await this.setRemoteDescription({type:"answer",sdp:V})}catch(L){throw new f2(f1.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(L.toString()))}}async unmuteLocal(L){try{if(!this.remoteSDP)throw Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");let k=this.peerConnection.getTransceivers().filter(k=>k.mid&&-1!==L.indexOf(k.mid));if(k.length!==L.length)throw Error("Transceivers' length doesn't match mids' length.");k.map(async L=>{L.direction="sendonly"});let M=await this.peerConnection.createOffer(),U=this.logSDPExchange(M.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(M),this.remoteSDP.unmuteRemote(L);let V=this.remoteSDP.toString();null==U||U(V),await this.setRemoteDescription({type:"answer",sdp:V})}catch(L){throw new f2(f1.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(L.toString()))}}async getRemoteSSRC(L,k){var M,U;if(k=null!=k?k:null===(M=this.currentRemoteDescription)||void 0===M?void 0:M.sdp){let M=null===(U=FN(k).mediaDescriptions.find(k=>k.attributes.mid===L))||void 0===U?void 0:U.attributes.ssrcs;return null==M?void 0:M[0].ssrcId}}async setRemoteDescription(L){var k;await this.peerConnection.setRemoteDescription(L),so(k=["connected","completed"]).call(k,this.peerConnection.iceConnectionState)||(this.isReady=!0,this.addRemoteCandidate())}mungReceiveAnswerSDP(L,k,M){let U=FN(L),V=U.mediaDescriptions.find(L=>L.attributes.mid===k);return V&&M===R1.AUDIO&&"audio"===V.media.mediaType&&Vx(V),BN(U)}}).prototype,"establish",[iq],Object.getOwnPropertyDescriptor(n0.prototype,"establish"),n0.prototype),OU(n0.prototype,"connect",[iq],Object.getOwnPropertyDescriptor(n0.prototype,"connect"),n0.prototype),OU(n0.prototype,"receive",[iq],Object.getOwnPropertyDescriptor(n0.prototype,"receive"),n0.prototype),OU(n0.prototype,"mockReceive",[iq],Object.getOwnPropertyDescriptor(n0.prototype,"mockReceive"),n0.prototype),OU(n0.prototype,"stopReceiving",[iq],Object.getOwnPropertyDescriptor(n0.prototype,"stopReceiving"),n0.prototype),OU(n0.prototype,"restartICE",[iq],Object.getOwnPropertyDescriptor(n0.prototype,"restartICE"),n0.prototype),OU(n0.prototype,"close",[iq],Object.getOwnPropertyDescriptor(n0.prototype,"close"),n0.prototype),OU(n0.prototype,"updateEncoderConfig",[iq],Object.getOwnPropertyDescriptor(n0.prototype,"updateEncoderConfig"),n0.prototype),OU(n0.prototype,"updateSendParameters",[iq],Object.getOwnPropertyDescriptor(n0.prototype,"updateSendParameters"),n0.prototype),OU(n0.prototype,"replaceTrack",[iq],Object.getOwnPropertyDescriptor(n0.prototype,"replaceTrack"),n0.prototype),OU(n0.prototype,"muteLocal",[iq],Object.getOwnPropertyDescriptor(n0.prototype,"muteLocal"),n0.prototype),OU(n0.prototype,"unmuteLocal",[iq],Object.getOwnPropertyDescriptor(n0.prototype,"unmuteLocal"),n0.prototype),n0);function iq(L,k,M){let U=L[k];if("function"!=typeof U)throw Error("Cannot use mutex on object property.");return M.value=async function(){let L=this.mutex,M=await L.lock("From P2PConnection.".concat(k));try{for(var V=arguments.length,F=Array(V),B=0;B<V;B++)F[B]=arguments[B];return await U.apply(this,F)}finally{M()}},M}let yj=((ie={}).SEND_ONLY="SEND_ONLY",ie.RECEIVE_ONLY="RECEIVE_ONLY",ie);function mq(L,k){var M=Object.keys(L);if(Object.getOwnPropertySymbols){var U=Object.getOwnPropertySymbols(L);k&&(U=U.filter(function(k){return Object.getOwnPropertyDescriptor(L,k).enumerable})),M.push.apply(M,U)}return M}function fq(L){for(var k=1;k<arguments.length;k++){var M=null!=arguments[k]?arguments[k]:{};k%2?mq(Object(M),!0).forEach(function(k){uI(L,k,M[k])}):Object.getOwnPropertyDescriptors?Object.defineProperties(L,Object.getOwnPropertyDescriptors(M)):mq(Object(M)).forEach(function(k){Object.defineProperty(L,k,Object.getOwnPropertyDescriptor(M,k))})}return L}let yW=(n1=gq(yj.SEND_ONLY),n2=gq(yj.SEND_ONLY),n3=gq(),n5=gq(yj.RECEIVE_ONLY),n4=gq(yj.RECEIVE_ONLY),n6=gq(yj.RECEIVE_ONLY),n8=gq(yj.RECEIVE_ONLY),n9=gq(yj.RECEIVE_ONLY),n7=gq(yj.RECEIVE_ONLY),ae=gq(),at=gq(yj.RECEIVE_ONLY),OU((ai=class extends Hw{get state(){return this._state}set state(L){let k=this._state;this._state=L,this.emit(R8.StateChange,k,this._state)}constructor(L,k){super(),uI(this,"isPlanB",!1),uI(this,"store",void 0),uI(this,"statsUploader",void 0),uI(this,"sendConnection",void 0),uI(this,"recvConnection",void 0),uI(this,"localTrackMap",new Map),uI(this,"remoteUserMap",new Map),uI(this,"localDataChannels",[]),uI(this,"pendingLocalTracks",[]),uI(this,"pendingRemoteTracks",[]),uI(this,"statsCollector",void 0),uI(this,"dtlsFailedCount",0),uI(this,"sendMutex",void 0),uI(this,"recvMutex",void 0),uI(this,"_state",R6.Disconnected),uI(this,"_restartStates",["disconnected","failed"]),uI(this,"reconnectInterval",void 0),uI(this,"uploadUnplinkStarted",!1),uI(this,"uploadDownlinkStarted",!1),uI(this,"uplinkStateUploadInterval",void 0),uI(this,"downlinkStatsUploadInterval",void 0),uI(this,"handleMuteLocalTrack",async(L,k,M)=>{let U=await this.sendMutex.lock("Locking from P2PChannel2.handleMuteLocalTrack");try{var V,F;if(!this.sendConnection||this.state!==R6.Connected)return void M(new f2(f1.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before sendConnection established."));let U=this.filterTobeMutedTracks(L);if(0===U.length)return void k();let B=U.find(L=>"videoLowTrack"===L[0]);B&&B[1].track._originMediaStreamTrack.stop(),await this.sendConnection.muteLocal(U.map(L=>{let[,{id:k}]=L;return k}));let j=!1;j="video"===L.trackMediaType?!(null===(V=this.localTrackMap.get(R4.LocalAudioTrack))||void 0===V||!V.track._muted):void 0===(null===(F=this.localTrackMap.get(R4.LocalVideoTrack))||void 0===F?void 0:F.id);let G=this.createMuteMessage(U);await sO(this,R8.RequestMuteLocal,G);let X="video"===L.trackMediaType?Ic.MUTE_LOCAL_VIDEO:Ic.MUTE_LOCAL_AUDIO;await sO(this,R8.RequestP2PMuteLocal,{action:X,message:G,isMuteAll:j}),k()}catch(L){M(L)}finally{U()}}),uI(this,"handleUnmuteLocalTrack",async(L,k,M)=>{let U=await this.sendMutex.lock("Locking from P2PChannel2.handleUnmuteLocalTrack");try{if(!this.sendConnection||this.state!==R6.Connected)return void M(new f2(f1.INVALID_OPERATION,"Cannot call P2PChannel2.handleUnmuteLocalTrack before sendConnection established."));let U=this.filterTobeUnmutedTracks(L);if(0===U.length)return void k();await this.sendConnection.unmuteLocal(U.map(L=>{let[,{id:k}]=L;return k}));let V=this.createUnmuteMessage(U),F="video"===L.trackMediaType?Ic.UNMUTE_LOCAL_VIDEO:Ic.UNMUTE_LOCAL_AUDIO;await sO(this,R8.RequestP2PMuteLocal,{action:F,message:V}),k()}catch(L){M(L)}finally{U()}}),uI(this,"handleUpdateVideoEncoder",async(L,k,M,U)=>{let V;"boolean"==typeof U&&U||(V=await this.sendMutex.lock("Locking from P2PChannel2.handleUpdateVideoEncoder"));try{let M=this.localTrackMap.get(R4.LocalVideoTrack);if(!this.sendConnection||!M||M.track!==L||this.state!==R6.Connected)return void k();let{id:U,track:V}=M;U&&(await this.sendConnection.updateSendParameters(U,V),await this.sendConnection.updateEncoderConfig(U,V),this.emit(R8.UpdateVideoEncoder,V)),k()}catch(L){M(L)}finally{var F;null===(F=V)||void 0===F||F()}}),uI(this,"handleUpdateVideoSendParameters",async(L,k,M)=>{let U=await this.sendMutex.lock("Locking from P2PChannel2.handleUpdateVideoSendParameters");try{let M=this.localTrackMap.get(R4.LocalVideoTrack);if(!this.sendConnection||!M||M.track!==L||this.state!==R6.Connected)return void k();let{id:U,track:V}=M;U&&await this.sendConnection.updateSendParameters(U,V),k()}catch(L){M(L)}finally{U()}}),uI(this,"handleReplaceTrack",async(L,k,M,U)=>{var V,F;let B;gc.debug("[".concat(this.store.clientId,"] P2PChannel2 handleReplaceTrack for [track-id-").concat(L.getTrackId(),"]")),"boolean"==typeof U&&U||(B=await this.sendMutex.lock("From P2PChannel2.handleReplaceTrack"));try{let M=Array.from(this.localTrackMap.entries()).find(k=>{let[,{track:M}]=k;return L===M});if(!this.sendConnection||!M||void 0===M[1].id||this.state!==R6.Connected)return void k();if(await (null===(V=this.sendConnection)||void 0===V?void 0:V.replaceTrack(L,M[1].id)),M[0]===R4.LocalVideoTrack&&gf.supportDualStreamEncoding){let k=this.localTrackMap.get(R4.LocalVideoLowTrack);if(k){let M=L._mediaStreamTrack.clone();k.track._originMediaStreamTrack.stop(),k.track._mediaStreamTrack=M,k.track._originMediaStreamTrack=M,await new lQ((L,M)=>{this.handleReplaceTrack(k.track,L,M,!0)})}}k()}catch(L){M(L)}finally{null===(F=B)||void 0===F||F()}}),uI(this,"handleGetLocalVideoStats",L=>{L(this.statsCollector.getLocalVideoTrackStats())}),uI(this,"handleGetLocalAudioStats",L=>{L(this.statsCollector.getLocalAudioTrackStats())}),uI(this,"handleGetRemoteVideoStats",L=>this.statsCollector.getRemoteVideoTrackStats(L.uid)[L.uid]),uI(this,"handleGetRemoteAudioStats",L=>this.statsCollector.getRemoteAudioTrackStats(L.uid)[L.uid]),this.store=L,this.statsCollector=k,this.statsCollector.addP2PChannel(this),this.statsUploader=new GB(L),this.bindStatsUploaderEvents(),this.sendMutex=new S_("P2PChannel2-send-mutex",L.clientId),this.recvMutex=new S_("P2PChannel2-recv-mutex",L.clientId),this.reconnectInterval=window.setInterval(()=>{[this.sendConnection,this.recvConnection].forEach(L=>{L&&("disconnected"!==L.iceConnectionState&&"failed"!==L.iceConnectionState||this.handleDisconnect(L.direction))})},wN("ICE_RESTART_INTERVAL"))}async startP2PConnection(L,k){throw new f2(f1.NOT_SUPPORTED,"p2p mode does not support startP2PConnection.")}async connect(L){throw new f2(f1.NOT_SUPPORTED,"p2p mode does not support connect.")}async startP2P(L,k){let M;try{if(k){this.recvConnection&&(gc.warning("[".concat(this.store.clientId,"] P2PChannel.startP2P reset recvConnection.")),this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection)),M=await this.recvMutex.lock("From P2PChannel.startP2P"),this.recvConnection=new yV(L,this.store,RR.RECEIVE_ONLY),this.bindConnectionEvents(this.recvConnection);let U=await this.recvConnection.establish(k);return{iceParameters:U.iceParameters,dtlsParameters:U.dtlsParameters,sdp:U.sdp}}{this.state=R6.New,this.sendConnection&&(gc.warning("[".concat(this.store.clientId,"] P2PChannel.startP2P reset sendConnection.")),this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection)),M=await this.sendMutex.lock("From P2PChannel.startP2P"),this.sendConnection=new yV(L,this.store),this.store.peerConnectionStart(),this.bindConnectionEvents(this.sendConnection);let k=await this.sendConnection.establish();return{iceParameters:k.iceParameters,dtlsParameters:k.dtlsParameters,sdp:k.sdp}}}finally{M&&M()}}async p2pConnect(L){if(!this.sendConnection)throw new f2(f1.UNEXPECTED_ERROR,"Cannot P2PChannel2.p2pConnect before P2PChannel2.startP2PConnection .");this.store.peerConnectionStart(),await this.sendConnection.connect(L),this.statsUploader.startUploadTransportStats(),this.statsUploader.startUploadExtensionUsageStats(),this.state=R6.Connected}async addRemoteCandidate(L,k){if(k===RR.RECEIVE_ONLY){if(!this.sendConnection)throw new f2(f1.UNEXPECTED_ERROR,"Cannot P2PChannel2.connect before P2PChannel2.addRemoteCandidate .");await this.sendConnection.addRemoteCandidate(L)}else{if(!this.recvConnection)throw new f2(f1.UNEXPECTED_ERROR,"Cannot P2PChannel2.connect before P2PChannel2.addRemoteCandidate .");await this.recvConnection.addRemoteCandidate(L)}}publish(L,k,M){var U=this;return qb(function*(){let V=yield Jb(U.sendMutex.lock("From P2PChannel.publish"));try{if(!U.sendConnection||U.state!==R6.Connected){U.throwIfTrackTypeNotMatch(L);let k=L.filter(L=>-1===U.pendingLocalTracks.indexOf(L));return void(U.pendingLocalTracks=U.pendingLocalTracks.concat(k))}U.store.pubId=U.store.pubId+1,IW.markPublishStart(U.store.clientId,U.store.pubId);let V=U.filterTobePublishedTracks(L,k,M);if(0===V.length)return void(yield Jb(U.tryToUnmuteAudio(L)));V.forEach(L=>{let{track:k,type:M}=L,V=Date.now();U.store.publish(k.getTrackId(),M===R4.LocalAudioTrack?"audio":"video",V)}),U.bindLocalTrackEvents(V);let F=yield Jb(U.sendConnection.send(V.map(L=>{let{track:k}=L;return k}),U.store.codec,U.store.audioCodec)),B=(yield Jb(F.next())).value,j=U.createGatewayPublishMessage(V,B);try{yield j}catch(L){throw F.throw(L),(null==L?void 0:L.code)===f1.WS_ABORT&&V.forEach(L=>{let{track:k}=L;-1===U.pendingLocalTracks.indexOf(k)&&U.pendingLocalTracks.push(k)}),U.unbindLocalTrackEvents(V),L}yield Jb(F.next()),V.forEach(L=>{let{type:k}=L;U.statsCollector.addLocalStats(k)}),U.statsUploader.startUploadOutboundStats(),U.assignLocalTracks(V,B),V.forEach(L=>{let{track:k,type:M}=L,V=Date.now();U.store.publish(k.getTrackId(),M===R4.LocalAudioTrack?"audio":"video",void 0,V)}),U.startUploadUplinkState()}finally{V()}})()}async unpublish(L){if(!this.sendConnection||this.state!==R6.Connected)return void(0===L.length?this.pendingLocalTracks.length=0:this.pendingLocalTracks=this.pendingLocalTracks.filter(k=>!so(L).call(L,k)));let k=this.filterTobeUnpublishedTracks(L);if(0===k.length)return;let M=k.find(L=>"videoLowTrack"===L[0]);M&&M[1].track.close();let U=this.createGatewayUnpublishMessage(k);if(await this.sendConnection.stopSending(k.map(L=>{let[,{id:k}]=L;return k})),this.withdrawLocalTracks(k),this.unbindLocalTrackEvents(k.map(L=>{let[k,{track:M}]=L;return{type:k,track:M}})),k.forEach(L=>{let[k]=L;this.statsCollector.removeLocalStats(k)}),0===this.localTrackMap.size&&(this.statsUploader.stopUploadOutboundStats(),this.stopUploadUplinkState()),this.sendConnection&&this.state===R6.Connected)return M&&M[1].track.close(),U;L.forEach(L=>{let k=this.pendingLocalTracks.indexOf(L);-1!==k&&this.pendingLocalTracks.splice(k,1)})}startUploadUplinkState(){if(this.uploadUnplinkStarted)return;this.uploadUnplinkStarted=!0,this.uplinkStateUploadInterval&&window.clearInterval(this.uplinkStateUploadInterval);let e=()=>{let L=[],k=[];Array.from(this.localTrackMap.entries()).forEach(M=>{let[U,{track:V,ssrcs:F}]=M,B={stream_type:mB(V,U),ssrcs:F};V._muted||!V._enabled?L.push(B):k.push(B)}),L.length>0&&L.forEach(L=>{sO(this,R8.RequestMuteLocal,[L])}),k.length>0&&k.forEach(L=>{sO(this,R8.RequestUnmuteLocal,[L])})};e(),this.uplinkStateUploadInterval=window.setInterval(()=>{e()},3e3)}stopUploadUplinkState(){this.uploadUnplinkStarted&&(this.uploadUnplinkStarted=!1,this.uplinkStateUploadInterval&&window.clearInterval(this.uplinkStateUploadInterval))}publishLowStream(L){return qb(function*(){throw new f2(f1.NOT_SUPPORTED,"p2p mode does not support publishLowStream.")})()}async republish(){this.pendingLocalTracks.length>0&&(gc.debug("[".concat(this.store.clientId,"] Emit P2PChannelEvents.RequestRePublish to republish tracks.")),await oO(this,R8.RequestRePublish,this.pendingLocalTracks),this.emit(R8.MediaReconnectEnd,this.store.uid),this.pendingLocalTracks=[])}async unpublishLowStream(){throw new f2(f1.NOT_SUPPORTED,"p2p mode does not support unpublishLowStream.")}async subscribe(L,k,M,U){var V;if(!this.recvConnection)throw new f2(f1.INVALID_OPERATION,"Cannot subscribe remote user when recvConnection disconnected.");if(null!==(V=this.remoteUserMap.get(L))&&void 0!==V&&V.has(k))return;let{track:F,mid:B,transceiver:j}=await this.recvConnection.receive(k,[{ssrcId:M}],String(L.uid),U);k===R1.AUDIO?(L._audioTrack?L._audioTrack._updateOriginMediaStreamTrack(F):(L._audioTrack=new Tf(F,L.uid,L._uintid,this.store),gc.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(L._audioTrack.getTrackId()))),j&&L._audioTrack._updateRtpTransceiver(j),this.bindRemoteTrackEvents(L,L._audioTrack)):(L._videoSSRC=M,L._videoTrack?L._videoTrack._updateOriginMediaStreamTrack(F):(L._videoTrack=new TE(F,L.uid,L._uintid,this.store),gc.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(L._videoTrack.getTrackId()))),j&&L._videoTrack._updateRtpTransceiver(j),this.bindRemoteTrackEvents(L,L._videoTrack));let G=this.remoteUserMap.get(L);G?G.set(k,B):this.remoteUserMap.set(L,new Map([[k,B]])),this.statsCollector.addRemoteStats(L.uid),this.statsUploader.startUploadInboundStats(),this.startUploadDownlinkState();let X=this.pendingRemoteTracks.findIndex(M=>{let{user:U,kind:V}=M;return U.uid===L.uid&&k===V});-1!==X&&(this.pendingRemoteTracks.splice(X,1),this.emit(R8.MediaReconnectEnd,L.uid))}async mockSubscribe(L,k,M,U){if(!this.recvConnection)throw new f2(f1.INVALID_OPERATION,"Cannot subscribe remote user when recvConnection disconnected.");await this.recvConnection.mockReceive(k,[{ssrcId:M}],String(L.uid),U)}async unsubscribe(L,k,M){let U=this.pendingRemoteTracks.filter(M=>{let{user:U,kind:V}=M;return void 0!==k?U.uid===L.uid&&k===V:U.uid===L.uid});if(U.forEach(L=>{let k=this.pendingRemoteTracks.indexOf(L);this.pendingRemoteTracks.splice(k,1)}),this.recvConnection||M||U.forEach(k=>{var M,U;let{kind:V}=k;V===R1.AUDIO?(null===(M=L._audioTrack)||void 0===M||M._destroy(),L._audioTrack=void 0):V===R1.VIDEO&&(null===(U=L._videoTrack)||void 0===U||U._destroy(),L._videoTrack=void 0)}),!this.recvConnection)return;let V=this.filterTobeUnSubscribedTracks(L,k);0!==V.length&&(await this.recvConnection.stopReceiving(V.map(L=>{let[,{id:k}]=L;return k})),this.withdrawRemoteTracks(V),0===this.remoteUserMap.size&&(this.statsUploader.stopUploadInboundStats(),this.stopUploadDownlinkState()),V.forEach(L=>{var k,U,V;let[F,{kind:B}]=L;B===R1.VIDEO&&F._videoSSRC&&(null===(k=this.recvConnection)||void 0===k||k.setStatsRemoteVideoIsReady(F._videoSSRC,!1)),B===R1.VIDEO?(this.unbindRemoteTrackEvents(F._videoTrack),M||(null===(U=F._videoTrack)||void 0===U||U._destroy(),F._videoTrack=void 0)):B!==R1.AUDIO||(this.unbindRemoteTrackEvents(F._audioTrack),M||(null===(V=F._audioTrack)||void 0===V||V._destroy(),F._audioTrack=void 0))}),V.forEach(L=>{let[,{kind:k}]=L;sO(this,R8.RequestP2PMuteRemote,k)}))}startUploadDownlinkState(){if(this.uploadDownlinkStarted)return;this.uploadDownlinkStarted=!0,this.downlinkStatsUploadInterval&&window.clearInterval(this.downlinkStatsUploadInterval);let e=()=>Array.from(this.remoteUserMap.entries()).forEach(L=>{let[,k]=L;[R1.VIDEO,R1.AUDIO].forEach(L=>{k.has(L)?sO(this,R8.RequestP2PUnmuteRemote,L):sO(this,R8.RequestP2PMuteRemote,L)})});e(),this.downlinkStatsUploadInterval=window.setInterval(()=>{e()},3e3)}stopUploadDownlinkState(){this.uploadDownlinkStarted&&(this.uploadDownlinkStarted=!1,this.downlinkStatsUploadInterval&&window.clearInterval(this.downlinkStatsUploadInterval))}getAllDataChannels(){return this.localDataChannels}async massSubscribe(L){throw new f2(f1.NOT_SUPPORTED,"p2p mode does not support massSubscribe.")}async massSubscribeNoLock(L){throw new f2(f1.NOT_SUPPORTED,"p2p mode does not support massSubscribeNoLock.")}async massUnsubscribe(L){throw new f2(f1.NOT_SUPPORTED,"p2p mode does not support massUnsubscribe.")}async massUnsubscribeNoLock(L){throw new f2(f1.NOT_SUPPORTED,"p2p mode does not support massUnsubscribeNoLock.")}async muteRemote(L,k){if(!this.recvConnection)return;let M=this.remoteUserMap.get(L);if(!M)return void gc.warning("[".concat(this.store.clientId,"] P2PChannel2.muteRemote has no remote user ").concat(L.uid,"."));if(!M.get(k))return void gc.warning("[".concat(this.store.clientId,"] P2PChannel2.muteRemote has no remote user ").concat(L.uid," media type ").concat(k,"."));let U=k===R1.VIDEO?L._videoSSRC:L._audioSSRC;void 0!==U&&this.recvConnection.setStatsRemoteVideoIsReady(U,!1)}async unmuteRemote(L,k){return this.unmuteRemoteNoLock(L,k)}async unmuteRemoteNoLock(L,k){if(!this.recvConnection)return;let M=this.remoteUserMap.get(L);if(!M)return void gc.warning("[".concat(this.store.clientId,"] P2PChannel2.unmuteRemote has no remote user ").concat(L.uid,"."));M.get(k)||gc.warning("[".concat(this.store.clientId,"] P2PChannel2.unmuteRemote has no remote user ").concat(L.uid," media type ").concat(k,"."))}getAllTracks(L){let k=this.localTrackMap.get(R4.LocalAudioTrack);if((null==k?void 0:k.track)instanceof WL){let M=k.track;return Array.from(this.localTrackMap.entries()).filter(L=>{let[k]=L;return k!==R4.LocalAudioTrack}).filter(k=>{let[M]=k;return!(L&&M===R4.LocalVideoLowTrack)}).map(L=>{let[,{track:k}]=L;return k}).concat(M.trackList)}return Array.from(this.localTrackMap.entries()).filter(k=>{let[M]=k;return!(L&&M===R4.LocalVideoLowTrack)}).map(L=>{let[,{track:k}]=L;return k})}reportPublishEvent(L,k,M,U,V){if(L){let M=this.localTrackMap.get(R4.LocalAudioTrack),F=U?this.localTrackMap.get(R4.LocalVideoLowTrack):this.localTrackMap.get(R4.LocalVideoTrack);g_.publish(this.store.sessionId,{eventElapse:IW.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:L,ec:k,audioName:null==M?void 0:M.track.getTrackLabel(),videoName:null==F?void 0:F.track.getTrackLabel(),screenshare:-1!==(null==F?void 0:F.track._hints.indexOf(gL.SCREEN_TRACK)),audio:!!M,video:!!F,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:V})}else{var F;M||(M=[]);let B=M.find(L=>L instanceof Ts),j=U?null===(F=this.localTrackMap.get(R4.LocalVideoTrack))||void 0===F?void 0:F.track:M.find(L=>L instanceof Tp);g_.publish(this.store.sessionId,{eventElapse:IW.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:L,ec:k,audioName:null==B?void 0:B.getTrackLabel(),videoName:null==j?void 0:j.getTrackLabel(),screenshare:-1!==(null==j?void 0:j._hints.indexOf(gL.SCREEN_TRACK)),audio:!!B,video:!!j,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:V})}}reportSubscribeEvent(L,k,M,U){let V=U===R1.VIDEO?M._videoSSRC:M._audioSSRC;V&&g_.subscribe(this.store.sessionId,{succ:L,ec:k,video:U===R1.VIDEO,audio:U===R1.AUDIO,peerid:M.uid,subscribeRequestid:U===R1.VIDEO?M._videoSSRC:M._audioSSRC,p2pid:this.store.p2pId,eventElapse:IW.measureFromSubscribeStart(this.store.clientId,V)})}reset(){gc.debug("[".concat(this.store.clientId,"] P2PChannel2.reset")),this.sendMutex=new S_("P2PChannel2-send-mutex",this.store.clientId),this.sendMutex=new S_("P2PChannel2-recv-mutex",this.store.clientId),this.sendConnection&&(this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection),this.sendConnection=void 0),this.recvConnection&&(this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection),this.recvConnection=void 0),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),this.statsUploader.stopUploadExtensionUsageStats(),this.stopUploadUplinkState(),this.stopUploadDownlinkState(),this.unbindLocalTrackEvents(),this.unbindAllRemoteTrackEvents(),this.unbindRtpTransceiver();let L=this.localTrackMap.get(R4.LocalAudioTrack);if((null==L?void 0:L.track)instanceof WL){if(L.track.trackList.length>0){let k=L.track;L.track.trackList.forEach(L=>{k.removeAudioTrack(L)})}L.track.close()}this.localTrackMap.clear(),this.remoteUserMap.clear(),this.statsCollector.removeRemoteStats(),this.statsCollector.removeLocalStats(),this.dtlsFailedCount=0,this.pendingLocalTracks=[],this.pendingRemoteTracks=[],this.reconnectInterval&&(window.clearInterval(this.reconnectInterval),this.reconnectInterval=void 0),this.state=R6.Disconnected}getStats(L){var k,M;return L?null===(M=this.recvConnection)||void 0===M?void 0:M.getStats():null===(k=this.sendConnection)||void 0===k?void 0:k.getStats()}getRemoteVideoIsReady(L){var k;return(null===(k=this.recvConnection)||void 0===k?void 0:k.getRemoteVideoIsReady(L))||!1}getLocalAudioVolume(){let L=this.localTrackMap.get(R4.LocalAudioTrack);if(L)return L.track.getVolumeLevel()}getLocalVideoSize(){let L=this.localTrackMap.get(R4.LocalVideoTrack);if(L)return{width:L.track.videoWidth||0,height:L.track.videoHeight||0}}getEncoderConfig(L){let k=this.localTrackMap.get(L);return k&&k.track instanceof Tp||k&&k.track instanceof Ts?k.track._encoderConfig:void 0}getLocalMedia(L){return this.localTrackMap.get(L)}hasLocalMedia(){return this.localTrackMap.size>0}hasRemoteMedia(L,k){if(!L)return this.remoteUserMap.size>0;let M=this.remoteUserMap.get(L);return!!M&&(!k||M.has(k))}async hasRemoteMediaWithLock(L,k){if(!L)return this.remoteUserMap.size>0;let M=this.remoteUserMap.get(L);return!!M&&(!k||M.has(k))}getRemoteMedia(L){var k;let M=Array.from(gn(k=this.remoteUserMap).call(k)).find(k=>k.uid===L);return M?{audioTrack:M.audioTrack,audioSSRC:M._audioSSRC,videoTrack:M.videoTrack,videoSSRC:M._videoSSRC}:{}}getAudioLevels(){let L=Array.from(this.remoteUserMap.entries()).map(L=>{let[k]=L;return{uid:k.uid,level:k.audioTrack?100*k.audioTrack._source.getAccurateVolumeLevel():0}}),k=this.localTrackMap.get(R4.LocalAudioTrack);return k&&L.push({level:100*k.track._source.getAccurateVolumeLevel(),uid:this.store.uid}),L=uu(L).call(L,(L,k)=>L.level-k.level)}async disconnectForReconnect(){this.sendConnection&&this.recvConnection&&(gc.debug("[".concat(this.store.clientId,"] P2PChannel2.disconnectForReconnect closing P2PConnection")),this.state=R6.Reconnecting,wN("KEEP_LAST_FRAME")&&0!==this.remoteUserMap.size&&Array.from(this.remoteUserMap.entries()).forEach(L=>{var k;let[M]=L;M._videoTrack&&M._videoTrack._player&&(null===(k=M._videoTrack._player.getVideoElement())||void 0===k||k.pause(),M._videoTrack._player.isKeepLastFrame=!0,M._videoTrack._originMediaStreamTrack.stop())}),this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection),this.sendConnection=void 0,this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection),this.recvConnection=void 0,0!==this.localTrackMap.size&&(Array.from(this.localTrackMap.entries()).forEach(L=>{var k;let[M,{track:U}]=L;switch(M){case R4.LocalVideoTrack:so(k=U._hints).call(k,gL.LOW_STREAM)?U.close():this.pendingLocalTracks.push(U);break;case R4.LocalAudioTrack:U instanceof WL?this.pendingLocalTracks=this.pendingLocalTracks.concat(U.trackList):this.pendingLocalTracks.push(U);case R4.LocalVideoLowTrack:}}),this.emit(R8.MediaReconnectStart,this.store.uid)),this.unbindLocalTrackEvents(),this.localTrackMap.clear(),0!==this.remoteUserMap.size&&Array.from(this.remoteUserMap.entries()).forEach(L=>{let[k,M]=L;Array.from(gn(M).call(M)).forEach(L=>{this.setPendingRemoteMedia(k,L)}),this.emit(R8.MediaReconnectStart,k.uid)}),this.unbindAllRemoteTrackEvents(),this.remoteUserMap.clear(),this.stopUploadUplinkState(),this.stopUploadDownlinkState(),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),gc.debug("[".concat(this.store.clientId,"] P2PChannel2 disconnected, waiting to reconnect.")))}hasPendingRemoteMedia(L,k){for(let M of this.pendingRemoteTracks){let{user:U,kind:V}=M;if((L instanceof QF?L.uid:L)===U.uid&&k===V)return!0}return!1}setPendingRemoteMedia(L,k){this.hasPendingRemoteMedia(L,k)||this.pendingRemoteTracks.push({user:L,kind:k})}async restartICE(L,k){let M,U;if(L===RR.SEND_ONLY){if(!this.sendConnection)throw new f2(f1.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before sendConnection established.");M=await this.sendMutex.lock("From P2PChannel.restartICE"),U=this.sendConnection}else{if(!this.recvConnection)throw new f2(f1.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before recvConnection established.");M=await this.recvMutex.lock("From P2PChannel.restartICE"),U=this.recvConnection}try{if(k){let L=await U.restartICE(k);return U.isInRestartIce=!1,L}{let L=await U.restartICE();if(L){let k=await oO(this,R8.RequestP2PRestartICE,{direction:RR.RECEIVE_ONLY,iceParameter:L});await U.restartICE(k),U.isInRestartIce=!1}}}finally{M()}}getUplinkNetworkQuality(){if(!this.sendConnection)return 0;let L=this.sendConnection.getStats(),k=this.localTrackMap.get(R4.LocalVideoTrack),M=this.localTrackMap.get(R4.LocalAudioTrack),U=L.videoSend.find(L=>{var M;return L.ssrc===(null==k||null===(M=k.ssrcs)||void 0===M?void 0:M[0].ssrcId)}),V=L.audioSend.find(L=>{var k;return L.ssrc===(null==M||null===(k=M.ssrcs)||void 0===k?void 0:k[0].ssrcId)});if(!U||!V)return 1;let F=aO(this,R8.NeedSignalRTT),B=U?U.rttMs:void 0,j=V?V.rttMs:void 0,G=B&&j?(B+j)/2:B||j,X=100*L.sendPacketLossRate*.7/50+.3*((G&&F?(G+F)/2:G||F)||0)/1500,$=X<.17?1:X<.36?2:X<.59?3:X<.1?4:5,ee=null==k?void 0:k.track;if(ee&&ee._encoderConfig&&-1===ee._hints.indexOf(gL.SCREEN_TRACK)){let k=ee._encoderConfig.bitrateMax,M=L.bitrate.actualEncoded;if(k&&M){let L=(1e3*k-M)/(1e3*k);return TQ[L<.15?0:L<.3?1:L<.45?2:L<.6?3:4][$]}}return $}getDownlinkNetworkQuality(){if(!this.recvConnection)return 0;let L=this.recvConnection.getStats(),k=0;return Array.from(this.remoteUserMap.entries()).forEach(M=>{let[U]=M,V=U._audioSSRC,F=U._videoSSRC,B=L.audioRecv.find(L=>L.ssrc===V),j=L.videoRecv.find(L=>L.ssrc===F);if(!B&&!j)return void(k+=1);let G=aO(this,R8.NeedSignalRTT),X=L.rtt,$=(X&&G?(X+G)/2:X||G)||0,ee=B?B.jitterMs:void 0,et=L.recvPacketLossRate,ei=.7*et*100/50+.3*$/1500;ee&&(ei=.6*et*100/50+.2*$/1500+.2*ee/400),k+=ei<.1?1:ei<.17?2:ei<.36?3:ei<.59?4:5}),this.remoteUserMap.size>0?Math.round(k/this.remoteUserMap.size):k}async muteLocalTrack(L){return new lQ((k,M)=>{this.handleMuteLocalTrack(L,k,M)})}filterTobePublishedTracks(L,k,M){let U=[],V=this.getAllTracks();L=uO(L=L.filter(L=>-1===V.indexOf(L)));let F=!1,B=!1;for(let V of L){if(V instanceof Tp&&(this.localTrackMap.has(R4.LocalVideoTrack)||F?new f2(f1.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS).throw():(U.push({track:V,type:R4.LocalVideoTrack}),F=!0),k)){let L=this.getLowVideoTrack(V,M);U.push({track:L,type:R4.LocalVideoLowTrack})}if(V instanceof Ts){let L=this.localTrackMap.get(R4.LocalAudioTrack);if(L){if(!(L.track instanceof WL))throw new f2(f1.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(V._bypassWebAudio)throw new f2(f1.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");L.track.addAudioTrack(V),this.bindLocalAudioTrackEvents(V,!0)}else if(B){let L=U.find(L=>{let{type:k}=L;return k===R4.LocalAudioTrack});if(!(L.track instanceof WL))throw new f2(f1.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(V._bypassWebAudio)throw new f2(f1.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");L.track.addAudioTrack(V)}else{if(!gf.webAudioMediaStreamDest||V instanceof WL||V._bypassWebAudio)U.push({track:V,type:R4.LocalAudioTrack});else{let L=new WL;L.addAudioTrack(V),U.push({track:L,type:R4.LocalAudioTrack})}B=!0}}}return U}filterTobeUnpublishedTracks(L){let k=[],M=this.getAllTracks();for(let U of L=uO(L=L.filter(L=>-1!==M.indexOf(L)))){if(U instanceof Ts){let L=this.localTrackMap.get(R4.LocalAudioTrack);if(!L)continue;L.track instanceof WL?(L.track.removeAudioTrack(U),this.unbindLocalAudioTrackEvents(U),0===L.track.trackList.length&&(k.push([R4.LocalAudioTrack,L]),L.track.close())):k.push([R4.LocalAudioTrack,L])}if(U instanceof Tp){let L=this.localTrackMap.get(R4.LocalVideoTrack);if(!L)continue;k.push([R4.LocalVideoTrack,L]);let M=this.localTrackMap.get(R4.LocalVideoLowTrack);M&&k.push([R4.LocalVideoLowTrack,M])}}return k}bindLocalTrackEvents(L){L.forEach(L=>{let{track:k,type:M}=L;switch(M){case R4.LocalVideoTrack:k.addListener(gN.GET_STATS,this.handleGetLocalVideoStats),k.addListener(gN.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),k.addListener(gN.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),k.addListener(gN.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),k.addListener(gN.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this.handleUpdateVideoSendParameters),k.addListener(gN.NEED_REPLACE_TRACK,this.handleReplaceTrack),k.addListener(gN.NEED_MUTE_TRACK,this.handleMuteLocalTrack),k.addListener(gN.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case R4.LocalAudioTrack:this.bindLocalAudioTrackEvents(k);case R4.LocalVideoLowTrack:}})}bindLocalAudioTrackEvents(L,k){L instanceof WL?L.trackList.forEach(L=>{L.addListener(gN.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),L.addListener(gN.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),L.addListener(gN.GET_STATS,this.handleGetLocalAudioStats),L.addListener(gN.NEED_MUTE_TRACK,this.handleMuteLocalTrack),L.addListener(gN.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)}):(L.addListener(gN.GET_STATS,this.handleGetLocalAudioStats),L.addListener(gN.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),L.addListener(gN.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),L.addListener(gN.NEED_MUTE_TRACK,this.handleMuteLocalTrack),L.addListener(gN.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack),k||L.addListener(gN.NEED_REPLACE_TRACK,this.handleReplaceTrack))}unbindLocalTrackEvents(L){L||(L=Array.from(this.localTrackMap.entries()).map(L=>{let[k,{track:M}]=L;return{track:M,type:k}})),L.forEach(L=>{let{track:k,type:M}=L;switch(M){case R4.LocalVideoTrack:k.off(gN.GET_STATS,this.handleGetLocalVideoStats),k.off(gN.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),k.off(gN.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),k.off(gN.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),k.off(gN.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this.handleUpdateVideoSendParameters),k.off(gN.NEED_REPLACE_TRACK,this.handleReplaceTrack),k.off(gN.NEED_MUTE_TRACK,this.handleMuteLocalTrack),k.off(gN.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case R4.LocalAudioTrack:this.unbindLocalAudioTrackEvents(k);case R4.LocalVideoLowTrack:}})}unbindLocalAudioTrackEvents(L){L instanceof WL?L.trackList.forEach(L=>{L.off(gN.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),L.off(gN.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),L.off(gN.GET_STATS,this.handleGetLocalAudioStats),L.off(gN.NEED_MUTE_TRACK,this.handleMuteLocalTrack),L.off(gN.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)}):(L.off(gN.GET_STATS,this.handleGetLocalAudioStats),L.off(gN.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),L.off(gN.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),L.off(gN.NEED_REPLACE_TRACK,this.handleReplaceTrack),L.off(gN.NEED_MUTE_TRACK,this.handleMuteLocalTrack),L.off(gN.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack))}bindRemoteTrackEvents(L,k){k instanceof TE&&k.addListener(gN.GET_STATS,k=>{k(this.handleGetRemoteVideoStats(L))}),k instanceof Tf&&k.addListener(gN.GET_STATS,k=>{k(this.handleGetRemoteAudioStats(L))})}unbindRemoteTrackEvents(L){L&&L.removeAllListeners(gN.GET_STATS)}unbindAllRemoteTrackEvents(){Array.from(this.remoteUserMap.entries()).forEach(L=>{let[k,M]=L;M.has(R1.AUDIO)&&this.unbindRemoteTrackEvents(k._audioTrack),M.has(R1.VIDEO)&&this.unbindRemoteTrackEvents(k._videoTrack)})}createGatewayPublishMessage(L,k){return L.map((L,M)=>{var U;let V,{track:F,type:B}=L;switch(B){case R4.LocalAudioTrack:V=RG.Audio;break;case R4.LocalVideoTrack:V=so(U=F._hints).call(U,gL.SCREEN_TRACK)?RG.Screen:RG.High;break;case R4.LocalVideoLowTrack:V=RG.Low}return{kind:B===R4.LocalAudioTrack?R1.AUDIO:R1.VIDEO,stream_type:V,mid:k[M].id,ssrcs:k[M].localSSRC,isMuted:F.muted||!F.enabled}})}createGatewayUnpublishMessage(L){return L.map(L=>{var k;let M,[U,{track:V,ssrcs:F,id:B}]=L;switch(U){case R4.LocalVideoTrack:M=so(k=V._hints).call(k,gL.SCREEN_TRACK)?RG.Screen:RG.High;break;case R4.LocalAudioTrack:M=RG.Audio;break;case R4.LocalVideoLowTrack:M=RG.Low}return{stream_type:M,ssrcs:F,mid:B}})}assignLocalTracks(L,k){L.forEach((L,M)=>{let{track:U,type:V}=L;this.localTrackMap.set(V,{track:U,id:k[M].id,ssrcs:k[M].localSSRC})})}withdrawLocalTracks(L){L.forEach(L=>{let[k]=L;this.localTrackMap.delete(k)})}bindConnectionEvents(L){L.onConnectionStateChange=async k=>{var M;gc.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: ").concat(L.name,".onConnectionStateChange(").concat(k,")")),this.emit(R8.PeerConnectionStateChange,k),"connected"!==k||this.store.keyMetrics.peerConnectionEnd||this.store.peerConnectionEnd(),"connected"===k&&(L.isInRestartIce=!1),so(M=this._restartStates).call(M,k)&&!L.isInRestartIce&&("disconnected"===k&&await yO(800),"disconnected"!==L.iceConnectionState&&"failed"!==L.iceConnectionState||this.handleDisconnect(L.direction))},L.onICEConnectionStateChange=L=>{"connected"!==L||this.store.keyMetrics.iceConnectionEnd||this.store.iceConnectionEnd(),gc.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICEConnectionStateChange(").concat(L,")")),g_.reportApiInvoke(this.store.sessionId,{name:"ICEConnectionStateChange",options:L,tag:f9.TRACER}).onSuccess(),this.emit(R8.IceConnectionStateChange,L)},L.onICETransportStateChange=L=>{gc.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICETransportStateChange(").concat(L,")"))},L.onDTLSTransportStateChange=L=>{gc.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportStateChange(").concat(L,")"))},L.onDTLSTransportError=L=>{gc.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportError(").concat(L,")"))},L.onFirstAudioDecoded=L=>{var k,M;let U=Array.from(gn(k=this.remoteUserMap).call(k)).find(k=>k._audioSSRC===L);U&&(this.store.subscribe(U.uid,"audio",void 0,void 0,void 0,Date.now()),null===(M=U.audioTrack)||void 0===M||M.emit(gj.FIRST_FRAME_DECODED),g_.firstRemoteFrame(this.store.sessionId,gl.FIRST_AUDIO_DECODE,gh.FIRST_AUDIO_DECODE,{peer:U._uintid,subscribeElapse:IW.measureFromSubscribeStart(this.store.clientId,L),subscribeRequestid:L,p2pid:this.store.p2pId}))},L.onFirstAudioReceived=L=>{var k;let M=Array.from(gn(k=this.remoteUserMap).call(k)).find(k=>k._audioSSRC===L);M&&g_.firstRemoteFrame(this.store.sessionId,gl.FIRST_AUDIO_RECEIVED,gh.FIRST_AUDIO_RECEIVED,{peer:M._uintid,subscribeElapse:IW.measureFromSubscribeStart(this.store.clientId,L),subscribeRequestid:L,p2pid:this.store.p2pId})},L.onFirstVideoDecoded=(L,k,M)=>{this.reportVideoFirstFrameDecoded(L,k,M)},L.onFirstVideoReceived=L=>{var k;let M=Array.from(gn(k=this.remoteUserMap).call(k)).find(k=>k._videoSSRC===L);M&&g_.firstRemoteFrame(this.store.sessionId,gl.FIRST_VIDEO_RECEIVED,gh.FIRST_VIDEO_RECEIVED,{peer:M._uintid,subscribeElapse:IW.measureFromSubscribeStart(this.store.clientId,L),subscribeRequestid:L,p2pid:this.store.p2pId})},L.onSelectedLocalCandidateChanged=(L,k)=>{let M="relay"===L.candidateType,U="relay"===k.candidateType;"unknown"!==k.candidateType&&M===U||this.emit(R8.ConnectionTypeChange,M),gc.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedLocalCandidateChanged(").concat(JSON.stringify(ux(k))," -> ").concat(JSON.stringify(ux(L)),")"))},L.onSelectedRemoteCandidateChanged=(L,k)=>{gc.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedRemoteCandidateChanged(").concat(JSON.stringify(ux(k))," -> ").concat(JSON.stringify(ux(L)),")"))},L.onFirstVideoDecodedTimeout=L=>{this.reportVideoFirstFrameDecoded(L,void 0,void 0,!0)},L.onLocalCandidate=k=>{this.emit(R8.LocalCandidate,{candidate:k,direction:L.direction})}}unbindConnectionEvents(L){L.onConnectionStateChange=void 0,L.onICEConnectionStateChange=void 0,L.onICETransportStateChange=void 0,L.onDTLSTransportStateChange=void 0,L.onDTLSTransportError=void 0,L.onFirstAudioDecoded=void 0,L.onFirstAudioReceived=void 0,L.onFirstVideoDecoded=void 0,L.onFirstVideoReceived=void 0,L.onSelectedLocalCandidateChanged=void 0,L.onSelectedRemoteCandidateChanged=void 0,L.onFirstVideoDecodedTimeout=void 0,L.onLocalCandidate=void 0}async handleDisconnect(L){let k=L===RR.SEND_ONLY?this.sendConnection:this.recvConnection;k&&!k.isInRestartIce&&(k.isInRestartIce=!0,gc.debug("[".concat(this.store.clientId,"] [P2PChannel-").concat(k.name,"] start use restartICE")),L===RR.SEND_ONLY?this.restartICE(L):oO(this,R8.RequestP2PRestartICE,{direction:RR.SEND_ONLY}))}filterTobeMutedTracks(L){let k=[];if(-1===this.getAllTracks().indexOf(L))return k;let M=this.localTrackMap.get(R4.LocalAudioTrack);if(L instanceof Ts&&(null==M?void 0:M.track)instanceof WL)return M.track.isActive||k.push([R4.LocalAudioTrack,M]),k;let U=Array.from(this.localTrackMap.entries()).find(k=>{let[,{track:M}]=k;return L===M});if(U&&(k.push(U),U[0]===R4.LocalVideoTrack)){let L=this.localTrackMap.get(R4.LocalVideoLowTrack);L&&k.push([R4.LocalVideoLowTrack,L])}return k}filterTobeUnmutedTracks(L){let k=[],M=this.localTrackMap.get(R4.LocalAudioTrack);if(L instanceof Ts&&(null==M?void 0:M.track)instanceof WL)return M.track.isActive&&k.push([R4.LocalAudioTrack,M]),k;let U=Array.from(this.localTrackMap.entries()).find(k=>{let[,{track:M}]=k;return L===M});if(U){if(U[0]===R4.LocalVideoTrack){k.push(U);let L=this.localTrackMap.get(R4.LocalVideoLowTrack);L&&k.push([R4.LocalVideoLowTrack,L])}else k.push(U)}return k}createMuteMessage(L){return L.map(L=>{var k;let M,[U,{track:V,ssrcs:F,id:B}]=L;switch(U){case R4.LocalAudioTrack:M=RG.Audio;break;case R4.LocalVideoTrack:M=so(k=V._hints).call(k,gL.SCREEN_TRACK)?RG.Screen:RG.High;break;case R4.LocalVideoLowTrack:M=RG.Low}return{stream_type:M,ssrcs:F,mid:B}})}createUnmuteMessage(L){return L.map(L=>{var k;let M,[U,{track:V,ssrcs:F,id:B}]=L;switch(U){case R4.LocalAudioTrack:M=RG.Audio;break;case R4.LocalVideoTrack:M=so(k=V._hints).call(k,gL.SCREEN_TRACK)?RG.Screen:RG.High;break;case R4.LocalVideoLowTrack:M=RG.Low}return{stream_type:M,ssrcs:F,mid:B}})}filterTobeUnSubscribedTracks(L,k){let M=[],U=this.remoteUserMap.get(L);if(!U)return M;if(k){let V=U.get(k);if(!V)return M;M.push([L,{kind:k,id:V}])}else Array.from(U.entries()).forEach(k=>{let[U,V]=k;M.push([L,{kind:U,id:V}])});return M}createUnsubscribeMessage(L){let k=[];return L.forEach(L=>{let[M,{kind:U,id:V}]=L;switch(U){case R1.VIDEO:return void(M._videoSSRC&&k.push({stream_type:R1.VIDEO,ssrcId:M._videoSSRC}));case R1.AUDIO:return void(M._audioSSRC&&k.push({stream_type:R1.AUDIO,ssrcId:M._audioSSRC}))}}),k}withdrawRemoteTracks(L){L.forEach(L=>{let[k,{kind:M}]=L,U=this.remoteUserMap.get(k);U&&(U.delete(M),0===Array.from(U.entries()).length&&this.remoteUserMap.delete(k))})}async updateBitrateLimit(L){let k=this.localTrackMap.get(R4.LocalVideoTrack),M=this.localTrackMap.get(R4.LocalVideoLowTrack);k&&(await k.track.setBitrateLimit(L.uplink),await new lQ((L,M)=>{this.handleUpdateVideoEncoder(k.track,L,M,!0)})),M&&L.low_stream_uplink&&(await M.track.setBitrateLimit({max_bitrate:L.low_stream_uplink.bitrate,min_bitrate:L.low_stream_uplink.bitrate||0}),await new lQ((L,k)=>{this.handleUpdateVideoEncoder(M.track,L,k,!0)}))}isP2PDisconnected(){if(this.sendConnection&&this.recvConnection){let L=this.sendConnection.peerConnectionState,k=this.recvConnection.peerConnectionState;return"connected"!==L&&"connected"!==k}return!0}async tryToUnmuteAudio(L){for(let k=0;k<L.length;k++)if(L[k]instanceof Ts){let M=this.filterTobeUnmutedTracks(L[k]);if(0===M.length)continue;let U=this.createUnmuteMessage(M);return void await sO(this,R8.RequestUnmuteLocal,U)}}bindStatsUploaderEvents(){this.statsUploader.requestStats=L=>this.getStats(L),this.statsUploader.requestLocalMedia=()=>Array.from(this.localTrackMap.entries()).filter(L=>{let[,{ssrcs:k}]=L;return!!k}),this.statsUploader.requestRemoteMedia=()=>Array.from(this.remoteUserMap.entries()),this.statsUploader.requestVideoIsReady=L=>{var k;return!(null===(k=this.recvConnection)||void 0===k||!k.getRemoteVideoIsReady(L))},this.statsUploader.requestUpload=(L,k)=>this.emit(R8.RequestUpload,L,k),this.statsUploader.requestUploadStats=L=>this.emit(R8.RequestUploadStats,L),this.statsUploader.requestAllTracks=()=>this.getAllTracks()}unbindStatsUploaderEvents(){this.statsUploader.requestStats=void 0,this.statsUploader.requestLocalMedia=void 0,this.statsUploader.requestRemoteMedia=void 0,this.statsUploader.requestVideoIsReady=void 0}async requestReconnect(){this.dtlsFailedCount+=1,await yO(jO(this.dtlsFailedCount,Sm)),this.emit(R8.RequestReconnect)}async reconnectP2P(){}canPublishLowStream(){return this.localTrackMap.has(R4.LocalVideoTrack)||this.pendingLocalTracks.some(L=>L instanceof Tp)}throwIfTrackTypeNotMatch(L){if(L.filter(L=>L instanceof Tp).length>1)throw new f2(f1.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(L.filter(L=>L instanceof Ts).length>1&&(L.some(L=>L instanceof Ts&&L._bypassWebAudio)||!gf.webAudioMediaStreamDest))throw new f2(f1.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode");for(let k of L){if(k instanceof Tp&&this.pendingLocalTracks.some(L=>L instanceof Tp))throw new f2(f1.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(k instanceof Ts&&this.pendingLocalTracks.some(L=>L instanceof Ts)&&(!gf.webAudioMediaStreamDest||k._bypassWebAudio||this.pendingLocalTracks.some(L=>L instanceof Ts&&L._bypassWebAudio)))throw new f2(f1.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode")}}getLowVideoTrack(L,k){let M;let U=!wN("DISABLE_DUAL_STREAM_USE_ENCODING")&&gf.supportDualStreamEncoding,V=fq(fq({},{width:160,height:120,framerate:15,bitrate:50}),k);M=U?L._mediaStreamTrack.clone():wB(L,V);let F=IO(8,"track-low-"),B=new Tp(M,fq(fq({},U&&{scaleResolutionDownBy:lx(V,L)}),{},{frameRate:V.framerate,bitrateMax:V.bitrate,bitrateMin:V.bitrate}),void 0,void 0,F);return B.on(gF.TRANSCEIVER_UPDATED,k=>{L._updateRtpTransceiver(k,gk.LOW_STREAM)}),B._hints.push(gL.LOW_STREAM),L.addListener(gN.NEED_CLOSE,()=>{B.close()}),B}async globalLock(){return this.recvMutex.lock("From P2PChannel2.globalLock")}reportVideoFirstFrameDecoded(L,k,M,U){var V;let F=Array.from(gn(V=this.remoteUserMap).call(V)).find(k=>k._videoSSRC===L);if(F){U||this.store.subscribe(F.uid,"video",void 0,void 0,void 0,void 0,Date.now());let V=this.store.keyMetrics,B=V.subscribe.find(L=>L.userId===F.uid&&"video"===L.type);g_.firstRemoteVideoDecode(this.store.sessionId,gl.FIRST_VIDEO_DECODE,gh.FIRST_VIDEO_DECODE,{peer:F._uintid,videowidth:k,videoheight:M,subscribeElapse:IW.measureFromSubscribeStart(this.store.clientId,L),subscribeRequestid:L,p2pid:this.store.p2pId,apEnd:V.requestAPEnd||0,apStart:V.requestAPStart||0,joinGwEnd:V.joinGatewayEnd||0,joinGwStart:V.joinGatewayStart||0,pcEnd:V.peerConnectionEnd||0,pcStart:V.peerConnectionStart||0,subscriberEnd:(null==B?void 0:B.subscribeEnd)||0,subscriberStart:(null==B?void 0:B.subscribeStart)||0,videoAddNotify:(null==B?void 0:B.streamAdded)||0,state:U?1:0})}}async remoteMediaSsrcChanged(L,k,M){if(!this.recvConnection)return!1;let U=this.remoteUserMap.get(L);if(!U)return!1;let V=U.get(k);if(!V)return!1;let F=await this.recvConnection.getRemoteSSRC(V);return void 0!==F&&F!==M}isPreSubScribe(L){return!1}async publishDataChannel(L){throw new f2(f1.NOT_SUPPORTED)}async unpublishDataChannel(L){throw new f2(f1.NOT_SUPPORTED)}async subscribeDataChannel(L,k){throw new f2(f1.NOT_SUPPORTED)}async unsubscribeDataChannel(L,k){throw new f2(f1.NOT_SUPPORTED)}hasPendingRemoteDataChannel(L,k){throw new f2(f1.NOT_SUPPORTED)}setPendingRemoteDataChannel(L,k){throw new f2(f1.NOT_SUPPORTED)}async preConnect(L){throw new f2(f1.NOT_SUPPORTED)}getEstablishParams(){throw new f2(f1.NOT_SUPPORTED)}async reSubscribe(L){throw new f2(f1.NOT_SUPPORTED)}reportVideoFirstFrameRender(L){}async updateVideoStreamParameter(L,k){throw new f2(f1.NOT_SUPPORTED)}unbindRtpTransceiver(){0!==this.localTrackMap.size&&Array.from(this.localTrackMap.entries()).forEach(L=>{let[k,{track:M}]=L;k===R4.LocalVideoLowTrack?M._updateRtpTransceiver(void 0,gk.LOW_STREAM):M._updateRtpTransceiver(void 0)})}}).prototype,"p2pConnect",[n1],Object.getOwnPropertyDescriptor(ai.prototype,"p2pConnect"),ai.prototype),OU(ai.prototype,"unpublish",[n2],Object.getOwnPropertyDescriptor(ai.prototype,"unpublish"),ai.prototype),OU(ai.prototype,"unpublishLowStream",[n3],Object.getOwnPropertyDescriptor(ai.prototype,"unpublishLowStream"),ai.prototype),OU(ai.prototype,"subscribe",[n5],Object.getOwnPropertyDescriptor(ai.prototype,"subscribe"),ai.prototype),OU(ai.prototype,"mockSubscribe",[n4],Object.getOwnPropertyDescriptor(ai.prototype,"mockSubscribe"),ai.prototype),OU(ai.prototype,"unsubscribe",[n6],Object.getOwnPropertyDescriptor(ai.prototype,"unsubscribe"),ai.prototype),OU(ai.prototype,"muteRemote",[n8],Object.getOwnPropertyDescriptor(ai.prototype,"muteRemote"),ai.prototype),OU(ai.prototype,"unmuteRemote",[n9],Object.getOwnPropertyDescriptor(ai.prototype,"unmuteRemote"),ai.prototype),OU(ai.prototype,"hasRemoteMediaWithLock",[n7],Object.getOwnPropertyDescriptor(ai.prototype,"hasRemoteMediaWithLock"),ai.prototype),OU(ai.prototype,"disconnectForReconnect",[ae],Object.getOwnPropertyDescriptor(ai.prototype,"disconnectForReconnect"),ai.prototype),OU(ai.prototype,"remoteMediaSsrcChanged",[at],Object.getOwnPropertyDescriptor(ai.prototype,"remoteMediaSsrcChanged"),ai.prototype),ai);function gq(L){return function(k,M,U){let V=k[M];if("function"!=typeof V)throw Error("Cannot use mutex on object property.");return U.value=async function(){for(var k=arguments.length,U=Array(k),F=0;F<k;F++)U[F]=arguments[F];switch(L){case yj.SEND_ONLY:{let L=await this.sendMutex.lock("From P2PChannel2.".concat(M));try{return await V.apply(this,U)}finally{L()}}case yj.RECEIVE_ONLY:{let L=await this.recvMutex.lock("From P2PChannel2.".concat(M));try{return await V.apply(this,U)}finally{L()}}default:{let L=await this.sendMutex.lock("From P2PChannel2.".concat(M)),k=await this.recvMutex.lock("From P2PChannel2.".concat(M));try{return await V.apply(this,U)}finally{L(),k()}}}},U}}let Tq=class Tq extends Hw{constructor(L,k){super(),uI(this,"signal",void 0),uI(this,"token",void 0),uI(this,"tokenTimeout",void 0),uI(this,"tokenInterval",void 0),uI(this,"_sequence",0),uI(this,"userMap",new Map),uI(this,"encoder",new TextEncoder),this.signal=L,this.token=k;let i=()=>{this.signal.connectionState===R_.CONNECTED&&this.check(),0===this.userMap.size?this.tokenInterval=window.setTimeout(i,1e3):this.tokenInterval=window.setTimeout(i,3*wN("P2P_TOKEN_INTERVAL"))};i()}async send(L,k,M,U,V){var F;if(0===this.userMap.size)return;let B=Array.from(l1(F=this.userMap).call(F))[0].token;"string"!=typeof k&&(k=JSON.stringify(k)),U=null!=U?U:IO(6,""),V=null!=V?V:this._sequence++;let j={_id:U,_type:L,_seq:V,_message:k,token:"".concat(this.token,"_").concat(B)};wN("SHOW_P2P_LOG")&&gc.debug("send message",j,"noNeedResponse : ".concat(M)),this.splitMessage(JSON.stringify(j)).forEach(L=>{this.signal.request(Rf.DATA_STREAM,{payload:SO(this.encoder.encode(L))})});let G=new lQ((k,V)=>{let F=window.setTimeout(()=>{this.off("res-@".concat(U,"_ack"),s),this.off("res-@".concat(U),d),this.off(Is.ABORT,c),gc.debug("[external-signal] request timeout, type: ".concat(L,", requestId: ").concat(U)),0===this.userMap.size?V(new f2(f1.INVALID_REMOTE_USER)):V(new f2(f1.TIMEOUT))},wN("EXTERNAL_SIGNAL_REQUEST_TIMEOUT")),s=()=>{F&&window.clearTimeout(F),this.off(Is.ABORT,c),M&&k()},c=()=>{F&&window.clearTimeout(F),this.off("res-@".concat(U,"_ack"),s),this.off("res-@".concat(U),d),V(new f2(f1.EXTERNAL_SIGNAL_ABORT,"type: ".concat(L,", requestId: ").concat(U)))};this.once(Is.ABORT,c),this.once("res-@".concat(U,"_ack"),s);let d=(M,j)=>{B=!0,F&&window.clearTimeout(F),this.off("res-@".concat(U,"_ack"),s),this.off(Is.ABORT,c),"success"===M?k(j):V(new f2(f1.P2P_MESSAGE_FAILED,"request ".concat(L," failed, requestId: ").concat(U)))},B=!1;M||(this.once("res-@".concat(U),d),yO(wN("SIGNAL_REQUEST_TIMEOUT")).then(()=>{B||gc.warning("external_signal request timeout, type: ".concat(L,", requestId: ").concat(U,", ").concat(j))}))});try{return await G}catch(F){if(F.code===f1.TIMEOUT)return await this.send(L,k,M,U,V);throw F}}onMessage(L){var k,M;let{_uid:U}=L,V,F=this.userMap.get(U);if(F)V=F.splitMessageMap;else{if(this.userMap.size>0||!("_type"in L)||L._type!==Io.CHECK)return;let{token:k}=L;F={uid:U,isStart:!0,token:k,splitMessageMap:V=new Map,nextExpectedSequenceNumber:0,receivedMessagesMap:new Map},this.userMap.set(U,F),this.signal.emit(RT.ON_USER_ONLINE,{uid:U}),this.handleUserOnline()}if("id"in L&&"total"in L){let{id:k,total:F}=L,B=null!==(M=V.get(k))&&void 0!==M?M:[];if(B.push(L),V.has(k)||V.set(k,B),B.length!==F)return;{let M=uu(B).call(B,(L,k)=>L.index-k.index).map(L=>L.payload).join("");V.delete(k),(L=JSON.parse(M))._uid=U}}let{_type:B,token:j}=L;if(so(k=[Io.ACK,Io.CHECK]).call(k,B))return B===Io.CHECK&&this.handleCheckToken(F,j),void this.receiveMessage(L);j==="".concat(F.token,"_").concat(this.token)?this.handleReceivedMessage(L):gc.debug('Receive unexpected message", '.concat(j,", cur_token: ").concat(F.token,"_").concat(this.token),L)}check(){let L={_id:IO(6,""),token:this.token,_type:Io.CHECK};wN("SHOW_P2P_LOG")&&gc.debug("send message",L),this.signal.request(Rf.DATA_STREAM,{payload:SO(this.encoder.encode(JSON.stringify(L)))})}ack(L){let k={_id:L,_type:Io.ACK,token:this.token};wN("SHOW_P2P_LOG")&&gc.debug("send message",k),this.signal.request(Rf.DATA_STREAM,{payload:SO(this.encoder.encode(JSON.stringify(k)))})}response(L,k,M){this.send(Io.RESPONSE,JSON.stringify({success:!M,message:k}),!0,L)}handleReceivedMessage(L){let t=()=>{this.userMap.forEach(L=>{let{receivedMessagesMap:k,nextExpectedSequenceNumber:M}=L;for(;k.has(M);){let U=k.get(M);k.delete(M),this.receiveMessage(U),L.nextExpectedSequenceNumber++}})};if(!L)return void t();let{_uid:k,_seq:M}=L,U=this.userMap.get(k),{receivedMessagesMap:V,isStart:F,nextExpectedSequenceNumber:B}=U;if(M<B)return this.ack(L._id),void gc.debug("[external-signal] receive old message, seq: ".concat(M,", ").concat(L._message));V.set(M,L),F&&M===B&&(this.receiveMessage(L),V.delete(B),U.nextExpectedSequenceNumber++,t())}receiveMessage(L){let{_id:k,_type:M,_message:U,_uid:V}=L;if(wN("SHOW_P2P_LOG")&&gc.debug("receive message",L),k){let F;switch(L._type!==Io.ACK&&(U&&(F=JSON.parse(U)),this.ack(L._id)),L._type){case Io.CANDIDATE:case Io.CONTROL:this.signal.emit(M,F,V);break;case Io.PUBLISH:case Io.UNPUBLISH:case Io.RESTART_ICE:case Io.CALL:F.uid=V,oO(this.signal,M,F).then(k=>{this.response(L._id,k)}).catch(()=>{this.response(L._id,void 0,!0)});break;case Io.ACK:this.getListeners("res-@".concat(k,"_ack")).length>0&&this.emit("res-@".concat(k,"_ack"));break;case Io.RESPONSE:{let{success:L,message:M}=F;this.emit("res-@".concat(k),L?"success":"failed",M)}}}}splitMessage(L){if(L.length<Tq.MAX_MESSAGE_SIZE)return[L];let k=[],{remoteToken:M}=JSON.parse(L),U=IO(6,""),V=0,F=800,B=Math.ceil(L.length/F);for(;L.length>0;){V++;let j={id:U,index:V,total:B,payload:L.slice(0,F),token:"".concat(this.token,"_").concat(M)};JSON.stringify(j).length>Tq.MAX_MESSAGE_SIZE?F-=50:(k.push(j),L=L.slice(F))}return k.map(L=>JSON.stringify(L))}handleCheckToken(L,k){return L.token!==k?(gc.debug("token changed, from ".concat(L.token," to ").concat(k)),this.reset(L.uid,k),!1):(this.tokenTimeout&&(window.clearTimeout(this.tokenTimeout),this.tokenTimeout=void 0),this.tokenTimeout=window.setTimeout(()=>{gc.debug("token timeout, ".concat(k)),this.reset(L.uid)},wN("MAX_P2P_TIMEOUT")),!0)}async handleUserOnline(){let L=await oO(this.signal,Io.CALL,void 0),k=await this.send(Io.CALL,L);this.signal.emit(RE.P2P_CONNECTION,k,!0)}async reset(L,k){let M=this.userMap.get(L);M&&(this.emit(Is.ABORT),this.signal.emit(RT.ON_USER_OFFLINE,{uid:M.uid,reason:Id.P2P_TOKEN_CHANGED}),this._sequence=0,this.userMap.clear(),k||(gc.debug("change local token from ".concat(k," to ").concat(k)),this.token=IO(6,"")))}clear(){this._sequence=0,this.userMap.clear(),this.tokenInterval&&window.clearTimeout(this.tokenInterval),this.tokenInterval=void 0,this.tokenTimeout&&window.clearTimeout(this.tokenTimeout),this.tokenTimeout=void 0,this.emit(Is.ABORT)}};uI(Tq,"MAX_SIZE",1),uI(Tq,"MAX_MESSAGE_SIZE",1024);let Rq=class Rq extends Hw{get connectionState(){return this._connectionState}set connectionState(L){L!==this._connectionState&&(this._connectionState=L,L===R_.CONNECTED?this.emit(RE.WS_CONNECTED):L===R_.RECONNECTING?this.emit(RE.WS_RECONNECTING,this._websocketReconnectReason):L===R_.CLOSED&&this.emit(RE.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket&&this.websocket.url||null}get rtt(){return this.rttRolling.mean()}constructor(L,k){super(),uI(this,"_disconnectedReason",void 0),uI(this,"_websocketReconnectReason",void 0),uI(this,"_connectionState",R_.CLOSED),uI(this,"reconnectToken",void 0),uI(this,"p2pToken",void 0),uI(this,"websocket",void 0),uI(this,"openConnectionTime",void 0),uI(this,"clientId",void 0),uI(this,"lastMsgTime",Date.now()),uI(this,"uploadCache",[]),uI(this,"uploadCacheInterval",void 0),uI(this,"rttRolling",new SS(5)),uI(this,"pingpongTimer",void 0),uI(this,"pingpongTimeoutCount",0),uI(this,"joinResponse",void 0),uI(this,"multiIpOption",void 0),uI(this,"initError",void 0),uI(this,"spec",void 0),uI(this,"store",void 0),uI(this,"_external_signal",void 0),uI(this,"onWebsocketMessage",L=>{if(L.data instanceof ArrayBuffer)return void this.emit(RE.ON_BINARY_DATA,L.data);let k=JSON.parse(L.data);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(k,"_id")){let L="res-@".concat(k._id);this.emit(L,k._result,k._message)}else if(Object.prototype.hasOwnProperty.call(k,"_type")){switch(k._type){case RT.ON_DATA_STREAM:return void this.handleDataStream(k._message);case RT.MUTE_AUDIO:case RT.MUTE_VIDEO:case RT.ON_P2P_LOST:case RT.ON_USER_ONLINE:return;case RT.ON_USER_OFFLINE:let{uid:L}=k._message;return gc.debug("[".concat(this.clientId,"] user-offline uid: ").concat(L)),void this._external_signal.reset(L)}if(this.emit(k._type,k._message),k._type===RT.ON_NOTIFICATION&&this.handleNotification(k._message),k._type===RT.ON_USER_BANNED)switch(k._message.error_code){case 14:this.close(Se.UID_BANNED);break;case 15:this.close(Se.IP_BANNED);break;case 16:this.close(Se.CHANNEL_BANNED)}if(k._type===RT.ON_USER_LICENSE_BANNED)switch(k._message.error_code){case Rp.ERR_LICENSE_MISSING:this.close(Se.LICENSE_MISSING);break;case Rp.ERR_LICENSE_EXPIRED:this.close(Se.LICENSE_EXPIRED);break;case Rp.ERR_LICENSE_MINUTES_EXCEEDED:this.close(Se.LICENSE_MINUTES_EXCEEDED);break;case Rp.ERR_LICENSE_PERIOD_INVALID:this.close(Se.LICENSE_PERIOD_INVALID);break;case Rp.ERR_LICENSE_MULTIPLE_SDK_SERVICE:this.close(Se.LICENSE_MULTIPLE_SDK_SERVICE);break;case Rp.ERR_LICENSE_ILLEGAL:this.close(Se.LICENSE_ILLEGAL);break;default:this.close()}}}),this.clientId=L.clientId,this.spec=L,this.store=k,this.websocket=new XV("gateway-".concat(this.clientId),this.spec.retryConfig,!0,wN("JOIN_GATEWAY_USE_DUAL_DOMAIN"),wN("JOIN_GATEWAY_USE_443PORT_ONLY"),k),this.handleWebsocketEvents(),window.addEventListener("offline",()=>{this.connectionState===R_.CONNECTED&&this.reconnect("retry",Sr.OFFLINE)}),this.p2pToken=IO(6,""),this._external_signal=new Tq(this,this.p2pToken)}async request(L,k,M,U){let V=IO(6,""),F=this.websocket.connectionID,a=()=>new lQ((L,k)=>{if(this.connectionState===R_.CONNECTED)return L();let i=()=>{this.off(RE.WS_CLOSED,n),L()},n=()=>{this.off(RE.WS_CONNECTED,i),k(new f2(f1.WS_ABORT))};this.once(RE.WS_CONNECTED,i),this.once(RE.WS_CLOSED,n)});if(this.connectionState!==R_.CONNECTING&&this.connectionState!==R_.RECONNECTING||L===Rf.JOIN||L===Rf.REJOIN||await a(),this.websocket.sendMessage({_id:V,_type:L,_message:k},!0),U)return;let B=new lQ((M,U)=>{let B=!1,a=(U,V)=>{B=!0,M({isSuccess:"success"===U,message:V||{}}),this.off(RE.WS_CLOSED,c),this.off(RE.WS_RECONNECTING,c),this.emit(RE.REQUEST_SUCCESS,L,k)};this.once("res-@".concat(V),a);let c=()=>{U(new f2(f1.WS_ABORT,"type: ".concat(L))),this.off(RE.WS_CLOSED,c),this.off(RE.WS_RECONNECTING,c),this.off("res-@".concat(V),a)};this.once(RE.WS_CLOSED,c),this.once(RE.WS_RECONNECTING,c),yO(wN("SIGNAL_REQUEST_TIMEOUT")).then(()=>{this.websocket.connectionID!==F||B||(gc.warning("[".concat(this.clientId,"] ws request timeout, type: ").concat(L)),this.emit(RE.REQUEST_TIMEOUT,L,k))})}),j=null;try{j=await B}catch(U){if(this.connectionState===R_.CLOSED||L===Rf.LEAVE)throw new f2(f1.WS_ABORT);return!this.spec.forceWaitGatewayResponse||M?U.throw():L===Rf.JOIN||L===Rf.REJOIN?null:(await a(),await this.request(L,k))}if(j.isSuccess)return j.message;let G=Number(j.message.error_code||j.message.code),X=VV(G),$=new f2(f1.UNEXPECTED_RESPONSE,"".concat(X.desc,": ").concat(j.message.error_str),{code:G,data:j.message,desc:X.desc});return"success"===X.action?j.message:(gc.warning("[".concat(this.clientId,"] [").concat(this.websocket.connectionID,"] unexpected response from type ").concat(L,", error_code: ").concat(G,", message: ").concat(X.desc,", action: ").concat(X.action)),G===Rp.ERR_TOO_MANY_BROADCASTERS?((L===Rf.JOIN||L===Rf.REJOIN)&&(this.initError=$,this.close()),$.throw()):"failed"===X.action?$.throw():"quit"===X.action?(this.initError=$,this.close(),$.throw()):(G===Rp.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=j.message.option,gc.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",Sr.MULTI_IP)):this.reconnect(X.action,Sr.SERVER_ERROR),L===Rf.JOIN||L===Rf.REJOIN?null:await this.request(L,k)))}waitMessage(L,k){return new lQ(M=>{let n=U=>{(!k||k(U))&&(this.off(L,n),M(U))};this.on(L,n)})}uploadWRTCStats(L){if(!this.store.sessionId)return void gc.warn("[".concat(this.clientId,"] no session id when upload wrtc stats"));let k={lts:Date.now(),sid:this.store.sessionId,uid:this.store.intUid,stats:L};this.upload(RS.WRTC_STATS,k)}upload(L,k){let M={_type:L,_message:k};try{this.websocket.sendMessage(M)}catch(k){let L=wN("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(M),this.uploadCache.length>L&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval(()=>{if(this.connectionState!==R_.CONNECTED)return;let L=this.uploadCache.splice(0,1)[0];0===this.uploadCache.length&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(L._type,L._message)},wN("UPLOAD_CACHE_INTERVAL")||2e3))}}send(L,k){this.websocket.sendMessage({_type:L,_message:k})}async sendExtensionMessage(L,k,M){return await this._external_signal.send(L,k,M)}init(L){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new lQ((k,M)=>{this.once(RE.WS_CONNECTED,()=>k(this.joinResponse)),this.once(RE.WS_CLOSED,()=>M(this.initError||new f2(f1.WS_ABORT))),this.connectionState=R_.CONNECTING,this.websocket.init(L).catch(M)})}close(L){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._external_signal.clear(),this._disconnectedReason=L||Se.LEAVE,this.connectionState=R_.CLOSED,gc.debug("[".concat(this.clientId,"] ")+"will close websocket in signal"),this.websocket.close(),this.p2pToken=IO(6,""),this._external_signal.clear(),this._external_signal=new Tq(this,this.p2pToken)}async join(){if(!this.joinResponse){this.emit(RE.ABORT_P2P_EXECUTION);let L=await oO(this,RE.REQUEST_JOIN_INFO),k=await this.request(Rf.JOIN,L);if(!k)return this.emit(RE.REPORT_JOIN_GATEWAY,f1.TIMEOUT,this.url||""),!1;this.joinResponse=k,this.emit(RE.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=R_.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),!0}reconnect(L,k){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(L,k)}async downgradeCodec(L){return!1}handleDataStream(L){try{var k;let M=fO(L.payload),U=(new TextDecoder).decode(M),V=JSON.parse(U);"total"in V&&"id"in V||so(k=Object.values(Io)).call(k,V._type)?(V._uid=L.uid,this._external_signal.onMessage(V)):this.emit(RT.ON_DATA_STREAM,L)}catch(k){this.emit(RT.ON_DATA_STREAM,L)}}handleNotification(L){gc.debug("[".concat(this.clientId,"] receive notification: "),L);let k=VV(L.code);if("success"!==k.action){if("failed"!==k.action)return"quit"===k.action?("ERR_REPEAT_JOIN_CHANNEL"===k.desc&&this.close(Se.UID_BANNED),void this.close()):void this.reconnect(k.action,Sr.SERVER_ERROR);gc.error("[".concat(this.clientId,"] ignore error: "),k.desc)}}handlePingPong(){if(!this.websocket||"connected"!==this.websocket.state)return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;let L=wN("PING_PONG_TIME_OUT"),k=Date.now();this.pingpongTimeoutCount>=L&&(gc.warning("[".concat(this.clientId,"] PINGPONG Timeout. Last Socket Message: ").concat(k-this.lastMsgTime,"ms")),k-this.lastMsgTime>wN("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",Sr.TIMEOUT):this.request(Rf.PING,void 0,!0).then(()=>{this.pingpongTimeoutCount=0;let L=Date.now()-k;this.rttRolling.add(L),wN("REPORT_STATS")&&this.send(Rf.PING_BACK,{pingpongElapse:L})}).catch(L=>{})}handleWebsocketEvents(){this.websocket.on(RI.RECONNECT_CREATE_CONNECTION,L=>{this.emit(RE.WS_RECONNECT_CREATE_CONNECTION,L)}),this.websocket.on(RI.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(RI.CLOSED,()=>{this.connectionState=R_.CLOSED}),this.websocket.on(RI.FAILED,()=>{this._disconnectedReason=Se.NETWORK_ERROR,this.connectionState=R_.CLOSED}),this.websocket.on(RI.RECONNECTING,L=>{this._websocketReconnectReason=L,this.joinResponse=void 0,this.connectionState===R_.CONNECTED?this.connectionState=R_.RECONNECTING:this.connectionState=R_.CONNECTING}),this.websocket.on(RI.WILL_RECONNECT,(L,k,M)=>{"retry"!==L?(gc.debug("".concat(this.clientId," websocket will_connect event, renewSession reconnectMode is ").concat(L)),this.reconnectToken=void 0):gc.debug("".concat(this.clientId," reconnect mode is retry, no need to renew session")),M(L)}),this.websocket.on(RI.CONNECTED,()=>{this.openConnectionTime=Date.now(),this.join().catch(L=>{if(this.emit(RE.REPORT_JOIN_GATEWAY,L,this.url||""),L instanceof f2&&L.code===f1.UNEXPECTED_RESPONSE&&L.data.code===Rp.ERR_NO_AUTHORIZED)return gc.warning("[".concat(this.clientId,"] reconnect no authorized, recover")),void this.reconnect("recover",Sr.SERVER_ERROR);gc.error("[".concat(this.clientId,"] join gateway request failed"),L.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",Sr.SERVER_ERROR):(this.initError=L,this.close())})}),this.websocket.on(RI.REQUEST_NEW_URLS,(L,k)=>{oO(this,RE.REQUEST_RECOVER,this.multiIpOption).then(L).catch(k)}),this.websocket.on(RI.ON_TOKEN_PRIVILEGE_DID_EXPIRE,()=>{this.emit(RT.ON_TOKEN_PRIVILEGE_DID_EXPIRE)})}};function Cq(L,k){var M=Object.keys(L);if(Object.getOwnPropertySymbols){var U=Object.getOwnPropertySymbols(L);k&&(U=U.filter(function(k){return Object.getOwnPropertyDescriptor(L,k).enumerable})),M.push.apply(M,U)}return M}function yq(L){for(var k=1;k<arguments.length;k++){var M=null!=arguments[k]?arguments[k]:{};k%2?Cq(Object(M),!0).forEach(function(k){uI(L,k,M[k])}):Object.getOwnPropertyDescriptors?Object.defineProperties(L,Object.getOwnPropertyDescriptors(M)):Cq(Object(M)).forEach(function(k){Object.defineProperty(L,k,Object.getOwnPropertyDescriptor(M,k))})}return L}let Iq=class Iq{constructor(L){uI(this,"sessionDesc",void 0),uI(this,"localCapabilities",void 0),uI(this,"rtpCapabilities",void 0),uI(this,"candidates",void 0),uI(this,"_originCandidates",void 0),uI(this,"iceParameters",void 0),uI(this,"dtlsParameters",void 0),uI(this,"setup",void 0),uI(this,"currentMidIndex",void 0),uI(this,"cname",void 0),L=pO(L);let{iceParameters:k,dtlsParameters:M,candidates:U,rtpCapabilities:V,setup:F,localCapabilities:B,sdkCodec:j,cname:G}=L,X=FN("v=0\no=- 0 0 IN IP4 127.0.0.1\ns=AgoraGateway\nt=0 0\na=group:BUNDLE audio video\na=msid-semantic: WMS\na=ice-lite\nm=audio 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 localhost\na=sendrecv\na=rtcp-mux\na=rtcp-rsize\na=mid:audio\nm=video 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 localhost\na=sendrecv\na=rtcp-mux\na=rtcp-rsize\na=mid:video\n");this.rtpCapabilities=V,this.candidates=U,this._originCandidates=pO(U),this.iceParameters=k,this.dtlsParameters=M,this.setup=F,this.localCapabilities=B,this.cname=G;for(let L=0;L<X.mediaDescriptions.length;L++){let B=X.mediaDescriptions[L];if(B.attributes.iceUfrag=k.iceUfrag,B.attributes.icePwd=k.icePwd,B.attributes.fingerprints=M.fingerprints,B.attributes.candidates=U,B.attributes.setup=F,"video"===B.media.mediaType){B.media.fmts=V.videoCodecs.map(L=>L.payloadType.toString(10));let L=V.videoCodecs.filter(L=>{var k,M;return null===(k=L.rtpMap)||void 0===k?void 0:so(M=k.encodingName.toLowerCase()).call(M,j)}),k=V.videoCodecs.filter(k=>!so(L).call(L,k));B.attributes.payloads=[...L,...k],B.attributes.extmaps=V.videoExtensions}"audio"===B.media.mediaType&&(B.media.fmts=V.audioCodecs.map(L=>L.payloadType.toString(10)),B.attributes.payloads=V.audioCodecs,B.attributes.extmaps=V.audioExtensions),X.mediaDescriptions[L]=this.mungMediaDesc(B)}this.sessionDesc=X,this.currentMidIndex=X.mediaDescriptions.length-1}toString(){return BN(this.sessionDesc)}send(L,k,M){let{ssrcs:U,ssrcGroups:V}=bx(k,this.cname),F=this.sessionDesc.mediaDescriptions.find(k=>L===R1.VIDEO?"video"===k.media.mediaType:"audio"===k.media.mediaType),B=U[0].attributes.label,j=U[0].attributes.mslabel;return F.attributes.ssrcs=F.attributes.ssrcs.concat(U),F.attributes.ssrcGroups=F.attributes.ssrcGroups.concat(V),{id:B,mslabel:j}}batchSend(L){return L.map(L=>{let{kind:k,ssrcMsg:M}=L;return this.send(k,M,void 0)})}stopSending(L){this.sessionDesc.mediaDescriptions.forEach(k=>{let M=[],U=[],V=[];k.attributes.ssrcs.forEach(k=>{so(L).call(L,k.attributes.label||"")?V.push(k):M.push(k)}),k.attributes.ssrcGroups.forEach(L=>{var k;so(k=V.map(L=>L.ssrcId)).call(k,L.ssrcIds[0])||U.push(L)}),k.attributes.ssrcs=M,k.attributes.ssrcGroups=U})}mute(L){let k=this.sessionDesc.mediaDescriptions.find(k=>k.attributes.mid===L);if(!k)throw Error("mediaDescription not found with ".concat(L," in remote SDP when calling RemoteSDP.mute."));k.attributes.direction="inactive"}unmute(L){let k=this.sessionDesc.mediaDescriptions.find(k=>k.attributes.mid===L);if(!k)throw Error("mediaDescription not found with ".concat(L," in remote SDP when calling RemoteSDP.unmute."));k.attributes.direction="sendonly"}receive(L,k,M){L.forEach((L,k)=>{let M=L._mediaStreamTrack,U=this.sessionDesc.mediaDescriptions.findIndex(L=>L.attributes.mid===M.kind),V=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[U],L);this.sessionDesc.mediaDescriptions[U]=V})}stopReceiving(L){}updateCandidates(L){let k=this._originCandidates.filter(L=>"udp"===L.transport),M=[];if(k.forEach(L=>{M.push(yq(yq({},L),{},{foundation:"tcpcandidate",priority:Number(L.priority)-1+"",transport:"tcp",port:Number(L.port)+90+""}))}),0!==k.length){switch(L){case R2.TCP_RELAY:this.candidates=M;break;case R2.UDP_TCP_RELAY:case R2.RELAY:this.candidates=[...k,...M];break;default:this.candidates=k}for(let L of this.sessionDesc.mediaDescriptions)L.attributes.candidates=this.candidates}}restartICE(L){L=pO(L),this.iceParameters=L,this.sessionDesc.mediaDescriptions.forEach(k=>{k.attributes.iceUfrag=L.iceUfrag,k.attributes.icePwd=L.icePwd})}predictReceivingMids(L){let k=[];for(let M=0;M<L;M++)k.push((this.currentMidIndex+M+1).toString(10));return k}mungRecvMediaDsec(L,k){let M=pO(L);return Ax(M,k),Ox(M,k),M}updateRecvMedia(L,k){let M=this.sessionDesc.mediaDescriptions.findIndex(k=>k.attributes.mid===L);if(-1!==M){let L=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[M],k);this.sessionDesc.mediaDescriptions[M]=L}}bumpMid(L){this.currentMidIndex+=L}updateTrackLabel(L,k,M){let U=this.sessionDesc.mediaDescriptions.find(k=>L===R1.VIDEO?"video"===k.attributes.mid:"audio"===k.attributes.mid);if(U){var V;let L=U.attributes.ssrcs.find(L=>L.attributes.label===k);L&&(L.attributes.label=M,null===(V=L.attributes.msid)||void 0===V||V.replace(k,M))}}mungMediaDesc(L){let k=pO(L);return wx(k),function(L){let k=L.attributes.extmaps.find(L=>Sx(L.extensionName));k&&L.attributes.extmaps.splice(L.attributes.extmaps.indexOf(k),1),L.attributes.payloads.forEach(L=>{let k=L.rtcpFeedbacks.findIndex(L=>"transport-cc"===L.type);-1!==k&&L.rtcpFeedbacks.splice(k,1)})}(k),k}getSSRC(L){for(let k of this.sessionDesc.mediaDescriptions)for(let M of k.attributes.ssrcs)if(M.attributes.label===L)return[M]}};function Aq(L,k){var M=Object.keys(L);if(Object.getOwnPropertySymbols){var U=Object.getOwnPropertySymbols(L);k&&(U=U.filter(function(k){return Object.getOwnPropertyDescriptor(L,k).enumerable})),M.push.apply(M,U)}return M}function wq(L){for(var k=1;k<arguments.length;k++){var M=null!=arguments[k]?arguments[k]:{};k%2?Aq(Object(M),!0).forEach(function(k){uI(L,k,M[k])}):Object.getOwnPropertyDescriptors?Object.defineProperties(L,Object.getOwnPropertyDescriptors(M)):Aq(Object(M)).forEach(function(k){Object.defineProperty(L,k,Object.getOwnPropertyDescriptor(M,k))})}return L}let yG=(OU((ar=class e extends _V{get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get localCodecs(){return[...new Set(this.localCapabilities&&this.localCapabilities.videoCodecs.map(L=>L.rtpMap&&L.rtpMap.encodingName.toLowerCase()||"").filter(L=>{var k;return so(k=Object.keys(S8)).call(k,L)}))]}constructor(L,k){super(L,k),uI(this,"store",void 0),uI(this,"peerConnection",void 0),uI(this,"remoteSDP",void 0),uI(this,"initialOffer",void 0),uI(this,"statsFilter",void 0),uI(this,"useRTX",!1),uI(this,"localCapabilities",void 0),uI(this,"localCandidateCount",0),uI(this,"allCandidatesReceived",!1),uI(this,"establishPromise",void 0),uI(this,"mutex",void 0),this.store=k,this.mutex=new S_("P2PConnection-mutex",k.clientId),this.peerConnection=new RTCPeerConnection(e.resolvePCConfiguration(L),{optional:[{googDscp:!0}]}),this.statsFilter=EN(this.peerConnection,wN("STATS_UPDATE_INTERVAL"),void 0,iw()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,this.establishPromise=this.establish()}async establish(){try{let L=await this.peerConnection.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});if(!L.sdp)throw Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");let k=vx(L.sdp),M=Rx(L.sdp,{filterRTX:!this.useRTX,filterVideoFec:wN("FILTER_VIDEO_FEC"),filterAudioFec:wN("FILTER_AUDIO_FEC"),filterAudioCodec:["opus"]});return this.localCapabilities=M,this.initialOffer=L,wq(wq({},k),{},{rtpCapabilities:{send:{audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},recv:{audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},sendrecv:M},offerSDP:L.sdp})}catch(L){throw new f2(f1.GET_LOCAL_CONNECTION_PARAMS_FAILED,L.toString())}}async updateRemoteConnect(){}async connect(L){try{if(!this.initialOffer)throw Error("Cannot establish P2PConnection without initial offer.");this.remoteSDP=new Iq(wq(wq({},L),{},{rtpCapabilities:L.rtpCapabilities.send,localCapabilities:this.localCapabilities,sdkCodec:this.store.codec}));let k=this.remoteSDP.toString();await this.peerConnection.setLocalDescription(this.initialOffer),await this.peerConnection.setRemoteDescription({type:"answer",sdp:k})}catch(L){throw new f2(f1.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(L.toString()))}}async updateRemoteRTPCapabilities(L,k){throw new f2(f1.NOT_SUPPORTED,"Planb mode does not support createDataChannels.")}getPreMedia(L){}send(L,k){var M=this;return qb(function*(){let U=yield Jb(M.mutex.lock());try{let U;if(!M.remoteSDP)throw Error("Cannot call P2PConnection.send before remote SDP created");let V=L.map(L=>M.peerConnection.addTrack(L._mediaStreamTrack)),F=yield Jb(M.peerConnection.createOffer()),B=FN(F.sdp),j=L.map(L=>{let k=L._mediaStreamTrack,U=B.mediaDescriptions.find(L=>L.attributes.mid===k.kind);if(!U)throw Error("Cannot extract ssrc from mediaDescription.");return function(L,k,M){let U=L.attributes.ssrcs.filter(L=>L.attributes.label===k),V=L.attributes.ssrcGroups;if(0===U.length)throw Error("Cannot extract ssrc from plan-b SDP.");if(V&&U.length>1){let L=V.find(L=>-1!==L.ssrcIds.indexOf(U[0].ssrcId));return L?[{ssrcId:L.ssrcIds[0],rtx:M?L.ssrcIds[1]:void 0}]:[{ssrcId:U[0].ssrcId}]}return[{ssrcId:U[0].ssrcId}]}(U,k.id,M.useRTX)});try{U=yield j}catch(L){throw V.forEach(L=>{$A()&&L.replaceTrack(null),M.peerConnection.removeTrack(L)}),L}let G=M.mungSendOfferSDP(F.sdp,L);M.remoteSDP.receive(L,k,U);let X=M.remoteSDP.toString();return yield Jb(M.peerConnection.setLocalDescription({type:"offer",sdp:G})),yield Jb(M.applySendEncodings(V,L)),yield Jb(M.peerConnection.setRemoteDescription({type:"answer",sdp:X})),L.map((L,k)=>{let M=L._mediaStreamTrack.id;return{localSSRC:j[k],id:M}})}catch(L){throw new f2(f1.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(L.toString()))}finally{U()}})()}async stopSending(L){try{if(!this.remoteSDP)throw Error("Cannot call P2PConnection.stopSending before remote SDP created");let k=this.peerConnection.getSenders().filter(k=>{var M;return -1!==L.indexOf((null===(M=k.track)||void 0===M?void 0:M.id)||"")});if(k.length!==L.length)throw Error("Transceivers' length doesn't match mids' length when trying to call P2PConnection.stopSending.");k.map(L=>{$A()&&L.replaceTrack(null),this.peerConnection.removeTrack(L)});let M=await this.peerConnection.createOffer();await this.peerConnection.setLocalDescription(M),this.remoteSDP.stopReceiving(L);let U=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"answer",sdp:U})}catch(L){throw new f2(f1.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(L.toString()))}}async receive(L,k,M,U){try{if(!this.remoteSDP)throw Error("Cannot call P2PConnection.receive ".concat(L," before remoteSDP created."));let{id:M,mslabel:V}=this.remoteSDP.send(L,k,U),F=new lQ((k,U)=>{let F=setTimeout(()=>{U(Error("Cannot receive track, id: ".concat(M)))},1e4),s=U=>{let B=zA();if(("Safari"===B.name&&11===Number(B.version)||nw())&&U.track.id!==M&&U.streams[0].id===V){var j;let V=U.streams[0].getTracks()[0];return null===(j=this.remoteSDP)||void 0===j||j.updateTrackLabel(L,M,U.track.id),this.peerConnection.removeEventListener("track",s),clearTimeout(F),void k(V)}if(U.track.id===M)return this.peerConnection.removeEventListener("track",s),clearTimeout(F),void k(U.track)};this.peerConnection.addEventListener("track",s)}),B=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:B});let j=await this.peerConnection.createAnswer();return await this.peerConnection.setLocalDescription(j),{track:await F,id:M}}catch(L){throw new f2(f1.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(L.toString()))}}async stopReceiving(L){try{if(!this.remoteSDP)throw Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(L);let k=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:k});let M=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(M)}catch(L){throw new f2(f1.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(L.toString()))}}async muteRemote(L){}async unmuteRemote(L){}async muteLocal(L){try{if(!this.remoteSDP)throw Error("Cannot call P2PConnection.muteLocal before remote SDP created.");let k=this.peerConnection.getSenders().filter(k=>{var M;return -1!==L.indexOf((null===(M=k.track)||void 0===M?void 0:M.id)||"")});if(k.length!==L.length)throw Error("sender' length doesn't match mids' length.");k.map(L=>{if($A()&&L.track)L.track.enabled=!1;else{let k=L.getParameters();k.encodings.forEach(L=>L.active=!1),L.setParameters(k)}})}catch(L){throw new f2(f1.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(L.toString()))}}async unmuteLocal(L){try{if(!this.remoteSDP)throw Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");let k=this.peerConnection.getSenders().filter(k=>{var M;return -1!==L.indexOf((null===(M=k.track)||void 0===M?void 0:M.id)||"")});if(k.length!==L.length)throw Error("Senders' length doesn't match mids' length.");k.map(async L=>{if($A()&&L.track)L.track.enabled=!0;else{let k=L.getParameters();k.encodings.forEach(L=>L.active=!0),await L.setParameters(k)}});let M=await this.peerConnection.createOffer();await this.peerConnection.setLocalDescription(M);let U=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"answer",sdp:U})}catch(L){throw new f2(f1.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(L.toString()))}}restartICE(L){var k=this;return qb(function*(){let M=yield Jb(k.mutex.lock("From P2PConnection.restartICE"));try{if(!k.remoteSDP)throw Error("Cannot restartICE before remoteSDP created.");let M=gf.supportPCSetConfiguration;if(L===R2.RELAY&&!M)return;if(M){let M=k.peerConnection.getConfiguration(),U=L===R2.RELAY?"relay":"all";M.iceTransportPolicy!==U&&(gc.debug("[".concat(k.store.clientId,"] restartICE change iceTransportPolicy from [").concat(M.iceTransportPolicy,"] to [").concat(U,"]")),M.iceTransportPolicy=U,k.peerConnection.setConfiguration(M))}L!==R2.RELAY&&k.remoteSDP.updateCandidates(L);let U=yield Jb(k.peerConnection.createOffer({iceRestart:!0}));if(!U.sdp)throw Error("Cannot restartICE because restart offer SDP does not exist.");let V=vx(U.sdp),{remoteIceParameters:F}=yield V.iceParameters;k.remoteSDP.restartICE(F);let B=k.remoteSDP.toString();yield Jb(k.peerConnection.setLocalDescription(U)),yield Jb(k.peerConnection.setRemoteDescription({type:"answer",sdp:B}))}catch(L){gc.warning("[".concat(k.store.clientId,"] restart ICE failed, abort operation"),L)}finally{M()}})()}close(){var L;this.peerConnection.close(),null===(L=this.onConnectionStateChange)||void 0===L||L.call(this,"closed"),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.statsFilter.destroy()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(L){return this.statsFilter.getVideoIsReady(L)}async updateEncoderConfig(L,k){try{if(!this.remoteSDP)throw Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");let L=await this.peerConnection.createOffer(),M=this.mungSendOfferSDP(L.sdp,[k]);this.remoteSDP.updateRecvMedia(k._mediaStreamTrack.kind,k);let U=this.remoteSDP.toString();await this.peerConnection.setLocalDescription({type:"offer",sdp:M}),await this.peerConnection.setRemoteDescription({type:"answer",sdp:U})}catch(L){throw new f2(f1.EXCHANGE_SDP_FAILED,L.toString())}}async updateSendParameters(L,k){let M=this.peerConnection.getSenders().filter(k=>{var M;return(null===(M=k.track)||void 0===M?void 0:M.id)===L});1===M.length&&await this.applySendEncodings(M,[k])}setStatsRemoteVideoIsReady(L,k){this.statsFilter.setVideoIsReady2(L,k)}async replaceTrack(L,k){let M=this.peerConnection.getSenders().find(L=>{var M;return(null===(M=L.track)||void 0===M?void 0:M.id)===k});M&&await M.replaceTrack(L._mediaStreamTrack)}createDataChannels(L,k){throw new f2(f1.NOT_SUPPORTED,"Planb mode does not support createDataChannels.")}stopDataChannels(L){throw new f2(f1.NOT_SUPPORTED,"Planb mode does not support stopDataChannels.")}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var L;null===(L=this.onICEConnectionStateChange)||void 0===L||L.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var L;null===(L=this.onConnectionStateChange)||void 0===L||L.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidate=L=>{L.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,gc.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout(()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,gc.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))},wN("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(L){let k={iceServers:[],sdpSemantics:"plan-b"};return L.iceServers?k.iceServers=L.iceServers:L.turnServer&&"off"!==L.turnServer.mode&&(Qw(L.turnServer.servers)?k.iceServers=L.turnServer.servers:(k.iceServers&&k.iceServers.push(...e.turnServerConfigToIceServers(L.turnServer.servers)),wN("USE_TURN_SERVER_OF_GATEWAY")&&k.iceServers&&L.turnServer.serversFromGateway&&k.iceServers.push(...e.turnServerConfigToIceServers(L.turnServer.serversFromGateway)),L.turnServer.servers.concat(L.turnServer.serversFromGateway||[]).forEach(L=>{L.forceturn&&(k.iceTransportPolicy="relay")}))),k}static turnServerConfigToIceServers(L){let k=[];return L.forEach(L=>{L.security?L.tcpport&&k.push({username:L.username,credential:L.password,credentialType:"password",urls:"turns:".concat(L.turnServerURL,":").concat(L.tcpport,"?transport=tcp")}):(L.udpport&&k.push({username:L.username,credential:L.password,credentialType:"password",urls:"turn:".concat(L.turnServerURL,":").concat(L.udpport,"?transport=udp")}),L.tcpport&&k.push({username:L.username,credential:L.password,credentialType:"password",urls:"turn:".concat(L.turnServerURL,":").concat(L.tcpport,"?transport=tcp")}))}),k}async updateRtpSenderEncodings(L,k){var M,U;if(k||(k=this.peerConnection.getSenders().find(k=>{var M;return(null===(M=k.track)||void 0===M?void 0:M.id)===L._mediaStreamTrack.id})),!k)return gc.warn("[".concat(L.getTrackId(),"] no rtpSender found}"));if(!gf.supportSetRtpSenderParameters)return gc.warn("Browser not support set rtp-sender parameters");let V={},F={};if(L instanceof Tp)switch(L._optimizationMode){case"motion":V.degradationPreference="maintain-framerate";break;case"detail":V.degradationPreference="maintain-resolution";break;default:V.degradationPreference="balanced"}if(wN("DSCP_TYPE")&&vw()){let L=wN("DSCP_TYPE");so(U=["very-low","low","medium","high"]).call(U,L)&&(F.networkPriority=L)}let B=k.getParameters(),j=null===(M=B.encodings)||void 0===M?void 0:M[0];j&&Object.assign(j,F),Object.assign(B,V),gc.debug("[".concat(L.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(B.encodings))),await k.setParameters(B)}async applySendEncodings(L,k){try{if(!gf.supportSetRtpSenderParameters||L.length!==k.length)return;for(let M=0;M<L.length;M++){let U=L[M],V=k[M];U&&V&&await this.updateRtpSenderEncodings(V,U)}}catch(L){gc.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(L,k){let M=FN(L);return k.forEach((L,k)=>{let U=L._mediaStreamTrack,V=M.mediaDescriptions.find(L=>L.attributes.mid===U.kind);V&&Ax(V,L)}),BN(M)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=L=>{var k;null===(k=this.onFirstAudioReceived)||void 0===k||k.call(this,L)},this.statsFilter.onFirstVideoReceived=L=>{var k;null===(k=this.onFirstVideoReceived)||void 0===k||k.call(this,L)},this.statsFilter.onFirstAudioDecoded=L=>{var k;null===(k=this.onFirstAudioDecoded)||void 0===k||k.call(this,L)},this.statsFilter.onFirstVideoDecoded=(L,k,M)=>{var U;null===(U=this.onFirstVideoDecoded)||void 0===U||U.call(this,L,k,M)},this.statsFilter.onSelectedLocalCandidateChanged=(L,k)=>{var M;null===(M=this.onSelectedLocalCandidateChanged)||void 0===M||M.call(this,L,k)},this.statsFilter.onSelectedRemoteCandidateChanged=(L,k)=>{var M;null===(M=this.onSelectedRemoteCandidateChanged)||void 0===M||M.call(this,L,k)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0}async batchReceive(L){try{if(!this.remoteSDP)throw Error("Cannot call P2PConnection.batchReceive before remoteSDP created.");let k=this.remoteSDP.batchSend(L).map((k,M)=>{let{id:U,mslabel:V}=k,{kind:F}=L[M];return new lQ((L,k)=>{let M=setTimeout(()=>{k(Error("Cannot receive track, id: ".concat(U)))},1e4),s=k=>{let B=zA();if("Safari"===B.name&&11===Number(B.version)&&k.track.id!==U&&k.streams[0].id===V){var j;let V=k.streams[0].getTracks()[0];return null===(j=this.remoteSDP)||void 0===j||j.updateTrackLabel(F,U,k.track.id),this.peerConnection.removeEventListener("track",s),clearTimeout(M),void L({track:V,id:U})}if(k.track.id===U)return this.peerConnection.removeEventListener("track",s),clearTimeout(M),void L({track:k.track,id:U})};this.peerConnection.addEventListener("track",s)})}),M=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:M});let U=await this.peerConnection.createAnswer();return await this.peerConnection.setLocalDescription(U),await lQ.all(k)}catch(L){throw new f2(f1.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(L.toString()))}}async getRemoteSSRC(L){if(!this.remoteSDP)return;let k=this.remoteSDP.getSSRC(L);return null==k?void 0:k[0].ssrcId}setConfiguration(L){if(gf.supportPCSetConfiguration){let k=e.resolvePCConfiguration(L);this.peerConnection.setConfiguration(k)}}}).prototype,"connect",[Nq],Object.getOwnPropertyDescriptor(ar.prototype,"connect"),ar.prototype),OU(ar.prototype,"stopSending",[Nq],Object.getOwnPropertyDescriptor(ar.prototype,"stopSending"),ar.prototype),OU(ar.prototype,"receive",[Nq],Object.getOwnPropertyDescriptor(ar.prototype,"receive"),ar.prototype),OU(ar.prototype,"stopReceiving",[Nq],Object.getOwnPropertyDescriptor(ar.prototype,"stopReceiving"),ar.prototype),OU(ar.prototype,"muteRemote",[Nq],Object.getOwnPropertyDescriptor(ar.prototype,"muteRemote"),ar.prototype),OU(ar.prototype,"unmuteRemote",[Nq],Object.getOwnPropertyDescriptor(ar.prototype,"unmuteRemote"),ar.prototype),OU(ar.prototype,"muteLocal",[Nq],Object.getOwnPropertyDescriptor(ar.prototype,"muteLocal"),ar.prototype),OU(ar.prototype,"unmuteLocal",[Nq],Object.getOwnPropertyDescriptor(ar.prototype,"unmuteLocal"),ar.prototype),OU(ar.prototype,"close",[Nq],Object.getOwnPropertyDescriptor(ar.prototype,"close"),ar.prototype),OU(ar.prototype,"updateEncoderConfig",[Nq],Object.getOwnPropertyDescriptor(ar.prototype,"updateEncoderConfig"),ar.prototype),OU(ar.prototype,"updateSendParameters",[Nq],Object.getOwnPropertyDescriptor(ar.prototype,"updateSendParameters"),ar.prototype),OU(ar.prototype,"replaceTrack",[Nq],Object.getOwnPropertyDescriptor(ar.prototype,"replaceTrack"),ar.prototype),OU(ar.prototype,"getRemoteSSRC",[Nq],Object.getOwnPropertyDescriptor(ar.prototype,"getRemoteSSRC"),ar.prototype),ar);function Nq(L,k,M){let U=L[k];if("function"!=typeof U)throw Error("Cannot use mutex on object property.");return M.value=async function(){let L=this.mutex,M=await L.lock("Locking from P2PConnection.".concat(k));try{for(var V=arguments.length,F=Array(V),B=0;B<V;B++)F[B]=arguments[B];return await U.apply(this,F)}finally{M()}},M}let yH={interceptLocalAudioFrame:async function(L){let k=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!gf.supportWebRTCEncodedTransform)return void gc.warning("browser not support audio encoded transform");if(TT.has(L)||!L.track)return;let M={track:L.track};if(QA()){if(!L.createEncodedStreams)return void gc.warning("browser not support createEncodedStreams() API");let U=null;try{U=L.createEncodedStreams()}catch(L){return void gc.error("create audio-encoded-streams error",L&&L.message)}let V=new TransformStream({transform(U,V){M.controller||(M.controller=V),L.track&&L.track.id!==M.track.id&&(gc.debug("audio track changed: ".concat(M.track.id," => ").concat(L.track.id)),M.track.removeEventListener("ended",n),M.track=L.track,M.track.addEventListener("ended",n));let F=k.metadata&&k.metadata();F?function(L,k){let{chunk:M,controller:U}=k,V=Tg.METADATA;M.data=function(L,k,M){let U=M.byteLength,V=U+1+2,F=3+V,B=new ArrayBuffer(L.byteLength+F),j=new DataView(B);j.setUint8(0,71),j.setUint16(1,V),j.setUint8(3,k),j.setUint16(4,U);for(let L=0;L<U;L++)j.setUint8(6+L,M[L]);let G=new Uint8Array(j.buffer);return G.set(new Uint8Array(L),F),G.buffer}(M.data,V,L),U.enqueue(M)}(F,{sender:L,chunk:U,controller:V}):V.enqueue(U)}});U.readable.pipeThrough(V).pipeTo(U.writable)}else if($A()){if("undefined"==typeof RTCRtpScriptTransform)return void gc.warning("browser not support RTCRtpScriptTransform");let U=iM(),V=new MessageChannel;await new lQ(L=>U.onmessage=k=>{"registered"===k.data&&L(void 0)});let F=new RTCRtpScriptTransform(U,{name:"audio-metadata-tx",port:V.port2},[V.port2]);L.transform=F,await new lQ(L=>U.onmessage=k=>{"started"===k.data&&L(void 0)}),V.port1.onmessage=U=>{var F;if(U.data.transformed&&L.track&&(null===(F=L.track)||void 0===F?void 0:F.id)!==M.track.id)gc.debug("audio track changed: ".concat(M.track.id," => ").concat(L.track.id)),M.track.removeEventListener("ended",n),M.track=L.track,M.track.addEventListener("ended",n);else if(U.data.getMetadata){let L=k.metadata&&k.metadata();L&&V.port1.postMessage({metadata:L})}},M.worker=U}function n(){if(L.track){if(this.id!==L.track.id)return;L.track.removeEventListener("ended",n)}let k=TT.get(L);if(k){TT.delete(L);try{var M,U;null===(M=k.controller)||void 0===M||M.terminate(),null===(U=k.worker)||void 0===U||U.terminate()}catch(L){gc.warning(L&&L.message)}}}TT.set(L,M),L.track.addEventListener("ended",n)},interceptRemoteAudioFrame:async function(k){let M=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!gf.supportWebRTCEncodedTransform)return void gc.warning("browser not support audio encoded transform");if(Tj.has(k))return;let U={track:k.track,onMetadata:M.onMetadata,onPts:M.onPts};if(QA()&&!nw()){if(!k.createEncodedStreams)return void gc.warning("browser not support createEncodedStreams() API");sw(fQ.CHROME,87,116)||(M.enableTopn=!1);let V=null;try{V=k.createEncodedStreams()}catch(L){return void gc.error("create audio-encoded-streams error",L&&L.message)}let F=new TransformStream({transform(V,F){U.controller||(U.controller=F),k.track&&k.track.id!==U.track.id&&(gc.debug("audio track changed: ".concat(U.track.id," => ").concat(k.track.id)),U.track.removeEventListener("ended",n),U.track=k.track,U.track.addEventListener("ended",n)),M.enableTopn?function(k,M,U){var V;let F=dM(new DataView(M.data));if(!F)return U.enqueue(M);let B=k.track.id;TW.set(B,k.track);let j=null===(V=F.tlv.find(L=>L.tag===Tg.AUDIO_LEVEL))||void 0===V?void 0:V.value,G=0;"number"==typeof j&&(G=127-j);let X=Math.round(Math.pow(10,G/60)-1),{selected:$,speaker:ee}=function(L,k){let M=Tb.get(L);if(M||(M=function(L){let k=new SM;return Tb.set(L,k),TN||(TN=new RM(wN("TOPN_SILENCE_THRESHOLD")||500)).on("ActiveSpeakerChanged",L=>{null!=L&&(TL=L)}),TN.addSpeakers([k]),k}(L)),Tb.size<=3)return{selected:!0,speaker:M};if(!TN)throw Error("no active speaker detector");return TN.levelChanged(M.id,k),Tk=TN.loudest.map(L=>L.id),TL&&!so(Tk).call(Tk,TL)&&Tk.length>=3&&Tk.pop(),{selected:so(Tk).call(Tk,M.id)||M.id===TL,speaker:M}}(k,X),et=function(k,M,U){let V=TU.get(k)||new OM(k,M);return V.score=U,TU.set(k,V),function(k){if(TV.set(k,!0),!L)return void(L=Date.now());let M=Date.now();M-L>1e3&&(TV.get(k)?TV.set(k,!1):(DM(k),TV.delete(k)),L=M)}(k),V}(B,k.track,ee.energyScore);et.addSample($),et.active&&(M.data=F.frame.buffer,U.enqueue(M))}(k,V,F):M.enableMetadata||M.enablePts?function(L,k,M,U){let V;let F=new DataView(L.data),B=F.getUint8(0);if(0!=(128&B)&&71!==B){let k=function(L){if(L.byteLength<=0)return[];let k=[],M=0;for(;M<L.byteLength;){let U=(128&L.getUint8(M))>>7,V=127&L.getUint8(M);if(!(U&&M+4<=L.byteLength)){M++;break}{let U=L.getUint32(M,!1),F=(16776192&U)>>10,B=1023&U;k.push({pt:V,ts_offset:F,length:B,data:new Uint8Array}),M+=4}}let U=L.byteLength-M;for(let V of k){if(V.length>U)return console.warn("Broken red payload"),[];V.length>0&&(V.data=new Uint8Array(L.buffer,L.byteOffset+M,V.length),M+=V.length,U-=V.length)}if(U>0){let V={pt:k.length>0?k[k.length-1].pt:0,ts_offset:0,length:U,data:new Uint8Array(L.buffer,L.byteOffset+M,U)};k.push(V)}return k}(F);if(k.length>0){let M=function(L){let k=0;for(let M=0;M<L.length;M++)k+=(M<L.length-1?4:1)+L[M].length;let M=new Uint8Array(k),U=0;for(let k=0;k<L.length;k++)if(k<L.length-1){let V=(2147483648|(127&L[k].pt)<<24|(262143&L[k].ts_offset)<<10|1023&L[k].length)>>>0;M[U++]=V>>24&255,M[U++]=V>>16&255,M[U++]=V>>8&255,M[U++]=255&V}else M[U++]=127&L[k].pt;for(let k of L)M.set(k.data,U),U+=k.length;return M}(k.map(L=>{let k=new Uint8Array(L.length);k.set(L.data);let M=dM(new DataView(k.buffer));return null!=M&&M.frame&&(L.data=null==M?void 0:M.frame),V=M,L}));L.data=M.buffer}}else(V=dM(F))&&(L.data=V.frame.buffer);if(k.enqueue(L),!V)return;let j=V.tlv.find(L=>L.tag===Tg.METADATA);j&&M&&j.value instanceof Uint8Array&&M(j.value);let G=V.tlv.find(L=>L.tag===Tg.AUDIO_64_BIT_PTS);G&&U&&G.value instanceof Uint8Array&&8==G.value.length&&U(new DataView(G.value.buffer).getBigUint64(0,!0))}(V,F,M.onMetadata,M.onPts):F.enqueue(V)}});V.readable.pipeThrough(F).pipeTo(V.writable)}else{if("undefined"==typeof RTCRtpScriptTransform)return void gc.warning("browser not support RTCRtpScriptTransform");let L=iM(),M=new MessageChannel;await new lQ(k=>L.onmessage=L=>{"registered"===L.data&&k(void 0)});let V=new RTCRtpScriptTransform(L,{name:"audio-metadata-rx",port:M.port2},[M.port2]);k.transform=V,await new lQ(k=>L.onmessage=L=>{"started"===L.data&&k(void 0)}),M.port1.onmessage=L=>{var M;L.data.transformed&&k.track&&(null===(M=k.track)||void 0===M?void 0:M.id)!==U.track.id?(gc.debug("audio track changed: ".concat(U.track.id," => ").concat(k.track.id)),U.track.removeEventListener("ended",n),U.track=k.track,U.track.addEventListener("ended",n)):L.data.metadata&&U.onMetadata?U.onMetadata(L.data.metadata):L.data.pts&&U.onPts&&U.onPts(L.data.pts)},U.worker=L}function n(){k.track.removeEventListener("ended",n),function(L){let k=Tj.get(L);if(k){(function(L){let k=Tb.get(L);k&&(Tb.delete(L),TN&&(TN.removeSpeakers([k]),0===Tb.size&&(TN.destroy(),TN=null)))})(L),DM(L.track.id),Tj.delete(L);try{var M,U;null===(M=k.controller)||void 0===M||M.terminate(),null===(U=k.worker)||void 0===U||U.terminate()}catch(L){gc.warning(L&&L.message)}}}(k)}Tj.set(k,U),k.track.addEventListener("ended",n)},interceptLocalVideoFrame:async function(L,k){if(!gf.supportWebRTCEncodedTransform)return void gc.warning("browser not support video encoded transform");if(TK.has(L)||!L.track)return;let M={track:L.track};if(QA()){if(!L.createEncodedStreams)return void gc.warning("browser not support createEncodedStreams() API");let U=null;try{U=L.createEncodedStreams()}catch(L){return void gc.error("create video-encoded-streams error",L&&L.message)}let V=[];k.on("sei-to-send",L=>{V.push(L)});let F=new TransformStream({transform(k,U){M.controller||(M.controller=U),L.track&&L.track.id!==M.track.id&&(gc.debug("video track changed: ".concat(M.track.id," => ").concat(L.track.id)),M.track.removeEventListener("ended",n),M.track=L.track,M.track.addEventListener("ended",n));let F=xM(new Uint8Array(k.data)),B=V.shift();if(B){let L=function(L,k,M){switch(M){case TG:return function(L,k){let M=VM(k),U=M.length,V=Math.floor(U/255),F=U%255,B=new Uint8Array(6+V+1+U+L.byteLength);B[0]=0,B[1]=0,B[2]=0,B[3]=1,B[4]=6,B[5]=101;let j=0;for(;j<V;)B[6+j]=255,j++;return B[6+j]=F,j++,B.set(M,6+j),B.set(new Uint8Array(L),6+j+U),B.buffer}(L,k);case TH:return function(L,k){let M=VM(k),U=M.length,V=Math.floor(U/255),F=U%255,B=new Uint8Array(7+V+1+U+1+L.byteLength);B[0]=0,B[1]=0,B[2]=0,B[3]=1,B[4]=78,B[5]=1,B[6]=101;let j=0;for(;j<V;)B[7+j]=255,j++;return B[7+j]=F,j++,B.set(M,7+j),B[7+(j+=U)]=128,j++,B.set(new Uint8Array(L),7+j),B.buffer}(L,k);default:return null}}(k.data,B,F);L&&(k.data=L)}U.enqueue(k)}});U.readable.pipeThrough(F).pipeTo(U.writable)}else{if(!$A())return;{if("undefined"==typeof RTCRtpScriptTransform)return void gc.warning("browser not support RTCRtpScriptTransform");let U=iM(),V=new MessageChannel;await new lQ(L=>U.onmessage=k=>{"registered"===k.data&&L(void 0)});let F=new RTCRtpScriptTransform(U,{name:"sei-tx",port:V.port2},[V.port2]);L.transform=F,await new lQ(L=>U.onmessage=k=>{"started"===k.data&&L(void 0)}),k.on("sei-to-send",L=>{V.port1.postMessage({sei:L})}),V.port1.onmessage=k=>{var U;k.data.transformed&&L.track&&(null===(U=L.track)||void 0===U?void 0:U.id)!==M.track.id&&(gc.debug("video track changed: ".concat(M.track.id," => ").concat(L.track.id)),M.track.removeEventListener("ended",n),M.track=L.track,M.track.addEventListener("ended",n))},M.worker=U}}function n(){if(L.track){if(this.id!==L.track.id)return;L.track.removeEventListener("ended",n)}let k=TK.get(L);if(k){TK.delete(L);try{var M,U;null===(M=k.controller)||void 0===M||M.terminate(),null===(U=k.worker)||void 0===U||U.terminate()}catch(L){gc.warning(L&&L.message)}}}TK.set(L,M),L.track.addEventListener("ended",n)},interceptRemoteVideoFrame:async function(L){let k=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!gf.supportWebRTCEncodedTransform)return void gc.warning("browser not support video encoded transform");if(!L.track)return;if(TJ.has(L)){let M=TJ.get(L);return void(M&&(M.onSei=k.onSei))}let M={track:L.track,onSei:k.onSei};if(QA()){if(!L.createEncodedStreams)return void gc.warning("browser not support createEncodedStreams() API");let k=null;try{k=L.createEncodedStreams()}catch(L){return void gc.error("create video-encoded-streams error",L&&L.message)}let U=new TransformStream({transform(k,U){M.controller||(M.controller=U),L.track&&L.track.id!==M.track.id&&(gc.debug("video track changed: ".concat(M.track.id," => ").concat(L.track.id)),M.track.removeEventListener("ended",n),M.track=L.track,M.track.addEventListener("ended",n));let V=function(L,k){switch(k){case TG:return function(L){let k=new DataView(L.data),M=0;for(;M+4<L.data.byteLength;){if(0===k.getUint8(M+0)&&0===k.getUint8(M+1)&&0===k.getUint8(M+2)&&1===k.getUint8(M+3)&&6===k.getUint8(M+4)){let U=M+6,V=0,F=0;for(;255===(F=k.getUint8(U++));)V+=255;V+=F;let B=UM(L.data,U,V);return new Uint8Array(B)}M++}return null}(L);case TH:return function(L){let k=new DataView(L.data),M=0;for(;M+5<L.data.byteLength;){if(0===k.getUint8(M+0)&&0===k.getUint8(M+1)&&0===k.getUint8(M+2)&&1===k.getUint8(M+3)&&78===k.getUint8(M+4)&&1===k.getUint8(M+5)&&101===k.getUint8(M+6)){let U=M+7,V=0,F=0;for(;255===(F=k.getUint8(U++));)V+=255;V+=F;let B=UM(L.data,U,V);return new Uint8Array(B)}M++}return null}(L);default:return null}}(k,xM(new Uint8Array(k.data)));V&&M.onSei&&M.onSei(V),U.enqueue(k)}});k.readable.pipeThrough(U).pipeTo(k.writable)}else if($A()){if("undefined"==typeof RTCRtpScriptTransform)return void gc.warning("browser not support RTCRtpScriptTransform");let k=iM(),U=new MessageChannel;await new lQ(L=>k.onmessage=k=>{"registered"===k.data&&L(void 0)});let V=new RTCRtpScriptTransform(k,{name:"sei-rx",port:U.port2},[U.port2]);L.transform=V,await new lQ(L=>k.onmessage=k=>{"started"===k.data&&L(void 0)}),U.port1.onmessage=k=>{var U;k.data.transformed&&L.track&&(null===(U=L.track)||void 0===U?void 0:U.id)!==M.track.id?(gc.debug("video track changed: ".concat(M.track.id," => ").concat(L.track.id)),M.track.removeEventListener("ended",n),M.track=L.track,M.track.addEventListener("ended",n)):k.data.sei&&M.onSei&&M.onSei(k.data.sei)},M.worker=k}function n(){if(L.track){if(this.id!==L.track.id)return;L.track.removeEventListener("ended",n)}!function(L){let k=TJ.get(L);if(k){TJ.delete(L);try{var M,U;null===(M=k.controller)||void 0===M||M.terminate(),null===(U=k.worker)||void 0===U||U.terminate()}catch(L){gc.warning(L&&L.message)}}}(L)}TJ.set(L,M),L.track.addEventListener("ended",n)}};fN(),AN("PROCESS_ID","process-".concat(IO(8,""),"-").concat(IO(4,""),"-").concat(IO(4,""),"-").concat(IO(4,""),"-").concat(IO(12,""))),function(){let L;try{L=window.localStorage.getItem("websdk_ng_global_parameter")}catch(L){return void gc.error("Error loading sdk config",L.message)}if(L)try{let k=JSON.parse(window.atob(L)),M=Date.now();gc.debug("Loading global parameters from cache",k),Object.keys(k).forEach(L=>{if(Object.prototype.hasOwnProperty.call(S3,L)){let{value:U,expires:V}=k[L];V&&V<=M||(S4[L]=U,S3[L]=U)}})}catch(k){gc.error("Error loading mutableParamsCache: ".concat(L),k.message)}}(),Array.isArray(S4.AREAS)&&S4.AREAS.length>0&&_F(S4.AREAS,!0);let kq=(L,k,M)=>{gc.debug("setParameter key:".concat(L,", value:").concat(JSON.stringify(k))),AN(L,k,M)};Xx({name:"ChannelMediaRelay",create:function(L){return new ZY(L.joinInfo,L.clientId,L.websocketRetryConfig||Sm,L.httpRetryConfig||Sm,L.resolution)}},!1),Xx({name:"LiveStreaming",create:function(L){return new rz(L.joinInfo,L.websocketRetryConfig||Sm,L.httpRetryConfig||Sm)}},!1),Xx({name:"ImageModeration",create:function(L){let{config:k}=L;return _G(k),new pG(k)}},!1),Xx({name:"ContentInspect",create:function(L){let{config:k}=L;return function(L){if(!L)throw new ED(f1.INVALID_PARAMS,"inspectConfig is necessary.");if(!L.inspectType||!Array.isArray(L.inspectType))throw new ED(f1.INVALID_PARAMS,"inspectConfig.inspectType is necessary and is an instance of Array.");{let k=[...new Set(L.inspectType)];k.forEach(L=>{var k;if(!so(k=["supervise","moderation"]).call(k,L))throw new ED(f1.INVALID_PARAMS,"".concat(L," is not a valid inspect type."))}),L.inspectType=k}if(L&&L.extraInfo&&L.extraInfo.length>1024)throw new ED(f1.INVALID_PARAMS,"inspectConfig.extraInfo length cannot exceed 1024 bytes")}(k),new Mz(k)}},!1),Xx({name:"DataStream",create:(L,k)=>{let M=k?new eM(L):new tM(L);return M.useDataStream(new qY),M}},!1),Xx({name:"P2PChannel",create:function(L){let{store:k,statsCollector:M}=L;return new yW(k,M)},createSubmodule:function(L){let{store:k,spec:M}=L;return new Rq(M,k)}},!1),Xx({name:"PlanBConnection",create:function(L){let{store:k,spec:M}=L;return new yG(M,k)}},!1),Xx({name:"InterceptFrame",create:()=>yH},!1);let yK=function(L){let k=new Hw,M={getListeners:k.getListeners.bind(k),on:(L,M)=>(L===Ii.SECURITY_POLICY_VIOLATION&&EW(M,!0),k.on.bind(k)(L,M)),addListener:k.addListener.bind(k),once:k.once.bind(k),off:k.off.bind(k),removeAllListeners:k.removeAllListeners.bind(k),emit:k.emit.bind(k),safeEmit:k.safeEmit.bind(k)};return pW(pW({},L),M)}({__TRACK_LIST__:gb,VERSION:SJ,BUILD:S1,ESM_BUNDLER:!1,ESM:!1,UMD:!0,DEV:!1,setParameter:kq,getParameter:wN,getSupportedCodec:async function(){let L={audio:[],video:[]};try{let k=new RTCPeerConnection,M=await async function(L){let k;return gf.supportUnifiedPlan?(L.addTransceiver("video",{direction:"recvonly"}),L.addTransceiver("audio",{direction:"recvonly"}),k=(await L.createOffer()).sdp):k=(await L.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0})).sdp,k}(k);if(!M)return L;k.close(),k=null,L=function(L){let k={video:[],audio:[]};return L.match(/ VP8/i)&&k.video.push("VP8"),L.match(/ VP9/i)&&k.video.push("VP9"),L.match(/ AV1/i)&&k.video.push("AV1"),L.match(/ H264/i)&&k.video.push("H264"),L.match(/ H265/i)&&k.video.push("H265"),L.match(/ opus/i)&&k.audio.push("OPUS"),L.match(/ PCMU/i)&&k.audio.push("PCMU"),L.match(/ PCMA/i)&&k.audio.push("PCMA"),L.match(/ G722/i)&&k.audio.push("G722"),k}(M)}catch(L){throw new ED(f1.CREATE_OFFER_FAILED,L.toString&&L.toString()).print()}return L},checkSystemRequirements:function(){let L=g_.reportApiInvoke(null,{name:f8.CHECK_SYSTEM_REQUIREMENTS,options:[],tag:f9.TRACER}),k=!1;try{let L=window.RTCPeerConnection,M=navigator.mediaDevices&&navigator.mediaDevices.getUserMedia,U=window.WebSocket;(k=!!(L&&M&&U))&&Rw()&&ow(75)&&(new L).close()}catch(L){return gc.error("check system requirement failed: ",L),!1}let M=!1,U=zA();U.name===fQ.CHROME&&Number(U.version)>=58&&("WebKit"!==f$.engine.name||function(){let L=zA();if(ZA()){if(L.os===fX.MAC_OS)return!0;if(L.os===fX.IOS){let L=f$.os.version&&f$.os.version.split(".");if(L&&14===Number(L[0])&&L[1]&&Number(L[1])>=3||L&&Number(L[0])>14)return!0}}return!1}())&&(M=!0),(U.name===fQ.FIREFOX&&Number(U.version)>=56||U.name===fQ.OPERA&&Number(U.version)>=45||U.name===fQ.SAFARI&&Number(U.version)>=11||"WebKit"===U.name&&(nw()||Sw())&&U.osVersion&&Number(U.osVersion.split(".")[0])>=11||gw()||zA().name===fQ.QQ)&&(M=!0),gc.debug("checkSystemRequirements, api:",k,"browser",M);let V=k&&M;return L.onSuccess(V),V},getDevices:function(L){return Ti.enumerateDevices(!0,!0,L)},getMicrophones:function(L){return Ti.getRecordingDevices(L)},getCameras:function(L){return Ti.getCamerasDevices(L)},getElectronScreenSources:yP,getPlaybackDevices:function(L){return Ti.getSpeakers(L)},createClient:function(){var L;let k=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{codec:"vp8",audioCodec:"opus",mode:"rtc"},M=IO(5,"client-"),U=g_.reportApiInvoke(null,{id:M,name:f8.CREATE_CLIENT,options:[k],tag:f9.TRACER});try{Dw(k.codec,"config.codec",["vp8","vp9","av1","h264","h265"]),Dw(k.mode,"config.mode",["rtc","live","p2p"]),void 0!==k.audioCodec&&Dw(k.audioCodec,"config.audioCodec",["opus","pcmu","pcma","g722"]),void 0!==k.proxyServer&&kw(k.proxyServer,"config.proxyServer",1,1e4),void 0!==k.turnServer&&$w(k.turnServer),void 0!==k.httpRetryConfig&&Xw(k.httpRetryConfig),void 0!==k.websocketRetryConfig&&Xw(k.websocketRetryConfig)}catch(L){throw U.onError(L),L}return(uw(16,0,!0)||hw(16,0,!0))&&("vp9"===k.codec&&(k.codec="vp8",gc.debug("browser not support vp9, force use vp8")),AN("UNSUPPORTED_VIDEO_CODEC",["vp9"])),void 0===k.audioCodec&&(k.audioCodec="opus"),U.onSuccess(),new vI(oW(oW({forceWaitGatewayResponse:!0},k),{},{role:so(L=["rtc","p2p"]).call(L,k.mode)?"host":k.role||"audience"}),M)},createCameraVideoTrack:async function(){let L=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},k=wN("CAMERA_CAPTURE_CONFIG"),M=IO(8,"track-cam-"),U=g_.reportApiInvoke(null,{id:M,tag:f9.TRACER,name:f8.CREATE_CAM_VIDEO_TRACK,options:[dP({},L),k]});k&&(L.encoderConfig=k);let V=zP(L),F=null;gc.info("start create camera video track with config",JSON.stringify(L),"trackId",M);try{F=(await wP({video:V},M)).getVideoTracks()[0]||null}catch(L){throw U.onError(L),L}if(!F){let L=new f2(f1.UNEXPECTED_ERROR,"can not find track in media stream");return U.onError(L),L.throw(gc)}if(L.optimizationMode&&Uk(M,F,L,ND(L.encoderConfig)),wN("USE_STANDARD_BITRATE_DEFAULT")){let k=ND(L.encoderConfig);L.encoderConfig=k,delete k.bitrateMax,delete k.bitrateMin}let B=new T_(F,L,V,L.scalabiltyMode?PD(L.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},L.optimizationMode,M);return U.onSuccess(B.getTrackId()),gc.info("create camera video success, trackId:",M),B},createCustomVideoTrack:function(L){let k=IO(8,"track-cus-"),M=g_.reportApiInvoke(null,{id:k,tag:f9.TRACER,name:f8.CREATE_CUSTOM_VIDEO_TRACK,options:[L]});wN("USE_STANDARD_BITRATE_DEFAULT")&&(delete L.bitrateMax,delete L.bitrateMin);let U=new Tp(L.mediaStreamTrack,{width:L.width,height:L.height,frameRate:L.frameRate,bitrateMax:L.bitrateMax,bitrateMin:L.bitrateMin},L.scalabiltyMode?PD(L.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},L.optimizationMode,k,[gL.CUSTOM_TRACK]);return M.onSuccess(U.getTrackId()),gc.info("create custom video track success with config",L,"trackId",U.getTrackId()),U},createScreenVideoTrack:async function(){let L=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},k=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"disable",M="object"==typeof k?qP(k):void 0;M&&(k="auto");let U=IO(8,"track-scr-v-"),V=g_.reportApiInvoke(null,{id:U,tag:f9.TRACER,name:f8.CREATE_SCREEN_VIDEO_TRACK,options:[dP({},L),k]});L.encoderConfig?"string"==typeof L.encoderConfig||L.encoderConfig.width&&L.encoderConfig.height||(L.encoderConfig.width={max:1920},L.encoderConfig.height={max:1080}):L.encoderConfig="1080p_2";let F=function(L){let k={};L.screenSourceType&&(k.mediaSource=L.screenSourceType),L.extensionId&&QA()&&(k.extensionId=L.extensionId);let{displaySurface:M,selfBrowserSurface:U,surfaceSwitching:V,systemAudio:F,preferCurrentTab:B}=L;(rw(107)||aw(107)||pw(93))&&(M&&(Dw(M,"displaySurface",["browser","window","monitor"]),k.displaySurface=M),U?(Dw(U,"selfBrowserSurface",["exclude","include"]),k.selfBrowserSurface=U):k.selfBrowserSurface="include",V&&(Dw(V,"surfaceSwitching",["exclude","include"]),k.surfaceSwitching=V)),(rw(105)||aw(105)||pw(91))&&F&&(Dw(F,"systemAudio",["exclude","include"]),k.systemAudio=F),(rw(94)||aw(94)||pw(80))&&B&&(k.preferCurrentTab=!0),L.electronScreenSourceId&&(k.sourceId=L.electronScreenSourceId);let j=L.encoderConfig?DD(L.encoderConfig):null;return k.mandatory={chromeMediaSource:"desktop",maxWidth:j?j.width:void 0,maxHeight:j?j.height:void 0},j&&(j.frameRate&&("number"==typeof j.frameRate?(k.mandatory.maxFrameRate=j.frameRate,k.mandatory.minFrameRate=j.frameRate):(k.mandatory.maxFrameRate=j.frameRate.max||j.frameRate.ideal||j.frameRate.exact||void 0,k.mandatory.minFrameRate=j.frameRate.min||j.frameRate.ideal||j.frameRate.exact||void 0),k.frameRate=j.frameRate),j.width&&(k.width=j.width),j.height&&(k.height=j.height)),k}(L),B=null,j=null;if(!gf.supportShareAudio&&"enable"===k){let L=new f2(f1.NOT_SUPPORTED,"your browser or platform is not support share-screen with audio");return V.onError(L),L.throw(gc)}gc.info("start create screen video track with config",L,"withAudio",k,"trackId",U);let G=gf.supportShareAudio&&"disable"!==k;try{let L=await wP({screen:F,screenAudio:G?M||!0:void 0},U);B=L.getVideoTracks()[0]||null,j=L.getAudioTracks()[0]||null}catch(L){throw V.onError(L),L}if(!B){let L=new f2(f1.UNEXPECTED_ERROR,"can not find track in media stream");return V.onError(L),L.throw(gc)}if(!j&&"enable"===k){B&&B.stop();let L=new f2(f1.SHARE_AUDIO_NOT_ALLOWED);return V.onError(L),L.throw(gc)}L.optimizationMode||(L.optimizationMode="detail"),L.optimizationMode&&(Uk(U,B,L,L.encoderConfig&&DD(L.encoderConfig)||void 0),L.encoderConfig&&"string"!=typeof L.encoderConfig&&(L.encoderConfig.bitrateMin=L.encoderConfig.bitrateMax));let X=new Tp(B,L.encoderConfig?DD(L.encoderConfig):{},L.scalabiltyMode?PD(L.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},L.optimizationMode,U,[gL.SCREEN_TRACK]);if(!j)return V.onSuccess(X.getTrackId()),gc.info("create screen video track success","video:",X.getTrackId()),X;let $=new Ts(j,void 0,IO(8,"track-scr-a-"),!1);return V.onSuccess([X.getTrackId(),$.getTrackId()]),gc.info("create screen video track success","video:",X.getTrackId(),"audio:",$.getTrackId()),[X,$]},createMicrophoneAndCameraTracks:async function(){let L=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},k=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},M=wN("CAMERA_CAPTURE_CONFIG"),U=IO(8,"track-mic-"),V=IO(8,"track-cam-"),F=g_.reportApiInvoke(null,{id:"".concat(U,"-").concat(V),tag:f9.TRACER,name:f8.CREATE_MIC_AND_CAM_TRACKS,options:[L,k,M]});M&&(k.encoderConfig=M);let B=zP(k),j=XP(L),G=null,X=null;gc.info("start create camera video track(".concat(V,") and microphone audio track(").concat(U,") with config, audio: ").concat(JSON.stringify(L),", video: ").concat(JSON.stringify(k)));try{let L=await wP({audio:j,video:B},"".concat(U,"-").concat(V));G=L.getAudioTracks()[0],X=L.getVideoTracks()[0]}catch(L){throw F.onError(L),L}if(!G||!X){let L=new f2(f1.UNEXPECTED_ERROR,"can not find tracks in media stream");return F.onError(L),L.throw(gc)}if(k.optimizationMode&&Uk(V,X,k,ND(k.encoderConfig)),wN("USE_STANDARD_BITRATE_DEFAULT")){let L=ND(k.encoderConfig);k.encoderConfig=L,delete L.bitrateMax,delete L.bitrateMin}let $=new Tc(G,L,j,U),ee=new T_(X,k,B,k.scalabiltyMode?PD(k.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},k.optimizationMode,V);return F.onSuccess([$.getTrackId(),ee.getTrackId()]),gc.info("create camera video track(".concat(V,") and microphone audio track(").concat(U,") success")),[$,ee]},createMicrophoneAudioTrack:async function(){let L=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},k=IO(8,"track-mic-"),M=g_.reportApiInvoke(null,{id:k,tag:f9.TRACER,name:f8.CREATE_MIC_AUDIO_TRACK,options:[L]}),U=XP(L),V=null;gc.info("start create microphone audio track with config",JSON.stringify(L),"trackId",k);try{V=(await wP({audio:U},k)).getAudioTracks()[0]||null}catch(L){throw M.onError(L),L}if(!V){let L=new f2(f1.UNEXPECTED_ERROR,"can not find track in media stream");return M.onError(L),L.throw(gc)}let F=new Tc(V,L,U,k);return M.onSuccess(F.getTrackId()),gc.info("create microphone audio track success, trackId:",k),F},createCustomAudioTrack:function(L){let k=IO(8,"track-cus-"),M=g_.reportApiInvoke(null,{id:k,tag:f9.TRACER,name:f8.CREATE_CUSTOM_AUDIO_TRACK,options:[L]}),U=new Ts(L.mediaStreamTrack,L.encoderConfig?kD(L.encoderConfig):{},k,!1);return gc.info("create custom audio track success with config",L,"trackId",U.getTrackId()),M.onSuccess(U.getTrackId()),U},createBufferSourceAudioTrack:async function(L){var k;let{cacheOnlineFile:M,encoderConfig:U}=L,{source:V}=L,F={source:V instanceof AudioBuffer?"AudioBuffer":V instanceof File?null!==(k=File.name)&&void 0!==k?k:"File":V,cacheOnlineFile:M,encoderConfig:U},B=IO(8,"track-buf-"),j=g_.reportApiInvoke(null,{id:B,tag:f9.TRACER,name:f8.CREATE_BUFFER_AUDIO_TRACK,options:[F]});if(wN("DISABLE_WEBAUDIO"))throw new f2(f1.NOT_SUPPORTED,"can not create BufferSourceAudioTrack when WebAudio disabled");gc.info("start create buffer source audio track with config",JSON.stringify(F),"trackId",B);let G=V;if(!(V instanceof AudioBuffer))try{V=await async function(L,k){let M=null;if("string"==typeof L){let k=Tl.get(L);if(k)return gc.debug("use cached audio resource: ",L),k;try{M=(await GO(()=>fG.get(L,{responseType:"arraybuffer"}),void 0,void 0,{maxRetryCount:3})).data}catch(L){throw new f2(f1.FETCH_AUDIO_FILE_FAILED,L.toString())}}else{let k=new lQ((k,M)=>{let U=new FileReader;U.onload=L=>{L.target?k(L.target.result):M(new f2(f1.READ_LOCAL_AUDIO_FILE_ERROR))},U.onerror=()=>{M(new f2(f1.READ_LOCAL_AUDIO_FILE_ERROR))},U.readAsArrayBuffer(L)});M=await k}let U=await function(L){let k=EP();return new lQ((M,U)=>{k.decodeAudioData(L,L=>{M(L)},L=>{U(new f2(f1.DECODE_AUDIO_FILE_FAILED,L.toString()))})})}(M);return"string"==typeof L&&k&&Tl.set(L,U),U}(V,M)}catch(L){return j.onError(L),L.throw(gc)}let X=new HL(V),$=new Td(G,X,U?kD(U):{},B);return gc.info("create buffer source audio track success, trackId:",B),j.onSuccess($.getTrackId()),$},setAppType:function(L){if(gc.debug("setAppType: ".concat(L)),!(Number.isInteger(L)&&L>=0))throw gc.debug("Invalid appType"),new ED(f1.INVALID_PARAMS,"invalid app type",L);AN("APP_TYPE",Math.floor(L))},setLogLevel:function(L){gc.setLogLevel(L)},enableLogUpload:function(){wN("USE_NEW_LOG")?AN("UPLOAD_LOG",!0):gc.enableLogUpload()},disableLogUpload:function(){wN("USE_NEW_LOG")?AN("UPLOAD_LOG",!1):gc.disableLogUpload()},createChannelMediaRelayConfiguration:function(){return new JF},checkAudioTrackIsActive:async function(L){let k=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5e3,M=g_.reportApiInvoke(null,{tag:f9.TRACER,name:f8.CHECK_AUDIO_TRACK_IS_ACTIVE,options:[k]});if(!(L instanceof Ts||L instanceof Tf)){let L=new ED(f1.INVALID_TRACK,"the parameter is not a audio track");return M.onError(L),L.throw()}k&&k<1e3&&(k=1e3);let U=L instanceof Ts?L.getTrackLabel():"remote_track",V=L.getVolumeLevel(),F=V,B=V,j=Date.now();return new lQ(V=>{let G=setInterval(()=>{let X=L.getVolumeLevel();F=X>F?X:F,B=X<B?X:B;let $=F-B>1e-4,ee=Date.now()-j;if($||ee>k){clearInterval(G);let k={duration:ee,deviceLabel:U,maxVolumeLevel:F,result:$};gc.info("[track-".concat(L.getTrackId(),"] check audio track active completed. ").concat(JSON.stringify(k))),M.onSuccess(k),V($)}},200)})},checkVideoTrackIsActive:async function(L){let k=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5e3,M=g_.reportApiInvoke(null,{tag:f9.TRACER,name:f8.CHECK_VIDEO_TRACK_IS_ACTIVE,options:[k]});if(!(L instanceof Tp||L instanceof TE)){let L=new ED(f1.INVALID_TRACK,"the parameter is not a video track");return M.onError(L),L.throw()}k&&k<1e3&&(k=1e3);let U=L instanceof Tp?L.getTrackLabel():"remote_track",V=L.getMediaStreamTrack(!0),F=document.createElement("video");F.style.width="1px",F.style.height="1px",F.setAttribute("muted",""),F.muted=!0,F.setAttribute("playsinline",""),F.controls=!1,($A()||ZA())&&(F.style.opacity="0.01",F.style.position="fixed",F.style.left="0",F.style.top="0",document.body.appendChild(F)),F.srcObject=new MediaStream([V]),F.play();let B=document.createElement("canvas");B.width=160,B.height=120;let j=0,G=0;try{var X;let L,M,U;let V=Date.now();j=await (X=k,M=0,U=null,new lQ((k,V)=>{function d(){M>4&&L&&(L(),k(M));let j=B.getContext("2d");if(!j){let L=new ED(f1.UNEXPECTED_ERROR,"can not get canvas 2d context.");return gc.error(L.toString()),void V(L)}j.drawImage(F,0,0,160,120);let G=j.getImageData(0,0,B.width,B.height),X=Math.floor(G.data.length/3);if(U){for(let L=0;L<X;L+=3)if(G.data[L]!==U[L])return M+=1,void(U=G.data);U=G.data}else U=G.data}setTimeout(()=>{L&&(L(),k(M))},X),L=SP(()=>{d()},30)})),G=Date.now()-V}catch(L){throw M.onError(L),L}vt===fQ.SAFARI&&(F.pause(),F.remove()),F.srcObject=null;let $=j>4,ee={duration:G,changedPicNum:j,deviceLabel:U,result:$};return gc.info("[track-".concat(L.getTrackId(),"] check video track active completed. ").concat(JSON.stringify(ee))),M.onSuccess(ee),$},setArea:_F,audioElementPlayCenter:To,resumeAudioContext:function(){To.autoResumeAfterInterruption(!0)},processExternalMediaAEC:function(L){vC.processExternalMediaAEC(L)},registerExtensions:function(L){let k=wN("PLUGIN_INFO")||[];L.forEach(L=>{"name"in L&&!so(k).call(k,L.name)&&k.push(L.name),L.__registered__=!0,L.logger.hookLog=gc.extLog,L.reporter.hookApiInvoke=g_.extApiInvoke,L.parameters&&Object.keys(L.parameters).forEach(k=>{L.parameters[k]=wN(k)})}),kq("PLUGIN_INFO",k)},ChannelMediaRelayError:Rj,ChannelMediaRelayEvent:RU,ChannelMediaRelayState:RV,RemoteStreamFallbackType:gV,RemoteStreamType:gU,ConnectionDisconnectedReason:Se,AudienceLatencyLevelType:f7,AREAS:RX,preload:async function(L,k,M,U){return bj(L,k,M,U)}});return Object.defineProperties(yK,{onAudioAutoplayFailed:{get:()=>Tn.onAudioAutoplayFailed,set:L=>{Tn.onAudioAutoplayFailed=L}},onAutoplayFailed:{get:()=>Tn.onAutoplayFailed,set:L=>{Tn.onAutoplayFailed=L}},_onSecurityPolicyViolation:{value:void 0,writable:!0},_cspEventHandlerPointer:{value:void 0,writable:!0},onSecurityPolicyViolation:{get:()=>yK._onSecurityPolicyViolation,set(L){yK._onSecurityPolicyViolation=L,EW(L)}},__CLIENT_LIST__:{get:()=>wN("SHOW_GLOBAL_CLIENT_LIST")?TZ:[]}}),Ti.on(g0.CAMERA_DEVICE_CHANGED,L=>{gc.info("camera device changed",JSON.stringify(L)),yK.onCameraChanged&&yK.onCameraChanged(L),yK.safeEmit(Ii.CAMERA_CHANGED,L)}),Ti.on(g0.RECORDING_DEVICE_CHANGED,L=>{gc.info("microphone device changed",JSON.stringify(L)),yK.onMicrophoneChanged&&yK.onMicrophoneChanged(L),yK.safeEmit(Ii.MICROPHONE_CHANGED,L)}),Ti.on(g0.PLAYOUT_DEVICE_CHANGED,L=>{gc.debug("playout device changed",JSON.stringify(L)),yK.onPlaybackDeviceChanged&&yK.onPlaybackDeviceChanged(L),yK.safeEmit(Ii.PLAYBACK_DEVICE_CHANGED,L)}),To.onAutoplayFailed=()=>{gc.info("detect audio element autoplay failed"),Tn.onAudioAutoplayFailed&&Tn.onAudioAutoplayFailed()},g8.on("autoplay-failed",()=>{gc.info("detect webaudio autoplay failed"),Tn.onAudioAutoplayFailed&&Tn.onAudioAutoplayFailed(),yK.safeEmit(Ii.AUTOPLAY_FAILED)}),g8.on(gS.STATE_CHANGE,(L,k)=>{gc.info("audio context state changed: ".concat(k," => ").concat(L)),yK.onAudioContextStateChanged&&yK.onAudioContextStateChanged(L,k),yK.safeEmit(Ii.AUDIO_CONTEXT_STATE_CHANGED,L,k)}),Ss.on(So.NETWORK_STATE_CHANGE,(L,k)=>{gc.info("[network-indicator] network state changed, ".concat(k," => ").concat(L))}),window&&(window.__ARTC__=yK),yK}()}}]);