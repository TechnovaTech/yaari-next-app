"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[773],{4773:function(e,l,o){o.r(l),o.d(l,{default:function(){return AudioCallScreen}});var t=o(7437),a=o(2265),n=o(2263),r=o.n(n),i=o(4671),s=o(5997),c=o(4033),d=o(5376),u=o(5128);let syncUserToCleverTap=async()=>{try{let e=localStorage.getItem("user");if(!e)return;let l=JSON.parse(e),o=(null==l?void 0:l.id)||(null==l?void 0:l._id)||(null==l?void 0:l.phone);if(!o){console.log("⚠️ No user identity found, skipping CleverTap sync");return}console.log("\uD83D\uDD04 Syncing user to CleverTap:",o),await (0,u.Lj)({Identity:o,Name:null==l?void 0:l.name,Email:null==l?void 0:l.email,Phone:null==l?void 0:l.phone,Gender:null==l?void 0:l.gender,Age:null==l?void 0:l.age,City:null==l?void 0:l.city,"Profile Picture":null==l?void 0:l.profilePic,"Coins Balance":(null==l?void 0:l.coins)||0,"User Type":(null==l?void 0:l.isPremium)?"Premium":"Free","Last Updated":new Date().toISOString()}),console.log("✅ User synced to CleverTap successfully")}catch(e){console.error("❌ Error syncing user to CleverTap:",e)}},trackCallEvent=async(e,l,o,t)=>{await (0,u.L9)("Call ".concat(l),{"Call Type":e,"Other User ID":o,Duration:t,Timestamp:new Date().toISOString()})};var g=o(2273),h=o(3103),v=o(4064);function AvatarCircle(e){let{src:l,alt:o,className:a}=e;return(0,t.jsx)("div",{className:"w-40 h-40 rounded-full overflow-hidden bg-white/20 mb-8 ".concat(a||""),children:(0,t.jsx)("img",{src:l,alt:o,className:"w-full h-full object-cover"})})}let formatTime=e=>"".concat(Math.floor(e/60).toString().padStart(2,"0"),":").concat((e%60).toString().padStart(2,"0"));function CallStats(e){let{userName:l,duration:o,cost:a,remainingBalance:n,rate:r}=e;return(0,t.jsxs)("div",{className:"flex-1 flex flex-col items-center justify-center",children:[(0,t.jsx)("h2",{className:"text-3xl font-bold text-white mb-4",children:l}),(0,t.jsx)("p",{className:"text-2xl text-white mb-2",children:formatTime(o)}),(0,t.jsxs)("p",{className:"text-lg text-white/80",children:["₹",a]}),null!==n&&n<=r&&(0,t.jsxs)("div",{className:"mt-4 bg-red-500/90 backdrop-blur-sm px-4 py-2 rounded-full flex items-center gap-2 animate-pulse",children:[(0,t.jsx)("img",{src:"/images/coinicon.png",alt:"coin",className:"w-4 h-4 object-contain"}),(0,t.jsxs)("span",{className:"text-white font-semibold mt-2.5",children:[n," coins left"]})]})]})}var f=o(2898);let p=(0,f.Z)("Volume2",[["polygon",{points:"11 5 6 9 2 9 2 15 6 15 11 19 11 5",key:"16drj5"}],["path",{d:"M15.54 8.46a5 5 0 0 1 0 7.07",key:"ltjumu"}],["path",{d:"M19.07 4.93a10 10 0 0 1 0 14.14",key:"1kegas"}]]);var m=o(2741),y=o(4043);function ControlsBar(e){let{isSpeakerOn:l,isMuted:o,onToggleSpeaker:a,onToggleMute:n,onEndCall:r}=e;return(0,t.jsxs)("div",{className:"flex justify-center items-center space-x-6 mb-8",children:[(0,t.jsx)("button",{onClick:a,className:"w-14 h-14 rounded-full flex items-center justify-center ".concat(l?"bg-white":"bg-white/30"),children:(0,t.jsx)(p,{className:l?"text-primary":"text-white",size:24})}),(0,t.jsx)("button",{onClick:r,className:"w-16 h-16 bg-red-500 rounded-full flex items-center justify-center shadow-lg",children:(0,t.jsx)(m.Z,{className:"text-white rotate-[135deg]",size:28})}),(0,t.jsx)("button",{onClick:n,className:"w-14 h-14 rounded-full flex items-center justify-center ".concat(o?"bg-red-500":"bg-white/30"),children:(0,t.jsx)(y.Z,{className:"text-white",size:24})})]})}function AudioCallScreen(e){let{userName:l,userAvatar:o,rate:n,onEndCall:f}=e,p=(0,c.useRouter)(),{socket:m}=(0,s.useSocket)();(0,d.K)(()=>handleEndCall());let[y,C]=(0,a.useState)(0),[w,S]=(0,a.useState)(!1),[I,N]=(0,a.useState)(!1),[x,b]=(0,a.useState)(null),[A]=(0,a.useState)(()=>r().createClient({mode:"rtc",codec:"vp8"})),[k,D]=(0,a.useState)(!1),[E,j]=(0,a.useState)(null),T=(0,a.useRef)(null),O=(0,a.useRef)(null),U=(0,a.useRef)(null),ensureWebAudioAlive=async()=>{try{let e=window.AudioContext||window.webkitAudioContext;if(!e)return;if(!T.current){T.current=new e;let l=T.current;U.current=l.createGain(),U.current.gain.value=0,O.current=l.createOscillator(),O.current.type="sine",O.current.frequency.value=240,O.current.connect(U.current),U.current.connect(l.destination);try{O.current.start()}catch(e){}}let l=T.current;l&&"suspended"===l.state&&(await l.resume(),console.log("WebAudio AudioContext resumed after route change"))}catch(e){console.warn("ensureWebAudioAlive failed:",e)}};(0,a.useEffect)(()=>{let e=setInterval(()=>{C(e=>e+1)},1e3);return()=>clearInterval(e)},[]);let handleCoinDeduction=async()=>{try{let e=sessionStorage.getItem("callData");if(console.log("Call data from session:",e),!e)return;let l=JSON.parse(e);console.log("Parsed call data:",l),console.log("isCaller value:",l.isCaller);let o=localStorage.getItem("user");if(!o)return;let t=JSON.parse(o);if(!1===l.isCaller){console.log("Receiver - not deducting coins");return}console.log("Caller - deducting coins"),console.log("Attempting to deduct ".concat(n," coins at ").concat(y,"s"));let a=await (0,g.G)(t.id,n,"audio");console.log("Successfully deducted ".concat(n," coins")),(null==a?void 0:a.newBalance)!==void 0&&j(a.newBalance)}catch(l){var e;console.error("Coin deduction failed:",l),(null===(e=l.message)||void 0===e?void 0:e.includes("Insufficient"))&&(alert("Insufficient coins! Call will end."),handleEndCall())}};(0,a.useEffect)(()=>{10!==y||k?k&&y>10&&(y-10)%60==0&&(console.log("Deduction at ".concat(y," seconds")),handleCoinDeduction()):(console.log("First deduction at 10 seconds"),D(!0),handleCoinDeduction())},[y]),(0,a.useEffect)(()=>{if(!m){console.log("Socket not available in audio call");return}console.log("Setting up call-ended listener in audio call");let handleRemoteCallEnd=()=>{console.log("\uD83D\uDD34 CALL ENDED BY OTHER USER - CLOSING AUDIO CALL");try{x&&(console.log("Closing local audio track"),x.close()),console.log("Leaving Agora channel"),A.leave(),console.log("Clearing session data"),sessionStorage.removeItem("callData"),sessionStorage.removeItem("channelName"),console.log("Navigating to /users"),window.location.href="/users"}catch(e){console.error("Error during call cleanup:",e),p.push("/users")}};return m.on("call-ended",handleRemoteCallEnd),console.log("call-ended listener registered"),()=>{console.log("Removing call-ended listener"),m.off("call-ended",handleRemoteCallEnd)}},[m,x,A,p]),(0,a.useEffect)(()=>{let init=async()=>{try{var e,l,o,t,a;if(sessionStorage.getItem("callData"),h.dV.isNativePlatform())try{await v.Z.enterCommunicationMode(),await v.Z.setSpeakerphoneOn({on:!0}),N(!0),console.log("Audio routing set to ".concat("speaker"," (initial)")),await ensureWebAudioAlive()}catch(e){console.warn("Failed to set initial earpiece routing:",e)}try{null===r()||void 0===r()||null===(e=r().setAudioProfile)||void 0===e||e.call(r(),"speech_low_quality"),null===r()||void 0===r()||null===(l=r().setAudioScenario)||void 0===l||l.call(r(),"meeting"),null===r()||void 0===r()||null===(o=r().setEnableSpeakerphone)||void 0===o||o.call(r(),!0),console.log("Agora audio profile/scenario set; speakerphone ".concat("ON"," via Agora")),await ensureWebAudioAlive()}catch(e){console.warn("Agora audio profile/scenario setup failed or unavailable:",e)}let n=sessionStorage.getItem("channelName")||"audio_".concat(Date.now()),s=await fetch("https://admin.yaari.me/api/agora/token",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({channelName:n})}),{token:c}=await s.json();console.log("Got Agora token"),await A.join(i.X.appId,n,c,null);let d=await r().createMicrophoneAudioTrack();b(d),await A.publish([d]);let u=sessionStorage.getItem("callData");if(u){let e=JSON.parse(u),l=localStorage.getItem("user"),o=l?JSON.parse(l):null;if((null==o?void 0:o.id)&&e.otherUserId)try{console.log("\uD83D\uDCE4 Logging audio call start:",{callerId:o.id,receiverId:e.otherUserId});let l=(null===(a=window.Capacitor)||void 0===a?void 0:null===(t=a.isNativePlatform)||void 0===t?void 0:t.call(a))?"".concat("https://admin.yaari.me","/api/call-log"):"/api/call-log",r=await fetch(l,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({callerId:o.id,receiverId:e.otherUserId,callType:"audio",action:"start",channelName:n})});if(!r.ok)throw Error("Failed to log call start: ".concat(r.status));let i=await r.json();i.sessionId&&sessionStorage.setItem("callSessionId",i.sessionId),console.log("✅ Audio call start logged:",i)}catch(e){console.error("❌ Failed to log audio call start:",e),alert("Warning: Call logging failed. Call may not appear in history.")}}}catch(e){console.error("Agora audio init error:",e)}};A.on("user-published",async(e,l)=>{if(await A.subscribe(e,l),"audio"===l){var o,t;null===(o=e.audioTrack)||void 0===o||o.play(),await ensureWebAudioAlive();try{let e=await (null===r()||void 0===r()?void 0:null===(t=r().getDevices)||void 0===t?void 0:t.call(r())),l=Array.isArray(e)?e.filter(e=>"audiooutput"===e.kind):[];console.log("Agora audio output devices:",l)}catch(e){console.warn("Enumerating audio output devices failed or unavailable:",e)}}}),init(),(0,u.o$)("Audio Call");let e=sessionStorage.getItem("callData");if(e){let l=JSON.parse(e);trackCallEvent("audio","accepted",l.otherUserId).catch(e=>console.log("Tracking error:",e))}return()=>{null==x||x.close(),A.leave(),h.dV.isNativePlatform()&&v.Z.resetAudio().catch(()=>{});try{var e,l;null===(e=O.current)||void 0===e||e.stop(),O.current=null,U.current=null,null===(l=T.current)||void 0===l||l.close(),T.current=null}catch(e){}}},[]);let toggleMute=async()=>{x&&(await x.setEnabled(w),S(!w))},toggleSpeaker=async()=>{let e=!I;if(N(e),!h.dV.isNativePlatform())try{var l;null===r()||void 0===r()||null===(l=r().setEnableSpeakerphone)||void 0===l||l.call(r(),e),console.log("AgoraRTC.setEnableSpeakerphone(".concat(e,") called"))}catch(e){console.warn("AgoraRTC.setEnableSpeakerphone failed or unavailable:",e)}h.dV.isNativePlatform()&&(await v.Z.setSpeakerphoneOn({on:e}),console.log("Speaker ".concat(e?"ON":"OFF"))),await ensureWebAudioAlive()},handleEndCall=async()=>{console.log("\uD83D\uDD34 USER CLICKED END CALL BUTTON");let e=sessionStorage.getItem("callData");console.log("Call data:",e);let o=Math.ceil(y/60)*n,t=e?JSON.parse(e):{};if(trackCallEvent("audio","ended",t.otherUserId,y).catch(e=>console.log("Tracking error:",e)),(0,u.L9)("Call Ended",{"Call Type":"audio",Duration:y,Cost:o,"Ended By":"User",Receiver:l,"Receiver ID":t.otherUserId}).catch(e=>console.log("Tracking error:",e)),syncUserToCleverTap().catch(e=>console.log("Sync error:",e)),e){let l=JSON.parse(e),t=localStorage.getItem("user"),n=t?JSON.parse(t):null;if((null==n?void 0:n.id)&&l.otherUserId)try{var a,r;console.log("\uD83D\uDCE4 Logging audio call end:",{callerId:n.id,receiverId:l.otherUserId,duration:y,cost:o});let e=(null===(r=window.Capacitor)||void 0===r?void 0:null===(a=r.isNativePlatform)||void 0===a?void 0:a.call(r))?"".concat("https://admin.yaari.me","/api/call-log"):"/api/call-log",t=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({callerId:n.id,receiverId:l.otherUserId,callType:"audio",action:"end",duration:y,cost:o,status:"completed"})});if(!t.ok)throw Error("Failed to log call end: ".concat(t.status));let i=await t.json();i.verified||console.warn("⚠️ Call saved but verification failed"),console.log("✅ Audio call end logged:",i)}catch(e){console.error("❌ Failed to log audio call end:",e),alert("Warning: Failed to save call to history.")}}if(e&&m){let l=JSON.parse(e),o=localStorage.getItem("user"),t=o?JSON.parse(o):null;console.log("Current user:",null==t?void 0:t.id),console.log("Other user:",l.otherUserId),l.otherUserId&&(null==t?void 0:t.id)?(console.log("\uD83D\uDCE4 EMITTING end-call TO:",l.otherUserId),m.emit("end-call",{userId:t.id,otherUserId:l.otherUserId}),console.log("end-call event emitted successfully")):console.log("Missing otherUserId or current userId")}else console.log("No call data or socket not available");if(console.log("Cleaning up local resources"),x&&x.close(),A.leave(),h.dV.isNativePlatform())try{await v.Z.resetAudio()}catch(e){}sessionStorage.removeItem("callData"),sessionStorage.removeItem("channelName"),console.log("Navigating back to users page"),window.location.href="/users"},P=Math.ceil(y/60)*n;return(0,t.jsxs)("div",{className:"full-screen-page bg-gradient-to-b from-primary to-orange-600 flex flex-col items-center justify-center p-8",children:[(0,t.jsxs)("div",{className:"flex-1 flex flex-col items-center justify-center",children:[(0,t.jsx)(AvatarCircle,{src:o,alt:l}),(0,t.jsx)(CallStats,{userName:l,duration:y,cost:P,remainingBalance:E,rate:n})]}),(0,t.jsx)(ControlsBar,{isSpeakerOn:I,isMuted:w,onToggleSpeaker:toggleSpeaker,onToggleMute:toggleMute,onEndCall:handleEndCall})]})}}}]);