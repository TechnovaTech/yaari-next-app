"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[766],{8339:function(e,l,a){a.d(l,{Z:function(){return o}});var t=a(2898);let o=(0,t.Z)("Video",[["path",{d:"m22 8-6 4 6 4V8Z",key:"50v9me"}],["rect",{width:"14",height:"12",x:"2",y:"6",rx:"2",ry:"2",key:"1rqjg6"}]])},5766:function(e,l,a){a.r(l),a.d(l,{default:function(){return VideoCallScreen}});var t=a(7437),o=a(2898);let s=(0,o.Z)("RefreshCw",[["path",{d:"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8",key:"v9h5vc"}],["path",{d:"M21 3v5h-5",key:"1q7to0"}],["path",{d:"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16",key:"3uifl3"}],["path",{d:"M8 16H3v5",key:"1cv678"}]]);var n=a(4043),i=a(2741),r=a(8339),c=a(2265),d=a(2263),u=a.n(d),g=a(4671),h=a(5997),m=a(4033),f=a(5376),v=a(5128),p=a(2273),y=a(3103),C=a(4064);function VideoCallScreen(e){let{userName:l,userAvatar:a,rate:o,onEndCall:d}=e,w=(0,m.useRouter)(),{socket:S}=(0,h.useSocket)();(0,f.K)(()=>handleEndCall());let[N,x]=(0,c.useState)(0),[I,b]=(0,c.useState)(!1),[j,k]=(0,c.useState)(!1),[D,E]=(0,c.useState)(!0),[T,O]=(0,c.useState)("user"),[U,M]=(0,c.useState)(null),[V,L]=(0,c.useState)(null),[R,A]=(0,c.useState)([]),[J]=(0,c.useState)(()=>u().createClient({mode:"rtc",codec:"vp8"})),[Z,P]=(0,c.useState)(!1),[z,F]=(0,c.useState)(null);(0,c.useEffect)(()=>{let e=setInterval(()=>{x(e=>e+1)},1e3);return()=>clearInterval(e)},[]);let handleCoinDeduction=async()=>{try{let e=sessionStorage.getItem("callData");if(console.log("Call data from session:",e),!e)return;let l=JSON.parse(e);console.log("Parsed call data:",l),console.log("isCaller value:",l.isCaller);let a=localStorage.getItem("user");if(!a)return;let t=JSON.parse(a);if(!1===l.isCaller){console.log("Receiver - not deducting coins");return}console.log("Caller - deducting coins"),console.log("Attempting to deduct ".concat(o," coins at ").concat(N,"s"));let s=await (0,p.G)(t.id,o,"video");console.log("Successfully deducted ".concat(o," coins")),(null==s?void 0:s.newBalance)!==void 0&&F(s.newBalance)}catch(l){var e;console.error("Coin deduction failed:",l),(null===(e=l.message)||void 0===e?void 0:e.includes("Insufficient"))&&(alert("Insufficient coins! Call will end."),handleEndCall())}};(0,c.useEffect)(()=>{10!==N||Z?Z&&N>10&&(N-10)%60==0&&(console.log("Deduction at ".concat(N," seconds")),handleCoinDeduction()):(console.log("First deduction at 10 seconds"),P(!0),handleCoinDeduction())},[N]),(0,c.useEffect)(()=>{if(!S){console.log("Socket not available in video call");return}console.log("Setting up call-ended listener in video call");let handleRemoteCallEnd=()=>{console.log("\uD83D\uDD34 CALL ENDED BY OTHER USER - CLOSING VIDEO CALL");try{U&&(console.log("Closing local video track"),U.close()),V&&(console.log("Closing local audio track"),V.close()),console.log("Leaving Agora channel"),J.leave(),console.log("Clearing session data"),sessionStorage.removeItem("callData"),sessionStorage.removeItem("channelName"),console.log("Navigating to /users"),window.location.href="/users"}catch(e){console.error("Error during call cleanup:",e),w.push("/users")}};return S.on("call-ended",handleRemoteCallEnd),console.log("call-ended listener registered"),()=>{console.log("Removing call-ended listener"),S.off("call-ended",handleRemoteCallEnd)}},[S,U,V,J,w]),(0,c.useEffect)(()=>{let init=async()=>{try{let a=sessionStorage.getItem("channelName")||"call_".concat(Date.now()),t=await fetch("https://admin.yaari.me/api/agora/token",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({channelName:a})}),{token:o}=await t.json();console.log("Got Agora token"),await J.join(g.X.appId,a,o,null);let s=await u().createMicrophoneAudioTrack(),n=await u().createCameraVideoTrack();if(L(s),M(n),await J.publish([s,n]),n.play("local-video"),s.setVolume(100),y.dV.isNativePlatform())try{await C.Z.enterCommunicationMode(),await C.Z.setSpeakerphoneOn({on:!0})}catch(e){console.warn("AudioRouting init failed (video):",e)}let i=sessionStorage.getItem("callData");if(i){let t=JSON.parse(i),o=localStorage.getItem("user"),s=o?JSON.parse(o):null;if((null==s?void 0:s.id)&&t.otherUserId)try{var e,l;console.log("\uD83D\uDCE4 Logging call start:",{callerId:s.id,receiverId:t.otherUserId,callType:"video"});let o=(null===(l=window.Capacitor)||void 0===l?void 0:null===(e=l.isNativePlatform)||void 0===e?void 0:e.call(l))?"".concat("https://admin.yaari.me","/api/call-log"):"/api/call-log",n=await fetch(o,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({callerId:s.id,receiverId:t.otherUserId,callType:"video",action:"start",channelName:a})});if(!n.ok)throw Error("Failed to log call start: ".concat(n.status));let i=await n.json();i.sessionId&&sessionStorage.setItem("callSessionId",i.sessionId),console.log("✅ Call start logged:",i)}catch(e){console.error("❌ Failed to log call start:",e),alert("Warning: Call logging failed. Call may not appear in history.")}}}catch(e){console.error("Agora init error:",e)}};return J.on("user-published",async(e,l)=>{if(await J.subscribe(e,l),"video"===l&&(A(l=>[...l,e]),setTimeout(()=>{var l;return null===(l=e.videoTrack)||void 0===l?void 0:l.play("remote-video")},100)),"audio"===l){var a,t;null===(a=e.audioTrack)||void 0===a||a.play(),null===(t=e.audioTrack)||void 0===t||t.setVolume(100)}}),J.on("user-unpublished",e=>{A(l=>l.filter(l=>l.uid!==e.uid))}),init(),(0,v.o$)("Video Call"),()=>{if(null==U||U.close(),null==V||V.close(),J.leave(),y.dV.isNativePlatform())try{C.Z.resetAudio()}catch(e){}}},[]);let toggleMute=async()=>{V&&(await V.setEnabled(I),b(!I))},toggleVideo=async()=>{U&&(await U.setEnabled(j),k(!j))},flipCamera=async()=>{try{if(U){U.close();let e="user"===T?"environment":"user",l=await u().createCameraVideoTrack({facingMode:e});await J.unpublish([U]),await J.publish([l]),M(l),O(e),l.play("local-video"),console.log("Camera flipped to:",e)}}catch(e){console.error("Error flipping camera:",e),alert("Could not flip camera. Make sure you have multiple cameras.")}},handleEndCall=async()=>{console.log("\uD83D\uDD34 USER CLICKED END CALL BUTTON");let e=sessionStorage.getItem("callData");console.log("Call data:",e);let a=Math.ceil(N/60)*o;if((0,v.L9)("Call Ended",{"Call Type":"video",Duration:N,Cost:a,"Ended By":"User",Receiver:l}),e){let l=JSON.parse(e),o=localStorage.getItem("user"),n=o?JSON.parse(o):null;if((null==n?void 0:n.id)&&l.otherUserId)try{var t,s;console.log("\uD83D\uDCE4 Logging call end:",{callerId:n.id,receiverId:l.otherUserId,duration:N,cost:a});let e=(null===(s=window.Capacitor)||void 0===s?void 0:null===(t=s.isNativePlatform)||void 0===t?void 0:t.call(s))?"".concat("https://admin.yaari.me","/api/call-log"):"/api/call-log",o=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({callerId:n.id,receiverId:l.otherUserId,callType:"video",action:"end",duration:N,cost:a,status:"completed"})});if(!o.ok)throw Error("Failed to log call end: ".concat(o.status));let i=await o.json();i.verified||console.warn("⚠️ Call saved but verification failed"),console.log("✅ Call end logged:",i)}catch(e){console.error("❌ Failed to log call end:",e),alert("Warning: Failed to save call to history.")}}if(e&&S){let l=JSON.parse(e),a=localStorage.getItem("user"),t=a?JSON.parse(a):null;console.log("Current user:",null==t?void 0:t.id),console.log("Other user:",l.otherUserId),l.otherUserId&&(null==t?void 0:t.id)?(console.log("\uD83D\uDCE4 EMITTING end-call TO:",l.otherUserId),S.emit("end-call",{userId:t.id,otherUserId:l.otherUserId}),console.log("end-call event emitted successfully")):console.log("Missing otherUserId or current userId")}else console.log("No call data or socket not available");if(console.log("Cleaning up local resources"),U&&U.close(),V&&V.close(),J.leave(),sessionStorage.removeItem("callData"),sessionStorage.removeItem("channelName"),console.log("Navigating back to users page"),y.dV.isNativePlatform())try{await C.Z.resetAudio()}catch(e){}window.location.href="/users"},B=Math.ceil(N/60)*o;return(0,t.jsxs)("div",{className:"full-screen-page bg-gray-900 flex flex-col",children:[(0,t.jsxs)("div",{className:"flex-1 relative",children:[(0,t.jsx)("div",{id:"remote-video",className:"absolute inset-0 bg-gray-800",children:0===R.length&&(0,t.jsx)("div",{className:"absolute inset-0"})}),(0,t.jsxs)("div",{className:"absolute top-8 left-0 right-0 text-center text-white z-10",children:[(0,t.jsx)("h2",{className:"text-2xl font-bold mb-2",children:l}),(0,t.jsx)("p",{className:"text-lg",children:"".concat(Math.floor(N/60).toString().padStart(2,"0"),":").concat((N%60).toString().padStart(2,"0"))}),(0,t.jsxs)("p",{className:"text-sm text-gray-400 mt-1",children:["₹",B]}),null!==z&&z<=o&&(0,t.jsxs)("div",{className:"mt-3 inline-flex bg-red-500/90 backdrop-blur-sm px-4 py-2 rounded-full items-center gap-2 animate-pulse",children:[(0,t.jsx)("img",{src:"/images/coinicon.png",alt:"coin",className:"w-4 h-4 object-contain"}),(0,t.jsxs)("span",{className:"text-white font-semibold text-sm mt-2.5",children:[z," coins left"]})]})]}),(0,t.jsxs)("div",{className:"absolute bottom-32 left-4 z-10",children:[(0,t.jsx)("div",{id:"local-video",className:"w-24 h-32 bg-gray-800 rounded-lg overflow-hidden"}),(0,t.jsx)("button",{onClick:flipCamera,className:"absolute top-2 right-2 w-8 h-8 bg-black/50 rounded-full flex items-center justify-center",children:(0,t.jsx)(s,{className:"text-white",size:16})})]})]}),(0,t.jsxs)("div",{className:"p-8 flex justify-center items-center space-x-4",children:[(0,t.jsx)("button",{onClick:toggleMute,className:"w-14 h-14 rounded-full flex items-center justify-center ".concat(I?"bg-red-500":"bg-gray-700"),children:(0,t.jsx)(n.Z,{className:"text-white",size:24})}),(0,t.jsx)("button",{onClick:handleEndCall,className:"w-16 h-16 bg-red-500 rounded-full flex items-center justify-center shadow-lg",children:(0,t.jsx)(i.Z,{className:"text-white rotate-[135deg]",size:28})}),(0,t.jsx)("button",{onClick:toggleVideo,className:"w-14 h-14 rounded-full flex items-center justify-center ".concat(j?"bg-red-500":"bg-gray-700"),children:(0,t.jsx)(r.Z,{className:"text-white",size:24})})]})]})}}}]);